var MN=Object.defineProperty;var FN=(s,e,t)=>e in s?MN(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var Hr=(s,e,t)=>(FN(s,typeof e!="symbol"?e+"":e,t),t);import{E as De,I as hg,L as N,A as Mt,T as Es,a as Xs,C as dt,b as j,M as Oe,c as ca,_ as U,P as Se,N as fi,V as x,S as LN,d as z,e as $,f as _,s as R,g as We,R as y,h as X,i as q,j as Te,O as k,k as wN,D as Ea,l as Ee,G as ki,m as pe,Q as Z,B as Fo,n as G,o as BN,p as VN,q as UN,r as kN,t as GN,u as zN,v as Qr,w as le,U as bn,x as te,y as Ys,z as Wn,F as se,H as W,J as me,K as dg,W as gi,X as Ai,Y as WN,Z as Li,$ as HN,a0 as M,a1 as $N,a2 as gr,a3 as ze,a4 as XN,a5 as lr,a6 as Zy,a7 as Nm,a8 as Ms,a9 as YN,aa as Dm,ab as jN,ac as Cn,ad as Lo,ae as Mm,af as Fm,ag as gt,ah as ft,ai as wo,aj as S,ak as Hn,al as Zi,am as $t,an as qN,ao as hn,ap as Su,aq as Pn,ar as Yc,as as bi,at as Qy,au as Ky,av as Lr,aw as Pl,ax as en,ay as ZN,az as QN,aA as jc,aB as Jy,aC as KN,aD as eI,aE as JN,aF as vu,aG as tI,aH as ud,aI as eD,aJ as Lm,aK as kh,aL as Br,aM as Ei,aN as iI,aO as ss,aP as xu,aQ as ot,aR as rI,aS as tD,aT as iD,aU as rD,aV as sI,aW as Ol,aX as hd,aY as fg,aZ as sD,a_ as nD,a$ as nI,b0 as wm,b1 as aD,b2 as oD,b3 as lD,b4 as cD,b5 as uD,b6 as hD,b7 as dD,b8 as fD,b9 as pD,ba as mD,bb as jr,bc as _D,bd as gD,be as SD,bf as aI,bg as $n,bh as Bm,bi as sa,bj as na,bk as aa,bl as vD,bm as oa,bn as oI,bo as ls,bp as Ji,bq as go,br as ja,bs as qc,bt as lI,bu as xD,bv as ED,bw as TD,bx as st,by as dn,bz as Le,bA as Eu,bB as Tu,bC as Vm,bD as Na,bE as gn,bF as Da,bG as jn,bH as Ma,bI as hs,bJ as Bt,bK as Bc,bL as It,bM as Ar,bN as bD,bO as CD,bP as Sn,bQ as yD,bR as nr,bS as Um,bT as ps,bU as Xt,bV as Xn,bW as jl,bX as bu,bY as K,bZ as Nt,b_ as km,b$ as Cu,c0 as yu,c1 as Iu,c2 as Gm,c3 as zm,c4 as Ru,c5 as Wm,c6 as Au,c7 as Hm,c8 as Bo,c9 as Dt,ca as $m,cb as Xm,cc as ql,cd as Pu,ce as Vo,cf as Ou,cg as Nu,ch as Zl,ci as Oi,cj as Ym,ck as cI,cl as Er,cm as ID,cn as RD,co as Zc,cp as uI,cq as hI,cr as jm,cs as dI,ct as qm,cu as Nl,cv as fI,cw as AD,cx as pg,cy as Nn,cz as PD,cA as Yn,cB as mg,cC as la,cD as _g,cE as pI,cF as mI,cG as OD,cH as ND,cI as gg,cJ as DD,cK as ro,cL as Ta,cM as MD,cN as li,cO as fn,cP as ys,cQ as FD,cR as tn,cS as _I,cT as Zm,cU as ke,cV as LD,cW as wD,cX as BD,cY as VD,cZ as UD,c_ as kD,c$ as gI,d0 as SI,d1 as vI,d2 as GD,d3 as Vc,d4 as An,d5 as Gh,d6 as zD,d7 as xI,d8 as WD,d9 as HD,da as $D,db as XD,dc as YD,dd as jD,de as qD,df as ZD,dg as Qc,dh as qa,di as Za,dj as Uc,dk as QD,dl as zh,dm as KD,dn as JD,dp as eM,dq as EI,dr as Dl,ds as Tr,dt as tM,du as iM,dv as Qm,dw as TI,dx as bI,dy as rM,dz as xc,dA as CI,dB as sM,dC as nM,dD as aM,dE as yI,dF as Sg,dG as vg,dH as xg,dI as oM,dJ as lM}from"./main-e8601b72.js";import{P as Uo,T as Km,a as II,C as cM}from"./passPostProcess-99298d86.js";import"./bakedVertexAnimation-f0d36139.js";import"./morphTargetsVertex-8153f830.js";import"./instancesDeclaration-9dea1578.js";import{A as RI,F as uM,T as rn,a as Jm}from"./dds-2cad4159.js";import{G as hM,U as dM,C as fM}from"./environmentTextureTools-e7182cc1.js";import"./helperFunctions-60ac609f.js";import"./default.fragment-d4022e5c.js";import"./meshUboDeclaration-6df77899.js";import{DumpData as AI}from"./dumpTools-d9c3a51e.js";import"./khronosTextureContainer2-34b3feaa.js";import"./clipPlaneFragment-4ee9d5d8.js";import"./clipPlaneVertex-9e3b7044.js";import"./shadowMap.fragment-53575f36.js";import"./shadowMap.vertex-ec63166c.js";import"./depthBoxBlur.fragment-f6d5296f.js";import"./shadowMapFragmentSoftTransparentShadow-95b25e02.js";import"./shadowMap.fragment-184b8421.js";import"./shadowMap.vertex-745324f3.js";import"./depthBoxBlur.fragment-17f76a50.js";import"./shadowMapFragmentSoftTransparentShadow-74b31e35.js";import"./meshUboDeclaration-ca609797.js";import"./default.fragment-24488752.js";import{G as pM,P as PI}from"./hdr-2949a103.js";import"./fogVertex-63846594.js";import"./default.vertex-dd4788e9.js";import"./logDepthDeclaration-2a2324b6.js";import"./logDepthVertex-50f013a0.js";import"./logDepthFragment-1fbe4860.js";import"./fogFragmentDeclaration-ab16d80d.js";import"./default.vertex-5283776d.js";import"./color.fragment-7a4435b6.js";import"./color.vertex-260c1943.js";import"./mainUVVaryingDeclaration-d7d129d5.js";import"./vertexColorMixing-e6b7420e.js";import"./mainUVVaryingDeclaration-91e38cff.js";import"./vertexColorMixing-471c72c7.js";import{ReadExrDataAsync as mM}from"./exrTextureLoader-bca265a4.js";import"./basis-8cd6b489.js";import"./packingFunctions-220d49df.js";import"./color.fragment-4953f0a1.js";import"./color.vertex-f92948f0.js";import"./lodCube.fragment-d6605fcd.js";import"./lod.fragment-2724b926.js";import"./lodCube.fragment-ff6abf8b.js";import"./lod.fragment-b72be3c3.js";import"./rgbdDecode.fragment-d8a067f2.js";import"./rgbdDecode.fragment-4419b975.js";import{G as _M}from"./tga-1f0ab857.js";import"./particles.fragment-c7c6f8b2.js";import"./particles.vertex-30642282.js";import"./particles.fragment-66fd52a5.js";import"./particles.vertex-b54b1b17.js";import"./postprocess.vertex-75a608cc.js";import"./kernelBlur.fragment-50c917f0.js";import"./kernelBlur.vertex-8e7f09e2.js";import"./kernelBlur.fragment-f5d287a9.js";import"./kernelBlur.vertex-63ecc071.js";import"./pass.fragment-52eaea35.js";import"./passCube.fragment-0849f2fa.js";import"./pass.fragment-87b218c5.js";import"./passCube.fragment-3f52ec62.js";import"./depth.fragment-4cb21e62.js";import"./depth.vertex-83f6105c.js";import"./kernelBlurVaryingDeclaration-f447b15d.js";import"./kernelBlurVaryingDeclaration-9592d7e6.js";class OI{constructor(){this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[],this.sounds=null,this.effectLayers=[],this.layers=[],this.reflectionProbes=[]}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e}getNodes(){let e=[];e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes);for(const t of this.skeletons)e=e.concat(t.bones);return e}}class gM extends OI{}class SM{constructor(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}dispose(){const e=this.rootNodes;for(const r of e)r.dispose();e.length=0;const t=this.skeletons;for(const r of t)r.dispose();t.length=0;const i=this.animationGroups;for(const r of i)r.dispose();i.length=0}}class vM extends OI{constructor(e){super(),this._wasAddedToScene=!1,e=e||De.LastCreatedScene,e&&(this.scene=e,this.proceduralTextures=[],e.onDisposeObservable.add(()=>{this._wasAddedToScene||this.dispose()}),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{for(const t of this.geometries)t._rebuild();for(const t of this.meshes)t._rebuild();for(const t of this.particleSystems)t.rebuild();for(const t of this.textures)t._rebuild()}))}_topologicalSort(e){const t=new Map;for(const o of e)t.set(o.uniqueId,o);const i={dependsOn:new Map,dependedBy:new Map};for(const o of e){const l=o.uniqueId;i.dependsOn.set(l,new Set),i.dependedBy.set(l,new Set)}for(const o of e){const l=o.uniqueId,c=i.dependsOn.get(l);if(o instanceof hg){const h=o.sourceMesh;t.has(h.uniqueId)&&(c.add(h.uniqueId),i.dependedBy.get(h.uniqueId).add(l))}const u=i.dependedBy.get(l);for(const h of o.getDescendants()){const d=h.uniqueId;t.has(d)&&(u.add(d),i.dependsOn.get(d).add(l))}}const r=[],n=[];for(const o of e){const l=o.uniqueId;i.dependsOn.get(l).size===0&&(n.push(o),t.delete(l))}const a=n;for(;a.length>0;){const o=a.shift();r.push(o);const l=i.dependedBy.get(o.uniqueId);for(const c of Array.from(l.values())){const u=i.dependsOn.get(c);u.delete(o.uniqueId),u.size===0&&t.get(c)&&(a.push(t.get(c)),t.delete(c))}}return t.size>0&&(N.Error("SceneSerializer._topologicalSort: There were unvisited nodes:"),t.forEach(o=>{N.Error(o.name)})),r}_addNodeAndDescendantsToList(e,t,i,r){if(!(!i||r&&!r(i)||t.has(i.uniqueId))){e.push(i),t.add(i.uniqueId);for(const n of i.getDescendants(!0))this._addNodeAndDescendantsToList(e,t,n,r)}}_isNodeInContainer(e){return e instanceof Mt&&this.meshes.indexOf(e)!==-1||e instanceof Es&&this.transformNodes.indexOf(e)!==-1||e instanceof Xs&&this.lights.indexOf(e)!==-1||e instanceof dt&&this.cameras.indexOf(e)!==-1}_isValidHierarchy(){for(const e of this.meshes)if(e.parent&&!this._isNodeInContainer(e.parent))return N.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.transformNodes)if(e.parent&&!this._isNodeInContainer(e.parent))return N.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.lights)if(e.parent&&!this._isNodeInContainer(e.parent))return N.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.cameras)if(e.parent&&!this._isNodeInContainer(e.parent))return N.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;return!0}instantiateModelsToScene(e,t=!1,i){this._isValidHierarchy()||j.Warn("SceneSerializer.InstantiateModelsToScene: The Asset Container hierarchy is not valid.");const r={},n={},a=new SM,o=[],l=[],c={doNotInstantiate:!0,...i},u=(g,v)=>{if(r[g.uniqueId]=v.uniqueId,n[v.uniqueId]=v,e&&(v.name=e(g.name)),v instanceof Oe){const E=v;if(E.morphTargetManager){const T=g.morphTargetManager;E.morphTargetManager=T.clone();for(let C=0;C<T.numTargets;C++){const A=T.getTarget(C),I=E.morphTargetManager.getTarget(C);r[A.uniqueId]=I.uniqueId,n[I.uniqueId]=I}}}},h=[],d=new Set;for(const g of this.transformNodes)g.parent===null&&this._addNodeAndDescendantsToList(h,d,g,c.predicate);for(const g of this.meshes)g.parent===null&&this._addNodeAndDescendantsToList(h,d,g,c.predicate);const f=this._topologicalSort(h),m=(g,v)=>{if(u(g,v),g.parent){const E=r[g.parent.uniqueId],T=n[E];T?v.parent=T:v.parent=g.parent}if(v.position&&g.position&&v.position.copyFrom(g.position),v.rotationQuaternion&&g.rotationQuaternion&&v.rotationQuaternion.copyFrom(g.rotationQuaternion),v.rotation&&g.rotation&&v.rotation.copyFrom(g.rotation),v.scaling&&g.scaling&&v.scaling.copyFrom(g.scaling),v.material){const E=v;if(E.material)if(t){const T=g.material;if(l.indexOf(T)===-1){let C=T.clone(e?e(T.name):"Clone of "+T.name);if(l.push(T),r[T.uniqueId]=C.uniqueId,n[C.uniqueId]=C,T.getClassName()==="MultiMaterial"){const A=T;for(const I of A.subMaterials)I&&(C=I.clone(e?e(I.name):"Clone of "+I.name),l.push(I),r[I.uniqueId]=C.uniqueId,n[C.uniqueId]=C);A.subMaterials=A.subMaterials.map(I=>I&&n[r[I.uniqueId]])}}E.getClassName()!=="InstancedMesh"&&(E.material=n[r[T.uniqueId]])}else E.material.getClassName()==="MultiMaterial"?this.scene.multiMaterials.indexOf(E.material)===-1&&this.scene.addMultiMaterial(E.material):this.scene.materials.indexOf(E.material)===-1&&this.scene.addMaterial(E.material)}v.parent===null&&a.rootNodes.push(v)};for(const g of f)if(g.getClassName()==="InstancedMesh"){const v=g,E=v.sourceMesh,T=r[E.uniqueId],A=(typeof T=="number"?n[T]:E).createInstance(v.name);m(v,A)}else{let v=!0;g.getClassName()==="TransformNode"||g.getClassName()==="Node"||g.skeleton||!g.getTotalVertices||g.getTotalVertices()===0?v=!1:c.doNotInstantiate&&(typeof c.doNotInstantiate=="function"?v=!c.doNotInstantiate(g):v=!c.doNotInstantiate);const E=v?g.createInstance(`instance of ${g.name}`):g.clone(`Clone of ${g.name}`,null,!0);if(!E)throw new Error(`Could not clone or instantiate node on Asset Container ${g.name}`);m(g,E)}for(const g of this.skeletons){if(c.predicate&&!c.predicate(g))continue;const v=g.clone(e?e(g.name):"Clone of "+g.name);for(const E of this.meshes)if(E.skeleton===g&&!E.isAnInstance){const T=n[r[E.uniqueId]];if(!T||T.isAnInstance||(T.skeleton=v,o.indexOf(v)!==-1))continue;o.push(v);for(const C of v.bones)C._linkedTransformNode&&(C._linkedTransformNode=n[r[C._linkedTransformNode.uniqueId]])}a.skeletons.push(v)}for(const g of this.animationGroups){if(c.predicate&&!c.predicate(g))continue;const v=g.clone(e?e(g.name):"Clone of "+g.name,E=>n[r[E.uniqueId]]||E);a.animationGroups.push(v)}return a}addAllToScene(){if(!this._wasAddedToScene){this._isValidHierarchy()||j.Warn("SceneSerializer.addAllToScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!0,this.addToScene(null),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(const e of this.scene._serializableComponents)e.addFromContainer(this);this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null}}addToScene(e=null){const t=[];for(const i of this.cameras)e&&!e(i)||(this.scene.addCamera(i),t.push(i));for(const i of this.lights)e&&!e(i)||(this.scene.addLight(i),t.push(i));for(const i of this.meshes)e&&!e(i)||(this.scene.addMesh(i),t.push(i));for(const i of this.skeletons)e&&!e(i)||this.scene.addSkeleton(i);for(const i of this.animations)e&&!e(i)||this.scene.addAnimation(i);for(const i of this.animationGroups)e&&!e(i)||this.scene.addAnimationGroup(i);for(const i of this.multiMaterials)e&&!e(i)||this.scene.addMultiMaterial(i);for(const i of this.materials)e&&!e(i)||this.scene.addMaterial(i);for(const i of this.morphTargetManagers)e&&!e(i)||this.scene.addMorphTargetManager(i);for(const i of this.geometries)e&&!e(i)||this.scene.addGeometry(i);for(const i of this.transformNodes)e&&!e(i)||(this.scene.addTransformNode(i),t.push(i));for(const i of this.actionManagers)e&&!e(i)||this.scene.addActionManager(i);for(const i of this.textures)e&&!e(i)||this.scene.addTexture(i);for(const i of this.reflectionProbes)e&&!e(i)||this.scene.addReflectionProbe(i);if(t.length){const i=new Set(this.scene.meshes);for(const r of this.scene.lights)i.add(r);for(const r of this.scene.cameras)i.add(r);for(const r of this.scene.transformNodes)i.add(r);for(const r of this.skeletons)for(const n of r.bones)i.add(n);for(const r of t)r.parent&&!i.has(r.parent)&&(r.setParent?r.setParent(null):r.parent=null)}}removeAllFromScene(){this._isValidHierarchy()||j.Warn("SceneSerializer.removeAllFromScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!1,this.removeFromScene(null),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this)}removeFromScene(e=null){for(const t of this.cameras)e&&!e(t)||this.scene.removeCamera(t);for(const t of this.lights)e&&!e(t)||this.scene.removeLight(t);for(const t of this.meshes)e&&!e(t)||this.scene.removeMesh(t,!0);for(const t of this.skeletons)e&&!e(t)||this.scene.removeSkeleton(t);for(const t of this.animations)e&&!e(t)||this.scene.removeAnimation(t);for(const t of this.animationGroups)e&&!e(t)||this.scene.removeAnimationGroup(t);for(const t of this.multiMaterials)e&&!e(t)||this.scene.removeMultiMaterial(t);for(const t of this.materials)e&&!e(t)||this.scene.removeMaterial(t);for(const t of this.morphTargetManagers)e&&!e(t)||this.scene.removeMorphTargetManager(t);for(const t of this.geometries)e&&!e(t)||this.scene.removeGeometry(t);for(const t of this.transformNodes)e&&!e(t)||this.scene.removeTransformNode(t);for(const t of this.actionManagers)e&&!e(t)||this.scene.removeActionManager(t);for(const t of this.textures)e&&!e(t)||this.scene.removeTexture(t);for(const t of this.reflectionProbes)e&&!e(t)||this.scene.removeReflectionProbe(t)}dispose(){const e=this.cameras.slice(0);for(const m of e)m.dispose();this.cameras.length=0;const t=this.lights.slice(0);for(const m of t)m.dispose();this.lights.length=0;const i=this.meshes.slice(0);for(const m of i)m.dispose();this.meshes.length=0;const r=this.skeletons.slice(0);for(const m of r)m.dispose();this.skeletons.length=0;const n=this.animationGroups.slice(0);for(const m of n)m.dispose();this.animationGroups.length=0;const a=this.multiMaterials.slice(0);for(const m of a)m.dispose();this.multiMaterials.length=0;const o=this.materials.slice(0);for(const m of o)m.dispose();this.materials.length=0;const l=this.geometries.slice(0);for(const m of l)m.dispose();this.geometries.length=0;const c=this.transformNodes.slice(0);for(const m of c)m.dispose();this.transformNodes.length=0;const u=this.actionManagers.slice(0);for(const m of u)m.dispose();this.actionManagers.length=0;const h=this.textures.slice(0);for(const m of h)m.dispose();this.textures.length=0;const d=this.reflectionProbes.slice(0);for(const m of d)m.dispose();this.reflectionProbes.length=0;const f=this.morphTargetManagers.slice(0);for(const m of f)m.dispose();this.morphTargetManagers.length=0,this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(const m of this.scene._serializableComponents)m.removeFromContainer(this,!0);this._onContextRestoredObserver&&(this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}_moveAssets(e,t,i){if(!(!e||!t))for(const r of e){let n=!0;if(i){for(const a of i)if(r===a){n=!1;break}}n&&(t.push(r),r._parentContainer=this)}}moveAllFromScene(e){this._wasAddedToScene=!1,e===void 0&&(e=new gM);for(const t in this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=this[t]||(t==="_environmentTexture"?null:[]),this._moveAssets(this.scene[t],this[t],e[t]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()}createRootMesh(){const e=new Oe("assetContainerRootMesh",this.scene);for(const t of this.meshes)t.parent||e.addChild(t);return this.meshes.unshift(e),e}mergeAnimationsTo(e=De.LastCreatedScene,t,i=null){if(!e)return N.Error("No scene available to merge animations to"),[];const r=i||(l=>{let c=null;const u=l.animations.length?l.animations[0].targetProperty:"",h=l.name.split(".").join("").split("_primitive")[0];switch(u){case"position":case"rotationQuaternion":c=e.getTransformNodeByName(l.name)||e.getTransformNodeByName(h);break;case"influence":c=e.getMorphTargetByName(l.name)||e.getMorphTargetByName(h);break;default:c=e.getNodeByName(l.name)||e.getNodeByName(h)}return c}),n=this.getNodes();for(const l of n){const c=r(l);if(c!==null){for(const u of l.animations){const h=c.animations.filter(d=>d.targetProperty===u.targetProperty);for(const d of h){const f=c.animations.indexOf(d,0);f>-1&&c.animations.splice(f,1)}}c.animations=c.animations.concat(l.animations)}}const a=[],o=this.animationGroups.slice();for(const l of o){a.push(l.clone(l.name,r));for(const c of l.animatables)c.stop()}for(const l of t){const c=r(l.target);c&&(e.beginAnimation(c,l.fromFrame,l.toFrame,l.loopAnimation,l.speedRatio,l.onAnimationEnd?l.onAnimationEnd:void 0,void 0,!0,void 0,l.onAnimationLoop?l.onAnimationLoop:void 0),e.stopAnimation(l.target))}return a}populateRootNodes(){this.rootNodes.length=0;for(const e of this.meshes)!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e);for(const e of this.transformNodes)!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e);for(const e of this.lights)!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e);for(const e of this.cameras)!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e)}addAllAssetsToContainer(e){if(!e)return;const t=[],i=new Set;for(t.push(e);t.length>0;){const r=t.pop();if(r instanceof Oe?(r.geometry&&this.geometries.indexOf(r.geometry)===-1&&this.geometries.push(r.geometry),this.meshes.push(r)):r instanceof hg?this.meshes.push(r):r instanceof Es?this.transformNodes.push(r):r instanceof Xs?this.lights.push(r):r instanceof dt&&this.cameras.push(r),r instanceof Mt){if(r.material&&this.materials.indexOf(r.material)===-1){this.materials.push(r.material);for(const n of r.material.getActiveTextures())this.textures.indexOf(n)===-1&&this.textures.push(n)}r.skeleton&&this.skeletons.indexOf(r.skeleton)===-1&&this.skeletons.push(r.skeleton),r.morphTargetManager&&this.morphTargetManagers.indexOf(r.morphTargetManager)===-1&&this.morphTargetManagers.push(r.morphTargetManager)}for(const n of r.getChildren())i.has(n)||t.push(n);i.add(r)}this.populateRootNodes()}_getByTags(e,t,i){if(t===void 0)return e;const r=[];for(const n in e){const a=e[n];ca&&ca.MatchesQuery(a,t)&&(!i||i(a))&&r.push(a)}return r}getMeshesByTags(e,t){return this._getByTags(this.meshes,e,t)}getCamerasByTags(e,t){return this._getByTags(this.cameras,e,t)}getLightsByTags(e,t){return this._getByTags(this.lights,e,t)}getMaterialsByTags(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))}getTransformNodesByTags(e,t){return this._getByTags(this.transformNodes,e,t)}}class Eg{static ExpandRGBDTexture(e){const t=e._texture;if(!t||!e.isRGBD)return;const i=t.getEngine(),r=i.getCaps(),n=t.isReady;let a=!1;r.textureHalfFloatRender&&r.textureHalfFloatLinearFiltering?(a=!0,t.type=2):r.textureFloatRender&&r.textureFloatLinearFiltering&&(a=!0,t.type=1),a&&(t.isReady=!1,t._isRGBD=!1,t.invertY=!1);const o=async()=>{const l=i.isWebGPU,c=l?1:0;t.isReady=!1,l?await U(()=>import("./rgbdDecode.fragment-4419b975.js"),["assets/rgbdDecode.fragment-4419b975.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/helperFunctions-60ac609f.js"]):await U(()=>import("./rgbdDecode.fragment-d8a067f2.js"),["assets/rgbdDecode.fragment-d8a067f2.js","assets/main-e8601b72.js","assets/index-ad665221.css"]);const u=new Se("rgbdDecode","rgbdDecode",null,null,1,null,3,i,!1,void 0,t.type,void 0,null,!1,void 0,c);u.externalTextureSamplerBinding=!0;const h=i.createRenderTargetTexture(t.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:t.samplingMode,type:t.type,format:5});u.onEffectCreatedObservable.addOnce(d=>{d.executeWhenCompiled(()=>{u.onApply=f=>{f._bindTexture("textureSampler",t),f.setFloat2("scale",1,1)},e.getScene().postProcessManager.directRender([u],h,!0),i.restoreDefaultFramebuffer(),i._releaseTexture(t),u&&u.dispose(),h._swapAndDie(t),t.isReady=!0})})};a&&(n?o():e.onLoadObservable.addOnce(o))}static async EncodeTextureToRGBD(e,t,i=0){return t.getEngine().isWebGPU?await U(()=>Promise.resolve().then(()=>_H),void 0):await U(()=>Promise.resolve().then(()=>pH),void 0),await RI("rgbdEncode",e,t,i,1,5)}}const xM=JSON.parse('[{"id":"juggernaut","classId":"marauder","game":"poe1","displayName":"Juggernaut","shortDescription":"Juggernaut ascendancy for Marauder","creationBonuses":{"str":4,"dex":0,"int":0}},{"id":"berserker","classId":"marauder","game":"poe1","displayName":"Berserker","shortDescription":"Berserker ascendancy for Marauder","creationBonuses":{"str":4,"dex":0,"int":0}},{"id":"chieftain","classId":"marauder","game":"poe1","displayName":"Chieftain","shortDescription":"Chieftain ascendancy for Marauder","creationBonuses":{"str":4,"dex":0,"int":0}},{"id":"warden","classId":"ranger","game":"poe1","displayName":"Warden","shortDescription":"Warden ascendancy for Ranger","creationBonuses":{"str":0,"dex":4,"int":0}},{"id":"deadeye","classId":"ranger","game":"poe1","displayName":"Deadeye","shortDescription":"Deadeye ascendancy for Ranger","creationBonuses":{"str":0,"dex":4,"int":0}},{"id":"pathfinder","classId":"ranger","game":"poe1","displayName":"Pathfinder","shortDescription":"Pathfinder ascendancy for Ranger","creationBonuses":{"str":0,"dex":4,"int":0}},{"id":"slayer","classId":"duelist","game":"poe1","displayName":"Slayer","shortDescription":"Slayer ascendancy for Duelist","creationBonuses":{"str":0,"dex":4,"int":0}},{"id":"gladiator","classId":"duelist","game":"poe1","displayName":"Gladiator","shortDescription":"Gladiator ascendancy for Duelist","creationBonuses":{"str":0,"dex":4,"int":0}},{"id":"champion","classId":"duelist","game":"poe1","displayName":"Champion","shortDescription":"Champion ascendancy for Duelist","creationBonuses":{"str":0,"dex":4,"int":0}},{"id":"inquisitor","classId":"templar","game":"poe1","displayName":"Inquisitor","shortDescription":"Inquisitor ascendancy for Templar","creationBonuses":{"str":0,"dex":0,"int":4}},{"id":"hierophant","classId":"templar","game":"poe1","displayName":"Hierophant","shortDescription":"Hierophant ascendancy for Templar","creationBonuses":{"str":0,"dex":0,"int":4}},{"id":"guardian","classId":"templar","game":"poe1","displayName":"Guardian","shortDescription":"Guardian ascendancy for Templar","creationBonuses":{"str":0,"dex":0,"int":4}},{"id":"assassin","classId":"shadow","game":"poe1","displayName":"Assassin","shortDescription":"Assassin ascendancy for Shadow","creationBonuses":{"str":0,"dex":4,"int":0}},{"id":"trickster","classId":"shadow","game":"poe1","displayName":"Trickster","shortDescription":"Trickster ascendancy for Shadow","creationBonuses":{"str":0,"dex":4,"int":0}},{"id":"saboteur","classId":"shadow","game":"poe1","displayName":"Saboteur","shortDescription":"Saboteur ascendancy for Shadow","creationBonuses":{"str":0,"dex":4,"int":0}},{"id":"ascendant","classId":"scion","game":"poe1","displayName":"Ascendant","shortDescription":"Ascendant ascendancy for Scion","creationBonuses":{"str":0,"dex":0,"int":0}},{"id":"titan","classId":"warrior","game":"poe2","displayName":"Titan","shortDescription":"Titan ascendancy for Warrior","creationBonuses":{"str":4,"dex":0,"int":0}},{"id":"warbringer","classId":"warrior","game":"poe2","displayName":"Warbringer","shortDescription":"Warbringer ascendancy for Warrior","creationBonuses":{"str":4,"dex":0,"int":0}},{"id":"smith_of_kitava","classId":"warrior","game":"poe2","displayName":"Smith of Kitava","shortDescription":"Smith of Kitava ascendancy for Warrior","creationBonuses":{"str":4,"dex":0,"int":0}},{"id":"infernalist","classId":"witch","game":"poe2","displayName":"Infernalist","shortDescription":"Infernalist ascendancy for Witch","creationBonuses":{"str":0,"dex":0,"int":4}},{"id":"blood_mage","classId":"witch","game":"poe2","displayName":"Blood Mage","shortDescription":"Blood Mage ascendancy for Witch","creationBonuses":{"str":0,"dex":0,"int":4}},{"id":"lich","classId":"witch","game":"poe2","displayName":"Lich","shortDescription":"Lich ascendancy for Witch","creationBonuses":{"str":0,"dex":0,"int":4}},{"id":"occultist","classId":"witch","game":"poe1","displayName":"Occultist","shortDescription":"Occultist ascendancy for Witch","creationBonuses":{"str":0,"dex":0,"int":4}},{"id":"elementalist","classId":"witch","game":"poe1","displayName":"Elementalist","shortDescription":"Elementalist ascendancy for Witch","creationBonuses":{"str":0,"dex":0,"int":4}},{"id":"necromancer","classId":"witch","game":"poe1","displayName":"Necromancer","shortDescription":"Necromancer ascendancy for Witch","creationBonuses":{"str":0,"dex":0,"int":4}},{"id":"stormweaver","classId":"sorceress","game":"poe2","displayName":"Stormweaver","shortDescription":"Stormweaver ascendancy for Sorceress","creationBonuses":{"str":0,"dex":0,"int":0}},{"id":"chronomancer","classId":"sorceress","game":"poe2","displayName":"Chronomancer","shortDescription":"Chronomancer ascendancy for Sorceress","creationBonuses":{"str":0,"dex":0,"int":0}},{"id":"tactician","classId":"mercenary","game":"poe2","displayName":"Tactician","shortDescription":"Tactician ascendancy for Mercenary","creationBonuses":{"str":0,"dex":0,"int":0}},{"id":"witchhunter","classId":"mercenary","game":"poe2","displayName":"Witchhunter","shortDescription":"Witchhunter ascendancy for Mercenary","creationBonuses":{"str":0,"dex":0,"int":0}},{"id":"gemling_legionnaire","classId":"mercenary","game":"poe2","displayName":"Gemling Legionnaire","shortDescription":"Gemling Legionnaire ascendancy for Mercenary","creationBonuses":{"str":0,"dex":0,"int":0}},{"id":"invoker","classId":"monk","game":"poe2","displayName":"Invoker","shortDescription":"Invoker ascendancy for Monk","creationBonuses":{"str":0,"dex":0,"int":0}},{"id":"acolyte_of_chayula","classId":"monk","game":"poe2","displayName":"Acolyte of Chayula","shortDescription":"Acolyte of Chayula ascendancy for Monk","creationBonuses":{"str":0,"dex":0,"int":0}},{"id":"amazon","classId":"huntress","game":"poe2","displayName":"Amazon","shortDescription":"Amazon ascendancy for Huntress","creationBonuses":{"str":0,"dex":0,"int":0}},{"id":"ritualist","classId":"huntress","game":"poe2","displayName":"Ritualist","shortDescription":"Ritualist ascendancy for Huntress","creationBonuses":{"str":0,"dex":0,"int":0}}]'),EM=JSON.parse('[{"id":"marauder","displayName":"Marauder (Strength-focused)","game":"poe1","affinity":{"str":32,"dex":14,"int":14},"startingStats":{"strength":27,"dexterity":9,"intelligence":9,"hp":109,"maxHp":109,"mp":43,"maxMp":43,"armor":17,"evasion":4},"allowedAscendancies":["juggernaut","berserker","chieftain"],"saveClass":"marauder"},{"id":"duelist","displayName":"Duelist (Balanced-focused)","game":"poe1","affinity":{"str":23,"dex":23,"int":14},"startingStats":{"strength":18,"dexterity":18,"intelligence":9,"hp":91,"maxHp":91,"mp":43,"maxMp":43,"armor":8,"evasion":13},"allowedAscendancies":["slayer","gladiator","champion"],"saveClass":"duelist"},{"id":"templar","displayName":"Templar (Balanced-focused)","game":"poe1","affinity":{"str":23,"dex":14,"int":23},"startingStats":{"strength":18,"dexterity":9,"intelligence":18,"hp":91,"maxHp":91,"mp":61,"maxMp":61,"armor":8,"evasion":4},"allowedAscendancies":["inquisitor","hierophant","guardian"],"saveClass":"templar"},{"id":"shadow","displayName":"Shadow (Balanced-focused)","game":"poe1","affinity":{"str":14,"dex":23,"int":23},"startingStats":{"strength":9,"dexterity":18,"intelligence":18,"hp":73,"maxHp":73,"mp":61,"maxMp":61,"armor":-1,"evasion":13},"allowedAscendancies":["assassin","trickster","saboteur"],"saveClass":"shadow"},{"id":"scion","displayName":"Scion (Balanced-focused)","game":"poe1","affinity":{"str":20,"dex":20,"int":20},"startingStats":{"strength":15,"dexterity":15,"intelligence":15,"hp":85,"maxHp":85,"mp":55,"maxMp":55,"energyShield":0,"maxEnergyShield":0,"armor":5,"evasion":10,"fireResistance":0,"coldResistance":0,"lightningResistance":0,"chaosResistance":0,"accuracy":200},"allowedAscendancies":["ascendant"],"saveClass":"scion"},{"id":"warrior","displayName":"Warrior (Strength-focused)","game":"poe2","affinity":{"str":32,"dex":14,"int":14},"startingStats":{"strength":27,"dexterity":9,"intelligence":9,"hp":78,"maxHp":78,"mp":40,"maxMp":40,"energyShield":0,"maxEnergyShield":0,"armor":17,"evasion":4,"fireResistance":0,"coldResistance":0,"lightningResistance":0,"chaosResistance":0,"accuracy":152},"allowedAscendancies":["titan","warbringer","smith_of_kitava"],"saveClass":"warrior"},{"id":"witch","displayName":"Witch (Intelligence-focused)","game":"poe2","affinity":{"str":14,"dex":14,"int":32},"startingStats":{"strength":9,"dexterity":9,"intelligence":27,"hp":73,"maxHp":73,"mp":79,"maxMp":79,"energyShield":0,"maxEnergyShield":0,"armor":-1,"evasion":4,"fireResistance":0,"coldResistance":0,"lightningResistance":0,"chaosResistance":0,"accuracy":152},"allowedAscendancies":["infernalist","blood_mage","lich"],"saveClass":"witch"},{"id":"sorceress","displayName":"Sorceress (Balanced-focused)","game":"poe2","affinity":{"str":20,"dex":20,"int":20},"startingStats":{"strength":15,"dexterity":15,"intelligence":15,"hp":85,"maxHp":85,"mp":55,"maxMp":55,"energyShield":0,"maxEnergyShield":0,"armor":5,"evasion":10,"fireResistance":0,"coldResistance":0,"lightningResistance":0,"chaosResistance":0,"accuracy":200},"allowedAscendancies":["stormweaver","chronomancer"],"saveClass":"sorceress"},{"id":"mercenary","displayName":"Mercenary (Balanced-focused)","game":"poe2","affinity":{"str":20,"dex":20,"int":20},"startingStats":{"strength":15,"dexterity":15,"intelligence":15,"hp":85,"maxHp":85,"mp":55,"maxMp":55,"energyShield":0,"maxEnergyShield":0,"armor":5,"evasion":10,"fireResistance":0,"coldResistance":0,"lightningResistance":0,"chaosResistance":0,"accuracy":200},"allowedAscendancies":["tactician","witchhunter","gemling_legionnaire"],"saveClass":"mercenary"},{"id":"monk","displayName":"Monk (Intelligence-focused)","game":"poe2","affinity":{"str":14,"dex":14,"int":32},"startingStats":{"strength":9,"dexterity":9,"intelligence":27,"hp":73,"maxHp":73,"mp":79,"maxMp":79,"energyShield":0,"maxEnergyShield":0,"armor":-1,"evasion":4,"fireResistance":0,"coldResistance":0,"lightningResistance":0,"chaosResistance":0,"accuracy":152},"allowedAscendancies":["invoker","acolyte_of_chayula"],"saveClass":"monk"},{"id":"ranger","displayName":"Ranger (Balanced-focused)","game":"poe2","affinity":{"str":23,"dex":23,"int":14},"startingStats":{"strength":18,"dexterity":18,"intelligence":9,"hp":60,"maxHp":60,"mp":49,"maxMp":49,"energyShield":0,"maxEnergyShield":0,"armor":8,"evasion":13,"fireResistance":0,"coldResistance":0,"lightningResistance":0,"chaosResistance":0,"accuracy":224},"allowedAscendancies":["warden","deadeye","pathfinder"],"saveClass":"archer"},{"id":"huntress","displayName":"Huntress (Balanced-focused)","game":"poe2","affinity":{"str":20,"dex":20,"int":20},"startingStats":{"strength":15,"dexterity":15,"intelligence":15,"hp":85,"maxHp":85,"mp":55,"maxMp":55,"energyShield":0,"maxEnergyShield":0,"armor":5,"evasion":10,"fireResistance":0,"coldResistance":0,"lightningResistance":0,"chaosResistance":0,"accuracy":200},"allowedAscendancies":["amazon","ritualist"],"saveClass":"huntress"}]');fi.AddNodeConstructor("Light_Type_2",(s,e)=>()=>new ar(s,x.Zero(),x.Zero(),0,0,e));class ar extends LN{get iesProfileTexture(){return this._iesProfileTexture}set iesProfileTexture(e){this._iesProfileTexture!==e&&(this._iesProfileTexture=e,this._iesProfileTexture&&ar._IsTexture(this._iesProfileTexture)&&this._iesProfileTexture.onLoadObservable.addOnce(()=>{this._markMeshesAsLightDirty()}))}get angle(){return this._angle}set angle(e){this._angle=e,this._cosHalfAngle=Math.cos(e*.5),this._projectionTextureProjectionLightDirty=!0,this.forceProjectionMatrixCompute(),this._computeAngleValues()}get innerAngle(){return this._innerAngle}set innerAngle(e){this._innerAngle=e,this._computeAngleValues()}get shadowAngleScale(){return this._shadowAngleScale}set shadowAngleScale(e){this._shadowAngleScale=e,this.forceProjectionMatrixCompute()}get projectionTextureMatrix(){return this._projectionTextureMatrix}get projectionTextureLightNear(){return this._projectionTextureLightNear}set projectionTextureLightNear(e){this._projectionTextureLightNear=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureLightFar(){return this._projectionTextureLightFar}set projectionTextureLightFar(e){this._projectionTextureLightFar=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureUpDirection(){return this._projectionTextureUpDirection}set projectionTextureUpDirection(e){this._projectionTextureUpDirection=e,this._projectionTextureProjectionLightDirty=!0}get projectionTexture(){return this._projectionTexture}set projectionTexture(e){this._projectionTexture!==e&&(this._projectionTexture=e,this._projectionTextureDirty=!0,this._projectionTexture&&!this._projectionTexture.isReady()&&(ar._IsProceduralTexture(this._projectionTexture)?this._projectionTexture.getEffect().executeWhenCompiled(()=>{this._markMeshesAsLightDirty()}):ar._IsTexture(this._projectionTexture)&&this._projectionTexture.onLoadObservable.addOnce(()=>{this._markMeshesAsLightDirty()})))}static _IsProceduralTexture(e){return e.onGeneratedObservable!==void 0}static _IsTexture(e){return e.onLoadObservable!==void 0}get projectionTextureProjectionLightMatrix(){return this._projectionTextureProjectionLightMatrix}set projectionTextureProjectionLightMatrix(e){this._projectionTextureProjectionLightMatrix=e,this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0}constructor(e,t,i,r,n,a){super(e,a),this._innerAngle=0,this._iesProfileTexture=null,this._projectionTextureMatrix=z.Zero(),this._projectionTextureLightNear=1e-6,this._projectionTextureLightFar=1e3,this._projectionTextureUpDirection=x.Up(),this._projectionTextureViewLightDirty=!0,this._projectionTextureProjectionLightDirty=!0,this._projectionTextureDirty=!0,this._projectionTextureViewTargetVector=x.Zero(),this._projectionTextureViewLightMatrix=z.Zero(),this._projectionTextureProjectionLightMatrix=z.Zero(),this._projectionTextureScalingMatrix=z.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),this.position=t,this.direction=i,this.angle=r,this.exponent=n}getClassName(){return"SpotLight"}getTypeID(){return Xs.LIGHTTYPEID_SPOTLIGHT}_setDirection(e){super._setDirection(e),this._projectionTextureViewLightDirty=!0}_setPosition(e){super._setPosition(e),this._projectionTextureViewLightDirty=!0}_setDefaultShadowProjectionMatrix(e,t,i){const r=this.getScene().activeCamera;if(!r)return;this._shadowAngleScale=this._shadowAngleScale||1;const n=this._shadowAngleScale*this._angle,a=this.shadowMinZ!==void 0?this.shadowMinZ:r.minZ,o=this.shadowMaxZ!==void 0?this.shadowMaxZ:r.maxZ,l=this.getScene().getEngine().useReverseDepthBuffer;z.PerspectiveFovLHToRef(n,1,l?o:a,l?a:o,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,l)}_computeProjectionTextureViewLightMatrix(){this._projectionTextureViewLightDirty=!1,this._projectionTextureDirty=!0,this.getAbsolutePosition().addToRef(this.getShadowDirection(),this._projectionTextureViewTargetVector),z.LookAtLHToRef(this.getAbsolutePosition(),this._projectionTextureViewTargetVector,this._projectionTextureUpDirection,this._projectionTextureViewLightMatrix)}_computeProjectionTextureProjectionLightMatrix(){this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0;const e=this.projectionTextureLightFar,t=this.projectionTextureLightNear,i=e/(e-t),r=-i*t,n=1/Math.tan(this._angle/2),a=1;z.FromValuesToRef(n/a,0,0,0,0,n,0,0,0,0,i,1,0,0,r,0,this._projectionTextureProjectionLightMatrix)}_computeProjectionTextureMatrix(){if(this._projectionTextureDirty=!1,this._projectionTextureViewLightMatrix.multiplyToRef(this._projectionTextureProjectionLightMatrix,this._projectionTextureMatrix),this._projectionTexture instanceof $){const e=this._projectionTexture.uScale/2,t=this._projectionTexture.vScale/2;z.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,.5,0,.5,.5,.5,1,this._projectionTextureScalingMatrix)}this._projectionTextureMatrix.multiplyToRef(this._projectionTextureScalingMatrix,this._projectionTextureMatrix)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightDirection",3),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}_computeAngleValues(){this._lightAngleScale=1/Math.max(.001,Math.cos(this._innerAngle*.5)-this._cosHalfAngle),this._lightAngleOffset=-this._cosHalfAngle*this._lightAngleScale}transferTexturesToEffect(e,t){return this.projectionTexture&&this.projectionTexture.isReady()&&(this._projectionTextureViewLightDirty&&this._computeProjectionTextureViewLightMatrix(),this._projectionTextureProjectionLightDirty&&this._computeProjectionTextureProjectionLightMatrix(),this._projectionTextureDirty&&this._computeProjectionTextureMatrix(),e.setMatrix("textureProjectionMatrix"+t,this._projectionTextureMatrix),e.setTexture("projectionLightTexture"+t,this.projectionTexture)),this._iesProfileTexture&&this._iesProfileTexture.isReady()&&e.setTexture("iesLightTexture"+t,this._iesProfileTexture),this}transferToEffect(e,t){let i;return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x-this._scene.floatingOriginOffset.x,this.transformedPosition.y-this._scene.floatingOriginOffset.y,this.transformedPosition.z-this._scene.floatingOriginOffset.z,this.exponent,t),i=x.Normalize(this.transformedDirection)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x-this._scene.floatingOriginOffset.x,this.position.y-this._scene.floatingOriginOffset.y,this.position.z-this._scene.floatingOriginOffset.z,this.exponent,t),i=x.Normalize(this.direction)),this._uniformBuffer.updateFloat4("vLightDirection",i.x,i.y,i.z,this._cosHalfAngle,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,this._lightAngleScale,this._lightAngleOffset,t),this}transferToNodeMaterialEffect(e,t){let i;return this.computeTransformedInformation()?i=x.Normalize(this.transformedDirection):i=x.Normalize(this.direction),this.getScene().useRightHandedSystem?e.setFloat3(t,-i.x,-i.y,-i.z):e.setFloat3(t,i.x,i.y,i.z),this}dispose(){super.dispose(),this._projectionTexture&&this._projectionTexture.dispose(),this._iesProfileTexture&&(this._iesProfileTexture.dispose(),this._iesProfileTexture=null)}getDepthMinZ(e){const t=this._scene.getEngine(),i=this.shadowMinZ!==void 0?this.shadowMinZ:(e==null?void 0:e.minZ)??0;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?i:this._scene.getEngine().isNDCHalfZRange?0:i}getDepthMaxZ(e){const t=this._scene.getEngine(),i=this.shadowMaxZ!==void 0?this.shadowMaxZ:(e==null?void 0:e.maxZ)??1e4;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:i}prepareLightSpecificDefines(e,t){e["SPOTLIGHT"+t]=!0,e["PROJECTEDLIGHTTEXTURE"+t]=!!(this.projectionTexture&&this.projectionTexture.isReady()),e["IESLIGHTTEXTURE"+t]=!!(this._iesProfileTexture&&this._iesProfileTexture.isReady())}}_([R()],ar.prototype,"angle",null);_([R()],ar.prototype,"innerAngle",null);_([R()],ar.prototype,"shadowAngleScale",null);_([R()],ar.prototype,"exponent",void 0);_([R()],ar.prototype,"projectionTextureLightNear",null);_([R()],ar.prototype,"projectionTextureLightFar",null);_([R()],ar.prototype,"projectionTextureUpDirection",null);_([We("projectedLightTexture")],ar.prototype,"_projectionTexture",void 0);y("BABYLON.SpotLight",ar);class ht{constructor(e,t){this.triggerOptions=e,this.onBeforeExecuteObservable=new k,e.parameter?(this.trigger=e.trigger,this._triggerParameter=e.parameter):e.trigger?this.trigger=e.trigger:this.trigger=e,this._nextActiveAction=this,this._condition=t}_prepare(){}getTriggerParameter(){return this._triggerParameter}setTriggerParameter(e){this._triggerParameter=e}_evaluateConditionForCurrentFrame(){const e=this._condition;if(!e)return!0;const t=this._actionManager.getScene().getRenderId();return e._evaluationId!==t&&(e._evaluationId=t,e._currentResult=e.isValid()),e._currentResult}_executeCurrent(e){this._evaluateConditionForCurrentFrame()&&(this.onBeforeExecuteObservable.notifyObservers(this),this._nextActiveAction.execute(e),this.skipToNextActiveAction())}execute(e){}skipToNextActiveAction(){this._nextActiveAction._child?(this._nextActiveAction._child._actionManager||(this._nextActiveAction._child._actionManager=this._actionManager),this._nextActiveAction=this._nextActiveAction._child):this._nextActiveAction=this}then(e){return this._child=e,e._actionManager=this._actionManager,e._prepare(),e}_getProperty(e){return this._actionManager._getProperty(e)}_getEffectiveTarget(e,t){return this._actionManager._getEffectiveTarget(e,t)}serialize(e){return null}_serialize(e,t){const i={type:1,children:[],name:e.name,properties:e.properties||[]};if(this._child&&this._child.serialize(i),this._condition){const r=this._condition.serialize();return r.children.push(i),t&&t.children.push(r),r}return t&&t.children.push(i),i}}ht._SerializeValueAsString=s=>typeof s=="number"?s.toString():typeof s=="boolean"?s?"true":"false":s instanceof X?s.x+", "+s.y:s instanceof x?s.x+", "+s.y+", "+s.z:s instanceof q?s.r+", "+s.g+", "+s.b:s instanceof Te?s.r+", "+s.g+", "+s.b+", "+s.a:s;ht._GetTargetProperty=s=>({name:"target",targetType:s._isMesh?"MeshProperties":s._isLight?"LightProperties":s._isCamera?"CameraProperties":s._isMaterial?"MaterialProperties":"SceneProperties",value:s._isScene?"Scene":s.name});y("BABYLON.Action",ht);class Ml{constructor(e){this._actionManager=e}isValid(){return!0}_getProperty(e){return this._actionManager._getProperty(e)}_getEffectiveTarget(e,t){return this._actionManager._getEffectiveTarget(e,t)}serialize(){}_serialize(e){return{type:2,children:[],name:e.name,properties:e.properties}}}class ni extends Ml{static get IsEqual(){return ni._IsEqual}static get IsDifferent(){return ni._IsDifferent}static get IsGreater(){return ni._IsGreater}static get IsLesser(){return ni._IsLesser}constructor(e,t,i,r,n=ni.IsEqual){super(e),this.propertyPath=i,this.value=r,this.operator=n,this._target=t,this._effectiveTarget=this._getEffectiveTarget(t,this.propertyPath),this._property=this._getProperty(this.propertyPath)}isValid(){switch(this.operator){case ni.IsGreater:return this._effectiveTarget[this._property]>this.value;case ni.IsLesser:return this._effectiveTarget[this._property]<this.value;case ni.IsEqual:case ni.IsDifferent:{let e;return this.value.equals?e=this.value.equals(this._effectiveTarget[this._property]):e=this.value===this._effectiveTarget[this._property],this.operator===ni.IsEqual?e:!e}}return!1}serialize(){return this._serialize({name:"ValueCondition",properties:[ht._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:ht._SerializeValueAsString(this.value)},{name:"operator",value:ni.GetOperatorName(this.operator)}]})}static GetOperatorName(e){switch(e){case ni._IsEqual:return"IsEqual";case ni._IsDifferent:return"IsDifferent";case ni._IsGreater:return"IsGreater";case ni._IsLesser:return"IsLesser";default:return""}}}ni._IsEqual=0;ni._IsDifferent=1;ni._IsGreater=2;ni._IsLesser=3;class TM extends Ml{constructor(e,t){super(e),this.predicate=t}isValid(){return this.predicate()}}class bM extends Ml{constructor(e,t,i){super(e),this.value=i,this._target=t}isValid(){return this._target.state===this.value}serialize(){return this._serialize({name:"StateCondition",properties:[ht._GetTargetProperty(this._target),{name:"value",value:this.value}]})}}y("BABYLON.ValueCondition",ni);y("BABYLON.PredicateCondition",TM);y("BABYLON.StateCondition",bM);class CM extends ht{constructor(e,t,i,r){super(e,r),this.propertyPath=i,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=!this._effectiveTarget[this._property]}serialize(e){return super._serialize({name:"SwitchBooleanAction",properties:[ht._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath}]},e)}}class yM extends ht{constructor(e,t,i,r){super(e,r),this.value=i,this._target=t}execute(){this._target.state=this.value}serialize(e){return super._serialize({name:"SetStateAction",properties:[ht._GetTargetProperty(this._target),{name:"value",value:this.value}]},e)}}class IM extends ht{constructor(e,t,i,r,n){super(e,n),this.propertyPath=i,this.value=r,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"SetValueAction",properties:[ht._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:ht._SerializeValueAsString(this.value)}]},e)}}class RM extends ht{constructor(e,t,i,r,n){super(e,n),this.propertyPath=i,this.value=r,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath),typeof this._effectiveTarget[this._property]!="number"&&N.Warn("Warning: IncrementValueAction can only be used with number values")}execute(){this._effectiveTarget[this._property]+=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"IncrementValueAction",properties:[ht._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:ht._SerializeValueAsString(this.value)}]},e)}}class AM extends ht{constructor(e,t,i,r,n,a){super(e,a),this.from=i,this.to=r,this.loop=n,this._target=t}_prepare(){}execute(){this._actionManager.getScene().beginAnimation(this._target,this.from,this.to,this.loop)}serialize(e){return super._serialize({name:"PlayAnimationAction",properties:[ht._GetTargetProperty(this._target),{name:"from",value:String(this.from)},{name:"to",value:String(this.to)},{name:"loop",value:ht._SerializeValueAsString(this.loop)||!1}]},e)}}class PM extends ht{constructor(e,t,i){super(e,i),this._target=t}_prepare(){}execute(){this._actionManager.getScene().stopAnimation(this._target)}serialize(e){return super._serialize({name:"StopAnimationAction",properties:[ht._GetTargetProperty(this._target)]},e)}}class NI extends ht{constructor(e=0,t){super(e,t)}execute(){}serialize(e){return super._serialize({name:"DoNothingAction",properties:[]},e)}}class OM extends ht{constructor(e,t,i,r=!0){super(e,i),this.children=t,this.enableChildrenConditions=r}_prepare(){for(let e=0;e<this.children.length;e++)this.children[e]._actionManager=this._actionManager,this.children[e]._prepare()}execute(e){for(const t of this.children)(!this.enableChildrenConditions||t._evaluateConditionForCurrentFrame())&&t.execute(e)}serialize(e){const t=super._serialize({name:"CombineAction",properties:[],combine:[]},e);for(let i=0;i<this.children.length;i++)t.combine.push(this.children[i].serialize(null));return t}}class NM extends ht{constructor(e,t,i){super(e,i),this.func=t}execute(e){this.func(e)}}class DI extends ht{constructor(e,t,i,r){super(e,r),this._target=t,this._parent=i}_prepare(){}execute(){if(this._target.parent===this._parent)return;const e=this._parent.getWorldMatrix().clone();e.invert(),this._target.position=x.TransformCoordinates(this._target.position,e),this._target.parent=this._parent}serialize(e){return super._serialize({name:"SetParentAction",properties:[ht._GetTargetProperty(this._target),ht._GetTargetProperty(this._parent)]},e)}}y("BABYLON.SetParentAction",DI);y("BABYLON.ExecuteCodeAction",NM);y("BABYLON.DoNothingAction",NI);y("BABYLON.StopAnimationAction",PM);y("BABYLON.PlayAnimationAction",AM);y("BABYLON.IncrementValueAction",RM);y("BABYLON.SetValueAction",IM);y("BABYLON.SetStateAction",yM);y("BABYLON.SetParentAction",DI);y("BABYLON.SwitchBooleanAction",CM);y("BABYLON.CombineAction",OM);class qe extends wN{constructor(e){super(),e=e||De.LastCreatedScene,e&&(this._scene=e,e.actionManagers.push(this))}dispose(){const e=this._scene.actionManagers.indexOf(this);for(let i=0;i<this.actions.length;i++){const r=this.actions[i];qe.Triggers[r.trigger]--,qe.Triggers[r.trigger]===0&&delete qe.Triggers[r.trigger]}this.actions.length=0,e>-1&&this._scene.actionManagers.splice(e,1);const t=this._scene.meshes.filter(i=>i.actionManager===this);for(const i of t)i.actionManager=null}getScene(){return this._scene}hasSpecificTriggers(e){for(let t=0;t<this.actions.length;t++){const i=this.actions[t];if(e.indexOf(i.trigger)>-1)return!0}return!1}hasSpecificTriggers2(e,t){for(let i=0;i<this.actions.length;i++){const r=this.actions[i];if(e==r.trigger||t==r.trigger)return!0}return!1}hasSpecificTrigger(e,t){for(let i=0;i<this.actions.length;i++){const r=this.actions[i];if(r.trigger===e)if(t){if(t(r.getTriggerParameter()))return!0}else return!0}return!1}get hasPointerTriggers(){for(let e=0;e<this.actions.length;e++){const t=this.actions[e];if(t.trigger>=qe.OnPickTrigger&&t.trigger<=qe.OnPointerOutTrigger)return!0}return!1}get hasPickTriggers(){for(let e=0;e<this.actions.length;e++){const t=this.actions[e];if(t.trigger>=qe.OnPickTrigger&&t.trigger<=qe.OnPickUpTrigger)return!0}return!1}registerAction(e){return e.trigger===qe.OnEveryFrameTrigger&&this.getScene().actionManager!==this?(N.Warn("OnEveryFrameTrigger can only be used with scene.actionManager"),null):(this.actions.push(e),this.getScene()._registeredActions++,qe.Triggers[e.trigger]?qe.Triggers[e.trigger]++:qe.Triggers[e.trigger]=1,e._actionManager=this,e._prepare(),e)}unregisterAction(e){const t=this.actions.indexOf(e);return t!==-1?(this.actions.splice(t,1),qe.Triggers[e.trigger]-=1,qe.Triggers[e.trigger]===0&&delete qe.Triggers[e.trigger],e._actionManager=null,this.getScene()._registeredActions--,!0):!1}processTrigger(e,t){for(let i=0;i<this.actions.length;i++){const r=this.actions[i];if(r.trigger===e){if(t&&(e===qe.OnKeyUpTrigger||e===qe.OnKeyDownTrigger)){const n=r.getTriggerParameter();if(typeof n=="function"){if(!n(t))continue}else if(n&&n!==t.sourceEvent.keyCode){if(!n.toLowerCase)continue;const a=n.toLowerCase();if(a!==t.sourceEvent.key){const o=t.sourceEvent.charCode?t.sourceEvent.charCode:t.sourceEvent.keyCode;if(String.fromCharCode(o).toLowerCase()!==a)continue}}}r._executeCurrent(t)}}}_getEffectiveTarget(e,t){const i=t.split(".");for(let r=0;r<i.length-1;r++)e=e[i[r]];return e}_getProperty(e){const t=e.split(".");return t[t.length-1]}serialize(e){const t={children:[],name:e,type:3,properties:[]};for(let i=0;i<this.actions.length;i++){const r={type:0,children:[],name:qe.GetTriggerName(this.actions[i].trigger),properties:[]},n=this.actions[i].triggerOptions;if(n&&typeof n!="number")if(n.parameter instanceof Node)r.properties.push(ht._GetTargetProperty(n.parameter));else if(typeof n.parameter=="object"){const a={};Ea.DeepCopy(n.parameter,a,["mesh"]),n.parameter&&n.parameter.mesh&&(a._meshId=n.parameter.mesh.id),r.properties.push({name:"parameter",targetType:null,value:a})}else r.properties.push({name:"parameter",targetType:null,value:n.parameter});this.actions[i].serialize(r),t.children.push(r)}return t}static Parse(e,t,i){const r=new qe(i);t===null?i.actionManager=r:t.actionManager=r;const n=(l,c)=>{const u=ki("BABYLON."+l);return u&&new u(...c)},a=(l,c,u,h)=>{if(h===null){const g=parseFloat(c);return c==="true"||c==="false"?c==="true":isNaN(g)?c:g}const d=h.split("."),f=c.split(",");for(let g=0;g<d.length;g++)u=u[d[g]];if(typeof u=="boolean")return f[0]==="true";if(typeof u=="string")return f[0];const m=[];for(let g=0;g<f.length;g++)m.push(parseFloat(f[g]));return u instanceof x?x.FromArray(m):u instanceof Ee?Ee.FromArray(m):u instanceof q?q.FromArray(m):u instanceof Te?Te.FromArray(m):parseFloat(f[0])},o=(l,c,u,h,d=null)=>{if(l.detached)return;const f=[];let m=null,g=null;const v=l.combine&&l.combine.length>0;if(l.type===2?f.push(r):f.push(c),v){const T=[];for(let C=0;C<l.combine.length;C++)o(l.combine[C],qe.NothingTrigger,u,h,T);f.push(T)}else for(let T=0;T<l.properties.length;T++){let C=l.properties[T].value;const A=l.properties[T].name,I=l.properties[T].targetType;A==="target"?I==="SceneProperties"?C=m=i:I==="MaterialProperties"?C=m=i.getMaterialByName(C):C=m=i.getNodeByName(C):A==="parent"?C=i.getNodeByName(C):A==="sound"?i.getSoundByName&&(C=i.getSoundByName(C)):A!=="propertyPath"?l.type===2&&A==="operator"?C=ni[C]:C=a(A,C,m,A==="value"?g:null):g=C,f.push(C)}if(d===null?f.push(u):f.push(null),l.name==="InterpolateValueAction"){const T=f[f.length-2];f[f.length-1]=T,f[f.length-2]=u}let E=n(l.name,f);if(E instanceof Ml&&u!==null){const T=new NI(c,u);h?h.then(T):r.registerAction(T),h=T}d===null?E instanceof Ml?(u=E,E=h):(u=null,h?h.then(E):r.registerAction(E)):d.push(E);for(let T=0;T<l.children.length;T++)o(l.children[T],c,u,E,null)};for(let l=0;l<e.children.length;l++){let c;const u=e.children[l];if(u.properties.length>0){const h=u.properties[0].value,d=u.properties[0].targetType===null?h:i.getMeshByName(h);d._meshId&&(d.mesh=i.getMeshById(d._meshId)),c={trigger:qe[u.name],parameter:d}}else c=qe[u.name];for(let h=0;h<u.children.length;h++)u.detached||o(u.children[h],c,null,null)}}static GetTriggerName(e){switch(e){case 0:return"NothingTrigger";case 1:return"OnPickTrigger";case 2:return"OnLeftPickTrigger";case 3:return"OnRightPickTrigger";case 4:return"OnCenterPickTrigger";case 5:return"OnPickDownTrigger";case 6:return"OnDoublePickTrigger";case 7:return"OnPickUpTrigger";case 8:return"OnLongPressTrigger";case 9:return"OnPointerOverTrigger";case 10:return"OnPointerOutTrigger";case 11:return"OnEveryFrameTrigger";case 12:return"OnIntersectionEnterTrigger";case 13:return"OnIntersectionExitTrigger";case 14:return"OnKeyDownTrigger";case 15:return"OnKeyUpTrigger";case 16:return"OnPickOutTrigger";default:return""}}}qe.NothingTrigger=0;qe.OnPickTrigger=1;qe.OnLeftPickTrigger=2;qe.OnRightPickTrigger=3;qe.OnCenterPickTrigger=4;qe.OnPickDownTrigger=5;qe.OnDoublePickTrigger=6;qe.OnPickUpTrigger=7;qe.OnPickOutTrigger=16;qe.OnLongPressTrigger=8;qe.OnPointerOverTrigger=9;qe.OnPointerOutTrigger=10;qe.OnEveryFrameTrigger=11;qe.OnIntersectionEnterTrigger=12;qe.OnIntersectionExitTrigger=13;qe.OnKeyDownTrigger=14;qe.OnKeyUpTrigger=15;class DM extends ht{constructor(e,t,i){super(e,i),this._sound=t}_prepare(){}execute(){this._sound!==void 0&&this._sound.play()}serialize(e){return super._serialize({name:"PlaySoundAction",properties:[{name:"sound",value:this._sound.name}]},e)}}class MM extends ht{constructor(e,t,i){super(e,i),this._sound=t}_prepare(){}execute(){this._sound!==void 0&&this._sound.stop()}serialize(e){return super._serialize({name:"StopSoundAction",properties:[{name:"sound",value:this._sound.name}]},e)}}y("BABYLON.PlaySoundAction",DM);y("BABYLON.StopSoundAction",MM);class FM extends ht{constructor(e,t,i,r,n=1e3,a,o,l){super(e,a),this.duration=1e3,this.onInterpolationDoneObservable=new k,this.propertyPath=i,this.value=r,this.duration=n,this.stopOtherAnimations=o,this.onInterpolationDone=l,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){const e=this._actionManager.getScene(),t=[{frame:0,value:this._effectiveTarget[this._property]},{frame:100,value:this.value}];let i;if(typeof this.value=="number")i=pe.ANIMATIONTYPE_FLOAT;else if(this.value instanceof q)i=pe.ANIMATIONTYPE_COLOR3;else if(this.value instanceof x)i=pe.ANIMATIONTYPE_VECTOR3;else if(this.value instanceof z)i=pe.ANIMATIONTYPE_MATRIX;else if(this.value instanceof Z)i=pe.ANIMATIONTYPE_QUATERNION;else{N.Warn("InterpolateValueAction: Unsupported type ("+typeof this.value+")");return}const r=new pe("InterpolateValueAction",this._property,100*(1e3/this.duration),i,pe.ANIMATIONLOOPMODE_CONSTANT);r.setKeys(t),this.stopOtherAnimations&&e.stopAnimation(this._effectiveTarget);const n=()=>{this.onInterpolationDoneObservable.notifyObservers(this),this.onInterpolationDone&&this.onInterpolationDone()};e.beginDirectAnimation(this._effectiveTarget,[r],0,100,!1,1,n)}serialize(e){return super._serialize({name:"InterpolateValueAction",properties:[ht._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:ht._SerializeValueAsString(this.value)},{name:"duration",value:ht._SerializeValueAsString(this.duration)},{name:"stopOtherAnimations",value:ht._SerializeValueAsString(this.stopOtherAnimations)||!1}]},e)}}y("BABYLON.InterpolateValueAction",FM);class Ct extends fi{get _matrix(){return this._compose(),this._localMatrix}set _matrix(e){e.updateFlag===this._localMatrix.updateFlag&&!this._needToCompose||(this._needToCompose=!1,this._localMatrix.copyFrom(e),this._markAsDirtyAndDecompose())}constructor(e,t,i=null,r=null,n=null,a=null,o=null){super(e,t.getScene(),!1),this.name=e,this.children=[],this.animations=[],this._index=null,this._scalingDeterminant=1,this._needToDecompose=!0,this._needToCompose=!1,this._linkedTransformNode=null,this._waitingTransformNodeId=null,this._skeleton=t,this._localMatrix=(r==null?void 0:r.clone())??z.Identity(),this._restMatrix=n??this._localMatrix.clone(),this._bindMatrix=a??this._localMatrix.clone(),this._index=o,this._absoluteMatrix=new z,this._absoluteBindMatrix=new z,this._absoluteInverseBindMatrix=new z,this._finalMatrix=new z,t.bones.push(this),this.setParent(i,!1),this._updateAbsoluteBindMatrices()}getClassName(){return"Bone"}getSkeleton(){return this._skeleton}get parent(){return this._parentNode}getParent(){return this.parent}getChildren(){return this.children}getIndex(){return this._index===null?this.getSkeleton().bones.indexOf(this):this._index}set parent(e){this.setParent(e)}setParent(e,t=!0){if(this.parent!==e){if(this.parent){const i=this.parent.children.indexOf(this);i!==-1&&this.parent.children.splice(i,1)}this._parentNode=e,this.parent&&this.parent.children.push(this),t&&this._updateAbsoluteBindMatrices(),this.markAsDirty()}}getLocalMatrix(){return this._compose(),this._localMatrix}getBindMatrix(){return this._bindMatrix}getBaseMatrix(){return this.getBindMatrix()}getRestMatrix(){return this._restMatrix}getRestPose(){return this.getRestMatrix()}setRestMatrix(e){this._restMatrix.copyFrom(e)}setRestPose(e){this.setRestMatrix(e)}getBindPose(){return this.getBindMatrix()}setBindMatrix(e){this.updateMatrix(e)}setBindPose(e){this.setBindMatrix(e)}getFinalMatrix(){return this._finalMatrix}getWorldMatrix(){return this.getFinalMatrix()}returnToRest(){if(this._linkedTransformNode){const e=G.Vector3[0],t=G.Quaternion[0],i=G.Vector3[1];this.getRestMatrix().decompose(e,t,i),this._linkedTransformNode.position.copyFrom(i),this._linkedTransformNode.rotationQuaternion=this._linkedTransformNode.rotationQuaternion??Z.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(t),this._linkedTransformNode.scaling.copyFrom(e)}else this._matrix=this._restMatrix}getAbsoluteInverseBindMatrix(){return this._absoluteInverseBindMatrix}getInvertedAbsoluteTransform(){return this.getAbsoluteInverseBindMatrix()}getAbsoluteMatrix(){return this._skeleton.computeAbsoluteMatrices(),this._absoluteMatrix}getAbsoluteTransform(){return this.getAbsoluteMatrix()}linkTransformNode(e){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=e,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++}getTransformNode(){return this._linkedTransformNode}get position(){return this._decompose(),this._localPosition}set position(e){this._decompose(),this._localPosition.copyFrom(e),this._markAsDirtyAndCompose()}get rotation(){return this.getRotation()}set rotation(e){this.setRotation(e)}get rotationQuaternion(){return this._decompose(),this._localRotation}set rotationQuaternion(e){this.setRotationQuaternion(e)}get scaling(){return this.getScale()}set scaling(e){this.setScale(e)}get animationPropertiesOverride(){return this._skeleton.animationPropertiesOverride}_decompose(){this._needToDecompose&&(this._needToDecompose=!1,this._localScaling||(this._localScaling=x.Zero(),this._localRotation=Z.Zero(),this._localPosition=x.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))}_compose(){if(this._needToCompose){if(!this._localScaling){this._needToCompose=!1;return}this._needToCompose=!1,z.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)}}updateMatrix(e,t=!0,i=!0){this._bindMatrix.copyFrom(e),t&&this._updateAbsoluteBindMatrices(),i?this._matrix=e:this.markAsDirty()}_updateAbsoluteBindMatrices(e,t=!0){if(e||(e=this._bindMatrix),this.parent?e.multiplyToRef(this.parent._absoluteBindMatrix,this._absoluteBindMatrix):this._absoluteBindMatrix.copyFrom(e),this._absoluteBindMatrix.invertToRef(this._absoluteInverseBindMatrix),t)for(let i=0;i<this.children.length;i++)this.children[i]._updateAbsoluteBindMatrices();this._scalingDeterminant=this._absoluteBindMatrix.determinant()<0?-1:1}markAsDirty(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this}_markAsDirtyAndCompose(){this.markAsDirty(),this._needToCompose=!0}_markAsDirtyAndDecompose(){this.markAsDirty(),this._needToDecompose=!0}_updatePosition(e,t=0,i,r=!0){const n=this.getLocalMatrix();if(t==0)r?(n.addAtIndex(12,e.x),n.addAtIndex(13,e.y),n.addAtIndex(14,e.z)):n.setTranslationFromFloats(e.x,e.y,e.z);else{const a=Ct._TmpMats[0],o=Ct._TmpVecs[0];this.parent?(a.copyFrom(this.parent.getAbsoluteMatrix()),i&&a.multiplyToRef(i.getWorldMatrix(),a)):z.IdentityToRef(a),r&&a.setTranslationFromFloats(0,0,0),a.invert(),x.TransformCoordinatesToRef(e,a,o),r?(n.addAtIndex(12,o.x),n.addAtIndex(13,o.y),n.addAtIndex(14,o.z)):n.setTranslationFromFloats(o.x,o.y,o.z)}this._markAsDirtyAndDecompose()}translate(e,t=0,i){this._updatePosition(e,t,i,!0)}setPosition(e,t=0,i){this._updatePosition(e,t,i,!1)}setAbsolutePosition(e,t){this.setPosition(e,1,t)}scale(e,t,i,r=!1){const n=this.getLocalMatrix(),a=Ct._TmpMats[0];z.ScalingToRef(e,t,i,a),a.multiplyToRef(n,n),a.invert();for(const o of this.children){const l=o.getLocalMatrix();l.multiplyToRef(a,l),l.multiplyAtIndex(12,e),l.multiplyAtIndex(13,t),l.multiplyAtIndex(14,i),o._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),r)for(const o of this.children)o.scale(e,t,i,r)}setScale(e){this._decompose(),this._localScaling.copyFrom(e),this._markAsDirtyAndCompose()}getScale(){return this._decompose(),this._localScaling}getScaleToRef(e){this._decompose(),e.copyFrom(this._localScaling)}setYawPitchRoll(e,t,i,r=0,n){if(r===0){const l=Ct._TmpQuat;Z.RotationYawPitchRollToRef(e,t,i,l),this.setRotationQuaternion(l,r,n);return}const a=Ct._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(a,n))return;const o=Ct._TmpMats[1];z.RotationYawPitchRollToRef(e,t,i,o),a.multiplyToRef(o,o),this._rotateWithMatrix(o,r,n)}rotate(e,t,i=0,r){const n=Ct._TmpMats[0];n.setTranslationFromFloats(0,0,0),z.RotationAxisToRef(e,t,n),this._rotateWithMatrix(n,i,r)}setAxisAngle(e,t,i=0,r){if(i===0){const o=Ct._TmpQuat;Z.RotationAxisToRef(e,t,o),this.setRotationQuaternion(o,i,r);return}const n=Ct._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(n,r))return;const a=Ct._TmpMats[1];z.RotationAxisToRef(e,t,a),n.multiplyToRef(a,a),this._rotateWithMatrix(a,i,r)}setRotation(e,t=0,i){this.setYawPitchRoll(e.y,e.x,e.z,t,i)}setRotationQuaternion(e,t=0,i){if(t===0){this._decompose(),this._localRotation.copyFrom(e),this._markAsDirtyAndCompose();return}const r=Ct._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(r,i))return;const n=Ct._TmpMats[1];z.FromQuaternionToRef(e,n),r.multiplyToRef(n,n),this._rotateWithMatrix(n,t,i)}setRotationMatrix(e,t=0,i){if(t===0){const a=Ct._TmpQuat;Z.FromRotationMatrixToRef(e,a),this.setRotationQuaternion(a,t,i);return}const r=Ct._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(r,i))return;const n=Ct._TmpMats[1];n.copyFrom(e),r.multiplyToRef(e,n),this._rotateWithMatrix(n,t,i)}_rotateWithMatrix(e,t=0,i){const r=this.getLocalMatrix(),n=r.m[12],a=r.m[13],o=r.m[14],l=this.getParent(),c=Ct._TmpMats[3],u=Ct._TmpMats[4];l&&t==1?(i?(c.copyFrom(i.getWorldMatrix()),l.getAbsoluteMatrix().multiplyToRef(c,c)):c.copyFrom(l.getAbsoluteMatrix()),u.copyFrom(c),u.invert(),r.multiplyToRef(c,r),r.multiplyToRef(e,r),r.multiplyToRef(u,r)):t==1&&i?(c.copyFrom(i.getWorldMatrix()),u.copyFrom(c),u.invert(),r.multiplyToRef(c,r),r.multiplyToRef(e,r),r.multiplyToRef(u,r)):r.multiplyToRef(e,r),r.setTranslationFromFloats(n,a,o),this._markAsDirtyAndDecompose()}_getAbsoluteInverseMatrixUnscaledToRef(e,t){const i=Ct._TmpMats[2];return e.copyFrom(this.getAbsoluteMatrix()),t?(e.multiplyToRef(t.getWorldMatrix(),e),z.ScalingToRef(t.scaling.x,t.scaling.y,t.scaling.z,i)):z.IdentityToRef(i),e.invert(),isNaN(e.m[0])?!1:(i.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyToRef(i,e),!0)}getPosition(e=0,t=null){const i=x.Zero();return this.getPositionToRef(e,t,i),i}getPositionToRef(e=0,t,i){if(e==0){const r=this.getLocalMatrix();i.x=r.m[12],i.y=r.m[13],i.z=r.m[14]}else{const r=Ct._TmpMats[0].copyFrom(this.getAbsoluteMatrix());t&&r.multiplyToRef(t.getWorldMatrix(),r),i.x=r.m[12],i.y=r.m[13],i.z=r.m[14]}}getAbsolutePosition(e=null){const t=x.Zero();return this.getPositionToRef(1,e,t),t}getAbsolutePositionToRef(e,t){this.getPositionToRef(1,e,t)}computeAbsoluteMatrices(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteMatrix,this._absoluteMatrix);else{this._absoluteMatrix.copyFrom(this._localMatrix);const i=this._skeleton.getPoseMatrix();i&&this._absoluteMatrix.multiplyToRef(i,this._absoluteMatrix)}const e=this.children,t=e.length;for(let i=0;i<t;i++)e[i].computeAbsoluteMatrices()}computeAbsoluteTransforms(){this.computeAbsoluteMatrices()}getDirection(e,t=null){const i=x.Zero();return this.getDirectionToRef(e,t,i),i}getDirectionToRef(e,t=null,i){const r=Ct._TmpMats[0].copyFrom(this.getAbsoluteMatrix());t&&r.multiplyToRef(t.getWorldMatrix(),r),x.TransformNormalToRef(e,r,i),i.normalize()}getRotation(e=0,t=null){const i=x.Zero();return this.getRotationToRef(e,t,i),i}getRotationToRef(e=0,t=null,i){const r=Ct._TmpQuat;this.getRotationQuaternionToRef(e,t,r),r.toEulerAnglesToRef(i)}getRotationQuaternion(e=0,t=null){const i=Z.Identity();return this.getRotationQuaternionToRef(e,t,i),i}getRotationQuaternionToRef(e=0,t=null,i){if(e==0)this._decompose(),i.copyFrom(this._localRotation);else{const r=Ct._TmpMats[0],n=this.getAbsoluteMatrix();t?n.multiplyToRef(t.getWorldMatrix(),r):r.copyFrom(n),r.multiplyAtIndex(0,this._scalingDeterminant),r.multiplyAtIndex(1,this._scalingDeterminant),r.multiplyAtIndex(2,this._scalingDeterminant),r.decompose(void 0,i,void 0)}}getRotationMatrix(e=0,t){const i=z.Identity();return this.getRotationMatrixToRef(e,t,i),i}getRotationMatrixToRef(e=0,t,i){if(e==0)this.getLocalMatrix().getRotationMatrixToRef(i);else{const r=Ct._TmpMats[0],n=this.getAbsoluteMatrix();t?n.multiplyToRef(t.getWorldMatrix(),r):r.copyFrom(n),r.multiplyAtIndex(0,this._scalingDeterminant),r.multiplyAtIndex(1,this._scalingDeterminant),r.multiplyAtIndex(2,this._scalingDeterminant),r.getRotationMatrixToRef(i)}}getAbsolutePositionFromLocal(e,t=null){const i=x.Zero();return this.getAbsolutePositionFromLocalToRef(e,t,i),i}getAbsolutePositionFromLocalToRef(e,t=null,i){const r=Ct._TmpMats[0].copyFrom(this.getAbsoluteMatrix());t&&r.multiplyToRef(t.getWorldMatrix(),r),x.TransformCoordinatesToRef(e,r,i)}getLocalPositionFromAbsolute(e,t=null){const i=x.Zero();return this.getLocalPositionFromAbsoluteToRef(e,t,i),i}getLocalPositionFromAbsoluteToRef(e,t=null,i){const r=Ct._TmpMats[0].copyFrom(this.getAbsoluteMatrix());t&&r.multiplyToRef(t.getWorldMatrix(),r),r.invert(),x.TransformCoordinatesToRef(e,r,i)}setCurrentPoseAsRest(){this.setRestMatrix(this.getLocalMatrix())}dispose(){this._linkedTransformNode=null;const e=this._skeleton.bones.indexOf(this);if(e!==-1&&this._skeleton.bones.splice(e,1),this._parentNode&&this._parentNode.children){const t=this._parentNode.children,i=t.indexOf(this);i!==-1&&t.splice(i,1)}super.dispose()}}Ct._TmpVecs=Fo(2,x.Zero);Ct._TmpQuat=Z.Identity();Ct._TmpMats=Fo(5,z.Identity);class LM{get currentFrame(){return this._currentFrame}get weight(){return this._weight}get currentValue(){return this._currentValue}get targetPath(){return this._targetPath}get target(){return this._currentActiveTarget}get isAdditive(){return this._host&&this._host.isAdditive}constructor(e,t,i,r){if(this._events=new Array,this._currentFrame=0,this._originalValue=new Array,this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._absoluteFrameOffset=0,this._previousElapsedTime=0,this._yoyoDirection=1,this._previousAbsoluteFrame=0,this._targetIsArray=!1,this._coreRuntimeAnimation=null,this._animation=t,this._target=e,this._scene=i,this._host=r,this._activeTargets=[],t._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===pe.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=z.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minValue=this._keys[0].value,this._maxValue=this._keys[this._keys.length-1].value,this._minFrame!==0){const a={frame:0,value:this._minValue};this._keys.splice(0,0,a)}if(this._target instanceof Array){let a=0;for(const o of this._target)this._preparePath(o,a),this._getOriginalValues(a),a++;this._targetIsArray=!0}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=!1,this._directTarget=this._activeTargets[0];const n=t.getEvents();if(n&&n.length>0)for(const a of n)this._events.push(a._clone());this._enableBlending=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.enableBlending:this._animation.enableBlending}_preparePath(e,t=0){const i=this._animation.targetPropertyPath;if(i.length>1){let r=e;for(let n=0;n<i.length-1;n++){const a=i[n];if(r=r[a],r===void 0)throw new Error(`Invalid property (${a}) in property path (${i.join(".")})`)}this._targetPath=i[i.length-1],this._activeTargets[t]=r}else this._targetPath=i[0],this._activeTargets[t]=e;if(this._activeTargets[t][this._targetPath]===void 0)throw new Error(`Invalid property (${this._targetPath}) in property path (${i.join(".")})`)}get animation(){return this._animation}reset(e=!1){if(e)if(this._target instanceof Array){let t=0;for(const i of this._target)this._originalValue[t]!==void 0&&this._setValue(i,this._activeTargets[t],this._originalValue[t],-1,t),t++}else this._originalValue[0]!==void 0&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(let t=0;t<this._events.length;t++)this._events[t].isDone=!1}isStopped(){return this._stopped}dispose(){const e=this._animation.runtimeAnimations.indexOf(this);e>-1&&this._animation.runtimeAnimations.splice(e,1)}setValue(e,t){if(this._targetIsArray){for(let i=0;i<this._target.length;i++){const r=this._target[i];this._setValue(r,this._activeTargets[i],e,t,i)}return}this._setValue(this._target,this._directTarget,e,t,0)}_getOriginalValues(e=0){let t;const i=this._activeTargets[e];i.getLocalMatrix&&this._targetPath==="_matrix"?t=i.getLocalMatrix():t=i[this._targetPath],t&&t.clone?this._originalValue[e]=t.clone():this._originalValue[e]=t}_registerTargetForLateAnimationBinding(e,t){const i=e.target;this._scene._registeredForLateAnimationBindings.pushNoDuplicate(i),i._lateAnimationHolders||(i._lateAnimationHolders={}),i._lateAnimationHolders[e.targetPath]||(i._lateAnimationHolders[e.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:t}),e.isAdditive?(i._lateAnimationHolders[e.targetPath].additiveAnimations.push(e),i._lateAnimationHolders[e.targetPath].totalAdditiveWeight+=e.weight):(i._lateAnimationHolders[e.targetPath].animations.push(e),i._lateAnimationHolders[e.targetPath].totalWeight+=e.weight)}_setValue(e,t,i,r,n){if(this._currentActiveTarget=t,this._weight=r,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){const o=t[this._targetPath];o.clone?this._originalBlendValue=o.clone():this._originalBlendValue=o}this._originalBlendValue.m?pe.AllowMatrixDecomposeForInterpolation?this._currentValue?z.DecomposeLerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=z.DecomposeLerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue?z.LerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=z.Lerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue=pe._UniversalLerp(this._originalBlendValue,i,this._blendingFactor);const a=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;this._blendingFactor+=a}else this._currentValue?this._currentValue.copyFrom?this._currentValue.copyFrom(i):this._currentValue=i:i!=null&&i.clone?this._currentValue=i.clone():this._currentValue=i;r!==-1?this._registerTargetForLateAnimationBinding(this,this._originalValue[n]):this._animationState.loopMode===pe.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT?this._currentValue.addToRef?this._currentValue.addToRef(this._originalValue[n],t[this._targetPath]):t[this._targetPath]=this._originalValue[n]+this._currentValue:t[this._targetPath]=this._currentValue,e.markAsDirty&&e.markAsDirty(this._animation.targetProperty)}_getCorrectLoopMode(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode}goToFrame(e,t=-1){const i=this._animation.getKeys();e<i[0].frame?e=i[0].frame:e>i[i.length-1].frame&&(e=i[i.length-1].frame);const r=this._events;if(r.length)for(let a=0;a<r.length;a++)r[a].onlyOnce||(r[a].isDone=r[a].frame<e);this._currentFrame=e;const n=this._animation._interpolate(e,this._animationState);this.setValue(n,t)}_prepareForSpeedRatioChange(e){const t=this._previousElapsedTime*(this._animation.framePerSecond*e)/1e3;this._absoluteFrameOffset=this._previousAbsoluteFrame-t}animate(e,t,i,r,n,a=-1){const o=this._animation,l=o.targetPropertyPath;if(!l||l.length<1)return this._stopped=!0,!1;let c=!0,u;const h=this._events;let d=0;if(this._coreRuntimeAnimation)d=i-t,u=this._coreRuntimeAnimation.currentFrame,this._currentFrame=u,this._animationState.repeatCount=this._coreRuntimeAnimation._animationState.repeatCount,this._animationState.highLimitValue=this._coreRuntimeAnimation._animationState.highLimitValue,this._animationState.offsetValue=this._coreRuntimeAnimation._animationState.offsetValue;else{(t<this._minFrame||t>this._maxFrame)&&(t=this._minFrame),(i<this._minFrame||i>this._maxFrame)&&(i=this._maxFrame),d=i-t;let m,g=e*(o.framePerSecond*n)/1e3+this._absoluteFrameOffset,v=0,E=!1;const T=r&&this._animationState.loopMode===pe.ANIMATIONLOOPMODE_YOYO;if(T){const C=(g-t)/d,A=Math.sin(C*Math.PI);g=Math.abs(A)*d+t;const F=A>=0?1:-1;this._yoyoDirection!==F&&(E=!0),this._yoyoDirection=F}if(this._previousElapsedTime=e,this._previousAbsoluteFrame=g,!r&&i>=t&&(g>=d&&n>0||g<=0&&n<0))c=!1,v=o._getKeyValue(this._maxValue);else if(!r&&t>=i&&(g<=d&&n<0||g>=0&&n>0))c=!1,v=o._getKeyValue(this._minValue);else if(this._animationState.loopMode!==pe.ANIMATIONLOOPMODE_CYCLE){const C=i.toString()+t.toString();if(!this._offsetsCache[C]){this._animationState.repeatCount=0,this._animationState.loopMode=pe.ANIMATIONLOOPMODE_CYCLE;const A=o._interpolate(t,this._animationState),I=o._interpolate(i,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),o.dataType){case pe.ANIMATIONTYPE_FLOAT:this._offsetsCache[C]=I-A;break;case pe.ANIMATIONTYPE_QUATERNION:this._offsetsCache[C]=I.subtract(A);break;case pe.ANIMATIONTYPE_VECTOR3:this._offsetsCache[C]=I.subtract(A);break;case pe.ANIMATIONTYPE_VECTOR2:this._offsetsCache[C]=I.subtract(A);break;case pe.ANIMATIONTYPE_SIZE:this._offsetsCache[C]=I.subtract(A);break;case pe.ANIMATIONTYPE_COLOR3:this._offsetsCache[C]=I.subtract(A);break}this._highLimitsCache[C]=I}v=this._highLimitsCache[C],m=this._offsetsCache[C]}if(m===void 0)switch(o.dataType){case pe.ANIMATIONTYPE_FLOAT:m=0;break;case pe.ANIMATIONTYPE_QUATERNION:m=zN;break;case pe.ANIMATIONTYPE_VECTOR3:m=GN;break;case pe.ANIMATIONTYPE_VECTOR2:m=kN;break;case pe.ANIMATIONTYPE_SIZE:m=UN;break;case pe.ANIMATIONTYPE_COLOR3:m=VN;break;case pe.ANIMATIONTYPE_COLOR4:m=BN;break}if(this._host&&this._host.syncRoot){const C=this._host.syncRoot,A=(C.masterFrame-C.fromFrame)/(C.toFrame-C.fromFrame);u=t+d*A}else g>0&&t>i||g<0&&t<i?u=c&&d!==0?i+g%d:t:u=c&&d!==0?t+g%d:i;if(!T&&(n>0&&this.currentFrame>u||n<0&&this.currentFrame<u)||T&&E){this._onLoop();for(let C=0;C<h.length;C++)h[C].onlyOnce||(h[C].isDone=!1);this._animationState.key=n>0?0:o.getKeys().length-1}this._currentFrame=u,this._animationState.repeatCount=d===0?0:g/d>>0,this._animationState.highLimitValue=v,this._animationState.offsetValue=m}const f=o._interpolate(u,this._animationState);if(this.setValue(f,a),h.length){for(let m=0;m<h.length;m++)if(d>=0&&u>=h[m].frame&&h[m].frame>=t||d<0&&u<=h[m].frame&&h[m].frame<=t){const g=h[m];g.isDone||(g.onlyOnce&&(h.splice(m,1),m--),g.isDone=!0,g.action(u))}}return c||(this._stopped=!0),c}}class Fl{get syncRoot(){return this._syncRoot}get masterFrame(){return this._runtimeAnimations.length===0?0:this._runtimeAnimations[0].currentFrame}get weight(){return this._weight}set weight(e){if(e===-1){this._weight=-1;return}this._weight=Math.min(Math.max(e,0),1)}get speedRatio(){return this._speedRatio}set speedRatio(e){for(let t=0;t<this._runtimeAnimations.length;t++)this._runtimeAnimations[t]._prepareForSpeedRatioChange(e);this._speedRatio=e,this._goToFrame!==null&&this.goToFrame(this._goToFrame)}get elapsedTime(){return this._localDelayOffset===null?0:this._scene._animationTime-this._localDelayOffset}constructor(e,t,i=0,r=100,n=!1,a=1,o,l,c,u=!1,h=0){this.target=t,this.fromFrame=i,this.toFrame=r,this.loopAnimation=n,this.onAnimationEnd=o,this.onAnimationLoop=c,this.isAdditive=u,this.playOrder=h,this._localDelayOffset=null,this._pausedDelay=null,this._manualJumpDelay=null,this._runtimeAnimations=new Array,this._paused=!1,this._speedRatio=1,this._weight=-1,this._previousWeight=-1,this._syncRoot=null,this._frameToSyncFromJump=null,this._goToFrame=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new k,this.onAnimationLoopObservable=new k,this._scene=e,l&&this.appendAnimations(t,l),this._speedRatio=a,e._activeAnimatables.push(this)}syncWith(e){if(this._syncRoot=e,e){const t=this._scene._activeAnimatables.indexOf(this);t>-1&&(this._scene._activeAnimatables.splice(t,1),this._scene._activeAnimatables.push(this))}return this}getAnimations(){return this._runtimeAnimations}appendAnimations(e,t){for(let i=0;i<t.length;i++){const r=t[i],n=new LM(e,r,this._scene,this);n._onLoop=()=>{this.onAnimationLoopObservable.notifyObservers(this),this.onAnimationLoop&&this.onAnimationLoop()},this._runtimeAnimations.push(n)}}getAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i].animation;return null}getRuntimeAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i];return null}reset(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].reset(!0);this._localDelayOffset=null,this._pausedDelay=null}enableBlending(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)t[i].animation.enableBlending=!0,t[i].animation.blendingSpeed=e}disableBlending(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].animation.enableBlending=!1}goToFrame(e,t=!1){const i=this._runtimeAnimations;if(i[0]){const r=i[0].animation.framePerSecond;this._frameToSyncFromJump=this._frameToSyncFromJump??i[0].currentFrame;const n=this.speedRatio===0?0:(e-this._frameToSyncFromJump)/r*1e3/this.speedRatio;this._manualJumpDelay=-n}for(let r=0;r<i.length;r++)i[r].goToFrame(e,t?this._weight:-1);this._goToFrame=e}get paused(){return this._paused}pause(){this._paused||(this._paused=!0)}restart(){this._paused=!1}_raiseOnAnimationEnd(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)}stop(e,t,i=!1,r=!1){if(e||t){const n=this._scene._activeAnimatables.indexOf(this);if(n>-1){const a=this._runtimeAnimations;for(let o=a.length-1;o>=0;o--){const l=a[o];e&&l.animation.name!=e||t&&!t(l.target)||(l.dispose(),a.splice(o,1))}a.length==0&&(i||this._scene._activeAnimatables.splice(n,1),r||this._raiseOnAnimationEnd())}}else{const n=this._scene._activeAnimatables.indexOf(this);if(n>-1){i||this._scene._activeAnimatables.splice(n,1);const a=this._runtimeAnimations;for(let o=0;o<a.length;o++)a[o].dispose();this._runtimeAnimations.length=0,r||this._raiseOnAnimationEnd()}}}async waitAsync(){return await new Promise(e=>{this.onAnimationEndObservable.add(()=>{e(this)},void 0,void 0,this,!0)})}_animate(e){if(this._paused)return this.animationStarted=!1,this._pausedDelay===null&&(this._pausedDelay=e),!0;if(this._localDelayOffset===null?(this._localDelayOffset=e,this._pausedDelay=null):this._pausedDelay!==null&&(this._localDelayOffset+=e-this._pausedDelay,this._pausedDelay=null),this._manualJumpDelay!==null&&(this._localDelayOffset+=this.speedRatio<0?-this._manualJumpDelay:this._manualJumpDelay,this._manualJumpDelay=null,this._frameToSyncFromJump=null),this._goToFrame=null,!Fl.ProcessPausedAnimatables&&this._weight===0&&this._previousWeight===0)return!0;this._previousWeight=this._weight;let t=!1;const i=this._runtimeAnimations;let r;for(r=0;r<i.length;r++){const a=i[r].animate(e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);t=t||a}if(this.animationStarted=t,!t){if(this.disposeOnEnd)for(r=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(r,1),r=0;r<i.length;r++)i[r].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return t}}Fl.ProcessPausedAnimatables=!1;function wM(s){if(s.totalWeight===0&&s.totalAdditiveWeight===0)return s.originalValue;let e=1;const t=G.Vector3[0],i=G.Vector3[1],r=G.Quaternion[0];let n=0;const a=s.animations[0],o=s.originalValue;let l=1,c=!1;if(s.totalWeight<1)l=1-s.totalWeight,o.decompose(i,r,t);else{if(n=1,e=s.totalWeight,l=a.weight/e,l==1)if(s.totalAdditiveWeight)c=!0;else return a.currentValue;a.currentValue.decompose(i,r,t)}if(!c){i.scaleInPlace(l),t.scaleInPlace(l),r.scaleInPlace(l);for(let h=n;h<s.animations.length;h++){const d=s.animations[h];if(d.weight===0)continue;l=d.weight/e;const f=G.Vector3[2],m=G.Vector3[3],g=G.Quaternion[1];d.currentValue.decompose(m,g,f),m.scaleAndAddToRef(l,i),g.scaleAndAddToRef(Z.Dot(r,g)>0?l:-l,r),f.scaleAndAddToRef(l,t)}r.normalize()}for(let h=0;h<s.additiveAnimations.length;h++){const d=s.additiveAnimations[h];if(d.weight===0)continue;const f=G.Vector3[2],m=G.Vector3[3],g=G.Quaternion[1];d.currentValue.decompose(m,g,f),m.multiplyToRef(i,m),x.LerpToRef(i,m,d.weight,i),r.multiplyToRef(g,g),Z.SlerpToRef(r,g,d.weight,r),f.scaleAndAddToRef(d.weight,t)}const u=a?a._animationState.workValue:G.Matrix[0].clone();return z.ComposeToRef(i,r,t,u),u}function BM(s,e){if(s.totalWeight===0&&s.totalAdditiveWeight===0)return e;const t=s.animations[0],i=s.originalValue;let r=e;if(s.totalWeight===0&&s.totalAdditiveWeight>0)r.copyFrom(i);else if(s.animations.length===1){if(Z.SlerpToRef(i,t.currentValue,Math.min(1,s.totalWeight),r),s.totalAdditiveWeight===0)return r}else if(s.animations.length>1){let n=1,a,o;if(s.totalWeight<1){const c=1-s.totalWeight;a=[],o=[],a.push(i),o.push(c)}else{if(s.animations.length===2&&(Z.SlerpToRef(s.animations[0].currentValue,s.animations[1].currentValue,s.animations[1].weight/s.totalWeight,e),s.totalAdditiveWeight===0))return e;a=[],o=[],n=s.totalWeight}for(let c=0;c<s.animations.length;c++){const u=s.animations[c];a.push(u.currentValue),o.push(u.weight/n)}let l=0;for(let c=0;c<a.length;){if(!c){Z.SlerpToRef(a[c],a[c+1],o[c+1]/(o[c]+o[c+1]),e),r=e,l=o[c]+o[c+1],c+=2;continue}l+=o[c],Z.SlerpToRef(r,a[c],o[c]/l,r),c++}}for(let n=0;n<s.additiveAnimations.length;n++){const a=s.additiveAnimations[n];a.weight!==0&&(r.multiplyToRef(a.currentValue,G.Quaternion[0]),Z.SlerpToRef(r,G.Quaternion[0],a.weight,r))}return r}function VM(s){if(s._registeredForLateAnimationBindings.length){for(let e=0;e<s._registeredForLateAnimationBindings.length;e++){const t=s._registeredForLateAnimationBindings.data[e];for(const i in t._lateAnimationHolders){const r=t._lateAnimationHolders[i],n=r.animations[0],a=r.originalValue;if(a==null)continue;const o=pe.AllowMatrixDecomposeForInterpolation&&a.m;let l=t[i];if(o)l=wM(r);else if(a.w!==void 0)l=BM(r,l||Z.Identity());else{let u=0,h=1;const d=n&&n._animationState.loopMode===pe.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT;if(r.totalWeight<1)d?l=a.clone?a.clone():a:n&&a.scale?l=a.scale(1-r.totalWeight):n?l=a*(1-r.totalWeight):a.clone?l=a.clone():l=a;else if(n){h=r.totalWeight;const f=n.weight/h;f!==1?n.currentValue.scale?l=n.currentValue.scale(f):l=n.currentValue*f:l=n.currentValue,d&&(l.addToRef?l.addToRef(a,l):l+=a),u=1}for(let f=u;f<r.animations.length;f++){const m=r.animations[f],g=m.weight/h;if(g)m.currentValue.scaleAndAddToRef?m.currentValue.scaleAndAddToRef(g,l):l+=m.currentValue*g;else continue}for(let f=0;f<r.additiveAnimations.length;f++){const m=r.additiveAnimations[f],g=m.weight;if(g)m.currentValue.scaleAndAddToRef?m.currentValue.scaleAndAddToRef(g,l):l+=m.currentValue*g;else continue}}t[i]=l}t._lateAnimationHolders={}}s._registeredForLateAnimationBindings.reset()}}function UM(s,e){e&&(e.prototype.copyAnimationRange=function(t,i,r,n=!1,a=null){this.animations.length===0&&(this.animations.push(new pe(this.name,"_matrix",t.animations[0].framePerSecond,pe.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));const o=t.animations[0].getRange(i);if(!o)return!1;const l=o.from,c=o.to,u=t.animations[0].getKeys(),h=t.length,d=t.getParent(),f=this.getParent(),m=n&&d&&h&&this.length&&h!==this.length,g=m&&f&&d?f.length/d.length:1,v=n&&!f&&a&&(a.x!==1||a.y!==1||a.z!==1),E=this.animations[0].getKeys();let T,C,A;for(let I=0,F=u.length;I<F;I++)T=u[I],T.frame>=l&&T.frame<=c&&(n?(A=T.value.clone(),m?(C=A.getTranslation(),A.setTranslation(C.scaleInPlace(g))):v&&a?(C=A.getTranslation(),A.setTranslation(C.multiplyInPlace(a))):A=T.value):A=T.value,E.push({frame:T.frame+r,value:A}));return this.animations[0].createRange(i,l+r,c+r),!0}),s&&(s.prototype._animate=function(t){if(!this.animationsEnabled)return;const i=Qr.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=i}this.deltaTime=t!==void 0?t:this.useConstantAnimationDeltaTime?16:(i-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=i;const r=this._activeAnimatables;if(r.length===0)return;this._animationTime+=this.deltaTime;const n=this._animationTime;for(let a=0;a<r.length;a++){const o=r[a];!o._animate(n)&&o.disposeOnEnd&&a--}VM(this)},s.prototype.sortActiveAnimatables=function(){this._activeAnimatables.sort((t,i)=>t.playOrder-i.playOrder)},s.prototype.beginWeightedAnimation=function(t,i,r,n=1,a,o=1,l,c,u,h,d=!1){const f=this.beginAnimation(t,i,r,a,o,l,c,!1,u,h,d);return f.weight=n,f},s.prototype.beginAnimation=function(t,i,r,n,a=1,o,l,c=!0,u,h,d=!1){if(a<0){const m=i;i=r,r=m,a=-a}i>r&&(a=-a),c&&this.stopAnimation(t,void 0,u),l||(l=new Fl(this,t,i,r,n,a,o,void 0,h,d));const f=u?u(t):!0;if(t.animations&&f&&l.appendAnimations(t,t.animations),t.getAnimatables){const m=t.getAnimatables();for(let g=0;g<m.length;g++)this.beginAnimation(m[g],i,r,n,a,o,l,c,u,h)}return l.reset(),l},s.prototype.beginHierarchyAnimation=function(t,i,r,n,a,o=1,l,c,u=!0,h,d,f=!1){const m=t.getDescendants(i),g=[];g.push(this.beginAnimation(t,r,n,a,o,l,c,u,h,void 0,f));for(const v of m)g.push(this.beginAnimation(v,r,n,a,o,l,c,u,h,void 0,f));return g},s.prototype.beginDirectAnimation=function(t,i,r,n,a,o=1,l,c,u=!1){if(o<0){const d=r;r=n,n=d,o=-o}return r>n&&(o=-o),new Fl(this,t,r,n,a,o,l,i,c,u)},s.prototype.beginDirectHierarchyAnimation=function(t,i,r,n,a,o,l,c,u,h=!1){const d=t.getDescendants(i),f=[];f.push(this.beginDirectAnimation(t,r,n,a,o,l,c,u,h));for(const m of d)f.push(this.beginDirectAnimation(m,r,n,a,o,l,c,u,h));return f},s.prototype.getAnimatableByTarget=function(t){for(let i=0;i<this._activeAnimatables.length;i++)if(this._activeAnimatables[i].target===t)return this._activeAnimatables[i];return null},s.prototype.getAllAnimatablesByTarget=function(t){const i=[];for(let r=0;r<this._activeAnimatables.length;r++)this._activeAnimatables[r].target===t&&i.push(this._activeAnimatables[r]);return i},s.prototype.stopAnimation=function(t,i,r){const n=this.getAllAnimatablesByTarget(t);for(const a of n)a.stop(i,r)},s.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(let t=0;t<this._activeAnimatables.length;t++)this._activeAnimatables[t].stop(void 0,void 0,!0);this._activeAnimatables.length=0}for(const t of this.animationGroups)t.stop()})}UM(le,Ct);class kM{getClassName(){return"TargetedAnimation"}constructor(e){this.parent=e,this.uniqueId=bn.UniqueId}serialize(){const e={};return e.animation=this.animation.serialize(),e.targetId=this.target.id,e}}class Rs{get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this.syncWithMask(!0))}syncWithMask(e=!1){if(!this.mask&&!e){this._numActiveAnimatables=this._targetedAnimations.length;return}this._numActiveAnimatables=0;for(let t=0;t<this._animatables.length;++t){const i=this._animatables[t];!this.mask||this.mask.disabled||this.mask.retainsTarget(i.target.name)?(this._numActiveAnimatables++,i.paused&&i.restart()):i.paused||i.pause()}}removeUnmaskedAnimations(){if(!(!this.mask||this.mask.disabled)){for(let e=0;e<this._animatables.length;++e){const t=this._animatables[e];this.mask.retainsTarget(t.target.name)||(t.stop(),this._animatables.splice(e,1),--e)}for(let e=0;e<this._targetedAnimations.length;e++){const t=this._targetedAnimations[e];this.mask.retainsTarget(t.target.name)||(this._targetedAnimations.splice(e,1),--e)}}}get from(){return this._from}set from(e){if(this._from!==e){this._from=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.fromFrame=this._from}}}get to(){return this._to}set to(e){if(this._to!==e){this._to=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.toFrame=this._to}}}get isStarted(){return this._isStarted}get isPlaying(){return this._isStarted&&!this._isPaused}get speedRatio(){return this._speedRatio}set speedRatio(e){if(this._speedRatio!==e){this._speedRatio=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.speedRatio=this._speedRatio}}}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){if(this._loopAnimation!==e){this._loopAnimation=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.loopAnimation=this._loopAnimation}}}get isAdditive(){return this._isAdditive}set isAdditive(e){if(this._isAdditive!==e){this._isAdditive=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.isAdditive=this._isAdditive}}}get weight(){return this._weight}set weight(e){this._weight!==e&&(this._weight=e,this.setWeightForAllAnimatables(this._weight))}get targetedAnimations(){return this._targetedAnimations}get animatables(){return this._animatables}get children(){return this._targetedAnimations}get playOrder(){return this._playOrder}set playOrder(e){if(this._playOrder!==e&&(this._playOrder=e,this._animatables.length>0)){for(let t=0;t<this._animatables.length;t++)this._animatables[t].playOrder=this._playOrder;this._scene.sortActiveAnimatables()}}get enableBlending(){return this._enableBlending}set enableBlending(e){if(this._enableBlending!==e&&(this._enableBlending=e,e!==null))for(let t=0;t<this._targetedAnimations.length;++t)this._targetedAnimations[t].animation.enableBlending=e}get blendingSpeed(){return this._blendingSpeed}set blendingSpeed(e){if(this._blendingSpeed!==e&&(this._blendingSpeed=e,e!==null))for(let t=0;t<this._targetedAnimations.length;++t)this._targetedAnimations[t].animation.blendingSpeed=e}getLength(e,t){e=e??this._from,t=t??this._to;const i=this.targetedAnimations[0].animation.framePerSecond*this._speedRatio;return(t-e)/i}static MergeAnimationGroups(e,t=!0,i=!1,r){if(e.length===0)return null;r=r??e[0].weight;let n=Number.MAX_VALUE,a=-Number.MAX_VALUE;if(i)for(const l of e)l.from<n&&(n=l.from),l.to>a&&(a=l.to);const o=new Rs(e[0].name+"_merged",e[0]._scene,r);for(const l of e){i&&l.normalize(n,a);for(const c of l.targetedAnimations)o.addTargetedAnimation(c.animation,c.target);t&&l.dispose()}return o}getScene(){return this._scene}constructor(e,t=null,i=-1,r=0){this.name=e,this._targetedAnimations=new Array,this._animatables=new Array,this._from=Number.MAX_VALUE,this._to=-Number.MAX_VALUE,this._speedRatio=1,this._loopAnimation=!1,this._isAdditive=!1,this._weight=-1,this._playOrder=0,this._enableBlending=null,this._blendingSpeed=null,this._numActiveAnimatables=0,this._shouldStart=!0,this._parentContainer=null,this.onAnimationEndObservable=new k,this.onAnimationLoopObservable=new k,this.onAnimationGroupLoopObservable=new k,this.onAnimationGroupEndObservable=new k,this.onAnimationGroupPauseObservable=new k,this.onAnimationGroupPlayObservable=new k,this.metadata=null,this._mask=null,this._animationLoopFlags=[],this._scene=t||De.LastCreatedScene,this._weight=i,this._playOrder=r,this.uniqueId=this._scene.getUniqueId(),this._scene.addAnimationGroup(this)}addTargetedAnimation(e,t){const i=new kM(this);i.animation=e,i.target=t;const r=e.getKeys();return this._from>r[0].frame&&(this._from=r[0].frame),this._to<r[r.length-1].frame&&(this._to=r[r.length-1].frame),this._enableBlending!==null&&(e.enableBlending=this._enableBlending),this._blendingSpeed!==null&&(e.blendingSpeed=this._blendingSpeed),this._targetedAnimations.push(i),this._shouldStart=!0,i}removeTargetedAnimation(e){for(let t=this._targetedAnimations.length-1;t>-1;t--)this._targetedAnimations[t].animation===e&&this._targetedAnimations.splice(t,1)}normalize(e=null,t=null){e==null&&(e=this._from),t==null&&(t=this._to);for(let i=0;i<this._targetedAnimations.length;i++){const n=this._targetedAnimations[i].animation.getKeys(),a=n[0],o=n[n.length-1];if(a.frame>e){const l={frame:e,value:a.value,inTangent:a.inTangent,outTangent:a.outTangent,interpolation:a.interpolation};n.splice(0,0,l)}if(o.frame<t){const l={frame:t,value:o.value,inTangent:o.inTangent,outTangent:o.outTangent,interpolation:o.interpolation};n.push(l)}}return this._from=e,this._to=t,this}_processLoop(e,t,i){e.onAnimationLoop=()=>{this.onAnimationLoopObservable.notifyObservers(t),!this._animationLoopFlags[i]&&(this._animationLoopFlags[i]=!0,this._animationLoopCount++,this._animationLoopCount===this._numActiveAnimatables&&(this.onAnimationGroupLoopObservable.notifyObservers(this),this._animationLoopCount=0,this._animationLoopFlags.length=0))}}start(e=!1,t=1,i,r,n){if(this._isStarted||this._targetedAnimations.length===0)return this;this._loopAnimation=e,this._shouldStart=!1,this._animationLoopCount=0,this._animationLoopFlags.length=0;for(let a=0;a<this._targetedAnimations.length;a++){const o=this._targetedAnimations[a],l=this._scene.beginDirectAnimation(o.target,[o.animation],i!==void 0?i:this._from,r!==void 0?r:this._to,e,t,void 0,void 0,n!==void 0?n:this._isAdditive);l.weight=this._weight,l.playOrder=this._playOrder,l.onAnimationEnd=()=>{this.onAnimationEndObservable.notifyObservers(o),this._checkAnimationGroupEnded(l)},this._processLoop(l,o,a),this._animatables.push(l)}return this.syncWithMask(),this._scene.sortActiveAnimatables(),this._speedRatio=t,this._isStarted=!0,this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}pause(){if(!this._isStarted)return this;this._isPaused=!0;for(let e=0;e<this._animatables.length;e++)this._animatables[e].pause();return this.onAnimationGroupPauseObservable.notifyObservers(this),this}play(e){return this.isStarted&&this._animatables.length&&!this._shouldStart?(e!==void 0&&(this.loopAnimation=e),this.restart()):(this.stop(),this.start(e,this._speedRatio)),this}reset(){if(!this._isStarted)return this.play(),this.goToFrame(0),this.stop(!0),this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].reset();return this}restart(){if(!this._isStarted)return this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].restart();return this.syncWithMask(),this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}stop(e=!1){if(!this._isStarted)return this;const t=this._animatables.slice();for(let r=0;r<t.length;r++)t[r].stop(void 0,void 0,!0,e);let i=0;for(let r=0;r<this._scene._activeAnimatables.length;r++){const n=this._scene._activeAnimatables[r];n._runtimeAnimations.length>0?this._scene._activeAnimatables[i++]=n:e&&this._checkAnimationGroupEnded(n,e)}return this._scene._activeAnimatables.length=i,this._isStarted=!1,this}setWeightForAllAnimatables(e){for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.weight=e}return this}syncAllAnimationsWith(e){for(let t=0;t<this._animatables.length;t++)this._animatables[t].syncWith(e);return this}goToFrame(e,t=!1){if(!this._isStarted)return this;for(let i=0;i<this._animatables.length;i++)this._animatables[i].goToFrame(e,t);return this}getCurrentFrame(){var e;return((e=this.animatables[0])==null?void 0:e.masterFrame)||0}dispose(){this.isStarted&&this.stop(),this._targetedAnimations.length=0,this._animatables.length=0;const e=this._scene.animationGroups.indexOf(this);if(e>-1&&this._scene.animationGroups.splice(e,1),this._parentContainer){const t=this._parentContainer.animationGroups.indexOf(this);t>-1&&this._parentContainer.animationGroups.splice(t,1),this._parentContainer=null}this.onAnimationEndObservable.clear(),this.onAnimationGroupEndObservable.clear(),this.onAnimationGroupPauseObservable.clear(),this.onAnimationGroupPlayObservable.clear(),this.onAnimationLoopObservable.clear(),this.onAnimationGroupLoopObservable.clear()}_checkAnimationGroupEnded(e,t=!1){const i=this._animatables.indexOf(e);i>-1&&this._animatables.splice(i,1),this._animatables.length===this._targetedAnimations.length-this._numActiveAnimatables&&(this._isStarted=!1,t||this.onAnimationGroupEndObservable.notifyObservers(this),this._animatables.length=0)}clone(e,t,i=!1){const r=new Rs(e||this.name,this._scene,this._weight,this._playOrder);r._from=this.from,r._to=this.to,r._speedRatio=this.speedRatio,r._loopAnimation=this.loopAnimation,r._isAdditive=this.isAdditive,r._enableBlending=this.enableBlending,r._blendingSpeed=this.blendingSpeed,r.metadata=this.metadata,r.mask=this.mask;for(const n of this._targetedAnimations)r.addTargetedAnimation(i?n.animation.clone():n.animation,t?t(n.target):n.target);return r}serialize(){const e={};e.name=this.name,e.from=this.from,e.to=this.to,e.speedRatio=this.speedRatio,e.loopAnimation=this.loopAnimation,e.isAdditive=this.isAdditive,e.weight=this.weight,e.playOrder=this.playOrder,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,e.targetedAnimations=[];for(let t=0;t<this.targetedAnimations.length;t++){const i=this.targetedAnimations[t];e.targetedAnimations[t]=i.serialize()}return ca&&ca.HasTags(this)&&(e.tags=ca.GetTags(this)),this.metadata&&(e.metadata=this.metadata),e}static Parse(e,t,i){const r=new Rs(e.name,t,e.weight,e.playOrder);for(let n=0;n<e.targetedAnimations.length;n++){const a=e.targetedAnimations[n],o=pe.Parse(a.animation),l=a.targetId;if(a.animation.property==="influence"){const c=t.getMorphTargetById(l);c&&r.addTargetedAnimation(o,c)}else{const c=i?i.get(l):t.getNodeById(l);c!=null&&r.addTargetedAnimation(o,c)}}return ca&&ca.AddTagsTo(r,e.tags),e.from!==null&&e.to!==null&&r.normalize(e.from,e.to),e.speedRatio!==void 0&&(r._speedRatio=e.speedRatio),e.loopAnimation!==void 0&&(r._loopAnimation=e.loopAnimation),e.isAdditive!==void 0&&(r._isAdditive=e.isAdditive),e.weight!==void 0&&(r._weight=e.weight),e.playOrder!==void 0&&(r._playOrder=e.playOrder),e.enableBlending!==void 0&&(r._enableBlending=e.enableBlending),e.blendingSpeed!==void 0&&(r._blendingSpeed=e.blendingSpeed),e.metadata!==void 0&&(r.metadata=e.metadata),r}static MakeAnimationAdditive(e,t,i,r=!1,n){let a;typeof t=="object"?a=t:a={referenceFrame:t,range:i,cloneOriginalAnimationGroup:r,clonedAnimationName:n};let o=e;a.cloneOriginalAnimationGroup&&(o=e.clone(a.clonedAnimationGroupName||o.name));const l=o.targetedAnimations;for(let c=0;c<l.length;c++){const u=l[c];u.animation=pe.MakeAnimationAdditive(u.animation,a)}if(o.isAdditive=!0,a.clipKeys){let c=Number.MAX_VALUE,u=-Number.MAX_VALUE;const h=o.targetedAnimations;for(let d=0;d<h.length;d++){const g=h[d].animation.getKeys();c>g[0].frame&&(c=g[0].frame),u<g[g.length-1].frame&&(u=g[g.length-1].frame)}o._from=c,o._to=u}return o}static ClipKeys(e,t,i,r,n){const a=e.clone(r||e.name);return Rs.ClipKeysInPlace(a,t,i,n)}static ClipKeysInPlace(e,t,i,r){return Rs.ClipInPlace(e,t,i,r,!1)}static ClipFrames(e,t,i,r,n){const a=e.clone(r||e.name);return Rs.ClipFramesInPlace(a,t,i,n)}static ClipFramesInPlace(e,t,i,r){return Rs.ClipInPlace(e,t,i,r,!0)}static ClipInPlace(e,t,i,r,n=!1){let a=Number.MAX_VALUE,o=-Number.MAX_VALUE;const l=e.targetedAnimations;for(let c=0;c<l.length;c++){const u=l[c],h=r?u.animation:u.animation.clone();n&&(h.createKeyForFrame(t),h.createKeyForFrame(i));const d=h.getKeys(),f=[];let m=Number.MAX_VALUE;for(let g=0;g<d.length;g++){const v=d[g];if(!n&&g>=t&&g<=i||n&&v.frame>=t&&v.frame<=i){const E={frame:v.frame,value:v.value.clone?v.value.clone():v.value,inTangent:v.inTangent,outTangent:v.outTangent,interpolation:v.interpolation,lockedTangent:v.lockedTangent};m===Number.MAX_VALUE&&(m=E.frame),E.frame-=m,f.push(E)}}if(f.length===0){l.splice(c,1),c--;continue}a>f[0].frame&&(a=f[0].frame),o<f[f.length-1].frame&&(o=f[f.length-1].frame),h.setKeys(f,!0),u.animation=h}return e._from=a,e._to=o,e}getClassName(){return"AnimationGroup"}toString(e){let t="Name: "+this.name;return t+=", type: "+this.getClassName(),e&&(t+=", from: "+this._from,t+=", to: "+this._to,t+=", isStarted: "+this._isStarted,t+=", speedRatio: "+this._speedRatio,t+=", targetedAnimations length: "+this._targetedAnimations.length,t+=", animatables length: "+this._animatables),t}}var Tg;(function(s){s[s.NONE=0]="NONE",s[s.STEP=1]="STEP"})(Tg||(Tg={}));var bg;(function(s){s[s.Include=0]="Include",s[s.Exclude=1]="Exclude"})(bg||(bg={}));class GM{constructor(e){this._mainBuses=new Set,this._nodes=new Set,this._defaultMainBus=null,this._parameterRampDuration=.01,typeof e.parameterRampDuration=="number"&&(this.parameterRampDuration=e.parameterRampDuration)}get defaultMainBus(){return this._mainBuses.size===0?null:(this._defaultMainBus||(this._defaultMainBus=Array.from(this._mainBuses)[0]),this._defaultMainBus)}get parameterRampDuration(){return this._parameterRampDuration}set parameterRampDuration(e){this._parameterRampDuration=Math.max(0,e)}dispose(){const e=this._nodes.values();for(let t=e.next();!t.done;t=e.next())t.value.dispose();this._mainBuses.clear(),this._nodes.clear(),this._defaultMainBus=null}unlockAsync(){return this.resumeAsync()}_addMainBus(e){this._mainBuses.add(e),this._addNode(e)}_removeMainBus(e){this._mainBuses.delete(e),this._defaultMainBus=null,this._removeNode(e)}_addNode(e){this._nodes.add(e)}_removeNode(e){this._nodes.delete(e)}}const zM={position:x.Zero(),rotation:x.Zero(),rotationQuaternion:new Z};function WM(s){return s.listenerEnabled||s.listenerMinUpdateTime!==void 0||s.listenerPosition!==void 0||s.listenerRotation!==void 0||s.listenerRotationQuaternion!==void 0}class HM{}class dd{constructor(e){this._attachmentType=3,this._position=new x,this._rotationQuaternion=new Z,this._sceneNode=null,this._useBoundingBox=!1,this.dispose=()=>{this.detach()},this._spatialAudioNode=e}get isAttached(){return this._sceneNode!==null}attach(e,t,i){this._sceneNode!==e&&(this.detach(),e&&(this._attachmentType=i,this._sceneNode=e,this._sceneNode.onDisposeObservable.add(this.dispose),this._useBoundingBox=t))}detach(){var e;(e=this._sceneNode)==null||e.onDisposeObservable.removeCallback(this.dispose),this._sceneNode=null}update(){var e,t;this._attachmentType&1&&(this._useBoundingBox&&this._sceneNode.getBoundingInfo?this._position.copyFrom(this._sceneNode.getBoundingInfo().boundingBox.centerWorld):(e=this._sceneNode)==null||e.getWorldMatrix().getTranslationToRef(this._position),this._spatialAudioNode.position.copyFrom(this._position),this._spatialAudioNode._updatePosition()),this._attachmentType&2&&((t=this._sceneNode)==null||t.getWorldMatrix().decompose(void 0,this._rotationQuaternion),this._spatialAudioNode.rotationQuaternion.copyFrom(this._rotationQuaternion),this._spatialAudioNode._updateRotation())}}class $M extends HM{constructor(){super(),this._attacherComponent=null,this._attacherComponent=new dd(this)}get isAttached(){return this._attacherComponent!==null&&this._attacherComponent.isAttached}attach(e,t=!1,i=3){this._attacherComponent||(this._attacherComponent=new dd(this)),this._attacherComponent.attach(e,t,i)}detach(){var e;(e=this._attacherComponent)==null||e.detach()}dispose(){var e;(e=this._attacherComponent)==null||e.dispose(),this._attacherComponent=null}setOptions(e){e.listenerMinUpdateTime!==void 0&&(this.minUpdateTime=e.listenerMinUpdateTime),e.listenerPosition&&(this.position=e.listenerPosition.clone()),e.listenerRotationQuaternion?this.rotationQuaternion=e.listenerRotationQuaternion.clone():e.listenerRotation?this.rotation=e.listenerRotation.clone():this.rotationQuaternion=zM.rotationQuaternion.clone(),this.update()}}class MI{constructor(e,t,i){if(this._autoUpdate=!0,this._lastUpdateTime=0,this.minUpdateTime=0,!t)return;this.minUpdateTime=i;const r=()=>{if(!this._autoUpdate)return;let n=!1;if(0<this.minUpdateTime){const a=Qr.Now;this._lastUpdateTime&&a-this._lastUpdateTime<this.minUpdateTime&&(n=!0),this._lastUpdateTime=a}n||e.update(),requestAnimationFrame(r)};requestAnimationFrame(r)}dispose(){this._autoUpdate=!1}}const XM=new RegExp("\\.(\\w{3,4})($|\\?)"),an=100,Wh=new Float32Array([0,0]);let ll=null,Ec=null,Tc=null;function YM(){if(!Ec){Ec=new Float32Array(an);const s=1/(an-1);let e=s;for(let t=1;t<an;t++)Ec[t]=Math.exp(-11.512925464970227*(1-e)),e+=s}return Ec}function jM(){if(!Tc){Tc=new Float32Array(an);const s=1/an;let e=s;for(let t=0;t<an;t++)Tc[t]=1+Math.log10(e)/Math.log10(an),e+=s}return Tc}function qM(s,e,t){ll||(ll=new Float32Array(an));let i;if(s==="linear")return Wh[0]=e,Wh[1]=t,Wh;if(s==="exponential")i=YM();else if(s==="logarithmic")i=jM();else throw new Error(`Unknown ramp shape: ${s}`);const r=Math.sign(t-e),n=Math.abs(t-e);if(r===1)for(let a=0;a<i.length;a++)ll[a]=e+n*i[a];else{let a=an-1;for(let o=0;o<i.length;o++,a--)ll[o]=e-n*(1-i[a])}return ll}function fd(s){return s.replace(/#/gm,"%23")}const ZM=.011,QM=1e-6;class Ti{constructor(e,t){this._deferredRampOptions={duration:0,shape:"linear"},this._deferredTargetValue=-1,this._isObservingUpdates=!1,this._rampEndTime=0,this._applyDeferredRamp=()=>{0<this._deferredRampOptions.duration&&this._rampEndTime<this._engine.currentTime&&this.setTargetValue(this._deferredTargetValue,this._deferredRampOptions)},this._engine=e,this._param=t,this._targetValue=t.value}get isRamping(){return this._engine.currentTime<this._rampEndTime}get targetValue(){return this._targetValue}set targetValue(e){this.setTargetValue(e)}get value(){return this._param.value}dispose(){this._clearDeferredRamp(),this._param=null,this._engine=null}setTargetValue(e,t=null){if(this._targetValue===e)return;const i=typeof(t==null?void 0:t.shape)=="string"?t.shape:"linear";let r=typeof(t==null?void 0:t.duration)=="number"?Math.max(t.duration,this._engine.parameterRampDuration):this._engine.parameterRampDuration;const n=this._engine.currentTime;if(n<this._rampEndTime){const a=this._rampEndTime-n;if(ZM<a)throw new Error("Audio parameter not set. Wait for current ramp to finish.");this._deferRamp(e,r,i);return}if((r=Math.max(this._engine.parameterRampDuration,r))<QM){this._param.setValueAtTime(this._targetValue=e,n);return}this._param.cancelScheduledValues(n),this._param.setValueCurveAtTime(qM(i,this._targetValue,this._targetValue=e),n,r),this._clearDeferredRamp(),this._rampEndTime=n+r}_deferRamp(e,t,i){this._deferredRampOptions.duration=t,this._deferredRampOptions.shape=i,this._deferredTargetValue=e,this._isObservingUpdates||(this._engine._addUpdateObserver(this._applyDeferredRamp),this._isObservingUpdates=!0)}_clearDeferredRamp(){this._deferredRampOptions.duration=0,this._isObservingUpdates&&(this._engine._removeUpdateObserver(this._applyDeferredRamp),this._isObservingUpdates=!1)}}const Hh=z.Zero(),$h=new Z,Cg=x.Zero(),yg=x.Zero();function Ig(s,e,t){const i=s._audioContext.listener;return i.forwardX&&i.forwardY&&i.forwardZ&&i.positionX&&i.positionY&&i.positionZ&&i.upX&&i.upY&&i.upZ?new KM(s,e,t):new JM(s,e,t)}class FI extends $M{constructor(e,t,i){super(),this._lastPosition=x.Zero(),this._lastRotation=x.Zero(),this._lastRotationQuaternion=new Z,this.position=x.Zero(),this.rotation=x.Zero(),this.rotationQuaternion=new Z,this._listener=e._audioContext.listener,this.engine=e,this._updaterComponent=new MI(this,t,i)}dispose(){super.dispose(),this._updaterComponent.dispose(),this._updaterComponent=null}get minUpdateTime(){return this._updaterComponent.minUpdateTime}set minUpdateTime(e){this._updaterComponent.minUpdateTime=e}update(){var e;this.isAttached?(e=this._attacherComponent)==null||e.update():(this._updatePosition(),this._updateRotation())}_updatePosition(){this._lastPosition.equalsWithEpsilon(this.position)||(this._setWebAudioPosition(this.position),this._lastPosition.copyFrom(this.position))}_updateRotation(){if(!this._lastRotationQuaternion.equalsWithEpsilon(this.rotationQuaternion))$h.copyFrom(this.rotationQuaternion),this._lastRotationQuaternion.copyFrom(this.rotationQuaternion);else if(!this._lastRotation.equalsWithEpsilon(this.rotation))Z.FromEulerAnglesToRef(this.rotation.x,this.rotation.y,this.rotation.z,$h),this._lastRotation.copyFrom(this.rotation);else return;z.FromQuaternionToRef($h,Hh),x.TransformNormalToRef(x.RightHandedForwardReadOnly,Hh,Cg),x.TransformNormalToRef(x.Up(),Hh,yg),this._setWebAudioOrientation(Cg,yg)}}class KM extends FI{constructor(e,t,i){super(e,t,i);const r=e._audioContext.listener;this._forwardX=new Ti(e,r.forwardX),this._forwardY=new Ti(e,r.forwardY),this._forwardZ=new Ti(e,r.forwardZ),this._positionX=new Ti(e,r.positionX),this._positionY=new Ti(e,r.positionY),this._positionZ=new Ti(e,r.positionZ),this._upX=new Ti(e,r.upX),this._upY=new Ti(e,r.upY),this._upZ=new Ti(e,r.upZ)}_setWebAudioPosition(e){this.isAttached&&(this._positionX.isRamping||this._positionY.isRamping||this._positionZ.isRamping)||(this._positionX.targetValue=e.x,this._positionY.targetValue=e.y,this._positionZ.targetValue=e.z)}_setWebAudioOrientation(e,t){this.isAttached&&(this._forwardX.isRamping||this._forwardY.isRamping||this._forwardZ.isRamping||this._upX.isRamping||this._upY.isRamping||this._upZ.isRamping)||(this._forwardX.targetValue=e.x,this._forwardY.targetValue=e.y,this._forwardZ.targetValue=e.z,this._upX.targetValue=t.x,this._upY.targetValue=t.y,this._upZ.targetValue=t.z)}}class JM extends FI{_setWebAudioPosition(e){this._listener.setPosition(e.x,e.y,e.z)}_setWebAudioOrientation(e,t){this._listener.setOrientation(e.x,e.y,e.z,t.x,t.y,t.z)}}var Rg;(function(s){s[s.HAS_INPUTS=1]="HAS_INPUTS",s[s.HAS_OUTPUTS=2]="HAS_OUTPUTS",s[s.HAS_INPUTS_AND_OUTPUTS=3]="HAS_INPUTS_AND_OUTPUTS"})(Rg||(Rg={}));class e_{constructor(e,t){this.onDisposeObservable=new k,this.engine=e,t&1&&(this._upstreamNodes=new Set),t&2&&(this._downstreamNodes=new Set)}dispose(){if(this._downstreamNodes){for(const e of Array.from(this._downstreamNodes))if(!this._disconnect(e))throw new Error("Disconnect failed");this._downstreamNodes.clear()}if(this._upstreamNodes){for(const e of Array.from(this._upstreamNodes))if(!e._disconnect(this))throw new Error("Disconnect failed");this._upstreamNodes.clear()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}_connect(e){return!this._downstreamNodes||this._downstreamNodes.has(e)||!e._onConnect(this)?!1:(this._downstreamNodes.add(e),!0)}_disconnect(e){return!this._downstreamNodes||!this._downstreamNodes.delete(e)?!1:e._onDisconnect(this)}_onConnect(e){return!this._upstreamNodes||this._upstreamNodes.has(e)?!1:(this._upstreamNodes.add(e),!0)}_onDisconnect(e){var t;return((t=this._upstreamNodes)==null?void 0:t.delete(e))??!1}}class LI extends e_{constructor(e,t,i){super(t,i),this.onNameChangedObservable=new k,this._name=e}get name(){return this._name}set name(e){if(this._name===e)return;const t=this._name;this._name=e,this.onNameChangedObservable.notifyObservers({newName:e,oldName:t,node:this})}dispose(){super.dispose(),this.onNameChangedObservable.clear()}}class eF extends e_{constructor(e){super(e,1)}}class tF extends eF{constructor(e){super(e),this._setGainNode(new GainNode(e._audioContext))}dispose(){super.dispose(),this._volume.dispose(),this._gainNode.disconnect(),this._destinationNode.disconnect()}get _inNode(){return this._gainNode}set _inNode(e){this._gainNode!==e&&this._setGainNode(e)}get volume(){return this._volume.targetValue}set volume(e){this._volume.targetValue=e}get _destinationNode(){return this.engine._audioDestination}getClassName(){return"_WebAudioMainOut"}setVolume(e,t=null){this._volume.setTargetValue(e,t)}_setGainNode(e){var t;this._gainNode!==e&&((t=this._gainNode)==null||t.disconnect(),e.connect(this._destinationNode),this._volume=new Ti(this.engine,e.gain),this._gainNode=e)}}class iF{constructor(e,t){var n,a;this._button=null,this._enabled=!0,this._style=null,this._onStateChanged=()=>{this._button&&(this._engine.state==="running"?this._hide():this._show())},this._engine=e;const i=t||((a=(n=De.LastCreatedEngine)==null?void 0:n.getInputElement())==null?void 0:a.parentElement)||document.body,r=((i==null?void 0:i.offsetTop)||0)+20;this._style=document.createElement("style"),this._style.appendChild(document.createTextNode(`.babylonUnmute{position:absolute;top:${r}px;margin-left:20px;height:40px;width:60px;background-color:rgba(51,51,51,0.7);background-image:url("data:image/svg+xml;charset=UTF-8,%3Csvg%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2239%22%20height%3D%2232%22%20viewBox%3D%220%200%2039%2032%22%3E%3Cpath%20fill%3D%22white%22%20d%3D%22M9.625%2018.938l-0.031%200.016h-4.953q-0.016%200-0.031-0.016v-12.453q0-0.016%200.031-0.016h4.953q0.031%200%200.031%200.016v12.453zM12.125%207.688l8.719-8.703v27.453l-8.719-8.719-0.016-0.047v-9.938zM23.359%207.875l1.406-1.406%204.219%204.203%204.203-4.203%201.422%201.406-4.219%204.219%204.219%204.203-1.484%201.359-4.141-4.156-4.219%204.219-1.406-1.422%204.219-4.203z%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E");background-size:80%;background-repeat:no-repeat;background-position:center;background-position-y:4px;border:none;outline:none;transition:transform 0.125s ease-out;cursor:pointer;z-index:9999;}.babylonUnmute:hover{transform:scale(1.05)}`)),document.head.appendChild(this._style),this._button=document.createElement("button"),this._button.className="babylonUnmute",this._button.id="babylonUnmuteButton",this._button.addEventListener("click",()=>{this._engine.unlockAsync()}),i.appendChild(this._button),this._engine.stateChangedObservable.add(this._onStateChanged)}dispose(){var e,t;(e=this._button)==null||e.remove(),this._button=null,(t=this._style)==null||t.remove(),this._style=null,this._engine.stateChangedObservable.removeCallback(this._onStateChanged)}get enabled(){return this._enabled}set enabled(e){this._enabled=e,e?this._engine.state!=="running"&&this._show():this._hide()}_show(){this._button&&(this._button.style.display="block")}_hide(){this._button&&(this._button.style.display="none")}}const rF={aac:"audio/aac",ac3:"audio/ac3",flac:"audio/flac",m4a:"audio/mp4",mp3:'audio/mpeg; codecs="mp3"',mp4:"audio/mp4",ogg:'audio/ogg; codecs="vorbis"',wav:"audio/wav",webm:'audio/webm; codecs="vorbis"'};class sF extends GM{constructor(e={}){super(e),this._audioContextStarted=!1,this._destinationNode=null,this._invalidFormats=new Set,this._isUpdating=!1,this._listener=null,this._listenerAutoUpdate=!0,this._listenerMinUpdateTime=0,this._pauseCalled=!1,this._resumeOnInteraction=!0,this._resumeOnPause=!0,this._resumeOnPauseRetryInterval=1e3,this._resumeOnPauseTimerId=null,this._resumePromise=null,this._silentHtmlAudio=null,this._unmuteUI=null,this._updateObservable=null,this._validFormats=new Set,this._volume=1,this._isUsingOfflineAudioContext=!1,this.isReadyPromise=new Promise(t=>{this._resolveIsReadyPromise=t}),this.stateChangedObservable=new k,this.userGestureObservable=new k,this._initAudioContextAsync=async()=>{this._audioContext.addEventListener("statechange",this._onAudioContextStateChange),this._mainOut=new tF(this),this._mainOut.volume=this._volume,await this.createMainBusAsync("default")},this._onAudioContextStateChange=()=>{this.state==="running"&&(clearInterval(this._resumeOnPauseTimerId),this._audioContextStarted=!0,this._resumePromise=null),(this.state==="suspended"||this.state==="interrupted")&&this._audioContextStarted&&this._resumeOnPause&&!this._pauseCalled&&(clearInterval(this._resumeOnPauseTimerId),this._resumeOnPauseTimerId=setInterval(()=>{this.resumeAsync()},this._resumeOnPauseRetryInterval)),this.stateChangedObservable.notifyObservers(this.state)},this._onUserGestureAsync=async()=>{if(this._resumeOnInteraction&&await this._audioContext.resume(),!this._silentHtmlAudio){this._silentHtmlAudio=document.createElement("audio");const t=this._silentHtmlAudio;t.controls=!1,t.preload="auto",t.loop=!0,t.src="data:audio/wav;base64,UklGRjAAAABXQVZFZm10IBAAAAABAAEAgLsAAAB3AQACABAAZGF0YQwAAAAAAAEA/v8CAP//AQA=",t.play()}this.userGestureObservable.notifyObservers()},this._startUpdating=()=>{if(!this._isUpdating)if(this._isUpdating=!0,this.state==="running")this._update();else{const t=()=>{this.state==="running"&&(this._update(),this.stateChangedObservable.removeCallback(t))};this.stateChangedObservable.add(t)}},this._update=()=>{var t;(t=this._updateObservable)!=null&&t.hasObservers()?(this._updateObservable.notifyObservers(),requestAnimationFrame(this._update)):this._isUpdating=!1},typeof e.listenerAutoUpdate=="boolean"&&(this._listenerAutoUpdate=e.listenerAutoUpdate),typeof e.listenerMinUpdateTime=="number"&&(this._listenerMinUpdateTime=e.listenerMinUpdateTime),this._volume=e.volume??1,e.audioContext?(this._isUsingOfflineAudioContext=e.audioContext instanceof OfflineAudioContext,this._audioContext=e.audioContext):this._audioContext=new AudioContext,e.disableDefaultUI||(this._unmuteUI=new iF(this,e.defaultUIParentElement))}async _initAsync(e){this._resumeOnInteraction=typeof e.resumeOnInteraction=="boolean"?e.resumeOnInteraction:!0,this._resumeOnPause=typeof e.resumeOnPause=="boolean"?e.resumeOnPause:!0,this._resumeOnPauseRetryInterval=e.resumeOnPauseRetryInterval??1e3,document.addEventListener("click",this._onUserGestureAsync),await this._initAudioContextAsync(),WM(e)&&(this._listener=Ig(this,this._listenerAutoUpdate,this._listenerMinUpdateTime),this._listener.setOptions(e)),this._resolveIsReadyPromise()}get currentTime(){return this._audioContext.currentTime??0}get _inNode(){return this._audioContext.destination}get mainOut(){return this._mainOut}get listener(){return this._listener??(this._listener=Ig(this,this._listenerAutoUpdate,this._listenerMinUpdateTime))}get state(){return this._isUsingOfflineAudioContext?"running":this._audioContext.state}get volume(){return this._volume}set volume(e){this._volume!==e&&(this._volume=e,this._mainOut&&(this._mainOut.volume=e))}get _audioDestination(){return this._destinationNode?this._destinationNode:this._destinationNode=this._audioContext.destination}set _audioDestination(e){this._destinationNode=e}get _unmuteUIEnabled(){return this._unmuteUI?this._unmuteUI.enabled:!1}set _unmuteUIEnabled(e){this._unmuteUI&&(this._unmuteUI.enabled=e)}async createBusAsync(e,t={}){const i=await U(()=>Promise.resolve().then(()=>BF),void 0),r=new i._WebAudioBus(e,this,t);return await r._initAsync(t),r}async createMainBusAsync(e,t={}){const i=await U(()=>Promise.resolve().then(()=>VF),void 0),r=new i._WebAudioMainBus(e,this);return await r._initAsync(t),r}async createMicrophoneSoundSourceAsync(e,t){let i;try{i=await navigator.mediaDevices.getUserMedia({audio:!0})}catch(r){throw new Error("Unable to access microphone: "+r)}return await this.createSoundSourceAsync(e,new MediaStreamAudioSourceNode(this._audioContext,{mediaStream:i}),{outBusAutoDefault:!1,...t})}async createSoundAsync(e,t,i={}){const r=await U(()=>Promise.resolve().then(()=>Lg),void 0),n=new r._WebAudioStaticSound(e,this,i);return await n._initAsync(t,i),n}async createSoundBufferAsync(e,t={}){const i=await U(()=>Promise.resolve().then(()=>Lg),void 0),r=new i._WebAudioStaticSoundBuffer(this);return await r._initAsync(e,t),r}async createSoundSourceAsync(e,t,i={}){const r=await U(()=>Promise.resolve().then(()=>UF),void 0),n=new r._WebAudioSoundSource(e,t,this,i);return await n._initAsync(i),n}async createStreamingSoundAsync(e,t,i={}){const r=await U(()=>Promise.resolve().then(()=>HF),void 0),n=new r._WebAudioStreamingSound(e,this,i);return await n._initAsync(t,i),n}dispose(){var e,t,i,r;super.dispose(),(e=this._listener)==null||e.dispose(),this._listener=null,this._audioContext.state!=="closed"&&!this._isUsingOfflineAudioContext&&this._audioContext.close(),document.removeEventListener("click",this._onUserGestureAsync),this._audioContext.removeEventListener("statechange",this._onAudioContextStateChange),(t=this._silentHtmlAudio)==null||t.remove(),(i=this._updateObservable)==null||i.clear(),this._updateObservable=null,(r=this._unmuteUI)==null||r.dispose(),this._unmuteUI=null,this.stateChangedObservable.clear()}flagInvalidFormat(e){this._invalidFormats.add(e)}isFormatValid(e){if(this._validFormats.has(e))return!0;if(this._invalidFormats.has(e))return!1;const t=rF[e];return t===void 0?!1:new Audio().canPlayType(t)===""?(this._invalidFormats.add(e),!1):(this._validFormats.add(e),!0)}async pauseAsync(){await this._audioContext.suspend(),this._pauseCalled=!0}resumeAsync(){return this._pauseCalled=!1,this._resumePromise?this._resumePromise:(this._resumePromise=this._audioContext.resume(),this._resumePromise)}setVolume(e,t=null){if(this._mainOut)this._mainOut.setVolume(e,t);else throw new Error("Main output not initialized yet.")}_addMainBus(e){super._addMainBus(e)}_removeMainBus(e){super._removeMainBus(e)}_addNode(e){super._addNode(e)}_removeNode(e){super._removeNode(e)}_addUpdateObserver(e){this._updateObservable||(this._updateObservable=new k),this._updateObservable.add(e),this._startUpdating()}_removeUpdateObserver(e){this._updateObservable&&this._updateObservable.removeCallback(e)}}te.AudioEngineFactory=(s,e,t)=>new nF(s,e,t);class nF{get masterGain(){return this._masterGain}set masterGain(e){this._masterGain=this._v2.mainOut._inNode=e}get useCustomUnlockedButton(){return this._useCustomUnlockedButton}set useCustomUnlockedButton(e){this._useCustomUnlockedButton=e,this._v2._unmuteUIEnabled=!e}get audioContext(){return this._v2.state==="running"&&this._triggerRunningStateAsync(),this._v2._audioContext}constructor(e=null,t=null,i=null){this._audioContext=null,this._tryToRun=!1,this._useCustomUnlockedButton=!1,this.canUseWebAudio=!0,this.WarnedWebAudioUnsupported=!1,this.isMP3supported=!1,this.isOGGsupported=!1,this.unlocked=!1,this.onAudioUnlockedObservable=new k,this.onAudioLockedObservable=new k;const r=new sF({audioContext:t||void 0,defaultUIParentElement:e!=null&&e.parentElement?e.parentElement:void 0});r._unmuteUIEnabled=!1,this._masterGain=new GainNode(r._audioContext),r._audioDestination=i,r.stateChangedObservable.add(n=>{n==="running"?(this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this)):(this.unlocked=!1,this.onAudioLockedObservable.notifyObservers(this))}),r._initAsync({resumeOnInteraction:!1}).then(()=>{const n=r.defaultMainBus._outNode;n&&(n.disconnect(r.mainOut._inNode),n.connect(this._masterGain)),r.mainOut._inNode=this._masterGain,r.stateChangedObservable.notifyObservers(r.state)}),this.isMP3supported=r.isFormatValid("mp3"),this.isOGGsupported=r.isFormatValid("ogg"),this._v2=r}lock(){this._v2._audioContext.suspend(),this._useCustomUnlockedButton||(this._v2._unmuteUIEnabled=!0)}unlock(){var e;if(((e=this._audioContext)==null?void 0:e.state)==="running"){this.unlocked||(this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this));return}this._triggerRunningStateAsync()}_resumeAudioContextOnStateChange(){var e;(e=this._audioContext)==null||e.addEventListener("statechange",()=>{var t;this.unlocked&&((t=this._audioContext)==null?void 0:t.state)!=="running"&&this._resumeAudioContextAsync()},{once:!0,passive:!0,signal:AbortSignal.timeout(3e3)})}_resumeAudioContextAsync(){return this._v2._isUsingOfflineAudioContext?Promise.resolve():this._v2._audioContext.resume()}dispose(){this._v2.dispose(),this.onAudioUnlockedObservable.clear(),this.onAudioLockedObservable.clear()}getGlobalVolume(){return this.masterGain.gain.value}setGlobalVolume(e){this.masterGain.gain.value=e}connectToAnalyser(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=e,this.masterGain.disconnect(),this._connectedAnalyser.connectAudioNodes(this.masterGain,this._v2._audioContext.destination)}async _triggerRunningStateAsync(){this._tryToRun||(this._tryToRun=!0,await this._resumeAudioContextAsync(),this._tryToRun=!1,this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this))}}class ds{get loop(){return this._loop}set loop(e){e!==this._loop&&(this._loop=e,this.updateOptions({loop:e}))}get currentTime(){var e;if(this._htmlAudioElement)return this._htmlAudioElement.currentTime;if((e=te.audioEngine)!=null&&e.audioContext&&(this.isPlaying||this.isPaused)){const t=this.isPaused?0:te.audioEngine.audioContext.currentTime-this._startTime;return this._currentTime+t}return 0}get spatialSound(){return this._spatialSound}set spatialSound(e){if(e==this._spatialSound)return;const t=this.isPlaying;this.pause(),e?(this._spatialSound=e,this._updateSpatialParameters()):this._disableSpatialSound(),t&&this.play()}constructor(e,t,i,r=null,n){var a;if(this.autoplay=!1,this._loop=!1,this.useCustomAttenuation=!1,this.isPlaying=!1,this.isPaused=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this.metadata=null,this.onEndedObservable=new k,this._spatialSound=!1,this._panningModel="equalpower",this._playbackRate=1,this._streaming=!1,this._startTime=0,this._currentTime=0,this._position=x.Zero(),this._localDirection=new x(1,0,0),this._volume=1,this._isReadyToPlay=!1,this._isDirectional=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=!1,this._urlType="Unknown",this.name=e,i=i||De.LastCreatedScene,!!i)if(this._scene=i,ds._SceneComponentInitialization(i),this._readyToPlayCallback=r,this._customAttenuationFunction=(o,l,c,u,h)=>l<c?o*(1-l/c):0,n&&(this.autoplay=n.autoplay||!1,this._loop=n.loop||!1,n.volume!==void 0&&(this._volume=n.volume),this._spatialSound=n.spatialSound??!1,this.maxDistance=n.maxDistance??100,this.useCustomAttenuation=n.useCustomAttenuation??!1,this.rolloffFactor=n.rolloffFactor||1,this.refDistance=n.refDistance||1,this.distanceModel=n.distanceModel||"linear",this._playbackRate=n.playbackRate||1,this._streaming=n.streaming??!1,this._length=n.length,this._offset=n.offset),(a=te.audioEngine)!=null&&a.canUseWebAudio&&te.audioEngine.audioContext){this._soundGain=te.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._outputAudioNode=this._soundGain,this._spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.addSound(this);let o=!0;if(t)try{typeof t=="string"?(this._urlType="String",this._url=t):t instanceof ArrayBuffer?this._urlType="ArrayBuffer":t instanceof HTMLMediaElement?this._urlType="MediaElement":t instanceof MediaStream?this._urlType="MediaStream":t instanceof AudioBuffer?this._urlType="AudioBuffer":Array.isArray(t)&&(this._urlType="Array");let l=[],c=!1;switch(this._urlType){case"MediaElement":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=te.audioEngine.audioContext.createMediaElementSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"MediaStream":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=te.audioEngine.audioContext.createMediaStreamSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"ArrayBuffer":t.byteLength>0&&(c=!0,this._soundLoaded(t));break;case"AudioBuffer":this._audioBufferLoaded(t);break;case"String":l.push(t);case"Array":l.length===0&&(l=t);for(let u=0;u<l.length;u++){const h=l[u];if(c=n&&n.skipCodecCheck||h.indexOf(".mp3",h.length-4)!==-1&&te.audioEngine.isMP3supported||h.indexOf(".ogg",h.length-4)!==-1&&te.audioEngine.isOGGsupported||h.indexOf(".wav",h.length-4)!==-1||h.indexOf(".m4a",h.length-4)!==-1||h.indexOf(".mp4",h.length-4)!==-1||h.indexOf("blob:")!==-1,c){this._streaming?(this._htmlAudioElement=new Audio(h),this._htmlAudioElement.controls=!1,this._htmlAudioElement.loop=this.loop,j.SetCorsBehavior(h,this._htmlAudioElement),this._htmlAudioElement.preload="auto",this._htmlAudioElement.addEventListener("canplaythrough",()=>{this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback()},{once:!0}),document.body.appendChild(this._htmlAudioElement),this._htmlAudioElement.load()):this._scene._loadFile(h,d=>{this._soundLoaded(d)},void 0,!0,!0,d=>{d&&N.Error("XHR "+d.status+" error on: "+h+"."),N.Error("Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)});break}}break;default:o=!1;break}o?c||(this._isReadyToPlay=!0,this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)):N.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}catch{N.Error("Unexpected error. Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)}}else this._scene.mainSoundTrack.addSound(this),te.audioEngine&&!te.audioEngine.WarnedWebAudioUnsupported&&(N.Error("Web Audio is not supported by your browser."),te.audioEngine.WarnedWebAudioUnsupported=!0),this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)}dispose(){var e;(e=te.audioEngine)!=null&&e.canUseWebAudio&&(this.isPlaying&&this.stop(),this._isReadyToPlay=!1,this.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src="",document.body.removeChild(this._htmlAudioElement),this._htmlAudioElement=null),this._streamingSource&&(this._streamingSource.disconnect(),this._streamingSource=null),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null),this._clearTimeoutsAndObservers())}isReady(){return this._isReadyToPlay}getClassName(){return"Sound"}_audioBufferLoaded(e){var t;(t=te.audioEngine)!=null&&t.audioContext&&(this._audioBuffer=e,this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback())}_soundLoaded(e){var t;(t=te.audioEngine)!=null&&t.audioContext&&te.audioEngine.audioContext.decodeAudioData(e,i=>{this._audioBufferLoaded(i)},i=>{N.Error("Error while decoding audio data for: "+this.name+" / Error: "+i)})}setAudioBuffer(e){var t;(t=te.audioEngine)!=null&&t.canUseWebAudio&&(this._audioBuffer=e,this._isReadyToPlay=!0)}updateOptions(e){e&&(this.loop=e.loop??this.loop,this.maxDistance=e.maxDistance??this.maxDistance,this.useCustomAttenuation=e.useCustomAttenuation??this.useCustomAttenuation,this.rolloffFactor=e.rolloffFactor??this.rolloffFactor,this.refDistance=e.refDistance??this.refDistance,this.distanceModel=e.distanceModel??this.distanceModel,this._playbackRate=e.playbackRate??this._playbackRate,this._length=e.length??void 0,this.spatialSound=e.spatialSound??this._spatialSound,this._setOffset(e.offset??void 0),this.setVolume(e.volume??this._volume),this._updateSpatialParameters(),this.isPlaying&&(this._streaming&&this._htmlAudioElement?(this._htmlAudioElement.playbackRate=this._playbackRate,this._htmlAudioElement.loop!==this.loop&&(this._htmlAudioElement.loop=this.loop)):this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.loop!==this.loop&&(this._soundSource.loop=this.loop),this._offset!==void 0&&this._soundSource.loopStart!==this._offset&&(this._soundSource.loopStart=this._offset),this._length!==void 0&&this._length!==this._soundSource.loopEnd&&(this._soundSource.loopEnd=(this._offset|0)+this._length))))}_createSpatialParameters(){var e;(e=te.audioEngine)!=null&&e.canUseWebAudio&&te.audioEngine.audioContext&&(this._scene.headphone&&(this._panningModel="HRTF"),this._soundPanner=this._soundPanner??te.audioEngine.audioContext.createPanner(),this._soundPanner&&this._outputAudioNode&&(this._updateSpatialParameters(),this._soundPanner.connect(this._outputAudioNode),this._inputAudioNode=this._soundPanner))}_disableSpatialSound(){var e;this._spatialSound&&(this._inputAudioNode=this._soundGain,(e=this._soundPanner)==null||e.disconnect(),this._soundPanner=null,this._spatialSound=!1)}_updateSpatialParameters(){this._spatialSound&&(this._soundPanner?this.useCustomAttenuation?(this._soundPanner.distanceModel="linear",this._soundPanner.maxDistance=Number.MAX_VALUE,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1,this._soundPanner.panningModel=this._panningModel):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor,this._soundPanner.panningModel=this._panningModel):this._createSpatialParameters())}switchPanningModelToHRTF(){this._panningModel="HRTF",this._switchPanningModel()}switchPanningModelToEqualPower(){this._panningModel="equalpower",this._switchPanningModel()}_switchPanningModel(){var e;(e=te.audioEngine)!=null&&e.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.panningModel=this._panningModel)}connectToSoundTrackAudioNode(e){var t;(t=te.audioEngine)!=null&&t.canUseWebAudio&&this._outputAudioNode&&(this._isOutputConnected&&this._outputAudioNode.disconnect(),this._outputAudioNode.connect(e),this._isOutputConnected=!0)}setDirectionalCone(e,t,i){if(t<e){N.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e,this._coneOuterAngle=t,this._coneOuterGain=i,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){var t;if(e!=this._coneInnerAngle){if(this._coneOuterAngle<e){N.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e,(t=te.audioEngine)!=null&&t.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle)}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){var t;if(e!=this._coneOuterAngle){if(e<this._coneInnerAngle){N.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=e,(t=te.audioEngine)!=null&&t.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneOuterAngle=this._coneOuterAngle)}}setPosition(e){var t;e.equals(this._position)||(this._position.copyFrom(e),(t=te.audioEngine)!=null&&t.canUseWebAudio&&this._spatialSound&&this._soundPanner&&!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z))}setLocalDirectionToMesh(e){var t;this._localDirection=e,(t=te.audioEngine)!=null&&t.canUseWebAudio&&this._connectedTransformNode&&this.isPlaying&&this._updateDirection()}_updateDirection(){if(!this._connectedTransformNode||!this._soundPanner)return;const e=this._connectedTransformNode.getWorldMatrix(),t=x.TransformNormal(this._localDirection,e);t.normalize(),this._soundPanner.orientationX.value=t.x,this._soundPanner.orientationY.value=t.y,this._soundPanner.orientationZ.value=t.z}updateDistanceFromListener(){var e;if((e=te.audioEngine)!=null&&e.canUseWebAudio&&this._connectedTransformNode&&this.useCustomAttenuation&&this._soundGain&&this._scene.activeCamera){const t=this._scene.audioListenerPositionProvider?this._connectedTransformNode.position.subtract(this._scene.audioListenerPositionProvider()).length():this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,t,this.maxDistance,this.refDistance,this.rolloffFactor)}}setAttenuationFunction(e){this._customAttenuationFunction=e}play(e,t,i){var r,n,a,o;if(this._isReadyToPlay&&this._scene.audioEnabled&&((r=te.audioEngine)!=null&&r.audioContext))try{this._clearTimeoutsAndObservers();let l=e?((n=te.audioEngine)==null?void 0:n.audioContext.currentTime)+e:(a=te.audioEngine)==null?void 0:a.audioContext.currentTime;if((!this._soundSource||!this._streamingSource)&&this._spatialSound&&this._soundPanner&&(!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedTransformNode?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z))),this._streaming){if(!this._streamingSource&&this._htmlAudioElement&&(this._streamingSource=te.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=()=>{this._onended()},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource&&(this._streamingSource.disconnect(),this._inputAudioNode&&this._streamingSource.connect(this._inputAudioNode)),this._htmlAudioElement){const c=()=>{var u,h;if((u=te.audioEngine)!=null&&u.unlocked){if(!this._htmlAudioElement)return;this._htmlAudioElement.currentTime=t??0;const d=this._htmlAudioElement.play();d!==void 0&&d.catch(()=>{var f,m;(f=te.audioEngine)==null||f.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=(m=te.audioEngine)==null?void 0:m.onAudioUnlockedObservable.addOnce(()=>{c()}))})}else(this.loop||this.autoplay)&&(this._audioUnlockedObserver=(h=te.audioEngine)==null?void 0:h.onAudioUnlockedObservable.addOnce(()=>{c()}))};c()}}else{const c=()=>{var u,h,d;if((u=te.audioEngine)!=null&&u.audioContext){if(i=i||this._length,t!==void 0&&this._setOffset(t),this._soundSource){const f=this._soundSource;f.onended=()=>{f.disconnect()}}if(this._soundSource=(h=te.audioEngine)==null?void 0:h.audioContext.createBufferSource(),this._soundSource&&this._inputAudioNode){this._soundSource.buffer=this._audioBuffer,this._soundSource.connect(this._inputAudioNode),this._soundSource.loop=this.loop,t!==void 0&&(this._soundSource.loopStart=t),i!==void 0&&(this._soundSource.loopEnd=(t|0)+i),this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.onended=()=>{this._onended()},l=e?((d=te.audioEngine)==null?void 0:d.audioContext.currentTime)+e:te.audioEngine.audioContext.currentTime;const f=((this.isPaused?this.currentTime:0)+(this._offset??0))%this._soundSource.buffer.duration;this._soundSource.start(l,f,this.loop?void 0:i)}}};((o=te.audioEngine)==null?void 0:o.audioContext.state)==="suspended"?this._tryToPlayTimeout=setTimeout(()=>{var u;((u=te.audioEngine)==null?void 0:u.audioContext.state)==="suspended"?(te.audioEngine.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=te.audioEngine.onAudioUnlockedObservable.addOnce(()=>{c()}))):c()},500):c()}this._startTime=l,this.isPlaying=!0,this.isPaused=!1}catch(l){N.Error("Error while trying to play audio: "+this.name+", "+l.message)}}_onended(){this.isPlaying=!1,this._startTime=0,this._currentTime=0,this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)}stop(e){var t,i;if(this.isPlaying)if(this._clearTimeoutsAndObservers(),this._streaming)this._htmlAudioElement?(this._htmlAudioElement.pause(),this._htmlAudioElement.currentTime>0&&(this._htmlAudioElement.currentTime=0)):(t=this._streamingSource)==null||t.disconnect(),this.isPlaying=!1;else if((i=te.audioEngine)!=null&&i.audioContext&&this._soundSource){const r=e?te.audioEngine.audioContext.currentTime+e:void 0;this._soundSource.onended=()=>{this.isPlaying=!1,this.isPaused=!1,this._startTime=0,this._currentTime=0,this._soundSource&&(this._soundSource.onended=()=>{}),this._onended()},this._soundSource.stop(r)}else this.isPlaying=!1;else this.isPaused&&(this.isPaused=!1,this._startTime=0,this._currentTime=0)}pause(){var e,t;this.isPlaying&&(this._clearTimeoutsAndObservers(),this._streaming?(this._htmlAudioElement?this._htmlAudioElement.pause():(e=this._streamingSource)==null||e.disconnect(),this.isPlaying=!1,this.isPaused=!0):(t=te.audioEngine)!=null&&t.audioContext&&this._soundSource&&(this._soundSource.onended=()=>{},this._soundSource.stop(),this.isPlaying=!1,this.isPaused=!0,this._currentTime+=te.audioEngine.audioContext.currentTime-this._startTime))}setVolume(e,t){var i;(i=te.audioEngine)!=null&&i.canUseWebAudio&&this._soundGain&&(t&&te.audioEngine.audioContext?(this._soundGain.gain.cancelScheduledValues(te.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,te.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(e,te.audioEngine.audioContext.currentTime+t)):this._soundGain.gain.value=e),this._volume=e}setPlaybackRate(e){this._playbackRate=e,this.isPlaying&&(this._streaming&&this._htmlAudioElement?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate))}getPlaybackRate(){return this._playbackRate}getVolume(){return this._volume}attachToMesh(e){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=e,this._spatialSound||(this._spatialSound=!0,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=t=>this._onRegisterAfterWorldMatrixUpdate(t),this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc)}detachFromMesh(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null)}_onRegisterAfterWorldMatrixUpdate(e){var t;if(!e.getBoundingInfo)this.setPosition(e.absolutePosition);else{const r=e.getBoundingInfo();this.setPosition(r.boundingSphere.centerWorld)}(t=te.audioEngine)!=null&&t.canUseWebAudio&&this._isDirectional&&this.isPlaying&&this._updateDirection()}clone(){if(this._streaming)return null;{const e=()=>{Wn(()=>this._isReadyToPlay,()=>{i._audioBuffer=this.getAudioBuffer(),i._isReadyToPlay=!0,i.autoplay&&i.play(0,this._offset,this._length)},void 0,300)},t={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},i=new ds(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,t);return this.useCustomAttenuation&&i.setAttenuationFunction(this._customAttenuationFunction),i.setPosition(this._position),i.setPlaybackRate(this._playbackRate),e(),i}}getAudioBuffer(){return this._audioBuffer}getSoundSource(){return this._soundSource}getSoundGain(){return this._soundGain}serialize(){const e={name:this.name,url:this._url,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this._spatialSound&&(this._connectedTransformNode&&(e.connectedMeshId=this._connectedTransformNode.id),e.position=this._position.asArray(),e.refDistance=this.refDistance,e.distanceModel=this.distanceModel,e.isDirectional=this._isDirectional,e.localDirectionToMesh=this._localDirection.asArray(),e.coneInnerAngle=this._coneInnerAngle,e.coneOuterAngle=this._coneOuterAngle,e.coneOuterGain=this._coneOuterGain),e}static Parse(e,t,i,r){const n=e.name;let a;e.url?a=i+e.url:a=i+n;const o={autoplay:e.autoplay,loop:e.loop,volume:e.volume,spatialSound:e.spatialSound,maxDistance:e.maxDistance,rolloffFactor:e.rolloffFactor,refDistance:e.refDistance,distanceModel:e.distanceModel,playbackRate:e.playbackRate};let l;if(!r)l=new ds(n,a,t,()=>{t.removePendingData(l)},o),t.addPendingData(l);else{const c=()=>{Wn(()=>r._isReadyToPlay,()=>{l._audioBuffer=r.getAudioBuffer(),l._isReadyToPlay=!0,l.autoplay&&l.play(0,l._offset,l._length)},void 0,300)};l=new ds(n,new ArrayBuffer(0),t,null,o),c()}if(e.position){const c=x.FromArray(e.position);l.setPosition(c)}if(e.isDirectional&&(l.setDirectionalCone(e.coneInnerAngle||360,e.coneOuterAngle||360,e.coneOuterGain||0),e.localDirectionToMesh)){const c=x.FromArray(e.localDirectionToMesh);l.setLocalDirectionToMesh(c)}if(e.connectedMeshId){const c=t.getMeshById(e.connectedMeshId);c&&l.attachToMesh(c)}return e.metadata&&(l.metadata=e.metadata),l}_setOffset(e){this._offset!==e&&(this.isPaused&&(this.stop(),this.isPaused=!1),this._offset=e)}_clearTimeoutsAndObservers(){var e;this._tryToPlayTimeout&&(clearTimeout(this._tryToPlayTimeout),this._tryToPlayTimeout=null),this._audioUnlockedObserver&&((e=te.audioEngine)==null||e.onAudioUnlockedObservable.remove(this._audioUnlockedObserver),this._audioUnlockedObserver=null)}}ds._SceneComponentInitialization=s=>{throw Ys("AudioSceneComponent")};y("BABYLON.Sound",ds);class aF{constructor(e,t={}){this.id=-1,this._isInitialized=!1,e=e||De.LastCreatedScene,e&&(this._scene=e,this.soundCollection=[],this._options=t,!this._options.mainTrack&&this._scene.soundTracks&&(this._scene.soundTracks.push(this),this.id=this._scene.soundTracks.length-1))}_initializeSoundTrackAudioGraph(){var e;(e=te.audioEngine)!=null&&e.canUseWebAudio&&te.audioEngine.audioContext&&(this._outputAudioNode=te.audioEngine.audioContext.createGain(),this._outputAudioNode.connect(te.audioEngine.masterGain),this._options&&this._options.volume&&(this._outputAudioNode.gain.value=this._options.volume),this._isInitialized=!0)}dispose(){if(te.audioEngine&&te.audioEngine.canUseWebAudio){for(this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this._outputAudioNode&&this._outputAudioNode.disconnect(),this._outputAudioNode=null}}addSound(e){var t;this._isInitialized||this._initializeSoundTrackAudioGraph(),(t=te.audioEngine)!=null&&t.canUseWebAudio&&this._outputAudioNode&&e.connectToSoundTrackAudioNode(this._outputAudioNode),e.soundTrackId!==void 0&&(e.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(e):this._scene.soundTracks&&this._scene.soundTracks[e.soundTrackId].removeSound(e)),this.soundCollection.push(e),e.soundTrackId=this.id}removeSound(e){const t=this.soundCollection.indexOf(e);t!==-1&&this.soundCollection.splice(t,1)}setVolume(e){var t;(t=te.audioEngine)!=null&&t.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.gain.value=e)}switchPanningModelToHRTF(){var e;if((e=te.audioEngine)!=null&&e.canUseWebAudio)for(let t=0;t<this.soundCollection.length;t++)this.soundCollection[t].switchPanningModelToHRTF()}switchPanningModelToEqualPower(){var e;if((e=te.audioEngine)!=null&&e.canUseWebAudio)for(let t=0;t<this.soundCollection.length;t++)this.soundCollection[t].switchPanningModelToEqualPower()}connectToAnalyser(e){var t;this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=e,(t=te.audioEngine)!=null&&t.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.disconnect(),this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,te.audioEngine.masterGain))}}const kc={},pd={};function ko(s,e){kc[s]=e}function oF(s,e){pd[s]=e}function wI(s){return pd[s]?pd[s]:null}function lF(s,e,t,i){for(const r in kc)Object.prototype.hasOwnProperty.call(kc,r)&&kc[r](s,e,t,i)}ko(se.NAME_AUDIO,(s,e,t,i)=>{var a;let r=[],n;if(t.sounds=t.sounds||[],s.sounds!==void 0&&s.sounds!==null)for(let o=0,l=s.sounds.length;o<l;o++){const c=s.sounds[o];(a=te.audioEngine)!=null&&a.canUseWebAudio?(c.url||(c.url=c.name),r[c.url]?t.sounds.push(ds.Parse(c,e,i,r[c.url])):(n=ds.Parse(c,e,i),r[c.url]=n,t.sounds.push(n))):t.sounds.push(new ds(c.name,null,e))}r=[]});Object.defineProperty(le.prototype,"mainSoundTrack",{get:function(){let s=this._getComponent(se.NAME_AUDIO);return s||(s=new or(this),this._addComponent(s)),this._mainSoundTrack||(this._mainSoundTrack=new aF(this,{mainTrack:!0})),this._mainSoundTrack},enumerable:!0,configurable:!0});le.prototype.getSoundByName=function(s){let e;for(e=0;e<this.mainSoundTrack.soundCollection.length;e++)if(this.mainSoundTrack.soundCollection[e].name===s)return this.mainSoundTrack.soundCollection[e];if(this.soundTracks){for(let t=0;t<this.soundTracks.length;t++)for(e=0;e<this.soundTracks[t].soundCollection.length;e++)if(this.soundTracks[t].soundCollection[e].name===s)return this.soundTracks[t].soundCollection[e]}return null};Object.defineProperty(le.prototype,"audioEnabled",{get:function(){let s=this._getComponent(se.NAME_AUDIO);return s||(s=new or(this),this._addComponent(s)),s.audioEnabled},set:function(s){let e=this._getComponent(se.NAME_AUDIO);e||(e=new or(this),this._addComponent(e)),s?e.enableAudio():e.disableAudio()},enumerable:!0,configurable:!0});Object.defineProperty(le.prototype,"headphone",{get:function(){let s=this._getComponent(se.NAME_AUDIO);return s||(s=new or(this),this._addComponent(s)),s.headphone},set:function(s){let e=this._getComponent(se.NAME_AUDIO);e||(e=new or(this),this._addComponent(e)),s?e.switchAudioModeForHeadphones():e.switchAudioModeForNormalSpeakers()},enumerable:!0,configurable:!0});Object.defineProperty(le.prototype,"audioListenerPositionProvider",{get:function(){let s=this._getComponent(se.NAME_AUDIO);return s||(s=new or(this),this._addComponent(s)),s.audioListenerPositionProvider},set:function(s){let e=this._getComponent(se.NAME_AUDIO);if(e||(e=new or(this),this._addComponent(e)),s&&typeof s!="function")throw new Error("The value passed to [Scene.audioListenerPositionProvider] must be a function that returns a Vector3");e.audioListenerPositionProvider=s},enumerable:!0,configurable:!0});Object.defineProperty(le.prototype,"audioListenerRotationProvider",{get:function(){let s=this._getComponent(se.NAME_AUDIO);return s||(s=new or(this),this._addComponent(s)),s.audioListenerRotationProvider},set:function(s){let e=this._getComponent(se.NAME_AUDIO);if(e||(e=new or(this),this._addComponent(e)),s&&typeof s!="function")throw new Error("The value passed to [Scene.audioListenerRotationProvider] must be a function that returns a Vector3");e.audioListenerRotationProvider=s},enumerable:!0,configurable:!0});Object.defineProperty(le.prototype,"audioPositioningRefreshRate",{get:function(){let s=this._getComponent(se.NAME_AUDIO);return s||(s=new or(this),this._addComponent(s)),s.audioPositioningRefreshRate},set:function(s){let e=this._getComponent(se.NAME_AUDIO);e||(e=new or(this),this._addComponent(e)),e.audioPositioningRefreshRate=s},enumerable:!0,configurable:!0});class or{get audioEnabled(){return this._audioEnabled}get headphone(){return this._headphone}constructor(e){this.name=se.NAME_AUDIO,this._audioEnabled=!0,this._headphone=!1,this.audioPositioningRefreshRate=500,this.audioListenerPositionProvider=null,this.audioListenerRotationProvider=null,this._cachedCameraDirection=new x,this._cachedCameraPosition=new x,this._lastCheck=0,this._invertMatrixTemp=new z,this._cameraDirectionTemp=new x,e=e||De.LastCreatedScene,e&&(this.scene=e,e.soundTracks=[],e.sounds=[])}register(){this.scene._afterRenderStage.registerStep(se.STEP_AFTERRENDER_AUDIO,this,this._afterRender)}rebuild(){}serialize(e){if(e.sounds=[],this.scene.soundTracks)for(let t=0;t<this.scene.soundTracks.length;t++){const i=this.scene.soundTracks[t];for(let r=0;r<i.soundCollection.length;r++)e.sounds.push(i.soundCollection[r].serialize())}}addFromContainer(e){if(e.sounds)for(const t of e.sounds)t.play(),t.autoplay=!0,this.scene.mainSoundTrack.addSound(t)}removeFromContainer(e,t=!1){if(e.sounds)for(const i of e.sounds)i.stop(),i.autoplay=!1,this.scene.mainSoundTrack.removeSound(i),t&&i.dispose()}dispose(){const e=this.scene;if(e._mainSoundTrack&&e.mainSoundTrack.dispose(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].dispose()}disableAudio(){const e=this.scene;this._audioEnabled=!1,te.audioEngine&&te.audioEngine.audioContext&&te.audioEngine.audioContext.suspend();let t;for(t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].pause();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let i=0;i<e.soundTracks[t].soundCollection.length;i++)e.soundTracks[t].soundCollection[i].pause()}enableAudio(){const e=this.scene;this._audioEnabled=!0,te.audioEngine&&te.audioEngine.audioContext&&te.audioEngine.audioContext.resume();let t;for(t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].isPaused&&e.mainSoundTrack.soundCollection[t].play();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let i=0;i<e.soundTracks[t].soundCollection.length;i++)e.soundTracks[t].soundCollection[i].isPaused&&e.soundTracks[t].soundCollection[i].play()}switchAudioModeForHeadphones(){const e=this.scene;if(this._headphone=!0,e.mainSoundTrack.switchPanningModelToHRTF(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToHRTF()}switchAudioModeForNormalSpeakers(){const e=this.scene;if(this._headphone=!1,e.mainSoundTrack.switchPanningModelToEqualPower(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToEqualPower()}_afterRender(){const e=Qr.Now;if(this._lastCheck&&e-this._lastCheck<this.audioPositioningRefreshRate)return;this._lastCheck=e;const t=this.scene;if(!this._audioEnabled||!t._mainSoundTrack||!t.soundTracks||t._mainSoundTrack.soundCollection.length===0&&t.soundTracks.length===1)return;const i=te.audioEngine;if(i&&i.audioContext){let r=t.activeCamera;if(t.activeCameras&&t.activeCameras.length>0&&(r=t.activeCameras[0]),this.audioListenerPositionProvider){const a=this.audioListenerPositionProvider();i.audioContext.listener.setPosition(a.x||0,a.y||0,a.z||0)}else r?this._cachedCameraPosition.equals(r.globalPosition)||(this._cachedCameraPosition.copyFrom(r.globalPosition),i.audioContext.listener.setPosition(r.globalPosition.x,r.globalPosition.y,r.globalPosition.z)):i.audioContext.listener.setPosition(0,0,0);if(this.audioListenerRotationProvider){const a=this.audioListenerRotationProvider();i.audioContext.listener.setOrientation(a.x||0,a.y||0,a.z||0,0,1,0)}else r?(r.rigCameras&&r.rigCameras.length>0&&(r=r.rigCameras[0]),r.getViewMatrix().invertToRef(this._invertMatrixTemp),x.TransformNormalToRef(or._CameraDirection,this._invertMatrixTemp,this._cameraDirectionTemp),this._cameraDirectionTemp.normalize(),!isNaN(this._cameraDirectionTemp.x)&&!isNaN(this._cameraDirectionTemp.y)&&!isNaN(this._cameraDirectionTemp.z)&&(this._cachedCameraDirection.equals(this._cameraDirectionTemp)||(this._cachedCameraDirection.copyFrom(this._cameraDirectionTemp),i.audioContext.listener.setOrientation(this._cameraDirectionTemp.x,this._cameraDirectionTemp.y,this._cameraDirectionTemp.z,0,1,0)))):i.audioContext.listener.setOrientation(0,0,0,0,1,0);let n;for(n=0;n<t.mainSoundTrack.soundCollection.length;n++){const a=t.mainSoundTrack.soundCollection[n];a.useCustomAttenuation&&a.updateDistanceFromListener()}if(t.soundTracks)for(n=0;n<t.soundTracks.length;n++)for(let a=0;a<t.soundTracks[n].soundCollection.length;a++){const o=t.soundTracks[n].soundCollection[a];o.useCustomAttenuation&&o.updateDistanceFromListener()}}}}or._CameraDirection=new x(0,0,-1);ds._SceneComponentInitialization=s=>{let e=s._getComponent(se.NAME_AUDIO);e||(e=new or(s),s._addComponent(e))};class Du extends LI{constructor(e,t){super(e,t,3)}connect(e){if(!this._connect(e))throw new Error("Connect failed")}disconnect(e){if(!this._disconnect(e))throw new Error("Disconnect failed")}disconnectAll(){if(!this._downstreamNodes)throw new Error("Disconnect failed");const e=this._downstreamNodes.values();for(let t=e.next();!t.done;t=e.next())if(!this._disconnect(t.value))throw new Error("Disconnect failed")}}const BI={volume:1};class cF extends Du{constructor(e){super("Volume",e)}setOptions(e){this.volume=e.volume??BI.volume}}function So(s){return s.getSubNode("Volume")}function uF(s,e){var t;return((t=So(s))==null?void 0:t[e])??BI[e]}const Dn={fftSize:2048,minDecibels:-100,maxDecibels:-30,smoothing:.8};function hF(s){return s.analyzerEnabled||s.analyzerFFTSize!==void 0||s.analyzerMinDecibels!==void 0||s.analyzerMaxDecibels!==void 0||s.analyzerSmoothing!==void 0}class dF{get frequencyBinCount(){return this.fftSize/2}}class fF extends Du{constructor(e){super("Analyzer",e)}setOptions(e){this.fftSize=e.analyzerFFTSize??Dn.fftSize,this.minDecibels=e.analyzerMinDecibels??Dn.minDecibels,this.maxDecibels=e.analyzerMaxDecibels??Dn.maxDecibels,this.smoothing=e.analyzerSmoothing??Dn.smoothing}}function ua(s){return s.getSubNode("Analyzer")}function bc(s,e,t){s.callOnSubNode("Analyzer",i=>{i[e]=t})}let Xh=null,Yh=null;function VI(){return Xh||(Xh=new Uint8Array),Xh}function UI(){return Yh||(Yh=new Float32Array),Yh}class pF extends dF{constructor(e){super(),this._fftSize=Dn.fftSize,this._maxDecibels=Dn.maxDecibels,this._minDecibels=Dn.minDecibels,this._smoothing=Dn.smoothing,this._subGraph=e}get fftSize(){return this._fftSize}set fftSize(e){this._fftSize=e,bc(this._subGraph,"fftSize",e)}get isEnabled(){return ua(this._subGraph)!==null}get minDecibels(){return this._minDecibels}set minDecibels(e){this._minDecibels=e,bc(this._subGraph,"minDecibels",e)}get maxDecibels(){return this._maxDecibels}set maxDecibels(e){this._maxDecibels=e,bc(this._subGraph,"maxDecibels",e)}get smoothing(){return this._smoothing}set smoothing(e){this._smoothing=e,bc(this._subGraph,"smoothing",e)}dispose(){const e=ua(this._subGraph);e&&(this._subGraph.removeSubNodeAsync(e),e.dispose())}async enableAsync(){ua(this._subGraph)||await this._subGraph.createAndAddSubNodeAsync("Analyzer")}getByteFrequencyData(){const e=ua(this._subGraph);return e?e.getByteFrequencyData():(N.Warn("AudioAnalyzer not enabled"),this.enableAsync(),VI())}getFloatFrequencyData(){const e=ua(this._subGraph);return e?e.getFloatFrequencyData():(N.Warn("AudioAnalyzer not enabled"),this.enableAsync(),UI())}}class kI extends LI{constructor(e,t,i){super(e,t,i),this._analyzer=null}get analyzer(){return this._analyzer??(this._analyzer=new pF(this._subGraph))}get volume(){return uF(this._subGraph,"volume")}set volume(e){const t=So(this._subGraph);if(!t)throw new Error("No volume subnode");t.volume=e}dispose(){var e;super.dispose(),(e=this._analyzer)==null||e.dispose(),this._analyzer=null,this._subGraph.dispose()}setVolume(e,t=null){const i=So(this._subGraph);if(!i)throw new Error("No volume subnode");i.setVolume(e,t)}}class GI extends kI{constructor(e,t){super(e,t,3)}}class zI extends kI{constructor(e,t,i=2){super(e,t,i),this._outBus=null,this._onOutBusDisposed=()=>{this._outBus=null}}get outBus(){return this._outBus}set outBus(e){if(this._outBus!==e){if(this._outBus&&(this._outBus.onDisposeObservable.removeCallback(this._onOutBusDisposed),!this._disconnect(this._outBus)))throw new Error("Disconnect failed");if(this._outBus=e,this._outBus&&(this._outBus.onDisposeObservable.add(this._onOutBusDisposed),!this._connect(this._outBus)))throw new Error("Connect failed")}}dispose(){super.dispose(),this._outBus=null}}class WI extends zI{constructor(e,t){super(e,t,3),this._newestInstance=null,this._privateInstances=new Set,this._state=1,this._instances=this._privateInstances,this.onEndedObservable=new k,this._onInstanceEnded=i=>{this._newestInstance===i&&(this._newestInstance=null),this._privateInstances.delete(i),this._instances.size===0&&(this._state=1,this.onEndedObservable.notifyObservers(this))}}get autoplay(){return this._options.autoplay}get currentTime(){const e=this._getNewestInstance();return e?e.currentTime:0}set currentTime(e){this.startOffset=e;const t=this._getNewestInstance();t&&(t.currentTime=e)}get loop(){return this._options.loop}set loop(e){this._options.loop=e}get maxInstances(){return this._options.maxInstances}set maxInstances(e){this._options.maxInstances=e}get startOffset(){return this._options.startOffset}set startOffset(e){this._options.startOffset=e}get state(){return this._state}dispose(){super.dispose(),this.stop(),this._newestInstance=null,this._privateInstances.clear(),this.onEndedObservable.clear()}pause(){const e=this._instances.values();for(let t=e.next();!t.done;t=e.next())t.value.pause();this._state=5}resume(){if(this._state!==5)return;const e=this._instances.values();for(let t=e.next();!t.done;t=e.next())t.value.resume();this._state=3}_beforePlay(e){if(this.state===5&&this._instances.size>0){this.resume();return}e.onEndedObservable.addOnce(this._onInstanceEnded),this._privateInstances.add(e),this._newestInstance=e}_afterPlay(e){this._state=e.state}_getNewestInstance(){if(this._instances.size===0)return null;if(!this._newestInstance){const e=this._instances.values();for(let t=e.next();!t.done;t=e.next())this._newestInstance=t.value}return this._newestInstance}_setState(e){this._state=e}_stopExcessInstances(){if(this.maxInstances<1/0){const e=Array.from(this._instances).filter(i=>i.state===3).length-this.maxInstances,t=this._instances.values();for(let i=0;i<e;i++)t.next().value.stop()}}}class mF extends GI{constructor(e,t){super(e,t),this._outBus=null,this._onOutBusDisposed=()=>{this.outBus=this.engine.defaultMainBus}}get outBus(){return this._outBus}set outBus(e){if(this._outBus!==e){if(this._outBus&&(this._outBus.onDisposeObservable.removeCallback(this._onOutBusDisposed),!this._disconnect(this._outBus)))throw new Error("Disconnect failed");if(this._outBus=e,this._outBus&&(this._outBus.onDisposeObservable.add(this._onOutBusDisposed),!this._connect(this._outBus)))throw new Error("Connect failed")}}dispose(){super.dispose(),this._outBus=null}}class _F extends GI{constructor(e,t){super(e,t)}}class gF extends WI{constructor(e,t){super(e,t)}get duration(){return this._options.duration}set duration(e){this._options.duration=e}get loopStart(){return this._options.loopStart}set loopStart(e){this._options.loopStart=e}get loopEnd(){return this._options.loopEnd}set loopEnd(e){this._options.loopEnd=e}get pitch(){return this._options.pitch}set pitch(e){this._options.pitch=e;const t=this._instances.values();for(let i=t.next();!i.done;i=t.next())i.value.pitch=e}get playbackRate(){return this._options.playbackRate}set playbackRate(e){this._options.playbackRate=e;const t=this._instances.values();for(let i=t.next();!i.done;i=t.next())i.value.playbackRate=e}play(e={}){if(this.state===5){this.resume();return}e.duration??(e.duration=this.duration),e.loop??(e.loop=this.loop),e.loopStart??(e.loopStart=this.loopStart),e.loopEnd??(e.loopEnd=this.loopEnd),e.startOffset??(e.startOffset=this.startOffset),e.volume??(e.volume=1),e.waitTime??(e.waitTime=0);const t=this._createInstance();this._beforePlay(t),t.play(e),this._afterPlay(t),this._stopExcessInstances()}stop(e={}){if(e.waitTime&&0<e.waitTime?this._setState(0):this._setState(1),!!this._instances)for(const t of Array.from(this._instances))t.stop(e)}}let SF=1;class vF{constructor(e){this.name=`StaticSoundBuffer #${SF++}`,this.engine=e}}class xF extends WI{constructor(e,t){super(e,t),this._preloadedInstances=new Array}get preloadCount(){return this._options.preloadCount??1}get preloadCompletedCount(){return this._preloadedInstances.length}preloadInstanceAsync(){const e=this._createInstance();return this._addPreloadedInstance(e),e.preloadedPromise}async preloadInstancesAsync(e){for(let t=0;t<e;t++)this.preloadInstanceAsync();await Promise.all(this._preloadedInstances.map(async t=>await t.preloadedPromise))}play(e={}){if(this.state===5){this.resume();return}let t;this.preloadCompletedCount>0?(t=this._preloadedInstances[0],t.startOffset=this.startOffset,this._removePreloadedInstance(t)):t=this._createInstance();const i=()=>{t.state===3&&(this._stopExcessInstances(),t.onStateChangedObservable.removeCallback(i))};t.onStateChangedObservable.add(i),e.startOffset??(e.startOffset=this.startOffset),e.loop??(e.loop=this.loop),e.volume??(e.volume=1),this._beforePlay(t),t.play(e),this._afterPlay(t)}stop(){if(this._setState(1),!!this._instances)for(const e of Array.from(this._instances))e.stop()}_addPreloadedInstance(e){this._preloadedInstances.includes(e)||this._preloadedInstances.push(e)}_removePreloadedInstance(e){const t=this._preloadedInstances.indexOf(e);t!==-1&&this._preloadedInstances.splice(t,1)}}const ei={coneInnerAngle:6.28318530718,coneOuterAngle:6.28318530718,coneOuterVolume:0,distanceModel:"linear",maxDistance:1e4,minDistance:1,panningModel:"equalpower",position:x.Zero(),rolloffFactor:1,rotation:x.Zero(),rotationQuaternion:new Z};function Ql(s){return s.spatialEnabled||s.spatialAutoUpdate!==void 0||s.spatialConeInnerAngle!==void 0||s.spatialConeOuterAngle!==void 0||s.spatialConeOuterVolume!==void 0||s.spatialDistanceModel!==void 0||s.spatialMaxDistance!==void 0||s.spatialMinDistance!==void 0||s.spatialMinUpdateTime!==void 0||s.spatialPanningModel!==void 0||s.spatialPosition!==void 0||s.spatialRolloffFactor!==void 0||s.spatialRotation!==void 0||s.spatialRotationQuaternion!==void 0}class EF{}const HI={pan:0};function TF(s){return s.stereoEnabled||s.stereoPan!==void 0}class bF{}var Ag;(function(s){s.Linear="linear",s.Exponential="exponential",s.Logarithmic="logarithmic"})(Ag||(Ag={}));var Pg;(function(s){s[s.Stopping=0]="Stopping",s[s.Stopped=1]="Stopped",s[s.Starting=2]="Starting",s[s.Started=3]="Started",s[s.FailedToStart=4]="FailedToStart",s[s.Paused=5]="Paused"})(Pg||(Pg={}));var Og;(function(s){s[s.Position=1]="Position",s[s.Rotation=2]="Rotation",s[s.PositionAndRotation=3]="PositionAndRotation"})(Og||(Og={}));class CF extends Du{constructor(e){super("Stereo",e)}setOptions(e){this.pan=e.stereoPan??HI.pan}}function Ng(s){return s.getSubNode("Stereo")}function yF(s,e,t){s.callOnSubNode("Stereo",i=>{i[e]=t})}class Mu extends bF{constructor(e){super(),this._pan=HI.pan,this._subGraph=e}get pan(){return this._pan}set pan(e){this._pan=e,yF(this._subGraph,"pan",e)}}class IF extends Du{constructor(e){super("Spatial",e),this._attacherComponent=null}get isAttached(){return this._attacherComponent!==null&&this._attacherComponent.isAttached}attach(e,t,i){this.detach(),this._attacherComponent||(this._attacherComponent=new dd(this)),this._attacherComponent.attach(e,t,i)}detach(){var e;(e=this._attacherComponent)==null||e.detach()}dispose(){var e;super.dispose(),(e=this._attacherComponent)==null||e.dispose(),this._attacherComponent=null}setOptions(e){this.coneInnerAngle=e.spatialConeInnerAngle??ei.coneInnerAngle,this.coneOuterAngle=e.spatialConeOuterAngle??ei.coneOuterAngle,this.coneOuterVolume=e.spatialConeOuterVolume??ei.coneOuterVolume,this.distanceModel=e.spatialDistanceModel??ei.distanceModel,this.maxDistance=e.spatialMaxDistance??ei.maxDistance,this.minDistance=e.spatialMinDistance??ei.minDistance,this.panningModel=e.spatialPanningModel??ei.panningModel,this.rolloffFactor=e.spatialRolloffFactor??ei.rolloffFactor,e.spatialPosition&&(this.position=e.spatialPosition.clone()),e.spatialRotationQuaternion?this.rotationQuaternion=e.spatialRotationQuaternion.clone():e.spatialRotation?this.rotation=e.spatialRotation.clone():this.rotationQuaternion=ei.rotationQuaternion.clone(),this.update()}update(){var e;this.isAttached?(e=this._attacherComponent)==null||e.update():(this._updatePosition(),this._updateRotation())}}function On(s){return s.getSubNode("Spatial")}function yn(s,e,t){s.callOnSubNode("Spatial",i=>{i[e]=t})}const Dg=z.Zero(),jh=new Z,Cc=x.Zero();function Mg(s){return s*Math.PI/180}function Fg(s){return s*180/Math.PI}async function RF(s){return new AF(s)}class AF extends IF{constructor(e){super(e),this._lastPosition=x.Zero(),this._lastRotation=x.Zero(),this._lastRotationQuaternion=new Z,this.position=ei.position.clone(),this.rotation=ei.rotation.clone(),this.rotationQuaternion=ei.rotationQuaternion.clone(),this.node=new PannerNode(e._audioContext),this._orientationX=new Ti(e,this.node.orientationX),this._orientationY=new Ti(e,this.node.orientationY),this._orientationZ=new Ti(e,this.node.orientationZ),this._positionX=new Ti(e,this.node.positionX),this._positionY=new Ti(e,this.node.positionY),this._positionZ=new Ti(e,this.node.positionZ)}dispose(){super.dispose(),this._orientationX.dispose(),this._orientationY.dispose(),this._orientationZ.dispose(),this._positionX.dispose(),this._positionY.dispose(),this._positionZ.dispose(),this.node.disconnect()}get coneInnerAngle(){return Mg(this.node.coneInnerAngle)}set coneInnerAngle(e){this.node.coneInnerAngle=Fg(e)}get coneOuterAngle(){return Mg(this.node.coneOuterAngle)}set coneOuterAngle(e){this.node.coneOuterAngle=Fg(e)}get coneOuterVolume(){return this.node.coneOuterGain}set coneOuterVolume(e){this.node.coneOuterGain=e}get distanceModel(){return this.node.distanceModel}set distanceModel(e){this.node.distanceModel=e;const t=this.node.maxDistance;this.node.maxDistance=t+.001,this.node.maxDistance=t}get minDistance(){return this.node.refDistance}set minDistance(e){this.node.refDistance=e}get maxDistance(){return this.node.maxDistance}set maxDistance(e){this.node.maxDistance=e}get panningModel(){return this.node.panningModel}set panningModel(e){this.node.panningModel=e}get rolloffFactor(){return this.node.rolloffFactor}set rolloffFactor(e){this.node.rolloffFactor=e}get _inNode(){return this.node}get _outNode(){return this.node}_updatePosition(){this._lastPosition.equalsWithEpsilon(this.position)||this.isAttached&&(this._positionX.isRamping||this._positionY.isRamping||this._positionZ.isRamping)||(this._positionX.targetValue=this.position.x,this._positionY.targetValue=this.position.y,this._positionZ.targetValue=this.position.z,this._lastPosition.copyFrom(this.position))}_updateRotation(){if(!(this.isAttached&&(this._orientationX.isRamping||this._orientationY.isRamping||this._orientationZ.isRamping))){if(!this._lastRotationQuaternion.equalsWithEpsilon(this.rotationQuaternion))jh.copyFrom(this.rotationQuaternion),this._lastRotationQuaternion.copyFrom(this.rotationQuaternion);else if(!this._lastRotation.equalsWithEpsilon(this.rotation))Z.FromEulerAnglesToRef(this.rotation.x,this.rotation.y,this.rotation.z,jh),this._lastRotation.copyFrom(this.rotation);else return;z.FromQuaternionToRef(jh,Dg),x.TransformNormalToRef(x.RightReadOnly,Dg,Cc),this._orientationX.targetValue=Cc.x,this._orientationY.targetValue=Cc.y,this._orientationZ.targetValue=Cc.z}}_connect(e){return super._connect(e)?(e._inNode&&this.node.connect(e._inNode),!0):!1}_disconnect(e){return super._disconnect(e)?(e._inNode&&this.node.disconnect(e._inNode),!0):!1}getClassName(){return"_SpatialWebAudioSubNode"}}async function PF(s){return new OF(s)}class OF extends CF{constructor(e){super(e),this.node=new StereoPannerNode(e._audioContext),this._pan=new Ti(e,this.node.pan)}dispose(){super.dispose(),this._pan.dispose()}get pan(){return this._pan.targetValue}set pan(e){this._pan.targetValue=e}get _inNode(){return this.node}get _outNode(){return this.node}getClassName(){return"_StereoWebAudioSubNode"}_connect(e){return super._connect(e)?(e._inNode&&this.node.connect(e._inNode),!0):!1}_disconnect(e){return super._disconnect(e)?(e._inNode&&this.node.disconnect(e._inNode),!0):!1}}class NF{constructor(){this._createSubNodePromises={},this._isDisposed=!1,this._subNodes={},this._onSubNodeDisposed=e=>{const t=e;delete this._subNodes[t.name],this._onSubNodesChanged()}}callOnSubNode(e,t){const i=this.getSubNode(e);if(i){t(i);return}this._createSubNodePromisesResolvedAsync().then(()=>{const r=this.getSubNode(e);if(r){t(r);return}this.createAndAddSubNodeAsync(e).then(n=>{t(n)})})}createAndAddSubNodeAsync(e){var t;return(t=this._createSubNodePromises)[e]||(t[e]=this._createSubNode(e).then(i=>(this._addSubNode(i),i))),this._createSubNodePromises[e]}dispose(){this._isDisposed=!0;const e=Object.values(this._subNodes);for(const t of e)t.dispose();this._subNodes={},this._createSubNodePromises={}}getSubNode(e){return this._subNodes[e]??null}async removeSubNodeAsync(e){await this._createSubNodePromisesResolvedAsync();const t=e.name;this._subNodes[t]&&delete this._subNodes[t],delete this._createSubNodePromises[t],this._onSubNodesChanged()}async _createSubNodePromisesResolvedAsync(){return await Promise.all(Object.values(this._createSubNodePromises))}_addSubNode(e){if(this._isDisposed){e.dispose();return}this._subNodes[e.name]=e,e.onDisposeObservable.addOnce(this._onSubNodeDisposed),this._onSubNodesChanged()}}async function DF(s){return new MF(s)}class MF extends cF{constructor(e){super(e);const t=this.node=new GainNode(e._audioContext);this._volume=new Ti(e,t.gain)}dispose(){super.dispose(),this._volume.dispose()}get volume(){return this._volume.value}set volume(e){this.setVolume(e)}get _inNode(){return this.node}get _outNode(){return this.node}setVolume(e,t=null){this._volume.setTargetValue(e,t)}_connect(e){return super._connect(e)?(e._inNode&&this.node.connect(e._inNode),!0):!1}_disconnect(e){return super._disconnect(e)?(e._inNode&&this.node.disconnect(e._inNode),!0):!1}getClassName(){return"_VolumeWebAudioSubNode"}}async function FF(s){return new LF(s)}class LF extends fF{constructor(e){super(e),this._byteFrequencyData=null,this._floatFrequencyData=null,this._analyzerNode=new AnalyserNode(e._audioContext)}get fftSize(){return this._analyzerNode.fftSize}set fftSize(e){e!==this._analyzerNode.fftSize&&(this._analyzerNode.fftSize=e,this._clearArrays())}get _inNode(){return this._analyzerNode}get minDecibels(){return this._analyzerNode.minDecibels}set minDecibels(e){this._analyzerNode.minDecibels=e}get maxDecibels(){return this._analyzerNode.maxDecibels}set maxDecibels(e){this._analyzerNode.maxDecibels=e}get smoothing(){return this._analyzerNode.smoothingTimeConstant}set smoothing(e){this._analyzerNode.smoothingTimeConstant=e}dispose(){super.dispose(),this._clearArrays(),this._byteFrequencyData=null,this._floatFrequencyData=null,this._analyzerNode.disconnect()}getClassName(){return"_WebAudioAnalyzerSubNode"}getByteFrequencyData(){return(!this._byteFrequencyData||this._byteFrequencyData.length===0)&&(this._byteFrequencyData=new Uint8Array(this._analyzerNode.frequencyBinCount)),this._analyzerNode.getByteFrequencyData(this._byteFrequencyData),this._byteFrequencyData}getFloatFrequencyData(){return(!this._floatFrequencyData||this._floatFrequencyData.length===0)&&(this._floatFrequencyData=new Float32Array(this._analyzerNode.frequencyBinCount)),this._analyzerNode.getFloatFrequencyData(this._floatFrequencyData),this._floatFrequencyData}_clearArrays(){var e,t;(e=this._byteFrequencyData)==null||e.set(VI()),(t=this._floatFrequencyData)==null||t.set(UI())}}class $I extends NF{constructor(e){super(),this._outputNode=null,this._owner=e}async initAsync(e){const t=hF(e);if(t&&await this.createAndAddSubNodeAsync("Analyzer"),await this.createAndAddSubNodeAsync("Volume"),await this._createSubNodePromisesResolvedAsync(),t){const r=ua(this);if(!r)throw new Error("No analyzer subnode.");r.setOptions(e)}const i=So(this);if(!i)throw new Error("No volume subnode.");if(i.setOptions(e),i.getClassName()!=="_VolumeWebAudioSubNode")throw new Error("Not a WebAudio subnode.");if(this._outputNode=i.node,this._outputNode&&this._downstreamNodes){const r=this._downstreamNodes.values();for(let n=r.next();!n.done;n=r.next()){const a=n.value._inNode;a&&this._outputNode.connect(a)}}}get _inNode(){return this._outputNode}get _outNode(){return this._outputNode}_createSubNode(e){switch(e){case"Analyzer":return FF(this._owner.engine);case"Volume":return DF(this._owner.engine);default:throw new Error(`Unknown subnode name: ${e}`)}}_onSubNodesChanged(){const e=ua(this),t=So(this);e&&t&&t.connect(e)}}class Fu extends $I{constructor(){super(...arguments),this._rootNode=null,this._inputNode=null}async initAsync(e){var r,n;await super.initAsync(e);let t=!1,i=!1;(t=Ql(e))&&await this.createAndAddSubNodeAsync("Spatial"),(i=TF(e))&&await this.createAndAddSubNodeAsync("Stereo"),await this._createSubNodePromisesResolvedAsync(),t&&((r=On(this))==null||r.setOptions(e)),i&&((n=Ng(this))==null||n.setOptions(e))}get _inNode(){return this._inputNode}_createSubNode(e){try{return super._createSubNode(e)}catch{}switch(e){case"Spatial":return RF(this._owner.engine);case"Stereo":return PF(this._owner.engine);default:throw new Error(`Unknown subnode name: ${e}`)}}_onSubNodesChanged(){var a,o,l;super._onSubNodesChanged();const e=On(this),t=Ng(this),i=So(this);if(e&&e.getClassName()!=="_SpatialWebAudioSubNode")throw new Error("Not a WebAudio subnode.");if(t&&t.getClassName()!=="_StereoWebAudioSubNode")throw new Error("Not a WebAudio subnode.");if(i&&i.getClassName()!=="_VolumeWebAudioSubNode")throw new Error("Not a WebAudio subnode.");e&&(e.disconnectAll(),i&&e.connect(i)),t&&(t.disconnectAll(),i&&t.connect(i)),e&&t?(this._rootNode=new GainNode(this._owner.engine._audioContext),this._rootNode.connect(e._outNode),this._rootNode.connect(t._outNode)):((a=this._rootNode)==null||a.disconnect(),this._rootNode=null);let r=null,n=null;if(this._rootNode?n=this._rootNode:(e?r=e:t?r=t:i&&(r=i),n=(r==null?void 0:r.node)??null),this._inputNode!==n){if(this._inputNode&&this._upstreamNodes){const c=this._upstreamNodes.values();for(let u=c.next();!u.done;u=c.next())(o=u.value._outNode)==null||o.disconnect(this._inputNode)}if(this._inputNode=n,n&&this._upstreamNodes){const c=this._upstreamNodes.values();for(let u=c.next();!u.done;u=c.next())(l=u.value._outNode)==null||l.connect(n)}}}}class wF extends EF{constructor(e){super(),this._coneInnerAngle=ei.coneInnerAngle,this._coneOuterAngle=ei.coneOuterAngle,this._coneOuterVolume=ei.coneOuterVolume,this._distanceModel=ei.distanceModel,this._maxDistance=ei.maxDistance,this._minDistance=ei.minDistance,this._panningModel=ei.panningModel,this._rolloffFactor=ei.rolloffFactor;const t=On(e);t?(this._position=t.position.clone(),this._rotation=t.rotation.clone(),this._rotationQuaternion=t.rotationQuaternion.clone()):(this._position=ei.position.clone(),this._rotation=ei.rotation.clone(),this._rotationQuaternion=ei.rotationQuaternion.clone(),e.createAndAddSubNodeAsync("Spatial")),this._subGraph=e}get coneInnerAngle(){return this._coneInnerAngle}set coneInnerAngle(e){this._coneInnerAngle=e,yn(this._subGraph,"coneInnerAngle",e)}get coneOuterAngle(){return this._coneOuterAngle}set coneOuterAngle(e){this._coneOuterAngle=e,yn(this._subGraph,"coneOuterAngle",e)}get coneOuterVolume(){return this._coneOuterVolume}set coneOuterVolume(e){this._coneOuterVolume=e,yn(this._subGraph,"coneOuterVolume",e)}get distanceModel(){return this._distanceModel}set distanceModel(e){this._distanceModel=e,yn(this._subGraph,"distanceModel",e)}get isAttached(){var e;return((e=this._subGraph.getSubNode("Spatial"))==null?void 0:e.isAttached)??!1}get maxDistance(){return this._maxDistance}set maxDistance(e){e<=0&&(e=1e-6),this._maxDistance=e,yn(this._subGraph,"maxDistance",e)}get minDistance(){return this._minDistance}set minDistance(e){this._minDistance=e,yn(this._subGraph,"minDistance",e)}get panningModel(){return this._panningModel}set panningModel(e){this._panningModel=e,yn(this._subGraph,"panningModel",e)}get position(){return this._position}set position(e){this._position=e,this._updatePosition()}get rolloffFactor(){return this._rolloffFactor}set rolloffFactor(e){this._rolloffFactor=e,yn(this._subGraph,"rolloffFactor",e)}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._updateRotation()}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion=e,this._updateRotation()}attach(e,t=!1,i=3){var r;(r=On(this._subGraph))==null||r.attach(e,t,i)}detach(){var e;(e=On(this._subGraph))==null||e.detach()}update(){const e=On(this._subGraph);e&&(e.isAttached?e.update():(this._updatePosition(e),this._updateRotation(e)))}_updatePosition(e=null){if(!e&&(e=On(this._subGraph),!e))return;e.position.equalsWithEpsilon(this._position)||(e.position.copyFrom(this._position),e._updatePosition())}_updateRotation(e=null){!e&&(e=On(this._subGraph),!e)||(e.rotationQuaternion.equalsWithEpsilon(this._rotationQuaternion)?e.rotation.equalsWithEpsilon(this._rotation)||(e.rotation.copyFrom(this._rotation),e._updateRotation()):(e.rotationQuaternion.copyFrom(this._rotationQuaternion),e._updateRotation()))}}class Lu extends wF{constructor(e,t,i){super(e),this._updaterComponent=new MI(this,t,i)}get minUpdateTime(){return this._updaterComponent.minUpdateTime}set minUpdateTime(e){this._updaterComponent.minUpdateTime=e}dispose(){this._updaterComponent.dispose(),this._updaterComponent=null}}class wu extends mF{constructor(e,t,i){super(e,t),this._spatial=null,this._spatialAutoUpdate=!0,this._spatialMinUpdateTime=0,this._stereo=null,typeof i.spatialAutoUpdate=="boolean"&&(this._spatialAutoUpdate=i.spatialAutoUpdate),typeof i.spatialMinUpdateTime=="number"&&(this._spatialMinUpdateTime=i.spatialMinUpdateTime),this._subGraph=new wu._SubGraph(this)}async _initAsync(e){e.outBus?this.outBus=e.outBus:(await this.engine.isReadyPromise,this.outBus=this.engine.defaultMainBus),await this._subGraph.initAsync(e),Ql(e)&&this._initSpatialProperty(),this.engine._addNode(this)}dispose(){super.dispose(),this._spatial=null,this._stereo=null,this.engine._removeNode(this)}get _inNode(){return this._subGraph._inNode}get _outNode(){return this._subGraph._outNode}get spatial(){return this._spatial?this._spatial:this._initSpatialProperty()}get stereo(){return this._stereo??(this._stereo=new Mu(this._subGraph))}getClassName(){return"_WebAudioBus"}_connect(e){var i;return super._connect(e)?(e._inNode&&((i=this._outNode)==null||i.connect(e._inNode)),!0):!1}_disconnect(e){var i;return super._disconnect(e)?(e._inNode&&((i=this._outNode)==null||i.disconnect(e._inNode)),!0):!1}_initSpatialProperty(){return this._spatial||(this._spatial=new Lu(this._subGraph,this._spatialAutoUpdate,this._spatialMinUpdateTime)),this._spatial}}wu._SubGraph=class extends Fu{get _downstreamNodes(){return this._owner._downstreamNodes??null}get _upstreamNodes(){return this._owner._upstreamNodes??null}};const BF=Object.freeze(Object.defineProperty({__proto__:null,_WebAudioBus:wu},Symbol.toStringTag,{value:"Module"}));class Bu extends _F{constructor(e,t){super(e,t),this._subGraph=new Bu._SubGraph(this)}async _initAsync(e){if(await this._subGraph.initAsync(e),this.engine.mainOut&&!this._connect(this.engine.mainOut))throw new Error("Connect failed");this.engine._addMainBus(this)}dispose(){super.dispose(),this.engine._removeMainBus(this)}get _inNode(){return this._subGraph._inNode}get _outNode(){return this._subGraph._outNode}_connect(e){var i;return super._connect(e)?(e._inNode&&((i=this._outNode)==null||i.connect(e._inNode)),!0):!1}_disconnect(e){var i;return super._disconnect(e)?(e._inNode&&((i=this._outNode)==null||i.disconnect(e._inNode)),!0):!1}getClassName(){return"_WebAudioMainBus"}}Bu._SubGraph=class extends $I{get _downstreamNodes(){return this._owner._downstreamNodes??null}};const VF=Object.freeze(Object.defineProperty({__proto__:null,_WebAudioMainBus:Bu},Symbol.toStringTag,{value:"Module"}));class Vu extends zI{constructor(e,t,i,r){super(e,i),this._spatial=null,this._spatialAutoUpdate=!0,this._spatialMinUpdateTime=0,this._stereo=null,typeof r.spatialAutoUpdate=="boolean"&&(this._spatialAutoUpdate=r.spatialAutoUpdate),typeof r.spatialMinUpdateTime=="number"&&(this._spatialMinUpdateTime=r.spatialMinUpdateTime),this._audioContext=this.engine._audioContext,this._webAudioNode=t,this._subGraph=new Vu._SubGraph(this)}async _initAsync(e){e.outBus?this.outBus=e.outBus:e.outBusAutoDefault!==!1&&(await this.engine.isReadyPromise,this.outBus=this.engine.defaultMainBus),await this._subGraph.initAsync(e),Ql(e)&&this._initSpatialProperty(),this.engine._addNode(this)}get _inNode(){return this._webAudioNode}get _outNode(){return this._subGraph._outNode}get spatial(){return this._spatial?this._spatial:this._initSpatialProperty()}get stereo(){return this._stereo??(this._stereo=new Mu(this._subGraph))}dispose(){var e;super.dispose(),(e=this._spatial)==null||e.dispose(),this._spatial=null,this._stereo=null,this._subGraph.dispose(),this.engine._removeNode(this)}getClassName(){return"_WebAudioSoundSource"}_connect(e){var i;return super._connect(e)?(e._inNode&&((i=this._outNode)==null||i.connect(e._inNode)),!0):!1}_disconnect(e){var i;return super._disconnect(e)?(e._inNode&&((i=this._outNode)==null||i.disconnect(e._inNode)),!0):!1}_initSpatialProperty(){return this._spatial||(this._spatial=new Lu(this._subGraph,this._spatialAutoUpdate,this._spatialMinUpdateTime)),this._spatial}}Vu._SubGraph=class extends Fu{get _downstreamNodes(){return this._owner._downstreamNodes??null}get _upstreamNodes(){return this._owner._upstreamNodes??null}_onSubNodesChanged(){super._onSubNodesChanged(),this._owner._inNode.disconnect(),this._owner._subGraph._inNode&&this._owner._inNode.connect(this._owner._subGraph._inNode)}};const UF=Object.freeze(Object.defineProperty({__proto__:null,_WebAudioSoundSource:Vu},Symbol.toStringTag,{value:"Module"}));class XI extends e_{constructor(e){super(e.engine,2),this._state=1,this.onEndedObservable=new k,this.onErrorObservable=new k,this.onStateChangedObservable=new k,this._sound=e}get state(){return this._state}dispose(){super.dispose(),this.stop(),this.onEndedObservable.clear(),this.onStateChangedObservable.clear()}_setState(e){this._state!==e&&(this._state=e,this.onStateChangedObservable.notifyObservers(this))}}class kF extends XI{}class vo extends gF{constructor(e,t,i){super(e,t),this._spatial=null,this._spatialAutoUpdate=!0,this._spatialMinUpdateTime=0,this._stereo=null,typeof i.spatialAutoUpdate=="boolean"&&(this._spatialAutoUpdate=i.spatialAutoUpdate),typeof i.spatialMinUpdateTime=="number"&&(this._spatialMinUpdateTime=i.spatialMinUpdateTime),this._options={autoplay:i.autoplay??!1,duration:i.duration??0,loop:i.loop??!1,loopEnd:i.loopEnd??0,loopStart:i.loopStart??0,maxInstances:i.maxInstances??1/0,pitch:i.pitch??0,playbackRate:i.playbackRate??1,startOffset:i.startOffset??0},this._subGraph=new vo._SubGraph(this)}async _initAsync(e,t){this._audioContext=this.engine._audioContext,e instanceof Uu?this._buffer=e:(typeof e=="string"||Array.isArray(e)||e instanceof ArrayBuffer||e instanceof AudioBuffer)&&(this._buffer=await this.engine.createSoundBufferAsync(e,t)),t.outBus?this.outBus=t.outBus:t.outBusAutoDefault!==!1&&(await this.engine.isReadyPromise,this.outBus=this.engine.defaultMainBus),await this._subGraph.initAsync(t),Ql(t)&&this._initSpatialProperty(),t.autoplay&&this.play(),this.engine._addNode(this)}get buffer(){return this._buffer}get _inNode(){return this._subGraph._inNode}get _outNode(){return this._subGraph._outNode}get spatial(){return this._spatial?this._spatial:this._initSpatialProperty()}get stereo(){return this._stereo??(this._stereo=new Mu(this._subGraph))}async cloneAsync(e=null){const t=await this.engine.createSoundAsync(this.name,e!=null&&e.cloneBuffer?this.buffer.clone():this.buffer,this._options);return t.outBus=e!=null&&e.outBus?e.outBus:this.outBus,t}dispose(){var e;super.dispose(),(e=this._spatial)==null||e.dispose(),this._spatial=null,this._stereo=null,this._subGraph.dispose(),this.engine._removeNode(this)}getClassName(){return"_WebAudioStaticSound"}_createInstance(){return new GF(this,this._options)}_connect(e){var i;return super._connect(e)?(e._inNode&&((i=this._outNode)==null||i.connect(e._inNode)),!0):!1}_disconnect(e){var i;return super._disconnect(e)?(e._inNode&&((i=this._outNode)==null||i.disconnect(e._inNode)),!0):!1}_initSpatialProperty(){return this._spatial||(this._spatial=new Lu(this._subGraph,this._spatialAutoUpdate,this._spatialMinUpdateTime)),this._spatial}}vo._SubGraph=class extends Fu{get _downstreamNodes(){return this._owner._downstreamNodes??null}get _upstreamNodes(){return this._owner._upstreamNodes??null}};class Uu extends vF{constructor(e){super(e)}async _initAsync(e,t){e instanceof AudioBuffer?this._audioBuffer=e:typeof e=="string"?await this._initFromUrlAsync(e):Array.isArray(e)?await this._initFromUrlsAsync(e,t.skipCodecCheck??!1):e instanceof ArrayBuffer&&await this._initFromArrayBufferAsync(e)}get channelCount(){return this._audioBuffer.numberOfChannels}get duration(){return this._audioBuffer.duration}get length(){return this._audioBuffer.length}get sampleRate(){return this._audioBuffer.sampleRate}clone(e=null){const t=new AudioBuffer({length:this._audioBuffer.length,numberOfChannels:this._audioBuffer.numberOfChannels,sampleRate:this._audioBuffer.sampleRate});for(let r=0;r<this._audioBuffer.numberOfChannels;r++)t.copyToChannel(this._audioBuffer.getChannelData(r),r);const i=new Uu(this.engine);return i._audioBuffer=t,i.name=e!=null&&e.name?e.name:this.name,i}async _initFromArrayBufferAsync(e){this._audioBuffer=await this.engine._audioContext.decodeAudioData(e)}async _initFromUrlAsync(e){e=fd(e),await this._initFromArrayBufferAsync(await(await fetch(e)).arrayBuffer())}async _initFromUrlsAsync(e,t){for(const i of e){if(t)await this._initFromUrlAsync(i);else{const r=i.match(XM),n=r==null?void 0:r.at(1);if(n&&this.engine.isFormatValid(n))try{await this._initFromUrlAsync(i)}catch{n&&0<n.length&&this.engine.flagInvalidFormat(n)}}if(this._audioBuffer)break}}}class GF extends kF{constructor(e,t){super(e),this._enginePlayTime=0,this._enginePauseTime=0,this._isConnected=!1,this._pitch=null,this._playbackRate=null,this._sourceNode=null,this._onEnded=()=>{this._enginePlayTime=0,this.onEndedObservable.notifyObservers(this),this._deinitSourceNode()},this._onEngineStateChanged=()=>{this.engine.state==="running"&&(this._options.loop&&this.state===2&&this.play(),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged))},this._options=t,this._volumeNode=new GainNode(e._audioContext),this._initSourceNode()}dispose(){var e,t;super.dispose(),(e=this._pitch)==null||e.dispose(),(t=this._playbackRate)==null||t.dispose(),this._sourceNode=null,this.stop(),this._deinitSourceNode(),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged)}get currentTime(){if(this._state===1)return 0;const e=this._state===5?0:this.engine.currentTime-this._enginePlayTime;return this._enginePauseTime+e+this._options.startOffset}set currentTime(e){const t=this._state===2||this._state===3;t&&(this.stop(),this._deinitSourceNode()),this._options.startOffset=e,t&&this.play()}get _outNode(){return this._volumeNode}set pitch(e){var t;(t=this._pitch)==null||t.setTargetValue(e)}set playbackRate(e){var t;(t=this._playbackRate)==null||t.setTargetValue(e)}get startTime(){return this._state===1?0:this._enginePlayTime}getClassName(){return"_WebAudioStaticSoundInstance"}play(e={}){var i;if(this._state===3)return;e.duration!==void 0&&(this._options.duration=e.duration),e.loop!==void 0&&(this._options.loop=e.loop),e.loopStart!==void 0&&(this._options.loopStart=e.loopStart),e.loopEnd!==void 0&&(this._options.loopEnd=e.loopEnd),e.startOffset!==void 0&&(this._options.startOffset=e.startOffset);let t=this._options.startOffset;this._state===5&&(t+=this.currentTime,t%=this._sound.buffer.duration),this._enginePlayTime=this.engine.currentTime+(e.waitTime??0),this._volumeNode.gain.value=e.volume??1,this._initSourceNode(),this.engine.state==="running"?(this._setState(3),(i=this._sourceNode)==null||i.start(this._enginePlayTime,t,this._options.duration>0?this._options.duration:void 0)):this._options.loop&&(this._setState(2),this.engine.stateChangedObservable.add(this._onEngineStateChanged))}pause(){var e;this._state!==5&&(this._setState(5),this._enginePauseTime+=this.engine.currentTime-this._enginePlayTime,(e=this._sourceNode)==null||e.stop(),this._deinitSourceNode())}resume(){this._state===5&&this.play()}stop(e={}){var i;if(this._state===1)return;this._setState(1);const t=this.engine.currentTime+(e.waitTime??0);(i=this._sourceNode)==null||i.stop(t),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged)}_connect(e){var i;return super._connect(e)?(e instanceof vo&&e._inNode&&((i=this._outNode)==null||i.connect(e._inNode),this._isConnected=!0),!0):!1}_disconnect(e){var i;return super._disconnect(e)?(e instanceof vo&&e._inNode&&((i=this._outNode)==null||i.disconnect(e._inNode),this._isConnected=!1),!0):!1}_deinitSourceNode(){if(this._sourceNode){if(this._isConnected&&!this._disconnect(this._sound))throw new Error("Disconnect failed");this._sourceNode.disconnect(this._volumeNode),this._sourceNode.removeEventListener("ended",this._onEnded),this._sourceNode=null}}_initSourceNode(){if(!this._sourceNode){if(this._sourceNode=new AudioBufferSourceNode(this._sound._audioContext,{buffer:this._sound.buffer._audioBuffer}),this._sourceNode.addEventListener("ended",this._onEnded,{once:!0}),this._sourceNode.connect(this._volumeNode),!this._connect(this._sound))throw new Error("Connect failed");this._pitch=new Ti(this.engine,this._sourceNode.detune),this._playbackRate=new Ti(this.engine,this._sourceNode.playbackRate)}const e=this._sourceNode;e.detune.value=this._sound.pitch,e.loop=this._options.loop,e.loopEnd=this._options.loopEnd,e.loopStart=this._options.loopStart,e.playbackRate.value=this._sound.playbackRate}}const Lg=Object.freeze(Object.defineProperty({__proto__:null,_WebAudioStaticSound:vo,_WebAudioStaticSoundBuffer:Uu},Symbol.toStringTag,{value:"Module"}));class zF extends XI{constructor(e){super(e),this.onReadyObservable=new k,this.preloadedPromise=new Promise((t,i)=>{this._rejectPreloadedProimse=i,this._resolvePreloadedPromise=t}),this.onErrorObservable.add(this._rejectPreloadedProimse),this.onReadyObservable.add(this._resolvePreloadedPromise)}set startOffset(e){this._options.startOffset=e}dispose(){super.dispose(),this.onErrorObservable.clear(),this.onReadyObservable.clear(),this._resolvePreloadedPromise()}}class xo extends xF{constructor(e,t,i){super(e,t),this._spatial=null,this._spatialAutoUpdate=!0,this._spatialMinUpdateTime=0,this._stereo=null,typeof i.spatialAutoUpdate=="boolean"&&(this._spatialAutoUpdate=i.spatialAutoUpdate),typeof i.spatialMinUpdateTime=="number"&&(this._spatialMinUpdateTime=i.spatialMinUpdateTime),this._options={autoplay:i.autoplay??!1,loop:i.loop??!1,maxInstances:i.maxInstances??1/0,preloadCount:i.preloadCount??1,startOffset:i.startOffset??0},this._subGraph=new xo._SubGraph(this)}async _initAsync(e,t){const i=this.engine._audioContext;if(!(i instanceof AudioContext))throw new Error("Unsupported audio context type.");this._audioContext=i,this._source=e,t.outBus?this.outBus=t.outBus:t.outBusAutoDefault!==!1&&(await this.engine.isReadyPromise,this.outBus=this.engine.defaultMainBus),await this._subGraph.initAsync(t),Ql(t)&&this._initSpatialProperty(),this.preloadCount&&await this.preloadInstancesAsync(this.preloadCount),t.autoplay&&this.play(t),this.engine._addNode(this)}get _inNode(){return this._subGraph._inNode}get _outNode(){return this._subGraph._outNode}get spatial(){return this._spatial?this._spatial:this._initSpatialProperty()}get stereo(){return this._stereo??(this._stereo=new Mu(this._subGraph))}dispose(){super.dispose(),this._spatial=null,this._stereo=null,this._subGraph.dispose(),this.engine._removeNode(this)}getClassName(){return"_WebAudioStreamingSound"}_createInstance(){return new WF(this,this._options)}_connect(e){var i;return super._connect(e)?(e._inNode&&((i=this._outNode)==null||i.connect(e._inNode)),!0):!1}_disconnect(e){var i;return super._disconnect(e)?(e._inNode&&((i=this._outNode)==null||i.disconnect(e._inNode)),!0):!1}_initSpatialProperty(){return this._spatial||(this._spatial=new Lu(this._subGraph,this._spatialAutoUpdate,this._spatialMinUpdateTime)),this._spatial}}xo._SubGraph=class extends Fu{get _downstreamNodes(){return this._owner._downstreamNodes??null}get _upstreamNodes(){return this._owner._upstreamNodes??null}};class WF extends zF{constructor(e,t){super(e),this._currentTimeChangedWhilePaused=!1,this._enginePlayTime=1/0,this._enginePauseTime=0,this._isReady=!1,this._isReadyPromise=new Promise((i,r)=>{this._resolveIsReadyPromise=i,this._rejectIsReadyPromise=r}),this._onCanPlayThrough=()=>{this._isReady=!0,this._resolveIsReadyPromise(this._mediaElement),this.onReadyObservable.notifyObservers(this)},this._onEnded=()=>{this.onEndedObservable.notifyObservers(this),this.dispose()},this._onError=i=>{this._setState(4),this.onErrorObservable.notifyObservers(i),this._rejectIsReadyPromise(i),this.dispose()},this._onEngineStateChanged=()=>{this.engine.state==="running"&&(this._options.loop&&this.state===2&&this.play(),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged))},this._onUserGesture=()=>{this.play()},this._options=t,this._volumeNode=new GainNode(e._audioContext),typeof e._source=="string"?this._initFromUrl(e._source):Array.isArray(e._source)?this._initFromUrls(e._source):e._source instanceof HTMLMediaElement&&this._initFromMediaElement(e._source)}get currentTime(){if(this._state===1)return 0;const e=this._state===5?0:this.engine.currentTime-this._enginePlayTime;return this._enginePauseTime+e+this._options.startOffset}set currentTime(e){const t=this._state===2||this._state===3;t&&(this._mediaElement.pause(),this._setState(1)),this._options.startOffset=e,t?this.play({startOffset:e}):this._state===5&&(this._currentTimeChangedWhilePaused=!0)}get _outNode(){return this._volumeNode}get startTime(){return this._state===1?0:this._enginePlayTime}dispose(){var e;super.dispose(),this.stop(),(e=this._sourceNode)==null||e.disconnect(this._volumeNode),this._sourceNode=null,this._mediaElement.removeEventListener("error",this._onError),this._mediaElement.removeEventListener("ended",this._onEnded),this._mediaElement.removeEventListener("canplaythrough",this._onCanPlayThrough);for(const t of Array.from(this._mediaElement.children))this._mediaElement.removeChild(t);this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged),this.engine.userGestureObservable.removeCallback(this._onUserGesture)}play(e={}){if(this._state===3)return;e.loop!==void 0&&(this._options.loop=e.loop),this._mediaElement.loop=this._options.loop;let t=e.startOffset;this._currentTimeChangedWhilePaused?(t=this._options.startOffset,this._currentTimeChangedWhilePaused=!1):this._state===5&&(t=this.currentTime+this._options.startOffset),t&&t>0&&(this._mediaElement.currentTime=t),this._volumeNode.gain.value=e.volume??1,this._play()}pause(){this._state!==2&&this._state!==3||(this._setState(5),this._enginePauseTime+=this.engine.currentTime-this._enginePlayTime,this._mediaElement.pause())}resume(){this._state===5?this.play():this._currentTimeChangedWhilePaused&&this.play()}stop(){this._state!==1&&this._stop()}getClassName(){return"_WebAudioStreamingSoundInstance"}_connect(e){var i;return super._connect(e)?(e instanceof xo&&e._inNode&&((i=this._outNode)==null||i.connect(e._inNode)),!0):!1}_disconnect(e){var i;return super._disconnect(e)?(e instanceof xo&&e._inNode&&((i=this._outNode)==null||i.disconnect(e._inNode)),!0):!1}_initFromMediaElement(e){if(j.SetCorsBehavior(e.currentSrc,e),e.controls=!1,e.loop=this._options.loop,e.preload="auto",e.addEventListener("canplaythrough",this._onCanPlayThrough,{once:!0}),e.addEventListener("ended",this._onEnded,{once:!0}),e.addEventListener("error",this._onError,{once:!0}),e.load(),this._sourceNode=new MediaElementAudioSourceNode(this._sound._audioContext,{mediaElement:e}),this._sourceNode.connect(this._volumeNode),!this._connect(this._sound))throw new Error("Connect failed");this._mediaElement=e}_initFromUrl(e){const t=new Audio(fd(e));this._initFromMediaElement(t)}_initFromUrls(e){const t=new Audio;for(const i of e){const r=document.createElement("source");r.src=fd(i),t.appendChild(r)}this._initFromMediaElement(t)}_play(){if(this._setState(2),!this._isReady){this._playWhenReady();return}if(this._state===2)if(this.engine.state==="running"){const e=this._mediaElement.play();this._enginePlayTime=this.engine.currentTime,this._setState(3),e.catch(()=>{this._setState(4),this._options.loop&&this.engine.userGestureObservable.addOnce(this._onUserGesture)})}else this._options.loop?this.engine.stateChangedObservable.add(this._onEngineStateChanged):(this.stop(),this._setState(4))}_playWhenReady(){this._isReadyPromise.then(()=>{this._play()}).catch(()=>{N.Error("Streaming sound instance failed to play"),this._setState(4)})}_stop(){this._mediaElement.pause(),this._setState(1),this._onEnded(),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged)}}const HF=Object.freeze(Object.defineProperty({__proto__:null,_WebAudioStreamingSound:xo},Symbol.toStringTag,{value:"Module"}));class Go{constructor(e){this._texture=null,this._isEnabled=!0,this.isEnabled=!0,this.time=0,e=e||De.LastCreatedScene,e&&(this._scene=e,this.animationParameters=new Ee(0,0,0,30))}_markSubMeshesAsAttributesDirty(){for(const e of this._scene.meshes)e.bakedVertexAnimationManager===this&&e._markSubMeshesAsAttributesDirty()}bind(e,t=!1){if(!this._texture||!this._isEnabled)return;const i=this._texture.getSize();e.setFloat2("bakedVertexAnimationTextureSizeInverted",1/i.width,1/i.height),e.setFloat("bakedVertexAnimationTime",this.time),t||e.setVector4("bakedVertexAnimationSettings",this.animationParameters),e.setTexture("bakedVertexAnimationTexture",this._texture)}clone(){const e=new Go(this._scene);return this.copyTo(e),e}setAnimationParameters(e,t,i=0,r=30){this.animationParameters=new Ee(e,t,i,r)}dispose(e){var t;e&&((t=this._texture)==null||t.dispose())}getClassName(){return"BakedVertexAnimationManager"}copyTo(e){me.Clone(()=>e,this)}serialize(){return me.Serialize(this)}parse(e,t,i){me.Parse(()=>this,e,t,i)}}_([We(),W("_markSubMeshesAsAttributesDirty")],Go.prototype,"texture",void 0);_([R(),W("_markSubMeshesAsAttributesDirty")],Go.prototype,"isEnabled",void 0);_([R()],Go.prototype,"animationParameters",void 0);_([R()],Go.prototype,"time",void 0);class Ll{get useTextureToStoreBoneMatrices(){return this._useTextureToStoreBoneMatrices}set useTextureToStoreBoneMatrices(e){this._useTextureToStoreBoneMatrices=e,this._markAsDirty()}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}get isUsingTextureForMatrices(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones}get uniqueId(){return this._uniqueId}constructor(e,t,i){this.name=e,this.id=t,this.bones=[],this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=z.Identity(),this._currentRenderId=-1,this._ranges={},this._absoluteTransformIsDirty=!0,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new k,this.metadata=null,this.bones=[],this._scene=i||De.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;const r=this._scene.getEngine().getCaps();this._canUseTextureForBones=r.textureFloat&&r.maxVertexTextureImageUnits>0}getClassName(){return"Skeleton"}getChildren(){return this.bones.filter(e=>!e.getParent())}getTransformMatrices(e){if(this.needInitialSkinMatrix){if(!e)throw new Error("getTransformMatrices: When using the needInitialSkinMatrix flag, a mesh must be provided");return e._bonesTransformMatrices||this.prepare(!0),e._bonesTransformMatrices}return(!this._transformMatrices||this._isDirty)&&this.prepare(!this._transformMatrices),this._transformMatrices}getTransformMatrixTexture(e){return this.needInitialSkinMatrix&&e._transformMatrixTexture?e._transformMatrixTexture:this._transformMatrixTexture}getScene(){return this._scene}toString(e){let t=`Name: ${this.name}, nBones: ${this.bones.length}`;if(t+=`, nAnimationRanges: ${this._ranges?Object.keys(this._ranges).length:"none"}`,e){t+=", Ranges: {";let i=!0;for(const r in this._ranges)i&&(t+=", ",i=!1),t+=r;t+="}"}return t}getBoneIndexByName(e){for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].name===e)return t;return-1}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=new dg(e,t,i);for(let r=0,n=this.bones.length;r<n;r++)this.bones[r].animations[0]&&this.bones[r].animations[0].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,r=this.bones.length;i<r;i++)this.bones[i].animations[0]&&this.bones[i].animations[0].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}copyAnimationRange(e,t,i=!1){if(this._ranges[t]||!e.getAnimationRange(t))return!1;let r=!0;const n=this._getHighestAnimationFrame()+1,a={},o=e.bones;let l,c;for(c=0,l=o.length;c<l;c++)a[o[c].name]=o[c];this.bones.length!==o.length&&(N.Warn(`copyAnimationRange: this rig has ${this.bones.length} bones, while source as ${o.length}`),r=!1);const u=i&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(c=0,l=this.bones.length;c<l;c++){const d=this.bones[c].name,f=a[d];f?r=r&&this.bones[c].copyAnimationRange(f,t,n,i,u):(N.Warn("copyAnimationRange: not same rig, missing source bone "+d),r=!1)}const h=e.getAnimationRange(t);return h&&(this._ranges[t]=new dg(t,h.from+n,h.to+n)),r}returnToRest(){for(const e of this.bones)e._index!==-1&&e.returnToRest()}_getHighestAnimationFrame(){let e=0;for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].animations[0]){const r=this.bones[t].animations[0].getHighestFrame();e<r&&(e=r)}return e}beginAnimation(e,t,i,r){const n=this.getAnimationRange(e);return n?this._scene.beginAnimation(this,n.from,n.to,t,i,r):null}static MakeAnimationAdditive(e,t=0,i){const r=e.getAnimationRange(i);if(!r)return null;const n=e._scene.getAllAnimatablesByTarget(e);let a=null;for(let l=0;l<n.length;l++){const c=n[l];if(c.fromFrame===(r==null?void 0:r.from)&&c.toFrame===(r==null?void 0:r.to)){a=c;break}}const o=e.getAnimatables();for(let l=0;l<o.length;l++){const u=o[l].animations;if(u)for(let h=0;h<u.length;h++)pe.MakeAnimationAdditive(u[h],t,i)}return a&&(a.isAdditive=!0),e}_markAsDirty(){this._isDirty=!0,this._absoluteTransformIsDirty=!0}_registerMeshWithPoseMatrix(e){this._meshesWithPoseMatrix.push(e)}_unregisterMeshWithPoseMatrix(e){const t=this._meshesWithPoseMatrix.indexOf(e);t>-1&&this._meshesWithPoseMatrix.splice(t,1)}_computeTransformMatrices(e,t){this.onBeforeComputeObservable.notifyObservers(this);for(let i=0;i<this.bones.length;i++){const r=this.bones[i];r._childUpdateId++;const n=r.getParent();if(n?r.getLocalMatrix().multiplyToRef(n.getFinalMatrix(),r.getFinalMatrix()):t?r.getLocalMatrix().multiplyToRef(t,r.getFinalMatrix()):r.getFinalMatrix().copyFrom(r.getLocalMatrix()),r._index!==-1){const a=r._index===null?i:r._index;r.getAbsoluteInverseBindMatrix().multiplyToArray(r.getFinalMatrix(),e,a*16)}}this._identity.copyToArray(e,this.bones.length*16)}prepare(e=!1){if(!e){const t=this.getScene().getRenderId();if(this._currentRenderId===t)return;this._currentRenderId=t}if(this._numBonesWithLinkedTransformNode>0){for(const t of this.bones)if(t._linkedTransformNode){const i=t._linkedTransformNode;t.position=i.position,i.rotationQuaternion?t.rotationQuaternion=i.rotationQuaternion:t.rotation=i.rotation,t.scaling=i.scaling}}if(this.needInitialSkinMatrix)for(const t of this._meshesWithPoseMatrix){const i=t.getPoseMatrix();let r=this._isDirty;if((!t._bonesTransformMatrices||t._bonesTransformMatrices.length!==16*(this.bones.length+1))&&(t._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),r=!0),!!r){if(this._synchronizedWithMesh!==t){this._synchronizedWithMesh=t;for(const n of this.bones)n.getParent()||(n.getBindMatrix().multiplyToRef(i,G.Matrix[1]),n._updateAbsoluteBindMatrices(G.Matrix[1]));if(this.isUsingTextureForMatrices){const n=(this.bones.length+1)*4;(!t._transformMatrixTexture||t._transformMatrixTexture.getSize().width!==n)&&(t._transformMatrixTexture&&t._transformMatrixTexture.dispose(),t._transformMatrixTexture=gi.CreateRGBATexture(t._bonesTransformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(t._bonesTransformMatrices,i),this.isUsingTextureForMatrices&&t._transformMatrixTexture&&t._transformMatrixTexture.update(t._bonesTransformMatrices)}}else{if(!this._isDirty)return;(!this._transformMatrices||this._transformMatrices.length!==16*(this.bones.length+1))&&(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=gi.CreateRGBATexture(this._transformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices)}this._isDirty=!1}getAnimatables(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(let e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables}clone(e,t){const i=new Ll(e,t||e,this._scene);i.needInitialSkinMatrix=this.needInitialSkinMatrix,i.metadata=this.metadata;for(let r=0;r<this.bones.length;r++){const n=this.bones[r];let a=null;const o=n.getParent();if(o){const c=this.bones.indexOf(o);a=i.bones[c]}const l=new Ct(n.name,i,a,n.getBindMatrix().clone(),n.getRestMatrix().clone());l._index=n._index,n._linkedTransformNode&&l.linkTransformNode(n._linkedTransformNode),Ea.DeepCopy(n.animations,l.animations)}if(this._ranges){i._ranges={};for(const r in this._ranges){const n=this._ranges[r];n&&(i._ranges[r]=n.clone())}}return this._isDirty=!0,i.prepare(!0),i}enableBlending(e=.01){for(const t of this.bones)for(const i of t.animations)i.enableBlending=!0,i.blendingSpeed=e}dispose(){if(this._meshesWithPoseMatrix.length=0,this.metadata=null,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){const e=this._parentContainer.skeletons.indexOf(this);e>-1&&this._parentContainer.skeletons.splice(e,1),this._parentContainer=null}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)}serialize(){var t;const e={};e.name=this.name,e.id=this.id,this.dimensionsAtRest&&(e.dimensionsAtRest=this.dimensionsAtRest.asArray()),e.bones=[],e.needInitialSkinMatrix=this.needInitialSkinMatrix,this.metadata&&(e.metadata=this.metadata);for(let i=0;i<this.bones.length;i++){const r=this.bones[i],n=r.getParent(),a={parentBoneIndex:n?this.bones.indexOf(n):-1,index:r.getIndex(),name:r.name,id:r.id,matrix:r.getBindMatrix().asArray(),rest:r.getRestMatrix().asArray(),linkedTransformNodeId:(t=r.getTransformNode())==null?void 0:t.id};e.bones.push(a),r.length&&(a.length=r.length),r.metadata&&(a.metadata=r.metadata),r.animations&&r.animations.length>0&&(a.animation=r.animations[0].serialize()),e.ranges=[];for(const o in this._ranges){const l=this._ranges[o];if(!l)continue;const c={};c.name=o,c.from=l.from,c.to=l.to,e.ranges.push(c)}}return e}static Parse(e,t){const i=new Ll(e.name,e.id,t);e.dimensionsAtRest&&(i.dimensionsAtRest=x.FromArray(e.dimensionsAtRest)),i.needInitialSkinMatrix=e.needInitialSkinMatrix,e.metadata&&(i.metadata=e.metadata);let r;for(r=0;r<e.bones.length;r++){const n=e.bones[r],a=e.bones[r].index;let o=null;n.parentBoneIndex>-1&&(o=i.bones[n.parentBoneIndex]);const l=n.rest?z.FromArray(n.rest):null,c=new Ct(n.name,i,o,z.FromArray(n.matrix),l,null,a);n.id!==void 0&&n.id!==null&&(c.id=n.id),n.length&&(c.length=n.length),n.metadata&&(c.metadata=n.metadata),n.animation&&c.animations.push(pe.Parse(n.animation)),n.linkedTransformNodeId!==void 0&&n.linkedTransformNodeId!==null&&(i._hasWaitingData=!0,c._waitingTransformNodeId=n.linkedTransformNodeId)}if(e.ranges)for(r=0;r<e.ranges.length;r++){const n=e.ranges[r];i.createAnimationRange(n.name,n.from,n.to)}return i}computeAbsoluteMatrices(e=!1){(this._absoluteTransformIsDirty||e)&&(this.bones[0].computeAbsoluteMatrices(),this._absoluteTransformIsDirty=!1)}computeAbsoluteTransforms(e=!1){this.computeAbsoluteMatrices(e)}getPoseMatrix(){let e=null;return this._meshesWithPoseMatrix.length>0&&(e=this._meshesWithPoseMatrix[0].getPoseMatrix()),e}sortBones(){const e=[],t=new Array(this.bones.length);for(let i=0;i<this.bones.length;i++)this._sortBones(i,e,t);this.bones=e}_sortBones(e,t,i){if(i[e])return;i[e]=!0;const r=this.bones[e];if(!r)return;r._index===void 0&&(r._index=e);const n=r.getParent();n&&this._sortBones(this.bones.indexOf(n),t,i),t.push(r)}setCurrentPoseAsRest(){for(const e of this.bones)e.setCurrentPoseAsRest()}}class xe{constructor(e,t,i=Number.MAX_VALUE,r=Ai){this.origin=e,this.direction=t,this.length=i,this.epsilon=r}clone(){return new xe(this.origin.clone(),this.direction.clone(),this.length)}intersectsBoxMinMax(e,t,i=0){const r=xe._TmpVector3[0].copyFromFloats(e.x-i,e.y-i,e.z-i),n=xe._TmpVector3[1].copyFromFloats(t.x+i,t.y+i,t.z+i);let a=0,o=Number.MAX_VALUE,l,c,u,h;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<r.x||this.origin.x>n.x)return!1}else if(l=1/this.direction.x,c=(r.x-this.origin.x)*l,u=(n.x-this.origin.x)*l,u===-1/0&&(u=1/0),c>u&&(h=c,c=u,u=h),a=Math.max(c,a),o=Math.min(u,o),a>o)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<r.y||this.origin.y>n.y)return!1}else if(l=1/this.direction.y,c=(r.y-this.origin.y)*l,u=(n.y-this.origin.y)*l,u===-1/0&&(u=1/0),c>u&&(h=c,c=u,u=h),a=Math.max(c,a),o=Math.min(u,o),a>o)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<r.z||this.origin.z>n.z)return!1}else if(l=1/this.direction.z,c=(r.z-this.origin.z)*l,u=(n.z-this.origin.z)*l,u===-1/0&&(u=1/0),c>u&&(h=c,c=u,u=h),a=Math.max(c,a),o=Math.min(u,o),a>o)return!1;return!0}intersectsBox(e,t=0){return this.intersectsBoxMinMax(e.minimum,e.maximum,t)}intersectsSphere(e,t=0){const i=e.center.x-this.origin.x,r=e.center.y-this.origin.y,n=e.center.z-this.origin.z,a=i*i+r*r+n*n,o=e.radius+t,l=o*o;if(a<=l)return!0;const c=i*this.direction.x+r*this.direction.y+n*this.direction.z;return c<0?!1:a-c*c<=l}intersectsTriangle(e,t,i){const r=xe._TmpVector3[0],n=xe._TmpVector3[1],a=xe._TmpVector3[2],o=xe._TmpVector3[3],l=xe._TmpVector3[4];t.subtractToRef(e,r),i.subtractToRef(e,n),x.CrossToRef(this.direction,n,a);const c=x.Dot(r,a);if(c===0)return null;const u=1/c;this.origin.subtractToRef(e,o);const h=x.Dot(o,a)*u;if(h<-this.epsilon||h>1+this.epsilon)return null;x.CrossToRef(o,r,l);const d=x.Dot(this.direction,l)*u;if(d<-this.epsilon||h+d>1+this.epsilon)return null;const f=x.Dot(n,l)*u;return f>this.length?null:new WN(1-h-d,h,f)}intersectsPlane(e){let t;const i=x.Dot(e.normal,this.direction);if(Math.abs(i)<999999997475243e-21)return null;{const r=x.Dot(e.normal,this.origin);return t=(-e.d-r)/i,t<0?t<-999999997475243e-21?null:0:t}}intersectsAxis(e,t=0){switch(e){case"y":{const i=(this.origin.y-t)/this.direction.y;return i>0?null:new x(this.origin.x+this.direction.x*-i,t,this.origin.z+this.direction.z*-i)}case"x":{const i=(this.origin.x-t)/this.direction.x;return i>0?null:new x(t,this.origin.y+this.direction.y*-i,this.origin.z+this.direction.z*-i)}case"z":{const i=(this.origin.z-t)/this.direction.z;return i>0?null:new x(this.origin.x+this.direction.x*-i,this.origin.y+this.direction.y*-i,t)}default:return null}}intersectsMesh(e,t,i,r=!1,n,a=!1){const o=G.Matrix[0];return e.getWorldMatrix().invertToRef(o),this._tmpRay?xe.TransformToRef(this,o,this._tmpRay):this._tmpRay=xe.Transform(this,o),e.intersects(this._tmpRay,t,i,r,n,a)}intersectsMeshes(e,t,i){i?i.length=0:i=[];for(let r=0;r<e.length;r++){const n=this.intersectsMesh(e[r],t);n.hit&&i.push(n)}return i.sort(this._comparePickingInfo),i}_comparePickingInfo(e,t){return e.distance<t.distance?-1:e.distance>t.distance?1:0}intersectionSegment(e,t,i){const r=this.origin,n=G.Vector3[0],a=G.Vector3[1],o=G.Vector3[2],l=G.Vector3[3];t.subtractToRef(e,n),this.direction.scaleToRef(xe._Rayl,o),r.addToRef(o,a),e.subtractToRef(r,l);const c=x.Dot(n,n),u=x.Dot(n,o),h=x.Dot(o,o),d=x.Dot(n,l),f=x.Dot(o,l),m=c*h-u*u;let g,v=m,E,T=m;m<xe._Smallnum?(g=0,v=1,E=f,T=h):(g=u*f-h*d,E=c*f-u*d,g<0?(g=0,E=f,T=h):g>v&&(g=v,E=f+u,T=h)),E<0?(E=0,-d<0?g=0:-d>c?g=v:(g=-d,v=c)):E>T&&(E=T,-d+u<0?g=0:-d+u>c?g=v:(g=-d+u,v=c));const C=Math.abs(g)<xe._Smallnum?0:g/v,A=Math.abs(E)<xe._Smallnum?0:E/T,I=G.Vector3[4];o.scaleToRef(A,I);const F=G.Vector3[5];n.scaleToRef(C,F),F.addInPlace(l);const V=G.Vector3[6];return F.subtractToRef(I,V),A>0&&A<=this.length&&V.lengthSquared()<i*i?F.length():-1}update(e,t,i,r,n,a,o,l=!1){if(l){xe._RayDistant||(xe._RayDistant=xe.Zero()),xe._RayDistant.unprojectRayToRef(e,t,i,r,z.IdentityReadOnly,a,o);const c=G.Matrix[0];n.invertToRef(c),xe.TransformToRef(xe._RayDistant,c,this)}else this.unprojectRayToRef(e,t,i,r,n,a,o);return this}static Zero(){return new xe(x.Zero(),x.Zero())}static CreateNew(e,t,i,r,n,a,o){return xe.Zero().update(e,t,i,r,n,a,o)}static CreateNewFromTo(e,t,i=z.IdentityReadOnly){const r=new xe(new x(0,0,0),new x(0,0,0));return xe.CreateFromToToRef(e,t,r,i)}static CreateFromToToRef(e,t,i,r=z.IdentityReadOnly){i.origin.copyFrom(e);const n=t.subtractToRef(e,i.direction),a=Math.sqrt(n.x*n.x+n.y*n.y+n.z*n.z);return i.length=a,i.direction.normalize(),xe.TransformToRef(i,r,i)}static Transform(e,t){const i=new xe(new x(0,0,0),new x(0,0,0));return xe.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){x.TransformCoordinatesToRef(e.origin,t,i.origin),x.TransformNormalToRef(e.direction,t,i.direction),i.length=e.length,i.epsilon=e.epsilon;const r=i.direction,n=r.length();if(!(n===0||n===1)){const a=1/n;r.x*=a,r.y*=a,r.z*=a,i.length*=n}return i}unprojectRayToRef(e,t,i,r,n,a,o){const l=G.Matrix[0];n.multiplyToRef(a,l),l.multiplyToRef(o,l),l.invert();const c=De.LastCreatedEngine,u=G.Vector3[0];u.x=e/i*2-1,u.y=-(t/r*2-1),u.z=c!=null&&c.useReverseDepthBuffer?1:c!=null&&c.isNDCHalfZRange?0:-1;const h=G.Vector3[1].copyFromFloats(u.x,u.y,1-1e-8),d=G.Vector3[2],f=G.Vector3[3];x.TransformCoordinatesToRef(u,l,d),x.TransformCoordinatesToRef(h,l,f),this.origin.copyFrom(d),f.subtractToRef(d,this.direction),this.direction.normalize()}}xe._TmpVector3=Fo(6,x.Zero);xe._RayDistant=xe.Zero();xe._Smallnum=1e-8;xe._Rayl=1e9;function ku(s,e,t,i,r,n=!1){const a=xe.Zero();return Gu(s,e,t,i,a,r,n),a}function Gu(s,e,t,i,r,n,a=!1,o=!1){const l=s.getEngine();if(!n&&!(n=s.activeCamera))return s;const c=n.viewport,u=l.getRenderHeight(),{x:h,y:d,width:f,height:m}=c.toGlobal(l.getRenderWidth(),u),g=1/l.getHardwareScalingLevel();return e=e*g-h,t=t*g-(u-d-m),r.update(e,t,f,m,i||z.IdentityReadOnly,a?z.IdentityReadOnly:n.getViewMatrix(),n.getProjectionMatrix(),o),s}function YI(s,e,t,i){const r=xe.Zero();return zu(s,e,t,r,i),r}function zu(s,e,t,i,r){if(!Li)return s;const n=s.getEngine();if(!r&&!(r=s.activeCamera))throw new Error("Active camera not set");const a=r.viewport,o=n.getRenderHeight(),{x:l,y:c,width:u,height:h}=a.toGlobal(n.getRenderWidth(),o),d=z.Identity(),f=1/n.getHardwareScalingLevel();return e=e*f-l,t=t*f-(o-c-h),i.update(e,t,u,h,d,d,r.getProjectionMatrix()),s}function jI(s,e,t,i,r,n,a,o){const l=e(i,t.enableDistantPicking),c=t.intersects(l,r,a,n,i,o);return!c||!c.hit||!r&&s!=null&&c.distance>=s.distance?null:c}function t_(s,e,t,i,r,n){let a=null;const o=!!(s.activeCameras&&s.activeCameras.length>1&&s.cameraToUseForPointers!==s.activeCamera),l=s.cameraToUseForPointers||s.activeCamera,c=jI;for(let u=0;u<s.meshes.length;u++){const h=s.meshes[u];if(t){if(!t(h,-1))continue}else if(!h.isEnabled()||!h.isVisible||!h.isPickable)continue;const d=o&&h.isWorldMatrixCameraDependent(),f=h.computeWorldMatrix(d,l);if(h.hasThinInstances&&h.thinInstanceEnablePicking){const m=c(a,e,h,f,!0,!0,n);if(m){if(r)return m;const g=G.Matrix[1],v=h.thinInstanceGetWorldMatrices();for(let E=0;E<v.length;E++){if(t&&!t(h,E))continue;v[E].multiplyToRef(f,g);const C=c(a,e,h,g,i,r,n,!0);if(C&&(a=C,a.thinInstanceIndex=E,i))return a}}}else{const m=c(a,e,h,f,i,r,n);if(m&&(a=m,i))return a}}return a||new Li}function qI(s,e,t,i){if(!Li)return null;const r=[],n=!!(s.activeCameras&&s.activeCameras.length>1&&s.cameraToUseForPointers!==s.activeCamera),a=s.cameraToUseForPointers||s.activeCamera,o=jI;for(let l=0;l<s.meshes.length;l++){const c=s.meshes[l];if(t){if(!t(c,-1))continue}else if(!c.isEnabled()||!c.isVisible||!c.isPickable)continue;const u=n&&c.isWorldMatrixCameraDependent(),h=c.computeWorldMatrix(u,a);if(c.hasThinInstances&&c.thinInstanceEnablePicking){if(o(null,e,c,h,!0,!0,i)){const f=G.Matrix[1],m=c.thinInstanceGetWorldMatrices();for(let g=0;g<m.length;g++){if(t&&!t(c,g))continue;m[g].multiplyToRef(h,f);const E=o(null,e,c,f,!1,!1,i,!0);E&&(E.thinInstanceIndex=g,r.push(E))}}}else{const d=o(null,e,c,h,!1,!1,i);d&&r.push(d)}}return r}function $F(s,e,t,i,r,n){if(!Li)return null;const a=t_(s,o=>(s._tempPickingRay||(s._tempPickingRay=xe.Zero()),Gu(s,e,t,o,s._tempPickingRay,n||null),s._tempPickingRay),i,r,!0);return a&&(a.ray=ku(s,e,t,z.Identity(),n||null)),a}function XF(s,e,t,i,r,n,a,o=!1){const l=t_(s,(c,u)=>(s._tempPickingRay||(s._tempPickingRay=xe.Zero()),Gu(s,e,t,c,s._tempPickingRay,n||null,!1,u),s._tempPickingRay),i,r,!1,a);return l&&(l.ray=ku(s,e,t,z.Identity(),n||null)),l}function YF(s,e,t,i,r){const n=t_(s,a=>(s._pickWithRayInverseMatrix||(s._pickWithRayInverseMatrix=z.Identity()),a.invertToRef(s._pickWithRayInverseMatrix),s._cachedRayForTransform||(s._cachedRayForTransform=xe.Zero()),xe.TransformToRef(e,s._pickWithRayInverseMatrix,s._cachedRayForTransform),s._cachedRayForTransform),t,i,!1,r);return n&&(n.ray=e),n}function jF(s,e,t,i,r,n){return qI(s,a=>ku(s,e,t,a,r||null),i,n)}function qF(s,e,t,i){return qI(s,r=>(s._pickWithRayInverseMatrix||(s._pickWithRayInverseMatrix=z.Identity()),r.invertToRef(s._pickWithRayInverseMatrix),s._cachedRayForTransform||(s._cachedRayForTransform=xe.Zero()),xe.TransformToRef(e,s._pickWithRayInverseMatrix,s._cachedRayForTransform),s._cachedRayForTransform),t,i)}function wg(s,e,t=100,i,r){i||(i=s.getWorldMatrix()),e.length=t,r?e.origin.copyFrom(r):e.origin.copyFrom(s.position);const n=G.Vector3[2];n.set(0,0,s._scene.useRightHandedSystem?-1:1);const a=G.Vector3[3];return x.TransformNormalToRef(n,i,a),x.NormalizeToRef(a,e.direction),e}function ZF(s,e){e&&(e.prototype.getForwardRay=function(t=100,i,r){return wg(this,new xe(x.Zero(),x.Zero(),t),t,i,r)},e.prototype.getForwardRayToRef=function(t,i=100,r,n){return wg(this,t,i,r,n)}),s&&(HN._IsPickingAvailable=!0,s.prototype.createPickingRay=function(t,i,r,n,a=!1){return ku(this,t,i,r,n,a)})}ZF(le,dt);le.prototype.createPickingRayToRef=function(s,e,t,i,r,n=!1,a=!1){return Gu(this,s,e,t,i,r,n,a)};le.prototype.createPickingRayInCameraSpace=function(s,e,t){return YI(this,s,e,t)};le.prototype.createPickingRayInCameraSpaceToRef=function(s,e,t,i){return zu(this,s,e,t,i)};le.prototype.pickWithBoundingInfo=function(s,e,t,i,r){return $F(this,s,e,t,i,r)};le.prototype.pick=function(s,e,t,i,r,n,a=!1){return XF(this,s,e,t,i,r,n,a)};le.prototype.pickWithRay=function(s,e,t,i){return YF(this,s,e,t,i)};le.prototype.multiPick=function(s,e,t,i,r){return jF(this,s,e,t,i,r)};le.prototype.multiPickWithRay=function(s,e,t){return qF(this,s,e,t)};class Ne{}Ne.ANCHOR_SYSTEM="xr-anchor-system";Ne.BACKGROUND_REMOVER="xr-background-remover";Ne.HIT_TEST="xr-hit-test";Ne.MESH_DETECTION="xr-mesh-detection";Ne.PHYSICS_CONTROLLERS="xr-physics-controller";Ne.PLANE_DETECTION="xr-plane-detection";Ne.POINTER_SELECTION="xr-controller-pointer-selection";Ne.TELEPORTATION="xr-controller-teleportation";Ne.FEATURE_POINTS="xr-feature-points";Ne.HAND_TRACKING="xr-hand-tracking";Ne.IMAGE_TRACKING="xr-image-tracking";Ne.NEAR_INTERACTION="xr-near-interaction";Ne.DOM_OVERLAY="xr-dom-overlay";Ne.MOVEMENT="xr-controller-movement";Ne.LIGHT_ESTIMATION="xr-light-estimation";Ne.EYE_TRACKING="xr-eye-tracking";Ne.WALKING_LOCOMOTION="xr-walking-locomotion";Ne.LAYERS="xr-layers";Ne.DEPTH_SENSING="xr-depth-sensing";Ne.SPACE_WARP="xr-space-warp";Ne.RAW_CAMERA_ACCESS="xr-raw-camera-access";class At{constructor(e){this._xrSessionManager=e,this._features={},this._xrSessionManager.onXRSessionInit.add(()=>{const t=this.getEnabledFeatures();for(const i of t){const r=this._features[i];r.enabled&&!r.featureImplementation.attached&&!r.featureImplementation.disableAutoAttach&&this.attachFeature(i)}}),this._xrSessionManager.onXRSessionEnded.add(()=>{const t=this.getEnabledFeatures();for(const i of t){const r=this._features[i];r.enabled&&r.featureImplementation.attached&&this.detachFeature(i)}})}static AddWebXRFeature(e,t,i=1,r=!1){this._AvailableFeatures[e]=this._AvailableFeatures[e]||{latest:i},i>this._AvailableFeatures[e].latest&&(this._AvailableFeatures[e].latest=i),r&&(this._AvailableFeatures[e].stable=i),this._AvailableFeatures[e][i]=t}static ConstructFeature(e,t=1,i,r){const n=this._AvailableFeatures[e][t];if(!n)throw new Error("feature not found");return n(i,r)}static GetAvailableFeatures(){return Object.keys(this._AvailableFeatures)}static GetAvailableVersions(e){return Object.keys(this._AvailableFeatures[e])}static GetLatestVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].latest||-1}static GetStableVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].stable||-1}attachFeature(e){const t=this._features[e];t&&t.enabled&&!t.featureImplementation.attached&&(t.featureImplementation.attach()||j.Warn(`Feature ${e} failed to attach`))}detachFeature(e){const t=this._features[e];t&&t.featureImplementation.attached&&(t.featureImplementation.detach()||j.Warn(`Feature ${e} failed to detach`))}disableFeature(e){const t=typeof e=="string"?e:e.Name,i=this._features[t];return i&&i.enabled?(i.enabled=!1,this.detachFeature(t),i.featureImplementation.dispose(),delete this._features[t],!0):!1}dispose(){const e=this.getEnabledFeatures();for(const t of e)this.disableFeature(t)}enableFeature(e,t="latest",i={},r=!0,n=!0){const a=typeof e=="string"?e:e.Name;let o=0;if(typeof t=="string"){if(!t)throw new Error(`Error in provided version - ${a} (${t})`);if(t==="stable"?o=At.GetStableVersionOfFeature(a):t==="latest"?o=At.GetLatestVersionOfFeature(a):o=+t,o===-1||isNaN(o))throw new Error(`feature not found - ${a} (${t})`)}else o=t;const l=At._ConflictingFeatures[a];if(l!==void 0&&this.getEnabledFeatures().indexOf(l)!==-1)throw new Error(`Feature ${a} cannot be enabled while ${l} is enabled.`);const c=this._features[a],u=At.ConstructFeature(a,o,this._xrSessionManager,i);if(!u)throw new Error(`feature not found - ${a}`);c&&this.disableFeature(a);const h=u();if(h.dependsOn&&!h.dependsOn.every(f=>!!this._features[f]))throw new Error(`Dependant features missing. Make sure the following features are enabled - ${h.dependsOn.join(", ")}`);if(h.isCompatible())return this._features[a]={featureImplementation:h,enabled:!0,version:o,required:n},r?this._xrSessionManager.session&&!this._features[a].featureImplementation.attached&&this.attachFeature(a):this._features[a].featureImplementation.disableAutoAttach=!0,this._features[a].featureImplementation;if(n)throw new Error("required feature not compatible");return j.Warn(`Feature ${a} not compatible with the current environment/browser and was not enabled.`),h}getEnabledFeature(e){return this._features[e]&&this._features[e].featureImplementation}getEnabledFeatures(){return Object.keys(this._features)}async _extendXRSessionInitObject(e){const t=this.getEnabledFeatures();for(const i of t){const r=this._features[i],n=r.featureImplementation.xrNativeFeatureName;if(n&&(r.required?(e.requiredFeatures=e.requiredFeatures||[],e.requiredFeatures.indexOf(n)===-1&&e.requiredFeatures.push(n)):(e.optionalFeatures=e.optionalFeatures||[],e.optionalFeatures.indexOf(n)===-1&&e.optionalFeatures.push(n))),r.featureImplementation.getXRSessionInitExtension){const a=await r.featureImplementation.getXRSessionInitExtension();e={...e,...a}}}return e}}At._AvailableFeatures={};At._ConflictingFeatures={[Ne.TELEPORTATION]:Ne.MOVEMENT,[Ne.MOVEMENT]:Ne.TELEPORTATION};var Bg;(function(s){s[s.ABOVE_FINGER_TIPS=0]="ABOVE_FINGER_TIPS",s[s.RADIAL_SIDE=1]="RADIAL_SIDE",s[s.ULNAR_SIDE=2]="ULNAR_SIDE",s[s.BELOW_WRIST=3]="BELOW_WRIST"})(Bg||(Bg={}));var Vg;(function(s){s[s.LOOK_AT_CAMERA=0]="LOOK_AT_CAMERA",s[s.HAND_ROTATION=1]="HAND_ROTATION"})(Vg||(Vg={}));var Ug;(function(s){s[s.ALWAYS_VISIBLE=0]="ALWAYS_VISIBLE",s[s.PALM_UP=1]="PALM_UP",s[s.GAZE_FOCUS=2]="GAZE_FOCUS",s[s.PALM_AND_GAZE=3]="PALM_AND_GAZE"})(Ug||(Ug={}));x.Zero(),x.Zero(),x.Zero(),x.Zero(),x.Zero(),x.Zero();Z.Identity();z.Identity(),z.Identity();Fo(10,x.Zero);Z.Identity();Fo(5,z.Identity);class ZI{constructor(e,t,i=3,r){this._engine=e,this._label=r,this._engine._storageBuffers.push(this),this._create(t,i)}_create(e,t){this._bufferSize=e,this._creationFlags=t,this._buffer=this._engine.createStorageBuffer(e,t,this._label)}_rebuild(){this._create(this._bufferSize,this._creationFlags)}getBuffer(){return this._buffer}clear(e,t){this._engine.clearStorageBuffer(this._buffer,e,t)}update(e,t,i){this._buffer&&this._engine.updateStorageBuffer(this._buffer,e,t,i)}async read(e,t,i,r){return await this._engine.readFromStorageBuffer(this._buffer,e,t,i,r)}dispose(){const e=this._engine._storageBuffers,t=e.indexOf(this);t!==-1&&(e[t]=e[e.length-1],e.pop()),this._engine._releaseBuffer(this._buffer),this._buffer=null}}const cl=(()=>{const s=new Uint8Array(4),e=new Uint32Array(s.buffer);return!!((e[0]=1)&s[0])})();Object.defineProperty(M.prototype,"effectiveByteStride",{get:function(){return this._alignedBuffer&&this._alignedBuffer.byteStride||this.byteStride},enumerable:!0,configurable:!0});Object.defineProperty(M.prototype,"effectiveByteOffset",{get:function(){return this._alignedBuffer?0:this.byteOffset},enumerable:!0,configurable:!0});Object.defineProperty(M.prototype,"effectiveBuffer",{get:function(){return this._alignedBuffer&&this._alignedBuffer.getBuffer()||this._buffer.getBuffer()},enumerable:!0,configurable:!0});M.prototype._rebuild=function(){var s,e;(s=this._buffer)==null||s._rebuild(),(e=this._alignedBuffer)==null||e._rebuild()};M.prototype.dispose=function(){var s;this._ownsBuffer&&this._buffer.dispose(),(s=this._alignedBuffer)==null||s.dispose(),this._alignedBuffer=void 0,this._isDisposed=!0};M.prototype.getWrapperBuffer=function(){return this._alignedBuffer||this._buffer};M.prototype._alignBuffer=function(){var h;const s=this._buffer.getData();if(!this.engine._features.forceVertexBufferStrideAndOffsetMultiple4Bytes||this.byteStride%4===0&&this.byteOffset%4===0||!s)return;const e=$N(this.type),t=this.byteStride+3&-4,i=t/e,r=this._maxVerticesCount,a=r*t/e;let o;if(Array.isArray(s)){const d=new Float32Array(s);o=new DataView(d.buffer,d.byteOffset,d.byteLength)}else s instanceof ArrayBuffer?o=new DataView(s,0,s.byteLength):o=new DataView(s.buffer,s.byteOffset,s.byteLength);let l;this.type===M.BYTE?l=new Int8Array(a):this.type===M.UNSIGNED_BYTE?l=new Uint8Array(a):this.type===M.SHORT?l=new Int16Array(a):this.type===M.UNSIGNED_SHORT?l=new Uint16Array(a):this.type===M.INT?l=new Int32Array(a):this.type===M.UNSIGNED_INT?l=new Uint32Array(a):l=new Float32Array(a);const c=this.getSize();let u=this.byteOffset;for(let d=0;d<r;++d){for(let f=0;f<c;++f)switch(this.type){case M.BYTE:l[d*i+f]=o.getInt8(u+f);break;case M.UNSIGNED_BYTE:l[d*i+f]=o.getUint8(u+f);break;case M.SHORT:l[d*i+f]=o.getInt16(u+f*2,cl);break;case M.UNSIGNED_SHORT:l[d*i+f]=o.getUint16(u+f*2,cl);break;case M.INT:l[d*i+f]=o.getInt32(u+f*4,cl);break;case M.UNSIGNED_INT:l[d*i+f]=o.getUint32(u+f*4,cl);break;case M.FLOAT:l[d*i+f]=o.getFloat32(u+f*4,cl);break}u+=this.byteStride}(h=this._alignedBuffer)==null||h.dispose(),this._alignedBuffer=new gr(this.engine,l,!1,t,!1,this.getIsInstanced(),!0,this.instanceDivisor,(this._label??"VertexBuffer")+"_aligned")};class Kl{constructor(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new k,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}attachControl(e){e=j.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==ze.POINTERWHEEL)return;const i=t.event,r=i.deltaMode===XN.DOM_DELTA_LINE?this._ffMultiplier:1;this._wheelDeltaX+=this.wheelPrecisionX*r*i.deltaX/this._normalize,this._wheelDeltaY-=this.wheelPrecisionY*r*i.deltaY/this._normalize,this._wheelDeltaZ+=this.wheelPrecisionZ*r*i.deltaZ/this._normalize,i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,ze.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()}checkInputs(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0}getClassName(){return"BaseCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}_([R()],Kl.prototype,"wheelPrecisionX",void 0);_([R()],Kl.prototype,"wheelPrecisionY",void 0);_([R()],Kl.prototype,"wheelPrecisionZ",void 0);class ci{get isConnected(){return this._isConnected}constructor(e,t,i,r=0,n=1,a=2,o=3){this.id=e,this.index=t,this.browserGamepad=i,this._leftStick={x:0,y:0},this._rightStick={x:0,y:0},this._isConnected=!0,this._invertLeftStickY=!1,this.type=ci.GAMEPAD,this._leftStickAxisX=r,this._leftStickAxisY=n,this._rightStickAxisX=a,this._rightStickAxisY=o,this.browserGamepad.axes.length>=2&&(this._leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]}),this.browserGamepad.axes.length>=4&&(this._rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}onleftstickchanged(e){this._onleftstickchanged=e}onrightstickchanged(e){this._onrightstickchanged=e}get leftStick(){return this._leftStick}set leftStick(e){this._onleftstickchanged&&(this._leftStick.x!==e.x||this._leftStick.y!==e.y)&&this._onleftstickchanged(e),this._leftStick=e}get rightStick(){return this._rightStick}set rightStick(e){this._onrightstickchanged&&(this._rightStick.x!==e.x||this._rightStick.y!==e.y)&&this._onrightstickchanged(e),this._rightStick=e}update(){this._leftStick&&(this.leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]},this._invertLeftStickY&&(this.leftStick.y*=-1)),this._rightStick&&(this.rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}dispose(){}}ci.GAMEPAD=0;ci.GENERIC=1;ci.XBOX=2;ci.POSE_ENABLED=3;ci.DUALSHOCK=4;class QF extends ci{onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}constructor(e,t,i){super(e,t,i),this.onButtonDownObservable=new k,this.onButtonUpObservable=new k,this.type=ci.GENERIC,this._buttons=new Array(i.buttons.length)}_setButtonValue(e,t,i){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),e===0&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}update(){super.update();for(let e=0;e<this._buttons.length;e++)this._buttons[e]=this._setButtonValue(this.browserGamepad.buttons[e].value,this._buttons[e],e)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear()}}class Wu{constructor(){this.gamepadRotationSensibility=80,this.gamepadMoveSensibility=40,this._yAxisScale=1}get invertYAxis(){return this._yAxisScale!==1}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){const e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(t=>{t.type!==ci.POSE_ENABLED&&(!this.gamepad||t.type===ci.XBOX)&&(this.gamepad=t)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(t=>{this.gamepad===t&&(this.gamepad=null)}),this.gamepad=e.getGamepadByType(ci.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad){const e=this.camera,t=this.gamepad.rightStick;if(t){if(t.x!=0){const r=t.x/this.gamepadRotationSensibility;r!=0&&Math.abs(r)>.005&&(e.inertialAlphaOffset+=r)}if(t.y!=0){const r=t.y/this.gamepadRotationSensibility*this._yAxisScale;r!=0&&Math.abs(r)>.005&&(e.inertialBetaOffset+=r)}}const i=this.gamepad.leftStick;if(i&&i.y!=0){const r=i.y/this.gamepadMoveSensibility;r!=0&&Math.abs(r)>.005&&(this.camera.inertialRadiusOffset-=r)}}}getClassName(){return"ArcRotateCameraGamepadInput"}getSimpleName(){return"gamepad"}}_([R()],Wu.prototype,"gamepadRotationSensibility",void 0);_([R()],Wu.prototype,"gamepadMoveSensibility",void 0);lr.ArcRotateCameraGamepadInput=Wu;Zy.prototype.addVRDeviceOrientation=function(){return this.add(new QI),this};class QI{constructor(){this.alphaCorrection=1,this.gammaCorrection=1,this._alpha=0,this._gamma=0,this._dirty=!1,this._deviceOrientationHandler=e=>this._onOrientationEvent(e)}attachControl(e){e=j.BackCompatCameraNoPreventDefault(arguments),this.camera.attachControl(e);const t=this.camera.getScene().getEngine().getHostWindow();t&&(typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(i=>{i==="granted"?t.addEventListener("deviceorientation",this._deviceOrientationHandler):j.Warn("Permission not granted.")}).catch(i=>{j.Error(i)}):t.addEventListener("deviceorientation",this._deviceOrientationHandler))}_onOrientationEvent(e){e.alpha!==null&&(this._alpha=(+e.alpha|0)*this.alphaCorrection),e.gamma!==null&&(this._gamma=(+e.gamma|0)*this.gammaCorrection),this._dirty=!0}checkInputs(){this._dirty&&(this._dirty=!1,this._gamma<0&&(this._gamma=180+this._gamma),this.camera.alpha=-this._alpha/180*Math.PI%Math.PI*2,this.camera.beta=this._gamma/180*Math.PI)}detachControl(){window.removeEventListener("deviceorientation",this._deviceOrientationHandler)}getClassName(){return"ArcRotateCameraVRDeviceOrientationInput"}getSimpleName(){return"VRDeviceOrientation"}}lr.ArcRotateCameraVRDeviceOrientationInput=QI;class qn{constructor(){this.keysForward=[87],this.keysBackward=[83],this.keysUp=[69],this.keysDown=[81],this.keysRight=[68],this.keysLeft=[65],this._keys=new Array}attachControl(e){e=j.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(t.type===Nm.KEYDOWN)(this.keysForward.indexOf(i.keyCode)!==-1||this.keysBackward.indexOf(i.keyCode)!==-1||this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),e||i.preventDefault());else if(this.keysForward.indexOf(i.keyCode)!==-1||this.keysBackward.indexOf(i.keyCode)!==-1||this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1){const r=this._keys.indexOf(i.keyCode);r>=0&&this._keys.splice(r,1),e||i.preventDefault()}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}getClassName(){return"FlyCameraKeyboardInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t],r=e._computeLocalCameraSpeed();this.keysForward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,r):this.keysBackward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,-r):this.keysUp.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,r,0):this.keysDown.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,-r,0):this.keysRight.indexOf(i)!==-1?e._localDirection.copyFromFloats(r,0,0):this.keysLeft.indexOf(i)!==-1&&e._localDirection.copyFromFloats(-r,0,0),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),x.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}}_([R()],qn.prototype,"keysForward",void 0);_([R()],qn.prototype,"keysBackward",void 0);_([R()],qn.prototype,"keysUp",void 0);_([R()],qn.prototype,"keysDown",void 0);_([R()],qn.prototype,"keysRight",void 0);_([R()],qn.prototype,"keysLeft",void 0);lr.FlyCameraKeyboardInput=qn;class Hu{constructor(){this.buttons=[0,1,2],this.buttonsYaw=[-1,0,1],this.buttonsPitch=[-1,0,1],this.buttonsRoll=[2],this.activeButton=-1,this.angularSensibility=1e3,this._previousPosition=null}attachControl(e){e=j.BackCompatCameraNoPreventDefault(arguments),this._noPreventDefault=e,this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(t=>{this._pointerInput(t)},ze.POINTERDOWN|ze.POINTERUP|ze.POINTERMOVE),this._rollObserver=this.camera.getScene().onBeforeRenderObservable.add(()=>{this.camera.rollCorrect&&this.camera.restoreRoll(this.camera.rollCorrect)})}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this.camera.getScene().onBeforeRenderObservable.remove(this._rollObserver),this._observer=null,this._rollObserver=null,this._previousPosition=null,this._noPreventDefault=void 0)}getClassName(){return"FlyCameraMouseInput"}getSimpleName(){return"mouse"}_pointerInput(e){const t=e.event,r=this.camera.getEngine();if(!this.touchEnabled&&t.pointerType==="touch"||e.type!==ze.POINTERMOVE&&this.buttons.indexOf(t.button)===-1)return;const n=t.target;if(e.type===ze.POINTERDOWN){try{n==null||n.setPointerCapture(t.pointerId)}catch{}this._previousPosition={x:t.clientX,y:t.clientY},this.activeButton=t.button,this._noPreventDefault||t.preventDefault(),r.isPointerLock&&this._onMouseMove(e.event)}else if(e.type===ze.POINTERUP){try{n==null||n.releasePointerCapture(t.pointerId)}catch{}this.activeButton=-1,this._previousPosition=null,this._noPreventDefault||t.preventDefault()}else if(e.type===ze.POINTERMOVE){if(!this._previousPosition){r.isPointerLock&&this._onMouseMove(e.event);return}const a=t.clientX-this._previousPosition.x,o=t.clientY-this._previousPosition.y;this._rotateCamera(a,o),this._previousPosition={x:t.clientX,y:t.clientY},this._noPreventDefault||t.preventDefault()}}_onMouseMove(e){if(!this.camera.getEngine().isPointerLock)return;const r=e.movementX,n=e.movementY;this._rotateCamera(r,n),this._previousPosition=null,this._noPreventDefault||e.preventDefault()}_rotateCamera(e,t){const i=this.camera,r=i._calculateHandednessMultiplier(),n=e*r/this.angularSensibility,a=t*r/this.angularSensibility,o=Z.RotationYawPitchRoll(i.rotation.y,i.rotation.x,i.rotation.z);let l;if(this.buttonsPitch.some(c=>c===this.activeButton)&&(l=Z.RotationAxis(Ms.X,a),o.multiplyInPlace(l)),this.buttonsYaw.some(c=>c===this.activeButton)){l=Z.RotationAxis(Ms.Y,n),o.multiplyInPlace(l);const c=i.bankedTurnLimit+i._trackRoll;if(i.bankedTurn&&-c<i.rotation.z&&i.rotation.z<c){const u=i.bankedTurnMultiplier*-n;l=Z.RotationAxis(Ms.Z,u),o.multiplyInPlace(l)}}this.buttonsRoll.some(c=>c===this.activeButton)&&(l=Z.RotationAxis(Ms.Z,-n),i._trackRoll-=n,o.multiplyInPlace(l)),o.toEulerAnglesToRef(i.rotation)}}_([R()],Hu.prototype,"buttons",void 0);_([R()],Hu.prototype,"angularSensibility",void 0);lr.FlyCameraMouseInput=Hu;class Ci{constructor(){this.keysHeightOffsetIncr=[38],this.keysHeightOffsetDecr=[40],this.keysHeightOffsetModifierAlt=!1,this.keysHeightOffsetModifierCtrl=!1,this.keysHeightOffsetModifierShift=!1,this.keysRotationOffsetIncr=[37],this.keysRotationOffsetDecr=[39],this.keysRotationOffsetModifierAlt=!1,this.keysRotationOffsetModifierCtrl=!1,this.keysRotationOffsetModifierShift=!1,this.keysRadiusIncr=[40],this.keysRadiusDecr=[38],this.keysRadiusModifierAlt=!0,this.keysRadiusModifierCtrl=!1,this.keysRadiusModifierShift=!1,this.heightSensibility=1,this.rotationSensibility=1,this.radiusSensibility=1,this._keys=new Array}attachControl(e){e=j.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(!i.metaKey){if(t.type===Nm.KEYDOWN)this._ctrlPressed=i.ctrlKey,this._altPressed=i.altKey,this._shiftPressed=i.shiftKey,(this.keysHeightOffsetIncr.indexOf(i.keyCode)!==-1||this.keysHeightOffsetDecr.indexOf(i.keyCode)!==-1||this.keysRotationOffsetIncr.indexOf(i.keyCode)!==-1||this.keysRotationOffsetDecr.indexOf(i.keyCode)!==-1||this.keysRadiusIncr.indexOf(i.keyCode)!==-1||this.keysRadiusDecr.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),i.preventDefault&&(e||i.preventDefault()));else if(this.keysHeightOffsetIncr.indexOf(i.keyCode)!==-1||this.keysHeightOffsetDecr.indexOf(i.keyCode)!==-1||this.keysRotationOffsetIncr.indexOf(i.keyCode)!==-1||this.keysRotationOffsetDecr.indexOf(i.keyCode)!==-1||this.keysRadiusIncr.indexOf(i.keyCode)!==-1||this.keysRadiusDecr.indexOf(i.keyCode)!==-1){const r=this._keys.indexOf(i.keyCode);r>=0&&this._keys.splice(r,1),i.preventDefault&&(e||i.preventDefault())}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver)for(const e of this._keys)this.keysHeightOffsetIncr.indexOf(e)!==-1&&this._modifierHeightOffset()?this.camera.heightOffset+=this.heightSensibility:this.keysHeightOffsetDecr.indexOf(e)!==-1&&this._modifierHeightOffset()?this.camera.heightOffset-=this.heightSensibility:this.keysRotationOffsetIncr.indexOf(e)!==-1&&this._modifierRotationOffset()?(this.camera.rotationOffset+=this.rotationSensibility,this.camera.rotationOffset%=360):this.keysRotationOffsetDecr.indexOf(e)!==-1&&this._modifierRotationOffset()?(this.camera.rotationOffset-=this.rotationSensibility,this.camera.rotationOffset%=360):this.keysRadiusIncr.indexOf(e)!==-1&&this._modifierRadius()?this.camera.radius+=this.radiusSensibility:this.keysRadiusDecr.indexOf(e)!==-1&&this._modifierRadius()&&(this.camera.radius-=this.radiusSensibility)}getClassName(){return"FollowCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}_modifierHeightOffset(){return this.keysHeightOffsetModifierAlt===this._altPressed&&this.keysHeightOffsetModifierCtrl===this._ctrlPressed&&this.keysHeightOffsetModifierShift===this._shiftPressed}_modifierRotationOffset(){return this.keysRotationOffsetModifierAlt===this._altPressed&&this.keysRotationOffsetModifierCtrl===this._ctrlPressed&&this.keysRotationOffsetModifierShift===this._shiftPressed}_modifierRadius(){return this.keysRadiusModifierAlt===this._altPressed&&this.keysRadiusModifierCtrl===this._ctrlPressed&&this.keysRadiusModifierShift===this._shiftPressed}}_([R()],Ci.prototype,"keysHeightOffsetIncr",void 0);_([R()],Ci.prototype,"keysHeightOffsetDecr",void 0);_([R()],Ci.prototype,"keysHeightOffsetModifierAlt",void 0);_([R()],Ci.prototype,"keysHeightOffsetModifierCtrl",void 0);_([R()],Ci.prototype,"keysHeightOffsetModifierShift",void 0);_([R()],Ci.prototype,"keysRotationOffsetIncr",void 0);_([R()],Ci.prototype,"keysRotationOffsetDecr",void 0);_([R()],Ci.prototype,"keysRotationOffsetModifierAlt",void 0);_([R()],Ci.prototype,"keysRotationOffsetModifierCtrl",void 0);_([R()],Ci.prototype,"keysRotationOffsetModifierShift",void 0);_([R()],Ci.prototype,"keysRadiusIncr",void 0);_([R()],Ci.prototype,"keysRadiusDecr",void 0);_([R()],Ci.prototype,"keysRadiusModifierAlt",void 0);_([R()],Ci.prototype,"keysRadiusModifierCtrl",void 0);_([R()],Ci.prototype,"keysRadiusModifierShift",void 0);_([R()],Ci.prototype,"heightSensibility",void 0);_([R()],Ci.prototype,"rotationSensibility",void 0);_([R()],Ci.prototype,"radiusSensibility",void 0);lr.FollowCameraKeyboardMoveInput=Ci;class Fa{constructor(){this.axisControlRadius=!0,this.axisControlHeight=!1,this.axisControlRotation=!1,this.wheelPrecision=3,this.wheelDeltaPercentage=0}attachControl(e){e=j.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==ze.POINTERWHEEL)return;const i=t.event;let r=0;const n=Math.max(-1,Math.min(1,i.deltaY));this.wheelDeltaPercentage?(+this.axisControlRadius+ +this.axisControlHeight+ +this.axisControlRotation&&N.Warn("wheelDeltaPercentage only usable when mouse wheel controls ONE axis. Currently enabled: axisControlRadius: "+this.axisControlRadius+", axisControlHeightOffset: "+this.axisControlHeight+", axisControlRotationOffset: "+this.axisControlRotation),this.axisControlRadius?r=n*.01*this.wheelDeltaPercentage*this.camera.radius:this.axisControlHeight?r=n*.01*this.wheelDeltaPercentage*this.camera.heightOffset:this.axisControlRotation&&(r=n*.01*this.wheelDeltaPercentage*this.camera.rotationOffset)):r=n*this.wheelPrecision,r&&(this.axisControlRadius?this.camera.radius+=r:this.axisControlHeight?this.camera.heightOffset-=r:this.axisControlRotation&&(this.camera.rotationOffset-=r)),i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,ze.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null)}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}_([R()],Fa.prototype,"axisControlRadius",void 0);_([R()],Fa.prototype,"axisControlHeight",void 0);_([R()],Fa.prototype,"axisControlRotation",void 0);_([R()],Fa.prototype,"wheelPrecision",void 0);_([R()],Fa.prototype,"wheelDeltaPercentage",void 0);lr.FollowCameraMouseWheelInput=Fa;class cr extends YN{constructor(){super(...arguments),this.angularSensibilityX=1,this.angularSensibilityY=1,this.pinchPrecision=1e4,this.pinchDeltaPercentage=0,this.axisXControlRadius=!1,this.axisXControlHeight=!1,this.axisXControlRotation=!0,this.axisYControlRadius=!1,this.axisYControlHeight=!0,this.axisYControlRotation=!1,this.axisPinchControlRadius=!0,this.axisPinchControlHeight=!1,this.axisPinchControlRotation=!1,this.warningEnable=!0,this._warningCounter=0}getClassName(){return"FollowCameraPointersInput"}onTouch(e,t,i){this._warning(),this.axisXControlRotation?this.camera.rotationOffset+=t/this.angularSensibilityX:this.axisYControlRotation&&(this.camera.rotationOffset+=i/this.angularSensibilityX),this.axisXControlHeight?this.camera.heightOffset+=t/this.angularSensibilityY:this.axisYControlHeight&&(this.camera.heightOffset+=i/this.angularSensibilityY),this.axisXControlRadius?this.camera.radius-=t/this.angularSensibilityY:this.axisYControlRadius&&(this.camera.radius-=i/this.angularSensibilityY)}onMultiTouch(e,t,i,r,n,a){if(i===0&&n===null||r===0&&a===null)return;let o=(r-i)/(this.pinchPrecision*(this.angularSensibilityX+this.angularSensibilityY)/2);this.pinchDeltaPercentage?(o*=.01*this.pinchDeltaPercentage,this.axisPinchControlRotation&&(this.camera.rotationOffset+=o*this.camera.rotationOffset),this.axisPinchControlHeight&&(this.camera.heightOffset+=o*this.camera.heightOffset),this.axisPinchControlRadius&&(this.camera.radius-=o*this.camera.radius)):(this.axisPinchControlRotation&&(this.camera.rotationOffset+=o),this.axisPinchControlHeight&&(this.camera.heightOffset+=o),this.axisPinchControlRadius&&(this.camera.radius-=o))}_warning(){if(!this.warningEnable||this._warningCounter++%100!==0)return;const e="It probably only makes sense to control ONE camera property with each pointer axis. Set 'warningEnable = false' if you are sure. Currently enabled: ";+this.axisXControlRotation+ +this.axisXControlHeight+ +this.axisXControlRadius<=1&&N.Warn(e+"axisXControlRotation: "+this.axisXControlRotation+", axisXControlHeight: "+this.axisXControlHeight+", axisXControlRadius: "+this.axisXControlRadius),+this.axisYControlRotation+ +this.axisYControlHeight+ +this.axisYControlRadius<=1&&N.Warn(e+"axisYControlRotation: "+this.axisYControlRotation+", axisYControlHeight: "+this.axisYControlHeight+", axisYControlRadius: "+this.axisYControlRadius),+this.axisPinchControlRotation+ +this.axisPinchControlHeight+ +this.axisPinchControlRadius<=1&&N.Warn(e+"axisPinchControlRotation: "+this.axisPinchControlRotation+", axisPinchControlHeight: "+this.axisPinchControlHeight+", axisPinchControlRadius: "+this.axisPinchControlRadius)}}_([R()],cr.prototype,"angularSensibilityX",void 0);_([R()],cr.prototype,"angularSensibilityY",void 0);_([R()],cr.prototype,"pinchPrecision",void 0);_([R()],cr.prototype,"pinchDeltaPercentage",void 0);_([R()],cr.prototype,"axisXControlRadius",void 0);_([R()],cr.prototype,"axisXControlHeight",void 0);_([R()],cr.prototype,"axisXControlRotation",void 0);_([R()],cr.prototype,"axisYControlRadius",void 0);_([R()],cr.prototype,"axisYControlHeight",void 0);_([R()],cr.prototype,"axisYControlRotation",void 0);_([R()],cr.prototype,"axisPinchControlRadius",void 0);_([R()],cr.prototype,"axisPinchControlHeight",void 0);_([R()],cr.prototype,"axisPinchControlRotation",void 0);lr.FollowCameraPointersInput=cr;class Vr{constructor(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this.rotationSpeed=.5,this.keysRotateLeft=[],this.keysRotateRight=[],this.keysRotateUp=[],this.keysRotateDown=[],this._keys=new Array}attachControl(e){e=j.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(!i.metaKey){if(t.type===Nm.KEYDOWN)(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysUpward.indexOf(i.keyCode)!==-1||this.keysDownward.indexOf(i.keyCode)!==-1||this.keysRotateLeft.indexOf(i.keyCode)!==-1||this.keysRotateRight.indexOf(i.keyCode)!==-1||this.keysRotateUp.indexOf(i.keyCode)!==-1||this.keysRotateDown.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),e||i.preventDefault());else if(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysUpward.indexOf(i.keyCode)!==-1||this.keysDownward.indexOf(i.keyCode)!==-1||this.keysRotateLeft.indexOf(i.keyCode)!==-1||this.keysRotateRight.indexOf(i.keyCode)!==-1||this.keysRotateUp.indexOf(i.keyCode)!==-1||this.keysRotateDown.indexOf(i.keyCode)!==-1){const r=this._keys.indexOf(i.keyCode);r>=0&&this._keys.splice(r,1),e||i.preventDefault()}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t],r=e._computeLocalCameraSpeed();this.keysLeft.indexOf(i)!==-1?e._localDirection.copyFromFloats(-r,0,0):this.keysUp.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,r):this.keysRight.indexOf(i)!==-1?e._localDirection.copyFromFloats(r,0,0):this.keysDown.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,-r):this.keysUpward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,r,0):this.keysDownward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,-r,0):this.keysRotateLeft.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y-=this._getLocalRotation()):this.keysRotateRight.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y+=this._getLocalRotation()):this.keysRotateUp.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x-=this._getLocalRotation()):this.keysRotateDown.indexOf(i)!==-1&&(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x+=this._getLocalRotation()),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),x.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}getClassName(){return"FreeCameraKeyboardMoveInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}_getLocalRotation(){const e=this.camera._calculateHandednessMultiplier();return this.rotationSpeed*this._engine.getDeltaTime()/1e3*e}}_([R()],Vr.prototype,"keysUp",void 0);_([R()],Vr.prototype,"keysUpward",void 0);_([R()],Vr.prototype,"keysDown",void 0);_([R()],Vr.prototype,"keysDownward",void 0);_([R()],Vr.prototype,"keysLeft",void 0);_([R()],Vr.prototype,"keysRight",void 0);_([R()],Vr.prototype,"rotationSpeed",void 0);_([R()],Vr.prototype,"keysRotateLeft",void 0);_([R()],Vr.prototype,"keysRotateRight",void 0);_([R()],Vr.prototype,"keysRotateUp",void 0);_([R()],Vr.prototype,"keysRotateDown",void 0);lr.FreeCameraKeyboardMoveInput=Vr;class $u{constructor(e=!0){this.touchEnabled=e,this.buttons=[0,1,2],this.angularSensibility=2e3,this._previousPosition=null,this.onPointerMovedObservable=new k,this._allowCameraRotation=!0,this._currentActiveButton=-1,this._activePointerId=-1}attachControl(e){e=j.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();this._pointerInput||(this._pointerInput=r=>{const n=r.event,a=n.pointerType==="touch";if(!this.touchEnabled&&a||r.type!==ze.POINTERMOVE&&this.buttons.indexOf(n.button)===-1)return;const o=n.target;if(r.type===ze.POINTERDOWN){if(a&&this._activePointerId!==-1||!a&&this._currentActiveButton!==-1)return;this._activePointerId=n.pointerId;try{o==null||o.setPointerCapture(n.pointerId)}catch{}this._currentActiveButton===-1&&(this._currentActiveButton=n.button),this._previousPosition={x:n.clientX,y:n.clientY},e||(n.preventDefault(),i&&i.focus()),t.isPointerLock&&this._onMouseMove&&this._onMouseMove(r.event)}else if(r.type===ze.POINTERUP){if(a&&this._activePointerId!==n.pointerId||!a&&this._currentActiveButton!==n.button)return;try{o==null||o.releasePointerCapture(n.pointerId)}catch{}this._currentActiveButton=-1,this._previousPosition=null,e||n.preventDefault(),this._activePointerId=-1}else if(r.type===ze.POINTERMOVE&&(this._activePointerId===n.pointerId||!a)){if(t.isPointerLock&&this._onMouseMove)this._onMouseMove(r.event);else if(this._previousPosition){const l=this.camera._calculateHandednessMultiplier(),c=(n.clientX-this._previousPosition.x)*l,u=(n.clientY-this._previousPosition.y)*l;this._allowCameraRotation&&(this.camera.cameraRotation.y+=c/this.angularSensibility,this.camera.cameraRotation.x+=u/this.angularSensibility),this.onPointerMovedObservable.notifyObservers({offsetX:c,offsetY:u}),this._previousPosition={x:n.clientX,y:n.clientY},e||n.preventDefault()}}}),this._onMouseMove=r=>{if(!t.isPointerLock)return;const n=this.camera._calculateHandednessMultiplier();this.camera.cameraRotation.y+=r.movementX*n/this.angularSensibility,this.camera.cameraRotation.x+=r.movementY*n/this.angularSensibility,this._previousPosition=null,e||r.preventDefault()},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,ze.POINTERDOWN|ze.POINTERUP|ze.POINTERMOVE),i&&(this._contextMenuBind=r=>this.onContextMenu(r),i.addEventListener("contextmenu",this._contextMenuBind,!1))}onContextMenu(e){e.preventDefault()}detachControl(){if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._contextMenuBind){const t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("contextmenu",this._contextMenuBind)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this._previousPosition=null}this._activePointerId=-1,this._currentActiveButton=-1}getClassName(){return"FreeCameraMouseInput"}getSimpleName(){return"mouse"}}_([R()],$u.prototype,"buttons",void 0);_([R()],$u.prototype,"angularSensibility",void 0);lr.FreeCameraMouseInput=$u;var _t;(function(s){s[s.MoveRelative=0]="MoveRelative",s[s.RotateRelative=1]="RotateRelative",s[s.MoveScene=2]="MoveScene"})(_t||(_t={}));class bs extends Kl{constructor(){super(...arguments),this._moveRelative=x.Zero(),this._rotateRelative=x.Zero(),this._moveScene=x.Zero(),this._wheelXAction=_t.MoveRelative,this._wheelXActionCoordinate=0,this._wheelYAction=_t.MoveRelative,this._wheelYActionCoordinate=2,this._wheelZAction=null,this._wheelZActionCoordinate=null}getClassName(){return"FreeCameraMouseWheelInput"}set wheelXMoveRelative(e){e===null&&this._wheelXAction!==_t.MoveRelative||(this._wheelXAction=_t.MoveRelative,this._wheelXActionCoordinate=e)}get wheelXMoveRelative(){return this._wheelXAction!==_t.MoveRelative?null:this._wheelXActionCoordinate}set wheelYMoveRelative(e){e===null&&this._wheelYAction!==_t.MoveRelative||(this._wheelYAction=_t.MoveRelative,this._wheelYActionCoordinate=e)}get wheelYMoveRelative(){return this._wheelYAction!==_t.MoveRelative?null:this._wheelYActionCoordinate}set wheelZMoveRelative(e){e===null&&this._wheelZAction!==_t.MoveRelative||(this._wheelZAction=_t.MoveRelative,this._wheelZActionCoordinate=e)}get wheelZMoveRelative(){return this._wheelZAction!==_t.MoveRelative?null:this._wheelZActionCoordinate}set wheelXRotateRelative(e){e===null&&this._wheelXAction!==_t.RotateRelative||(this._wheelXAction=_t.RotateRelative,this._wheelXActionCoordinate=e)}get wheelXRotateRelative(){return this._wheelXAction!==_t.RotateRelative?null:this._wheelXActionCoordinate}set wheelYRotateRelative(e){e===null&&this._wheelYAction!==_t.RotateRelative||(this._wheelYAction=_t.RotateRelative,this._wheelYActionCoordinate=e)}get wheelYRotateRelative(){return this._wheelYAction!==_t.RotateRelative?null:this._wheelYActionCoordinate}set wheelZRotateRelative(e){e===null&&this._wheelZAction!==_t.RotateRelative||(this._wheelZAction=_t.RotateRelative,this._wheelZActionCoordinate=e)}get wheelZRotateRelative(){return this._wheelZAction!==_t.RotateRelative?null:this._wheelZActionCoordinate}set wheelXMoveScene(e){e===null&&this._wheelXAction!==_t.MoveScene||(this._wheelXAction=_t.MoveScene,this._wheelXActionCoordinate=e)}get wheelXMoveScene(){return this._wheelXAction!==_t.MoveScene?null:this._wheelXActionCoordinate}set wheelYMoveScene(e){e===null&&this._wheelYAction!==_t.MoveScene||(this._wheelYAction=_t.MoveScene,this._wheelYActionCoordinate=e)}get wheelYMoveScene(){return this._wheelYAction!==_t.MoveScene?null:this._wheelYActionCoordinate}set wheelZMoveScene(e){e===null&&this._wheelZAction!==_t.MoveScene||(this._wheelZAction=_t.MoveScene,this._wheelZActionCoordinate=e)}get wheelZMoveScene(){return this._wheelZAction!==_t.MoveScene?null:this._wheelZActionCoordinate}checkInputs(){if(this._wheelDeltaX===0&&this._wheelDeltaY===0&&this._wheelDeltaZ==0)return;this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);const e=z.Zero();this.camera.getViewMatrix().invertToRef(e);const t=x.Zero();x.TransformNormalToRef(this._moveRelative,e,t),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(t),this.camera.cameraDirection.addInPlace(this._moveScene),super.checkInputs()}_updateCamera(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)}_updateCameraProperty(e,t,i){if(e===0||t===null||i===null)return;let r=null;switch(t){case _t.MoveRelative:r=this._moveRelative;break;case _t.RotateRelative:r=this._rotateRelative;break;case _t.MoveScene:r=this._moveScene;break}switch(i){case 0:r.set(e,0,0);break;case 1:r.set(0,e,0);break;case 2:r.set(0,0,e);break}}}_([R()],bs.prototype,"wheelXMoveRelative",null);_([R()],bs.prototype,"wheelYMoveRelative",null);_([R()],bs.prototype,"wheelZMoveRelative",null);_([R()],bs.prototype,"wheelXRotateRelative",null);_([R()],bs.prototype,"wheelYRotateRelative",null);_([R()],bs.prototype,"wheelZRotateRelative",null);_([R()],bs.prototype,"wheelXMoveScene",null);_([R()],bs.prototype,"wheelYMoveScene",null);_([R()],bs.prototype,"wheelZMoveScene",null);lr.FreeCameraMouseWheelInput=bs;class Xu{constructor(e=!1){this.allowMouse=e,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this.singleFingerRotate=!1,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array,this._isSafari=j.IsSafari()}attachControl(e){e=j.BackCompatCameraNoPreventDefault(arguments);let t=null;if(this._pointerInput===void 0&&(this._onLostFocus=()=>{this._offsetX=null,this._offsetY=null},this._pointerInput=i=>{const r=i.event,n=r.pointerType==="mouse"||this._isSafari&&typeof r.pointerType>"u";if(!(!this.allowMouse&&n)){if(i.type===ze.POINTERDOWN){if(e||r.preventDefault(),this._pointerPressed.push(r.pointerId),this._pointerPressed.length!==1)return;t={x:r.clientX,y:r.clientY}}else if(i.type===ze.POINTERUP){e||r.preventDefault();const a=this._pointerPressed.indexOf(r.pointerId);if(a===-1||(this._pointerPressed.splice(a,1),a!=0))return;t=null,this._offsetX=null,this._offsetY=null}else if(i.type===ze.POINTERMOVE){if(e||r.preventDefault(),!t||this._pointerPressed.indexOf(r.pointerId)!=0)return;this._offsetX=r.clientX-t.x,this._offsetY=-(r.clientY-t.y)}}}),this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,ze.POINTERDOWN|ze.POINTERUP|ze.POINTERMOVE),this._onLostFocus){const r=this.camera.getEngine().getInputElement();r&&r.addEventListener("blur",this._onLostFocus)}}detachControl(){if(this._pointerInput){if(this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null),this._onLostFocus){const t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed.length=0,this._offsetX=null,this._offsetY=null}}checkInputs(){if(this._offsetX===null||this._offsetY===null||this._offsetX===0&&this._offsetY===0)return;const e=this.camera,t=e._calculateHandednessMultiplier();if(e.cameraRotation.y=this._offsetX*t/this.touchAngularSensibility,this.singleFingerRotate&&this._pointerPressed.length===1||!this.singleFingerRotate&&this._pointerPressed.length>1)e.cameraRotation.x=-(this._offsetY*t)/this.touchAngularSensibility;else{const r=e._computeLocalCameraSpeed(),n=new x(0,0,this.touchMoveSensibility!==0?r*this._offsetY/this.touchMoveSensibility:0);z.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(x.TransformCoordinates(n,e._cameraRotationMatrix))}}getClassName(){return"FreeCameraTouchInput"}getSimpleName(){return"touch"}}_([R()],Xu.prototype,"touchAngularSensibility",void 0);_([R()],Xu.prototype,"touchMoveSensibility",void 0);lr.FreeCameraTouchInput=Xu;class Yu extends Dm{constructor(e){super(e),this._mouseInput=null,this._mouseWheelInput=null}addKeyboard(){return this.add(new Vr),this}addMouse(e=!0){return this._mouseInput||(this._mouseInput=new $u(e),this.add(this._mouseInput)),this}removeMouse(){return this._mouseInput&&this.remove(this._mouseInput),this}addMouseWheel(){return this._mouseWheelInput||(this._mouseWheelInput=new bs,this.add(this._mouseWheelInput)),this}removeMouseWheel(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this}addTouch(){return this.add(new Xu),this}clear(){super.clear(),this._mouseInput=null}}Yu.prototype.addDeviceOrientation=function(s){return this._deviceOrientationInput||(this._deviceOrientationInput=new KI,s&&(this._deviceOrientationInput.smoothFactor=s),this.add(this._deviceOrientationInput)),this};class KI{static async WaitForOrientationChangeAsync(e){return await new Promise((t,i)=>{let r=!1;const n=()=>{window.removeEventListener("deviceorientation",n),r=!0,t()};e&&setTimeout(()=>{r||(window.removeEventListener("deviceorientation",n),i("WaitForOrientationChangeAsync timed out"))},e),typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(a=>{a=="granted"?window.addEventListener("deviceorientation",n):j.Warn("Permission not granted.")}).catch(a=>{j.Error(a)}):window.addEventListener("deviceorientation",n)})}constructor(){this._screenOrientationAngle=0,this._screenQuaternion=new Z,this._alpha=0,this._beta=0,this._gamma=0,this.smoothFactor=0,this._onDeviceOrientationChangedObservable=new k,this._orientationChanged=()=>{this._screenOrientationAngle=window.orientation!==void 0?+window.orientation:window.screen.orientation&&window.screen.orientation.angle?window.screen.orientation.angle:0,this._screenOrientationAngle=-j.ToRadians(this._screenOrientationAngle/2),this._screenQuaternion.copyFromFloats(0,Math.sin(this._screenOrientationAngle),0,Math.cos(this._screenOrientationAngle))},this._deviceOrientation=e=>{this.smoothFactor?(this._alpha=e.alpha!==null?j.SmoothAngleChange(this._alpha,e.alpha,this.smoothFactor):0,this._beta=e.beta!==null?j.SmoothAngleChange(this._beta,e.beta,this.smoothFactor):0,this._gamma=e.gamma!==null?j.SmoothAngleChange(this._gamma,e.gamma,this.smoothFactor):0):(this._alpha=e.alpha!==null?e.alpha:0,this._beta=e.beta!==null?e.beta:0,this._gamma=e.gamma!==null?e.gamma:0),e.alpha!==null&&this._onDeviceOrientationChangedObservable.notifyObservers()},this._constantTransform=new Z(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._orientationChanged()}get camera(){return this._camera}set camera(e){this._camera=e,this._camera!=null&&!this._camera.rotationQuaternion&&(this._camera.rotationQuaternion=new Z),this._camera&&this._camera.onDisposeObservable.add(()=>{this._onDeviceOrientationChangedObservable.clear()})}attachControl(){const e=this.camera.getScene().getEngine().getHostWindow();if(e){const t=()=>{e.addEventListener("orientationchange",this._orientationChanged),e.addEventListener("deviceorientation",this._deviceOrientation),this._orientationChanged()};typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(i=>{i==="granted"?t():j.Warn("Permission not granted.")}).catch(i=>{j.Error(i)}):t()}}detachControl(){window.removeEventListener("orientationchange",this._orientationChanged),window.removeEventListener("deviceorientation",this._deviceOrientation),this._alpha=0}checkInputs(){this._alpha&&(Z.RotationYawPitchRollToRef(j.ToRadians(this._alpha),j.ToRadians(this._beta),-j.ToRadians(this._gamma),this.camera.rotationQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._screenQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._constantTransform),this._camera.getScene().useRightHandedSystem?this._camera.rotationQuaternion.y*=-1:this._camera.rotationQuaternion.z*=-1,this._camera.rotationQuaternion.w*=-1)}getClassName(){return"FreeCameraDeviceOrientationInput"}getSimpleName(){return"deviceOrientation"}}lr.FreeCameraDeviceOrientationInput=KI;class ju{constructor(){this.gamepadAngularSensibility=200,this.gamepadMoveSensibility=40,this.deadzoneDelta=.1,this._yAxisScale=1,this._cameraTransform=z.Identity(),this._deltaTransform=x.Zero(),this._vector3=x.Zero(),this._vector2=X.Zero()}get invertYAxis(){return this._yAxisScale!==1}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){const e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(t=>{t.type!==ci.POSE_ENABLED&&(!this.gamepad||t.type===ci.XBOX)&&(this.gamepad=t)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(t=>{this.gamepad===t&&(this.gamepad=null)}),this.gamepad=e.getGamepadByType(ci.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad&&this.gamepad.leftStick){const e=this.camera,t=this.gamepad.leftStick;this.gamepadMoveSensibility!==0&&(t.x=Math.abs(t.x)>this.deadzoneDelta?t.x/this.gamepadMoveSensibility:0,t.y=Math.abs(t.y)>this.deadzoneDelta?t.y/this.gamepadMoveSensibility:0);let i=this.gamepad.rightStick;i&&this.gamepadAngularSensibility!==0?(i.x=Math.abs(i.x)>this.deadzoneDelta?i.x/this.gamepadAngularSensibility:0,i.y=(Math.abs(i.y)>this.deadzoneDelta?i.y/this.gamepadAngularSensibility:0)*this._yAxisScale):i={x:0,y:0},e.rotationQuaternion?e.rotationQuaternion.toRotationMatrix(this._cameraTransform):z.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,this._cameraTransform);const r=e._computeLocalCameraSpeed()*50;this._vector3.copyFromFloats(t.x*r,0,-t.y*r),x.TransformCoordinatesToRef(this._vector3,this._cameraTransform,this._deltaTransform),e.cameraDirection.addInPlace(this._deltaTransform),this._vector2.copyFromFloats(i.y,i.x),e.cameraRotation.addInPlace(this._vector2)}}getClassName(){return"FreeCameraGamepadInput"}getSimpleName(){return"gamepad"}}_([R()],ju.prototype,"gamepadAngularSensibility",void 0);_([R()],ju.prototype,"gamepadMoveSensibility",void 0);lr.FreeCameraGamepadInput=ju;var kg;(function(s){s[s.X=0]="X",s[s.Y=1]="Y",s[s.Z=2]="Z"})(kg||(kg={}));class ae{static _GetDefaultOptions(){return{puckSize:40,containerSize:60,color:"cyan",puckImage:void 0,containerImage:void 0,position:void 0,alwaysVisible:!1,limitToContainer:!1}}constructor(e,t){this._released=!1;const i={...ae._GetDefaultOptions(),...t};if(e?this._leftJoystick=!0:this._leftJoystick=!1,ae._GlobalJoystickIndex++,this._axisTargetedByLeftAndRight=0,this._axisTargetedByUpAndDown=1,this.reverseLeftRight=!1,this.reverseUpDown=!1,this._touches=new jN,this.deltaPosition=x.Zero(),this._joystickSensibility=25,this._inversedSensibility=1/(this._joystickSensibility/1e3),this._onResize=()=>{ae._VjCanvasWidth=window.innerWidth,ae._VjCanvasHeight=window.innerHeight,ae.Canvas&&(ae.Canvas.width=ae._VjCanvasWidth,ae.Canvas.height=ae._VjCanvasHeight),ae._HalfWidth=ae._VjCanvasWidth/2},!ae.Canvas){window.addEventListener("resize",this._onResize,!1),ae.Canvas=document.createElement("canvas"),ae._VjCanvasWidth=window.innerWidth,ae._VjCanvasHeight=window.innerHeight,ae.Canvas.width=window.innerWidth,ae.Canvas.height=window.innerHeight,ae.Canvas.style.width="100%",ae.Canvas.style.height="100%",ae.Canvas.style.position="absolute",ae.Canvas.style.backgroundColor="transparent",ae.Canvas.style.top="0px",ae.Canvas.style.left="0px",ae.Canvas.style.zIndex="5",ae.Canvas.style.touchAction="none",ae.Canvas.setAttribute("touch-action","none");const r=ae.Canvas.getContext("2d");if(!r)throw new Error("Unable to create canvas for virtual joystick");ae._VjCanvasContext=r,ae._VjCanvasContext.strokeStyle="#ffffff",ae._VjCanvasContext.lineWidth=2,document.body.appendChild(ae.Canvas)}ae._HalfWidth=ae.Canvas.width/2,this.pressed=!1,this.limitToContainer=i.limitToContainer,this._joystickColor=i.color,this.containerSize=i.containerSize,this.puckSize=i.puckSize,i.position&&this.setPosition(i.position.x,i.position.y),i.puckImage&&this.setPuckImage(i.puckImage),i.containerImage&&this.setContainerImage(i.containerImage),i.alwaysVisible&&ae._AlwaysVisibleSticks++,this.alwaysVisible=i.alwaysVisible,this._joystickPointerId=-1,this._joystickPointerPos=new X(0,0),this._joystickPreviousPointerPos=new X(0,0),this._joystickPointerStartPos=new X(0,0),this._deltaJoystickVector=new X(0,0),this._onPointerDownHandlerRef=r=>{this._onPointerDown(r)},this._onPointerMoveHandlerRef=r=>{this._onPointerMove(r)},this._onPointerUpHandlerRef=r=>{this._onPointerUp(r)},ae.Canvas.addEventListener("pointerdown",this._onPointerDownHandlerRef,!1),ae.Canvas.addEventListener("pointermove",this._onPointerMoveHandlerRef,!1),ae.Canvas.addEventListener("pointerup",this._onPointerUpHandlerRef,!1),ae.Canvas.addEventListener("pointerout",this._onPointerUpHandlerRef,!1),ae.Canvas.addEventListener("pointercancel",this._onPointerUpHandlerRef,!1),ae.Canvas.addEventListener("contextmenu",r=>{r.preventDefault()},!1),requestAnimationFrame(()=>{this._drawVirtualJoystick()})}setJoystickSensibility(e){this._joystickSensibility=e,this._inversedSensibility=1/(this._joystickSensibility/1e3)}_onPointerDown(e){let t;e.preventDefault(),this._leftJoystick===!0?t=e.clientX<ae._HalfWidth:t=e.clientX>ae._HalfWidth,t&&this._joystickPointerId<0?(this._joystickPointerId=e.pointerId,this._joystickPosition?(this._joystickPointerStartPos=this._joystickPosition.clone(),this._joystickPointerPos=this._joystickPosition.clone(),this._joystickPreviousPointerPos=this._joystickPosition.clone(),this._onPointerMove(e)):(this._joystickPointerStartPos.x=e.clientX,this._joystickPointerStartPos.y=e.clientY,this._joystickPointerPos=this._joystickPointerStartPos.clone(),this._joystickPreviousPointerPos=this._joystickPointerStartPos.clone()),this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this.pressed=!0,this._touches.add(e.pointerId.toString(),e)):ae._GlobalJoystickIndex<2&&this._action&&(this._action(),this._touches.add(e.pointerId.toString(),{x:e.clientX,y:e.clientY,prevX:e.clientX,prevY:e.clientY}))}_onPointerMove(e){if(this._joystickPointerId==e.pointerId){if(this.limitToContainer){const a=new X(e.clientX-this._joystickPointerStartPos.x,e.clientY-this._joystickPointerStartPos.y),o=a.length();o>this.containerSize&&a.scaleInPlace(this.containerSize/o),this._joystickPointerPos.x=this._joystickPointerStartPos.x+a.x,this._joystickPointerPos.y=this._joystickPointerStartPos.y+a.y}else this._joystickPointerPos.x=e.clientX,this._joystickPointerPos.y=e.clientY;this._deltaJoystickVector=this._joystickPointerPos.clone(),this._deltaJoystickVector=this._deltaJoystickVector.subtract(this._joystickPointerStartPos),0<ae._AlwaysVisibleSticks&&(this._leftJoystick?this._joystickPointerPos.x=Math.min(ae._HalfWidth,this._joystickPointerPos.x):this._joystickPointerPos.x=Math.max(ae._HalfWidth,this._joystickPointerPos.x));const i=(this.reverseLeftRight?-1:1)*this._deltaJoystickVector.x/this._inversedSensibility;switch(this._axisTargetedByLeftAndRight){case 0:this.deltaPosition.x=Math.min(1,Math.max(-1,i));break;case 1:this.deltaPosition.y=Math.min(1,Math.max(-1,i));break;case 2:this.deltaPosition.z=Math.min(1,Math.max(-1,i));break}const n=(this.reverseUpDown?1:-1)*this._deltaJoystickVector.y/this._inversedSensibility;switch(this._axisTargetedByUpAndDown){case 0:this.deltaPosition.x=Math.min(1,Math.max(-1,n));break;case 1:this.deltaPosition.y=Math.min(1,Math.max(-1,n));break;case 2:this.deltaPosition.z=Math.min(1,Math.max(-1,n));break}}else{const t=this._touches.get(e.pointerId.toString());t&&(t.x=e.clientX,t.y=e.clientY)}}_onPointerUp(e){if(this._joystickPointerId==e.pointerId)this._clearPreviousDraw(),this._joystickPointerId=-1,this.pressed=!1;else{const t=this._touches.get(e.pointerId.toString());t&&ae._VjCanvasContext.clearRect(t.prevX-44,t.prevY-44,88,88)}this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this._touches.remove(e.pointerId.toString())}setJoystickColor(e){this._joystickColor=e}set containerSize(e){this._joystickContainerSize=e,this._clearContainerSize=~~(this._joystickContainerSize*2.1),this._clearContainerSizeOffset=~~(this._clearContainerSize/2)}get containerSize(){return this._joystickContainerSize}set puckSize(e){this._joystickPuckSize=e,this._clearPuckSize=~~(this._joystickPuckSize*2.1),this._clearPuckSizeOffset=~~(this._clearPuckSize/2)}get puckSize(){return this._joystickPuckSize}clearPosition(){this.alwaysVisible=!1,this._joystickPosition=null}set alwaysVisible(e){this._alwaysVisible!==e&&(e&&this._joystickPosition?(ae._AlwaysVisibleSticks++,this._alwaysVisible=!0):(ae._AlwaysVisibleSticks--,this._alwaysVisible=!1))}get alwaysVisible(){return this._alwaysVisible}setPosition(e,t){this._joystickPointerStartPos&&this._clearPreviousDraw(),this._joystickPosition=new X(e,t)}setActionOnTouch(e){this._action=e}setAxisForLeftRight(e){switch(e){case 0:case 1:case 2:this._axisTargetedByLeftAndRight=e;break;default:this._axisTargetedByLeftAndRight=0;break}}setAxisForUpDown(e){switch(e){case 0:case 1:case 2:this._axisTargetedByUpAndDown=e;break;default:this._axisTargetedByUpAndDown=1;break}}_clearPreviousDraw(){const e=this._joystickPosition||this._joystickPointerStartPos;ae._VjCanvasContext.clearRect(e.x-this._clearContainerSizeOffset,e.y-this._clearContainerSizeOffset,this._clearContainerSize,this._clearContainerSize),ae._VjCanvasContext.clearRect(this._joystickPreviousPointerPos.x-this._clearPuckSizeOffset-1,this._joystickPreviousPointerPos.y-this._clearPuckSizeOffset-1,this._clearPuckSize+2,this._clearPuckSize+2)}setContainerImage(e){const t=new Image;t.src=e,t.onload=()=>this._containerImage=t}setPuckImage(e){const t=new Image;t.src=e,t.onload=()=>this._puckImage=t}_drawContainer(){const e=this._joystickPosition||this._joystickPointerStartPos;this._clearPreviousDraw(),this._containerImage?ae._VjCanvasContext.drawImage(this._containerImage,e.x-this.containerSize,e.y-this.containerSize,this.containerSize*2,this.containerSize*2):(ae._VjCanvasContext.beginPath(),ae._VjCanvasContext.strokeStyle=this._joystickColor,ae._VjCanvasContext.lineWidth=2,ae._VjCanvasContext.arc(e.x,e.y,this.containerSize,0,Math.PI*2,!0),ae._VjCanvasContext.stroke(),ae._VjCanvasContext.closePath(),ae._VjCanvasContext.beginPath(),ae._VjCanvasContext.lineWidth=6,ae._VjCanvasContext.strokeStyle=this._joystickColor,ae._VjCanvasContext.arc(e.x,e.y,this.puckSize,0,Math.PI*2,!0),ae._VjCanvasContext.stroke(),ae._VjCanvasContext.closePath())}_drawPuck(){this._puckImage?ae._VjCanvasContext.drawImage(this._puckImage,this._joystickPointerPos.x-this.puckSize,this._joystickPointerPos.y-this.puckSize,this.puckSize*2,this.puckSize*2):(ae._VjCanvasContext.beginPath(),ae._VjCanvasContext.strokeStyle=this._joystickColor,ae._VjCanvasContext.lineWidth=2,ae._VjCanvasContext.arc(this._joystickPointerPos.x,this._joystickPointerPos.y,this.puckSize,0,Math.PI*2,!0),ae._VjCanvasContext.stroke(),ae._VjCanvasContext.closePath())}_drawVirtualJoystick(){this._released||(this.alwaysVisible&&this._drawContainer(),this.pressed&&this._touches.forEach((e,t)=>{t.pointerId===this._joystickPointerId?(this.alwaysVisible||this._drawContainer(),this._drawPuck(),this._joystickPreviousPointerPos=this._joystickPointerPos.clone()):(ae._VjCanvasContext.clearRect(t.prevX-44,t.prevY-44,88,88),ae._VjCanvasContext.beginPath(),ae._VjCanvasContext.fillStyle="white",ae._VjCanvasContext.beginPath(),ae._VjCanvasContext.strokeStyle="red",ae._VjCanvasContext.lineWidth=6,ae._VjCanvasContext.arc(t.x,t.y,40,0,Math.PI*2,!0),ae._VjCanvasContext.stroke(),ae._VjCanvasContext.closePath(),t.prevX=t.x,t.prevY=t.y)}),requestAnimationFrame(()=>{this._drawVirtualJoystick()}))}releaseCanvas(){ae.Canvas&&(ae.Canvas.removeEventListener("pointerdown",this._onPointerDownHandlerRef),ae.Canvas.removeEventListener("pointermove",this._onPointerMoveHandlerRef),ae.Canvas.removeEventListener("pointerup",this._onPointerUpHandlerRef),ae.Canvas.removeEventListener("pointerout",this._onPointerUpHandlerRef),ae.Canvas.removeEventListener("pointercancel",this._onPointerUpHandlerRef),window.removeEventListener("resize",this._onResize),document.body.removeChild(ae.Canvas),ae.Canvas=null),this._released=!0}}ae._GlobalJoystickIndex=0;ae._AlwaysVisibleSticks=0;Yu.prototype.addVirtualJoystick=function(){return this.add(new JI),this};class JI{getLeftJoystick(){return this._leftjoystick}getRightJoystick(){return this._rightjoystick}checkInputs(){if(this._leftjoystick){const e=this.camera,t=e._computeLocalCameraSpeed()*50,i=z.RotationYawPitchRoll(e.rotation.y,e.rotation.x,0),r=x.TransformCoordinates(new x(this._leftjoystick.deltaPosition.x*t,this._leftjoystick.deltaPosition.y*t,this._leftjoystick.deltaPosition.z*t),i);e.cameraDirection=e.cameraDirection.add(r),e.cameraRotation=e.cameraRotation.addVector3(this._rightjoystick.deltaPosition),this._leftjoystick.pressed||(this._leftjoystick.deltaPosition=this._leftjoystick.deltaPosition.scale(.9)),this._rightjoystick.pressed||(this._rightjoystick.deltaPosition=this._rightjoystick.deltaPosition.scale(.9))}}attachControl(){this._leftjoystick=new ae(!0),this._leftjoystick.setAxisForUpDown(2),this._leftjoystick.setAxisForLeftRight(0),this._leftjoystick.setJoystickSensibility(.15),this._rightjoystick=new ae(!1),this._rightjoystick.setAxisForUpDown(0),this._rightjoystick.setAxisForLeftRight(1),this._rightjoystick.reverseUpDown=!0,this._rightjoystick.setJoystickSensibility(.05),this._rightjoystick.setJoystickColor("yellow")}detachControl(){this._leftjoystick.releaseCanvas(),this._rightjoystick.releaseCanvas()}getClassName(){return"FreeCameraVirtualJoystickInput"}getSimpleName(){return"virtualJoystick"}}lr.FreeCameraVirtualJoystickInput=JI;class KF extends Kl{getClassName(){return"GeospatialCameraMouseWheelInput"}checkInputs(){this.camera._perFrameZoom=this._wheelDeltaY,super.checkInputs()}}lr.GeospatialCameraMouseWheelInput=KF;class xr extends Lo{get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysUpward(){const e=this.inputs.attached.keyboard;return e?e.keysUpward:[]}set keysUpward(e){const t=this.inputs.attached.keyboard;t&&(t.keysUpward=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysDownward(){const e=this.inputs.attached.keyboard;return e?e.keysDownward:[]}set keysDownward(e){const t=this.inputs.attached.keyboard;t&&(t.keysDownward=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get keysRotateLeft(){const e=this.inputs.attached.keyboard;return e?e.keysRotateLeft:[]}set keysRotateLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateLeft=e)}get keysRotateRight(){const e=this.inputs.attached.keyboard;return e?e.keysRotateRight:[]}set keysRotateRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateRight=e)}get keysRotateUp(){const e=this.inputs.attached.keyboard;return e?e.keysRotateUp:[]}set keysRotateUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateUp=e)}get keysRotateDown(){const e=this.inputs.attached.keyboard;return e?e.keysRotateDown:[]}set keysRotateDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateDown=e)}constructor(e,t,i,r=!0){super(e,t,i,r),this.ellipsoid=new x(.5,1,.5),this.ellipsoidOffset=new x(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this._needMoveForGravity=!1,this._oldPosition=x.Zero(),this._diffPosition=x.Zero(),this._newPosition=x.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(n,a,o=null)=>{this._newPosition.copyFrom(a),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>te.CollisionsEpsilon&&(this.position.addToRef(this._diffPosition,this._deferredPositionUpdate),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate),this.onCollide&&o&&this.onCollide(o))},this.inputs=new Yu(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=j.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new x(0,0,0),this.cameraRotation=new X(0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;this.parent?t=x.TransformCoordinates(this.position,this.parent.getWorldMatrix()):t=this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let r=e;this.applyGravity&&(r=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,r,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=x.Zero(),this._transformedDirection=x.Zero()),this.inputs.checkInputs(),super._checkInputs()}set needMoveForGravity(e){this._needMoveForGravity=e}get needMoveForGravity(){return this._needMoveForGravity}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FreeCamera"}}_([Cn()],xr.prototype,"ellipsoid",void 0);_([Cn()],xr.prototype,"ellipsoidOffset",void 0);_([R()],xr.prototype,"checkCollisions",void 0);_([R()],xr.prototype,"applyGravity",void 0);y("BABYLON.FreeCamera",xr);fi.AddNodeConstructor("TouchCamera",(s,e)=>()=>new eR(s,x.Zero(),e));class eR extends xr{get touchAngularSensibility(){const e=this.inputs.attached.touch;return e?e.touchAngularSensibility:0}set touchAngularSensibility(e){const t=this.inputs.attached.touch;t&&(t.touchAngularSensibility=e)}get touchMoveSensibility(){const e=this.inputs.attached.touch;return e?e.touchMoveSensibility:0}set touchMoveSensibility(e){const t=this.inputs.attached.touch;t&&(t.touchMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addTouch(),this._setupInputs()}getClassName(){return"TouchCamera"}_setupInputs(){const e=this.inputs.attached.touch,t=this.inputs.attached.mouse;t?t.touchEnabled=!e:e.allowMouse=!t}}fi.AddNodeConstructor("DeviceOrientationCamera",(s,e)=>()=>new i_(s,x.Zero(),e));class i_ extends xr{constructor(e,t,i){super(e,t,i),this._tmpDragQuaternion=new Z,this._disablePointerInputWhenUsingDeviceOrientation=!0,this._dragFactor=0,this._quaternionCache=new Z,this.inputs.addDeviceOrientation(),this.inputs._deviceOrientationInput&&this.inputs._deviceOrientationInput._onDeviceOrientationChangedObservable.addOnce(()=>{this._disablePointerInputWhenUsingDeviceOrientation&&this.inputs._mouseInput&&(this.inputs._mouseInput._allowCameraRotation=!1,this.inputs._mouseInput.onPointerMovedObservable.add(r=>{this._dragFactor!=0&&(this._initialQuaternion||(this._initialQuaternion=new Z),Z.FromEulerAnglesToRef(0,r.offsetX*this._dragFactor,0,this._tmpDragQuaternion),this._initialQuaternion.multiplyToRef(this._tmpDragQuaternion,this._initialQuaternion))}))})}get disablePointerInputWhenUsingDeviceOrientation(){return this._disablePointerInputWhenUsingDeviceOrientation}set disablePointerInputWhenUsingDeviceOrientation(e){this._disablePointerInputWhenUsingDeviceOrientation=e}enableHorizontalDragging(e=1/300){this._dragFactor=e}getClassName(){return"DeviceOrientationCamera"}_checkInputs(){super._checkInputs(),this._quaternionCache.copyFrom(this.rotationQuaternion),this._initialQuaternion&&this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}resetToCurrentRotation(e=Ms.Y){if(!this.rotationQuaternion)return;this._initialQuaternion||(this._initialQuaternion=new Z),this._initialQuaternion.copyFrom(this._quaternionCache||this.rotationQuaternion);const t=["x","y","z"];for(const i of t)e[i]?this._initialQuaternion[i]*=-1:this._initialQuaternion[i]=0;this._initialQuaternion.normalize(),this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}}class JF extends Dm{constructor(e){super(e)}addKeyboard(){return this.add(new qn),this}addMouse(){return this.add(new Hu),this}}class Jl extends Lo{get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysForward(){const e=this.inputs.attached.keyboard;return e?e.keysForward:[]}set keysForward(e){const t=this.inputs.attached.keyboard;t&&(t.keysForward=e)}get keysBackward(){const e=this.inputs.attached.keyboard;return e?e.keysBackward:[]}set keysBackward(e){const t=this.inputs.attached.keyboard;t&&(t.keysBackward=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}constructor(e,t,i,r=!0){super(e,t,i,r),this.ellipsoid=new x(1,1,1),this.ellipsoidOffset=new x(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this.cameraDirection=x.Zero(),this._trackRoll=0,this.rollCorrect=100,this.bankedTurn=!1,this.bankedTurnLimit=Math.PI/2,this.bankedTurnMultiplier=1,this._needMoveForGravity=!1,this._oldPosition=x.Zero(),this._diffPosition=x.Zero(),this._newPosition=x.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(n,a,o=null)=>{(c=>{this._newPosition.copyFrom(c),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>te.CollisionsEpsilon&&(this.position.addInPlace(this._diffPosition),this.onCollide&&o&&this.onCollide(o))})(a)},this.inputs=new JF(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=j.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new x(0,0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;this.parent?t=x.TransformCoordinates(this.position,this.parent.getWorldMatrix()):t=this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let r=e;this.applyGravity&&(r=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,r,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=x.Zero(),this._transformedDirection=x.Zero()),this.inputs.checkInputs(),super._checkInputs()}set needMoveForGravity(e){this._needMoveForGravity=e}get needMoveForGravity(){return this._needMoveForGravity}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}restoreRoll(e){const t=this._trackRoll,i=this.rotation.z,r=t-i,n=.001;Math.abs(r)>=n&&(this.rotation.z+=r/e,Math.abs(t-this.rotation.z)<=n&&(this.rotation.z=t))}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FlyCamera"}}_([Cn()],Jl.prototype,"ellipsoid",void 0);_([Cn()],Jl.prototype,"ellipsoidOffset",void 0);_([R()],Jl.prototype,"checkCollisions",void 0);_([R()],Jl.prototype,"applyGravity",void 0);y("BABYLON.FlyCamera",Jl);class eL extends Dm{constructor(e){super(e)}addKeyboard(){return this.add(new Ci),this}addMouseWheel(){return this.add(new Fa),this}addPointers(){return this.add(new cr),this}addVRDeviceOrientation(){return N.Warn("DeviceOrientation support not yet implemented for FollowCamera."),this}}fi.AddNodeConstructor("FollowCamera",(s,e)=>()=>new br(s,x.Zero(),e));fi.AddNodeConstructor("ArcFollowCamera",(s,e)=>()=>new tR(s,0,0,1,null,e));class br extends Lo{constructor(e,t,i,r=null){super(e,t,i),this.radius=12,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.rotationOffset=0,this.lowerRotationOffsetLimit=null,this.upperRotationOffsetLimit=null,this.heightOffset=4,this.lowerHeightOffsetLimit=null,this.upperHeightOffsetLimit=null,this.cameraAcceleration=.05,this.maxCameraSpeed=20,this.lockedTarget=r,this.inputs=new eL(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_follow(e){if(!e)return;const t=G.Matrix[0];e.absoluteRotationQuaternion.toRotationMatrix(t);const i=Math.atan2(t.m[8],t.m[10]),r=j.ToRadians(this.rotationOffset)+i,n=e.getAbsolutePosition(),a=n.x+Math.sin(r)*this.radius,o=n.z+Math.cos(r)*this.radius,l=a-this.position.x,c=n.y+this.heightOffset-this.position.y,u=o-this.position.z;let h=l*this.cameraAcceleration*2,d=c*this.cameraAcceleration,f=u*this.cameraAcceleration*2;(h>this.maxCameraSpeed||h<-this.maxCameraSpeed)&&(h=h<1?-this.maxCameraSpeed:this.maxCameraSpeed),(d>this.maxCameraSpeed||d<-this.maxCameraSpeed)&&(d=d<1?-this.maxCameraSpeed:this.maxCameraSpeed),(f>this.maxCameraSpeed||f<-this.maxCameraSpeed)&&(f=f<1?-this.maxCameraSpeed:this.maxCameraSpeed),this.position=new x(this.position.x+h,this.position.y+d,this.position.z+f),this.setTarget(n)}attachControl(e,t){t=j.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t),this._reset=()=>{}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){this.inputs.checkInputs(),this._checkLimits(),super._checkInputs(),this.lockedTarget&&this._follow(this.lockedTarget)}_checkLimits(){this.lowerRadiusLimit!==null&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit),this.upperRadiusLimit!==null&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit),this.lowerHeightOffsetLimit!==null&&this.heightOffset<this.lowerHeightOffsetLimit&&(this.heightOffset=this.lowerHeightOffsetLimit),this.upperHeightOffsetLimit!==null&&this.heightOffset>this.upperHeightOffsetLimit&&(this.heightOffset=this.upperHeightOffsetLimit),this.lowerRotationOffsetLimit!==null&&this.rotationOffset<this.lowerRotationOffsetLimit&&(this.rotationOffset=this.lowerRotationOffsetLimit),this.upperRotationOffsetLimit!==null&&this.rotationOffset>this.upperRotationOffsetLimit&&(this.rotationOffset=this.upperRotationOffsetLimit)}getClassName(){return"FollowCamera"}}_([R()],br.prototype,"radius",void 0);_([R()],br.prototype,"lowerRadiusLimit",void 0);_([R()],br.prototype,"upperRadiusLimit",void 0);_([R()],br.prototype,"rotationOffset",void 0);_([R()],br.prototype,"lowerRotationOffsetLimit",void 0);_([R()],br.prototype,"upperRotationOffsetLimit",void 0);_([R()],br.prototype,"heightOffset",void 0);_([R()],br.prototype,"lowerHeightOffsetLimit",void 0);_([R()],br.prototype,"upperHeightOffsetLimit",void 0);_([R()],br.prototype,"cameraAcceleration",void 0);_([R()],br.prototype,"maxCameraSpeed",void 0);_([Mm("lockedTargetId")],br.prototype,"lockedTarget",void 0);class tR extends Lo{constructor(e,t,i,r,n,a){super(e,x.Zero(),a),this.alpha=t,this.beta=i,this.radius=r,this._cartesianCoordinates=x.Zero(),this.setMeshTarget(n)}setMeshTarget(e){this._meshTarget=e,this._follow()}_follow(){if(!this._meshTarget)return;this._cartesianCoordinates.x=this.radius*Math.cos(this.alpha)*Math.cos(this.beta),this._cartesianCoordinates.y=this.radius*Math.sin(this.beta),this._cartesianCoordinates.z=this.radius*Math.sin(this.alpha)*Math.cos(this.beta);const e=this._meshTarget.getAbsolutePosition();this.position=e.add(this._cartesianCoordinates),this.setTarget(e)}_checkInputs(){super._checkInputs(),this._follow()}getClassName(){return"ArcFollowCamera"}}y("BABYLON.FollowCamera",br);y("BABYLON.ArcFollowCamera",tR);var Gg;(function(s){s[s.A=0]="A",s[s.B=1]="B",s[s.X=2]="X",s[s.Y=3]="Y",s[s.LB=4]="LB",s[s.RB=5]="RB",s[s.Back=8]="Back",s[s.Start=9]="Start",s[s.LeftStick=10]="LeftStick",s[s.RightStick=11]="RightStick"})(Gg||(Gg={}));var zg;(function(s){s[s.Up=12]="Up",s[s.Down=13]="Down",s[s.Left=14]="Left",s[s.Right=15]="Right"})(zg||(zg={}));class tL extends ci{constructor(e,t,i,r=!1){super(e,t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new k,this.onButtonUpObservable=new k,this.onPadDownObservable=new k,this.onPadUpObservable=new k,this._buttonA=0,this._buttonB=0,this._buttonX=0,this._buttonY=0,this._buttonBack=0,this._buttonStart=0,this._buttonLb=0,this._buttonRb=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this._isXboxOnePad=!1,this.type=ci.XBOX,this._isXboxOnePad=r}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),e===0&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDpadValue(e,t,i){return e!==t&&(e===1&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),e===0&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonA(){return this._buttonA}set buttonA(e){this._buttonA=this._setButtonValue(e,this._buttonA,0)}get buttonB(){return this._buttonB}set buttonB(e){this._buttonB=this._setButtonValue(e,this._buttonB,1)}get buttonX(){return this._buttonX}set buttonX(e){this._buttonX=this._setButtonValue(e,this._buttonX,2)}get buttonY(){return this._buttonY}set buttonY(e){this._buttonY=this._setButtonValue(e,this._buttonY,3)}get buttonStart(){return this._buttonStart}set buttonStart(e){this._buttonStart=this._setButtonValue(e,this._buttonStart,9)}get buttonBack(){return this._buttonBack}set buttonBack(e){this._buttonBack=this._setButtonValue(e,this._buttonBack,8)}get buttonLB(){return this._buttonLb}set buttonLB(e){this._buttonLb=this._setButtonValue(e,this._buttonLb,4)}get buttonRB(){return this._buttonRb}set buttonRB(e){this._buttonRb=this._setButtonValue(e,this._buttonRb,5)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,10)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,11)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDpadValue(e,this._dPadUp,12)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDpadValue(e,this._dPadDown,13)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDpadValue(e,this._dPadLeft,14)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDpadValue(e,this._dPadRight,15)}update(){super.update(),this._isXboxOnePad?(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value):(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}var Wg;(function(s){s[s.Cross=0]="Cross",s[s.Circle=1]="Circle",s[s.Square=2]="Square",s[s.Triangle=3]="Triangle",s[s.L1=4]="L1",s[s.R1=5]="R1",s[s.Share=8]="Share",s[s.Options=9]="Options",s[s.LeftStick=10]="LeftStick",s[s.RightStick=11]="RightStick"})(Wg||(Wg={}));var Hg;(function(s){s[s.Up=12]="Up",s[s.Down=13]="Down",s[s.Left=14]="Left",s[s.Right=15]="Right"})(Hg||(Hg={}));class iL extends ci{constructor(e,t,i){super(e.replace("STANDARD GAMEPAD","SONY PLAYSTATION DUALSHOCK"),t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new k,this.onButtonUpObservable=new k,this.onPadDownObservable=new k,this.onPadUpObservable=new k,this._buttonCross=0,this._buttonCircle=0,this._buttonSquare=0,this._buttonTriangle=0,this._buttonShare=0,this._buttonOptions=0,this._buttonL1=0,this._buttonR1=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this.type=ci.DUALSHOCK}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),e===0&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDpadValue(e,t,i){return e!==t&&(e===1&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),e===0&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonCross(){return this._buttonCross}set buttonCross(e){this._buttonCross=this._setButtonValue(e,this._buttonCross,0)}get buttonCircle(){return this._buttonCircle}set buttonCircle(e){this._buttonCircle=this._setButtonValue(e,this._buttonCircle,1)}get buttonSquare(){return this._buttonSquare}set buttonSquare(e){this._buttonSquare=this._setButtonValue(e,this._buttonSquare,2)}get buttonTriangle(){return this._buttonTriangle}set buttonTriangle(e){this._buttonTriangle=this._setButtonValue(e,this._buttonTriangle,3)}get buttonOptions(){return this._buttonOptions}set buttonOptions(e){this._buttonOptions=this._setButtonValue(e,this._buttonOptions,9)}get buttonShare(){return this._buttonShare}set buttonShare(e){this._buttonShare=this._setButtonValue(e,this._buttonShare,8)}get buttonL1(){return this._buttonL1}set buttonL1(e){this._buttonL1=this._setButtonValue(e,this._buttonL1,4)}get buttonR1(){return this._buttonR1}set buttonR1(e){this._buttonR1=this._setButtonValue(e,this._buttonR1,5)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,10)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,11)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDpadValue(e,this._dPadUp,12)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDpadValue(e,this._dPadDown,13)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDpadValue(e,this._dPadLeft,14)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDpadValue(e,this._dPadRight,15)}update(){super.update(),this.buttonCross=this.browserGamepad.buttons[0].value,this.buttonCircle=this.browserGamepad.buttons[1].value,this.buttonSquare=this.browserGamepad.buttons[2].value,this.buttonTriangle=this.browserGamepad.buttons[3].value,this.buttonL1=this.browserGamepad.buttons[4].value,this.buttonR1=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonShare=this.browserGamepad.buttons[8].value,this.buttonOptions=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}class rL{constructor(e){if(this._scene=e,this._babylonGamepads=[],this._oneGamepadConnected=!1,this._isMonitoring=!1,this.onGamepadDisconnectedObservable=new k,Fm()?(this._gamepadEventSupported="GamepadEvent"in window,this._gamepadSupport=navigator&&navigator.getGamepads):this._gamepadEventSupported=!1,this.onGamepadConnectedObservable=new k(t=>{for(const i in this._babylonGamepads){const r=this._babylonGamepads[i];r&&r._isConnected&&this.onGamepadConnectedObservable.notifyObserver(t,r)}}),this._onGamepadConnectedEvent=t=>{const i=t.gamepad;if(i.index in this._babylonGamepads&&this._babylonGamepads[i.index].isConnected)return;let r;this._babylonGamepads[i.index]?(r=this._babylonGamepads[i.index],r.browserGamepad=i,r._isConnected=!0):r=this._addNewGamepad(i),this.onGamepadConnectedObservable.notifyObservers(r),this._startMonitoringGamepads()},this._onGamepadDisconnectedEvent=t=>{const i=t.gamepad;for(const r in this._babylonGamepads)if(this._babylonGamepads[r].index===i.index){const n=this._babylonGamepads[r];n._isConnected=!1,this.onGamepadDisconnectedObservable.notifyObservers(n),n.dispose&&n.dispose();break}},this._gamepadSupport)if(this._updateGamepadObjects(),this._babylonGamepads.length&&this._startMonitoringGamepads(),this._gamepadEventSupported){const t=this._scene?this._scene.getEngine().getHostWindow():window;t&&(t.addEventListener("gamepadconnected",this._onGamepadConnectedEvent,!1),t.addEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent,!1))}else this._startMonitoringGamepads()}get gamepads(){return this._babylonGamepads}getGamepadByType(e=ci.XBOX){for(const t of this._babylonGamepads)if(t&&t.type===e)return t;return null}dispose(){this._gamepadEventSupported&&(this._onGamepadConnectedEvent&&window.removeEventListener("gamepadconnected",this._onGamepadConnectedEvent),this._onGamepadDisconnectedEvent&&window.removeEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent),this._onGamepadConnectedEvent=null,this._onGamepadDisconnectedEvent=null);for(const e of this._babylonGamepads)e.dispose();this.onGamepadConnectedObservable.clear(),this.onGamepadDisconnectedObservable.clear(),this._oneGamepadConnected=!1,this._stopMonitoringGamepads(),this._babylonGamepads=[]}_addNewGamepad(e){this._oneGamepadConnected||(this._oneGamepadConnected=!0);let t;const i=e.id.search("054c")!==-1&&e.id.search("0ce6")===-1,r=e.id.search("Xbox One")!==-1;return r||e.id.search("Xbox 360")!==-1||e.id.search("xinput")!==-1||e.id.search("045e")!==-1&&e.id.search("Surface Dock")===-1?t=new tL(e.id,e.index,e,r):i?t=new iL(e.id,e.index,e):t=new QF(e.id,e.index,e),this._babylonGamepads[t.index]=t,t}_startMonitoringGamepads(){this._isMonitoring||(this._isMonitoring=!0,this._checkGamepadsStatus())}_stopMonitoringGamepads(){this._isMonitoring=!1}_checkGamepadsStatus(){this._updateGamepadObjects();for(const e in this._babylonGamepads){const t=this._babylonGamepads[e];if(!(!t||!t.isConnected))try{t.update()}catch{this._loggedErrors.indexOf(t.index)===-1&&(j.Warn(`Error updating gamepad ${t.id}`),this._loggedErrors.push(t.index))}}this._isMonitoring&&te.QueueNewFrame(()=>{this._checkGamepadsStatus()})}_updateGamepadObjects(){const e=navigator.getGamepads?navigator.getGamepads():[];for(let t=0;t<e.length;t++){const i=e[t];if(i)if(this._babylonGamepads[i.index])this._babylonGamepads[t].browserGamepad=i,this._babylonGamepads[t].isConnected||(this._babylonGamepads[t]._isConnected=!0,this.onGamepadConnectedObservable.notifyObservers(this._babylonGamepads[t]));else{const r=this._addNewGamepad(i);this.onGamepadConnectedObservable.notifyObservers(r)}}}}Object.defineProperty(le.prototype,"gamepadManager",{get:function(){if(!this._gamepadManager){this._gamepadManager=new rL(this);let s=this._getComponent(se.NAME_GAMEPAD);s||(s=new sL(this),this._addComponent(s))}return this._gamepadManager},enumerable:!0,configurable:!0});Yu.prototype.addGamepad=function(){return this.add(new ju),this};Zy.prototype.addGamepad=function(){return this.add(new Wu),this};class sL{constructor(e){this.name=se.NAME_GAMEPAD,this.scene=e}register(){}rebuild(){}dispose(){const e=this.scene._gamepadManager;e&&(e.dispose(),this.scene._gamepadManager=null)}}fi.AddNodeConstructor("FreeCamera",(s,e)=>()=>new zo(s,x.Zero(),e));class zo extends eR{get gamepadAngularSensibility(){const e=this.inputs.attached.gamepad;return e?e.gamepadAngularSensibility:0}set gamepadAngularSensibility(e){const t=this.inputs.attached.gamepad;t&&(t.gamepadAngularSensibility=e)}get gamepadMoveSensibility(){const e=this.inputs.attached.gamepad;return e?e.gamepadMoveSensibility:0}set gamepadMoveSensibility(e){const t=this.inputs.attached.gamepad;t&&(t.gamepadMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addGamepad()}getClassName(){return"UniversalCamera"}}dt._CreateDefaultParsedCamera=(s,e)=>new zo(s,x.Zero(),e);fi.AddNodeConstructor("GamepadCamera",(s,e)=>()=>new r_(s,x.Zero(),e));class r_ extends zo{constructor(e,t,i){super(e,t,i)}getClassName(){return"GamepadCamera"}}class Bs extends gt{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(U(()=>Promise.resolve().then(()=>zX),void 0))):t.push(U(()=>Promise.resolve().then(()=>kX),void 0))}constructor(e,t=null,i){super({...i,name:e,engine:t||ft.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Bs.FragmentUrl,samplers:Bs.Samplers})}}Bs.FragmentUrl="anaglyph";Bs.Samplers=["leftSampler"];class iR extends Se{getClassName(){return"AnaglyphPostProcess"}constructor(e,t,i,r,n,a){const o={samplers:Bs.Samplers,size:typeof t=="number"?t:void 0,camera:i[1],samplingMode:r,engine:n,reusable:a,...t};super(e,Bs.FragmentUrl,{effectWrapper:typeof t=="number"||!t.effectWrapper?new Bs(e,n,o):void 0,...o}),this._passedProcess=i[0]._rigPostProcess,this.onApplyObservable.add(l=>{l.setTextureFromPostProcess("leftSampler",this._passedProcess)})}}y("BABYLON.AnaglyphPostProcess",iR);function qu(s){s._rigCameras[0]._rigPostProcess=new Uo(s.name+"_passthru",1,s._rigCameras[0]),s._rigCameras[1]._rigPostProcess=new iR(s.name+"_anaglyph",1,s._rigCameras)}fi.AddNodeConstructor("AnaglyphArcRotateCamera",(s,e,t)=>()=>new nL(s,0,0,1,x.Zero(),t.interaxial_distance,e));class nL extends wo{constructor(e,t,i,r,n,a,o){super(e,t,i,r,n,o),this._setRigMode=()=>qu(this),this.interaxialDistance=a,this.setCameraRigMode(dt.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:a})}getClassName(){return"AnaglyphArcRotateCamera"}}fi.AddNodeConstructor("AnaglyphFreeCamera",(s,e,t)=>()=>new aL(s,x.Zero(),t.interaxial_distance,e));class aL extends xr{constructor(e,t,i,r){super(e,t,r),this._setRigMode=()=>qu(this),this.interaxialDistance=i,this.setCameraRigMode(dt.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphFreeCamera"}}fi.AddNodeConstructor("AnaglyphGamepadCamera",(s,e,t)=>()=>new oL(s,x.Zero(),t.interaxial_distance,e));class oL extends r_{constructor(e,t,i,r){super(e,t,r),this._setRigMode=()=>qu(this),this.interaxialDistance=i,this.setCameraRigMode(dt.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphGamepadCamera"}}fi.AddNodeConstructor("AnaglyphUniversalCamera",(s,e,t)=>()=>new lL(s,x.Zero(),t.interaxial_distance,e));class lL extends zo{constructor(e,t,i,r){super(e,t,r),this._setRigMode=()=>qu(this),this.interaxialDistance=i,this.setCameraRigMode(dt.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphUniversalCamera"}}const $g="stereoscopicInterlacePixelShader",cL=`const vec3 TWO=vec3(2.0,2.0,2.0);varying vec2 vUV;uniform sampler2D camASampler;uniform sampler2D textureSampler;uniform vec2 stepSize;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{bool useCamA;bool useCamB;vec2 texCoord1;vec2 texCoord2;vec3 frag1;vec3 frag2;
#ifdef IS_STEREOSCOPIC_HORIZ
useCamB=vUV.x>0.5;useCamA=!useCamB;texCoord1=vec2(useCamB ? (vUV.x-0.5)*2.0 : vUV.x*2.0,vUV.y);texCoord2=vec2(texCoord1.x+stepSize.x,vUV.y);
#else
#ifdef IS_STEREOSCOPIC_INTERLACED
float rowNum=floor(vUV.y/stepSize.y);useCamA=mod(rowNum,2.0)==1.0;useCamB=mod(rowNum,2.0)==0.0;texCoord1=vec2(vUV.x,vUV.y);texCoord2=vec2(vUV.x,vUV.y);
#else
useCamB=vUV.y>0.5;useCamA=!useCamB;texCoord1=vec2(vUV.x,useCamB ? (vUV.y-0.5)*2.0 : vUV.y*2.0);texCoord2=vec2(vUV.x,texCoord1.y+stepSize.y);
#endif
#endif
if (useCamB){frag1=texture2D(textureSampler,texCoord1).rgb;frag2=texture2D(textureSampler,texCoord2).rgb;}else if (useCamA){frag1=texture2D(camASampler ,texCoord1).rgb;frag2=texture2D(camASampler ,texCoord2).rgb;}else {discard;}
gl_FragColor=vec4((frag1+frag2)/TWO,1.0);}
`;S.ShadersStore[$g]||(S.ShadersStore[$g]=cL);class uL extends Se{getClassName(){return"StereoscopicInterlacePostProcessI"}constructor(e,t,i,r,n,a,o){super(e,"stereoscopicInterlace",["stepSize"],["camASampler"],1,t[1],n,a,o,r?"#define IS_STEREOSCOPIC_INTERLACED 1":i?"#define IS_STEREOSCOPIC_HORIZ 1":void 0),this._passedProcess=t[0]._rigPostProcess,this._stepSize=new X(1/this.width,1/this.height),this.onSizeChangedObservable.add(()=>{this._stepSize=new X(1/this.width,1/this.height)}),this.onApplyObservable.add(l=>{l.setTextureFromPostProcess("camASampler",this._passedProcess),l.setFloat2("stepSize",this._stepSize.x,this._stepSize.y)})}}function Zu(s){const e=s.cameraRigMode===dt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL||s.cameraRigMode===dt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED,t=s.cameraRigMode===dt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED;s.cameraRigMode===dt.RIG_MODE_STEREOSCOPIC_INTERLACED?(s._rigCameras[0]._rigPostProcess=new Uo(s.name+"_passthru",1,s._rigCameras[0]),s._rigCameras[1]._rigPostProcess=new uL(s.name+"_stereoInterlace",s._rigCameras,!1,!0)):(s._rigCameras[t?1:0].viewport=new Hn(0,0,e?.5:1,e?1:.5),s._rigCameras[t?0:1].viewport=new Hn(e?.5:0,e?0:.5,e?.5:1,e?1:.5))}fi.AddNodeConstructor("StereoscopicArcRotateCamera",(s,e,t)=>()=>new hL(s,0,0,1,x.Zero(),t.interaxial_distance,t.isStereoscopicSideBySide,e));class hL extends wo{constructor(e,t,i,r,n,a,o,l){super(e,t,i,r,n,l),this._setRigMode=()=>Zu(this),this.interaxialDistance=a,this.isStereoscopicSideBySide=o,this.setCameraRigMode(o?dt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:dt.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:a})}getClassName(){return"StereoscopicArcRotateCamera"}}fi.AddNodeConstructor("StereoscopicFreeCamera",(s,e,t)=>()=>new dL(s,x.Zero(),t.interaxial_distance,t.isStereoscopicSideBySide,e));class dL extends xr{constructor(e,t,i,r,n){super(e,t,n),this._setRigMode=()=>Zu(this),this.interaxialDistance=i,this.isStereoscopicSideBySide=r,this.setCameraRigMode(r?dt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:dt.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicFreeCamera"}}fi.AddNodeConstructor("StereoscopicGamepadCamera",(s,e,t)=>()=>new fL(s,x.Zero(),t.interaxial_distance,t.isStereoscopicSideBySide,e));class fL extends r_{constructor(e,t,i,r,n){super(e,t,n),this._setRigMode=()=>Zu(this),this.interaxialDistance=i,this.isStereoscopicSideBySide=r,this.setCameraRigMode(r?dt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:dt.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicGamepadCamera"}}fi.AddNodeConstructor("StereoscopicFreeCamera",(s,e,t)=>()=>new pL(s,x.Zero(),t.interaxial_distance,t.isStereoscopicSideBySide,e));class pL extends zo{constructor(e,t,i,r,n){super(e,t,n),this._setRigMode=()=>Zu(this),this.interaxialDistance=i,this.isStereoscopicSideBySide=r,this.setCameraRigMode(r?dt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:dt.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicUniversalCamera"}}fi.AddNodeConstructor("VirtualJoysticksCamera",(s,e)=>()=>new mL(s,x.Zero(),e));class mL extends xr{constructor(e,t,i){super(e,t,i),this.inputs.addVirtualJoystick()}getClassName(){return"VirtualJoysticksCamera"}}class Wo{constructor(){this.compensateDistortion=!0,this.multiviewEnabled=!1}get aspectRatio(){return this.hResolution/(2*this.vResolution)}get aspectRatioFov(){return 2*Math.atan(this.postProcessScaleFactor*this.vScreenSize/(2*this.eyeToScreenDistance))}get leftHMatrix(){const t=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return z.Translation(t,0,0)}get rightHMatrix(){const t=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return z.Translation(-t,0,0)}get leftPreViewMatrix(){return z.Translation(.5*this.interpupillaryDistance,0,0)}get rightPreViewMatrix(){return z.Translation(-.5*this.interpupillaryDistance,0,0)}static GetDefault(){const e=new Wo;return e.hResolution=1280,e.vResolution=800,e.hScreenSize=.149759993,e.vScreenSize=.0935999975,e.vScreenCenter=.0467999987,e.eyeToScreenDistance=.0410000011,e.lensSeparationDistance=.063500002,e.interpupillaryDistance=.064000003,e.distortionK=[1,.219999999,.239999995,0],e.chromaAbCorrection=[.995999992,-.00400000019,1.01400006,0],e.postProcessScaleFactor=1.714605507808412,e.lensCenterOffset=.151976421,e}}class Xg extends Se{getClassName(){return"VRDistortionCorrectionPostProcess"}constructor(e,t,i,r){super(e,"vrDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,r.postProcessScaleFactor,t,$.BILINEAR_SAMPLINGMODE),this._isRightEye=i,this._distortionFactors=r.distortionK,this._postProcessScaleFactor=r.postProcessScaleFactor,this._lensCenterOffset=r.lensCenterOffset,this.adaptScaleToCurrentViewport=!0,this.onSizeChangedObservable.add(()=>{this._scaleIn=new X(2,2/this.aspectRatio),this._scaleFactor=new X(.5*(1/this._postProcessScaleFactor),.5*(1/this._postProcessScaleFactor)*this.aspectRatio),this._lensCenter=new X(this._isRightEye?.5-this._lensCenterOffset*.5:.5+this._lensCenterOffset*.5,.5)}),this.onApplyObservable.add(n=>{n.setFloat2("LensCenter",this._lensCenter.x,this._lensCenter.y),n.setFloat2("Scale",this._scaleFactor.x,this._scaleFactor.y),n.setFloat2("ScaleIn",this._scaleIn.x,this._scaleIn.y),n.setFloat4("HmdWarpParam",this._distortionFactors[0],this._distortionFactors[1],this._distortionFactors[2],this._distortionFactors[3])})}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(U(()=>Promise.resolve().then(()=>K$),void 0))):t.push(U(()=>Promise.resolve().then(()=>Z$),void 0)),super._gatherImports(e,t)}}const Yg="vrMultiviewToSingleviewPixelShader",_L=`precision mediump sampler2DArray;varying vec2 vUV;uniform sampler2DArray multiviewSampler;uniform int imageIndex;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{gl_FragColor=texture2D(multiviewSampler,vec3(vUV,imageIndex));}`;S.ShadersStore[Yg]||(S.ShadersStore[Yg]=_L);class md extends Zi{set samples(e){this._samples=e}get samples(){return this._samples}constructor(e,t=512){super("multiview rtt",t,e,!1,!0,0,!1,void 0,!1,!1,!0,void 0,!0),this._renderTarget=this.getScene().getEngine().createMultiviewRenderTargetTexture(this.getRenderWidth(),this.getRenderHeight()),this._texture=this._renderTarget.texture,this._texture.isMultiview=!0,this._texture.format=5,this.samples=this._getEngine().getCaps().maxSamples||this.samples,this._texture.samples=this._samples}_bindFrameBuffer(){this._renderTarget&&this.getScene().getEngine().bindMultiviewFramebuffer(this._renderTarget)}getViewCount(){return 2}}ft.prototype.createMultiviewRenderTargetTexture=function(s,e,t,i){const r=this._gl;if(!this.getCaps().multiview)throw"Multiview is not supported";const n=this._createHardwareRenderTargetWrapper(!1,!1,{width:s,height:e});n._framebuffer=r.createFramebuffer();const a=new $t(this,0,!0);return a.width=s,a.height=e,a.isMultiview=!0,t||(t=r.createTexture(),r.bindTexture(r.TEXTURE_2D_ARRAY,t),r.texStorage3D(r.TEXTURE_2D_ARRAY,1,r.RGBA8,s,e,2)),n._colorTextureArray=t,i||(i=r.createTexture(),r.bindTexture(r.TEXTURE_2D_ARRAY,i),r.texStorage3D(r.TEXTURE_2D_ARRAY,1,r.DEPTH24_STENCIL8,s,e,2)),n._depthStencilTextureArray=i,a.isReady=!0,n.setTextures(a),n._depthStencilTexture=a,n};ft.prototype.bindMultiviewFramebuffer=function(s){const e=s,t=this._gl,i=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(e,void 0,void 0,void 0,!0),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer),e._colorTextureArray&&e._depthStencilTextureArray)this.getCaps().oculusMultiview?(i.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,e.samples,0,2),i.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,e.samples,0,2)):(i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,0,2),i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,0,2));else throw"Invalid multiview frame buffer"};ft.prototype.bindSpaceWarpFramebuffer=function(s){const e=s,t=this._gl,i=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(e,void 0,void 0,void 0,!0),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer),e._colorTextureArray&&e._depthStencilTextureArray)i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,0,2),i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_ATTACHMENT,e._depthStencilTextureArray,0,0,2);else throw new Error("Invalid Space Warp framebuffer")};dt.prototype._useMultiviewToSingleView=!1;dt.prototype._multiviewTexture=null;dt.prototype._resizeOrCreateMultiviewTexture=function(s,e){this._multiviewTexture?(this._multiviewTexture.getRenderWidth()!=s||this._multiviewTexture.getRenderHeight()!=e)&&(this._multiviewTexture.dispose(),this._multiviewTexture=new md(this.getScene(),{width:s,height:e})):this._multiviewTexture=new md(this.getScene(),{width:s,height:e})};function rR(s,e,t){const i=new hn(s,void 0,!0,e,void 0,t);return i.addUniform("viewProjection",16),i.addUniform("viewProjectionR",16),i.addUniform("view",16),i.addUniform("projection",16),i.addUniform("vEyePosition",4),i}const gL=le.prototype.createSceneUniformBuffer;le.prototype._transformMatrixR=z.Zero();le.prototype._multiviewSceneUbo=null;le.prototype._createMultiviewUbo=function(){this._multiviewSceneUbo=rR(this.getEngine(),"scene_multiview")};le.prototype.createSceneUniformBuffer=function(s,e){return this._multiviewSceneUbo?rR(this.getEngine(),s,e):gL.bind(this)(s,e)};le.prototype._updateMultiviewUbo=function(s,e){s&&e&&s.multiplyToRef(e,this._transformMatrixR),s&&e&&(s.multiplyToRef(e,G.Matrix[0]),qN.GetRightPlaneToRef(G.Matrix[0],this._frustumPlanes[3])),this._multiviewSceneUbo&&(this._multiviewSceneUbo.updateMatrix("viewProjection",this.getTransformMatrix()),this._multiviewSceneUbo.updateMatrix("viewProjectionR",this._transformMatrixR),this._multiviewSceneUbo.updateMatrix("view",this._viewMatrix),this._multiviewSceneUbo.updateMatrix("projection",this._projectionMatrix))};le.prototype._renderMultiviewToSingleView=function(s){s._resizeOrCreateMultiviewTexture(s._rigPostProcess&&s._rigPostProcess&&s._rigPostProcess.width>0?s._rigPostProcess.width:this.getEngine().getRenderWidth(!0),s._rigPostProcess&&s._rigPostProcess&&s._rigPostProcess.height>0?s._rigPostProcess.height:this.getEngine().getRenderHeight(!0)),this._multiviewSceneUbo||this._createMultiviewUbo(),s.outputRenderTarget=s._multiviewTexture,this._renderForCamera(s),s.outputRenderTarget=null;for(let e=0;e<s._rigCameras.length;e++){const t=this.getEngine();this._activeCamera=s._rigCameras[e],t.setViewport(this._activeCamera.viewport),this.postProcessManager&&(this.postProcessManager._prepareFrame(),this.postProcessManager._finalizeFrame(this._activeCamera.isIntermediate))}};class SL extends Se{getClassName(){return"VRMultiviewToSingleviewPostProcess"}constructor(e,t,i){super(e,"vrMultiviewToSingleview",["imageIndex"],["multiviewSampler"],i,t,$.BILINEAR_SAMPLINGMODE);const r=t??this.getCamera();this.onSizeChangedObservable.add(()=>{}),this.onApplyObservable.add(n=>{r._scene.activeCamera&&r._scene.activeCamera.isLeftCamera?n.setInt("imageIndex",0):n.setInt("imageIndex",1),n.setTexture("multiviewSampler",r._multiviewTexture)})}}function s_(s,e){const t=e.vrCameraMetrics||Wo.GetDefault();s._rigCameras[0]._cameraRigParams.vrMetrics=t,s._rigCameras[0].viewport=new Hn(0,0,.5,1),s._rigCameras[0]._cameraRigParams.vrWorkMatrix=new z,s._rigCameras[0]._cameraRigParams.vrHMatrix=t.leftHMatrix,s._rigCameras[0]._cameraRigParams.vrPreViewMatrix=t.leftPreViewMatrix,s._rigCameras[0].getProjectionMatrix=s._rigCameras[0]._getVRProjectionMatrix,s._rigCameras[1]._cameraRigParams.vrMetrics=t,s._rigCameras[1].viewport=new Hn(.5,0,.5,1),s._rigCameras[1]._cameraRigParams.vrWorkMatrix=new z,s._rigCameras[1]._cameraRigParams.vrHMatrix=t.rightHMatrix,s._rigCameras[1]._cameraRigParams.vrPreViewMatrix=t.rightPreViewMatrix,s._rigCameras[1].getProjectionMatrix=s._rigCameras[1]._getVRProjectionMatrix,t.multiviewEnabled&&(s.getScene().getEngine().getCaps().multiview?(s._useMultiviewToSingleView=!0,s._rigPostProcess=new SL("VRMultiviewToSingleview",s,t.postProcessScaleFactor)):(N.Warn("Multiview is not supported, falling back to standard rendering"),t.multiviewEnabled=!1)),t.compensateDistortion&&(s._rigCameras[0]._rigPostProcess=new Xg("VR_Distort_Compensation_Left",s._rigCameras[0],!1,t),s._rigCameras[1]._rigPostProcess=new Xg("VR_Distort_Compensation_Right",s._rigCameras[1],!0,t))}fi.AddNodeConstructor("VRDeviceOrientationArcRotateCamera",(s,e)=>()=>new vL(s,0,0,1,x.Zero(),e));class vL extends wo{constructor(e,t,i,r,n,a,o=!0,l=Wo.GetDefault()){super(e,t,i,r,n,a),this._setRigMode=c=>s_(this,c),l.compensateDistortion=o,this.setCameraRigMode(dt.RIG_MODE_VR,{vrCameraMetrics:l}),this.inputs.addVRDeviceOrientation()}getClassName(){return"VRDeviceOrientationArcRotateCamera"}}fi.AddNodeConstructor("VRDeviceOrientationFreeCamera",(s,e)=>()=>new n_(s,x.Zero(),e));class n_ extends i_{constructor(e,t,i,r=!0,n=Wo.GetDefault()){super(e,t,i),this._setRigMode=a=>s_(this,a),n.compensateDistortion=r,this.setCameraRigMode(dt.RIG_MODE_VR,{vrCameraMetrics:n})}getClassName(){return"VRDeviceOrientationFreeCamera"}}fi.AddNodeConstructor("VRDeviceOrientationGamepadCamera",(s,e)=>()=>new xL(s,x.Zero(),e));class xL extends n_{constructor(e,t,i,r=!0,n=Wo.GetDefault()){super(e,t,i,r,n),this._setRigMode=a=>s_(this,a),this.inputs.addGamepad()}getClassName(){return"VRDeviceOrientationGamepadCamera"}}class a_{get isFixedFoveationSupported(){return this.layerType=="XRWebGLLayer"&&typeof this.layer.fixedFoveation=="number"}get fixedFoveation(){return this.isFixedFoveationSupported?this.layer.fixedFoveation:null}set fixedFoveation(e){if(this.isFixedFoveationSupported){const t=Math.max(0,Math.min(1,e||0));this.layer.fixedFoveation=t}}createRenderTargetTextureProvider(e){return this._rttWrapper=this._createRenderTargetTextureProvider(e),this._rttWrapper}dispose(){this._rttWrapper&&(this._rttWrapper.dispose(),this._rttWrapper=null)}constructor(e,t,i,r,n){this.getWidth=e,this.getHeight=t,this.layer=i,this.layerType=r,this._createRenderTargetTextureProvider=n,this._rttWrapper=null}}class o_{constructor(e,t){this._scene=e,this.layerWrapper=t,this._renderTargetTextures=new Array,this._engine=e.getEngine()}_createInternalTexture(e,t){const i=new $t(this._engine,0,!0);return i.width=e.width,i.height=e.height,i._hardwareTexture=new Su(t,this._engine._gl),i.isReady=!0,i}_createRenderTargetTexture(e,t,i,r,n,a){if(!this._engine)throw new Error("Engine is disposed");const o={width:e,height:t},l=a?new md(this._scene,o):new Zi("XR renderTargetTexture",o,this._scene),c=l.renderTarget;if(c._samples=l.samples,(i||!r)&&(c._framebuffer=i),r)if(a)c._colorTextureArray=r;else{const u=this._createInternalTexture(o,r);c.setTexture(u,0),l._texture=u}return n&&(a?c._depthStencilTextureArray=n:c._depthStencilTexture=this._createInternalTexture(o,n)),l.disableRescaling(),this._renderTargetTextures.push(l),l}_destroyRenderTargetTexture(e){this._renderTargetTextures.splice(this._renderTargetTextures.indexOf(e),1),e.dispose()}getFramebufferDimensions(){return this._framebufferDimensions}dispose(){for(const e of this._renderTargetTextures)e.dispose();this._renderTargetTextures.length=0}}class l_ extends a_{constructor(e){super(()=>e.framebufferWidth,()=>e.framebufferHeight,e,"XRWebGLLayer",t=>new EL(t.scene,this)),this.layer=e}}class EL extends o_{constructor(e,t){super(e,t),this.layerWrapper=t,this._layer=t.layer,this._framebufferDimensions={framebufferWidth:this._layer.framebufferWidth,framebufferHeight:this._layer.framebufferHeight}}trySetViewportForView(e,t){const i=this._layer.getViewport(t);if(!i)return!1;const r=this._framebufferDimensions.framebufferWidth,n=this._framebufferDimensions.framebufferHeight;return e.x=i.x/r,e.y=i.y/n,e.width=i.width/r,e.height=i.height/n,!0}getRenderTargetTextureForEye(e){const t=this._layer.framebufferWidth,i=this._layer.framebufferHeight,r=this._layer.framebuffer;return(!this._rtt||t!==this._framebufferDimensions.framebufferWidth||i!==this._framebufferDimensions.framebufferHeight||r!==this._framebuffer)&&(this._rtt=this._createRenderTargetTexture(t,i,r),this._framebufferDimensions.framebufferWidth=t,this._framebufferDimensions.framebufferHeight=i,this._framebuffer=r),this._rtt}getRenderTargetTextureForView(e){return this.getRenderTargetTextureForEye(e.eye)}}class Qu{static GetDefaults(e){const t=new Qu;return t.canvasOptions={antialias:!0,depth:!0,stencil:e?e.isStencilEnable:!0,alpha:!0,framebufferScaleFactor:1},t.newCanvasCssStyle="position:absolute; bottom:0px;right:0px;z-index:10;width:90%;height:100%;background-color: #000000;",t}}class TL{constructor(e,t=Qu.GetDefaults()){if(this._options=t,this._canvas=null,this._engine=null,this.xrLayer=null,this._xrLayerWrapper=null,this.onXRLayerInitObservable=new k,this._engine=e.scene.getEngine(),this._engine.onDisposeObservable.addOnce(()=>{this._engine=null}),t.canvasElement)this._setManagedOutputCanvas(t.canvasElement);else{const i=document.createElement("canvas");i.style.cssText=this._options.newCanvasCssStyle||"position:absolute; bottom:0px;right:0px;",this._setManagedOutputCanvas(i)}e.onXRSessionInit.add(()=>{this._addCanvas()}),e.onXRSessionEnded.add(()=>{this._removeCanvas()}),this._makeCanvasCompatible()}dispose(){this._removeCanvas(),this._setManagedOutputCanvas(null),this.onXRLayerInitObservable.clear()}_makeCanvasCompatible(){this._canvasCompatiblePromise=new Promise((e,t)=>{try{this.canvasContext&&this.canvasContext.makeXRCompatible?this.canvasContext.makeXRCompatible().then(()=>{e()},()=>{j.Warn("Error executing makeXRCompatible. This does not mean that the session will work incorrectly."),e()}):e()}catch(i){t(i)}})}async initializeXRLayerAsync(e){const t=()=>(this.xrLayer=new XRWebGLLayer(e,this.canvasContext,this._options.canvasOptions),this._xrLayerWrapper=new l_(this.xrLayer),this.onXRLayerInitObservable.notifyObservers(this.xrLayer),this.xrLayer);return await this._canvasCompatiblePromise.then(()=>{},()=>{}).then(()=>t())}_addCanvas(){this._canvas&&this._engine&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.appendChild(this._canvas),this.xrLayer?this._setCanvasSize(!0):this.onXRLayerInitObservable.addOnce(()=>{this._setCanvasSize(!0)})}_removeCanvas(){this._canvas&&this._engine&&document.body.contains(this._canvas)&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.removeChild(this._canvas),this._setCanvasSize(!1)}_setCanvasSize(e=!0,t=this._xrLayerWrapper){!this._canvas||!this._engine||(e?t&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=t.getWidth()+"px",this._canvas.style.height=t.getHeight()+"px"):this._engine.setSize(t.getWidth(),t.getHeight())):this._originalCanvasSize&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=this._originalCanvasSize.width+"px",this._canvas.style.height=this._originalCanvasSize.height+"px"):this._engine.setSize(this._originalCanvasSize.width,this._originalCanvasSize.height)))}_setManagedOutputCanvas(e){this._removeCanvas(),e?(this._originalCanvasSize={width:e.offsetWidth,height:e.offsetHeight},this._canvas=e,this.canvasContext=this._canvas.getContext("webgl2"),this.canvasContext||(this.canvasContext=this._canvas.getContext("webgl"))):(this._canvas=null,this.canvasContext=null)}}class bL extends a_{constructor(e){super(()=>e.framebufferWidth,()=>e.framebufferHeight,e,"XRWebGLLayer",t=>new CL(t,this)),this.layer=e}}class CL extends o_{constructor(e,t){super(e.scene,t),this.layerWrapper=t,this._nativeRTTProvider=navigator.xr.getNativeRenderTargetProvider(e.session,this._createRenderTargetTexture.bind(this),this._destroyRenderTargetTexture.bind(this)),this._nativeLayer=t.layer}trySetViewportForView(e){return e.x=0,e.y=0,e.width=1,e.height=1,!0}getRenderTargetTextureForEye(e){return this._nativeRTTProvider.getRenderTargetForEye(e)}getRenderTargetTextureForView(e){return this._nativeRTTProvider.getRenderTargetForEye(e.eye)}getFramebufferDimensions(){return{framebufferWidth:this._nativeLayer.framebufferWidth,framebufferHeight:this._nativeLayer.framebufferHeight}}}class yL{constructor(e){this._nativeRenderTarget=navigator.xr.getWebXRRenderTarget(e.scene.getEngine())}async initializeXRLayerAsync(e){return await this._nativeRenderTarget.initializeXRLayerAsync(e),this.xrLayer=this._nativeRenderTarget.xrLayer,this.xrLayer}dispose(){}}class Ku{get worldScalingFactor(){return this._worldScalingFactor}set worldScalingFactor(e){const t=this._worldScalingFactor;this._worldScalingFactor=e,this.onWorldScaleFactorChangedObservable.notifyObservers({previousScaleFactor:t,newScaleFactor:e})}constructor(e){this.scene=e,this.currentTimestamp=-1,this.defaultHeightCompensation=1.7,this.onXRFrameObservable=new k,this.onXRReferenceSpaceChanged=new k,this.onXRSessionEnded=new k,this.onXRSessionInit=new k,this.onXRReferenceSpaceInitialized=new k,this.onXRReady=new k,this.inXRFrameLoop=!1,this.inXRSession=!1,this._worldScalingFactor=1,this.onWorldScaleFactorChangedObservable=new k(void 0,!0),this._engine=e.getEngine(),this._onEngineDisposedObserver=this._engine.onDisposeObservable.addOnce(()=>{this._engine=null}),e.onDisposeObservable.addOnce(()=>{this.dispose()})}get referenceSpace(){return this._referenceSpace}set referenceSpace(e){this._referenceSpace=e,this.onXRReferenceSpaceChanged.notifyObservers(this._referenceSpace)}get sessionMode(){return this._sessionMode}dispose(){var e;this.inXRSession&&this.exitXRAsync(),this.onXRReady.clear(),this.onXRFrameObservable.clear(),this.onXRSessionEnded.clear(),this.onXRReferenceSpaceChanged.clear(),this.onXRSessionInit.clear(),this.onWorldScaleFactorChangedObservable.clear(),(e=this._engine)==null||e.onDisposeObservable.remove(this._onEngineDisposedObserver),this._engine=null}async exitXRAsync(){if(this.session&&this.inXRSession){this.inXRSession=!1;try{return await this.session.end()}catch{N.Warn("Could not end XR session.")}}}trySetViewportForView(e,t){var i;return((i=this._baseLayerRTTProvider)==null?void 0:i.trySetViewportForView(e,t))||!1}getRenderTargetTextureForEye(e){var t;return((t=this._baseLayerRTTProvider)==null?void 0:t.getRenderTargetTextureForEye(e))||null}getRenderTargetTextureForView(e){var t;return((t=this._baseLayerRTTProvider)==null?void 0:t.getRenderTargetTextureForView(e))||null}getWebXRRenderTarget(e){const t=this.scene.getEngine();return this._xrNavigator.xr.native?new yL(this):(e=e||Qu.GetDefaults(t),e.canvasElement=e.canvasElement||t.getRenderingCanvas()||void 0,new TL(this,e))}async initializeAsync(){if(this._xrNavigator=navigator,!this._xrNavigator.xr)throw new Error("WebXR not supported on this browser.")}async initializeSessionAsync(e="immersive-vr",t={}){const i=await this._xrNavigator.xr.requestSession(e,t);return this.session=i,this._sessionMode=e,this.inXRSession=!0,this.onXRSessionInit.notifyObservers(i),this.session.addEventListener("end",()=>{var r;this.inXRSession=!1,this.onXRSessionEnded.notifyObservers(null),this._engine&&(this._engine.framebufferDimensionsObject=null,this._engine.restoreDefaultFramebuffer(),this._engine.customAnimationFrameRequester=null,this._engine._renderLoop()),this.isNative&&((r=this._baseLayerRTTProvider)==null||r.dispose()),this._baseLayerRTTProvider=null,this._baseLayerWrapper=null},{once:!0}),this.session}async isSessionSupportedAsync(e){return await Ku.IsSessionSupportedAsync(e)}resetReferenceSpace(){this.referenceSpace=this.baseReferenceSpace}runXRRenderLoop(){var e;!this.inXRSession||!this._engine||(this._engine.customAnimationFrameRequester={requestAnimationFrame:t=>this.session.requestAnimationFrame(t),renderFunction:(t,i)=>{var r;if(!(!this.inXRSession||!this._engine)&&(this.currentFrame=i,this.currentTimestamp=t,i)){this.inXRFrameLoop=!0;const n=((r=this._baseLayerRTTProvider)==null?void 0:r.getFramebufferDimensions())||null;this._engine.framebufferDimensionsObject!==n&&(this._engine.framebufferDimensionsObject=n),this.onXRFrameObservable.notifyObservers(i),this._engine._renderLoop(),this._engine.framebufferDimensionsObject=null,this.inXRFrameLoop=!1}}},this._engine.framebufferDimensionsObject=((e=this._baseLayerRTTProvider)==null?void 0:e.getFramebufferDimensions())||null,this.onXRFrameObservable.addOnce(()=>{this.onXRReady.notifyObservers(this)}),typeof window<"u"&&window.cancelAnimationFrame&&window.cancelAnimationFrame(this._engine._frameHandler),this._engine._renderLoop())}async setReferenceSpaceTypeAsync(e="local-floor"){let t;try{t=await this.session.requestReferenceSpace(e)}catch(r){N.Error("XR.requestReferenceSpace failed for the following reason: "),N.Error(r),N.Log('Defaulting to universally-supported "viewer" reference space type.');try{const n=await this.session.requestReferenceSpace("viewer"),a=new XRRigidTransform({x:0,y:-this.defaultHeightCompensation,z:0});return n.getOffsetReferenceSpace(a)}catch(n){throw N.Error(n),'XR initialization failed: required "viewer" reference space type not supported.'}}const i=await this.session.requestReferenceSpace("viewer");return this.viewerReferenceSpace=i,this.referenceSpace=this.baseReferenceSpace=t,this.onXRReferenceSpaceInitialized.notifyObservers(t),this.referenceSpace}async updateRenderStateAsync(e){return await this.session.updateRenderState(e)}_setBaseLayerWrapper(e){var t,i;this.isNative&&((t=this._baseLayerRTTProvider)==null||t.dispose()),this._baseLayerWrapper=e,this._baseLayerRTTProvider=((i=this._baseLayerWrapper)==null?void 0:i.createRenderTargetTextureProvider(this))||null}_getBaseLayerWrapper(){return this._baseLayerWrapper}updateRenderState(e){e.baseLayer&&this._setBaseLayerWrapper(this.isNative?new bL(e.baseLayer):new l_(e.baseLayer)),this.session.updateRenderState(e)}static async IsSessionSupportedAsync(e){if(!navigator.xr)return!1;const t=navigator.xr.isSessionSupported||navigator.xr.supportsSession;if(t)try{const i=t.call(navigator.xr,e);return typeof i>"u"?!0:i}catch(i){return N.Warn(i),!1}else return!1}get isNative(){return this._xrNavigator.xr.native??!1}get currentFrameRate(){var e;return(e=this.session)==null?void 0:e.frameRate}get supportedFrameRates(){var e;return(e=this.session)==null?void 0:e.supportedFrameRates}async updateTargetFrameRate(e){return await this.session.updateTargetFrameRate(e)}runInXRFrame(e,t=!0){this.inXRFrameLoop?e():(this.inXRSession||!t)&&this.onXRFrameObservable.addOnce(e)}get isFixedFoveationSupported(){var e;return((e=this._baseLayerWrapper)==null?void 0:e.isFixedFoveationSupported)||!1}get fixedFoveation(){var e;return((e=this._baseLayerWrapper)==null?void 0:e.fixedFoveation)||null}set fixedFoveation(e){const t=Math.max(0,Math.min(1,e||0));this._baseLayerWrapper&&(this._baseLayerWrapper.fixedFoveation=t)}get enabledFeatures(){var e;return((e=this.session)==null?void 0:e.enabledFeatures)??null}}class Ju{constructor(e,t=null){if(this.scene=e,this._pointerDownOnMeshAsked=!1,this._isActionableMesh=!1,this._teleportationRequestInitiated=!1,this._teleportationBackRequestInitiated=!1,this._rotationRightAsked=!1,this._rotationLeftAsked=!1,this._dpadPressed=!0,this._activePointer=!1,this._id=Ju._IdCounter++,t)this._gazeTracker=t.clone("gazeTracker");else{this._gazeTracker=Pl("gazeTracker",{diameter:.0035,thickness:.0025,tessellation:20,updatable:!1},e),this._gazeTracker.bakeCurrentTransformIntoVertices(),this._gazeTracker.isPickable=!1,this._gazeTracker.isVisible=!1;const i=new Lr("targetMat",e);i.specularColor=q.Black(),i.emissiveColor=new q(.7,.7,.7),i.backFaceCulling=!1,this._gazeTracker.material=i}}_getForwardRay(e){return new xe(x.Zero(),new x(0,0,e))}_selectionPointerDown(){this._pointerDownOnMeshAsked=!0,this._currentHit&&this.scene.simulatePointerDown(this._currentHit,{pointerId:this._id})}_selectionPointerUp(){this._currentHit&&this.scene.simulatePointerUp(this._currentHit,{pointerId:this._id}),this._pointerDownOnMeshAsked=!1}_activatePointer(){this._activePointer=!0}_deactivatePointer(){this._activePointer=!1}_updatePointerDistance(e=100){}dispose(){this._interactionsEnabled=!1,this._teleportationEnabled=!1,this._gazeTracker&&this._gazeTracker.dispose()}}Ju._IdCounter=0;class jg extends Ju{constructor(e,t){super(t),this._getCamera=e}_getForwardRay(e){const t=this._getCamera();return t?t.getForwardRay(e):new xe(x.Zero(),x.Forward())}}class Eo{get onEnteringVR(){return this.onEnteringVRObservable}get onExitingVR(){return this.onExitingVRObservable}get teleportationTarget(){return this._teleportationTarget}set teleportationTarget(e){e&&(e.name="teleportationTarget",this._isDefaultTeleportationTarget=!1,this._teleportationTarget=e)}get gazeTrackerMesh(){return this._cameraGazer._gazeTracker}set gazeTrackerMesh(e){e&&(this._cameraGazer._gazeTracker&&this._cameraGazer._gazeTracker.dispose(),this._cameraGazer._gazeTracker=e,this._cameraGazer._gazeTracker.bakeCurrentTransformIntoVertices(),this._cameraGazer._gazeTracker.isPickable=!1,this._cameraGazer._gazeTracker.isVisible=!1,this._cameraGazer._gazeTracker.name="gazeTracker")}get displayGaze(){return this._displayGaze}set displayGaze(e){this._displayGaze=e,e||(this._cameraGazer._gazeTracker.isVisible=!1)}get displayLaserPointer(){return this._displayLaserPointer}set displayLaserPointer(e){this._displayLaserPointer=e}get deviceOrientationCamera(){return this._deviceOrientationCamera}get currentVRCamera(){return this._scene.activeCamera}get vrDeviceOrientationCamera(){return this._vrDeviceOrientationCamera}get vrButton(){return this._btnVR}get _teleportationRequestInitiated(){return this._cameraGazer._teleportationRequestInitiated}constructor(e,t={}){if(this.webVROptions=t,this._fullscreenVRpresenting=!1,this.enableGazeEvenWhenNoPointerLock=!1,this.exitVROnDoubleTap=!0,this.onEnteringVRObservable=new k,this.onAfterEnteringVRObservable=new k,this.onExitingVRObservable=new k,this._useCustomVRButton=!1,this._teleportActive=!1,this._floorMeshesCollection=[],this._teleportationMode=Eo.TELEPORTATIONMODE_CONSTANTTIME,this._teleportationTime=122,this._teleportationSpeed=20,this._rotationAllowed=!0,this._teleportBackwardsVector=new x(0,-1,-1),this._isDefaultTeleportationTarget=!0,this._teleportationFillColor="#444444",this._teleportationBorderColor="#FFFFFF",this._rotationAngle=0,this._haloCenter=new x(0,0,0),this._padSensibilityUp=.65,this._padSensibilityDown=.35,this._pickedLaserColor=new q(.2,.2,1),this._pickedGazeColor=new q(0,0,1),this.onNewMeshSelected=new k,this.onNewMeshPicked=new k,this.onBeforeCameraTeleport=new k,this.onAfterCameraTeleport=new k,this.onSelectedMeshUnselected=new k,this.teleportationEnabled=!0,this._teleportationInitialized=!1,this._interactionsEnabled=!1,this._displayGaze=!0,this._displayLaserPointer=!0,this.updateGazeTrackerScale=!0,this.updateGazeTrackerColor=!0,this.updateControllerLaserColor=!0,this.requestPointerLockOnFullScreen=!0,this.xrTestDone=!1,this._onResize=()=>{this._moveButtonToBottomRight()},this._onFullscreenChange=()=>{this._fullscreenVRpresenting=!!document.fullscreenElement,!this._fullscreenVRpresenting&&this._inputElement&&(this.exitVR(),!this._useCustomVRButton&&this._btnVR&&(this._btnVR.style.top=this._inputElement.offsetTop+this._inputElement.offsetHeight-70+"px",this._btnVR.style.left=this._inputElement.offsetLeft+this._inputElement.offsetWidth-100+"px",this._updateButtonVisibility()))},this._cachedAngularSensibility={angularSensibilityX:null,angularSensibilityY:null,angularSensibility:null},this._beforeRender=()=>{this._scene.getEngine().isPointerLock||this.enableGazeEvenWhenNoPointerLock||(this._cameraGazer._gazeTracker.isVisible=!1)},this._onNewGamepadConnected=r=>{r.type!==ci.POSE_ENABLED&&(r.leftStick&&r.onleftstickchanged(n=>{this._teleportationInitialized&&this.teleportationEnabled&&(this._checkTeleportWithRay(n,this._cameraGazer),this._checkTeleportBackwards(n,this._cameraGazer))}),r.rightStick&&r.onrightstickchanged(n=>{this._teleportationInitialized&&this._checkRotate(n,this._cameraGazer)}),r.type===ci.XBOX&&(r.onbuttondown(n=>{this._interactionsEnabled&&n===0&&this._cameraGazer._selectionPointerDown()}),r.onbuttonup(n=>{this._interactionsEnabled&&n===0&&this._cameraGazer._selectionPointerUp()})))},this._workingVector=x.Zero(),this._workingQuaternion=Z.Identity(),this._workingMatrix=z.Identity(),N.Warn("WebVR is deprecated. Please avoid using this experience helper and use the WebXR experience helper instead"),this._scene=e,this._inputElement=e.getEngine().getInputElement(),!("getVRDisplays"in navigator)&&t.useXR===void 0&&(t.useXR=!0),t.createFallbackVRDeviceOrientationFreeCamera===void 0&&(t.createFallbackVRDeviceOrientationFreeCamera=!0),t.createDeviceOrientationCamera===void 0&&(t.createDeviceOrientationCamera=!0),t.laserToggle===void 0&&(t.laserToggle=!0),this._hasEnteredVR=!1,this._scene.activeCamera?this._position=this._scene.activeCamera.position.clone():this._position=new x(0,this._defaultHeight,0),t.createDeviceOrientationCamera||!this._scene.activeCamera){if(this._deviceOrientationCamera=new i_("deviceOrientationVRHelper",this._position.clone(),e),this._scene.activeCamera&&(this._deviceOrientationCamera.minZ=this._scene.activeCamera.minZ,this._deviceOrientationCamera.maxZ=this._scene.activeCamera.maxZ,this._scene.activeCamera instanceof Lo&&this._scene.activeCamera.rotation)){const r=this._scene.activeCamera;r.rotationQuaternion?this._deviceOrientationCamera.rotationQuaternion.copyFrom(r.rotationQuaternion):this._deviceOrientationCamera.rotationQuaternion.copyFrom(Z.RotationYawPitchRoll(r.rotation.y,r.rotation.x,r.rotation.z)),this._deviceOrientationCamera.rotation=r.rotation.clone()}this._scene.activeCamera=this._deviceOrientationCamera,this._inputElement&&this._scene.activeCamera.attachControl()}else this._existingCamera=this._scene.activeCamera;this.webVROptions.useXR&&navigator.xr?Ku.IsSessionSupportedAsync("immersive-vr").then(r=>{r?(N.Log("Using WebXR. It is recommended to use the WebXRDefaultExperience directly"),e.createDefaultXRExperienceAsync({floorMeshes:t.floorMeshes||[]}).then(n=>{this.xr=n,this.xrTestDone=!0,this._cameraGazer=new jg(()=>this.xr.baseExperience.camera,e),this.xr.baseExperience.onStateChangedObservable.add(a=>{switch(a){case 0:this.onEnteringVRObservable.notifyObservers(this),this._interactionsEnabled||this.xr.pointerSelection.detach(),this.xr.pointerSelection.displayLaserPointer=this._displayLaserPointer;break;case 1:this.onExitingVRObservable.notifyObservers(this),this._scene.getEngine().resize();break;case 2:this._hasEnteredVR=!0;break;case 3:this._hasEnteredVR=!1;break}})})):this._completeVRInit(e,t)}):this._completeVRInit(e,t)}_completeVRInit(e,t){if(this.xrTestDone=!0,t.createFallbackVRDeviceOrientationFreeCamera&&(this._vrDeviceOrientationCamera=new n_("VRDeviceOrientationVRHelper",this._position,this._scene,!0,t.vrDeviceOrientationCameraMetrics),this._vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._cameraGazer=new jg(()=>this.currentVRCamera,e),!this._useCustomVRButton){this._btnVR=document.createElement("BUTTON"),this._btnVR.className="babylonVRicon",this._btnVR.id="babylonVRiconbtn",this._btnVR.title="Click to switch to VR";let n=".babylonVRicon { position: absolute; right: 20px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+(window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A":"https://cdn.babylonjs.com/Assets/vrButton.png")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";n+=".babylonVRicon.vrdisplaypresenting { display: none; }";const a=document.createElement("style");a.appendChild(document.createTextNode(n)),document.getElementsByTagName("head")[0].appendChild(a),this._moveButtonToBottomRight()}this._btnVR&&this._btnVR.addEventListener("click",()=>{this.isInVRMode||this.enterVR()});const i=this._scene.getEngine().getHostWindow();i&&(i.addEventListener("resize",this._onResize),document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),t.createFallbackVRDeviceOrientationFreeCamera&&this._displayVRButton(),this._onKeyDown=r=>{r.keyCode===27&&this.isInVRMode&&this.exitVR()},document.addEventListener("keydown",this._onKeyDown),this._scene.onPrePointerObservable.add(()=>{this._hasEnteredVR&&this.exitVROnDoubleTap&&(this.exitVR(),this._fullscreenVRpresenting&&this._scene.getEngine().exitFullscreen())},ze.POINTERDOUBLETAP,!1),e.onDisposeObservable.add(()=>{this.dispose()}),this._updateButtonVisibility(),this._circleEase=new Pn,this._circleEase.setEasingMode(Yc.EASINGMODE_EASEINOUT),this._teleportationEasing=this._circleEase,e.onPointerObservable.add(r=>{this._interactionsEnabled&&e.activeCamera===this.vrDeviceOrientationCamera&&r.event.pointerType==="mouse"&&(r.type===ze.POINTERDOWN?this._cameraGazer._selectionPointerDown():r.type===ze.POINTERUP&&this._cameraGazer._selectionPointerUp())}),this.webVROptions.floorMeshes&&this.enableTeleportation({floorMeshes:this.webVROptions.floorMeshes}))}get isInVRMode(){return this.xr&&this.webVROptions.useXR&&this.xr.baseExperience.state===2||this._fullscreenVRpresenting}_moveButtonToBottomRight(){if(this._inputElement&&!this._useCustomVRButton&&this._btnVR){const e=this._inputElement.getBoundingClientRect();this._btnVR.style.top=e.top+e.height-70+"px",this._btnVR.style.left=e.left+e.width-100+"px"}}_displayVRButton(){!this._useCustomVRButton&&!this._btnVRDisplayed&&this._btnVR&&(document.body.appendChild(this._btnVR),this._btnVRDisplayed=!0)}_updateButtonVisibility(){!this._btnVR||this._useCustomVRButton||(this._btnVR.className="babylonVRicon",this.isInVRMode&&(this._btnVR.className+=" vrdisplaypresenting"))}enterVR(){if(this.xr){this.xr.baseExperience.enterXRAsync("immersive-vr","local-floor",this.xr.renderTarget);return}if(this.onEnteringVRObservable)try{this.onEnteringVRObservable.notifyObservers(this)}catch(e){N.Warn("Error in your custom logic onEnteringVR: "+e)}this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone(),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.rotation=Z.FromRotationMatrix(this._scene.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles(),this.vrDeviceOrientationCamera.angularSensibility=2e3),this._existingCamera=this._scene.activeCamera,this._existingCamera.angularSensibilityX&&(this._cachedAngularSensibility.angularSensibilityX=this._existingCamera.angularSensibilityX,this._existingCamera.angularSensibilityX=Number.MAX_VALUE),this._existingCamera.angularSensibilityY&&(this._cachedAngularSensibility.angularSensibilityY=this._existingCamera.angularSensibilityY,this._existingCamera.angularSensibilityY=Number.MAX_VALUE),this._existingCamera.angularSensibility&&(this._cachedAngularSensibility.angularSensibility=this._existingCamera.angularSensibility,this._existingCamera.angularSensibility=Number.MAX_VALUE)),this._vrDeviceOrientationCamera&&(this._vrDeviceOrientationCamera.position=this._position,this._scene.activeCamera&&(this._vrDeviceOrientationCamera.minZ=this._scene.activeCamera.minZ),this._scene.activeCamera=this._vrDeviceOrientationCamera,this._scene.getEngine().enterFullscreen(this.requestPointerLockOnFullScreen),this._updateButtonVisibility(),this._vrDeviceOrientationCamera.onViewMatrixChangedObservable.addOnce(()=>{this.onAfterEnteringVRObservable.notifyObservers({success:!0})})),this._scene.activeCamera&&this._inputElement&&this._scene.activeCamera.attachControl(),this._interactionsEnabled&&this._scene.registerBeforeRender(this._beforeRender),this._hasEnteredVR=!0}exitVR(){if(this.xr){this.xr.baseExperience.exitXRAsync();return}if(this._hasEnteredVR){if(this.onExitingVRObservable)try{this.onExitingVRObservable.notifyObservers(this)}catch(e){N.Warn("Error in your custom logic onExitingVR: "+e)}this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone()),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._deviceOrientationCamera?(this._deviceOrientationCamera.position=this._position,this._scene.activeCamera=this._deviceOrientationCamera,this._cachedAngularSensibility.angularSensibilityX&&(this._deviceOrientationCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._deviceOrientationCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._deviceOrientationCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)):this._existingCamera&&(this._existingCamera.position=this._position,this._scene.activeCamera=this._existingCamera,this._inputElement&&this._scene.activeCamera.attachControl(),this._cachedAngularSensibility.angularSensibilityX&&(this._existingCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._existingCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._existingCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)),this._updateButtonVisibility(),this._interactionsEnabled&&(this._scene.unregisterBeforeRender(this._beforeRender),this._cameraGazer._gazeTracker.isVisible=!1),this._scene.getEngine().resize(),this._hasEnteredVR=!1}}get position(){return this._position}set position(e){this._position=e,this._scene.activeCamera&&(this._scene.activeCamera.position=e)}enableInteractions(){if(!this._interactionsEnabled){if(this.xr){this.xr.baseExperience.state===2&&this.xr.pointerSelection.attach();return}this.raySelectionPredicate=e=>e.isVisible&&(e.isPickable||e.name===this._floorMeshName),this.meshSelectionPredicate=()=>!0,this._raySelectionPredicate=e=>this._isTeleportationFloor(e)||e.name.indexOf("gazeTracker")===-1&&e.name.indexOf("teleportationTarget")===-1&&e.name.indexOf("torusTeleportation")===-1?this.raySelectionPredicate(e):!1,this._interactionsEnabled=!0}}_isTeleportationFloor(e){for(let t=0;t<this._floorMeshesCollection.length;t++)if(this._floorMeshesCollection[t].id===e.id)return!0;return!!(this._floorMeshName&&e.name===this._floorMeshName)}addFloorMesh(e){this._floorMeshesCollection&&(this._floorMeshesCollection.indexOf(e)>-1||this._floorMeshesCollection.push(e))}removeFloorMesh(e){if(!this._floorMeshesCollection)return;const t=this._floorMeshesCollection.indexOf(e);t!==-1&&this._floorMeshesCollection.splice(t,1)}enableTeleportation(e={}){if(!this._teleportationInitialized){if(this.enableInteractions(),this.webVROptions.useXR&&(e.floorMeshes||e.floorMeshName)){const i=e.floorMeshes||[];if(!i.length){const r=this._scene.getMeshByName(e.floorMeshName);r&&i.push(r)}if(this.xr){for(const r of i)this.xr.teleportation.addFloorMesh(r);this.xr.teleportation.attached||this.xr.teleportation.attach();return}else if(!this.xrTestDone){const r=()=>{this.xrTestDone&&(this._scene.unregisterBeforeRender(r),this.xr?this.xr.teleportation.attached||this.xr.teleportation.attach():this.enableTeleportation(e))};this._scene.registerBeforeRender(r);return}}e.floorMeshName&&(this._floorMeshName=e.floorMeshName),e.floorMeshes&&(this._floorMeshesCollection=e.floorMeshes),e.teleportationMode&&(this._teleportationMode=e.teleportationMode),e.teleportationTime&&e.teleportationTime>0&&(this._teleportationTime=e.teleportationTime),e.teleportationSpeed&&e.teleportationSpeed>0&&(this._teleportationSpeed=e.teleportationSpeed),e.easingFunction!==void 0&&(this._teleportationEasing=e.easingFunction);const t=new bi;t.vignetteColor=new Te(0,0,0,0),t.vignetteEnabled=!0,this._teleportationInitialized=!0,this._isDefaultTeleportationTarget&&this._createTeleportationCircles()}}_checkTeleportWithRay(e,t){this._teleportationRequestInitiated&&!t._teleportationRequestInitiated||(t._teleportationRequestInitiated?Math.sqrt(e.y*e.y+e.x*e.x)<this._padSensibilityDown&&(this._teleportActive&&this.teleportCamera(this._haloCenter),t._teleportationRequestInitiated=!1):e.y<-this._padSensibilityUp&&t._dpadPressed&&(t._activatePointer(),t._teleportationRequestInitiated=!0))}_checkRotate(e,t){t._teleportationRequestInitiated||(t._rotationLeftAsked?e.x>-this._padSensibilityDown&&(t._rotationLeftAsked=!1):e.x<-this._padSensibilityUp&&t._dpadPressed&&(t._rotationLeftAsked=!0,this._rotationAllowed&&this._rotateCamera(!1)),t._rotationRightAsked?e.x<this._padSensibilityDown&&(t._rotationRightAsked=!1):e.x>this._padSensibilityUp&&t._dpadPressed&&(t._rotationRightAsked=!0,this._rotationAllowed&&this._rotateCamera(!0)))}_checkTeleportBackwards(e,t){if(!t._teleportationRequestInitiated)if(e.y>this._padSensibilityUp&&t._dpadPressed){if(!t._teleportationBackRequestInitiated){if(!this.currentVRCamera)return;const i=Z.FromRotationMatrix(this.currentVRCamera.getWorldMatrix().getRotationMatrix()),r=this.currentVRCamera.position;i.toEulerAnglesToRef(this._workingVector),this._workingVector.z=0,this._workingVector.x=0,Z.RotationYawPitchRollToRef(this._workingVector.y,this._workingVector.x,this._workingVector.z,this._workingQuaternion),this._workingQuaternion.toRotationMatrix(this._workingMatrix),x.TransformCoordinatesToRef(this._teleportBackwardsVector,this._workingMatrix,this._workingVector);const n=new xe(r,this._workingVector),a=this._scene.pickWithRay(n,this._raySelectionPredicate);a&&a.pickedPoint&&a.pickedMesh&&this._isTeleportationFloor(a.pickedMesh)&&a.distance<5&&this.teleportCamera(a.pickedPoint),t._teleportationBackRequestInitiated=!0}}else t._teleportationBackRequestInitiated=!1}_createTeleportationCircles(){this._teleportationTarget=Qy("teleportationTarget",{width:2,height:2,subdivisions:2},this._scene),this._teleportationTarget.isPickable=!1;const e=512,t=new Ky("DynamicTexture",e,this._scene,!0);t.hasAlpha=!0;const i=t.getContext(),r=e/2,n=e/2,a=200;i.beginPath(),i.arc(r,n,a,0,2*Math.PI,!1),i.fillStyle=this._teleportationFillColor,i.fill(),i.lineWidth=10,i.strokeStyle=this._teleportationBorderColor,i.stroke(),i.closePath(),t.update();const o=new Lr("TextPlaneMaterial",this._scene);o.diffuseTexture=t,this._teleportationTarget.material=o;const l=Pl("torusTeleportation",{diameter:.75,thickness:.1,tessellation:25,updatable:!1},this._scene);l.isPickable=!1,l.parent=this._teleportationTarget;const c=new pe("animationInnerCircle","position.y",30,pe.ANIMATIONTYPE_FLOAT,pe.ANIMATIONLOOPMODE_CYCLE),u=[];u.push({frame:0,value:0}),u.push({frame:30,value:.4}),u.push({frame:60,value:0}),c.setKeys(u);const h=new en;h.setEasingMode(Yc.EASINGMODE_EASEINOUT),c.setEasingFunction(h),l.animations=[],l.animations.push(c),this._scene.beginAnimation(l,0,60,!0),this._hideTeleportationTarget()}_hideTeleportationTarget(){this._teleportActive=!1,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!1,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!1))}_rotateCamera(e){if(!(this.currentVRCamera instanceof xr))return;e?this._rotationAngle++:this._rotationAngle--,this.currentVRCamera.animations=[];const t=Z.FromRotationMatrix(z.RotationY(Math.PI/4*this._rotationAngle)),i=new pe("animationRotation","rotationQuaternion",90,pe.ANIMATIONTYPE_QUATERNION,pe.ANIMATIONLOOPMODE_CONSTANT),r=[];r.push({frame:0,value:this.currentVRCamera.rotationQuaternion}),r.push({frame:6,value:t}),i.setKeys(r),i.setEasingFunction(this._circleEase),this.currentVRCamera.animations.push(i),this._postProcessMove.animations=[];const n=new pe("animationPP","vignetteWeight",90,pe.ANIMATIONTYPE_FLOAT,pe.ANIMATIONLOOPMODE_CONSTANT),a=[];a.push({frame:0,value:0}),a.push({frame:3,value:4}),a.push({frame:6,value:0}),n.setKeys(a),n.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(n);const o=new pe("animationPP2","vignetteStretch",90,pe.ANIMATIONTYPE_FLOAT,pe.ANIMATIONLOOPMODE_CONSTANT),l=[];l.push({frame:0,value:0}),l.push({frame:3,value:10}),l.push({frame:6,value:0}),o.setKeys(l),o.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(o),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._postProcessMove.samples=4,this._scene.beginAnimation(this.currentVRCamera,0,6,!1,1)}teleportCamera(e){if(!(this.currentVRCamera instanceof xr))return;this._workingVector.copyFrom(e),this.isInVRMode||(this._workingVector.y+=this._defaultHeight),this.onBeforeCameraTeleport.notifyObservers(this._workingVector);const t=90;let i,r;if(this._teleportationMode==Eo.TELEPORTATIONMODE_CONSTANTSPEED){r=t;const d=x.Distance(this.currentVRCamera.position,this._workingVector);i=this._teleportationSpeed/d}else r=Math.round(this._teleportationTime*t/1e3),i=1;this.currentVRCamera.animations=[];const n=new pe("animationCameraTeleportation","position",t,pe.ANIMATIONTYPE_VECTOR3,pe.ANIMATIONLOOPMODE_CONSTANT),a=[{frame:0,value:this.currentVRCamera.position},{frame:r,value:this._workingVector}];n.setKeys(a),n.setEasingFunction(this._teleportationEasing),this.currentVRCamera.animations.push(n),this._postProcessMove.animations=[];const o=Math.round(r/2),l=new pe("animationPP","vignetteWeight",t,pe.ANIMATIONTYPE_FLOAT,pe.ANIMATIONLOOPMODE_CONSTANT),c=[];c.push({frame:0,value:0}),c.push({frame:o,value:8}),c.push({frame:r,value:0}),l.setKeys(c),this._postProcessMove.animations.push(l);const u=new pe("animationPP2","vignetteStretch",t,pe.ANIMATIONTYPE_FLOAT,pe.ANIMATIONLOOPMODE_CONSTANT),h=[];h.push({frame:0,value:0}),h.push({frame:o,value:10}),h.push({frame:r,value:0}),u.setKeys(h),this._postProcessMove.animations.push(u),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._scene.beginAnimation(this.currentVRCamera,0,r,!1,i,()=>{this.onAfterCameraTeleport.notifyObservers(this._workingVector)}),this._hideTeleportationTarget()}setLaserColor(e,t=this._pickedLaserColor){this._pickedLaserColor=t}setLaserLightingState(e=!0){}setGazeColor(e,t=this._pickedGazeColor){this._pickedGazeColor=t}changeLaserColor(e){this.updateControllerLaserColor}changeGazeColor(e){this.updateGazeTrackerColor&&this._cameraGazer._gazeTracker.material&&(this._cameraGazer._gazeTracker.material.emissiveColor=e)}dispose(){this.isInVRMode&&this.exitVR(),this._postProcessMove&&this._postProcessMove.dispose(),this._vrDeviceOrientationCamera&&this._vrDeviceOrientationCamera.dispose(),!this._useCustomVRButton&&this._btnVR&&this._btnVR.parentNode&&document.body.removeChild(this._btnVR),this._deviceOrientationCamera&&this._scene.activeCamera!=this._deviceOrientationCamera&&this._deviceOrientationCamera.dispose(),this._cameraGazer&&this._cameraGazer.dispose(),this._teleportationTarget&&this._teleportationTarget.dispose(),this.xr&&this.xr.dispose(),this._floorMeshesCollection.length=0,document.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChangeBind),window.removeEventListener("resize",this._onResize),document.removeEventListener("fullscreenchange",this._onFullscreenChange),this._scene.gamepadManager.onGamepadConnectedObservable.removeCallback(this._onNewGamepadConnected),this._scene.unregisterBeforeRender(this._beforeRender)}getClassName(){return"VRExperienceHelper"}}Eo.TELEPORTATIONMODE_CONSTANTTIME=0;Eo.TELEPORTATIONMODE_CONSTANTSPEED=1;const IL=QN,rs={...ZN,TwoPi:Math.PI*2,Sign:Math.sign,Log2:Math.log2,HCF:IL},RL=(s,e,t,i)=>!(s.x>t.x+i||t.x-i>e.x||s.y>t.y+i||t.y-i>e.y||s.z>t.z+i||t.z-i>e.z),Qa=function(){const s={root:0,found:!1};return function(e,t,i,r){s.root=0,s.found=!1;const n=t*t-4*e*i;if(n<0)return s;const a=Math.sqrt(n);let o=(-t-a)/(2*e),l=(-t+a)/(2*e);if(o>l){const c=l;l=o,o=c}return o>0&&o<r?(s.root=o,s.found=!0,s):(l>0&&l<r&&(s.root=l,s.found=!0),s)}}();class eh{constructor(){this._collisionPoint=x.Zero(),this._planeIntersectionPoint=x.Zero(),this._tempVector=x.Zero(),this._tempVector2=x.Zero(),this._tempVector3=x.Zero(),this._tempVector4=x.Zero(),this._edge=x.Zero(),this._baseToVertex=x.Zero(),this._destinationPoint=x.Zero(),this._slidePlaneNormal=x.Zero(),this._displacementVector=x.Zero(),this._radius=x.One(),this._retry=0,this._basePointWorld=x.Zero(),this._velocityWorld=x.Zero(),this._normalizedVelocity=x.Zero(),this._collisionMask=-1}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}get slidePlaneNormal(){return this._slidePlaneNormal}_initialize(e,t,i){this._velocity=t,this._velocitySquaredLength=this._velocity.lengthSquared();const r=Math.sqrt(this._velocitySquaredLength);r===0||r===1?this._normalizedVelocity.copyFromFloats(t._x,t._y,t._z):t.scaleToRef(1/r,this._normalizedVelocity),this._basePoint=e,e.multiplyToRef(this._radius,this._basePointWorld),t.multiplyToRef(this._radius,this._velocityWorld),this._velocityWorldLength=this._velocityWorld.length(),this._epsilon=i,this.collisionFound=!1}_checkPointInTriangle(e,t,i,r,n){t.subtractToRef(e,this._tempVector),i.subtractToRef(e,this._tempVector2),x.CrossToRef(this._tempVector,this._tempVector2,this._tempVector4);let a=x.Dot(this._tempVector4,n);return a<0||(r.subtractToRef(e,this._tempVector3),x.CrossToRef(this._tempVector2,this._tempVector3,this._tempVector4),a=x.Dot(this._tempVector4,n),a<0)?!1:(x.CrossToRef(this._tempVector3,this._tempVector,this._tempVector4),a=x.Dot(this._tempVector4,n),a>=0)}_canDoCollision(e,t,i,r){const n=x.Distance(this._basePointWorld,e),a=Math.max(this._radius.x,this._radius.y,this._radius.z);return!(n>this._velocityWorldLength+a+t||!RL(i,r,this._basePointWorld,this._velocityWorldLength+a))}_testTriangle(e,t,i,r,n,a,o){let l,c=!1;t||(t=[]),t[e]||(t[e]=new jc(0,0,0,0),t[e].copyFromPoints(i,r,n));const u=t[e];if(!a&&!u.isFrontFacingTo(this._normalizedVelocity,0))return;const h=u.signedDistanceTo(this._basePoint),d=x.Dot(u.normal,this._velocity);if(eh.DoubleSidedCheck&&d>1e-4)return;if(d==0){if(Math.abs(h)>=1)return;c=!0,l=0}else{l=(-1-h)/d;let g=(1-h)/d;if(l>g){const v=g;g=l,l=v}if(l>1||g<0)return;l<0&&(l=0),l>1&&(l=1)}this._collisionPoint.copyFromFloats(0,0,0);let f=!1,m=1;if(c||(this._basePoint.subtractToRef(u.normal,this._planeIntersectionPoint),this._velocity.scaleToRef(l,this._tempVector),this._planeIntersectionPoint.addInPlace(this._tempVector),this._checkPointInTriangle(this._planeIntersectionPoint,i,r,n,u.normal)&&(f=!0,m=l,this._collisionPoint.copyFrom(this._planeIntersectionPoint))),!f){let g=this._velocitySquaredLength;this._basePoint.subtractToRef(i,this._tempVector);let v=2*x.Dot(this._velocity,this._tempVector),E=this._tempVector.lengthSquared()-1,T=Qa(g,v,E,m);T.found&&(m=T.root,f=!0,this._collisionPoint.copyFrom(i)),this._basePoint.subtractToRef(r,this._tempVector),v=2*x.Dot(this._velocity,this._tempVector),E=this._tempVector.lengthSquared()-1,T=Qa(g,v,E,m),T.found&&(m=T.root,f=!0,this._collisionPoint.copyFrom(r)),this._basePoint.subtractToRef(n,this._tempVector),v=2*x.Dot(this._velocity,this._tempVector),E=this._tempVector.lengthSquared()-1,T=Qa(g,v,E,m),T.found&&(m=T.root,f=!0,this._collisionPoint.copyFrom(n)),r.subtractToRef(i,this._edge),i.subtractToRef(this._basePoint,this._baseToVertex);let C=this._edge.lengthSquared(),A=x.Dot(this._edge,this._velocity),I=x.Dot(this._edge,this._baseToVertex);if(g=C*-this._velocitySquaredLength+A*A,v=2*(C*x.Dot(this._velocity,this._baseToVertex)-A*I),E=C*(1-this._baseToVertex.lengthSquared())+I*I,T=Qa(g,v,E,m),T.found){const F=(A*T.root-I)/C;F>=0&&F<=1&&(m=T.root,f=!0,this._edge.scaleInPlace(F),i.addToRef(this._edge,this._collisionPoint))}if(n.subtractToRef(r,this._edge),r.subtractToRef(this._basePoint,this._baseToVertex),C=this._edge.lengthSquared(),A=x.Dot(this._edge,this._velocity),I=x.Dot(this._edge,this._baseToVertex),g=C*-this._velocitySquaredLength+A*A,v=2*(C*x.Dot(this._velocity,this._baseToVertex)-A*I),E=C*(1-this._baseToVertex.lengthSquared())+I*I,T=Qa(g,v,E,m),T.found){const F=(A*T.root-I)/C;F>=0&&F<=1&&(m=T.root,f=!0,this._edge.scaleInPlace(F),r.addToRef(this._edge,this._collisionPoint))}if(i.subtractToRef(n,this._edge),n.subtractToRef(this._basePoint,this._baseToVertex),C=this._edge.lengthSquared(),A=x.Dot(this._edge,this._velocity),I=x.Dot(this._edge,this._baseToVertex),g=C*-this._velocitySquaredLength+A*A,v=2*(C*x.Dot(this._velocity,this._baseToVertex)-A*I),E=C*(1-this._baseToVertex.lengthSquared())+I*I,T=Qa(g,v,E,m),T.found){const F=(A*T.root-I)/C;F>=0&&F<=1&&(m=T.root,f=!0,this._edge.scaleInPlace(F),n.addToRef(this._edge,this._collisionPoint))}}if(f){const g=m*m*this._velocitySquaredLength;(!this.collisionFound||g<this._nearestDistanceSquared)&&(o.collisionResponse&&(this.intersectionPoint?this.intersectionPoint.copyFrom(this._collisionPoint):this.intersectionPoint=this._collisionPoint.clone(),this._nearestDistanceSquared=g,this._nearestDistance=Math.sqrt(g),this.collisionFound=!0),this.collidedMesh=o)}}_collide(e,t,i,r,n,a,o,l,c,u=!1){if(u)if(!i||i.length===0)for(let h=0;h<t.length-2;h+=1){const d=t[h],f=t[h+1],m=t[h+2];!d||!f||!m||((c?1:0)^h%2?this._testTriangle(h,e,d,f,m,o,l):this._testTriangle(h,e,f,d,m,o,l))}else for(let h=r;h<n-2;h+=1){const d=i[h],f=i[h+1],m=i[h+2];if(m===4294967295){h+=2;continue}const g=t[d],v=t[f],E=t[m];!g||!v||!E||((c?1:0)^h%2?this._testTriangle(h,e,g,v,E,o,l):this._testTriangle(h,e,v,g,E,o,l))}else if(!i||i.length===0)for(let h=0;h<t.length;h+=3){const d=t[h],f=t[h+1],m=t[h+2];c?this._testTriangle(h,e,d,f,m,o,l):this._testTriangle(h,e,m,f,d,o,l)}else for(let h=r;h<n;h+=3){const d=t[i[h]-a],f=t[i[h+1]-a],m=t[i[h+2]-a];c?this._testTriangle(h,e,d,f,m,o,l):this._testTriangle(h,e,m,f,d,o,l)}}_getResponse(e,t,i){if(e.addToRef(t,this._destinationPoint),i)t.scaleInPlace(this._nearestDistance/t.length()),this._basePoint.addToRef(t,e);else{t.scaleInPlace((this._nearestDistance-this._epsilon)/t.length()),this._basePoint.addToRef(t,e);return}e.subtractToRef(this.intersectionPoint,this._slidePlaneNormal),this._slidePlaneNormal.normalize(),this._slidePlaneNormal.scaleToRef(this._epsilon,this._displacementVector),e.addInPlace(this._displacementVector),this.intersectionPoint.addInPlace(this._displacementVector),this._slidePlaneNormal.scaleInPlace(jc.SignedDistanceToPlaneFromPositionAndNormal(this.intersectionPoint,this._slidePlaneNormal,this._destinationPoint)),this._destinationPoint.subtractInPlace(this._slidePlaneNormal),this._destinationPoint.subtractToRef(this.intersectionPoint,t)}}eh.DoubleSidedCheck=!1;class AL{constructor(){this._scaledPosition=x.Zero(),this._scaledVelocity=x.Zero(),this._finalPosition=x.Zero()}getNewPosition(e,t,i,r,n,a,o,l=!0){e.divideToRef(i._radius,this._scaledPosition),t.divideToRef(i._radius,this._scaledVelocity),i.collidedMesh=null,i._retry=0,i._initialVelocity=this._scaledVelocity,i._initialPosition=this._scaledPosition,this._collideWithWorld(this._scaledPosition,this._scaledVelocity,i,r,this._finalPosition,l,n),this._finalPosition.multiplyInPlace(i._radius),a(o,this._finalPosition,i.collidedMesh)}createCollider(){return new eh}init(e){this._scene=e}_collideWithWorld(e,t,i,r,n,a,o=null){const l=te.CollisionsEpsilon*10;if(i._retry>=r){n.copyFrom(e);return}const c=o?o.collisionMask:i.collisionMask;i._initialize(e,t,l);const u=o&&o.surroundingMeshes||this._scene.meshes;for(let h=0;h<u.length;h++){const d=u[h];d.isEnabled()&&d.checkCollisions&&d.subMeshes&&d!==o&&c&d.collisionGroup&&d._checkCollision(i)}if(!i.collisionFound){e.addToRef(t,n);return}if((t.x!==0||t.y!==0||t.z!==0)&&(i._getResponse(e,t,a),a||t.setAll(0)),t.length()<=l){n.copyFrom(e);return}i._retry++,this._collideWithWorld(e,t,i,r,n,a,o)}}le.CollisionCoordinatorFactory=()=>new AL;const qg="pickingPixelShader",PL=`#if defined(INSTANCES)
varying float vMeshID;
#else
uniform float meshID;
#endif
void main(void) {float id;
#if defined(INSTANCES)
id=vMeshID;
#else
id=meshID;
#endif
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
int castedId=int(id);vec3 color=vec3(
float((castedId>>16) & 0xFF),
float((castedId>>8) & 0xFF),
float(castedId & 0xFF)
)/255.0;gl_FragColor=vec4(color,1.0);
#else
float castedId=floor(id+0.5);vec3 color=vec3(
floor(mod(castedId,16777216.0)/65536.0),
floor(mod(castedId,65536.0)/256.0),
mod(castedId,256.0)
)/255.0;gl_FragColor=vec4(color,1.0);
#endif
}
`;S.ShadersStore[qg]||(S.ShadersStore[qg]=PL);const Zg="pickingVertexShader",OL=`attribute vec3 position;
#if defined(INSTANCES)
attribute float instanceMeshID;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
uniform mat4 viewProjection;
#if defined(INSTANCES)
varying float vMeshID;
#endif
void main(void) {
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(position,1.0);gl_Position=viewProjection*worldPos;
#if defined(INSTANCES)
vMeshID=instanceMeshID;
#endif
}
`;S.ShadersStore[Zg]||(S.ShadersStore[Zg]=OL);const Qg="pickingPixelShader",NL=`#if defined(INSTANCES)
varying vMeshID: f32;
#else
uniform meshID: f32;
#endif
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var id: i32;
#if defined(INSTANCES)
id=i32(input.vMeshID);
#else
id=i32(uniforms.meshID);
#endif
var color=vec3f(
f32((id>>16) & 0xFF),
f32((id>>8) & 0xFF),
f32(id & 0xFF),
)/255.0;fragmentOutputs.color=vec4f(color,1.0);}
`;S.ShadersStoreWGSL[Qg]||(S.ShadersStoreWGSL[Qg]=NL);const Kg="pickingVertexShader",DL=`attribute position: vec3f;
#if defined(INSTANCES)
attribute instanceMeshID: f32;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
uniform viewProjection: mat4x4f;
#if defined(INSTANCES)
varying vMeshID: f32;
#endif
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld*vec4f(input.position,1.0);vertexOutputs.position=uniforms.viewProjection*worldPos;
#if defined(INSTANCES)
vertexOutputs.vMeshID=input.instanceMeshID;
#endif
}
`;S.ShadersStoreWGSL[Kg]||(S.ShadersStoreWGSL[Kg]=DL);class To{constructor(e,t,i,r=""){this.defines="",this.onCompiled=null,this.onError=null,this.uniqueId=0,this.onCompileObservable=new k,this.onErrorObservable=new k,this.onBindObservable=new k,this._wasPreviouslyReady=!1,this._isReady=!1,this._compilationError="",this._key="",this._computeSourceCodeOverride="",this._pipelineContext=null,this._computeSourceCode="",this._rawComputeSourceCode="",this._shaderLanguage=1,this.name=e,this._key=r,this._engine=i,this.uniqueId=To._UniqueIdSeed++,this.defines=t.defines??"",this.onError=t.onError,this.onCompiled=t.onCompiled,this._entryPoint=t.entryPoint??"main",this._shaderStore=S.GetShadersStore(this._shaderLanguage),this._shaderRepository=S.GetShadersRepository(this._shaderLanguage),this._includeShaderStore=S.GetIncludesShadersStore(this._shaderLanguage);let n;const a=Fm()?this._engine.getHostDocument():null;typeof e=="string"?n=e:e.computeSource?n="source:"+e.computeSource:e.computeElement?n=(a==null?void 0:a.getElementById(e.computeElement))||e.computeElement:n=e.compute||e;const o={defines:this.defines.split(`
`),indexParameters:void 0,isFragment:!1,shouldUseHighPrecisionShader:!1,processor:null,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:this._shaderRepository,includesShadersStore:this._includeShaderStore,version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:null,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:(l,c,u)=>{if(!u)return c;for(const h of u){const f=h.replace("#define","").replace(";","").trim().split(" ");if(f.length===2){const m=f[0],g=f[1];(!isNaN(parseInt(g))||!isNaN(parseFloat(g)))&&(c=`const ${m} = ${g};
`+c)}}return c}};this._loadShader(n,"Compute","",l=>{Jy(o),KN(l,o,c=>{this._rawComputeSourceCode=l,t.processFinalCode&&(c=t.processFinalCode(c));const u=eI(c,"",o);this._useFinalCode(u.vertexCode,e)},this._engine)})}_useFinalCode(e,t){if(t){const i=t.computeElement||t.compute||t.spectorName||t;this._computeSourceCode="//#define SHADER_NAME compute:"+i+`
`+e}else this._computeSourceCode=e;this._prepareEffect()}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return this._isReady?!0:this._pipelineContext?this._pipelineContext.isReady:!1}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getCompilationError(){return this._compilationError}executeWhenCompiled(e){if(this.isReady()){e(this);return}this.onCompileObservable.add(t=>{e(t)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&this._checkIsReady(null)}_checkIsReady(e){Wn(()=>this._isReadyInternal(),()=>{},t=>{this._processCompilationErrors(t,e)},void 0,void 0,!1)}_loadShader(e,t,i,r){if(typeof HTMLElement<"u"&&e instanceof HTMLElement){const a=JN(e);r(a);return}if(e.substring(0,7)==="source:"){r(e.substring(7));return}if(e.substring(0,7)==="base64:"){const a=window.atob(e.substring(7));r(a);return}if(this._shaderStore[e+t+"Shader"]){r(this._shaderStore[e+t+"Shader"]);return}if(i&&this._shaderStore[e+i+"Shader"]){r(this._shaderStore[e+i+"Shader"]);return}let n;e[0]==="."||e[0]==="/"||e.indexOf("http")>-1?n=e:n=this._shaderRepository+e,this._engine._loadFile(n+"."+t.toLowerCase()+".fx",r)}get computeSourceCode(){var e;return this._computeSourceCodeOverride?this._computeSourceCodeOverride:((e=this._pipelineContext)==null?void 0:e._getComputeShaderCode())??this._computeSourceCode}get rawComputeSourceCode(){return this._rawComputeSourceCode}_prepareEffect(){const e=this.defines,t=this._pipelineContext;this._isReady=!1;try{const i=this._engine;this._pipelineContext=i.createComputePipelineContext(),this._pipelineContext._name=this._key,i._prepareComputePipelineContext(this._pipelineContext,this._computeSourceCodeOverride?this._computeSourceCodeOverride:this._computeSourceCode,this._rawComputeSourceCode,this._computeSourceCodeOverride?null:e,this._entryPoint),i._executeWhenComputeStateIsCompiled(this._pipelineContext,r=>{if(r&&r.numErrors>0){this._processCompilationErrors(r,t);return}this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),t&&this.getEngine()._deleteComputePipelineContext(t)}),this._pipelineContext.isAsync&&this._checkIsReady(t)}catch(i){this._processCompilationErrors(i,t)}}_processCompilationErrors(e,t=null){var i;if(this._compilationError="",N.Error("Unable to compile compute effect:"),this.defines&&N.Error(`Defines:
`+this.defines),To.LogShaderCodeOnCompilationError){const r=(i=this._pipelineContext)==null?void 0:i._getComputeShaderCode();r&&(N.Error("Compute code:"),N.Error(r))}if(typeof e=="string")this._compilationError=e,N.Error("Error: "+this._compilationError);else for(const r of e.messages){let n="";r.line!==void 0&&(n+="Line "+r.line+", "),r.offset!==void 0&&(n+="Offset "+r.offset+", "),r.length!==void 0&&(n+="Length "+r.length+", "),n+=r.type+": "+r.text,this._compilationError&&(this._compilationError+=`
`),this._compilationError+=n,N.Error(n)}t&&(this._pipelineContext=t,this._isReady=!0),this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)}dispose(){this._pipelineContext&&this._pipelineContext.dispose(),this._engine._releaseComputeEffect(this)}static RegisterShader(e,t){S.GetShadersStore(1)[`${e}ComputeShader`]=t}}To._UniqueIdSeed=0;To.LogShaderCodeOnCompilationError=!0;class c_{constructor(){this._gpuTimeInFrameId=-1,this.counter=new vu}_addDuration(e,t){e<this._gpuTimeInFrameId||(this._gpuTimeInFrameId!==e?(this.counter._fetchResult(),this.counter.fetchNewFrame(),this.counter.addCount(t,!1),this._gpuTimeInFrameId=e):this.counter.addCount(t,!1))}}class on{get options(){return this._options}get shaderPath(){return this._shaderPath}constructor(e,t,i,r={}){if(this._bindings={},this._samplers={},this._contextIsDirty=!1,this.fastMode=!1,this.onCompiled=null,this.onError=null,this.name=e,this._engine=t,this.uniqueId=bn.UniqueId,t.enableGPUTimingMeasurements&&(this.gpuTimeInFrame=new c_),!this._engine.getCaps().supportComputeShaders){N.Error("This engine does not support compute shaders!");return}if(!r.bindingsMapping){N.Error("You must provide the binding mappings as browsers don't support reflection for wgsl shaders yet!");return}this._context=t.createComputeContext(),this._shaderPath=i,this._options={bindingsMapping:{},defines:[],...r}}getClassName(){return"ComputeShader"}setTexture(e,t,i=!0){const r=this._bindings[e];this._bindings[e]={type:i?0:4,object:t,indexInGroupEntries:r==null?void 0:r.indexInGroupEntries},this._contextIsDirty||(this._contextIsDirty=!r||r.object!==t||r.type!==this._bindings[e].type)}setInternalTexture(e,t){const i=this._bindings[e];this._bindings[e]={type:8,object:t,indexInGroupEntries:i==null?void 0:i.indexInGroupEntries},this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t||i.type!==this._bindings[e].type)}setStorageTexture(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:1,object:t,indexInGroupEntries:i==null?void 0:i.indexInGroupEntries}}setExternalTexture(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:6,object:t,indexInGroupEntries:i==null?void 0:i.indexInGroupEntries}}setVideoTexture(e,t){return t.externalTexture?(this.setExternalTexture(e,t.externalTexture),!0):!1}setUniformBuffer(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:on._BufferIsDataBuffer(t)?7:2,object:t,indexInGroupEntries:i==null?void 0:i.indexInGroupEntries}}setStorageBuffer(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:on._BufferIsDataBuffer(t)?7:3,object:t,indexInGroupEntries:i==null?void 0:i.indexInGroupEntries}}setTextureSampler(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||!t.compareSampler(i.object)),this._bindings[e]={type:5,object:t,indexInGroupEntries:i==null?void 0:i.indexInGroupEntries}}isReady(){let e=this._effect;for(const n in this._bindings){const a=this._bindings[n],o=a.type,l=a.object;switch(o){case 0:case 4:case 1:{if(!l.isReady())return!1;break}case 6:{if(!l.isReady())return!1;break}}}const t=[],i=this._shaderPath;if(this._options.defines)for(let n=0;n<this._options.defines.length;n++)t.push(this._options.defines[n]);const r=t.join(`
`);return this._cachedDefines!==r&&(this._cachedDefines=r,e=this._engine.createComputeEffect(i,{defines:r,entryPoint:this._options.entryPoint,onCompiled:this.onCompiled,onError:this.onError}),this._effect=e),!!e.isReady()}dispatch(e,t,i){return!this.fastMode&&!this._checkContext()?!1:(this._engine.computeDispatch(this._effect,this._context,this._bindings,e,t,i,this._options.bindingsMapping,this.gpuTimeInFrame),!0)}dispatchIndirect(e,t=0){if(!this.fastMode&&!this._checkContext())return!1;const i=on._BufferIsDataBuffer(e)?e:e.getBuffer();return this._engine.computeDispatchIndirect(this._effect,this._context,this._bindings,i,t,this._options.bindingsMapping,this.gpuTimeInFrame),!0}_checkContext(){var e;if(!this.isReady())return!1;for(const t in this._bindings){const i=this._bindings[t];if(!this._options.bindingsMapping[t])throw new Error("ComputeShader ('"+this.name+"'): No binding mapping has been provided for the property '"+t+"'");switch(i.type){case 0:{const r=this._samplers[t],n=i.object;(!r||!n._texture||!r.compareSampler(n._texture))&&(this._samplers[t]=new tI().setParameters(n.wrapU,n.wrapV,n.wrapR,n.anisotropicFilteringLevel,n._texture.samplingMode,(e=n._texture)==null?void 0:e._comparisonFunction),this._contextIsDirty=!0);break}case 6:{this._contextIsDirty=!0;break}case 2:{const r=i.object;r.getBuffer()!==i.buffer&&(i.buffer=r.getBuffer(),this._contextIsDirty=!0);break}}}return this._contextIsDirty&&(this._contextIsDirty=!1,this._context.clear()),!0}async dispatchWhenReady(e,t,i,r=10){return await new Promise(n=>{Wn(()=>this.dispatch(e,t,i),n,void 0,r)})}serialize(){const e=me.Serialize(this);e.options=this._options,e.shaderPath=this._shaderPath,e.bindings={},e.textures={};for(const t in this._bindings){const i=this._bindings[t],r=i.object;switch(i.type){case 0:case 4:case 1:{const n=r.serialize();n&&(e.textures[t]=n,e.bindings[t]={type:i.type});break}}}return e}static Parse(e,t,i){const r=me.Parse(()=>new on(e.name,t.getEngine(),e.shaderPath,e.options),e,t,i);for(const n in e.textures){const a=e.bindings[n],o=$.Parse(e.textures[n],t,i);a.type===0?r.setTexture(n,o):a.type===4?r.setTexture(n,o,!1):r.setStorageTexture(n,o)}return r}static _BufferIsDataBuffer(e){return e.underlyingResource!==void 0}}_([R()],on.prototype,"name",void 0);_([R()],on.prototype,"fastMode",void 0);y("BABYLON.ComputeShader",on);const Jg="gpuTransformVertexShader",ML=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
out vec3 outPosition;const mat4 identity=mat4(
vec4(1.0,0.0,0.0,0.0),
vec4(0.0,1.0,0.0,0.0),
vec4(0.0,0.0,1.0,0.0),
vec4(0.0,0.0,0.0,1.0)
);void main(void) {vec3 positionUpdated=position;
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
mat4 finalWorld=identity;
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);outPosition=worldPos.xyz;}`;S.ShadersStore[Jg]||(S.ShadersStore[Jg]=ML);const eS="gpuTransformPixelShader",FL=`#version 300 es
void main() {discard;}
`;S.ShadersStore[eS]||(S.ShadersStore[eS]=FL);const tS="boundingInfoComputeShader",LL=`struct Results {minX : atomic<i32>,
minY : atomic<i32>,
minZ : atomic<i32>,
maxX : atomic<i32>,
maxY : atomic<i32>,
maxZ : atomic<i32>,
dummy1 : i32,
dummy2 : i32,};fn floatToBits(value: f32)->i32 {return bitcast<i32>(value);}
fn bitsToFloat(value: i32)->f32 {return bitcast<f32>(value);}
fn atomicMinFloat(atomicVar: ptr<storage,atomic<i32>,read_write>,value: f32) {let intValue=floatToBits(value);loop {let oldIntValue=atomicLoad(atomicVar);let oldValue=bitsToFloat(oldIntValue);if (value>=oldValue) {break;}
if (atomicCompareExchangeWeak(atomicVar,oldIntValue,intValue).old_value==oldIntValue) {break;}}}
fn atomicMaxFloat(atomicVar: ptr<storage,atomic<i32>,read_write>,value: f32) {let intValue=floatToBits(value);loop {let oldIntValue=atomicLoad(atomicVar);let oldValue=bitsToFloat(oldIntValue);if (value<=oldValue) {break;}
if (atomicCompareExchangeWeak(atomicVar,oldIntValue,intValue).old_value==oldIntValue) {break;}}}
fn readMatrixFromRawSampler(smp : texture_2d<f32>,index : f32)->mat4x4<f32>
{let offset=i32(index) *4; 
let m0=textureLoad(smp,vec2<i32>(offset+0,0),0);let m1=textureLoad(smp,vec2<i32>(offset+1,0),0);let m2=textureLoad(smp,vec2<i32>(offset+2,0),0);let m3=textureLoad(smp,vec2<i32>(offset+3,0),0);return mat4x4<f32>(m0,m1,m2,m3);}
const identity=mat4x4f(
vec4f(1.0,0.0,0.0,0.0),
vec4f(0.0,1.0,0.0,0.0),
vec4f(0.0,0.0,1.0,0.0),
vec4f(0.0,0.0,0.0,1.0)
);struct Settings {morphTargetTextureInfo: vec3f,
morphTargetCount: f32,
indexResult : u32,};@group(0) @binding(0) var<storage,read> positionBuffer : array<f32>;@group(0) @binding(1) var<storage,read_write> resultBuffer : array<Results>;@group(0) @binding(7) var<uniform> settings : Settings;
#if NUM_BONE_INFLUENCERS>0
@group(0) @binding(2) var boneSampler : texture_2d<f32>;@group(0) @binding(3) var<storage,read> indexBuffer : array<vec4f>;@group(0) @binding(4) var<storage,read> weightBuffer : array<vec4f>;
#if NUM_BONE_INFLUENCERS>4
@group(0) @binding(5) var<storage,read> indexExtraBuffer : array<vec4f>;@group(0) @binding(6) var<storage,read> weightExtraBuffer : array<vec4f>;
#endif
#endif
#ifdef MORPHTARGETS
@group(0) @binding(8) var morphTargets : texture_2d_array<f32>;@group(0) @binding(9) var<storage,read> morphTargetInfluences : array<f32>;@group(0) @binding(10) var<storage,read> morphTargetTextureIndices : array<f32>;
#endif
#ifdef MORPHTARGETS
fn readVector3FromRawSampler(targetIndex : i32,vertexIndex : u32)->vec3f
{ 
let vertexID=f32(vertexIndex)*settings.morphTargetTextureInfo.x;let y=floor(vertexID/settings.morphTargetTextureInfo.y);let x=vertexID-y*settings.morphTargetTextureInfo.y;let textureUV=vec2<i32>(i32(x),i32(y));return textureLoad(morphTargets,textureUV,i32(morphTargetTextureIndices[targetIndex]),0).xyz;}
fn readVector4FromRawSampler(targetIndex : i32,vertexIndex : u32)->vec4f
{ 
let vertexID=f32(vertexIndex)*settings.morphTargetTextureInfo.x;let y=floor(vertexID/settings.morphTargetTextureInfo.y);let x=vertexID-y*settings.morphTargetTextureInfo.y;let textureUV=vec2<i32>(i32(x),i32(y));return textureLoad(morphTargets,textureUV,i32(morphTargetTextureIndices[targetIndex]),0);}
#endif
@compute @workgroup_size(256,1,1)
fn main(@builtin(global_invocation_id) global_id : vec3<u32>) {let index=global_id.x;if (index>=arrayLength(&positionBuffer)/3) {return;}
let position=vec3f(positionBuffer[index*3],positionBuffer[index*3+1],positionBuffer[index*3+2]);var finalWorld=identity;var positionUpdated=position;
#if NUM_BONE_INFLUENCERS>0
var influence : mat4x4<f32>;let matricesIndices=indexBuffer[index];let matricesWeights=weightBuffer[index];influence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];
#endif 
#if NUM_BONE_INFLUENCERS>4
let matricesIndicesExtra=indexExtraBuffer[index];let matricesWeightsExtra=weightExtraBuffer[index];influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.x)*matricesWeightsExtra.x;
#if NUM_BONE_INFLUENCERS>5
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.y)*matricesWeightsExtra.y;
#endif 
#if NUM_BONE_INFLUENCERS>6
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.z)*matricesWeightsExtra.z;
#endif 
#if NUM_BONE_INFLUENCERS>7
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.w)*matricesWeightsExtra.w;
#endif 
#endif 
finalWorld=finalWorld*influence;
#endif
#ifdef MORPHTARGETS
for (var i=0; i<NUM_MORPH_INFLUENCERS; i=i+1) {if (f32(i)>=settings.morphTargetCount) {break;}
positionUpdated=positionUpdated+(readVector3FromRawSampler(i,index)-position)*morphTargetInfluences[i];}
#endif
var worldPos=finalWorld*vec4f(positionUpdated.x,positionUpdated.y,positionUpdated.z,1.0);atomicMinFloat(&resultBuffer[settings.indexResult].minX,worldPos.x);atomicMinFloat(&resultBuffer[settings.indexResult].minY,worldPos.y);atomicMinFloat(&resultBuffer[settings.indexResult].minZ,worldPos.z);atomicMaxFloat(&resultBuffer[settings.indexResult].maxX,worldPos.x);atomicMaxFloat(&resultBuffer[settings.indexResult].maxY,worldPos.y);atomicMaxFloat(&resultBuffer[settings.indexResult].maxZ,worldPos.z);}
`;S.ShadersStoreWGSL[tS]||(S.ShadersStoreWGSL[tS]=LL);class Kc{constructor(e,t,i,r,n,a){this.entries=[],this._boundingVectors=new Array,this._capacity=i,this._depth=r,this._maxDepth=n,this._creationFunc=a,this._minPoint=e,this._maxPoint=t,this._boundingVectors.push(e.clone()),this._boundingVectors.push(t.clone()),this._boundingVectors.push(e.clone()),this._boundingVectors[2].x=t.x,this._boundingVectors.push(e.clone()),this._boundingVectors[3].y=t.y,this._boundingVectors.push(e.clone()),this._boundingVectors[4].z=t.z,this._boundingVectors.push(t.clone()),this._boundingVectors[5].z=e.z,this._boundingVectors.push(t.clone()),this._boundingVectors[6].x=e.x,this._boundingVectors.push(t.clone()),this._boundingVectors[7].y=e.y}get capacity(){return this._capacity}get minPoint(){return this._minPoint}get maxPoint(){return this._maxPoint}addEntry(e){if(this.blocks){for(let t=0;t<this.blocks.length;t++)this.blocks[t].addEntry(e);return}this._creationFunc(e,this),this.entries.length>this.capacity&&this._depth<this._maxDepth&&this.createInnerBlocks()}removeEntry(e){if(this.blocks){for(let i=0;i<this.blocks.length;i++)this.blocks[i].removeEntry(e);return}const t=this.entries.indexOf(e);t>-1&&this.entries.splice(t,1)}addEntries(e){for(let t=0;t<e.length;t++){const i=e[t];this.addEntry(i)}}select(e,t,i){if(ud.IsInFrustum(this._boundingVectors,e)){if(this.blocks){for(let r=0;r<this.blocks.length;r++)this.blocks[r].select(e,t,i);return}i?t.concat(this.entries):t.concatWithNoDuplicate(this.entries)}}intersects(e,t,i,r){if(ud.IntersectsSphere(this._minPoint,this._maxPoint,e,t)){if(this.blocks){for(let n=0;n<this.blocks.length;n++)this.blocks[n].intersects(e,t,i,r);return}r?i.concat(this.entries):i.concatWithNoDuplicate(this.entries)}}intersectsRay(e,t){if(e.intersectsBoxMinMax(this._minPoint,this._maxPoint)){if(this.blocks){for(let i=0;i<this.blocks.length;i++)this.blocks[i].intersectsRay(e,t);return}t.concatWithNoDuplicate(this.entries)}}createInnerBlocks(){Kc._CreateBlocks(this._minPoint,this._maxPoint,this.entries,this._capacity,this._depth,this._maxDepth,this,this._creationFunc),this.entries.splice(0)}static _CreateBlocks(e,t,i,r,n,a,o,l){o.blocks=new Array;const c=new x((t.x-e.x)/2,(t.y-e.y)/2,(t.z-e.z)/2);for(let u=0;u<2;u++)for(let h=0;h<2;h++)for(let d=0;d<2;d++){const f=e.add(c.multiplyByFloats(u,h,d)),m=e.add(c.multiplyByFloats(u+1,h+1,d+1)),g=new Kc(f,m,r,n+1,a,l);g.addEntries(i),o.blocks.push(g)}}}class bo{constructor(e,t,i=2){this.maxDepth=i,this.dynamicContent=[],this._maxBlockCapacity=t||64,this._selectionContent=new eD(1024),this._creationFunc=e}update(e,t,i){Kc._CreateBlocks(e,t,i,this._maxBlockCapacity,0,this.maxDepth,this,this._creationFunc)}addMesh(e){for(let t=0;t<this.blocks.length;t++)this.blocks[t].addEntry(e)}removeMesh(e){for(let t=0;t<this.blocks.length;t++)this.blocks[t].removeEntry(e)}select(e,t){this._selectionContent.reset();for(let i=0;i<this.blocks.length;i++)this.blocks[i].select(e,this._selectionContent,t);return t?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}intersects(e,t,i){this._selectionContent.reset();for(let r=0;r<this.blocks.length;r++)this.blocks[r].intersects(e,t,this._selectionContent,i);return i?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}intersectsRay(e){this._selectionContent.reset();for(let t=0;t<this.blocks.length;t++)this.blocks[t].intersectsRay(e,this._selectionContent);return this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}}bo.CreationFuncForMeshes=(s,e)=>{const t=s.getBoundingInfo();!s.isBlocked&&t.boundingBox.intersectsMinMax(e.minPoint,e.maxPoint)&&e.entries.push(s)};bo.CreationFuncForSubMeshes=(s,e)=>{s.getBoundingInfo().boundingBox.intersectsMinMax(e.minPoint,e.maxPoint)&&e.entries.push(s)};le.prototype.createOrUpdateSelectionOctree=function(s=64,e=2){let t=this._getComponent(se.NAME_OCTREE);t||(t=new sR(this),this._addComponent(t)),this._selectionOctree||(this._selectionOctree=new bo(bo.CreationFuncForMeshes,s,e));const i=this.getWorldExtends();return this._selectionOctree.update(i.min,i.max,this.meshes),this._selectionOctree};Object.defineProperty(le.prototype,"selectionOctree",{get:function(){return this._selectionOctree},enumerable:!0,configurable:!0});Mt.prototype.createOrUpdateSubmeshesOctree=function(s=64,e=2){const t=this.getScene();let i=t._getComponent(se.NAME_OCTREE);i||(i=new sR(t),t._addComponent(i)),this._submeshesOctree||(this._submeshesOctree=new bo(bo.CreationFuncForSubMeshes,s,e)),this.computeWorldMatrix(!0);const n=this.getBoundingInfo().boundingBox;return this._submeshesOctree.update(n.minimumWorld,n.maximumWorld,this.subMeshes),this._submeshesOctree};class sR{constructor(e){this.name=se.NAME_OCTREE,this.checksIsEnabled=!0,this._tempRay=new xe(x.Zero(),new x(1,1,1)),e=e||De.LastCreatedScene,e&&(this.scene=e,this.scene.getActiveMeshCandidates=()=>this.getActiveMeshCandidates(),this.scene.getActiveSubMeshCandidates=t=>this.getActiveSubMeshCandidates(t),this.scene.getCollidingSubMeshCandidates=(t,i)=>this.getCollidingSubMeshCandidates(t,i),this.scene.getIntersectingSubMeshCandidates=(t,i)=>this.getIntersectingSubMeshCandidates(t,i))}register(){this.scene.onMeshRemovedObservable.add(e=>{const t=this.scene.selectionOctree;if(t!=null){const i=t.dynamicContent.indexOf(e);i!==-1&&t.dynamicContent.splice(i,1)}}),this.scene.onMeshImportedObservable.add(e=>{const t=this.scene.selectionOctree;t!=null&&t.addMesh(e)})}getActiveMeshCandidates(){var e;return((e=this.scene._selectionOctree)==null?void 0:e.select(this.scene.frustumPlanes))||this.scene._getDefaultMeshCandidates()}getActiveSubMeshCandidates(e){return e._submeshesOctree&&e.useOctreeForRenderingSelection?e._submeshesOctree.select(this.scene.frustumPlanes):this.scene._getDefaultSubMeshCandidates(e)}getIntersectingSubMeshCandidates(e,t){return e._submeshesOctree&&e.useOctreeForPicking?(xe.TransformToRef(t,e.getWorldMatrix(),this._tempRay),e._submeshesOctree.intersectsRay(this._tempRay)):this.scene._getDefaultSubMeshCandidates(e)}getCollidingSubMeshCandidates(e,t){if(e._submeshesOctree&&e.useOctreeForCollisions){const i=t._velocityWorldLength+Math.max(t._radius.x,t._radius.y,t._radius.z);return e._submeshesOctree.intersects(t._basePointWorld,i)}return this.scene._getDefaultSubMeshCandidates(e)}rebuild(){}dispose(){}}class Lt{getRenderCamera(e){if(this._renderCamera)return this._renderCamera;{let t;return this.originalScene.activeCameras&&this.originalScene.activeCameras.length>1?t=this.originalScene.activeCameras[this.originalScene.activeCameras.length-1]:t=this.originalScene.activeCamera,e&&t&&t.isRigCamera?t.rigParent:t}}setRenderCamera(e){this._renderCamera=e}_getSharedGizmoLight(){return this._sharedGizmoLight||(this._sharedGizmoLight=new Lm("shared gizmo light",new x(0,1,0),this.utilityLayerScene),this._sharedGizmoLight.intensity=2,this._sharedGizmoLight.groundColor=q.Gray()),this._sharedGizmoLight}static get DefaultUtilityLayer(){return Lt._DefaultUtilityLayer==null?Lt._CreateDefaultUtilityLayerFromScene(De.LastCreatedScene):Lt._DefaultUtilityLayer}static _CreateDefaultUtilityLayerFromScene(e){return Lt._DefaultUtilityLayer=new Lt(e),Lt._DefaultUtilityLayer.originalScene.onDisposeObservable.addOnce(()=>{Lt._DefaultUtilityLayer=null}),Lt._DefaultUtilityLayer}static get DefaultKeepDepthUtilityLayer(){return Lt._DefaultKeepDepthUtilityLayer==null&&(Lt._DefaultKeepDepthUtilityLayer=new Lt(De.LastCreatedScene),Lt._DefaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,Lt._DefaultKeepDepthUtilityLayer.originalScene.onDisposeObservable.addOnce(()=>{Lt._DefaultKeepDepthUtilityLayer=null})),Lt._DefaultKeepDepthUtilityLayer}constructor(e,t=!0,i=!1){this.originalScene=e,this.handleEvents=t,this._pointerCaptures={},this._lastPointerEvents={},this._sharedGizmoLight=null,this._renderCamera=null,this.pickUtilitySceneFirst=!0,this.shouldRender=!0,this.onlyCheckPointerDownEvents=!0,this.processAllEvents=!1,this.pickingEnabled=!0,this.onPointerOutObservable=new k,this.utilityLayerScene=new le(e.getEngine(),{virtual:!0}),this.utilityLayerScene.useRightHandedSystem=e.useRightHandedSystem,this.utilityLayerScene._allowPostProcessClearColor=!1,this.utilityLayerScene.postProcessesEnabled=!1,this.utilityLayerScene.detachControl(),t&&(this._originalPointerObserver=e.onPrePointerObservable.add(r=>{var l;if(!this.utilityLayerScene.activeCamera||!this.pickingEnabled||!this.processAllEvents&&r.type!==ze.POINTERMOVE&&r.type!==ze.POINTERUP&&r.type!==ze.POINTERDOWN&&r.type!==ze.POINTERDOUBLETAP)return;this.utilityLayerScene.pointerX=e.pointerX,this.utilityLayerScene.pointerY=e.pointerY;const n=r.event;if(e.isPointerCaptured(n.pointerId)){this._pointerCaptures[n.pointerId]=!1;return}const a=c=>{let u=null;if(r.nearInteractionPickingInfo)r.nearInteractionPickingInfo.pickedMesh.getScene()==c?u=r.nearInteractionPickingInfo:u=new Li;else if(c!==this.utilityLayerScene&&r.originalPickingInfo)u=r.originalPickingInfo;else{let h=null;this._renderCamera&&(h=c._activeCamera,c._activeCamera=this._renderCamera,r.ray=null),u=r.ray?c.pickWithRay(r.ray):c.pick(e.pointerX,e.pointerY),h&&(c._activeCamera=h)}return u},o=a(this.utilityLayerScene);if(!r.ray&&o&&(r.ray=o.ray),(l=r.originalPickingInfo)!=null&&l.aimTransform&&o&&(o.aimTransform=r.originalPickingInfo.aimTransform,o.gripTransform=r.originalPickingInfo.gripTransform),this.utilityLayerScene.onPrePointerObservable.notifyObservers(r),this.onlyCheckPointerDownEvents&&r.type!=ze.POINTERDOWN){r.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new kh(r.type,r.event,o),r.type),r.type===ze.POINTERUP&&this._pointerCaptures[n.pointerId]&&(this._pointerCaptures[n.pointerId]=!1);return}if(this.utilityLayerScene.autoClearDepthAndStencil||this.pickUtilitySceneFirst)o&&o.hit&&(r.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new kh(r.type,r.event,o),r.type),r.skipOnPointerObservable=!0);else{const c=a(e),u=r.event;c&&o&&(o.distance===0&&c.pickedMesh?this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(c.pickedMesh)?(this._notifyObservers(r,c,u),r.skipOnPointerObservable=!0):r.type===ze.POINTERDOWN?(this._pointerCaptures[u.pointerId]=!0,this._notifyObservers(r,c,u)):(r.type===ze.POINTERMOVE||r.type===ze.POINTERUP)&&(this._lastPointerEvents[u.pointerId]&&(this.onPointerOutObservable.notifyObservers(u.pointerId),delete this._lastPointerEvents[u.pointerId]),this._notifyObservers(r,c,u)):!this._pointerCaptures[u.pointerId]&&(o.distance<c.distance||c.distance===0)?(this._notifyObservers(r,o,u),r.skipOnPointerObservable||(r.skipOnPointerObservable=o.distance>0)):!this._pointerCaptures[u.pointerId]&&o.distance>=c.distance&&(this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(c.pickedMesh)?(this._notifyObservers(r,c,u),r.skipOnPointerObservable=!0):((r.type===ze.POINTERMOVE||r.type===ze.POINTERUP)&&this._lastPointerEvents[u.pointerId]&&(this.onPointerOutObservable.notifyObservers(u.pointerId),delete this._lastPointerEvents[u.pointerId]),this._notifyObservers(r,o,u))),r.type===ze.POINTERUP&&this._pointerCaptures[u.pointerId]&&(this._pointerCaptures[u.pointerId]=!1))}}),this._originalPointerObserver&&e.onPrePointerObservable.makeObserverTopPriority(this._originalPointerObserver)),this.utilityLayerScene.autoClear=!1,i||(this._afterRenderObserver=this.originalScene.onAfterRenderCameraObservable.add(r=>{this.shouldRender&&r==this.getRenderCamera()&&this.render()})),this._sceneDisposeObserver=this.originalScene.onDisposeObservable.add(()=>{this.dispose()}),this._updateCamera()}_notifyObservers(e,t,i){e.skipOnPointerObservable||(this.utilityLayerScene.onPointerObservable.notifyObservers(new kh(e.type,e.event,t),e.type),this._lastPointerEvents[i.pointerId]=!0)}render(){if(this._updateCamera(),this.utilityLayerScene.activeCamera){const e=this.utilityLayerScene.activeCamera.getScene(),t=this.utilityLayerScene.activeCamera;t._scene=this.utilityLayerScene,t.leftCamera&&(t.leftCamera._scene=this.utilityLayerScene),t.rightCamera&&(t.rightCamera._scene=this.utilityLayerScene),this.utilityLayerScene.render(!1),t._scene=e,t.leftCamera&&(t.leftCamera._scene=e),t.rightCamera&&(t.rightCamera._scene=e)}}dispose(){this.onPointerOutObservable.clear(),this._afterRenderObserver&&this.originalScene.onAfterCameraRenderObservable.remove(this._afterRenderObserver),this._sceneDisposeObserver&&this.originalScene.onDisposeObservable.remove(this._sceneDisposeObserver),this._originalPointerObserver&&this.originalScene.onPrePointerObservable.remove(this._originalPointerObserver),this.utilityLayerScene.dispose()}_updateCamera(){this.utilityLayerScene.cameraToUseForPointers=this.getRenderCamera(),this.utilityLayerScene.activeCamera=this.getRenderCamera()}}Lt._DefaultUtilityLayer=null;Lt._DefaultKeepDepthUtilityLayer=null;var iS;(function(s){s[s.Origin=0]="Origin",s[s.Pivot=1]="Pivot"})(iS||(iS={}));var rS;(function(s){s[s.World=0]="World",s[s.Local=1]="Local"})(rS||(rS={}));Object.defineProperty(le.prototype,"debugLayer",{get:function(){return this._debugLayer||(this._debugLayer=new Co(this)),this._debugLayer},enumerable:!0,configurable:!0});var sS;(function(s){s[s.Properties=0]="Properties",s[s.Debug=1]="Debug",s[s.Statistics=2]="Statistics",s[s.Tools=3]="Tools",s[s.Settings=4]="Settings"})(sS||(sS={}));class Co{get onPropertyChangedObservable(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable:(this._onPropertyChangedObservable||(this._onPropertyChangedObservable=new k),this._onPropertyChangedObservable)}get onSelectionChangedObservable(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable:(this._onSelectionChangedObservable||(this._onSelectionChangedObservable=new k),this._onSelectionChangedObservable)}constructor(e){this.BJSINSPECTOR=this._getGlobalInspector(),this._scene=e||De.LastCreatedScene,this._scene&&this._scene.onDisposeObservable.add(()=>{this._scene._debugLayer&&this._scene._debugLayer.hide()})}_createInspector(e){if(this.isVisible())return;if(this._onPropertyChangedObservable){for(const i of this._onPropertyChangedObservable.observers)this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable.add(i);this._onPropertyChangedObservable.clear(),this._onPropertyChangedObservable=void 0}if(this._onSelectionChangedObservable){for(const i of this._onSelectionChangedObservable.observers)this.BJSINSPECTOR.Inspector.OnSelectionChangedObservable.add(i);this._onSelectionChangedObservable.clear(),this._onSelectionChangedObservable=void 0}const t={...Co.Config,...e};this.BJSINSPECTOR=this.BJSINSPECTOR||this._getGlobalInspector(),this.BJSINSPECTOR.Inspector.Show(this._scene,t)}select(e,t){this.BJSINSPECTOR&&(t&&(Object.prototype.toString.call(t)=="[object String]"?this.BJSINSPECTOR.Inspector.MarkLineContainerTitleForHighlighting(t):this.BJSINSPECTOR.Inspector.MarkMultipleLineContainerTitlesForHighlighting(t)),this.BJSINSPECTOR.Inspector.IsVisible?this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable.notifyObservers(e):setTimeout(()=>{this.select(e,t)},100))}_getGlobalInspector(){if(typeof INSPECTOR<"u")return INSPECTOR;if(typeof BABYLON<"u"&&typeof BABYLON.Inspector<"u")return BABYLON}isVisible(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.IsVisible}hide(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.Hide()}get openedPanes(){return this.BJSINSPECTOR?this.BJSINSPECTOR.Inspector._OpenedPane:0}setAsActiveScene(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector._SetNewScene(this._scene)}popupSceneExplorer(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.PopupSceneExplorer()}popupInspector(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.PopupInspector()}popupEmbed(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.PopupEmbed()}async show(e){return await new Promise(t=>{if(typeof this.BJSINSPECTOR>"u"){const i=e&&e.inspectorURL?e.inspectorURL:Co.InspectorURL;j.LoadBabylonScript(i,()=>{this._createInspector(e),t(this)})}else this._createInspector(e),t(this)})}}Co.InspectorURL=`${j._DefaultCdnUrl}/v${te.Version}/inspector/babylon.inspector.bundle.js`;Co.Config={overlay:!1,showExplorer:!0,showInspector:!0,embedMode:!1,handleResize:!0,enablePopup:!0};class xt{constructor(e,t){this.type=e,this.jointData=t,t.nativeParams=t.nativeParams||{}}get physicsJoint(){return this._physicsJoint}set physicsJoint(e){this._physicsJoint=e}set physicsPlugin(e){this._physicsPlugin=e}executeNativeFunction(e){e(this._physicsPlugin.world,this._physicsJoint)}}xt.DistanceJoint=0;xt.HingeJoint=1;xt.BallAndSocketJoint=2;xt.WheelJoint=3;xt.SliderJoint=4;xt.PrismaticJoint=5;xt.UniversalJoint=6;xt.Hinge2Joint=xt.WheelJoint;xt.PointToPointJoint=8;xt.SpringJoint=9;xt.LockJoint=10;Oe._PhysicsImpostorParser=function(s,e,t){return new ue(e,t.physicsImpostor,{mass:t.physicsMass,friction:t.physicsFriction,restitution:t.physicsRestitution},s)};class ue{get isDisposed(){return this._isDisposed}get mass(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyMass(this):0}set mass(e){this.setMass(e)}get friction(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyFriction(this):0}set friction(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyFriction(this,e)}get restitution(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyRestitution(this):0}set restitution(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyRestitution(this,e)}get pressure(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.setBodyPressure?e.getBodyPressure(this):0}set pressure(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyPressure&&t.setBodyPressure(this,e)}get stiffness(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyStiffness?e.getBodyStiffness(this):0}set stiffness(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyStiffness&&t.setBodyStiffness(this,e)}get velocityIterations(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyVelocityIterations?e.getBodyVelocityIterations(this):0}set velocityIterations(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyVelocityIterations&&t.setBodyVelocityIterations(this,e)}get positionIterations(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyPositionIterations?e.getBodyPositionIterations(this):0}set positionIterations(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyPositionIterations&&t.setBodyPositionIterations(this,e)}constructor(e,t,i={mass:0},r){if(this.object=e,this.type=t,this._options=i,this._scene=r,this._pluginData={},this._bodyUpdateRequired=!1,this._onBeforePhysicsStepCallbacks=new Array,this._onAfterPhysicsStepCallbacks=new Array,this._onPhysicsCollideCallbacks=[],this._deltaPosition=x.Zero(),this._isDisposed=!1,this.soft=!1,this.segments=0,this._tmpQuat=new Z,this._tmpQuat2=new Z,this.beforeStep=()=>{if(this._physicsEngine){this.object.translate(this._deltaPosition,-1),this._deltaRotationConjugated&&this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotationConjugated,this.object.rotationQuaternion),this.object.computeWorldMatrix(!1),this.object.parent&&this.object.rotationQuaternion?(this.getParentsRotation(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this._tmpQuat)):this._tmpQuat.copyFrom(this.object.rotationQuaternion||new Z),this._options.disableBidirectionalTransformation||this.object.rotationQuaternion&&this._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(this,this.object.getAbsolutePosition(),this._tmpQuat);for(const n of this._onBeforePhysicsStepCallbacks)n(this)}},this.afterStep=()=>{if(this._physicsEngine){for(const n of this._onAfterPhysicsStepCallbacks)n(this);this._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(this),this.object.parent&&this.object.rotationQuaternion&&(this.getParentsRotation(),this._tmpQuat.conjugateInPlace(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this.object.rotationQuaternion)),this.object.setAbsolutePosition(this.object.position),this._deltaRotation?(this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotation,this.object.rotationQuaternion),this._deltaPosition.applyRotationQuaternionToRef(this._deltaRotation,ue._TmpVecs[0]),this.object.translate(ue._TmpVecs[0],1)):this.object.translate(this._deltaPosition,1),this.object.computeWorldMatrix(!0)}},this.onCollideEvent=null,this.onCollide=n=>{if(!this._onPhysicsCollideCallbacks.length&&!this.onCollideEvent||!this._physicsEngine)return;const a=this._physicsEngine.getImpostorWithPhysicsBody(n.body);if(a){this.onCollideEvent&&this.onCollideEvent(this,a);const o=this._onPhysicsCollideCallbacks.filter(l=>l.otherImpostors.indexOf(a)!==-1);for(const l of o)l.callback(this,a,n.point,n.distance,n.impulse,n.normal)}},!this.object){N.Error("No object was provided. A physics object is obligatory");return}this.object.parent&&i.mass!==0&&N.Warn("A physics impostor has been created for an object which has a parent. Babylon physics currently works in local space so unexpected issues may occur."),!this._scene&&e.getScene&&(this._scene=e.getScene()),this._scene&&(this.type>100&&(this.soft=!0),this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine?(this.object.rotationQuaternion||(this.object.rotation?this.object.rotationQuaternion=Z.RotationYawPitchRoll(this.object.rotation.y,this.object.rotation.x,this.object.rotation.z):this.object.rotationQuaternion=new Z),this._options.mass=i.mass===void 0?0:i.mass,this._options.friction=i.friction===void 0?.2:i.friction,this._options.restitution=i.restitution===void 0?.2:i.restitution,this.soft&&(this._options.mass=this._options.mass>0?this._options.mass:1,this._options.pressure=i.pressure===void 0?200:i.pressure,this._options.stiffness=i.stiffness===void 0?1:i.stiffness,this._options.velocityIterations=i.velocityIterations===void 0?20:i.velocityIterations,this._options.positionIterations=i.positionIterations===void 0?20:i.positionIterations,this._options.fixedPoints=i.fixedPoints===void 0?0:i.fixedPoints,this._options.margin=i.margin===void 0?0:i.margin,this._options.damping=i.damping===void 0?0:i.damping,this._options.path=i.path===void 0?null:i.path,this._options.shape=i.shape===void 0?null:i.shape),this._joints=[],!this.object.parent||this._options.ignoreParent?this._init():this.object.parent.physicsImpostor&&N.Warn("You must affect impostors to children before affecting impostor to parent.")):N.Error("Physics not enabled. Please use scene.enablePhysics(...) before creating impostors."))}_init(){this._physicsEngine&&(this._physicsEngine.removeImpostor(this),this.physicsBody=null,this._parent=this._parent||this._getPhysicsParent(),!this._isDisposed&&(!this.parent||this._options.ignoreParent)&&this._physicsEngine.addImpostor(this))}_getPhysicsParent(){return this.object.parent instanceof Mt?this.object.parent.physicsImpostor:null}isBodyInitRequired(){return this._bodyUpdateRequired||!this._physicsBody&&(!this._parent||!!this._options.ignoreParent)}setScalingUpdated(){this.forceUpdate()}forceUpdate(){this._init(),this.parent&&!this._options.ignoreParent&&this.parent.forceUpdate()}get physicsBody(){return this._parent&&!this._options.ignoreParent?this._parent.physicsBody:this._physicsBody}get parent(){return!this._options.ignoreParent&&this._parent?this._parent:null}set parent(e){this._parent=e}set physicsBody(e){this._physicsBody&&this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this),this._physicsBody=e,this.resetUpdateFlags()}resetUpdateFlags(){this._bodyUpdateRequired=!1}getObjectExtents(){if(this.object.getBoundingInfo){const e=this.object.rotationQuaternion,t=this.object.scaling.clone();this.object.rotationQuaternion=ue.IDENTITY_QUATERNION;const i=this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0);i&&i.decompose(t,void 0,void 0);const n=this.object.getBoundingInfo().boundingBox.extendSize.scale(2).multiplyInPlace(t);return n.x=Math.abs(n.x),n.y=Math.abs(n.y),n.z=Math.abs(n.z),this.object.rotationQuaternion=e,this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0),n}else return ue.DEFAULT_OBJECT_SIZE}getObjectCenter(){return this.object.getBoundingInfo?this.object.getBoundingInfo().boundingBox.centerWorld:this.object.position}getParam(e){return this._options[e]}setParam(e,t){this._options[e]=t,this._bodyUpdateRequired=!0}setMass(e){this.getParam("mass")!==e&&this.setParam("mass",e),this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyMass(this,e)}getLinearVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this):x.Zero()}setLinearVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this,e)}getAngularVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this):x.Zero()}setAngularVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this,e)}executeNativeFunction(e){this._physicsEngine&&e(this._physicsEngine.getPhysicsPlugin().world,this.physicsBody)}registerBeforePhysicsStep(e){this._onBeforePhysicsStepCallbacks.push(e)}unregisterBeforePhysicsStep(e){const t=this._onBeforePhysicsStepCallbacks.indexOf(e);t>-1?this._onBeforePhysicsStepCallbacks.splice(t,1):N.Warn("Function to remove was not found")}registerAfterPhysicsStep(e){this._onAfterPhysicsStepCallbacks.push(e)}unregisterAfterPhysicsStep(e){const t=this._onAfterPhysicsStepCallbacks.indexOf(e);t>-1?this._onAfterPhysicsStepCallbacks.splice(t,1):N.Warn("Function to remove was not found")}registerOnPhysicsCollide(e,t){const i=e instanceof Array?e:[e];this._onPhysicsCollideCallbacks.push({callback:t,otherImpostors:i})}unregisterOnPhysicsCollide(e,t){const i=e instanceof Array?e:[e];let r=-1;this._onPhysicsCollideCallbacks.some((a,o)=>{if(a.callback===t&&a.otherImpostors.length===i.length){const l=a.otherImpostors.every(c=>i.indexOf(c)>-1);return l&&(r=o),l}return!1})?this._onPhysicsCollideCallbacks.splice(r,1):N.Warn("Function to remove was not found")}getParentsRotation(){let e=this.object.parent;for(this._tmpQuat.copyFromFloats(0,0,0,1);e;)e.rotationQuaternion?this._tmpQuat2.copyFrom(e.rotationQuaternion):Z.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,e.rotation.z,this._tmpQuat2),this._tmpQuat.multiplyToRef(this._tmpQuat2,this._tmpQuat),e=e.parent;return this._tmpQuat}applyForce(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyForce(this,e,t),this}applyImpulse(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyImpulse(this,e,t),this}createJoint(e,t,i){const r=new xt(t,i);return this.addJoint(e,r),this}addJoint(e,t){return this._joints.push({otherImpostor:e,joint:t}),this._physicsEngine&&this._physicsEngine.addJoint(this,e,t),this}addAnchor(e,t,i,r,n){if(!this._physicsEngine)return this;const a=this._physicsEngine.getPhysicsPlugin();return a.appendAnchor?(this._physicsEngine&&a.appendAnchor(this,e,t,i,r,n),this):this}addHook(e,t,i,r){if(!this._physicsEngine)return this;const n=this._physicsEngine.getPhysicsPlugin();return n.appendAnchor?(this._physicsEngine&&n.appendHook(this,e,t,i,r),this):this}sleep(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().sleepBody(this),this}wakeUp(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().wakeUpBody(this),this}clone(e){return e?new ue(e,this.type,this._options,this._scene):null}dispose(){if(this._physicsEngine){for(const e of this._joints)this._physicsEngine&&this._physicsEngine.removeJoint(this,e.otherImpostor,e.joint);this._physicsEngine.removeImpostor(this),this.parent&&this.parent.forceUpdate(),this._isDisposed=!0}}setDeltaPosition(e){this._deltaPosition.copyFrom(e)}setDeltaRotation(e){this._deltaRotation||(this._deltaRotation=new Z),this._deltaRotation.copyFrom(e),this._deltaRotationConjugated=this._deltaRotation.conjugate()}getBoxSizeToRef(e){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().getBoxSizeToRef(this,e),this}getRadius(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getRadius(this):0}syncBoneWithImpostor(e,t,i,r,n){const a=ue._TmpVecs[0],o=this.object;if(o.rotationQuaternion)if(n){const l=ue._TmpQuat;o.rotationQuaternion.multiplyToRef(n,l),e.setRotationQuaternion(l,1,t)}else e.setRotationQuaternion(o.rotationQuaternion,1,t);a.x=0,a.y=0,a.z=0,i&&(a.x=i.x,a.y=i.y,a.z=i.z,e.getDirectionToRef(a,t,a),r==null&&(r=i.length()),a.x*=r,a.y*=r,a.z*=r),e.getParent()?(a.addInPlace(o.getAbsolutePosition()),e.setAbsolutePosition(a,t)):(t.setAbsolutePosition(o.getAbsolutePosition()),t.position.x-=a.x,t.position.y-=a.y,t.position.z-=a.z)}syncImpostorWithBone(e,t,i,r,n,a){const o=this.object;if(o.rotationQuaternion)if(n){const u=ue._TmpQuat;e.getRotationQuaternionToRef(1,t,u),u.multiplyToRef(n,o.rotationQuaternion)}else e.getRotationQuaternionToRef(1,t,o.rotationQuaternion);const l=ue._TmpVecs[0],c=ue._TmpVecs[1];a||(a=ue._TmpVecs[2],a.x=0,a.y=1,a.z=0),e.getDirectionToRef(a,t,c),e.getAbsolutePositionToRef(t,l),r==null&&i&&(r=i.length()),r!=null&&(l.x+=c.x*r,l.y+=c.y*r,l.z+=c.z*r),o.setAbsolutePosition(l)}}ue.DEFAULT_OBJECT_SIZE=new x(1,1,1);ue.IDENTITY_QUATERNION=Z.Identity();ue._TmpVecs=Fo(3,x.Zero);ue._TmpQuat=Z.Identity();ue.NoImpostor=0;ue.SphereImpostor=1;ue.BoxImpostor=2;ue.PlaneImpostor=3;ue.MeshImpostor=4;ue.CapsuleImpostor=6;ue.CylinderImpostor=7;ue.ParticleImpostor=8;ue.HeightmapImpostor=9;ue.ConvexHullImpostor=10;ue.CustomImpostor=100;ue.RopeImpostor=101;ue.ClothImpostor=102;ue.SoftbodyImpostor=103;const wL=[new Te(0,0,0,0),new Te(1,1,1,1),new Te(0,0,0,0)];class _d extends Br{get camera(){return this._camera}set camera(e){this._camera=e,this._renderer.activeCamera=this.camera}get reverseCulling(){return this._reverseCulling}set reverseCulling(e){this._reverseCulling=e;const t=Ei.GetConfiguration(this._renderer.renderPassId);t&&(t.reverseCulling=e)}get objectRenderer(){return this._renderer}get name(){return this._name}set name(e){this._name=e,this._renderer&&(this._renderer.name=e)}get forceLayerMaskCheck(){return this._forceLayerMaskCheck}set forceLayerMaskCheck(e){e!==this._forceLayerMaskCheck&&(this._forceLayerMaskCheck=e,this._renderer.forceLayerMaskCheck=e)}constructor(e,t,i,r){super(e,t),this.depthTest=!0,this.depthWrite=!0,this.size={width:100,height:100},this.sizeIsPercentage=!0,this.samples=1,this._reverseCulling=!1,this.dontRenderWhenMaterialDepthWriteIsDisabled=!0,this.textureDescriptions=[],this._forceLayerMaskCheck=!0,this._scene=i,this._engine=this._scene.getEngine(),this._renderer=new iI(e,i,r),this._renderer.renderSprites=!1,this._renderer.renderParticles=!1,this._renderer.enableBoundingBoxRendering=!1,this._renderer.enableOutlineRendering=!1,this._renderer.disableDepthPrePass=!0,this._renderer.customIsReadyFunction=(n,a,o)=>this.dontRenderWhenMaterialDepthWriteIsDisabled&&n.material&&n.material.disableDepthWrite?!!o:n.isReady(a===0),this._renderer.onBeforeRenderingManagerRenderObservable.add(()=>{this._renderer.options.doNotChangeAspectRatio||i.updateTransformMatrix(!0)}),this.name=e,this._clearAttachmentsLayout=new Map,this._allAttachmentsLayout=[],this.outputDepthTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryViewDepthTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryNormViewDepthTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryScreenDepthTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryViewNormalTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryWorldNormalTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryLocalPositionTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryWorldPositionTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryAlbedoTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryReflectivityTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryVelocityTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryLinearVelocityTexture=this._frameGraph.textureManager.createDanglingHandle()}get excludedSkinnedMeshFromVelocityTexture(){return Ei.GetConfiguration(this._renderer.renderPassId).excludedSkinnedMesh}excludeSkinnedMeshFromVelocityTexture(e){if(e.skeleton){const t=this.excludedSkinnedMeshFromVelocityTexture;t.indexOf(e)===-1&&t.push(e)}}removeExcludedSkinnedMeshFromVelocityTexture(e){const t=this.excludedSkinnedMeshFromVelocityTexture,i=t.indexOf(e);i!==-1&&t.splice(i,1)}isReady(){return this._renderer.isReadyForRendering(this._textureWidth,this._textureHeight)}record(){if(this.objectList===void 0)throw new Error(`FrameGraphGeometryRendererTask ${this.name}: object list must be provided`);this._renderer.renderList=this.objectList.meshes,this._renderer.particleSystemList=this.objectList.particleSystems;const e=this._createMultiRenderTargetTexture(),t=this._checkDepthTextureCompatibility();this._buildClearAttachmentsLayout(),this._registerForRenderPassId(this._renderer.renderPassId);const i=e.length>0?this._frameGraph.textureManager.getTextureDescription(e[0]):null;this._textureWidth=(i==null?void 0:i.size.width)??0,this._textureHeight=(i==null?void 0:i.size.height)??0,Ei.MarkAsDirty(this._renderer.renderPassId,this.objectList.meshes||this._scene.meshes);const r=this._frameGraph.addRenderPass(this.name);r.setRenderTarget(e);let n=!1;for(let o=0;o<this.textureDescriptions.length;o++){const l=this.textureDescriptions[o],c=e[o],u=Ei.GeometryTextureDescriptions.findIndex(d=>d.type===l.type);switch(Ei.GeometryTextureDescriptions[u].type){case 5:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryViewDepthTexture,c);break;case 13:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryNormViewDepthTexture,c);break;case 10:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryScreenDepthTexture,c);break;case 6:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryViewNormalTexture,c);break;case 8:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryWorldNormalTexture,c);break;case 9:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryLocalPositionTexture,c);break;case 1:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryWorldPositionTexture,c);break;case 12:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryAlbedoTexture,c);break;case 3:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryReflectivityTexture,c);break;case 2:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryVelocityTexture,c),n=!0;break;case 11:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryLinearVelocityTexture,c),n=!0;break}}this._scene.needsPreviousWorldMatrices=n,r.setRenderTargetDepth(this.depthTexture),r.setExecuteFunc(o=>{this._renderer.renderList=this.objectList.meshes,this._renderer.particleSystemList=this.objectList.particleSystems,o.setDepthStates(this.depthTest&&t,this.depthWrite&&t),this._clearAttachmentsLayout.forEach((l,c)=>{o.clearColorAttachments(wL[c],l)}),o.bindAttachments(this._allAttachmentsLayout),o.render(this._renderer,this._textureWidth,this._textureHeight)});const a=this._frameGraph.addRenderPass(this.name+"_disabled",!0);a.setRenderTarget(e),a.setRenderTargetDepth(this.depthTexture),a.setExecuteFunc(o=>{})}dispose(){Ei.DeleteConfiguration(this._renderer.renderPassId),this._renderer.dispose(),super.dispose()}_createMultiRenderTargetTexture(){const e=[],t=[],i=[],r=[];for(let o=0;o<this.textureDescriptions.length;o++){const l=this.textureDescriptions[o],c=Ei.GeometryTextureDescriptions.findIndex(u=>u.type===l.type);if(c===-1)throw new Error(`FrameGraphGeometryRendererTask ${this.name}: unknown texture type ${l.type}`);e[o]=l.textureType,t[o]=l.textureFormat,i[o]=Ei.GeometryTextureDescriptions[c].name,r[o]=!1}const n=this._frameGraph.textureManager.createRenderTargetTexture(this.name,{size:this.size,sizeIsPercentage:this.sizeIsPercentage,options:{createMipMaps:!1,samples:this.samples,types:e,formats:t,useSRGBBuffers:r,labels:i}}),a=[];for(let o=0;o<this.textureDescriptions.length;o++)a.push(n+o);return a}_checkDepthTextureCompatibility(){let e=!1;if(this.depthTexture!==void 0){if(this.depthTexture===ss)throw new Error(`FrameGraphGeometryRendererTask ${this.name}: the depth/stencil back buffer is not allowed as a depth texture`);if(this._frameGraph.textureManager.getTextureDescription(this.depthTexture).options.samples!==this.samples&&this.textureDescriptions.length>0)throw new Error(`FrameGraphGeometryRendererTask ${this.name}: the depth texture and the output texture must have the same number of samples`);this._frameGraph.textureManager.resolveDanglingHandle(this.outputDepthTexture,this.depthTexture),e=!0}return e}_buildClearAttachmentsLayout(){const e=new Map,t=[];for(let i=0;i<this.textureDescriptions.length;i++){const r=this.textureDescriptions[i],n=Ei.GeometryTextureDescriptions.findIndex(l=>l.type===r.type),a=Ei.GeometryTextureDescriptions[n];let o=e.get(a.clearType);if(o===void 0){o=[],e.set(a.clearType,o);for(let l=0;l<i;l++)o[l]=!1}e.forEach((l,c)=>{l.push(c===a.clearType)}),t.push(!0)}this._clearAttachmentsLayout=new Map,e.forEach((i,r)=>{this._clearAttachmentsLayout.set(r,this._engine.buildTextureLayout(i))}),this._allAttachmentsLayout=this._engine.buildTextureLayout(t)}_registerForRenderPassId(e){const t=Ei.CreateConfiguration(e);for(let i=0;i<this.textureDescriptions.length;i++){const r=this.textureDescriptions[i],n=Ei.GeometryTextureDescriptions.findIndex(o=>o.type===r.type),a=Ei.GeometryTextureDescriptions[n];t.defines[a.defineIndex]=i}t.reverseCulling=this.reverseCulling}}class gd extends Br{constructor(e,t,i,r=!0){super(e,t),this.layer=new Lt(i,r,!0),this.layer.utilityLayerScene._useCurrentFrameBuffer=!0,this.outputTexture=this._frameGraph.textureManager.createDanglingHandle()}record(){if(!this.targetTexture||!this.camera)throw new Error(`FrameGraphUtilityLayerRendererTask "${this.name}": targetTexture and camera are required`);this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture);const e=this._frameGraph.addRenderPass(this.name);e.setRenderTarget(this.outputTexture),e.setExecuteFunc(i=>{this.layer.setRenderCamera(this.camera),i.render(this.layer)});const t=this._frameGraph.addRenderPass(this.name+"_disabled",!0);t.setRenderTarget(this.outputTexture),t.setExecuteFunc(i=>{})}dispose(){this.layer.dispose(),super.dispose()}}function BL(s){const e=th.FindMainObjectRenderer(s);if(e)return e.camera;const t=s.tasks;for(let i=t.length-1;i>=0;i--){const r=t[i];if(r instanceof _d||r instanceof gd)return r.camera}return null}function VL(s){const e=s.getTasksByType(xu);let t=null;for(let i=e.length-1;i>=0;--i){if(e[i].isMainObjectRenderer)return e[i];e[i].objectList.meshes&&!t&&(t=e[i])}return t}function UL(s,e=!0){const t=s.scene,i=new Lt(t,e,!0);i.utilityLayerScene.activeCamera=t.activeCamera;let r=th.FindMainCamera(t.frameGraph);!r&&t.cameras.length>0&&(r=t.cameras[0]),r&&(i.setRenderCamera(r),i.utilityLayerScene.activeCamera=r);const n=t.onAfterRenderObservable.add(()=>{i.render()});return i.utilityLayerScene.onDisposeObservable.addOnce(()=>{t.onAfterRenderObservable.remove(n)}),i}const th={FindMainCamera:BL,FindMainObjectRenderer:VL,CreateUtilityLayerRenderer:UL};te.prototype.getGPUFrameTimeCounter=function(){return this._gpuFrameTime||(this._gpuFrameTime=new vu),this._gpuFrameTime};te.prototype.captureGPUFrameTime=function(s){};class kL{constructor(){this.occlusionInternalRetryCounter=0,this.isOcclusionQueryInProgress=!1,this.isOccluded=!1,this.occlusionRetryCount=-1,this.occlusionType=Mt.OCCLUSION_TYPE_NONE,this.occlusionQueryAlgorithmType=Mt.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE,this.forceRenderingWhenOccluded=!1}}te.prototype.createQuery=function(){return null};te.prototype.deleteQuery=function(s){return this};te.prototype.isQueryResultAvailable=function(s){return!1};te.prototype.getQueryResult=function(s){return 0};te.prototype.beginOcclusionQuery=function(s,e){return!1};te.prototype.endOcclusionQuery=function(s){return this};Object.defineProperty(Mt.prototype,"isOcclusionQueryInProgress",{get:function(){return this._occlusionDataStorage.isOcclusionQueryInProgress},set:function(s){this._occlusionDataStorage.isOcclusionQueryInProgress=s},enumerable:!1,configurable:!0});Object.defineProperty(Mt.prototype,"_occlusionDataStorage",{get:function(){return this.__occlusionDataStorage||(this.__occlusionDataStorage=new kL),this.__occlusionDataStorage},enumerable:!1,configurable:!0});Object.defineProperty(Mt.prototype,"isOccluded",{get:function(){return this._occlusionDataStorage.isOccluded},set:function(s){this._occlusionDataStorage.isOccluded=s},enumerable:!0,configurable:!0});Object.defineProperty(Mt.prototype,"occlusionQueryAlgorithmType",{get:function(){return this._occlusionDataStorage.occlusionQueryAlgorithmType},set:function(s){this._occlusionDataStorage.occlusionQueryAlgorithmType=s},enumerable:!0,configurable:!0});Object.defineProperty(Mt.prototype,"occlusionType",{get:function(){return this._occlusionDataStorage.occlusionType},set:function(s){this._occlusionDataStorage.occlusionType=s},enumerable:!0,configurable:!0});Object.defineProperty(Mt.prototype,"occlusionRetryCount",{get:function(){return this._occlusionDataStorage.occlusionRetryCount},set:function(s){this._occlusionDataStorage.occlusionRetryCount=s},enumerable:!0,configurable:!0});Object.defineProperty(Mt.prototype,"forceRenderingWhenOccluded",{get:function(){return this._occlusionDataStorage.forceRenderingWhenOccluded},set:function(s){this._occlusionDataStorage.forceRenderingWhenOccluded=s},enumerable:!0,configurable:!0});Mt.prototype._checkOcclusionQuery=function(){const s=this._occlusionDataStorage;if(s.occlusionType===Mt.OCCLUSION_TYPE_NONE)return s.isOccluded=!1,!1;const e=this.getEngine();if(!e.getCaps().supportOcclusionQuery||!e.isQueryResultAvailable)return s.isOccluded=!1,!1;if(this.isOcclusionQueryInProgress&&this._occlusionQuery!==null&&this._occlusionQuery!==void 0)if(e.isQueryResultAvailable(this._occlusionQuery)){const r=e.getQueryResult(this._occlusionQuery);s.isOcclusionQueryInProgress=!1,s.occlusionInternalRetryCounter=0,s.isOccluded=!(r>0)}else if(s.occlusionInternalRetryCounter++,s.occlusionRetryCount!==-1&&s.occlusionInternalRetryCounter>s.occlusionRetryCount)s.isOcclusionQueryInProgress=!1,s.occlusionInternalRetryCounter=0,s.isOccluded=s.occlusionType===Mt.OCCLUSION_TYPE_OPTIMISTIC?!1:s.isOccluded;else return s.occlusionType===Mt.OCCLUSION_TYPE_OPTIMISTIC?!1:s.isOccluded;const t=this.getScene();if(t.getBoundingBoxRenderer){const i=t.getBoundingBoxRenderer();this._occlusionQuery===null&&(this._occlusionQuery=e.createQuery()),this._occlusionQuery&&e.beginOcclusionQuery(s.occlusionQueryAlgorithmType,this._occlusionQuery)&&(i.renderOcclusionBoundingBox(this),e.endOcclusionQuery(s.occlusionQueryAlgorithmType),this._occlusionDataStorage.isOcclusionQueryInProgress=!0)}return s.isOccluded};const nR=new k,aR=new k;Object.defineProperty(te.prototype,"onBeforeViewRenderObservable",{get:function(){return nR}});Object.defineProperty(te.prototype,"onAfterViewRenderObservable",{get:function(){return aR}});Object.defineProperty(te.prototype,"inputElement",{get:function(){return this._inputElement},set:function(s){var e;this._inputElement!==s&&(this._inputElement=s,(e=this._onEngineViewChanged)==null||e.call(this))}});te.prototype.getInputElement=function(){return this.inputElement||this.getRenderingCanvas()};te.prototype.registerView=function(s,e,t){this.views||(this.views=[]);for(const n of this.views)if(n.target===s)return n;const i=this.getRenderingCanvas();i&&(s.width=i.width,s.height=i.height);const r={target:s,camera:e,clearBeforeCopy:t,enabled:!0,id:(Math.random()*1e5).toFixed()};return this.views.push(r),e&&!Array.isArray(e)&&e.onDisposeObservable.add(()=>{this.unRegisterView(s)}),r};te.prototype.unRegisterView=function(s){if(!this.views||this.views.length===0)return this;for(const e of this.views)if(e.target===s){const t=this.views.indexOf(e);t!==-1&&this.views.splice(t,1);break}return this};te.prototype._renderViewStep=function(s){const e=s.target,t=e.getContext("2d");if(!t)return!0;const i=this.getRenderingCanvas();nR.notifyObservers(s);const r=s.camera;let n=null,a=null,o=null;if(r&&(o=Array.isArray(r)?r[0].getScene():r.getScene(),n=o.activeCamera,a=o.activeCameras,Array.isArray(r)?o.activeCameras=r:(o.activeCamera=r,o.activeCameras=null)),this.activeView=s,s.customResize)s.customResize(e);else{const l=Math.floor(e.clientWidth/this._hardwareScalingLevel),c=Math.floor(e.clientHeight/this._hardwareScalingLevel),u=l!==e.width||i.width!==e.width||c!==e.height||i.height!==e.height;e.clientWidth&&e.clientHeight&&u&&(e.width=l,e.height=c,this.setSize(l,c))}return!i.width||!i.height?!1:(this._renderFrame(),this.flushFramebuffer(),s.clearBeforeCopy&&t.clearRect(0,0,i.width,i.height),t.drawImage(i,0,0),o&&(o.activeCameras=a,o.activeCamera=n),aR.notifyObservers(s),!0)};te.prototype._renderViews=function(){if(!this.views||this.views.length===0||!this.getRenderingCanvas())return!1;let e;for(const t of this.views){if(!t.enabled)continue;if(t.target===this.inputElement){e=t;continue}if(!this._renderViewStep(t))return!1}return e&&!this._renderViewStep(e)?!1:(this.activeView=null,!0)};te.prototype._debugPushGroup=function(s,e){};te.prototype._debugPopGroup=function(s){};te.prototype._debugInsertMarker=function(s,e){};te.prototype._debugFlushPendingCommands=function(){};class oR{constructor(){this._timeElapsedQueryEnded=!1}}ot.prototype.createQuery=function(){const s=this._gl.createQuery();if(!s)throw new Error("Unable to create Occlusion Query");return s};ot.prototype.deleteQuery=function(s){return this._gl.deleteQuery(s),this};ot.prototype.isQueryResultAvailable=function(s){return this._gl.getQueryParameter(s,this._gl.QUERY_RESULT_AVAILABLE)};ot.prototype.getQueryResult=function(s){return this._gl.getQueryParameter(s,this._gl.QUERY_RESULT)};ot.prototype.beginOcclusionQuery=function(s,e){const t=this._getGlAlgorithmType(s);return this._gl.beginQuery(t,e),!0};ot.prototype.endOcclusionQuery=function(s){const e=this._getGlAlgorithmType(s);return this._gl.endQuery(e),this};ot.prototype._createTimeQuery=function(){const s=this.getCaps().timerQuery;return s.createQueryEXT?s.createQueryEXT():this.createQuery()};ot.prototype._deleteTimeQuery=function(s){const e=this.getCaps().timerQuery;if(e.deleteQueryEXT){e.deleteQueryEXT(s);return}this.deleteQuery(s)};ot.prototype._getTimeQueryResult=function(s){const e=this.getCaps().timerQuery;return e.getQueryObjectEXT?e.getQueryObjectEXT(s,e.QUERY_RESULT_EXT):this.getQueryResult(s)};ot.prototype._getTimeQueryAvailability=function(s){const e=this.getCaps().timerQuery;return e.getQueryObjectEXT?e.getQueryObjectEXT(s,e.QUERY_RESULT_AVAILABLE_EXT):this.isQueryResultAvailable(s)};ot.prototype.startTimeQuery=function(){const s=this.getCaps(),e=s.timerQuery;if(!e)return null;const t=new oR;if(this._gl.getParameter(e.GPU_DISJOINT_EXT),s.canUseTimestampForTimerQuery)t._startTimeQuery=this._createTimeQuery(),t._startTimeQuery&&e.queryCounterEXT(t._startTimeQuery,e.TIMESTAMP_EXT);else{if(this._currentNonTimestampToken)return this._currentNonTimestampToken;t._timeElapsedQuery=this._createTimeQuery(),t._timeElapsedQuery&&(e.beginQueryEXT?e.beginQueryEXT(e.TIME_ELAPSED_EXT,t._timeElapsedQuery):this._gl.beginQuery(e.TIME_ELAPSED_EXT,t._timeElapsedQuery)),this._currentNonTimestampToken=t}return t};ot.prototype.endTimeQuery=function(s){const e=this.getCaps(),t=e.timerQuery;if(!t||!s)return-1;if(e.canUseTimestampForTimerQuery){if(!s._startTimeQuery)return-1;s._endTimeQuery||(s._endTimeQuery=this._createTimeQuery(),s._endTimeQuery&&t.queryCounterEXT(s._endTimeQuery,t.TIMESTAMP_EXT))}else if(!s._timeElapsedQueryEnded){if(!s._timeElapsedQuery)return-1;t.endQueryEXT?t.endQueryEXT(t.TIME_ELAPSED_EXT):(this._gl.endQuery(t.TIME_ELAPSED_EXT),this._currentNonTimestampToken=null),s._timeElapsedQueryEnded=!0}const i=this._gl.getParameter(t.GPU_DISJOINT_EXT);let r=!1;if(s._endTimeQuery?r=this._getTimeQueryAvailability(s._endTimeQuery):s._timeElapsedQuery&&(r=this._getTimeQueryAvailability(s._timeElapsedQuery)),r&&!i){let n=0;if(e.canUseTimestampForTimerQuery){if(!s._startTimeQuery||!s._endTimeQuery)return-1;const a=this._getTimeQueryResult(s._startTimeQuery);n=this._getTimeQueryResult(s._endTimeQuery)-a,this._deleteTimeQuery(s._startTimeQuery),this._deleteTimeQuery(s._endTimeQuery),s._startTimeQuery=null,s._endTimeQuery=null}else{if(!s._timeElapsedQuery)return-1;n=this._getTimeQueryResult(s._timeElapsedQuery),this._deleteTimeQuery(s._timeElapsedQuery),s._timeElapsedQuery=null,s._timeElapsedQueryEnded=!1}return n}return-1};ot.prototype.captureGPUFrameTime=function(s){if(s!==this._captureGPUFrameTime)if(this._captureGPUFrameTime=s,s){const e=this.getGPUFrameTimeCounter();this._onBeginFrameObserver=this.onBeginFrameObservable.add(()=>{this._gpuFrameTimeToken||(this._gpuFrameTimeToken=this.startTimeQuery())}),this._onEndFrameObserver=this.onEndFrameObservable.add(()=>{if(!this._gpuFrameTimeToken)return;const t=this.endTimeQuery(this._gpuFrameTimeToken);t>-1&&(this._gpuFrameTimeToken=null,e.fetchNewFrame(),e.addCount(t,!0))})}else this.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null};ot.prototype._getGlAlgorithmType=function(s){return s===Mt.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE?this._gl.ANY_SAMPLES_PASSED_CONSERVATIVE:this._gl.ANY_SAMPLES_PASSED};ot.prototype.updateVideoTexture=function(s,e,t){if(!s||s._isDisabled)return;const i=this._getInternalFormat(s.format),r=this._getRGBABufferInternalSizedFormat(0,s.format),n=this._bindTextureDirectly(this._gl.TEXTURE_2D,s,!0);this._unpackFlipY(!t);try{if(this._videoTextureSupported===void 0&&(this._gl.getError(),this._gl.texImage2D(this._gl.TEXTURE_2D,0,r,i,this._gl.UNSIGNED_BYTE,e),this._gl.getError()!==0?this._videoTextureSupported=!1:this._videoTextureSupported=!0),this._videoTextureSupported)this._gl.texImage2D(this._gl.TEXTURE_2D,0,r,i,this._gl.UNSIGNED_BYTE,e);else{if(!s._workingCanvas){s._workingCanvas=this.createCanvas(s.width,s.height);const a=s._workingCanvas.getContext("2d");if(!a)throw new Error("Unable to get 2d context");s._workingContext=a,s._workingCanvas.width=s.width,s._workingCanvas.height=s.height}s._workingContext.clearRect(0,0,s.width,s.height),s._workingContext.drawImage(e,0,0,e.videoWidth,e.videoHeight,0,0,s.width,s.height),this._gl.texImage2D(this._gl.TEXTURE_2D,0,r,i,this._gl.UNSIGNED_BYTE,s._workingCanvas)}s.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),n||this._bindTextureDirectly(this._gl.TEXTURE_2D,null),s.isReady=!0}catch{s._isDisabled=!0}};ot.prototype.restoreSingleAttachment=function(){const s=this._gl;this.bindAttachments([s.BACK])};ot.prototype.restoreSingleAttachmentForRenderTarget=function(){const s=this._gl;this.bindAttachments([s.COLOR_ATTACHMENT0])};ot.prototype.buildTextureLayout=function(s,e=!1){const t=this._gl,i=[];if(e)i.push(t.BACK);else for(let r=0;r<s.length;r++)s[r]?i.push(t["COLOR_ATTACHMENT"+r]):i.push(t.NONE);return i};ot.prototype.bindAttachments=function(s){this._gl.drawBuffers(s)};ot.prototype.unBindMultiColorAttachmentFramebuffer=function(s,e=!1,t){this._currentRenderTarget=null,s.disableAutomaticMSAAResolve||this.resolveMultiFramebuffer(s),e||this.generateMipMapsMultiFramebuffer(s),t&&(s._MSAAFramebuffer&&this._bindUnboundFramebuffer(s._framebuffer),t()),this._bindUnboundFramebuffer(null)};ot.prototype.createMultipleRenderTarget=function(s,e,t=!0){let i=!1,r=!0,n=!1,a=!1,o,l=1,c=1;const u=0,h=3,d=!1,f=5,m=3553;let g=[],v=[],E=[],T=[],C=[],A=[],I=[],F=[],V=[],D=!1;const w=this._createHardwareRenderTargetWrapper(!0,!1,s);e!==void 0&&(i=e.generateMipMaps===void 0?!1:e.generateMipMaps,r=e.generateDepthBuffer===void 0?!0:e.generateDepthBuffer,n=e.generateStencilBuffer===void 0?!1:e.generateStencilBuffer,a=e.generateDepthTexture===void 0?!1:e.generateDepthTexture,l=e.textureCount??1,c=e.samples??c,g=e.types||g,v=e.samplingModes||v,E=e.useSRGBBuffers||E,T=e.formats||T,C=e.targetTypes||C,A=e.faceIndex||A,I=e.layerIndex||I,F=e.layerCounts||F,V=e.labels||V,D=e.dontCreateTextures??!1,this.webGLVersion>1&&(e.depthTextureFormat===13||e.depthTextureFormat===17||e.depthTextureFormat===16||e.depthTextureFormat===14||e.depthTextureFormat===18)&&(o=e.depthTextureFormat)),o===void 0&&(o=n?13:14);const B=this._gl,Q=this._currentFramebuffer,J=B.createFramebuffer();this._bindUnboundFramebuffer(J);const re=s.width??s,ne=s.height??s,fe=[],be=[],Me=this.webGLVersion>1&&(o===13||o===17||o===18);w.label=(e==null?void 0:e.label)??"MultiRenderTargetWrapper",w._framebuffer=J,w._generateDepthBuffer=a||r,w._generateStencilBuffer=a?Me:n,w._depthStencilBuffer=this._setupFramebufferDepthAttachments(w._generateStencilBuffer,w._generateDepthBuffer,re,ne,1,o),w._attachments=be;for(let ce=0;ce<l;ce++){let bt=v[ce]||h,Pt=g[ce]||u,Yt=E[ce]||d;const mt=T[ce]||f,Ot=C[ce]||m,Wi=F[ce]??1;(Pt===1&&!this._caps.textureFloatLinearFiltering||Pt===2&&!this._caps.textureHalfFloatLinearFiltering)&&(bt=1);const zr=this._getSamplingParameters(bt,i);Pt===1&&!this._caps.textureFloat&&(Pt=0,N.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),Yt=Yt&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU);const ut=this.webGLVersion>1,Wr=B[ut?"COLOR_ATTACHMENT"+ce:"COLOR_ATTACHMENT"+ce+"_WEBGL"];if(be.push(Wr),Ot===-1||D)continue;const Vt=new $t(this,6);fe[ce]=Vt,B.activeTexture(B["TEXTURE"+ce]),B.bindTexture(Ot,Vt._hardwareTexture.underlyingResource),B.texParameteri(Ot,B.TEXTURE_MAG_FILTER,zr.mag),B.texParameteri(Ot,B.TEXTURE_MIN_FILTER,zr.min),B.texParameteri(Ot,B.TEXTURE_WRAP_S,B.CLAMP_TO_EDGE),B.texParameteri(Ot,B.TEXTURE_WRAP_T,B.CLAMP_TO_EDGE);const ta=this._getRGBABufferInternalSizedFormat(Pt,mt,Yt),Ya=this._getInternalFormat(mt),al=this._getWebGLTextureType(Pt);if(ut&&(Ot===35866||Ot===32879))Ot===35866?Vt.is2DArray=!0:Vt.is3D=!0,Vt.baseDepth=Vt.depth=Wi,B.texImage3D(Ot,0,ta,re,ne,Wi,0,Ya,al,null);else if(Ot===34067){for(let ia=0;ia<6;ia++)B.texImage2D(B.TEXTURE_CUBE_MAP_POSITIVE_X+ia,0,ta,re,ne,0,Ya,al,null);Vt.isCube=!0}else B.texImage2D(B.TEXTURE_2D,0,ta,re,ne,0,Ya,al,null);i&&B.generateMipmap(Ot),this._bindTextureDirectly(Ot,null),Vt.baseWidth=re,Vt.baseHeight=ne,Vt.width=re,Vt.height=ne,Vt.isReady=!0,Vt.samples=1,Vt.generateMipMaps=i,Vt.samplingMode=bt,Vt.type=Pt,Vt._useSRGBBuffer=Yt,Vt.format=mt,Vt.label=V[ce]??w.label+"-Texture"+ce,this._internalTexturesCache.push(Vt)}if(a&&this._caps.depthTextureExtension&&!D){const ce=new $t(this,14);let bt=5,Pt=B.DEPTH_COMPONENT16,Yt=B.DEPTH_COMPONENT,mt=B.UNSIGNED_SHORT,Ot=B.DEPTH_ATTACHMENT;this.webGLVersion<2?Pt=B.DEPTH_COMPONENT:o===14?(bt=1,mt=B.FLOAT,Pt=B.DEPTH_COMPONENT32F):o===18?(bt=0,mt=B.FLOAT_32_UNSIGNED_INT_24_8_REV,Pt=B.DEPTH32F_STENCIL8,Yt=B.DEPTH_STENCIL,Ot=B.DEPTH_STENCIL_ATTACHMENT):o===16?(bt=0,mt=B.UNSIGNED_INT,Pt=B.DEPTH_COMPONENT24,Ot=B.DEPTH_ATTACHMENT):(o===13||o===17)&&(bt=12,mt=B.UNSIGNED_INT_24_8,Pt=B.DEPTH24_STENCIL8,Yt=B.DEPTH_STENCIL,Ot=B.DEPTH_STENCIL_ATTACHMENT),this._bindTextureDirectly(B.TEXTURE_2D,ce,!0),B.texParameteri(B.TEXTURE_2D,B.TEXTURE_MAG_FILTER,B.NEAREST),B.texParameteri(B.TEXTURE_2D,B.TEXTURE_MIN_FILTER,B.NEAREST),B.texParameteri(B.TEXTURE_2D,B.TEXTURE_WRAP_S,B.CLAMP_TO_EDGE),B.texParameteri(B.TEXTURE_2D,B.TEXTURE_WRAP_T,B.CLAMP_TO_EDGE),B.texImage2D(B.TEXTURE_2D,0,Pt,re,ne,0,Yt,mt,null),B.framebufferTexture2D(B.FRAMEBUFFER,Ot,B.TEXTURE_2D,ce._hardwareTexture.underlyingResource,0),this._bindTextureDirectly(B.TEXTURE_2D,null),w._depthStencilTexture=ce,w._depthStencilTextureWithStencil=Me,ce.baseWidth=re,ce.baseHeight=ne,ce.width=re,ce.height=ne,ce.isReady=!0,ce.samples=1,ce.generateMipMaps=i,ce.samplingMode=1,ce.format=o,ce.type=bt,ce.label=w.label+"-DepthStencil",fe[l]=ce,this._internalTexturesCache.push(ce)}if(w.setTextures(fe),t&&B.drawBuffers(be),this._bindUnboundFramebuffer(Q),w.setLayerAndFaceIndices(I,A),this.resetTextureCache(),!D)this.updateMultipleRenderTargetTextureSampleCount(w,c,t);else if(c>1){const ce=B.createFramebuffer();if(!ce)throw new Error("Unable to create multi sampled framebuffer");w._samples=c,w._MSAAFramebuffer=ce,l>0&&t&&(this._bindUnboundFramebuffer(ce),B.drawBuffers(be),this._bindUnboundFramebuffer(Q))}return w};ot.prototype.updateMultipleRenderTargetTextureSampleCount=function(s,e,t=!0){if(this.webGLVersion<2||!s)return 1;if(s.samples===e)return e;const i=this._gl;e=Math.min(e,this.getCaps().maxMSAASamples),s._depthStencilBuffer&&(i.deleteRenderbuffer(s._depthStencilBuffer),s._depthStencilBuffer=null),s._MSAAFramebuffer&&(i.deleteFramebuffer(s._MSAAFramebuffer),s._MSAAFramebuffer=null);const r=s._attachments.length;for(let a=0;a<r;a++){const l=s.textures[a]._hardwareTexture;l==null||l.releaseMSAARenderBuffers()}if(e>1&&typeof i.renderbufferStorageMultisample=="function"){const a=i.createFramebuffer();if(!a)throw new Error("Unable to create multi sampled framebuffer");s._MSAAFramebuffer=a,this._bindUnboundFramebuffer(a);const o=[];for(let l=0;l<r;l++){const c=s.textures[l],u=c._hardwareTexture,h=i[this.webGLVersion>1?"COLOR_ATTACHMENT"+l:"COLOR_ATTACHMENT"+l+"_WEBGL"],d=this._createRenderBuffer(c.width,c.height,e,-1,this._getRGBABufferInternalSizedFormat(c.type,c.format,c._useSRGBBuffer),h);if(!d)throw new Error("Unable to create multi sampled framebuffer");u.addMSAARenderBuffer(d),c.samples=e,o.push(h)}t&&i.drawBuffers(o)}else this._bindUnboundFramebuffer(s._framebuffer);const n=s._depthStencilTexture?s._depthStencilTexture.format:void 0;return s._depthStencilBuffer=this._setupFramebufferDepthAttachments(s._generateStencilBuffer,s._generateDepthBuffer,s.width,s.height,e,n),this._bindUnboundFramebuffer(null),s._samples=e,e};ot.prototype.generateMipMapsMultiFramebuffer=function(s){const e=s,t=this._gl;if(e.isMulti)for(let i=0;i<e._attachments.length;i++){const r=e.textures[i];r!=null&&r.generateMipMaps&&!(r!=null&&r.isCube)&&!(r!=null&&r.is3D)&&(this._bindTextureDirectly(t.TEXTURE_2D,r,!0),t.generateMipmap(t.TEXTURE_2D),this._bindTextureDirectly(t.TEXTURE_2D,null))}};ot.prototype.resolveMultiFramebuffer=function(s){const e=s,t=this._gl;if(!e._MSAAFramebuffer||!e.isMulti)return;let i=e.resolveMSAAColors?t.COLOR_BUFFER_BIT:0;i|=e._generateDepthBuffer&&e.resolveMSAADepth?t.DEPTH_BUFFER_BIT:0,i|=e._generateStencilBuffer&&e.resolveMSAAStencil?t.STENCIL_BUFFER_BIT:0;const r=e._attachments,n=r.length;t.bindFramebuffer(t.READ_FRAMEBUFFER,e._MSAAFramebuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer);for(let a=0;a<n;a++){const o=e.textures[a];for(let l=0;l<n;l++)r[l]=t.NONE;r[a]=t[this.webGLVersion>1?"COLOR_ATTACHMENT"+a:"COLOR_ATTACHMENT"+a+"_WEBGL"],t.readBuffer(r[a]),t.drawBuffers(r),t.blitFramebuffer(0,0,o.width,o.height,0,0,o.width,o.height,i,t.NEAREST)}for(let a=0;a<n;a++)r[a]=t[this.webGLVersion>1?"COLOR_ATTACHMENT"+a:"COLOR_ATTACHMENT"+a+"_WEBGL"];t.drawBuffers(r),t.bindFramebuffer(this._gl.FRAMEBUFFER,e._MSAAFramebuffer)};var nS;(function(s){s[s.Texture=0]="Texture",s[s.StorageTexture=1]="StorageTexture",s[s.UniformBuffer=2]="UniformBuffer",s[s.StorageBuffer=3]="StorageBuffer",s[s.TextureWithoutSampler=4]="TextureWithoutSampler",s[s.Sampler=5]="Sampler",s[s.ExternalTexture=6]="ExternalTexture",s[s.DataBuffer=7]="DataBuffer",s[s.InternalTexture=8]="InternalTexture"})(nS||(nS={}));ot.prototype.createComputeEffect=function(s,e){throw new Error("createComputeEffect: This engine does not support compute shaders!")};ot.prototype.createComputePipelineContext=function(){throw new Error("createComputePipelineContext: This engine does not support compute shaders!")};ot.prototype.createComputeContext=function(){};ot.prototype.computeDispatch=function(s,e,t,i,r,n,a){throw new Error("computeDispatch: This engine does not support compute shaders!")};ot.prototype.computeDispatchIndirect=function(s,e,t,i,r,n){throw new Error("computeDispatchIndirect: This engine does not support compute shaders!")};ot.prototype.areAllComputeEffectsReady=function(){return!0};ot.prototype.releaseComputeEffects=function(){};ot.prototype._prepareComputePipelineContext=function(s,e,t,i,r){};ot.prototype._rebuildComputeEffects=function(){};te.prototype._executeWhenComputeStateIsCompiled=function(s,e){e(null)};ot.prototype._releaseComputeEffect=function(s){};ot.prototype._deleteComputePipelineContext=function(s){};function GL(s){const e=n=>{const a="\\b"+n+"\\b";return s&&(s===n||s.match(new RegExp(a,"g")))};if(this._excludedCompressedTextures&&this._excludedCompressedTextures.some(e))return s;const t=s.lastIndexOf("."),i=s.lastIndexOf("?"),r=i>-1?s.substring(i,s.length):"";return(t>-1?s.substring(0,t):s)+this._textureFormatInUse+r}Object.defineProperty(ft.prototype,"texturesSupported",{get:function(){const s=[];return this._caps.astc&&s.push("-astc.ktx"),this._caps.s3tc&&s.push("-dxt.ktx"),this._caps.pvrtc&&s.push("-pvrtc.ktx"),this._caps.etc2&&s.push("-etc2.ktx"),this._caps.etc1&&s.push("-etc1.ktx"),s},enumerable:!0,configurable:!0});Object.defineProperty(ft.prototype,"textureFormatInUse",{get:function(){return this._textureFormatInUse||null},enumerable:!0,configurable:!0});ft.prototype.setCompressedTextureExclusions=function(s){this._excludedCompressedTextures=s};ft.prototype.setTextureFormatToUse=function(s){const e=this.texturesSupported;for(let t=0,i=e.length;t<i;t++)for(let r=0,n=s.length;r<n;r++)if(e[t]===s[r].toLowerCase())return this._transformTextureUrl=GL.bind(this),this._textureFormatInUse=e[t];return this._textureFormatInUse="",this._transformTextureUrl=null,null};class ba{constructor(){const e=new ArrayBuffer(ba.DEFAULT_BUFFER_SIZE);this._uint32s=new Uint32Array(e),this._int32s=new Int32Array(e),this._float32s=new Float32Array(e),this._length=ba.DEFAULT_BUFFER_SIZE/4,this._position=0,this._nativeDataStream=new _native.NativeDataStream(()=>{this._flush()})}writeUint32(e){this._flushIfNecessary(1),this._uint32s[this._position++]=e}writeInt32(e){this._flushIfNecessary(1),this._int32s[this._position++]=e}writeFloat32(e){this._flushIfNecessary(1),this._float32s[this._position++]=e}writeUint32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._uint32s.set(e,this._position),this._position+=e.length}writeInt32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._int32s.set(e,this._position),this._position+=e.length}writeFloat32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._float32s.set(e,this._position),this._position+=e.length}writeNativeData(e){this._flushIfNecessary(e.length),this._uint32s.set(e,this._position),this._position+=e.length}writeBoolean(e){this.writeUint32(e?1:0)}_flushIfNecessary(e){this._position+e>this._length&&this._flush()}_flush(){this._nativeDataStream.writeBuffer(this._uint32s.buffer,this._position),this._position=0}}ba.DEFAULT_BUFFER_SIZE=65536;function yc(s,e,t,i){let r=i,n=0,a="";for(;r<t.length;){const o=t.charAt(r);if(a)o===a?a==='"'||a==="'"?t.charAt(r-1)!=="\\"&&(a=""):a="":a==="*/"&&o==="*"&&r+1<t.length&&(t.charAt(r+1)==="/"&&(a=""),a===""&&r++);else switch(o){case s:n++;break;case e:n--;break;case'"':case"'":case"`":a=o;break;case"/":if(r+1<t.length){const l=t.charAt(r+1);l==="/"?a=`
`:l==="*"&&(a="*/")}break}if(r++,n===0)break}return n===0?r-1:-1}function aS(s,e){for(;e<s.length;){const t=s[e];if(t!==" "&&t!==`
`&&t!=="\r"&&t!=="	"&&t!==`
`&&t!==" ")break;e++}return e}function qh(s){const e=s.charCodeAt(0);return e>=48&&e<=57||e>=65&&e<=90||e>=97&&e<=122||e==95}function Sd(s){let e=0,t="",i=!1;const r=[];for(;e<s.length;){const n=s.charAt(e);if(t)n===t?t==='"'||t==="'"?(s.charAt(e-1)!=="\\"&&(t=""),r.push(n)):(t="",i=!1):t==="*/"&&n==="*"&&e+1<s.length?(s.charAt(e+1)==="/"&&(t=""),t===""&&(i=!1,e++)):i||r.push(n);else{switch(n){case'"':case"'":case"`":t=n;break;case"/":if(e+1<s.length){const a=s.charAt(e+1);a==="/"?(t=`
`,i=!0):a==="*"&&(t="*/",i=!0)}break}i||r.push(n)}e++}return r.join("")}function zL(s,e,t,i){for(;e>=0&&s.charAt(e)!==t&&(!i||s.charAt(e)!==i);)e--;return e}function WL(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Jc(s,e,t,i){let r=s.indexOf(e);if(r<0)return s;if(t){for(;r++<s.length&&s.charAt(r)!="{";);if(r<s.length){const n=s.substring(0,r+1),a=s.substring(r+1);s=n+t+a}}if(i){const n=s.lastIndexOf("}");s=s.substring(0,n),s+=i+`
}`}return s}class va{get code(){return this._sourceCode}constructor(e,t=20){this.debug=!1,this._sourceCode=e,this._numMaxIterations=t,this._functionDescr=[],this.inlineToken="#define inline"}processCode(){this.debug&&N.Log(`Start inlining process (code size=${this._sourceCode.length})...`),this._collectFunctions(),this._processInlining(this._numMaxIterations),this.debug&&N.Log("End of inlining process.")}_collectFunctions(){let e=0;for(;e<this._sourceCode.length;){const t=this._sourceCode.indexOf(this.inlineToken,e);if(t<0)break;const i=this._sourceCode.indexOf("(",t+this.inlineToken.length);if(i<0){this.debug&&N.Warn(`Could not find the opening parenthesis after the token. startIndex=${e}`),e=t+this.inlineToken.length;continue}const r=va._RegexpFindFunctionNameAndType.exec(this._sourceCode.substring(t+this.inlineToken.length,i));if(!r){this.debug&&N.Warn(`Could not extract the name/type of the function from: ${this._sourceCode.substring(t+this.inlineToken.length,i)}`),e=t+this.inlineToken.length;continue}const[n,a]=[r[3],r[4]],o=yc("(",")",this._sourceCode,i);if(o<0){this.debug&&N.Warn(`Could not extract the parameters the function '${a}' (type=${n}). funcParamsStartIndex=${i}`),e=t+this.inlineToken.length;continue}const l=this._sourceCode.substring(i+1,o),c=aS(this._sourceCode,o+1);if(c===this._sourceCode.length){this.debug&&N.Warn(`Could not extract the body of the function '${a}' (type=${n}). funcParamsEndIndex=${o}`),e=t+this.inlineToken.length;continue}const u=yc("{","}",this._sourceCode,c);if(u<0){this.debug&&N.Warn(`Could not extract the body of the function '${a}' (type=${n}). funcBodyStartIndex=${c}`),e=t+this.inlineToken.length;continue}const h=this._sourceCode.substring(c,u+1),d=Sd(l).split(","),f=[];for(let v=0;v<d.length;++v){const E=d[v].trim(),T=E.lastIndexOf(" ");T>=0&&f.push(E.substring(T+1))}n!=="void"&&f.push("return"),this._functionDescr.push({name:a,type:n,parameters:f,body:h,callIndex:0}),e=u+1;const m=t>0?this._sourceCode.substring(0,t):"",g=u+1<this._sourceCode.length-1?this._sourceCode.substring(u+1):"";this._sourceCode=m+g,e-=u+1-t}this.debug&&N.Log(`Collect functions: ${this._functionDescr.length} functions found. functionDescr=${this._functionDescr}`)}_processInlining(e=20){for(;e-->=0&&this._replaceFunctionCallsByCode(););return this.debug&&N.Log(`numMaxIterations is ${e} after inlining process`),e>=0}_replaceFunctionCallsByCode(){let e=!1;for(const t of this._functionDescr){const{name:i,type:r,parameters:n,body:a}=t;let o=0;for(;o<this._sourceCode.length;){const l=this._sourceCode.indexOf(i,o);if(l<0)break;if(l===0||qh(this._sourceCode.charAt(l-1))){o=l+i.length;continue}const c=aS(this._sourceCode,l+i.length);if(c===this._sourceCode.length||this._sourceCode.charAt(c)!=="("){o=l+i.length;continue}const u=yc("(",")",this._sourceCode,c);if(u<0){this.debug&&N.Warn(`Could not extract the parameters of the function call. Function '${i}' (type=${r}). callParamsStartIndex=${c}`),o=l+i.length;continue}const h=this._sourceCode.substring(c+1,u),f=(C=>{const A=[];let I=0,F=0;for(;I<C.length;){if(C.charAt(I)==="("){const V=yc("(",")",C,I);if(V<0)return null;I=V}else C.charAt(I)===","&&(A.push(C.substring(F,I)),F=I+1);I++}return F<I&&A.push(C.substring(F,I)),A})(Sd(h));if(f===null){this.debug&&N.Warn(`Invalid function call: can't extract the parameters of the function call. Function '${i}' (type=${r}). callParamsStartIndex=${c}, callParams=`+h),o=l+i.length;continue}const m=[];for(let C=0;C<f.length;++C){const A=f[C].trim();m.push(A)}const g=r!=="void"?i+"_"+t.callIndex++:null;if(g&&m.push(g+" ="),m.length!==n.length){this.debug&&N.Warn(`Invalid function call: not the same number of parameters for the call than the number expected by the function. Function '${i}' (type=${r}). function parameters=${n}, call parameters=${m}`),o=l+i.length;continue}o=u+1;const v=this._replaceNames(a,n,m);let E=l>0?this._sourceCode.substring(0,l):"";const T=u+1<this._sourceCode.length-1?this._sourceCode.substring(u+1):"";if(g){const C=zL(this._sourceCode,l-1,`
`,"{");E=this._sourceCode.substring(0,C+1);const A=this._sourceCode.substring(C+1,l);this._sourceCode=E+r+" "+g+`;
`+v+`
`+A+g+T,this.debug&&N.Log(`Replace function call by code. Function '${i}' (type=${r}). injectDeclarationIndex=${C}, call parameters=${m}`)}else this._sourceCode=E+v+T,o+=v.length-(u+1-l),this.debug&&N.Log(`Replace function call by code. Function '${i}' (type=${r}). functionCallIndex=${l}, call parameters=${m}`);e=!0}}return e}_replaceNames(e,t,i){for(let r=0;r<t.length;++r){const n=new RegExp(WL(t[r]),"g"),a=t[r].length,o=i[r];e=e.replace(n,(l,...c)=>{const u=c[0];return qh(e.charAt(u-1))||qh(e.charAt(u+a))?t[r]:o})}return e}}va._RegexpFindFunctionNameAndType=/((\s+?)(\w+)\s+(\w+)\s*?)$/;const HL=/(flat\s)?\s*varying\s*.*/;class $L{constructor(){this.shaderLanguage=0}initializeShaders(e){this._nativeProcessingContext=e,this._nativeProcessingContext&&(this._nativeProcessingContext.remappedAttributeNames={},this._nativeProcessingContext.injectInVertexMain="")}attributeProcessor(e){if(!this._nativeProcessingContext)return e.replace("attribute","in");const i=/\s*(?:attribute|in)\s+(\S+)\s+(\S+)\s*;/gm.exec(e);if(i!==null){const r=i[1],n=i[2],a=this._nativeProcessingContext.vertexBufferKindToNumberOfComponents[n];if(a!==void 0){const o=a<0?a===-1?"int":"ivec"+-a:a===1?"uint":"uvec"+a,l=`_int_${n}_`;e=e.replace(i[0],`in ${o} ${l}; ${r} ${n};`),this._nativeProcessingContext.injectInVertexMain+=`${n} = ${r}(${l});
`,this._nativeProcessingContext.remappedAttributeNames[n]=l}else e=e.replace(i[0],`in ${r} ${n};`)}return e}varyingCheck(e,t){return HL.test(e)}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,i){var a;const r=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,n=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(n,""),e=e.replace(/texture2D\s*\(/g,"texture("),i){const o=e.search(/layout *\(location *= *0\) *out/g)!==-1;e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCube\s*\(/g,"texture("),e=e.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),e=e.replace(/gl_FragColor/g,"glFragColor"),e=e.replace(/gl_FragData/g,"glFragData"),e=e.replace(/void\s+?main\s*\(/g,(r||o?"":`layout(location = 0) out vec4 glFragColor;
`)+"void main(")}else if(t.indexOf("#define VERTEXOUTPUT_INVARIANT")>=0&&(e=`invariant gl_Position;
`+e),(a=this._nativeProcessingContext)!=null&&a.injectInVertexMain&&(e=Jc(e,"void main",this._nativeProcessingContext.injectInVertexMain)),t.indexOf("#define MULTIVIEW")!==-1)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e;return e}}class XL{get isReady(){if(this.compilationError){const e=this.compilationError.message;throw new Error("SHADER ERROR"+(typeof e=="string"?`
`+e:""))}return this.isCompiled}_getVertexShaderCode(){return null}_getFragmentShaderCode(){return null}constructor(e,t,i){this.isCompiled=!1,this.vertexBufferKindToType={},this._valueCache={},this._engine=e,this.isAsync=t,this.shaderProcessingContext=i}_fillEffectInformation(e,t,i,r,n,a,o,l){const c=this._engine;if(c.supportsUniformBuffers)for(const d in t)e.bindUniformBlock(d,t[d]);this._engine.getUniforms(this,i).forEach((d,f)=>{r[i[f]]=d}),this._uniforms=r;let h;for(h=0;h<n.length;h++)e.getUniform(n[h])==null&&(n.splice(h,1),h--);n.forEach((d,f)=>{a[d]=f}),l.push(...c.getAttributes(this,o))}setEngine(e){this._engine=e}dispose(){this._uniforms={}}_cacheMatrix(e,t){const i=this._valueCache[e],r=t.updateFlag;return i!==void 0&&i===r?!1:(this._valueCache[e]=r,!0)}_cacheFloat2(e,t,i){let r=this._valueCache[e];if(!r)return r=[t,i],this._valueCache[e]=r,!0;let n=!1;return r[0]!==t&&(r[0]=t,n=!0),r[1]!==i&&(r[1]=i,n=!0),n}_cacheFloat3(e,t,i,r){let n=this._valueCache[e];if(!n)return n=[t,i,r],this._valueCache[e]=n,!0;let a=!1;return n[0]!==t&&(n[0]=t,a=!0),n[1]!==i&&(n[1]=i,a=!0),n[2]!==r&&(n[2]=r,a=!0),a}_cacheFloat4(e,t,i,r,n){let a=this._valueCache[e];if(!a)return a=[t,i,r,n],this._valueCache[e]=a,!0;let o=!1;return a[0]!==t&&(a[0]=t,o=!0),a[1]!==i&&(a[1]=i,o=!0),a[2]!==r&&(a[2]=r,o=!0),a[3]!==n&&(a[3]=n,o=!0),o}setInt(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this._engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this._engine.setInt3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setInt4(e,t,i,r,n){this._cacheFloat4(e,t,i,r,n)&&(this._engine.setInt4(this._uniforms[e],t,i,r,n)||(this._valueCache[e]=null))}setIntArray(e,t){this._valueCache[e]=null,this._engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this._engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this._engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this._engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this._engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setUInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setUInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this._engine.setUInt3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setUInt4(e,t,i,r,n){this._cacheFloat4(e,t,i,r,n)&&(this._engine.setUInt4(this._uniforms[e],t,i,r,n)||(this._valueCache[e]=null))}setUIntArray(e,t){this._valueCache[e]=null,this._engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this._engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this._engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this._engine.setUIntArray4(this._uniforms[e],t)}setFloatArray(e,t){this._valueCache[e]=null,this._engine.setFloatArray(this._uniforms[e],t)}setFloatArray2(e,t){this._valueCache[e]=null,this._engine.setFloatArray2(this._uniforms[e],t)}setFloatArray3(e,t){this._valueCache[e]=null,this._engine.setFloatArray3(this._uniforms[e],t)}setFloatArray4(e,t){this._valueCache[e]=null,this._engine.setFloatArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this._engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this._engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this._engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this._engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){t&&(this._valueCache[e]=null,this._engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&(this._engine.setMatrices(this._uniforms[e],t.asArray())||(this._valueCache[e]=null))}setMatrix3x3(e,t){this._valueCache[e]=null,this._engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this._engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this._engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setBool(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this._engine.setInt(this._uniforms[e],t?1:0)&&(this._valueCache[e]=t?1:0)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this._engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))}setFloat2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this._engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))}setFloat3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this._engine.setFloat3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this._engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this._engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setFloat4(e,t,i,r,n){this._cacheFloat4(e,t,i,r,n)&&(this._engine.setFloat4(this._uniforms[e],t,i,r,n)||(this._valueCache[e]=null))}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this._engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))}setColor4(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null))}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))}}class YL extends rI{get _framebuffer(){return this.__framebuffer}set _framebuffer(e){this.__framebuffer&&this._engine._releaseFramebufferObjects(this.__framebuffer),this.__framebuffer=e}get _framebufferDepthStencil(){return this.__framebufferDepthStencil}set _framebufferDepthStencil(e){this.__framebufferDepthStencil&&this._engine._releaseFramebufferObjects(this.__framebufferDepthStencil),this.__framebufferDepthStencil=e}constructor(e,t,i,r){super(e,t,i,r),this.__framebuffer=null,this.__framebufferDepthStencil=null,this._engine=r}dispose(e=!1){this._framebuffer=null,this._framebufferDepthStencil=null,super.dispose(e)}}class oS{get underlyingResource(){return this._nativeTexture}constructor(e,t){this._engine=t,this.set(e)}setUsage(){}set(e){this._nativeTexture=e}reset(){this._nativeTexture=null}release(){this._nativeTexture&&this._engine.deleteTexture(this._nativeTexture),this.reset()}}function Zh(s,e){switch(s){case 15:return _native.Engine.TEXTURE_FORMAT_D16;case 16:return _native.Engine.TEXTURE_FORMAT_D24;case 13:return _native.Engine.TEXTURE_FORMAT_D24S8;case 14:return _native.Engine.TEXTURE_FORMAT_D32F;case 36492:return _native.Engine.TEXTURE_FORMAT_BC7;case 36494:return _native.Engine.TEXTURE_FORMAT_BC6H;case 33779:return _native.Engine.TEXTURE_FORMAT_BC3;case 33778:return _native.Engine.TEXTURE_FORMAT_BC2;case 33777:return _native.Engine.TEXTURE_FORMAT_BC1;case 33776:return _native.Engine.TEXTURE_FORMAT_BC1;case 37808:return _native.Engine.TEXTURE_FORMAT_ASTC4x4;case 36196:return _native.Engine.TEXTURE_FORMAT_ETC1;case 37492:return _native.Engine.TEXTURE_FORMAT_ETC2;case 37496:return _native.Engine.TEXTURE_FORMAT_ETC2A;case 4:{switch(e){case 0:return _native.Engine.TEXTURE_FORMAT_RGB8;case 3:return _native.Engine.TEXTURE_FORMAT_RGB8S;case 6:return _native.Engine.TEXTURE_FORMAT_RGB8I;case 7:return _native.Engine.TEXTURE_FORMAT_RGB8U}break}case 5:{switch(e){case 0:return _native.Engine.TEXTURE_FORMAT_RGBA8;case 1:return _native.Engine.TEXTURE_FORMAT_RGBA32F;case 2:return _native.Engine.TEXTURE_FORMAT_RGBA16F;case 3:return _native.Engine.TEXTURE_FORMAT_RGBA8S;case 4:return _native.Engine.TEXTURE_FORMAT_RGBA16I;case 5:return _native.Engine.TEXTURE_FORMAT_RGBA16U;case 6:return _native.Engine.TEXTURE_FORMAT_RGBA32I;case 7:return _native.Engine.TEXTURE_FORMAT_RGBA32U}break}case 6:{switch(e){case 0:return _native.Engine.TEXTURE_FORMAT_R8;case 1:return _native.Engine.TEXTURE_FORMAT_R32F;case 2:return _native.Engine.TEXTURE_FORMAT_R16F;case 3:return _native.Engine.TEXTURE_FORMAT_R8S;case 4:return _native.Engine.TEXTURE_FORMAT_R16S;case 5:return _native.Engine.TEXTURE_FORMAT_R16U;case 6:return _native.Engine.TEXTURE_FORMAT_R32I;case 7:return _native.Engine.TEXTURE_FORMAT_R32U}break}case 7:{switch(e){case 0:return _native.Engine.TEXTURE_FORMAT_RG8;case 1:return _native.Engine.TEXTURE_FORMAT_RG32F;case 2:return _native.Engine.TEXTURE_FORMAT_RG16F;case 3:return _native.Engine.TEXTURE_FORMAT_RG8S;case 4:return _native.Engine.TEXTURE_FORMAT_RG16S;case 5:return _native.Engine.TEXTURE_FORMAT_RG16U;case 6:return _native.Engine.TEXTURE_FORMAT_RG32I;case 7:return _native.Engine.TEXTURE_FORMAT_RG32U}break}case 12:{switch(e){case 0:return _native.Engine.TEXTURE_FORMAT_BGRA8}break}}throw new tD(`Unsupported texture format or type: format ${s}, type ${e}.`,iD.UnsupportedTextureError)}function ul(s){switch(s){case 1:return _native.Engine.TEXTURE_NEAREST_NEAREST;case 2:return _native.Engine.TEXTURE_LINEAR_LINEAR;case 3:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPLINEAR;case 4:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPNEAREST;case 5:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPNEAREST;case 6:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPLINEAR;case 7:return _native.Engine.TEXTURE_NEAREST_LINEAR;case 8:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPLINEAR;case 9:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPNEAREST;case 10:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPLINEAR;case 11:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPNEAREST;case 12:return _native.Engine.TEXTURE_LINEAR_NEAREST;default:throw new Error(`Unsupported sampling mode: ${s}.`)}}function Qh(s){switch(s){case 1:return _native.Engine.ADDRESS_MODE_WRAP;case 0:return _native.Engine.ADDRESS_MODE_CLAMP;case 2:return _native.Engine.ADDRESS_MODE_MIRROR;default:throw new Error("Unexpected wrap mode: "+s+".")}}function jL(s){switch(s){case 513:return _native.Engine.STENCIL_TEST_LESS;case 515:return _native.Engine.STENCIL_TEST_LEQUAL;case 514:return _native.Engine.STENCIL_TEST_EQUAL;case 518:return _native.Engine.STENCIL_TEST_GEQUAL;case 516:return _native.Engine.STENCIL_TEST_GREATER;case 517:return _native.Engine.STENCIL_TEST_NOTEQUAL;case 512:return _native.Engine.STENCIL_TEST_NEVER;case 519:return _native.Engine.STENCIL_TEST_ALWAYS;default:throw new Error(`Unsupported stencil func mode: ${s}.`)}}function qL(s){switch(s){case 7680:return _native.Engine.STENCIL_OP_FAIL_S_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_S_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_S_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_S_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_S_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_S_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_S_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_S_DECRSAT;default:throw new Error(`Unsupported stencil OpFail mode: ${s}.`)}}function ZL(s){switch(s){case 7680:return _native.Engine.STENCIL_OP_FAIL_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_Z_DECRSAT;default:throw new Error(`Unsupported stencil depthFail mode: ${s}.`)}}function QL(s){switch(s){case 7680:return _native.Engine.STENCIL_OP_PASS_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_PASS_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_PASS_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_PASS_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_PASS_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_PASS_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_PASS_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_PASS_Z_DECRSAT;default:throw new Error(`Unsupported stencil opPass mode: ${s}.`)}}function KL(s){switch(s){case 0:return _native.Engine.ALPHA_DISABLE;case 1:return _native.Engine.ALPHA_ADD;case 2:return _native.Engine.ALPHA_COMBINE;case 3:return _native.Engine.ALPHA_SUBTRACT;case 4:return _native.Engine.ALPHA_MULTIPLY;case 5:return _native.Engine.ALPHA_MAXIMIZED;case 6:return _native.Engine.ALPHA_ONEONE;case 7:return _native.Engine.ALPHA_PREMULTIPLIED;case 8:return _native.Engine.ALPHA_PREMULTIPLIED_PORTERDUFF;case 9:return _native.Engine.ALPHA_INTERPOLATE;case 10:return _native.Engine.ALPHA_SCREENMODE;default:throw new Error(`Unsupported alpha mode: ${s}.`)}}function JL(s){switch(s){case M.BYTE:return _native.Engine.ATTRIB_TYPE_INT8;case M.UNSIGNED_BYTE:return _native.Engine.ATTRIB_TYPE_UINT8;case M.SHORT:return _native.Engine.ATTRIB_TYPE_INT16;case M.UNSIGNED_SHORT:return _native.Engine.ATTRIB_TYPE_UINT16;case M.FLOAT:return _native.Engine.ATTRIB_TYPE_FLOAT;default:throw new Error(`Unsupported attribute type: ${s}.`)}}const ew={[M.PositionKind]:!0,[M.NormalKind]:!0,[M.TangentKind]:!0,[M.UVKind]:!0,[M.UV2Kind]:!0,[M.UV3Kind]:!0,[M.UV4Kind]:!0,[M.UV5Kind]:!0,[M.UV6Kind]:!0,[M.ColorKind]:!0,[M.ColorInstanceKind]:!0,[M.MatricesIndicesKind]:!0,[M.MatricesWeightsKind]:!0,[M.MatricesIndicesExtraKind]:!0,[M.MatricesWeightsExtraKind]:!0};function tw(s){switch(s){case M.BYTE:case M.SHORT:case M.INT:case M.FLOAT:return!0;case M.UNSIGNED_BYTE:case M.UNSIGNED_SHORT:case M.UNSIGNED_INT:return!1;default:throw new Error(`Invalid type '${s}'`)}}function lR(s,e){const t=e.getEngine(),i=e._pipelineContext;if(!(i!=null&&i.vertexBufferKindToType))return;let r=null;for(const n in s){const a=s[n];if(!a||!ew[n])continue;const o=a.normalized?M.FLOAT:a.type,l=i.vertexBufferKindToType[n];(o!==M.FLOAT&&l===void 0||l!==void 0&&l!==o)&&(r||(r=t._getShaderProcessingContext(e.shaderLanguage,!1)),i.vertexBufferKindToType[n]=o,o!==M.FLOAT&&(r.vertexBufferKindToNumberOfComponents[n]=M.DeduceStride(n),tw(o)&&(r.vertexBufferKindToNumberOfComponents[n]*=-1)))}if(r){const n=t._caps.parallelShaderCompile;t._caps.parallelShaderCompile=void 0,e._processShaderCodeAsync(null,t._features._checkNonFloatVertexBuffersDontRecreatePipelineContext,r),t._caps.parallelShaderCompile=n}}class iw{constructor(){this.vertexBufferKindToNumberOfComponents={},this.remappedAttributeNames={},this.injectInVertexMain=""}}const cR=new k;if(typeof self<"u"&&!Object.prototype.hasOwnProperty.call(self,"_native")){let s;Object.defineProperty(self,"_native",{get:()=>s,set:e=>{s=e,s&&cR.notifyObservers(s)}})}async function rw(){return await new Promise(s=>{typeof _native>"u"?cR.addOnce(e=>s(e)):s(_native)})}async function sw(s,e){(await rw())[s]=e}class lS extends sI{}class nw{constructor(e){this._engine=e,this._pending=new Array,this._isCommandBufferScopeActive=!1,this._commandStream=yo._createNativeDataStream(),this._engine.setCommandDataStream(this._commandStream)}beginCommandScope(){if(this._isCommandBufferScopeActive)throw new Error("Command scope already active.");this._isCommandBufferScopeActive=!0}endCommandScope(){if(!this._isCommandBufferScopeActive)throw new Error("Command scope is not active.");this._isCommandBufferScopeActive=!1,this._submit()}startEncodingCommand(e){this._commandStream.writeNativeData(e)}encodeCommandArgAsUInt32(e){this._commandStream.writeUint32(e)}encodeCommandArgAsUInt32s(e){this._commandStream.writeUint32Array(e)}encodeCommandArgAsInt32(e){this._commandStream.writeInt32(e)}encodeCommandArgAsInt32s(e){this._commandStream.writeInt32Array(e)}encodeCommandArgAsFloat32(e){this._commandStream.writeFloat32(e)}encodeCommandArgAsFloat32s(e){this._commandStream.writeFloat32Array(e)}encodeCommandArgAsNativeData(e){this._commandStream.writeNativeData(e),this._pending.push(e)}finishEncodingCommand(){this._isCommandBufferScopeActive||this._submit()}_submit(){this._engine.submitCommands(),this._pending.length=0}}const Kh=[];class yo extends ft{setHardwareScalingLevel(e){super.setHardwareScalingLevel(e),this._engine.setHardwareScalingLevel(e)}constructor(e={}){if(super(null,!1,void 0,e.adaptToDeviceRatio),this._engine=new _native.Engine({version:ft.Version,nonFloatVertexBuffers:!0}),this._camera=_native.Camera?new _native.Camera:null,this._commandBufferEncoder=new nw(this._engine),this._frameStats={gpuTimeNs:Number.NaN},this._boundBuffersVertexArray=null,this._currentDepthTest=_native.Engine.DEPTH_TEST_LEQUAL,this._stencilTest=!1,this._stencilMask=255,this._stencilFunc=519,this._stencilFuncRef=0,this._stencilFuncMask=255,this._stencilOpStencilFail=7680,this._stencilOpDepthFail=7680,this._stencilOpStencilDepthPass=7681,this._zOffset=0,this._zOffsetUnits=0,this._depthWrite=!0,this._fillModeWarningDisplayed=!1,_native.Engine.PROTOCOL_VERSION!==yo.PROTOCOL_VERSION)throw new Error(`Protocol version mismatch: ${_native.Engine.PROTOCOL_VERSION} (Native) !== ${yo.PROTOCOL_VERSION} (JS)`);this._engine.setDeviceLostCallback&&this._engine.setDeviceLostCallback(()=>{this.onContextLostObservable.notifyObservers(this),this._contextWasLost=!0,this._restoreEngineAfterContextLost()}),this._webGLVersion=2,this.disableUniformBuffers=!0,this._shaderPlatformName="NATIVE",this._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_SIZE,maxCubemapTextureSize:512,maxRenderTextureSize:512,maxVertexAttribs:16,maxVaryingVectors:16,maxDrawBuffers:8,maxFragmentUniformVectors:16,maxVertexUniformVectors:16,shaderFloatPrecision:23,standardDerivatives:!0,astc:null,pvrtc:null,etc1:null,etc2:null,bptc:null,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!1,highPrecisionShaderSupported:!0,colorBufferFloat:!1,blendFloat:!1,supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,textureFloat:!0,textureFloatLinearFiltering:!0,textureFloatRender:!0,textureHalfFloat:!0,textureHalfFloatLinearFiltering:!0,textureHalfFloatRender:!0,textureLOD:!0,texelFetch:!1,drawBuffersExtension:!1,depthTextureExtension:!1,vertexArrayObject:!0,instancedArrays:!0,supportOcclusionQuery:!1,canUseTimestampForTimerQuery:!1,blendMinMax:!1,maxMSAASamples:16,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!1,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!1,texture2DArrayMaxLayerCount:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_LAYERS,disableMorphTargetTexture:!1,parallelShaderCompile:{COMPLETION_STATUS_KHR:0},textureNorm16:!1,blendParametersPerTarget:!1,dualSourceBlending:!1},this._features={forceBitmapOverHTMLImageElement:!0,supportRenderAndCopyToLodForFloatTextures:!1,supportDepthStencilTexture:!1,supportShadowSamplers:!1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:!1,basisNeedsPOT:!1,support3DTextures:!1,needTypeSuffixInShaderConstants:!1,supportMSAA:!0,supportSSAO2:!1,supportIBLShadows:!1,supportExtendedTextureFormats:!1,supportSwitchCaseInShader:!1,supportSyncTextureRead:!1,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!0,supportSpriteInstancing:!1,forceVertexBufferStrideAndOffsetMultiple4Bytes:!0,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1},j.Log("Babylon Native (v"+ft.Version+") launched"),j.LoadScript=function(r,n,a,o){j.LoadFile(r,l=>{Function(l).apply(null),n&&n()},void 0,void 0,!1,(l,c)=>{a&&a("LoadScript Error",c)})},typeof URL>"u"&&(window.URL={createObjectURL:function(){},revokeObjectURL:function(){}}),typeof Blob>"u"&&(window.Blob=function(r){return r}),Array.prototype.flat||Object.defineProperty(Array.prototype,"flat",{configurable:!0,value:function r(){const n=isNaN(arguments[0])?1:Number(arguments[0]);return n?Array.prototype.reduce.call(this,function(a,o){return Array.isArray(o)?a.push.apply(a,r.call(o,n-1)):a.push(o),a},[]):Array.prototype.slice.call(this)},writable:!0});const t=window&&window.devicePixelRatio||1;this._hardwareScalingLevel=e.adaptToDeviceRatio?1/t:1,this._engine.setHardwareScalingLevel(this._hardwareScalingLevel),this._lastDevicePixelRatio=t,this.resize();const i=this.getDepthFunction();i&&this.setDepthFunction(i),this._shaderProcessor=new $L,this.onNewSceneAddedObservable.add(r=>{const n=r.render;r.render=(...a)=>{this._commandBufferEncoder.beginCommandScope(),n.apply(r,a),this._commandBufferEncoder.endCommandScope()}})}dispose(){super.dispose(),this._boundBuffersVertexArray&&this._deleteVertexArray(this._boundBuffersVertexArray),this._engine.dispose()}static _createNativeDataStream(){return new ba}_queueNewFrame(e,t){return t.requestAnimationFrame&&t!==window?t.requestAnimationFrame(e):this._engine.requestAnimationFrame(e),0}_restoreEngineAfterContextLost(){this._clearEmptyResources();const e=this._depthCullingState.depthTest,t=this._depthCullingState.depthFunc,i=this._depthCullingState.depthMask,r=this._stencilState.stencilTest;this._rebuildGraphicsResources(),this._depthCullingState.depthTest=e,this._depthCullingState.depthFunc=t,this._depthCullingState.depthMask=i,this._stencilState.stencilTest=r,this._flagContextRestored()}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._currentFramebuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_UNBINDFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(this._currentFramebuffer),this._commandBufferEncoder.finishEncodingCommand()),e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()),this._currentFramebuffer=e)}getHostDocument(){return null}clear(e,t,i,r=!1,n=0){if(this.useReverseDepthBuffer)throw new Error("reverse depth buffer is not currently implemented");this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_CLEAR),this._commandBufferEncoder.encodeCommandArgAsUInt32(t&&e?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.r:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.g:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.b:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.a:1),this._commandBufferEncoder.encodeCommandArgAsUInt32(i?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(1),this._commandBufferEncoder.encodeCommandArgAsUInt32(r?1:0),this._commandBufferEncoder.encodeCommandArgAsUInt32(n),this._commandBufferEncoder.finishEncodingCommand()}createIndexBuffer(e,t,i){const r=this._normalizeIndexData(e),n=new lS;return n.references=1,n.is32Bits=r.BYTES_PER_ELEMENT===4,r.byteLength&&(n.nativeIndexBuffer=this._engine.createIndexBuffer(r.buffer,r.byteOffset,r.byteLength,n.is32Bits,t??!1)),n}createVertexBuffer(e,t,i){const r=ArrayBuffer.isView(e)?e:new Float32Array(e),n=new lS;return n.references=1,r.byteLength&&(n.nativeVertexBuffer=this._engine.createVertexBuffer(r.buffer,r.byteOffset,r.byteLength,t??!1)),n}_recordVertexArrayObject(e,t,i,r,n){r._checkedNonFloatVertexBuffers||(lR(t,r),r._checkedNonFloatVertexBuffers=!0),i&&this._engine.recordIndexBuffer(e,i.nativeIndexBuffer);const a=r.getAttributesNames();for(let o=0;o<a.length;o++){const l=r.getAttributeLocation(o);if(l>=0){const c=a[o];let u=null;if(n&&(u=n[c]),u||(u=t[c]),u){const h=u.effectiveBuffer;h&&h.nativeVertexBuffer&&this._engine.recordVertexBuffer(e,h.nativeVertexBuffer,l,u.effectiveByteOffset,u.effectiveByteStride,u.getSize(),JL(u.type),u.normalized,u.getInstanceDivisor())}}}}bindBuffers(e,t,i){this._boundBuffersVertexArray&&this._deleteVertexArray(this._boundBuffersVertexArray),this._boundBuffersVertexArray=this._engine.createVertexArray(),this._recordVertexArrayObject(this._boundBuffersVertexArray,e,t,i),this.bindVertexArrayObject(this._boundBuffersVertexArray)}recordVertexArrayObject(e,t,i,r){const n=this._engine.createVertexArray();return this._recordVertexArrayObject(n,e,t,i,r),n}_deleteVertexArray(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()}bindVertexArrayObject(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDVERTEXARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()}releaseVertexArrayObject(e){this._deleteVertexArray(e)}getAttributes(e,t){const i=e,r=i.shaderProcessingContext;Kh.length=0;for(let n=0;n<t.length;n++){const a=t[n],o=r.remappedAttributeNames[a]??a;Kh[n]=o}return this._engine.getAttributes(i.program,Kh)}_checkSupportedFillMode(e){return e==5||e==8?(this._fillModeWarningDisplayed||(N.Warn("Line Loop and Triangle Fan are not supported fill modes with Babylon Native. Elements with these fill mode will not be visible."),this._fillModeWarningDisplayed=!0),!1):!0}drawElementsType(e,t,i,r){this._checkSupportedFillMode(e)&&(this._drawCalls.addCount(1,!1),r?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINDEXEDINSTANCED),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r)):(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINDEXED),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i)),this._commandBufferEncoder.finishEncodingCommand())}drawArraysType(e,t,i,r){this._checkSupportedFillMode(e)&&(this._drawCalls.addCount(1,!1),r?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINSTANCED),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r)):(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAW),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i)),this._commandBufferEncoder.finishEncodingCommand())}createPipelineContext(e){const t=!!this._caps.parallelShaderCompile;return new XL(this,t,e)}createMaterialContext(){}createDrawContext(){}_preparePipelineContextAsync(e,t,i,r,n,a,o,l,c,u,h){r?this.createRawShaderProgram():this.createShaderProgram(e,t,i,l),h()}_getShaderProcessingContext(e){return new iw}_executeWhenRenderingStateIsCompiled(e,t){const i=e;if(i.isAsync)if(i.onCompiled){const r=i.onCompiled;i.onCompiled=()=>{r(),t()}}else i.onCompiled=t;else t()}createRawShaderProgram(){throw new Error("Not Supported")}createShaderProgram(e,t,i,r){const n=e;this.onBeforeShaderCompilationObservable.notifyObservers(this);const a=new va(t);a.processCode(),t=a.code;const o=new va(i);o.processCode(),i=o.code,t=ot._ConcatenateShader(t,r),i=ot._ConcatenateShader(i,r);const l=()=>{var c;n.isCompiled=!0,(c=n.onCompiled)==null||c.call(n),this.onAfterShaderCompilationObservable.notifyObservers(this)};if(e.isAsync)n.program=this._engine.createProgramAsync(t,i,l,c=>{n.compilationError=c});else try{n.program=this._engine.createProgram(t,i),l()}catch(c){const u=c==null?void 0:c.message;throw new Error("SHADER ERROR"+(typeof u=="string"?`
`+u:""))}return n.program}inlineShaderCode(e){const t=new va(e);return t.debug=!1,t.processCode(),t.code}_setProgram(e){this._currentProgram!==e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETPROGRAM),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand(),this._currentProgram=e)}_deletePipelineContext(e){const t=e;t&&t.program&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEPROGRAM),this._commandBufferEncoder.encodeCommandArgAsNativeData(t.program),this._commandBufferEncoder.finishEncodingCommand())}getUniforms(e,t){const i=e;return this._engine.getUniforms(i.program,t)}bindUniformBlock(e,t,i){throw new Error("Not Implemented")}bindSamplers(e){const t=e.getPipelineContext();this._setProgram(t.program);const i=e.getSamplers();for(let r=0;r<i.length;r++){const n=e.getUniform(i[r]);n&&(this._boundUniforms[r]=n)}this._currentEffect=null}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._engine.getRenderWidth()}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._engine.getRenderHeight()}setViewport(e,t,i){this._cachedViewport=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETVIEWPORT),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.x),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.y),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.width),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.height),this._commandBufferEncoder.finishEncodingCommand()}enableScissor(e,t,i,r){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSCISSOR),this._commandBufferEncoder.encodeCommandArgAsFloat32(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(r),this._commandBufferEncoder.finishEncodingCommand()}disableScissor(){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSCISSOR),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.finishEncodingCommand()}setStateCullFaceType(e,t){throw new Error("setStateCullFaceType: Not Implemented")}setState(e,t=0,i,r=!1,n,a,o=0){this._zOffset=t,this._zOffsetUnits=o,this._zOffset!==0&&j.Warn("zOffset is not supported in Native engine."),this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTATE),this._commandBufferEncoder.encodeCommandArgAsUInt32(e?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(o),this._commandBufferEncoder.encodeCommandArgAsUInt32(this.cullBackFaces??n??!0?1:0),this._commandBufferEncoder.encodeCommandArgAsUInt32(r?1:0),this._commandBufferEncoder.finishEncodingCommand()}getInputElementClientRect(){return{bottom:this.getRenderHeight(),height:this.getRenderHeight(),left:0,right:this.getRenderWidth(),top:0,width:this.getRenderWidth(),x:0,y:0,toJSON:()=>{}}}setZOffset(e){e!==this._zOffset&&(this._zOffset=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSET),this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-e:e),this._commandBufferEncoder.finishEncodingCommand())}getZOffset(){return this._zOffset}setZOffsetUnits(e){e!==this._zOffsetUnits&&(this._zOffsetUnits=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSETUNITS),this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-e:e),this._commandBufferEncoder.finishEncodingCommand())}getZOffsetUnits(){return this._zOffsetUnits}setDepthBuffer(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this._commandBufferEncoder.encodeCommandArgAsUInt32(e?this._currentDepthTest:_native.Engine.DEPTH_TEST_ALWAYS),this._commandBufferEncoder.finishEncodingCommand()}getDepthWrite(){return this._depthWrite}getDepthFunction(){switch(this._currentDepthTest){case _native.Engine.DEPTH_TEST_NEVER:return 512;case _native.Engine.DEPTH_TEST_ALWAYS:return 519;case _native.Engine.DEPTH_TEST_GREATER:return 516;case _native.Engine.DEPTH_TEST_GEQUAL:return 518;case _native.Engine.DEPTH_TEST_NOTEQUAL:return 517;case _native.Engine.DEPTH_TEST_EQUAL:return 514;case _native.Engine.DEPTH_TEST_LESS:return 513;case _native.Engine.DEPTH_TEST_LEQUAL:return 515}return null}setDepthFunction(e){let t=0;switch(e){case 512:t=_native.Engine.DEPTH_TEST_NEVER;break;case 519:t=_native.Engine.DEPTH_TEST_ALWAYS;break;case 516:t=_native.Engine.DEPTH_TEST_GREATER;break;case 518:t=_native.Engine.DEPTH_TEST_GEQUAL;break;case 517:t=_native.Engine.DEPTH_TEST_NOTEQUAL;break;case 514:t=_native.Engine.DEPTH_TEST_EQUAL;break;case 513:t=_native.Engine.DEPTH_TEST_LESS;break;case 515:t=_native.Engine.DEPTH_TEST_LEQUAL;break}this._currentDepthTest=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this._commandBufferEncoder.encodeCommandArgAsUInt32(this._currentDepthTest),this._commandBufferEncoder.finishEncodingCommand()}setDepthWrite(e){this._depthWrite=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHWRITE),this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(e)),this._commandBufferEncoder.finishEncodingCommand()}setColorWrite(e){this._colorWrite=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETCOLORWRITE),this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(e)),this._commandBufferEncoder.finishEncodingCommand()}getColorWrite(){return this._colorWrite}applyStencil(){this._setStencil(this._stencilMask,qL(this._stencilOpStencilFail),ZL(this._stencilOpDepthFail),QL(this._stencilOpStencilDepthPass),jL(this._stencilFunc),this._stencilFuncRef)}_setStencil(e,t,i,r,n,a){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTENCIL),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r),this._commandBufferEncoder.encodeCommandArgAsUInt32(n),this._commandBufferEncoder.encodeCommandArgAsUInt32(a),this._commandBufferEncoder.finishEncodingCommand()}setStencilBuffer(e){this._stencilTest=e,e?this.applyStencil():this._setStencil(255,_native.Engine.STENCIL_OP_FAIL_S_KEEP,_native.Engine.STENCIL_OP_FAIL_Z_KEEP,_native.Engine.STENCIL_OP_PASS_Z_KEEP,_native.Engine.STENCIL_TEST_ALWAYS,0)}getStencilBuffer(){return this._stencilTest}getStencilOperationPass(){return this._stencilOpStencilDepthPass}setStencilOperationPass(e){this._stencilOpStencilDepthPass=e,this.applyStencil()}setStencilMask(e){this._stencilMask=e,this.applyStencil()}setStencilFunction(e){this._stencilFunc=e,this.applyStencil()}setStencilFunctionReference(e){this._stencilFuncRef=e,this.applyStencil()}setStencilFunctionMask(e){this._stencilFuncMask=e}setStencilOperationFail(e){this._stencilOpStencilFail=e,this.applyStencil()}setStencilOperationDepthFail(e){this._stencilOpDepthFail=e,this.applyStencil()}getStencilMask(){return this._stencilMask}getStencilFunction(){return this._stencilFunc}getStencilFunctionReference(){return this._stencilFuncRef}getStencilFunctionMask(){return this._stencilFuncMask}getStencilOperationFail(){return this._stencilOpStencilFail}getStencilOperationDepthFail(){return this._stencilOpDepthFail}setAlphaConstants(e,t,i,r){throw new Error("Setting alpha blend constant color not yet implemented.")}setAlphaMode(e,t=!1,i=0){if(this._alphaMode[i]===e)return;const r=KL(e);this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETBLENDMODE),this._commandBufferEncoder.encodeCommandArgAsUInt32(r),this._commandBufferEncoder.finishEncodingCommand(),t||this.setDepthWrite(e===0),this._alphaMode[i]=e}setInt(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINT),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setIntArray(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setIntArray2(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setIntArray3(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setIntArray4(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloatArray(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloatArray2(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloatArray3(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloatArray4(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setArray(e,t){return e?this.setFloatArray(e,new Float32Array(t)):!1}setArray2(e,t){return e?this.setFloatArray2(e,new Float32Array(t)):!1}setArray3(e,t){return e?this.setFloatArray3(e,new Float32Array(t)):!1}setArray4(e,t){return e?this.setFloatArray4(e,new Float32Array(t)):!1}setMatrices(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRICES),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setMatrix3x3(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX3X3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setMatrix2x2(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX2X2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloat(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloat2(e,t,i){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloat3(e,t,i,r){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(r),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloat4(e,t,i,r,n){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(r),this._commandBufferEncoder.encodeCommandArgAsFloat32(n),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setColor3(e,t){return e?(this.setFloat3(e,t.r,t.g,t.b),!0):!1}setColor4(e,t,i){return e?(this.setFloat4(e,t.r,t.g,t.b,i),!0):!1}wipeCaches(e){this.preventCacheWipeBetweenFrames||(this.resetTextureCache(),this._currentEffect=null,e&&(this._currentProgram=null,this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._alphaState.reset()),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}_createTexture(){return this._engine.createTexture()}_deleteTexture(e){e&&this._engine.deleteTexture(e.underlyingResource)}updateDynamicTexture(e,t,i,r=!1,n){if(r===void 0&&(r=!1),e&&e._hardwareTexture){const a=e._hardwareTexture.underlyingResource;t.getContext().flush();const l=t.getCanvasTexture();this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_COPYTEXTURE),this._commandBufferEncoder.encodeCommandArgAsNativeData(l),this._commandBufferEncoder.encodeCommandArgAsNativeData(a),this._commandBufferEncoder.finishEncodingCommand(),e.isReady=!0}}createDynamicTexture(e,t,i,r){return e=Math.max(e,1),t=Math.max(t,1),this.createRawTexture(new Uint8Array(e*t*4),e,t,5,!1,!1,r)}createVideoElement(e){return this._camera?this._camera.createVideo(e):null}updateVideoTexture(e,t,i){if(e&&e._hardwareTexture&&this._camera){const r=e._hardwareTexture.underlyingResource;this._camera.updateVideoTexture(r,t,i)}}createRawTexture(e,t,i,r,n,a,o,l=null,c=0,u=0,h=!1){const d=new $t(this,3);if(d.format=r,d.generateMipMaps=n,d.samplingMode=o,d.invertY=a,d.baseWidth=t,d.baseHeight=i,d.width=d.baseWidth,d.height=d.baseHeight,d._compression=l,d.type=c,d._useSRGBBuffer=this._getUseSRGBBuffer(h,!n),this.updateRawTexture(d,e,r,a,l,c,d._useSRGBBuffer),d._hardwareTexture){const f=d._hardwareTexture.underlyingResource,m=ul(o);this._setTextureSampling(f,m)}return this._internalTexturesCache.push(d),d}createRawTexture2DArray(e,t,i,r,n,a,o,l,c=null,u=0){const h=new $t(this,11);if(h.baseWidth=t,h.baseHeight=i,h.baseDepth=r,h.width=t,h.height=i,h.depth=r,h.format=n,h.type=u,h.generateMipMaps=a,h.samplingMode=l,h.is2DArray=!0,h._hardwareTexture){const d=h._hardwareTexture.underlyingResource;this._engine.loadRawTexture2DArray(d,e,t,i,r,Zh(n,u),a,o);const f=ul(l);this._setTextureSampling(d,f)}return h.isReady=!0,this._internalTexturesCache.push(h),h}updateRawTexture(e,t,i,r,n=null,a=0,o=!1){if(e){if(t&&e._hardwareTexture){const l=e._hardwareTexture.underlyingResource;this._engine.loadRawTexture(l,t,e.width,e.height,Zh(i,a),e.generateMipMaps,e.invertY)}e.isReady=!0}}createTexture(e,t,i,r,n=3,a=null,o=null,l=null,c=null,u=null,h=null,d,f,m,g=!1){e=e||"";const v=e.substring(0,5)==="data:",E=v&&e.indexOf(";base64,")!==-1,T=c||new $t(this,1),C=e;this._transformTextureUrl&&!E&&!c&&!l&&(e=this._transformTextureUrl(e));const A=e.lastIndexOf("."),I=h||(A>-1?e.substring(A).toLowerCase():"");let F=null;(I.endsWith(".basis")||I.endsWith(".ktx")||I.endsWith(".ktx2")||d==="image/ktx"||d==="image/ktx2")&&(F=rD(I)),r&&r.addPendingData(T),T.url=e,T.generateMipMaps=!t,T.samplingMode=n,T.invertY=i,T._useSRGBBuffer=this._getUseSRGBBuffer(g,t),this.doNotHandleContextLost||(T._buffer=l);let V=null;a&&!c&&(V=T.onLoadedObservable.add(a)),c||this._internalTexturesCache.push(T);const D=(w,B)=>{r&&r.removePendingData(T),e===C?(V&&T.onLoadedObservable.remove(V),De.UseFallbackTexture&&this.createTexture(De.FallbackTexture,t,T.invertY,r,n,null,o,l,T),o&&o((w||"Unknown error")+(De.UseFallbackTexture?" - Fallback texture was used":""),B)):(N.Warn(`Failed to load ${e}, falling back to ${C}`),this.createTexture(C,t,T.invertY,r,n,a,o,l,T,u,h,d,f))};if(F)throw new Error("Loading textures from IInternalTextureLoader not yet implemented.");{const w=B=>{if(!T._hardwareTexture){r&&r.removePendingData(T);return}const Q=T._hardwareTexture.underlyingResource;this._engine.loadTexture(Q,B,!t,i,T._useSRGBBuffer,()=>{T.baseWidth=this._engine.getTextureWidth(Q),T.baseHeight=this._engine.getTextureHeight(Q),T.width=T.baseWidth,T.height=T.baseHeight,T.isReady=!0;const J=ul(n);this._setTextureSampling(Q,J),r&&r.removePendingData(T),T.onLoadedObservable.notifyObservers(T),T.onLoadedObservable.clear()},()=>{throw new Error("Could not load a native texture.")})};if(v&&l)if(l instanceof ArrayBuffer)w(new Uint8Array(l));else if(ArrayBuffer.isView(l))w(l);else if(typeof l=="string")w(new Uint8Array(j.DecodeBase64(l)));else throw new Error("Unsupported buffer type");else E?w(new Uint8Array(j.DecodeBase64(e))):this._loadFile(e,B=>w(new Uint8Array(B)),void 0,void 0,!0,(B,Q)=>{D("Unable to load "+(B&&B.responseURL,Q))})}return T}wrapNativeTexture(e,t=!1,i=3){const r=new oS(e,this._engine),n=new $t(this,0,!0);return n._hardwareTexture=r,n.baseWidth=this._engine.getTextureWidth(e),n.baseHeight=this._engine.getTextureHeight(e),n.width=n.baseWidth,n.height=n.baseHeight,n.isReady=!0,n.useMipMaps=t,this.updateTextureSamplingMode(i,n),n}wrapWebGLTexture(){throw new Error("wrapWebGLTexture is not supported, use wrapNativeTexture instead.")}_createDepthStencilTexture(e,t,i){const r=t.generateStencil||!1,n=t.samples||1,a=i,o=new $t(this,12),l=e.width??e,c=e.height??e,u=this._engine.createFrameBuffer(o._hardwareTexture.underlyingResource,l,c,r,!0,n);return a._framebufferDepthStencil=u,o}_releaseFramebufferObjects(e){e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand())}async _createImageBitmapFromSource(e,t){return await new Promise((r,n)=>{const a=this.createCanvasImage();a.onload=()=>{try{const o=this._engine.createImageBitmap(a);r(o)}catch(o){n(`Error loading image ${a.src} with exception: ${o}`)}},a.onerror=o=>{n(`Error loading image ${a.src} with exception: ${o}`)},a.src=e})}async createImageBitmap(e,t){return await new Promise((i,r)=>{if(Array.isArray(e)){const n=e;if(n.length){const a=this._engine.createImageBitmap(n[0]);if(a){i(a);return}}}r("Unsupported data for createImageBitmap.")})}resizeImageBitmap(e,t,i){return this._engine.resizeImageBitmap(e,t,i)}createCubeTexture(e,t,i,r,n=null,a=null,o,l=null,c=!1,u=0,h=0,d=null,f,m=!1,g=null){const v=d||new $t(this,7);v.isCube=!0,v.url=e,v.generateMipMaps=!r,v._lodGenerationScale=u,v._lodGenerationOffset=h,v._useSRGBBuffer=this._getUseSRGBBuffer(m,!!r),this._doNotHandleContextLost||(v._extension=l,v._files=i,v._buffer=g);const E=e.lastIndexOf(".");if((l||(E>-1?e.substring(E).toLowerCase():""))===".env"){const C=A=>{const I=hM(A);v.width=I.width,v.height=I.width,dM(v,I);const F=I.specular;if(!F)throw new Error("Nothing else parsed so far");v._lodGenerationScale=F.lodGenerationScale;const V=fM(A,I);v.format=5,v.type=0,v.generateMipMaps=!0,v.getEngine().updateTextureSamplingMode($.TRILINEAR_SAMPLINGMODE,v),v._isRGBD=!0,v.invertY=!0,this._engine.loadCubeTextureWithMips(v._hardwareTexture.underlyingResource,V,!1,v._useSRGBBuffer,()=>{v.isReady=!0,n&&n()},()=>{throw new Error("Could not load a native cube texture.")})};if(g)C(g);else{if(i&&i.length===6)throw new Error("Multi-file loading not allowed on env files.");{const A=(I,F)=>{a&&I&&a(I.status+" "+I.statusText,F)};this._loadFile(e,I=>{C(new Uint8Array(I,0,I.byteLength))},void 0,void 0,!0,A)}}}else{if(!i||i.length!==6)throw new Error("Cannot load cubemap because 6 files were not defined");const C=[i[0],i[3],i[1],i[4],i[2],i[5]];Promise.all(C.map(async A=>await this._loadFileAsync(A,void 0,!0).then(I=>new Uint8Array(I,0,I.byteLength)))).then(async A=>await new Promise((I,F)=>{this._engine.loadCubeTexture(v._hardwareTexture.underlyingResource,A,!r,!0,v._useSRGBBuffer,I,F)})).then(()=>{v.isReady=!0,n&&n()},A=>{a&&a(`Failed to load cubemap: ${A.message}`,A)})}return this._internalTexturesCache.push(v),v}_createHardwareTexture(){return new oS(this._createTexture(),this._engine)}_createHardwareRenderTargetWrapper(e,t,i){const r=new YL(e,t,i,this);return this._renderTargetWrapperCache.push(r),r}_createInternalTexture(e,t,i=!0,r=0){let n=!1,a=0,o=3,l=5,c=!1,u=1,h;t!==void 0&&typeof t=="object"?(n=!!t.generateMipMaps,a=t.type===void 0?0:t.type,o=t.samplingMode===void 0?3:t.samplingMode,l=t.format===void 0?5:t.format,c=t.useSRGBBuffer===void 0?!1:t.useSRGBBuffer,u=t.samples??1,h=t.label):n=!!t,c=this._getUseSRGBBuffer(c,!n),(a===1&&!this._caps.textureFloatLinearFiltering||a===2&&!this._caps.textureHalfFloatLinearFiltering)&&(o=1),a===1&&!this._caps.textureFloat&&(a=0,N.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const d=new $t(this,r),f=e.width??e,m=e.height??e,g=e.layers||0;if(g!==0)throw new Error("Texture layers are not supported in Babylon Native");const v=d._hardwareTexture.underlyingResource,E=Zh(l,a);return this._engine.initializeTexture(v,f,m,n,E,!0,c,u),this._setTextureSampling(v,ul(o)),d._useSRGBBuffer=c,d.baseWidth=f,d.baseHeight=m,d.width=f,d.height=m,d.depth=g,d.isReady=!0,d.samples=u,d.generateMipMaps=n,d.samplingMode=o,d.type=a,d.format=l,d.label=h,this._internalTexturesCache.push(d),d}createRenderTargetTexture(e,t){const i=this._createHardwareRenderTargetWrapper(!1,!1,e);let r=!0,n=!1,a=!1,o,l=1;t!==void 0&&typeof t=="object"&&(r=t.generateDepthBuffer??!0,n=!!t.generateStencilBuffer,a=!!t.noColorAttachment,o=t.colorAttachment,l=t.samples??1);const c=o||(a?null:this._createInternalTexture(e,t,!0,5)),u=e.width??e,h=e.height??e,d=this._engine.createFrameBuffer(c?c._hardwareTexture.underlyingResource:null,u,h,n,r,l);return i._framebuffer=d,i._generateDepthBuffer=r,i._generateStencilBuffer=n,i._samples=l,i.setTextures(c),i}updateRenderTargetTextureSampleCount(e,t){return N.Warn("Updating render target sample count is not currently supported"),e.samples}updateTextureSamplingMode(e,t){if(t._hardwareTexture){const i=ul(e);this._setTextureSampling(t._hardwareTexture.underlyingResource,i)}t.samplingMode=e}bindFramebuffer(e,t,i,r,n){const a=e;if(this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,t)throw new Error("Cuboid frame buffers are not yet supported in NativeEngine.");if(i||r)throw new Error("Required width/height for frame buffers not yet supported in NativeEngine.");a._framebufferDepthStencil?this._bindUnboundFramebuffer(a._framebufferDepthStencil):this._bindUnboundFramebuffer(a._framebuffer)}unBindFramebuffer(e,t=!1,i){this._currentRenderTarget=null,i&&i(),this._bindUnboundFramebuffer(null)}createDynamicVertexBuffer(e){return this.createVertexBuffer(e,!0)}updateDynamicIndexBuffer(e,t,i=0){const r=e,n=this._normalizeIndexData(t);r.is32Bits=n.BYTES_PER_ELEMENT===4,this._engine.updateDynamicIndexBuffer(r.nativeIndexBuffer,n.buffer,n.byteOffset,n.byteLength,i)}updateDynamicVertexBuffer(e,t,i=0,r){const n=e,a=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t,o=new Uint8Array(a.buffer,a.byteOffset,r??a.byteLength);this._engine.updateDynamicVertexBuffer(n.nativeVertexBuffer,o.buffer,o.byteOffset,o.byteLength,i)}_setTexture(e,t,i=!1,r=!1){const n=this._boundUniforms[e];if(!n)return!1;if(!t)return this._boundTexturesCache[e]!=null&&(this._activeChannel=e,this._boundTexturesCache[e]=null,this._unsetNativeTexture(n)),!1;if(t.video)this._activeChannel=e,t.update();else if(t.delayLoadState===4)return t.delayLoad(),!1;let a;return r?a=t.depthStencilTexture:t.isReady()?a=t.getInternalTexture():t.isCube?a=this.emptyCubeTexture:t.is3D?a=this.emptyTexture3D:t.is2DArray?a=this.emptyTexture2DArray:a=this.emptyTexture,this._activeChannel=e,!a||!a._hardwareTexture?!1:(this._setTextureWrapMode(a._hardwareTexture.underlyingResource,Qh(t.wrapU),Qh(t.wrapV),Qh(t.wrapR)),this._updateAnisotropicLevel(t),this._setNativeTexture(n,a._hardwareTexture.underlyingResource),!0)}_setTextureSampling(e,t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURESAMPLING),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.finishEncodingCommand()}_setTextureWrapMode(e,t,i,r){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREWRAPMODE),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r),this._commandBufferEncoder.finishEncodingCommand()}_setNativeTexture(e,t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURE),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand()}_unsetNativeTexture(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_UNSETTEXTURE),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()}_updateAnisotropicLevel(e){const t=e.getInternalTexture(),i=e.anisotropicFilteringLevel;!t||!t._hardwareTexture||t._cachedAnisotropicFilteringLevel!==i&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREANISOTROPICLEVEL),this._commandBufferEncoder.encodeCommandArgAsNativeData(t._hardwareTexture.underlyingResource),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand(),t._cachedAnisotropicFilteringLevel=i)}_bindTexture(e,t){const i=this._boundUniforms[e];if(i)if(t&&t._hardwareTexture){const r=t._hardwareTexture.underlyingResource;this._setNativeTexture(i,r)}else this._unsetNativeTexture(i)}unbindAllTextures(){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DISCARDALLTEXTURES),this._commandBufferEncoder.finishEncodingCommand()}_deleteBuffer(e){e.nativeIndexBuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEINDEXBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e.nativeIndexBuffer),this._commandBufferEncoder.finishEncodingCommand(),delete e.nativeIndexBuffer),e.nativeVertexBuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e.nativeVertexBuffer),this._commandBufferEncoder.finishEncodingCommand(),delete e.nativeVertexBuffer)}createCanvas(e,t){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");const i=new _native.Canvas;return i.width=e,i.height=t,i}createCanvasImage(){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");return new _native.Image}createCanvasPath2D(e){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");return new _native.Path2D(e)}updateTextureData(e,t,i,r,n,a,o=0,l=0,c=!1){throw new Error("updateTextureData not implemented.")}_uploadCompressedDataToTextureDirectly(e,t,i,r,n,a=0,o=0){throw new Error("_uploadCompressedDataToTextureDirectly not implemented.")}_uploadDataToTextureDirectly(e,t,i=0,r=0){throw new Error("_uploadDataToTextureDirectly not implemented.")}_uploadArrayBufferViewToTexture(e,t,i=0,r=0){throw new Error("_uploadArrayBufferViewToTexture not implemented.")}_uploadImageToTexture(e,t,i=0,r=0){throw new Error("_uploadArrayBufferViewToTexture not implemented.")}getFontOffset(e){return{ascent:0,height:0,descent:0}}flushFramebuffer(){}_readTexturePixels(e,t,i,r,n,a,o,l,c,u){var h;if(r!==void 0&&r!==-1)throw new Error(`Reading cubemap faces is not supported, but faceIndex is ${r}.`);return this._engine.readTexture((h=e._hardwareTexture)==null?void 0:h.underlyingResource,n??0,c??0,u??0,t,i,(a==null?void 0:a.buffer)??null,(a==null?void 0:a.byteOffset)??0,(a==null?void 0:a.byteLength)??0).then(d=>(a||(a=new Uint8Array(d)),a))}startTimeQuery(){return this._gpuFrameTimeToken||(this._gpuFrameTimeToken=new oR),this._gpuFrameTimeToken}endTimeQuery(e){return this._engine.populateFrameStats(this._frameStats),this._frameStats.gpuTimeNs}}yo.PROTOCOL_VERSION=9;yo._createNativeDataStream=function(){return _native.NativeDataStream.VALIDATION_ENABLED?new aw:new ba};class aw extends ba{constructor(){super()}writeUint32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32),super.writeUint32(e)}writeInt32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32),super.writeInt32(e)}writeFloat32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32),super.writeFloat32(e)}writeUint32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32_ARRAY),super.writeUint32Array(e)}writeInt32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32_ARRAY),super.writeInt32Array(e)}writeFloat32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32_ARRAY),super.writeFloat32Array(e)}writeNativeData(e){super.writeUint32(_native.NativeDataStream.VALIDATION_NATIVE_DATA),super.writeNativeData(e)}writeBoolean(e){super.writeUint32(_native.NativeDataStream.VALIDATION_BOOLEAN),super.writeBoolean(e)}}class Qe{static ComputeNumMipmapLevels(e,t){return Ol(Math.max(e,t))+1}static GetTextureTypeFromFormat(e){switch(e){case"r8unorm":case"r8uint":case"rg8unorm":case"rg8uint":case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8uint":case"bgra8unorm":case"bgra8unorm-srgb":case"rgb10a2uint":case"rgb10a2unorm":case"rgb9e5ufloat":case"rg11b10ufloat":case"bc7-rgba-unorm":case"bc7-rgba-unorm-srgb":case"bc6h-rgb-ufloat":case"bc5-rg-unorm":case"bc3-rgba-unorm":case"bc3-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc2-rgba-unorm-srgb":case"bc4-r-unorm":case"bc1-rgba-unorm":case"bc1-rgba-unorm-srgb":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"eac-r11unorm":case"eac-rg11unorm":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":case"stencil8":return 0;case"r8snorm":case"r8sint":case"rg8snorm":case"rg8sint":case"rgba8snorm":case"rgba8sint":case"bc6h-rgb-float":case"bc5-rg-snorm":case"bc4-r-snorm":case"eac-r11snorm":case"eac-rg11snorm":return 3;case"r16uint":case"r16unorm":case"rg16unorm":case"rgba16unorm":case"rg16uint":case"rgba16uint":case"depth16unorm":return 5;case"r16sint":case"r16snorm":case"rg16snorm":case"rgba16snorm":case"rg16sint":case"rgba16sint":return 4;case"r16float":case"rg16float":case"rgba16float":return 2;case"r32uint":case"rg32uint":case"rgba32uint":return 7;case"r32sint":case"rg32sint":case"rgba32sint":return 7;case"r32float":case"rg32float":case"rgba32float":case"depth32float":case"depth32float-stencil8":case"depth24plus":case"depth24plus-stencil8":return 1}return 0}static GetBlockInformationFromFormat(e){switch(e){case"r8unorm":case"r8snorm":case"r8uint":case"r8sint":return{width:1,height:1,length:1};case"r16uint":case"r16sint":case"r16unorm":case"r16snorm":case"r16float":case"rg8unorm":case"rg8snorm":case"rg8uint":case"rg8sint":return{width:1,height:1,length:2};case"r32uint":case"r32sint":case"r32float":case"rg16uint":case"rg16sint":case"rg16float":case"rg16unorm":case"rg16snorm":case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8snorm":case"rgba8uint":case"rgba8sint":case"bgra8unorm":case"bgra8unorm-srgb":case"rgb9e5ufloat":case"rgb10a2uint":case"rgb10a2unorm":case"rg11b10ufloat":return{width:1,height:1,length:4};case"rg32uint":case"rg32sint":case"rg32float":case"rgba16uint":case"rgba16sint":case"rgba16float":case"rgba16unorm":case"rgba16snorm":return{width:1,height:1,length:8};case"rgba32uint":case"rgba32sint":case"rgba32float":return{width:1,height:1,length:16};case"stencil8":throw"No fixed size for Stencil8 format!";case"depth16unorm":return{width:1,height:1,length:2};case"depth24plus":throw"No fixed size for Depth24Plus format!";case"depth24plus-stencil8":throw"No fixed size for Depth24PlusStencil8 format!";case"depth32float":return{width:1,height:1,length:4};case"depth32float-stencil8":return{width:1,height:1,length:5};case"bc7-rgba-unorm":case"bc7-rgba-unorm-srgb":case"bc6h-rgb-ufloat":case"bc6h-rgb-float":case"bc5-rg-unorm":case"bc5-rg-snorm":case"bc3-rgba-unorm":case"bc3-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc2-rgba-unorm-srgb":return{width:4,height:4,length:16};case"bc4-r-unorm":case"bc4-r-snorm":case"bc1-rgba-unorm":case"bc1-rgba-unorm-srgb":return{width:4,height:4,length:8};case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"eac-r11unorm":case"eac-r11snorm":return{width:4,height:4,length:8};case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"eac-rg11unorm":case"eac-rg11snorm":return{width:4,height:4,length:16};case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":return{width:4,height:4,length:16};case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":return{width:5,height:4,length:16};case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":return{width:5,height:5,length:16};case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":return{width:6,height:5,length:16};case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":return{width:6,height:6,length:16};case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":return{width:8,height:5,length:16};case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":return{width:8,height:6,length:16};case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":return{width:8,height:8,length:16};case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":return{width:10,height:5,length:16};case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":return{width:10,height:6,length:16};case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":return{width:10,height:8,length:16};case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":return{width:10,height:10,length:16};case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":return{width:12,height:10,length:16};case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":return{width:12,height:12,length:16}}return{width:1,height:1,length:4}}static IsHardwareTexture(e){return!!e.release}static IsInternalTexture(e){return!!e.dispose}static IsImageBitmap(e){return e.close!==void 0}static IsImageBitmapArray(e){return Array.isArray(e)&&e[0].close!==void 0}static IsCompressedFormat(e){switch(e){case"bc7-rgba-unorm-srgb":case"bc7-rgba-unorm":case"bc6h-rgb-float":case"bc6h-rgb-ufloat":case"bc5-rg-snorm":case"bc5-rg-unorm":case"bc4-r-snorm":case"bc4-r-unorm":case"bc3-rgba-unorm-srgb":case"bc3-rgba-unorm":case"bc2-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc1-rgba-unorm-srgb":case"bc1-rgba-unorm":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"eac-r11unorm":case"eac-r11snorm":case"eac-rg11unorm":case"eac-rg11snorm":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":return!0}return!1}static GetWebGPUTextureFormat(e,t,i=!1){switch(t){case 15:return"depth16unorm";case 16:return"depth24plus";case 13:return"depth24plus-stencil8";case 14:return"depth32float";case 18:return"depth32float-stencil8";case 19:return"stencil8";case 36492:return i?"bc7-rgba-unorm-srgb":"bc7-rgba-unorm";case 36495:return"bc6h-rgb-ufloat";case 36494:return"bc6h-rgb-float";case 33779:return i?"bc3-rgba-unorm-srgb":"bc3-rgba-unorm";case 33778:return i?"bc2-rgba-unorm-srgb":"bc2-rgba-unorm";case 33777:case 33776:return i?"bc1-rgba-unorm-srgb":"bc1-rgba-unorm";case 37808:return i?"astc-4x4-unorm-srgb":"astc-4x4-unorm";case 36196:case 37492:return i?"etc2-rgb8unorm-srgb":"etc2-rgb8unorm";case 37496:return i?"etc2-rgba8unorm-srgb":"etc2-rgba8unorm"}switch(e){case 3:switch(t){case 6:return"r8snorm";case 7:return"rg8snorm";case 4:throw"RGB format not supported in WebGPU";case 8:return"r8sint";case 9:return"rg8sint";case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return"rgba8sint";default:return"rgba8snorm"}case 0:switch(t){case 6:return"r8unorm";case 7:return"rg8unorm";case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return i?"rgba8unorm-srgb":"rgba8unorm";case 12:return i?"bgra8unorm-srgb":"bgra8unorm";case 8:return"r8uint";case 9:return"rg8uint";case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return"rgba8uint";case 0:throw"TEXTUREFORMAT_ALPHA format not supported in WebGPU";case 1:throw"TEXTUREFORMAT_LUMINANCE format not supported in WebGPU";case 2:throw"TEXTUREFORMAT_LUMINANCE_ALPHA format not supported in WebGPU";default:return"rgba8unorm"}case 4:switch(t){case 8:return"r16sint";case 9:return"rg16sint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return"rgba16sint";default:return"rgba16sint"}case 5:switch(t){case 8:return"r16uint";case 9:return"rg16uint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return"rgba16uint";default:return"rgba16uint"}case 6:switch(t){case 8:return"r32sint";case 9:return"rg32sint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return"rgba32sint";default:return"rgba32sint"}case 7:switch(t){case 8:return"r32uint";case 9:return"rg32uint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return"rgba32uint";default:return"rgba32uint"}case 1:switch(t){case 6:return"r32float";case 7:return"rg32float";case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return"rgba32float";default:return"rgba32float"}case 2:switch(t){case 6:return"r16float";case 7:return"rg16float";case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return"rgba16float";default:return"rgba16float"}case 10:throw"TEXTURETYPE_UNSIGNED_SHORT_5_6_5 format not supported in WebGPU";case 13:switch(t){case 5:return"rg11b10ufloat";case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV";default:return"rg11b10ufloat"}case 14:switch(t){case 5:return"rgb9e5ufloat";case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV";default:return"rgb9e5ufloat"}case 8:throw"TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4 format not supported in WebGPU";case 9:throw"TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1 format not supported in WebGPU";case 11:switch(t){case 5:return"rgb10a2unorm";case 11:return"rgb10a2uint";default:return"rgb10a2unorm"}}return i?"rgba8unorm-srgb":"rgba8unorm"}static GetNumChannelsFromWebGPUTextureFormat(e){switch(e){case"r8unorm":case"r8snorm":case"r8uint":case"r8sint":case"bc4-r-unorm":case"bc4-r-snorm":case"r16uint":case"r16sint":case"depth16unorm":case"r16float":case"r16unorm":case"r16snorm":case"r32uint":case"r32sint":case"r32float":case"depth32float":case"stencil8":case"depth24plus":case"eac-r11unorm":case"eac-r11snorm":return 1;case"rg8unorm":case"rg8snorm":case"rg8uint":case"rg8sint":case"depth32float-stencil8":case"bc5-rg-unorm":case"bc5-rg-snorm":case"rg16uint":case"rg16sint":case"rg16float":case"rg16unorm":case"rg16snorm":case"rg32uint":case"rg32sint":case"rg32float":case"depth24plus-stencil8":case"eac-rg11unorm":case"eac-rg11snorm":return 2;case"rgb9e5ufloat":case"rg11b10ufloat":case"bc6h-rgb-ufloat":case"bc6h-rgb-float":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":return 3;case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8snorm":case"rgba8uint":case"rgba8sint":case"bgra8unorm":case"bgra8unorm-srgb":case"rgba16unorm":case"rgba16snorm":case"rgb10a2uint":case"rgb10a2unorm":case"bc7-rgba-unorm":case"bc7-rgba-unorm-srgb":case"bc3-rgba-unorm":case"bc3-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc2-rgba-unorm-srgb":case"bc1-rgba-unorm":case"bc1-rgba-unorm-srgb":case"rgba16uint":case"rgba16sint":case"rgba16float":case"rgba32uint":case"rgba32sint":case"rgba32float":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":return 4}throw`Unknown format ${e}!`}static HasStencilAspect(e){switch(e){case"stencil8":case"depth32float-stencil8":case"depth24plus-stencil8":return!0}return!1}static HasDepthAndStencilAspects(e){switch(e){case"depth32float-stencil8":case"depth24plus-stencil8":return!0}return!1}static GetDepthFormatOnly(e){switch(e){case"depth16unorm":return"depth16unorm";case"depth24plus":return"depth24plus";case"depth24plus-stencil8":return"depth24plus";case"depth32float":return"depth32float";case"depth32float-stencil8":return"depth32float"}return e}static GetSample(e){return e>1?4:1}}class Et extends te{constructor(){super(...arguments),this.dbgShowShaderCode=!1,this.dbgSanityChecks=!0,this.dbgVerboseLogsNumFrames=10,this.dbgLogIfNotDrawWrapper=!0,this.dbgShowEmptyEnableEffectCalls=!0,this.dbgVerboseLogsForFirstFrames=!1,this._currentRenderPass=null,this._snapshotRenderingMode=0,this._timestampIndex=0,this._debugStackRenderPass=[]}get enableGPUTimingMeasurements(){return this._timestampQuery.enable}set enableGPUTimingMeasurements(e){this._timestampQuery.enable!==e&&(this.gpuTimeInFrameForMainPass=e?new c_:void 0,this._timestampQuery.enable=e)}_currentPassIsMainPass(){return this._currentRenderTarget===null}_endCurrentRenderPass(){var t,i,r;if(!this._currentRenderPass)return 0;if(this._debugStackRenderPass.length!==0)for(let n=0;n<this._debugStackRenderPass.length;++n)this._currentRenderPass.popDebugGroup();const e=this._currentPassIsMainPass()?2:1;return!this._snapshotRendering.endRenderPass(this._currentRenderPass)&&!this.compatibilityMode&&(this._bundleList.run(this._currentRenderPass),this._bundleList.reset()),this._currentRenderPass.end(),this._timestampQuery.endPass(this._timestampIndex,this._currentRenderTarget&&this._currentRenderTarget.gpuTimeInFrame?this._currentRenderTarget.gpuTimeInFrame:this.gpuTimeInFrameForMainPass),this._timestampIndex+=2,this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&N.Log("frame #"+this._count+" - "+(e===2?"main":"render target")+" end pass"+(e===1?" - internalTexture.uniqueId="+((i=(t=this._currentRenderTarget)==null?void 0:t.texture)==null?void 0:i.uniqueId):""))),(r=this._debugPopGroup)==null||r.call(this,0),this._currentRenderPass=null,e}_generateMipmaps(e,t){t=t??this._renderEncoder;const i=e._hardwareTexture;if(!i)return;t===this._renderEncoder&&this._endCurrentRenderPass();const r=e._hardwareTexture.format,n=Qe.ComputeNumMipmapLevels(e.width,e.height);this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&N.Log("frame #"+this._count+" - generate mipmaps - width="+e.width+", height="+e.height+", isCube="+e.isCube+", command encoder="+(t===this._renderEncoder?"render":"copy"))),e.isCube?this._textureHelper.generateCubeMipmaps(i,r,n,t):this._textureHelper.generateMipmaps(i,r,n,0,e.is3D,t)}}Et.prototype.setAlphaMode=function(s,e=!1,t=0){const i=this._alphaState._alphaBlend[t];if(this._alphaMode[t]===s&&(s===0&&!i||s!==0&&i)){if(!e){const n=s===0;this.depthCullingState.depthMask!==n&&(this.setDepthWrite(n),this._cacheRenderPipeline.setDepthWriteEnabled(n))}return}const r=s===0;this._alphaState.setAlphaBlend(!r,t),this._alphaState.setAlphaMode(s,t),e||(this.setDepthWrite(r),this._cacheRenderPipeline.setDepthWriteEnabled(r)),this._alphaMode[t]=s,this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState._alphaBlend,this._alphaState._numTargetEnabled),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)};Et.prototype.setAlphaEquation=function(s,e=0){te.prototype.setAlphaEquation.call(this,s,e),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)};var cS;(function(s){s.LowPower="low-power",s.HighPerformance="high-performance"})(cS||(cS={}));var uS;(function(s){s.CoreFeaturesAndLimits="core-features-and-limits",s.DepthClipControl="depth-clip-control",s.Depth32FloatStencil8="depth32float-stencil8",s.TextureCompressionBC="texture-compression-bc",s.TextureCompressionBCSliced3D="texture-compression-bc-sliced-3d",s.TextureCompressionETC2="texture-compression-etc2",s.TextureCompressionASTC="texture-compression-astc",s.TextureCompressionASTCSliced3D="texture-compression-astc-sliced-3d",s.TimestampQuery="timestamp-query",s.IndirectFirstInstance="indirect-first-instance",s.ShaderF16="shader-f16",s.RG11B10UFloatRenderable="rg11b10ufloat-renderable",s.BGRA8UnormStorage="bgra8unorm-storage",s.Float32Filterable="float32-filterable",s.Float32Blendable="float32-blendable",s.ClipDistances="clip-distances",s.DualSourceBlending="dual-source-blending",s.Subgroups="subgroups",s.TextureFormatsTier1="texture-formats-tier1",s.TextureFormatsTier2="texture-formats-tier2"})(uS||(uS={}));var hS;(function(s){s.Unmapped="unmapped",s.Pending="pending",s.Mapped="mapped"})(hS||(hS={}));var $e;(function(s){s[s.MapRead=1]="MapRead",s[s.MapWrite=2]="MapWrite",s[s.CopySrc=4]="CopySrc",s[s.CopyDst=8]="CopyDst",s[s.Index=16]="Index",s[s.Vertex=32]="Vertex",s[s.Uniform=64]="Uniform",s[s.Storage=128]="Storage",s[s.Indirect=256]="Indirect",s[s.QueryResolve=512]="QueryResolve"})($e||($e={}));var dS;(function(s){s[s.Read=1]="Read",s[s.Write=2]="Write"})(dS||(dS={}));var fS;(function(s){s.E1d="1d",s.E2d="2d",s.E3d="3d"})(fS||(fS={}));var pS;(function(s){s[s.CopySrc=1]="CopySrc",s[s.CopyDst=2]="CopyDst",s[s.TextureBinding=4]="TextureBinding",s[s.StorageBinding=8]="StorageBinding",s[s.RenderAttachment=16]="RenderAttachment"})(pS||(pS={}));var mS;(function(s){s.E1d="1d",s.E2d="2d",s.E2dArray="2d-array",s.Cube="cube",s.CubeArray="cube-array",s.E3d="3d"})(mS||(mS={}));var _S;(function(s){s.All="all",s.StencilOnly="stencil-only",s.DepthOnly="depth-only"})(_S||(_S={}));var gS;(function(s){s.R8Unorm="r8unorm",s.R8Snorm="r8snorm",s.R8Uint="r8uint",s.R8Sint="r8sint",s.R16Uint="r16uint",s.R16Sint="r16sint",s.R16Float="r16float",s.RG8Unorm="rg8unorm",s.RG8Snorm="rg8snorm",s.RG8Uint="rg8uint",s.RG8Sint="rg8sint",s.R16Unorm="r16unorm",s.R16Snorm="r16snorm",s.R32Uint="r32uint",s.R32Sint="r32sint",s.R32Float="r32float",s.RG16Uint="rg16uint",s.RG16Sint="rg16sint",s.RG16Float="rg16float",s.RGBA8Unorm="rgba8unorm",s.RGBA8UnormSRGB="rgba8unorm-srgb",s.RGBA8Snorm="rgba8snorm",s.RGBA8Uint="rgba8uint",s.RGBA8Sint="rgba8sint",s.BGRA8Unorm="bgra8unorm",s.BGRA8UnormSRGB="bgra8unorm-srgb",s.RG16Unorm="rg16unorm",s.RG16Snorm="rg16snorm",s.RGB9E5UFloat="rgb9e5ufloat",s.RGB10A2UINT="rgb10a2uint",s.RGB10A2Unorm="rgb10a2unorm",s.RG11B10UFloat="rg11b10ufloat",s.RG32Uint="rg32uint",s.RG32Sint="rg32sint",s.RG32Float="rg32float",s.RGBA16Uint="rgba16uint",s.RGBA16Sint="rgba16sint",s.RGBA16Float="rgba16float",s.RGBA16Unorm="rgba16unorm",s.RGBA16Snorm="rgba16snorm",s.RGBA32Uint="rgba32uint",s.RGBA32Sint="rgba32sint",s.RGBA32Float="rgba32float",s.Stencil8="stencil8",s.Depth16Unorm="depth16unorm",s.Depth24Plus="depth24plus",s.Depth24PlusStencil8="depth24plus-stencil8",s.Depth32Float="depth32float",s.BC1RGBAUnorm="bc1-rgba-unorm",s.BC1RGBAUnormSRGB="bc1-rgba-unorm-srgb",s.BC2RGBAUnorm="bc2-rgba-unorm",s.BC2RGBAUnormSRGB="bc2-rgba-unorm-srgb",s.BC3RGBAUnorm="bc3-rgba-unorm",s.BC3RGBAUnormSRGB="bc3-rgba-unorm-srgb",s.BC4RUnorm="bc4-r-unorm",s.BC4RSnorm="bc4-r-snorm",s.BC5RGUnorm="bc5-rg-unorm",s.BC5RGSnorm="bc5-rg-snorm",s.BC6HRGBUFloat="bc6h-rgb-ufloat",s.BC6HRGBFloat="bc6h-rgb-float",s.BC7RGBAUnorm="bc7-rgba-unorm",s.BC7RGBAUnormSRGB="bc7-rgba-unorm-srgb",s.ETC2RGB8Unorm="etc2-rgb8unorm",s.ETC2RGB8UnormSRGB="etc2-rgb8unorm-srgb",s.ETC2RGB8A1Unorm="etc2-rgb8a1unorm",s.ETC2RGB8A1UnormSRGB="etc2-rgb8a1unorm-srgb",s.ETC2RGBA8Unorm="etc2-rgba8unorm",s.ETC2RGBA8UnormSRGB="etc2-rgba8unorm-srgb",s.EACR11Unorm="eac-r11unorm",s.EACR11Snorm="eac-r11snorm",s.EACRG11Unorm="eac-rg11unorm",s.EACRG11Snorm="eac-rg11snorm",s.ASTC4x4Unorm="astc-4x4-unorm",s.ASTC4x4UnormSRGB="astc-4x4-unorm-srgb",s.ASTC5x4Unorm="astc-5x4-unorm",s.ASTC5x4UnormSRGB="astc-5x4-unorm-srgb",s.ASTC5x5Unorm="astc-5x5-unorm",s.ASTC5x5UnormSRGB="astc-5x5-unorm-srgb",s.ASTC6x5Unorm="astc-6x5-unorm",s.ASTC6x5UnormSRGB="astc-6x5-unorm-srgb",s.ASTC6x6Unorm="astc-6x6-unorm",s.ASTC6x6UnormSRGB="astc-6x6-unorm-srgb",s.ASTC8x5Unorm="astc-8x5-unorm",s.ASTC8x5UnormSRGB="astc-8x5-unorm-srgb",s.ASTC8x6Unorm="astc-8x6-unorm",s.ASTC8x6UnormSRGB="astc-8x6-unorm-srgb",s.ASTC8x8Unorm="astc-8x8-unorm",s.ASTC8x8UnormSRGB="astc-8x8-unorm-srgb",s.ASTC10x5Unorm="astc-10x5-unorm",s.ASTC10x5UnormSRGB="astc-10x5-unorm-srgb",s.ASTC10x6Unorm="astc-10x6-unorm",s.ASTC10x6UnormSRGB="astc-10x6-unorm-srgb",s.ASTC10x8Unorm="astc-10x8-unorm",s.ASTC10x8UnormSRGB="astc-10x8-unorm-srgb",s.ASTC10x10Unorm="astc-10x10-unorm",s.ASTC10x10UnormSRGB="astc-10x10-unorm-srgb",s.ASTC12x10Unorm="astc-12x10-unorm",s.ASTC12x10UnormSRGB="astc-12x10-unorm-srgb",s.ASTC12x12Unorm="astc-12x12-unorm",s.ASTC12x12UnormSRGB="astc-12x12-unorm-srgb",s.Depth32FloatStencil8="depth32float-stencil8"})(gS||(gS={}));var SS;(function(s){s.ClampToEdge="clamp-to-edge",s.Repeat="repeat",s.MirrorRepeat="mirror-repeat"})(SS||(SS={}));var vS;(function(s){s.Nearest="nearest",s.Linear="linear"})(vS||(vS={}));var xS;(function(s){s.Nearest="nearest",s.Linear="linear"})(xS||(xS={}));var ES;(function(s){s.Never="never",s.Less="less",s.Equal="equal",s.LessEqual="less-equal",s.Greater="greater",s.NotEqual="not-equal",s.GreaterEqual="greater-equal",s.Always="always"})(ES||(ES={}));var TS;(function(s){s[s.Vertex=1]="Vertex",s[s.Fragment=2]="Fragment",s[s.Compute=4]="Compute"})(TS||(TS={}));var bS;(function(s){s.Uniform="uniform",s.Storage="storage",s.ReadOnlyStorage="read-only-storage"})(bS||(bS={}));var CS;(function(s){s.Filtering="filtering",s.NonFiltering="non-filtering",s.Comparison="comparison"})(CS||(CS={}));var yS;(function(s){s.Float="float",s.UnfilterableFloat="unfilterable-float",s.Depth="depth",s.Sint="sint",s.Uint="uint"})(yS||(yS={}));var IS;(function(s){s.WriteOnly="write-only",s.ReadOnly="read-only",s.ReadWrite="read-write"})(IS||(IS={}));var RS;(function(s){s.Error="error",s.Warning="warning",s.Info="info"})(RS||(RS={}));var AS;(function(s){s.Validation="validation",s.Internal="internal"})(AS||(AS={}));var PS;(function(s){s.Auto="auto"})(PS||(PS={}));var OS;(function(s){s.PointList="point-list",s.LineList="line-list",s.LineStrip="line-strip",s.TriangleList="triangle-list",s.TriangleStrip="triangle-strip"})(OS||(OS={}));var NS;(function(s){s.CCW="ccw",s.CW="cw"})(NS||(NS={}));var DS;(function(s){s.None="none",s.Front="front",s.Back="back"})(DS||(DS={}));var MS;(function(s){s[s.Red=1]="Red",s[s.Green=2]="Green",s[s.Blue=4]="Blue",s[s.Alpha=8]="Alpha",s[s.All=15]="All"})(MS||(MS={}));var FS;(function(s){s.Zero="zero",s.One="one",s.Src="src",s.OneMinusSrc="one-minus-src",s.SrcAlpha="src-alpha",s.OneMinusSrcAlpha="one-minus-src-alpha",s.Dst="dst",s.OneMinusDst="one-minus-dst",s.DstAlpha="dst-alpha",s.OneMinusDstAlpha="one-minus-dst-alpha",s.SrcAlphaSaturated="src-alpha-saturated",s.Constant="constant",s.OneMinusConstant="one-minus-constant",s.Src1="src1",s.OneMinusSrc1="one-minus-src1",s.Src1Alpha="src1-alpha",s.OneMinusSrc1Alpha="one-minus-src1-alpha"})(FS||(FS={}));var LS;(function(s){s.Add="add",s.Subtract="subtract",s.ReverseSubtract="reverse-subtract",s.Min="min",s.Max="max"})(LS||(LS={}));var wS;(function(s){s.Keep="keep",s.Zero="zero",s.Replace="replace",s.Invert="invert",s.IncrementClamp="increment-clamp",s.DecrementClamp="decrement-clamp",s.IncrementWrap="increment-wrap",s.DecrementWrap="decrement-wrap"})(wS||(wS={}));var BS;(function(s){s.Uint16="uint16",s.Uint32="uint32"})(BS||(BS={}));var VS;(function(s){s.Uint8="uint8",s.Uint8x2="uint8x2",s.Uint8x4="uint8x4",s.Sint8="sint8",s.Sint8x2="sint8x2",s.Sint8x4="sint8x4",s.Unorm8="unorm8",s.Unorm8x2="unorm8x2",s.Unorm8x4="unorm8x4",s.Snorm8="snorm8",s.Snorm8x2="snorm8x2",s.Snorm8x4="snorm8x4",s.Uint16="uint16",s.Uint16x2="uint16x2",s.Uint16x4="uint16x4",s.Sint16="sint16",s.Sint16x2="sint16x2",s.Sint16x4="sint16x4",s.Unorm16="unorm16",s.Unorm16x2="unorm16x2",s.Unorm16x4="unorm16x4",s.Snorm16="snorm16",s.Snorm16x2="snorm16x2",s.Snorm16x4="snorm16x4",s.Float16="float16",s.Float16x2="float16x2",s.Float16x4="float16x4",s.Float32="float32",s.Float32x2="float32x2",s.Float32x3="float32x3",s.Float32x4="float32x4",s.Uint32="uint32",s.Uint32x2="uint32x2",s.Uint32x3="uint32x3",s.Uint32x4="uint32x4",s.Sint32="sint32",s.Sint32x2="sint32x2",s.Sint32x3="sint32x3",s.Sint32x4="sint32x4",s.UNORM10x10x10x2="unorm10-10-10-2",s.UNORM8x4BGRA="unorm8x4-bgra"})(VS||(VS={}));var US;(function(s){s.Vertex="vertex",s.Instance="instance"})(US||(US={}));var kS;(function(s){s.Beginning="beginning",s.End="end"})(kS||(kS={}));var GS;(function(s){s.Beginning="beginning",s.End="end"})(GS||(GS={}));var zS;(function(s){s.Load="load",s.Clear="clear"})(zS||(zS={}));var WS;(function(s){s.Store="store",s.Discard="discard"})(WS||(WS={}));var HS;(function(s){s.Occlusion="occlusion",s.Timestamp="timestamp"})(HS||(HS={}));var $S;(function(s){s.Opaque="opaque",s.Premultiplied="premultiplied"})($S||($S={}));var XS;(function(s){s.Standard="standard",s.Extended="extended"})(XS||(XS={}));var YS;(function(s){s.Unknown="unknown",s.Destroyed="destroyed"})(YS||(YS={}));var jS;(function(s){s.Validation="validation",s.OutOfMemory="out-of-memory",s.Internal="internal"})(jS||(jS={}));class jt{constructor(){this.shaderLanguage=0}_addUniformToLeftOverUBO(e,t,i){let r=0;[e,t,r]=this._getArraySize(e,t,i);for(let n=0;n<this._webgpuProcessingContext.leftOverUniforms.length;n++)if(this._webgpuProcessingContext.leftOverUniforms[n].name===e)return;this._webgpuProcessingContext.leftOverUniforms.push({name:e,type:t,length:r})}_buildLeftOverUBO(){if(!this._webgpuProcessingContext.leftOverUniforms.length)return"";const e=jt.LeftOvertUBOName;let t=this._webgpuProcessingContext.availableBuffers[e];return t||(t={binding:this._webgpuProcessingContext.getNextFreeUBOBinding()},this._webgpuProcessingContext.availableBuffers[e]=t,this._addBufferBindingDescription(e,t,"uniform",!0),this._addBufferBindingDescription(e,t,"uniform",!1)),this._generateLeftOverUBOCode(e,t)}_collectBindingNames(){for(let e=0;e<this._webgpuProcessingContext.bindGroupLayoutEntries.length;e++){const t=this._webgpuProcessingContext.bindGroupLayoutEntries[e];if(t===void 0){this._webgpuProcessingContext.bindGroupLayoutEntries[e]=[];continue}for(let i=0;i<t.length;i++){const r=this._webgpuProcessingContext.bindGroupLayoutEntries[e][i],n=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][r.binding].name,a=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][r.binding].nameInArrayOfTexture;r&&(r.texture||r.externalTexture||r.storageTexture?this._webgpuProcessingContext.textureNames.push(a):r.sampler?this._webgpuProcessingContext.samplerNames.push(n):r.buffer&&this._webgpuProcessingContext.bufferNames.push(n))}}}_preCreateBindGroupEntries(){const e=this._webgpuProcessingContext.bindGroupEntries;for(let t=0;t<this._webgpuProcessingContext.bindGroupLayoutEntries.length;t++){const i=this._webgpuProcessingContext.bindGroupLayoutEntries[t],r=[];for(let n=0;n<i.length;n++){const a=this._webgpuProcessingContext.bindGroupLayoutEntries[t][n];a.sampler||a.texture||a.storageTexture||a.externalTexture?r.push({binding:a.binding,resource:void 0}):a.buffer&&r.push({binding:a.binding,resource:{buffer:void 0,offset:0,size:0}})}e[t]=r}}_addTextureBindingDescription(e,t,i,r,n,a){let{groupIndex:o,bindingIndex:l}=t.textures[i];if(this._webgpuProcessingContext.bindGroupLayoutEntries[o]||(this._webgpuProcessingContext.bindGroupLayoutEntries[o]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o][l]){let c;r===null?c=this._webgpuProcessingContext.bindGroupLayoutEntries[o].push({binding:l,visibility:0,externalTexture:{}}):n?c=this._webgpuProcessingContext.bindGroupLayoutEntries[o].push({binding:l,visibility:0,storageTexture:{access:"write-only",format:n,viewDimension:r}}):c=this._webgpuProcessingContext.bindGroupLayoutEntries[o].push({binding:l,visibility:0,texture:{sampleType:t.sampleType,viewDimension:r,multisampled:!1}});const u=t.isTextureArray?e+i:e;this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o][l]={name:e,index:c-1,nameInArrayOfTexture:u}}l=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o][l].index,a?this._webgpuProcessingContext.bindGroupLayoutEntries[o][l].visibility|=1:this._webgpuProcessingContext.bindGroupLayoutEntries[o][l].visibility|=2}_addSamplerBindingDescription(e,t,i){let{groupIndex:r,bindingIndex:n}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[r]||(this._webgpuProcessingContext.bindGroupLayoutEntries[r]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][n]){const a=this._webgpuProcessingContext.bindGroupLayoutEntries[r].push({binding:n,visibility:0,sampler:{type:t.type}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][n]={name:e,index:a-1}}n=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][n].index,i?this._webgpuProcessingContext.bindGroupLayoutEntries[r][n].visibility|=1:this._webgpuProcessingContext.bindGroupLayoutEntries[r][n].visibility|=2}_addBufferBindingDescription(e,t,i,r){let{groupIndex:n,bindingIndex:a}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[n]||(this._webgpuProcessingContext.bindGroupLayoutEntries[n]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][a]){const o=this._webgpuProcessingContext.bindGroupLayoutEntries[n].push({binding:a,visibility:0,buffer:{type:i}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][a]={name:e,index:o-1}}a=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][a].index,r?this._webgpuProcessingContext.bindGroupLayoutEntries[n][a].visibility|=1:this._webgpuProcessingContext.bindGroupLayoutEntries[n][a].visibility|=2}}jt.LeftOvertUBOName="LeftOver";jt.InternalsUBOName="Internals";jt.UniformSizes={bool:1,int:1,float:1,vec2:2,ivec2:2,uvec2:2,vec3:3,ivec3:3,uvec3:3,vec4:4,ivec4:4,uvec4:4,mat2:4,mat3:12,mat4:16,i32:1,u32:1,f32:1,mat2x2:4,mat3x3:12,mat4x4:16,mat2x2f:4,mat3x3f:12,mat4x4f:16,vec2i:2,vec3i:3,vec4i:4,vec2u:2,vec3u:3,vec4u:4,vec2f:2,vec3f:3,vec4f:4,vec2h:1,vec3h:2,vec4h:2};jt._SamplerFunctionByWebGLSamplerType={sampler2D:"sampler2D",sampler2DArray:"sampler2DArray",sampler2DShadow:"sampler2DShadow",sampler2DArrayShadow:"sampler2DArrayShadow",samplerCube:"samplerCube",sampler3D:"sampler3D"};jt._TextureTypeByWebGLSamplerType={sampler2D:"texture2D",sampler2DArray:"texture2DArray",sampler2DShadow:"texture2D",sampler2DArrayShadow:"texture2DArray",samplerCube:"textureCube",samplerCubeArray:"textureCubeArray",sampler3D:"texture3D"};jt._GpuTextureViewDimensionByWebGPUTextureType={textureCube:"cube",textureCubeArray:"cube-array",texture2D:"2d",texture2DArray:"2d-array",texture3D:"3d"};jt._SamplerTypeByWebGLSamplerType={sampler2DShadow:"samplerShadow",sampler2DArrayShadow:"samplerShadow"};jt._IsComparisonSamplerByWebGPUSamplerType={samplerShadow:!0,samplerArrayShadow:!0,sampler:!1};class ow{get isAsync(){return!1}get isReady(){return!!this.stages}constructor(e,t){this.bindGroupLayouts={},this._name="unnamed",this.shaderProcessingContext=e,this._leftOverUniformsByName={},this.engine=t,this.vertexBufferKindToType={}}_handlesSpectorRebuildCallback(){}_fillEffectInformation(e,t,i,r,n,a,o,l){const c=this.engine;c._doNotHandleContextLost&&(e._fragmentSourceCode="",e._vertexSourceCode="");const u=this.shaderProcessingContext.availableTextures;let h;for(h=0;h<n.length;h++){const m=n[h],g=u[n[h]];g==null||g==null?(n.splice(h,1),h--):a[m]=h}for(const m of c.getAttributes(this,o))l.push(m);this.buildUniformLayout();const d=[],f=[];for(h=0;h<o.length;h++){const m=l[h];m>=0&&(d.push(o[h]),f.push(m))}this.shaderProcessingContext.attributeNamesFromEffect=d,this.shaderProcessingContext.attributeLocationsFromEffect=f}buildUniformLayout(){var e;if(this.shaderProcessingContext.leftOverUniforms.length){(e=this.uniformBuffer)==null||e.dispose(),this.uniformBuffer=new hn(this.engine,void 0,void 0,"leftOver-"+this._name);for(const t of this.shaderProcessingContext.leftOverUniforms){const i=t.type.replace(/^(.*?)(<.*>)?$/,"$1"),r=jt.UniformSizes[i];this.uniformBuffer.addUniform(t.name,r,t.length),this._leftOverUniformsByName[t.name]=t.type}this.uniformBuffer.create()}}setEngine(e){this.engine=e}dispose(){this.uniformBuffer&&this.uniformBuffer.dispose()}setInt(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt(e,t)}setInt2(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt2(e,t,i)}setInt3(e,t,i,r){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt3(e,t,i,r)}setInt4(e,t,i,r,n){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt4(e,t,i,r,n)}setIntArray(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateIntArray(e,t)}setIntArray2(e,t){this.setIntArray(e,t)}setIntArray3(e,t){this.setIntArray(e,t)}setIntArray4(e,t){this.setIntArray(e,t)}setUInt(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt(e,t)}setUInt2(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt2(e,t,i)}setUInt3(e,t,i,r){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt3(e,t,i,r)}setUInt4(e,t,i,r,n){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt4(e,t,i,r,n)}setUIntArray(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUIntArray(e,t)}setUIntArray2(e,t){this.setUIntArray(e,t)}setUIntArray3(e,t){this.setUIntArray(e,t)}setUIntArray4(e,t){this.setUIntArray(e,t)}setArray(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateArray(e,t)}setArray2(e,t){this.setArray(e,t)}setArray3(e,t){this.setArray(e,t)}setArray4(e,t){this.setArray(e,t)}setMatrices(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrices(e,t)}setMatrix(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix(e,t)}setMatrix3x3(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix3x3(e,t)}setMatrix2x2(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix2x2(e,t)}setFloat(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat(e,t)}setVector2(e,t){this.setFloat2(e,t.x,t.y)}setFloat2(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat2(e,t,i)}setVector3(e,t){this.setFloat3(e,t.x,t.y,t.z)}setFloat3(e,t,i,r){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat3(e,t,i,r)}setVector4(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setQuaternion(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setFloat4(e,t,i,r,n){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat4(e,t,i,r,n)}setColor3(e,t){this.setFloat3(e,t.r,t.g,t.b)}setColor4(e,t,i){this.setFloat4(e,t.r,t.g,t.b,i)}setDirectColor4(e,t){this.setFloat4(e,t.r,t.g,t.b,t.a)}_getVertexShaderCode(){var e;return(e=this.sources)==null?void 0:e.vertex}_getFragmentShaderCode(){var e;return(e=this.sources)==null?void 0:e.fragment}}const lw=4,cw=65536,qS={mat2:2,mat3:3,mat4:4,mat2x2:2,mat3x3:3,mat4x4:4};class Sr{static get KnownUBOs(){return Sr._SimplifiedKnownBindings?Sr._SimplifiedKnownUBOs:Sr._KnownUBOs}constructor(e,t=!1){this.vertexBufferKindToNumberOfComponents={},this.shaderLanguage=e,this._attributeNextLocation=0,this._varyingNextLocation=0,this.freeGroupIndex=0,this.freeBindingIndex=0,this.availableVaryings={},this.availableAttributes={},this.availableBuffers={},this.availableTextures={},this.availableSamplers={},this.orderedAttributes=[],this.bindGroupLayoutEntries=[],this.bindGroupLayoutEntryInfo=[],this.bindGroupEntries=[],this.bufferNames=[],this.textureNames=[],this.samplerNames=[],this.leftOverUniforms=[],t||this._findStartingGroupBinding()}_findStartingGroupBinding(){const e=Sr.KnownUBOs,t=[];for(const i in e){const r=e[i].binding;r.groupIndex!==-1&&(t[r.groupIndex]===void 0?t[r.groupIndex]=r.bindingIndex:t[r.groupIndex]=Math.max(t[r.groupIndex],r.bindingIndex))}this.freeGroupIndex=t.length-1,this.freeGroupIndex===0?(this.freeGroupIndex++,this.freeBindingIndex=0):this.freeBindingIndex=t[t.length-1]+1}getAttributeNextLocation(e,t=0){const i=this._attributeNextLocation;return this._attributeNextLocation+=(qS[e]??1)*(t||1),i}getVaryingNextLocation(e,t=0){const i=this._varyingNextLocation;return this._varyingNextLocation+=(qS[e]??1)*(t||1),i}getNextFreeUBOBinding(){return this._getNextFreeBinding(1)}_getNextFreeBinding(e){if(this.freeBindingIndex>cw-e&&(this.freeGroupIndex++,this.freeBindingIndex=0),this.freeGroupIndex===lw)throw"Too many textures or UBOs have been declared and it is not supported in WebGPU.";const t={groupIndex:this.freeGroupIndex,bindingIndex:this.freeBindingIndex};return this.freeBindingIndex+=e,t}}Sr._SimplifiedKnownBindings=!0;Sr._SimplifiedKnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:-1,bindingIndex:-1}},Light1:{binding:{groupIndex:-1,bindingIndex:-1}},Light2:{binding:{groupIndex:-1,bindingIndex:-1}},Light3:{binding:{groupIndex:-1,bindingIndex:-1}},Light4:{binding:{groupIndex:-1,bindingIndex:-1}},Light5:{binding:{groupIndex:-1,bindingIndex:-1}},Light6:{binding:{groupIndex:-1,bindingIndex:-1}},Light7:{binding:{groupIndex:-1,bindingIndex:-1}},Light8:{binding:{groupIndex:-1,bindingIndex:-1}},Light9:{binding:{groupIndex:-1,bindingIndex:-1}},Light10:{binding:{groupIndex:-1,bindingIndex:-1}},Light11:{binding:{groupIndex:-1,bindingIndex:-1}},Light12:{binding:{groupIndex:-1,bindingIndex:-1}},Light13:{binding:{groupIndex:-1,bindingIndex:-1}},Light14:{binding:{groupIndex:-1,bindingIndex:-1}},Light15:{binding:{groupIndex:-1,bindingIndex:-1}},Light16:{binding:{groupIndex:-1,bindingIndex:-1}},Light17:{binding:{groupIndex:-1,bindingIndex:-1}},Light18:{binding:{groupIndex:-1,bindingIndex:-1}},Light19:{binding:{groupIndex:-1,bindingIndex:-1}},Light20:{binding:{groupIndex:-1,bindingIndex:-1}},Light21:{binding:{groupIndex:-1,bindingIndex:-1}},Light22:{binding:{groupIndex:-1,bindingIndex:-1}},Light23:{binding:{groupIndex:-1,bindingIndex:-1}},Light24:{binding:{groupIndex:-1,bindingIndex:-1}},Light25:{binding:{groupIndex:-1,bindingIndex:-1}},Light26:{binding:{groupIndex:-1,bindingIndex:-1}},Light27:{binding:{groupIndex:-1,bindingIndex:-1}},Light28:{binding:{groupIndex:-1,bindingIndex:-1}},Light29:{binding:{groupIndex:-1,bindingIndex:-1}},Light30:{binding:{groupIndex:-1,bindingIndex:-1}},Light31:{binding:{groupIndex:-1,bindingIndex:-1}},Material:{binding:{groupIndex:-1,bindingIndex:-1}},Mesh:{binding:{groupIndex:-1,bindingIndex:-1}},Internals:{binding:{groupIndex:-1,bindingIndex:-1}}};Sr._KnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:1,bindingIndex:0}},Light1:{binding:{groupIndex:1,bindingIndex:1}},Light2:{binding:{groupIndex:1,bindingIndex:2}},Light3:{binding:{groupIndex:1,bindingIndex:3}},Light4:{binding:{groupIndex:1,bindingIndex:4}},Light5:{binding:{groupIndex:1,bindingIndex:5}},Light6:{binding:{groupIndex:1,bindingIndex:6}},Light7:{binding:{groupIndex:1,bindingIndex:7}},Light8:{binding:{groupIndex:1,bindingIndex:8}},Light9:{binding:{groupIndex:1,bindingIndex:9}},Light10:{binding:{groupIndex:1,bindingIndex:10}},Light11:{binding:{groupIndex:1,bindingIndex:11}},Light12:{binding:{groupIndex:1,bindingIndex:12}},Light13:{binding:{groupIndex:1,bindingIndex:13}},Light14:{binding:{groupIndex:1,bindingIndex:14}},Light15:{binding:{groupIndex:1,bindingIndex:15}},Light16:{binding:{groupIndex:1,bindingIndex:16}},Light17:{binding:{groupIndex:1,bindingIndex:17}},Light18:{binding:{groupIndex:1,bindingIndex:18}},Light19:{binding:{groupIndex:1,bindingIndex:19}},Light20:{binding:{groupIndex:1,bindingIndex:20}},Light21:{binding:{groupIndex:1,bindingIndex:21}},Light22:{binding:{groupIndex:1,bindingIndex:22}},Light23:{binding:{groupIndex:1,bindingIndex:23}},Light24:{binding:{groupIndex:1,bindingIndex:24}},Light25:{binding:{groupIndex:1,bindingIndex:25}},Light26:{binding:{groupIndex:1,bindingIndex:26}},Light27:{binding:{groupIndex:1,bindingIndex:27}},Light28:{binding:{groupIndex:1,bindingIndex:28}},Light29:{binding:{groupIndex:1,bindingIndex:29}},Light30:{binding:{groupIndex:1,bindingIndex:30}},Light31:{binding:{groupIndex:1,bindingIndex:31}},Material:{binding:{groupIndex:2,bindingIndex:0}},Mesh:{binding:{groupIndex:2,bindingIndex:1}},Internals:{binding:{groupIndex:2,bindingIndex:2}}};class uw extends jt{constructor(){super(...arguments),this._missingVaryings=[],this._textureArrayProcessing=[],this._vertexIsGLES3=!1,this._fragmentIsGLES3=!1,this.shaderLanguage=0,this.parseGLES3=!0}_getArraySize(e,t,i){let r=0;const n=e.indexOf("["),a=e.indexOf("]");if(n>0&&a>0){const o=e.substring(n+1,a);r=+o,isNaN(r)&&(r=+i[o.trim()]),e=e.substring(0,n)}return[e,t,r]}initializeShaders(e){this._webgpuProcessingContext=e,this._missingVaryings.length=0,this._textureArrayProcessing.length=0,this.attributeKeywordName=void 0,this.varyingVertexKeywordName=void 0,this.varyingFragmentKeywordName=void 0}preProcessShaderCode(e,t){const i=`// Internals UBO
uniform ${jt.InternalsUBOName} {
float yFactor_;
float textureOutputHeight_;
};
`,r=e.indexOf("// Internals UBO")!==-1;return t?(this._fragmentIsGLES3=e.indexOf("#version 3")!==-1,this._fragmentIsGLES3&&(this.varyingFragmentKeywordName="in"),r?e:i+`##INJECTCODE##
`+e):(this._vertexIsGLES3=e.indexOf("#version 3")!==-1,this._vertexIsGLES3&&(this.attributeKeywordName="in",this.varyingVertexKeywordName="out"),r?e:i+e)}varyingCheck(e,t){const i=/(flat\s)?\s*\bout\b/,r=/(flat\s)?\s*\bin\b/,n=/(flat\s)?\s*\bvarying\b/;return(t&&this._fragmentIsGLES3?r:!t&&this._vertexIsGLES3?i:n).test(e)}varyingProcessor(e,t,i){this._preProcessors=i;const r=/\s*(flat)?\s*out\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm,n=/\s*(flat)?\s*in\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm,a=/\s*(flat)?\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm,l=(t&&this._fragmentIsGLES3?n:!t&&this._vertexIsGLES3?r:a).exec(e);if(l!==null){const c=l[1]??"",u=l[2],h=l[3];let d;t?(d=this._webgpuProcessingContext.availableVaryings[h],this._missingVaryings[d]="",d===void 0&&N.Warn(`Invalid fragment shader: The varying named "${h}" is not declared in the vertex shader! This declaration will be ignored.`)):(d=this._webgpuProcessingContext.getVaryingNextLocation(u,this._getArraySize(h,u,i)[2]),this._webgpuProcessingContext.availableVaryings[h]=d,this._missingVaryings[d]=`layout(location = ${d}) ${c} in ${u} ${h};`),e=e.replace(l[0],d===void 0?"":`layout(location = ${d}) ${c} ${t?"in":"out"} ${u} ${h};`)}return e}attributeProcessor(e,t){this._preProcessors=t;const i=/\s*in\s+(\S+)\s+(\S+)\s*;/gm,r=/\s*attribute\s+(\S+)\s+(\S+)\s*;/gm,a=(this._vertexIsGLES3?i:r).exec(e);if(a!==null){const o=a[1],l=a[2],c=this._webgpuProcessingContext.getAttributeNextLocation(o,this._getArraySize(l,o,t)[2]);this._webgpuProcessingContext.availableAttributes[l]=c,this._webgpuProcessingContext.orderedAttributes[c]=l;const u=this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents[l];if(u!==void 0){const h=u<0?u===-1?"int":"ivec"+-u:u===1?"uint":"uvec"+u,d=`_int_${l}_`;e=e.replace(a[0],`layout(location = ${c}) in ${h} ${d}; ${o} ${l} = ${o}(${d});`)}else e=e.replace(a[0],`layout(location = ${c}) in ${o} ${l};`)}return e}uniformProcessor(e,t,i){this._preProcessors=i;const n=/\s*uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm.exec(e);if(n!==null){let a=n[1],o=n[2];if(a.indexOf("sampler")===0||a.indexOf("sampler")===1){let l=0;[o,a,l]=this._getArraySize(o,a,i);let c=this._webgpuProcessingContext.availableTextures[o];if(!c){c={autoBindSampler:!0,isTextureArray:l>0,isStorageTexture:!1,textures:[],sampleType:"float"};for(let V=0;V<(l||1);++V)c.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}const u=jt._SamplerTypeByWebGLSamplerType[a]??"sampler",h=!!jt._IsComparisonSamplerByWebGPUSamplerType[u],d=h?"comparison":"filtering",f=o+"Sampler";let m=this._webgpuProcessingContext.availableSamplers[f];m||(m={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:d});const g=a.charAt(0)==="u"?"u":a.charAt(0)==="i"?"i":"";g&&(a=a.substring(1));const v=h?"depth":g==="u"?"uint":g==="i"?"sint":"float";c.sampleType=v;const E=l>0,T=m.binding.groupIndex,C=m.binding.bindingIndex,A=jt._SamplerFunctionByWebGLSamplerType[a],I=jt._TextureTypeByWebGLSamplerType[a],F=jt._GpuTextureViewDimensionByWebGPUTextureType[I];if(!E)l=1,e=`layout(set = ${T}, binding = ${C}) uniform ${u} ${f};
                        layout(set = ${c.textures[0].groupIndex}, binding = ${c.textures[0].bindingIndex}) uniform ${g}${I} ${o}Texture;
                        #define ${o} ${g}${A}(${o}Texture, ${f})`;else{const V=[];V.push(`layout(set = ${T}, binding = ${C}) uniform ${g}${u} ${f};`),e=`
`;for(let D=0;D<l;++D){const w=c.textures[D].groupIndex,B=c.textures[D].bindingIndex;V.push(`layout(set = ${w}, binding = ${B}) uniform ${I} ${o}Texture${D};`),e+=`${D>0?`
`:""}#define ${o}${D} ${g}${A}(${o}Texture${D}, ${f})`}e=V.join(`
`)+e,this._textureArrayProcessing.push(o)}this._webgpuProcessingContext.availableTextures[o]=c,this._webgpuProcessingContext.availableSamplers[f]=m,this._addSamplerBindingDescription(f,m,!t);for(let V=0;V<l;++V)this._addTextureBindingDescription(o,c,V,F,null,!t)}else this._addUniformToLeftOverUBO(o,a,i),e=""}return e}uniformBufferProcessor(e,t){const r=/uniform\s+(\w+)/gm.exec(e);if(r!==null){const n=r[1];let a=this._webgpuProcessingContext.availableBuffers[n];if(!a){const o=Sr.KnownUBOs[n];let l;o&&o.binding.groupIndex!==-1?l=o.binding:l=this._webgpuProcessingContext.getNextFreeUBOBinding(),a={binding:l},this._webgpuProcessingContext.availableBuffers[n]=a}this._addBufferBindingDescription(n,a,"uniform",!t),e=e.replace("uniform",`layout(set = ${a.binding.groupIndex}, binding = ${a.binding.bindingIndex}) uniform`)}return e}postProcessor(e,t,i,r,n,a){const o=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,l=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(l,""),e=e.replace(/texture2D\s*\(/g,"texture("),i){const c=e.indexOf("gl_FragCoord")>=0,u=`
                glFragCoord_ = gl_FragCoord;
                if (yFactor_ == 1.) {
                    glFragCoord_.y = textureOutputHeight_ - glFragCoord_.y;
                }
            `,h=c?`vec4 glFragCoord_;
`:"",d=e.search(/layout *\(location *= *0\) *out/g)!==-1;if(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCube\s*\(/g,"texture("),e=e.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),e=e.replace(/gl_FragColor/g,"glFragColor"),e=e.replace(/gl_FragData/g,"glFragData"),e=e.replace(/gl_FragCoord/g,"glFragCoord_"),!this._fragmentIsGLES3)e=e.replace(/void\s+?main\s*\(/g,(o||d?"":`layout(location = 0) out vec4 glFragColor;
`)+"void main(");else{const f=/^\s*out\s+\S+\s+\S+\s*;/gm.exec(e);f!==null&&(e=e.substring(0,f.index)+"layout(location = 0) "+e.substring(f.index))}e=e.replace(/dFdy/g,"(-yFactor_)*dFdy"),e=e.replace("##INJECTCODE##",h),c&&(e=Jc(e,"void main",u))}else if("VERTEXOUTPUT_INVARIANT"in a&&(e=`invariant gl_Position;
`+e),e=e.replace(/gl_InstanceID/g,"gl_InstanceIndex"),e=e.replace(/gl_VertexID/g,"gl_VertexIndex"),t.indexOf("#define MULTIVIEW")!==-1)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e;if(!i){const c=e.lastIndexOf("}");e=e.substring(0,c),e+=`gl_Position.y *= yFactor_;
`,e+="}"}return e}_applyTextureArrayProcessing(e,t){const i=new RegExp(t+"\\s*\\[(.+)?\\]","gm");let r=i.exec(e);for(;r!==null;){const n=r[1];let a=+n;this._preProcessors&&isNaN(a)&&(a=+this._preProcessors[n.trim()]),e=e.replace(r[0],t+a),r=i.exec(e)}return e}_generateLeftOverUBOCode(e,t){let i=`layout(set = ${t.binding.groupIndex}, binding = ${t.binding.bindingIndex}) uniform ${e} {
    `;for(const r of this._webgpuProcessingContext.leftOverUniforms)r.length>0?i+=`    ${r.type} ${r.name}[${r.length}];
`:i+=`    ${r.type} ${r.name};
`;return i+=`};

`,i}finalizeShaders(e,t){for(let r=0;r<this._textureArrayProcessing.length;++r){const n=this._textureArrayProcessing[r];e=this._applyTextureArrayProcessing(e,n),t=this._applyTextureArrayProcessing(t,n)}for(let r=0;r<this._missingVaryings.length;++r){const n=this._missingVaryings[r];n&&n.length>0&&(t=n+`
`+t)}const i=this._buildLeftOverUBO();return e=i+e,t=i+t,this._collectBindingNames(),this._preCreateBindGroupEntries(),this._preProcessors=null,this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents={},{vertexCode:e,fragmentCode:t}}}const ZS="fragmentOutputs.fragDepth",hw="uniforms",dw="internals",fw={texture_1d:"1d",texture_2d:"2d",texture_2d_array:"2d-array",texture_3d:"3d",texture_cube:"cube",texture_cube_array:"cube-array",texture_multisampled_2d:"2d",texture_depth_2d:"2d",texture_depth_2d_array:"2d-array",texture_depth_cube:"cube",texture_depth_cube_array:"cube-array",texture_depth_multisampled_2d:"2d",texture_storage_1d:"1d",texture_storage_2d:"2d",texture_storage_2d_array:"2d-array",texture_storage_3d:"3d",texture_external:null};class pw extends jt{constructor(){super(...arguments),this.shaderLanguage=1,this.uniformRegexp=/uniform\s+(\w+)\s*:\s*(.+)\s*;/,this.textureRegexp=/var\s+(\w+)\s*:\s*((array<\s*)?(texture_\w+)\s*(<\s*(.+)\s*>)?\s*(,\s*\w+\s*>\s*)?);/,this.noPrecision=!0,this.pureMode=!1}_getArraySize(e,t,i){let r=0;const n=t.lastIndexOf(">");if(t.indexOf("array")>=0&&n>0){let a=n;for(;a>0&&t.charAt(a)!==" "&&t.charAt(a)!==",";)a--;const o=t.substring(a+1,n);for(r=+o,isNaN(r)&&(r=+i[o.trim()]);a>0&&(t.charAt(a)===" "||t.charAt(a)===",");)a--;t=t.substring(t.indexOf("<")+1,a+1)}return[e,t,r]}initializeShaders(e){this._webgpuProcessingContext=e,this._attributesInputWGSL=[],this._attributesWGSL=[],this._attributesConversionCodeWGSL=[],this._hasNonFloatAttribute=!1,this._varyingsWGSL=[],this._varyingNamesWGSL=[],this._stridedUniformArrays=[]}preProcessShaderCode(e){const t=this.pureMode?"":`struct ${jt.InternalsUBOName} {
  yFactor_: f32,
  textureOutputHeight_: f32,
};
var<uniform> ${dw} : ${jt.InternalsUBOName};
`;return e.indexOf(t)!==-1?e:t+Sd(e)}varyingCheck(e){return/(flat|linear|perspective)?\s*(center|centroid|sample)?\s*\bvarying\b/.test(e)}varyingProcessor(e,t,i){const n=/\s*(flat|linear|perspective)?\s*(center|centroid|sample)?\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(n!==null){const a=n[1]??"perspective",o=n[2]??"center",l=n[4],c=n[3],u=a==="flat"?`@interpolate(${a})`:`@interpolate(${a}, ${o})`;let h;t?(h=this._webgpuProcessingContext.availableVaryings[c],h===void 0&&N.Warn(`Invalid fragment shader: The varying named "${c}" is not declared in the vertex shader! This declaration will be ignored.`)):(h=this._webgpuProcessingContext.getVaryingNextLocation(l,this._getArraySize(c,l,i)[2]),this._webgpuProcessingContext.availableVaryings[c]=h,this._varyingsWGSL.push(`  @location(${h}) ${u} ${c} : ${l},`),this._varyingNamesWGSL.push(c)),e=""}return e}attributeProcessor(e,t){const r=/\s*attribute\s+(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(r!==null){const n=r[2],a=r[1],o=this._webgpuProcessingContext.getAttributeNextLocation(n,this._getArraySize(a,n,t)[2]);this._webgpuProcessingContext.availableAttributes[a]=o,this._webgpuProcessingContext.orderedAttributes[o]=a;const l=this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents[a];if(l!==void 0){const c=l<0?l===-1?"i32":"vec"+-l+"<i32>":l===1?"u32":"vec"+l+"<u32>",u=`_int_${a}_`;this._attributesInputWGSL.push(`@location(${o}) ${u} : ${c},`),this._attributesWGSL.push(`${a} : ${n},`),this._attributesConversionCodeWGSL.push(`vertexInputs.${a} = ${n}(vertexInputs_.${u});`),this._hasNonFloatAttribute=!0}else this._attributesInputWGSL.push(`@location(${o}) ${a} : ${n},`),this._attributesWGSL.push(`${a} : ${n},`),this._attributesConversionCodeWGSL.push(`vertexInputs.${a} = vertexInputs_.${a};`);e=""}return e}uniformProcessor(e,t,i){const r=this.uniformRegexp.exec(e);if(r!==null){const n=r[2],a=r[1];this._addUniformToLeftOverUBO(a,n,i),e=""}return e}textureProcessor(e,t,i){const r=this.textureRegexp.exec(e);if(r!==null){const n=r[1],a=r[2],o=!!r[3],l=r[4],c=l.indexOf("storage")>0,u=r[6],h=c?u.substring(0,u.indexOf(",")).trim():null;let d=o?this._getArraySize(n,a,i)[2]:0,f=this._webgpuProcessingContext.availableTextures[n];if(f)d=f.textures.length;else{f={isTextureArray:d>0,isStorageTexture:c,textures:[],sampleType:"float"},d=d||1;for(let E=0;E<d;++E)f.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}this._webgpuProcessingContext.availableTextures[n]=f;const m=l.indexOf("depth")>0,g=fw[l],v=m?"depth":u==="u32"?"uint":u==="i32"?"sint":"float";if(f.sampleType=v,g===void 0)throw`Can't get the texture dimension corresponding to the texture function "${l}"!`;for(let E=0;E<d;++E){const{groupIndex:T,bindingIndex:C}=f.textures[E];E===0&&(e=`@group(${T}) @binding(${C}) ${e}`),this._addTextureBindingDescription(n,f,E,g,h,!t)}}return e}_convertDefinesToConst(e){let t="";for(const i in e){const r=e[i];i.startsWith("__")||(!isNaN(parseInt(r))||!isNaN(parseFloat(r))?t+=`const ${i} = ${r};
`:i&&r===""&&(t+=`const ${i} = true;
`))}return t}postProcessor(e,t,i,r,n,a,o){const l=[];for(const c in o)o[c]!=="true"&&l.push(c);l.sort((c,u)=>c.length-u.length>0?-1:c.length===u.length?0:1);for(const c of l){const u=e.indexOf("#define "+c);let h=e.indexOf(`
`,u);h===-1&&(h=e.length);const d=e.substring(u+8+c.length+1,h);e=e.replace(new RegExp(c,"g"),d)}return e=this._convertDefinesToConst(a)+e,"VERTEXOUTPUT_INVARIANT"in a&&(e=`#define VERTEXOUTPUT_INVARIANT
`+e),e}finalizeShaders(e,t){const i=[],r=t.indexOf("fragmentInputs.position")>=0&&!this.pureMode?`
            if (internals.yFactor_ == 1.) {
                fragmentInputs.position.y = internals.textureOutputHeight_ - fragmentInputs.position.y;
            }
        `:"";e=this._processSamplers(e,!0),t=this._processSamplers(t,!1),e=this._processCustomBuffers(e,!0),t=this._processCustomBuffers(t,!1);const n=this._buildLeftOverUBO();e=n+e,t=n+t,e=e.replace(/#define /g,"//#define "),e=this._processStridedUniformArrays(e);let a=`struct VertexInputs {
  @builtin(vertex_index) vertexIndex : u32,
  @builtin(instance_index) instanceIndex : u32,
`;this._attributesInputWGSL.length>0&&(a+=this._attributesInputWGSL.join(`
`)),a+=`
};
var<private> vertexInputs`+(this._hasNonFloatAttribute?"_":"")+` : VertexInputs;
`,this._hasNonFloatAttribute&&(a+=`struct VertexInputs_ {
  vertexIndex : u32, instanceIndex : u32,
`,a+=this._attributesWGSL.join(`
`),a+=`
};
var<private> vertexInputs : VertexInputs_;
`);let o=`struct FragmentInputs {
  @builtin(position)`+(e.indexOf("#define VERTEXOUTPUT_INVARIANT")>=0?" @invariant":"")+` position : vec4<f32>,
`;this._varyingsWGSL.length>0&&(o+=this._varyingsWGSL.join(`
`)),o+=`
};
var<private> vertexOutputs : FragmentInputs;
`,e=a+o+e;let l=`
  vertexInputs${this._hasNonFloatAttribute?"_":""} = input;
`;this._hasNonFloatAttribute&&(l+=`vertexInputs.vertexIndex = vertexInputs_.vertexIndex;
vertexInputs.instanceIndex = vertexInputs_.instanceIndex;
`,l+=this._attributesConversionCodeWGSL.join(`
`),l+=`
`);const c=this.pureMode?"  return vertexOutputs;":`  vertexOutputs.position.y = vertexOutputs.position.y * internals.yFactor_;
  return vertexOutputs;`;let u=e.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")!==-1;e=(u?`diagnostic(off, derivative_uniformity);
`:"")+`diagnostic(off, chromium.unreachable_code);
`+Jc(e,"fn main",l,c),t=t.replace(/#define /g,"//#define "),t=this._processStridedUniformArrays(t),this.pureMode||(t=t.replace(/dpdy/g,"(-internals.yFactor_)*dpdy"));let h=`struct FragmentInputs {
  @builtin(position) position : vec4<f32>,
  @builtin(front_facing) frontFacing : bool,
`;this._varyingsWGSL.length>0&&(h+=this._varyingsWGSL.join(`
`)),h+=`
};
var<private> fragmentInputs : FragmentInputs;
`;let d=`struct FragmentOutputs {
`;const f="fragmentOutputs\\.fragData";let m=t.match(new RegExp(f+"0","g")),g=0;if(m){d+=` @location(${g}) fragData0 : vec4<f32>,
`,g++;for(let I=1;I<8;I++)m=t.match(new RegExp(f+I,"g")),m&&(d+=` @location(${g}) fragData${g} : vec4<f32>,
`,g++);t.indexOf("MRT_AND_COLOR")!==-1&&(d+=`  @location(${g}) color : vec4<f32>,
`,g++)}const v=/oitDepthSampler/;m=t.match(v),m&&(d+=` @location(${g++}) depth : vec2<f32>,
`,d+=` @location(${g++}) frontColor : vec4<f32>,
`,d+=` @location(${g++}) backColor : vec4<f32>,
`),g===0&&(t.indexOf("DUAL_SOURCE_BLENDING")!==-1?(i.push("dual_source_blending"),d+=`  @location(0) @blend_src(0) color : vec4<f32>,
`,d+=`  @location(0) @blend_src(1) color2 : vec4<f32>,
`):d+=`  @location(0) color : vec4<f32>,
`,g++);let E=!1,T=0;for(;!E&&(T=t.indexOf(ZS,T),!(T<0));){const I=T;for(E=!0;T>1&&t.charAt(T)!==`
`;){if(t.charAt(T)==="/"&&t.charAt(T-1)==="/"){E=!1;break}T--}T=I+ZS.length}E&&(d+=`  @builtin(frag_depth) fragDepth: f32,
`),d+=`};
var<private> fragmentOutputs : FragmentOutputs;
`,t=h+d+t;const C=`  fragmentInputs = input;
  `+r,A="  return fragmentOutputs;";return u=t.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")!==-1,i.length>0&&(t="enable "+i.join(`;
enable `)+`;
`+t),t=(u?`diagnostic(off, derivative_uniformity);
`:"")+`diagnostic(off, chromium.unreachable_code);
`+Jc(t,"fn main",C,A),this._collectBindingNames(),this._preCreateBindGroupEntries(),this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents={},{vertexCode:e,fragmentCode:t}}_generateLeftOverUBOCode(e,t){let i="",r=`struct ${e} {
`;for(const n of this._webgpuProcessingContext.leftOverUniforms){const a=n.type.replace(/^(.*?)(<.*>)?$/,"$1"),o=jt.UniformSizes[a];if(n.length>0)if(o<=2){const l=`${e}_${this._stridedUniformArrays.length}_strided_arr`;i+=`struct ${l} {
                        @size(16)
                        el: ${a},
                    }`,this._stridedUniformArrays.push(n.name),r+=` @align(16) ${n.name} : array<${l}, ${n.length}>,
`}else r+=` ${n.name} : array<${n.type}, ${n.length}>,
`;else r+=`  ${n.name} : ${n.type},
`}return r+=`};
`,r=`${i}
${r}`,r+=`@group(${t.binding.groupIndex}) @binding(${t.binding.bindingIndex}) var<uniform> ${hw} : ${e};
`,r}_processSamplers(e,t){const i=/var\s+(\w+Sampler)\s*:\s*(sampler|sampler_comparison)\s*;/gm;for(;;){const r=i.exec(e);if(r===null)break;const n=r[1],a=r[2],o=n.length-7,l=n.lastIndexOf("Sampler")===o?n.substring(0,o):null,c=a==="sampler_comparison"?"comparison":"filtering";if(l){const m=this._webgpuProcessingContext.availableTextures[l];m&&(m.autoBindSampler=!0)}let u=this._webgpuProcessingContext.availableSamplers[n];u||(u={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:c},this._webgpuProcessingContext.availableSamplers[n]=u),this._addSamplerBindingDescription(n,u,t);const h=e.substring(0,r.index),d=`@group(${u.binding.groupIndex}) @binding(${u.binding.bindingIndex}) `,f=e.substring(r.index);e=h+d+f,i.lastIndex+=d.length}return e}_processCustomBuffers(e,t){var r;const i=/var<\s*(uniform|storage)\s*(,\s*(read|read_write)\s*)?>\s+(\S+)\s*:\s*(\S+)\s*;/gm;for(;;){const n=i.exec(e);if(n===null)break;const a=n[1],o=n[3];let l=n[4];const c=n[5];let u=this._webgpuProcessingContext.availableBuffers[l];if(!u){const v=a==="uniform"?Sr.KnownUBOs[c]:null;let E;v?(l=c,E=v.binding,E.groupIndex===-1&&(E=(r=this._webgpuProcessingContext.availableBuffers[l])==null?void 0:r.binding,E||(E=this._webgpuProcessingContext.getNextFreeUBOBinding()))):E=this._webgpuProcessingContext.getNextFreeUBOBinding(),u={binding:E},this._webgpuProcessingContext.availableBuffers[l]=u}this._addBufferBindingDescription(l,this._webgpuProcessingContext.availableBuffers[l],o==="read_write"?"storage":a==="storage"?"read-only-storage":"uniform",t);const h=u.binding.groupIndex,d=u.binding.bindingIndex,f=e.substring(0,n.index),m=`@group(${h}) @binding(${d}) `,g=e.substring(n.index);e=f+m+g,i.lastIndex+=m.length}return e}_processStridedUniformArrays(e){for(const t of this._stridedUniformArrays)e=e.replace(new RegExp(`${t}\\s*\\[(.*?)\\]`,"g"),`${t}[$1].el`);return e}}class Gc{get underlyingResource(){return this._webgpuTexture}getMSAATexture(e){var t;return((t=this._webgpuMSAATexture)==null?void 0:t[e])??null}setMSAATexture(e,t){this._webgpuMSAATexture||(this._webgpuMSAATexture=[]),this._webgpuMSAATexture[t]=e}releaseMSAATexture(e){if(this._webgpuMSAATexture)if(e!==void 0)this._engine._textureHelper.releaseTexture(this._webgpuMSAATexture[e]),delete this._webgpuMSAATexture[e];else{for(const t of this._webgpuMSAATexture)this._engine._textureHelper.releaseTexture(t);this._webgpuMSAATexture=null}}constructor(e,t=null){this._engine=e,this._originalFormatIsRGB=!1,this.format="rgba8unorm",this.textureUsages=0,this.textureAdditionalUsages=0,this._webgpuTexture=t,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}set(e){this._webgpuTexture=e}setUsage(e,t,i,r,n,a,o,l){let c="2d",u=1;r?(c=i?"cube-array":"cube",u=6*(l||1)):n?(c="3d",u=1):i&&(c="2d-array",u=l);const h=Qe.GetDepthFormatOnly(this.format),d=Qe.HasDepthAndStencilAspects(this.format)?"depth-only":"all";this.createView({label:`TextureView${n?"3D":r?"Cube":"2D"}${i?"_Array"+u:""}_${a}x${o}_${t?"wmips":"womips"}_${this.format}_${c}`,format:h,dimension:c,mipLevelCount:t?Ol(Math.max(a,o))+1:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:u,aspect:d})}createView(e,t=!1){if(this.view=this._webgpuTexture.createView(e),t&&e){const i=e.mipLevelCount;e.mipLevelCount=1,this.viewForWriting=this._webgpuTexture.createView(e),e.mipLevelCount=i}}reset(){this._webgpuTexture=null,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}release(){var e,t;(e=this._webgpuTexture)==null||e.destroy(),this.releaseMSAATexture(),(t=this._copyInvertYTempTexture)==null||t.destroy(),this.reset()}}const mw=`
    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));
    const tex = array<vec2<f32>, 4>( vec2f(0.0f, 0.0f),  vec2f(1.0f, 0.0f),  vec2f(0.0f, 1.0f),  vec2f(1.0f, 1.0f));

    varying vTex: vec2f;

    @vertex
    fn main(input : VertexInputs) -> FragmentInputs {
        vertexOutputs.vTex = tex[input.vertexIndex];
        vertexOutputs.position = vec4f(pos[input.vertexIndex], 0.0, 1.0);
    }
    `,_w=`
    var imgSampler: sampler;
    var img: texture_2d<f32>;

    varying vTex: vec2f;

    @fragment
    fn main(input: FragmentInputs) -> FragmentOutputs {
        fragmentOutputs.color = textureSample(img, imgSampler, input.vTex);
    }
    `,uR=`
    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));
    const tex = array<vec2<f32>, 4>( vec2f(0.0f, 0.0f),  vec2f(1.0f, 0.0f),  vec2f(0.0f, 1.0f),  vec2f(1.0f, 1.0f));

    var img: texture_2d<f32>;

    #ifdef INVERTY
        varying vTextureSize: vec2f;
    #endif

    @vertex
    fn main(input : VertexInputs) -> FragmentInputs {
        #ifdef INVERTY
            vertexOutputs.vTextureSize = vec2f(textureDimensions(img, 0));
        #endif
        vertexOutputs.position =  vec4f(pos[input.vertexIndex], 0.0, 1.0);
    }
    `,gw=`
    var img: texture_2d<f32>;

    #ifdef INVERTY
        varying vTextureSize: vec2f;
    #endif

    @fragment
    fn main(input: FragmentInputs) -> FragmentOutputs {
    #ifdef INVERTY
        var color: vec4f = textureLoad(img, vec2i(i32(input.position.x), i32(input.vTextureSize.y - input.position.y)), 0);
    #else
        var color: vec4f = textureLoad(img, vec2i(input.position.xy), 0);
    #endif
    #ifdef PREMULTIPLYALPHA
        color = vec4f(color.rgb * color.a, color.a);
    #endif
        fragmentOutputs.color = color;
    }
    `,Sw=uR,vw=`
    var img: texture_2d<f32>;
    uniform ofstX: f32;
    uniform ofstY: f32;
    uniform width: f32;
    uniform height: f32;

    #ifdef INVERTY
        varying vTextureSize: vec2f;
    #endif

    @fragment
    fn main(input: FragmentInputs) -> FragmentOutputs {
        if (input.position.x < uniforms.ofstX || input.position.x >= uniforms.ofstX + uniforms.width) {
            discard;
        }
        if (input.position.y < uniforms.ofstY || input.position.y >= uniforms.ofstY + uniforms.height) {
            discard;
        }
    #ifdef INVERTY
        var color: vec4f = textureLoad(img, vec2i(i32(input.position.x), i32(uniforms.ofstY + uniforms.height - (input.position.y - uniforms.ofstY))), 0);
    #else
        var color: vec4f = textureLoad(img, vec2i(input.position.xy), 0);
    #endif
    #ifdef PREMULTIPLYALPHA
        color = vec4f(color.rgb * color.a, color.a);
    #endif
        fragmentOutputs.color = color;
    }
    `,xw=`
    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));

    @vertex
    fn main(input : VertexInputs) -> FragmentInputs {
        vertexOutputs.position =  vec4f(pos[input.vertexIndex], 0.0, 1.0);
    }
    `,Ew=`
    uniform color: vec4f;


    @fragment
    fn main(input: FragmentInputs) -> FragmentOutputs {
        fragmentOutputs.color = uniforms.color;
    }
    `,Tw=`
    struct VertexOutput {
        @builtin(position) Position : vec4<f32>,
        @location(0) fragUV : vec2<f32>
    }

    @vertex
    fn main(
        @builtin(vertex_index) VertexIndex : u32
    ) -> VertexOutput {
        var pos = array<vec2<f32>, 4>(
            vec2(-1.0,  1.0),
            vec2( 1.0,  1.0),
            vec2(-1.0, -1.0),
            vec2( 1.0, -1.0)
        );
        var tex = array<vec2<f32>, 4>(
            vec2(0.0, 0.0),
            vec2(1.0, 0.0),
            vec2(0.0, 1.0),
            vec2(1.0, 1.0)
        );

        var output: VertexOutput;

        output.Position = vec4<f32>(pos[VertexIndex], 0.0, 1.0);
        output.fragUV = tex[VertexIndex];

        return output;
    }
    `,bw=`
    @group(0) @binding(0) var videoSampler: sampler;
    @group(0) @binding(1) var videoTexture: texture_external;

    @fragment
    fn main(
        @location(0) fragUV: vec2<f32>
    ) -> @location(0) vec4<f32> {
        return textureSampleBaseClampToEdge(videoTexture, videoSampler, fragUV);
    }
    `,Cw=`
    @group(0) @binding(0) var videoSampler: sampler;
    @group(0) @binding(1) var videoTexture: texture_external;

    @fragment
    fn main(
        @location(0) fragUV: vec2<f32>
    ) -> @location(0) vec4<f32> {
        return textureSampleBaseClampToEdge(videoTexture, videoSampler, vec2<f32>(fragUV.x, 1.0 - fragUV.y));
    }
    `;var ns;(function(s){s[s.MipMap=0]="MipMap",s[s.InvertYPremultiplyAlpha=1]="InvertYPremultiplyAlpha",s[s.Clear=2]="Clear",s[s.InvertYPremultiplyAlphaWithOfst=3]="InvertYPremultiplyAlphaWithOfst"})(ns||(ns={}));var so;(function(s){s[s.DontInvertY=0]="DontInvertY",s[s.InvertY=1]="InvertY"})(so||(so={}));const QS=[{vertex:mw,fragment:_w},{vertex:uR,fragment:gw},{vertex:xw,fragment:Ew},{vertex:Sw,fragment:vw}],Ps={"":0,r8unorm:1,r8uint:2,r8sint:3,r16uint:4,r16sint:5,r16float:6,rg8unorm:7,rg8uint:8,rg8sint:9,r32uint:10,r32sint:11,r32float:12,rg16uint:13,rg16sint:14,rg16float:15,rgba8unorm:16,"rgba8unorm-srgb":17,rgba8uint:18,rgba8sint:19,bgra8unorm:20,"bgra8unorm-srgb":21,rgb10a2uint:22,rgb10a2unorm:23,rg32uint:24,rg32sint:25,rg32float:26,rgba16uint:27,rgba16sint:28,rgba16float:29,rgba32uint:30,rgba32sint:31,rgba32float:32,stencil8:33,depth16unorm:34,depth24plus:35,"depth24plus-stencil8":36,depth32float:37,"depth32float-stencil8":38,r16unorm:39,rg16unorm:40,rgba16unorm:41,r16snorm:42,rg16snorm:43,rgba16snorm:44};class yw{constructor(e,t,i,r){if(this._pipelines={},this._compiledShaders=[],this._videoPipelines={},this._videoCompiledShaders=[],this._deferredReleaseTextures=[],this._engine=e,this._device=t,this._bufferManager=i,r.indexOf("rg11b10ufloat-renderable")!==-1){const n=Object.keys(Ps);Ps.rg11b10ufloat=Ps[n[n.length-1]]+1}this._mipmapSampler=t.createSampler({minFilter:"linear"}),this._videoSampler=t.createSampler({minFilter:"linear"}),this._ubCopyWithOfst=this._bufferManager.createBuffer(4*4,$e.Uniform|$e.CopyDst,"UBCopyWithOffset").underlyingResource,this._getPipeline("rgba8unorm"),this._getVideoPipeline("rgba8unorm")}_getPipeline(e,t=ns.MipMap,i){const r=t===ns.MipMap?1:t===ns.InvertYPremultiplyAlpha?((i.invertY?1:0)<<1)+((i.premultiplyAlpha?1:0)<<2):t===ns.Clear?8:t===ns.InvertYPremultiplyAlphaWithOfst?((i.invertY?1:0)<<4)+((i.premultiplyAlpha?1:0)<<5):0;this._pipelines[e]||(this._pipelines[e]=[]);let n=this._pipelines[e][r];if(!n){let a="";(t===ns.InvertYPremultiplyAlpha||t===ns.InvertYPremultiplyAlphaWithOfst)&&(i.invertY&&(a+=`#define INVERTY
`),i.premultiplyAlpha&&(a+=`#define PREMULTIPLYALPHA
`));let o=this._compiledShaders[r];if(!o){let c=QS[t].vertex,u=QS[t].fragment;const h={defines:a.split(`
`),indexParameters:null,isFragment:!1,shouldUseHighPrecisionShader:!0,processor:this._engine._getShaderProcessor(1),supportsUniformBuffers:!0,shadersRepository:"",includesShadersStore:{},version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._engine._getShaderProcessingContext(1,!0),isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer};Jy(h),h.processor.pureMode=!0,hd(c,h,g=>{c=g},this._engine),h.isFragment=!0,hd(u,h,g=>{u=g},this._engine);const d=eI(c,u,h);h.processor.pureMode=!1;const f=this._device.createShaderModule({label:`BabylonWebGPUDevice${this._engine.uniqueId}_InternalVertexShader_${r}`,code:d.vertexCode}),m=this._device.createShaderModule({label:`BabylonWebGPUDevice${this._engine.uniqueId}_InternalFragmentShader_${r}`,code:d.fragmentCode});o=this._compiledShaders[r]=[f,m]}const l=this._device.createRenderPipeline({label:`BabylonWebGPUDevice${this._engine.uniqueId}_InternalPipeline_${e}_${r}`,layout:"auto",vertex:{module:o[0],entryPoint:"main"},fragment:{module:o[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:"triangle-strip",stripIndexFormat:"uint16"}});n=this._pipelines[e][r]=[l,l.getBindGroupLayout(0)]}return n}_getVideoPipeline(e,t=so.DontInvertY){const i=t===so.InvertY?1:0;this._videoPipelines[e]||(this._videoPipelines[e]=[]);let r=this._videoPipelines[e][i];if(!r){let n=this._videoCompiledShaders[i];if(!n){const o=this._device.createShaderModule({code:Tw,label:`BabylonWebGPUDevice${this._engine.uniqueId}_CopyVideoToTexture_VertexShader`}),l=this._device.createShaderModule({code:i===0?bw:Cw,label:`BabylonWebGPUDevice${this._engine.uniqueId}_CopyVideoToTexture_FragmentShader_${i===0?"DontInvertY":"InvertY"}`});n=this._videoCompiledShaders[i]=[o,l]}const a=this._device.createRenderPipeline({label:`BabylonWebGPUDevice${this._engine.uniqueId}_InternalVideoPipeline_${e}_${i===0?"DontInvertY":"InvertY"}`,layout:"auto",vertex:{module:n[0],entryPoint:"main"},fragment:{module:n[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:"triangle-strip",stripIndexFormat:"uint16"}});r=this._videoPipelines[e][i]=[a,a.getBindGroupLayout(0)]}return r}setCommandEncoder(e){this._commandEncoderForCreation=e}copyVideoToTexture(e,t,i,r=!1,n){var m,g;const a=n===void 0,[o,l]=this._getVideoPipeline(i,r?so.InvertY:so.DontInvertY);a&&(n=this._device.createCommandEncoder({})),(m=n.pushDebugGroup)==null||m.call(n,`copy video to texture - invertY=${r}`);const c=t._hardwareTexture,u={label:`BabylonWebGPUDevice${this._engine.uniqueId}_copyVideoToTexture_${i}_${r?"InvertY":"DontInvertY"}${t.label?"_"+t.label:""}`,colorAttachments:[{view:c.underlyingResource.createView({format:i,dimension:"2d",mipLevelCount:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:1,aspect:"all"}),loadOp:"load",storeOp:"store"}]},h=n.beginRenderPass(u),d={layout:l,entries:[{binding:0,resource:this._videoSampler},{binding:1,resource:this._device.importExternalTexture({source:e.underlyingResource})}]},f=this._device.createBindGroup(d);h.setPipeline(o),h.setBindGroup(0,f),h.draw(4,1,0,0),h.end(),(g=n.popDebugGroup)==null||g.call(n),a&&(this._device.queue.submit([n.finish()]),n=null)}invertYPreMultiplyAlpha(e,t,i,r,n=!1,a=!1,o=0,l=0,c=1,u=0,h=0,d=0,f=0,m,g){var B,Q;const v=d!==0,E=m===void 0,[T,C]=this._getPipeline(r,v?ns.InvertYPremultiplyAlphaWithOfst:ns.InvertYPremultiplyAlpha,{invertY:n,premultiplyAlpha:a});o=Math.max(o,0),E&&(m=this._device.createCommandEncoder({})),(B=m.pushDebugGroup)==null||B.call(m,`internal process texture - invertY=${n} premultiplyAlpha=${a}`);let A;if(Qe.IsHardwareTexture(e)?(A=e.underlyingResource,n&&!a&&c===1&&o===0||(e=void 0)):(A=e,e=void 0),!A)return;v&&this._bufferManager.setRawData(this._ubCopyWithOfst,0,new Float32Array([u,h,d,f]),0,4*4);const I=e,F=(I==null?void 0:I._copyInvertYTempTexture)??this.createTexture({width:t,height:i,layers:1},!1,!1,!1,!1,!1,r,1,m,21,void 0,"TempTextureForCopyWithInvertY"),V=(I==null?void 0:I._copyInvertYRenderPassDescr)??{label:`BabylonWebGPUDevice${this._engine.uniqueId}_invertYPreMultiplyAlpha_${r}_${n?"InvertY":"DontInvertY"}_${a?"PremultiplyAlpha":"DontPremultiplyAlpha"}`,colorAttachments:[{view:F.createView({format:r,dimension:"2d",baseMipLevel:0,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:0}),loadOp:"load",storeOp:"store"}]},D=m.beginRenderPass(V);let w=v?I==null?void 0:I._copyInvertYBindGroupWithOfst:I==null?void 0:I._copyInvertYBindGroup;if(!w){const J={layout:C,entries:[{binding:0,resource:A.createView({format:r,dimension:"2d",baseMipLevel:l,mipLevelCount:1,arrayLayerCount:c,baseArrayLayer:o})}]};v&&J.entries.push({binding:1,resource:{buffer:this._ubCopyWithOfst}}),w=this._device.createBindGroup(J)}D.setPipeline(T),D.setBindGroup(0,w),D.draw(4,1,0,0),D.end(),m.copyTextureToTexture({texture:F},{texture:A,mipLevel:l,origin:{x:0,y:0,z:o}},{width:d||t,height:f||i,depthOrArrayLayers:1}),I?(I._copyInvertYTempTexture=F,I._copyInvertYRenderPassDescr=V,v?I._copyInvertYBindGroupWithOfst=w:I._copyInvertYBindGroup=w):this._deferredReleaseTextures.push([F,null]),(Q=m.popDebugGroup)==null||Q.call(m),E&&(this._device.queue.submit([m.finish()]),m=null)}createTexture(e,t=!1,i=!1,r=!1,n=!1,a=!1,o="rgba8unorm",l=1,c,u=-1,h=0,d){l=Qe.GetSample(l);const f=e.layers||1,m={width:e.width,height:e.height,depthOrArrayLayers:f},g=Ps[o]?16:0,v=Qe.IsCompressedFormat(o),E=t?Qe.ComputeNumMipmapLevels(e.width,e.height):1,T=u>=0?u:7;h|=t&&!v?1|g:0,!v&&!a&&(h|=g|2);const C=this._device.createTexture({label:`BabylonWebGPUDevice${this._engine.uniqueId}_Texture${a?"3D":"2D"}_${d?d+"_":""}${m.width}x${m.height}x${m.depthOrArrayLayers}_${t?"wmips":"womips"}_${o}_samples${l}`,size:m,dimension:a?"3d":"2d",format:o,usage:T|h,sampleCount:l,mipLevelCount:E});return Qe.IsImageBitmap(e)&&(this.updateTexture(e,C,e.width,e.height,f,o,0,0,r,n,0,0),t&&i&&this.generateMipmaps(C,o,E,0,a,c)),C}createCubeTexture(e,t=!1,i=!1,r=!1,n=!1,a="rgba8unorm",o=1,l,c=-1,u=0,h){o=Qe.GetSample(o);const d=Qe.IsImageBitmapArray(e)?e[0].width:e.width,f=Qe.IsImageBitmapArray(e)?e[0].height:e.height,m=Ps[a]?16:0,g=Qe.IsCompressedFormat(a),v=t?Qe.ComputeNumMipmapLevels(d,f):1,E=c>=0?c:7;u|=t&&!g?1|m:0,g||(u|=m|2);const T=this._device.createTexture({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureCube_${h?h+"_":""}${d}x${f}x6_${t?"wmips":"womips"}_${a}_samples${o}`,size:{width:d,height:f,depthOrArrayLayers:6},dimension:"2d",format:a,usage:E|u,sampleCount:o,mipLevelCount:v});return Qe.IsImageBitmapArray(e)&&(this.updateCubeTextures(e,T,d,f,a,r,n,0,0),t&&i&&this.generateCubeMipmaps(T,a,v,l)),T}generateCubeMipmaps(e,t,i,r){var a,o;const n=r===void 0;n&&(r=this._device.createCommandEncoder({})),(a=r.pushDebugGroup)==null||a.call(r,`create cube mipmaps - ${i} levels`);for(let l=0;l<6;++l)this.generateMipmaps(e,t,i,l,!1,r);(o=r.popDebugGroup)==null||o.call(r),n&&(this._device.queue.submit([r.finish()]),r=null)}generateMipmaps(e,t,i,r=0,n=!1,a){var d,f,m,g;const o=a===void 0,[l,c]=this._getPipeline(t);r=Math.max(r,0),o&&(a=this._device.createCommandEncoder({})),(d=a.pushDebugGroup)==null||d.call(a,`create mipmaps for face #${r} - ${i} levels`);let u;if(Qe.IsHardwareTexture(e)?(u=e.underlyingResource,e._mipmapGenRenderPassDescr=e._mipmapGenRenderPassDescr||[],e._mipmapGenBindGroup=e._mipmapGenBindGroup||[]):(u=e,e=void 0),!u)return;const h=e;for(let v=1;v<i;++v){const E=((f=h==null?void 0:h._mipmapGenRenderPassDescr[r])==null?void 0:f[v-1])??{label:`BabylonWebGPUDevice${this._engine.uniqueId}_generateMipmaps_${t}_faceIndex${r}_level${v}`,colorAttachments:[{view:u.createView({format:t,dimension:n?"3d":"2d",baseMipLevel:v,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:r}),loadOp:"load",storeOp:"store"}]};h&&(h._mipmapGenRenderPassDescr[r]=h._mipmapGenRenderPassDescr[r]||[],h._mipmapGenRenderPassDescr[r][v-1]=E);const T=a.beginRenderPass(E),C=((m=h==null?void 0:h._mipmapGenBindGroup[r])==null?void 0:m[v-1])??this._device.createBindGroup({layout:c,entries:[{binding:0,resource:u.createView({format:t,dimension:n?"3d":"2d",baseMipLevel:v-1,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:r})},{binding:1,resource:this._mipmapSampler}]});h&&(h._mipmapGenBindGroup[r]=h._mipmapGenBindGroup[r]||[],h._mipmapGenBindGroup[r][v-1]=C),T.setPipeline(l),T.setBindGroup(0,C),T.draw(4,1,0,0),T.end()}(g=a.popDebugGroup)==null||g.call(a),o&&(this._device.queue.submit([a.finish()]),a=null)}createGPUTextureForInternalTexture(e,t,i,r,n,a){e._hardwareTexture||(e._hardwareTexture=new Gc(this._engine)),t===void 0&&(t=e.width),i===void 0&&(i=e.height),r===void 0&&(r=e.depth);const o=e._hardwareTexture,l=((n??0)&1)!==0;o.format=Qe.GetWebGPUTextureFormat(e.type,e.format,e._useSRGBBuffer),o.textureUsages=e._source===5||e.source===6?21:e._source===12?20:-1,o.textureAdditionalUsages=l?8:0;const c=e.generateMipMaps,u=r||1;let h;if(e._maxLodLevel!==null?h=e._maxLodLevel:h=c?Qe.ComputeNumMipmapLevels(t,i):1,e.isCube){const d=this.createCubeTexture({width:t,height:i},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,o.format,1,this._commandEncoderForCreation,o.textureUsages,o.textureAdditionalUsages,e.label);o.set(d);const f=e.is3D?1:u,m=Qe.GetDepthFormatOnly(o.format),g=Qe.HasDepthAndStencilAspects(o.format)?"depth-only":"all",v=e.is2DArray?"cube-array":"cube";o.createView({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureViewCube${e.is2DArray?"_Array"+f:""}_${t}x${i}_${c?"wmips":"womips"}_${m}_${v}_${g}_${e.label??"noname"}`,format:m,dimension:v,mipLevelCount:h,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:6,aspect:g},l)}else{const d=this.createTexture({width:t,height:i,layers:u},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,e.is3D,o.format,1,this._commandEncoderForCreation,o.textureUsages,o.textureAdditionalUsages,e.label);o.set(d);const f=e.is3D?1:u,m=Qe.GetDepthFormatOnly(o.format),g=Qe.HasDepthAndStencilAspects(o.format)?"depth-only":"all",v=e.is2DArray?"2d-array":e.is3D?"3d":"2d";o.createView({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureView${e.is3D?"3D":"2D"}${e.is2DArray?"_Array"+f:""}_${t}x${i}${e.is3D?"x"+u:""}_${c?"wmips":"womips"}_${m}_${v}_${g}_${e.label??"noname"}`,format:m,dimension:v,mipLevelCount:h,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:f,aspect:g},l)}return e.width=e.baseWidth=t,e.height=e.baseHeight=i,e.depth=e.baseDepth=r,a||this.createMSAATexture(e,e.samples),o}createMSAATexture(e,t,i=!0,r=0){const n=e._hardwareTexture;if(i&&(n==null||n.releaseMSAATexture()),!n||(t??1)<=1)return;const a=e.width,o=e.height,l=this.createTexture({width:a,height:o,layers:1},!1,!1,!1,!1,!1,n.format,t,this._commandEncoderForCreation,16,0,e.label?"MSAA_"+e.label:"MSAA");n.setMSAATexture(l,r)}updateCubeTextures(e,t,i,r,n,a=!1,o=!1,l=0,c=0){const u=[0,3,1,4,2,5];for(let h=0;h<u.length;++h){const d=e[u[h]];this.updateTexture(d,t,i,r,1,n,h,0,a,o,l,c)}}updateTexture(e,t,i,r,n,a,o=0,l=0,c=!1,u=!1,h=0,d=0,f){const m=Qe.IsInternalTexture(t)?t._hardwareTexture.underlyingResource:t,g=Qe.GetBlockInformationFromFormat(a),v=Qe.IsInternalTexture(t)?t._hardwareTexture:t,E={texture:m,origin:{x:h,y:d,z:Math.max(o,0)},mipLevel:l,premultipliedAlpha:u},T={width:Math.ceil(i/g.width)*g.width,height:Math.ceil(r/g.height)*g.height,depthOrArrayLayers:n||1};if(e.byteLength!==void 0){e=e;const C=Math.ceil(i/g.width)*g.length;if(Math.ceil(C/256)*256===C){const I=this._device.createCommandEncoder({}),F=this._bufferManager.createRawBuffer(e.byteLength,$e.MapWrite|$e.CopySrc,!0,"TempBufferForUpdateTexture"+(m?"_"+m.label:"")),V=F.getMappedRange();new Uint8Array(V).set(e),F.unmap(),I.copyBufferToTexture({buffer:F,offset:0,bytesPerRow:C,rowsPerImage:r},E,T),this._device.queue.submit([I.finish()]),this._bufferManager.releaseBuffer(F)}else this._device.queue.writeTexture(E,e,{offset:0,bytesPerRow:C,rowsPerImage:r},T);if(c||u)if(Qe.IsInternalTexture(t)){const I=h===0&&d===0&&i===t.width&&r===t.height;this.invertYPreMultiplyAlpha(v,t.width,t.height,a,c,u,o,l,n||1,h,d,I?0:i,I?0:r,void 0,f)}else throw"updateTexture: Can't process the texture data because a GPUTexture was provided instead of an InternalTexture!"}else e=e,this._device.queue.copyExternalImageToTexture({source:e,flipY:c},E,T)}readPixels(e,t,i,r,n,a,o=0,l=0,c=null,u=!1){const h=Qe.GetBlockInformationFromFormat(a),d=Math.ceil(r/h.width)*h.length,f=Math.ceil(d/256)*256,m=f*n,g=this._bufferManager.createRawBuffer(m,$e.MapRead|$e.CopyDst,void 0,"TempBufferForReadPixels"+(e.label?"_"+e.label:"")),v=this._device.createCommandEncoder({});return v.copyTextureToBuffer({texture:e,mipLevel:l,origin:{x:t,y:i,z:Math.max(o,0)}},{buffer:g,offset:0,bytesPerRow:f},{width:r,height:n,depthOrArrayLayers:1}),this._device.queue.submit([v.finish()]),this._bufferManager.readDataFromBuffer(g,m,r,n,d,f,Qe.GetTextureTypeFromFormat(a),0,c,!0,u)}releaseTexture(e){if(Qe.IsInternalTexture(e)){const t=e._hardwareTexture,i=e._irradianceTexture;this._deferredReleaseTextures.push([t,i])}else this._deferredReleaseTextures.push([e,null])}destroyDeferredTextures(){for(let e=0;e<this._deferredReleaseTextures.length;++e){const[t,i]=this._deferredReleaseTextures[e];t&&(Qe.IsHardwareTexture(t)?t.release():t.destroy()),i==null||i.dispose()}this._deferredReleaseTextures.length=0}}class Iw extends sI{set buffer(e){this._buffer=e}constructor(e,t=0){super(),this.engineId=-1,this.capacity=t,e&&(this._buffer=e)}get underlyingResource(){return this._buffer}}class eu{static _IsGPUBuffer(e){return e.underlyingResource===void 0}static _FlagsToString(e,t=""){let i=t;for(let r=0;r<=9;++r)e&1<<r&&(i&&(i+="_"),i+=$e[1<<r]);return i}constructor(e,t){this._deferredReleaseBuffers=[],this._engine=e,this._device=t}createRawBuffer(e,t,i=!1,r){const n=e.byteLength!==void 0?e.byteLength+3&-4:e+3&-4,a={label:"BabylonWebGPUDevice"+this._engine.uniqueId+"_"+eu._FlagsToString(t,r??"Buffer")+"_size"+n,mappedAtCreation:i,size:n,usage:t};return this._device.createBuffer(a)}createBuffer(e,t,i){const r=e.byteLength!==void 0,n=new Iw,a="DataBufferUniqueId="+n.uniqueId;return n.buffer=this.createRawBuffer(e,t,void 0,i?a+"-"+i:a),n.references=1,n.capacity=r?e.byteLength:e,n.engineId=this._engine.uniqueId,r&&this.setSubData(n,0,e),n}setRawData(e,t,i,r,n){r+=i.byteOffset,this._device.queue.writeBuffer(e,t,i.buffer,r,n)}setSubData(e,t,i,r=0,n=0){const a=e.underlyingResource;n=n||i.byteLength-r;const o=t&3;r-=o,t-=o;const l=n;if(n=n+o+3&-4,i.buffer.byteLength-i.byteOffset<n){const u=new Uint8Array(n);u.set(new Uint8Array(i.buffer,i.byteOffset+r,l)),i=u,r=0}this.setRawData(a,t,i,r,n)}_getHalfFloatAsFloatRGBAArrayBuffer(e,t,i){i?e=Math.min(e,i.length):i=new Float32Array(e);const r=new Uint16Array(t);for(;e--;)i[e]=uM(r[e]);return i}readDataFromBuffer(e,t,i,r,n,a,o=0,l=0,c=null,u=!0,h=!1){const d=o===1?2:o===2?1:0,f=this._engine.uniqueId;return new Promise((m,g)=>{e.mapAsync(1,l,t).then(()=>{const v=e.getMappedRange(l,t);let E=c;if(h)E===null?E=fg(o,t,!0,v):E=fg(o,E.buffer,void 0,v);else if(E===null)switch(d){case 0:E=new Uint8Array(t),E.set(new Uint8Array(v));break;case 1:E=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,v);break;case 2:E=new Float32Array(t/4),E.set(new Float32Array(v));break}else switch(d){case 0:E=new Uint8Array(E.buffer),E.set(new Uint8Array(v,0,Math.min(E.byteLength,t)));break;case 1:E=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,v,c);break;case 2:E=new Float32Array(E.buffer),E.set(new Float32Array(v,0,E.byteLength/4));break}if(n!==a){d===1&&!h&&(n*=2,a*=2);const T=new Uint8Array(E.buffer);let C=n,A=0;for(let I=1;I<r;++I){A=I*a;for(let F=0;F<n;++F)T[C++]=T[A++]}d!==0&&!h?E=new Float32Array(T.buffer,0,C/4):E=new Uint8Array(T.buffer,0,C)}e.unmap(),u&&this.releaseBuffer(e),m(E)},v=>{this._engine.isDisposed||this._engine.uniqueId!==f?m(new Uint8Array):g(v)})})}releaseBuffer(e){return eu._IsGPUBuffer(e)?(this._deferredReleaseBuffers.push(e),!0):(e.references--,e.references===0?(this._deferredReleaseBuffers.push(e.underlyingResource),!0):!1)}destroyDeferredBuffers(){for(let e=0;e<this._deferredReleaseBuffers.length;++e)this._deferredReleaseBuffers[e].destroy();this._deferredReleaseBuffers.length=0}}const Rw=[0,0,3,7,0,2,6,2,4,1,5,3,1],Aw=[0,64,32,96,16,80,48,112,8],Pw=[0,128,128,0,0,0,0,128,0,0,0,0,128];class fa{constructor(e){this._samplers={},this._device=e,this.disabled=!1}static GetSamplerHashCode(e){const t=e._cachedAnisotropicFilteringLevel?e._cachedAnisotropicFilteringLevel:1;return Rw[e.samplingMode]+Aw[(e._comparisonFunction||514)-512+1]+Pw[e.samplingMode]+((e._cachedWrapU??1)<<8)+((e._cachedWrapV??1)<<10)+((e._cachedWrapR??1)<<12)+((e.useMipMaps?1:0)<<14)+(t<<15)}static _GetSamplerFilterDescriptor(e,t){let i,r,n,a,o;const l=e.useMipMaps;switch(e.samplingMode){case 11:i="linear",r="linear",n="nearest",l||(a=o=0);break;case 3:case 3:i="linear",r="linear",l?n="linear":(n="nearest",a=o=0);break;case 8:i="nearest",r="nearest",l?n="linear":(n="nearest",a=o=0);break;case 4:i="nearest",r="nearest",n="nearest",l||(a=o=0);break;case 5:i="nearest",r="linear",n="nearest",l||(a=o=0);break;case 6:i="nearest",r="linear",l?n="linear":(n="nearest",a=o=0);break;case 7:i="nearest",r="linear",n="nearest",a=o=0;break;case 1:case 1:i="nearest",r="nearest",n="nearest",a=o=0;break;case 9:i="linear",r="nearest",n="nearest",l||(a=o=0);break;case 10:i="linear",r="nearest",l?n="linear":(n="nearest",a=o=0);break;case 2:case 2:i="linear",r="linear",t>1?n="linear":(n="nearest",a=o=0);break;case 12:i="linear",r="nearest",n="nearest",a=o=0;break;default:i="nearest",r="nearest",n="nearest",a=o=0;break}return t>1&&(a!==0||o!==0)?{magFilter:"linear",minFilter:"linear",mipmapFilter:"linear",anisotropyEnabled:!0}:{magFilter:i,minFilter:r,mipmapFilter:n,lodMinClamp:a,lodMaxClamp:o}}static _GetWrappingMode(e){switch(e){case 1:return"repeat";case 0:return"clamp-to-edge";case 2:return"mirror-repeat"}return"repeat"}static _GetSamplerWrappingDescriptor(e){return{addressModeU:this._GetWrappingMode(e._cachedWrapU),addressModeV:this._GetWrappingMode(e._cachedWrapV),addressModeW:this._GetWrappingMode(e._cachedWrapR)}}static _GetSamplerDescriptor(e,t){let i=(e.useMipMaps||e.samplingMode===2)&&e._cachedAnisotropicFilteringLevel?e._cachedAnisotropicFilteringLevel:1;e.samplingMode!==11&&e.samplingMode!==3&&e.samplingMode!==2&&(i=1);const r=this._GetSamplerFilterDescriptor(e,i);return{label:t,...r,...this._GetSamplerWrappingDescriptor(e),compare:e._comparisonFunction?fa.GetCompareFunction(e._comparisonFunction):void 0,maxAnisotropy:r.anisotropyEnabled?i:1}}static GetCompareFunction(e){switch(e){case 519:return"always";case 514:return"equal";case 516:return"greater";case 518:return"greater-equal";case 513:return"less";case 515:return"less-equal";case 512:return"never";case 517:return"not-equal";default:return"less"}}getSampler(e,t=!1,i=0,r){if(this.disabled)return this._device.createSampler(fa._GetSamplerDescriptor(e,r));t?i=0:i===0&&(i=fa.GetSamplerHashCode(e));let n=t?void 0:this._samplers[i];return n||(n=this._device.createSampler(fa._GetSamplerDescriptor(e,r)),t||(this._samplers[i]=n)),n}}var Ut;(function(s){s[s.StencilReadMask=0]="StencilReadMask",s[s.StencilWriteMask=1]="StencilWriteMask",s[s.DepthBias=2]="DepthBias",s[s.DepthBiasSlopeScale=3]="DepthBiasSlopeScale",s[s.DepthStencilState=4]="DepthStencilState",s[s.MRTAttachments=5]="MRTAttachments",s[s.RasterizationState=6]="RasterizationState",s[s.ColorStates1=7]="ColorStates1",s[s.ColorStates2=8]="ColorStates2",s[s.ColorStates3=9]="ColorStates3",s[s.ColorStates4=10]="ColorStates4",s[s.ShaderStage=11]="ShaderStage",s[s.TextureStage=12]="TextureStage",s[s.VertexState=13]="VertexState",s[s.NumStates=14]="NumStates"})(Ut||(Ut={}));const Ic={0:1,1:2,768:3,769:4,770:5,771:6,772:7,773:8,774:9,775:10,776:11,32769:12,32770:13,32771:14,32772:15,35065:16,35066:17,34185:18,35067:19},KS={32774:0,32775:1,32776:2,32778:3,32779:4},$r={0:0,7680:1,7681:2,7682:3,7683:4,5386:5,34055:6,34056:7},ra=[0,0,0,0];class lt{constructor(e,t){this.mrtTextureCount=0,this._device=e,this._useTextureStage=!0,this._states=new Array(30),this._statesLength=0,this._stateDirtyLowestIndex=0,this._emptyVertexBuffer=t,this._mrtFormats=[],this._parameter={token:void 0,pipeline:null},this.disabled=!1,this.vertexBuffers=[],this._kMaxVertexBufferStride=e.limits.maxVertexBufferArrayStride||2048,this.reset()}reset(){this._isDirty=!0,this.vertexBuffers.length=0,this.setAlphaToCoverage(!1),this.resetDepthCullingState(),this.setClampDepth(!1),this.setDepthBias(0),this._webgpuColorFormat=["bgra8unorm"],this.setColorFormat("bgra8unorm"),this.setMRT([]),this.setAlphaBlendEnabled([!1],1),this.setAlphaBlendFactors([null,null,null,null],[null,null]),this.setWriteMask(15),this.setDepthStencilFormat("depth24plus-stencil8"),this.setStencilEnabled(!1),this.resetStencilState(),this.setBuffers(null,null,null),this._setTextureState(0)}get colorFormats(){return this._mrtAttachments>0?this._mrtFormats:this._webgpuColorFormat}getRenderPipeline(e,t,i,r=0){if(i=Qe.GetSample(i),this.disabled){const a=lt._GetTopology(e);return this._setVertexState(t),this._setTextureState(r),this._parameter.pipeline=this._createRenderPipeline(t,a,i),lt.NumCacheMiss++,lt._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}if(this._setShaderStage(t.uniqueId),this._setRasterizationState(e,i),this._setColorStates(),this._setDepthStencilState(),this._setVertexState(t),this._setTextureState(r),this.lastStateDirtyLowestIndex=this._stateDirtyLowestIndex,!this._isDirty&&this._parameter.pipeline)return this._stateDirtyLowestIndex=this._statesLength,lt.NumCacheHitWithoutHash++,this._parameter.pipeline;if(this._getRenderPipeline(this._parameter),this._isDirty=!1,this._stateDirtyLowestIndex=this._statesLength,this._parameter.pipeline)return lt.NumCacheHitWithHash++,this._parameter.pipeline;const n=lt._GetTopology(e);return this._parameter.pipeline=this._createRenderPipeline(t,n,i),this._setRenderPipeline(this._parameter),lt.NumCacheMiss++,lt._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}endFrame(){lt.NumPipelineCreationLastFrame=lt._NumPipelineCreationCurrentFrame,lt._NumPipelineCreationCurrentFrame=0}setAlphaToCoverage(e){this._alphaToCoverageEnabled=e}setFrontFace(e){this._frontFace=e}setCullEnabled(e){this._cullEnabled=e}setCullFace(e){this._cullFace=e}setClampDepth(e){this._clampDepth=e}resetDepthCullingState(){this.setDepthCullingState(!1,2,1,0,0,!0,!0,519)}setDepthCullingState(e,t,i,r,n,a,o,l){this._depthWriteEnabled=o,this._depthTestEnabled=a,this._depthCompare=(l??519)-512,this._cullFace=i,this._cullEnabled=e,this._frontFace=t,this.setDepthBiasSlopeScale(r),this.setDepthBias(n)}setDepthBias(e){this._depthBias!==e&&(this._depthBias=e,this._states[Ut.DepthBias]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ut.DepthBias))}setDepthBiasSlopeScale(e){this._depthBiasSlopeScale!==e&&(this._depthBiasSlopeScale=e,this._states[Ut.DepthBiasSlopeScale]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ut.DepthBiasSlopeScale))}setColorFormat(e){this._webgpuColorFormat[0]=e,this._colorFormat=Ps[e??""]}setMRTAttachments(e){this.mrtAttachments=e;let t=0;for(let i=0;i<e.length;++i)e[i]!==0&&(t+=1<<i);this._mrtEnabledMask!==t&&(this._mrtEnabledMask=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ut.MRTAttachments))}setMRT(e,t){if(t=t??e.length,t>8)throw new Error("Can't handle more than 8 attachments for a MRT in cache render pipeline!");this.mrtTextureArray=e,this.mrtTextureCount=t,this._mrtEnabledMask=65535;let i=0,r=0;for(let n=0;n<t;++n){const a=e[n],o=a==null?void 0:a._hardwareTexture;this._mrtFormats[n]=(o==null?void 0:o.format)??this._webgpuColorFormat[0],i+=Ps[this._mrtFormats[n]??""]*2**r,r+=6}this._mrtFormats.length=t,this._mrtAttachments!==i&&(this._mrtAttachments=i,this._states[Ut.MRTAttachments]=i,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ut.MRTAttachments))}setAlphaBlendEnabled(e,t){this._alphaBlendEnabled=e,this._numAlphaBlendTargetsEnabled=t}setAlphaBlendFactors(e,t){this._alphaBlendFuncParams=e,this._alphaBlendEqParams=t}setWriteMask(e){this._writeMask=e}setDepthStencilFormat(e){this._webgpuDepthStencilFormat=e,this._depthStencilFormat=e===void 0?0:Ps[e]}setDepthTestEnabled(e){this._depthTestEnabled=e}setDepthWriteEnabled(e){this._depthWriteEnabled=e}setDepthCompare(e){this._depthCompare=(e??519)-512}setStencilEnabled(e){this._stencilEnabled=e}setStencilCompare(e){this._stencilFrontCompare=(e??519)-512}setStencilDepthFailOp(e){this._stencilFrontDepthFailOp=e===null?1:$r[e]}setStencilPassOp(e){this._stencilFrontPassOp=e===null?2:$r[e]}setStencilFailOp(e){this._stencilFrontFailOp=e===null?1:$r[e]}setStencilBackCompare(e){this._stencilBackCompare=(e??519)-512}setStencilBackDepthFailOp(e){this._stencilBackDepthFailOp=e===null?1:$r[e]}setStencilBackPassOp(e){this._stencilBackPassOp=e===null?2:$r[e]}setStencilBackFailOp(e){this._stencilBackFailOp=e===null?1:$r[e]}setStencilReadMask(e){this._stencilReadMask!==e&&(this._stencilReadMask=e,this._states[Ut.StencilReadMask]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ut.StencilReadMask))}setStencilWriteMask(e){this._stencilWriteMask!==e&&(this._stencilWriteMask=e,this._states[Ut.StencilWriteMask]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ut.StencilWriteMask))}resetStencilState(){this.setStencilState(!1,519,7680,7681,7680,255,255)}setStencilState(e,t,i,r,n,a,o,l=null,c=null,u=null,h=null){this._stencilEnabled=e,this._stencilFrontCompare=(t??519)-512,this._stencilFrontDepthFailOp=i===null?1:$r[i],this._stencilFrontPassOp=r===null?2:$r[r],this._stencilFrontFailOp=n===null?1:$r[n],this._stencilBackCompare=(l??519)-512,this._stencilBackDepthFailOp=c===null?1:$r[c],this._stencilBackPassOp=u===null?2:$r[u],this._stencilBackFailOp=h===null?1:$r[h],this.setStencilReadMask(a),this.setStencilWriteMask(o)}setBuffers(e,t,i){this._vertexBuffers=e,this._overrideVertexBuffers=i,this.indexBuffer=t}static _GetTopology(e){switch(e){case 0:return"triangle-list";case 2:return"point-list";case 1:return"line-list";case 3:return"point-list";case 4:return"line-list";case 5:throw"LineLoop is an unsupported fillmode in WebGPU";case 6:return"line-strip";case 7:return"triangle-strip";case 8:throw"TriangleFan is an unsupported fillmode in WebGPU";default:return"triangle-list"}}static _GetAphaBlendOperation(e){switch(e){case 32774:return"add";case 32778:return"subtract";case 32779:return"reverse-subtract";case 32775:return"min";case 32776:return"max";default:return"add"}}static _GetAphaBlendFactor(e){switch(e){case 0:return"zero";case 1:return"one";case 768:return"src";case 769:return"one-minus-src";case 770:return"src-alpha";case 771:return"one-minus-src-alpha";case 772:return"dst-alpha";case 773:return"one-minus-dst-alpha";case 774:return"dst";case 775:return"one-minus-dst";case 776:return"src-alpha-saturated";case 32769:case 32771:return"constant";case 32770:case 32772:return"one-minus-constant";case 35065:return"src1";case 35066:return"one-minus-src1";case 34185:return"src1-alpha";case 35067:return"one-minus-src1-alpha";default:return"one"}}static _GetCompareFunction(e){switch(e){case 0:return"never";case 1:return"less";case 2:return"equal";case 3:return"less-equal";case 4:return"greater";case 5:return"not-equal";case 6:return"greater-equal";case 7:return"always"}return"never"}static _GetStencilOpFunction(e){switch(e){case 0:return"zero";case 1:return"keep";case 2:return"replace";case 3:return"increment-clamp";case 4:return"decrement-clamp";case 5:return"invert";case 6:return"increment-wrap";case 7:return"decrement-wrap"}return"keep"}static _GetVertexInputDescriptorFormat(e){const t=e.type,i=e.normalized,r=e.getSize();switch(t){case M.BYTE:switch(r){case 1:case 2:return i?"snorm8x2":"sint8x2";case 3:case 4:return i?"snorm8x4":"sint8x4"}break;case M.UNSIGNED_BYTE:switch(r){case 1:case 2:return i?"unorm8x2":"uint8x2";case 3:case 4:return i?"unorm8x4":"uint8x4"}break;case M.SHORT:switch(r){case 1:case 2:return i?"snorm16x2":"sint16x2";case 3:case 4:return i?"snorm16x4":"sint16x4"}break;case M.UNSIGNED_SHORT:switch(r){case 1:case 2:return i?"unorm16x2":"uint16x2";case 3:case 4:return i?"unorm16x4":"uint16x4"}break;case M.INT:switch(r){case 1:return"sint32";case 2:return"sint32x2";case 3:return"sint32x3";case 4:return"sint32x4"}break;case M.UNSIGNED_INT:switch(r){case 1:return"uint32";case 2:return"uint32x2";case 3:return"uint32x3";case 4:return"uint32x4"}break;case M.FLOAT:switch(r){case 1:return"float32";case 2:return"float32x2";case 3:return"float32x3";case 4:return"float32x4"}break}throw new Error(`Invalid Format '${e.getKind()}' - type=${t}, normalized=${i}, size=${r}`)}_getAphaBlendState(e){return this._alphaBlendEnabled[e]?{srcFactor:lt._GetAphaBlendFactor(this._alphaBlendFuncParams[e*4+2]),dstFactor:lt._GetAphaBlendFactor(this._alphaBlendFuncParams[e*4+3]),operation:lt._GetAphaBlendOperation(this._alphaBlendEqParams[e*2+1])}:null}_getColorBlendState(e){return this._alphaBlendEnabled?{srcFactor:lt._GetAphaBlendFactor(this._alphaBlendFuncParams[e*4+0]),dstFactor:lt._GetAphaBlendFactor(this._alphaBlendFuncParams[e*4+1]),operation:lt._GetAphaBlendOperation(this._alphaBlendEqParams[e*2+0])}:null}_setShaderStage(e){this._shaderId!==e&&(this._shaderId=e,this._states[Ut.ShaderStage]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ut.ShaderStage))}_setRasterizationState(e,t){const i=this._frontFace,r=this._cullEnabled?this._cullFace:0,n=this._clampDepth?1:0,a=this._alphaToCoverageEnabled?1:0,o=i-1+(r<<1)+(n<<3)+(a<<4)+(e<<5)+(t<<8);this._rasterizationState!==o&&(this._rasterizationState=o,this._states[Ut.RasterizationState]=this._rasterizationState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ut.RasterizationState))}_setColorStates(){ra[0]=(this._writeMask?1:0)*2**53,ra[1]=(this._depthWriteEnabled?1:0)*2**53,ra[2]=(this._colorFormat&7)*2**50,ra[3]=(this._colorFormat&56)*2**47;let e=0,t=!1;for(let i=0;i<8;i++){if(this._alphaBlendEnabled[i]){const r=i*4+0,n=i*4+1,a=i*4+2,o=i*4+3,l=i*2+0,c=i*2+1,u=this._alphaBlendEqParams[l]===null?0:KS[this._alphaBlendEqParams[l]],h=this._alphaBlendEqParams[c]===null?0:KS[this._alphaBlendEqParams[c]];ra[e]+=((this._alphaBlendFuncParams[r]===null?1:Ic[this._alphaBlendFuncParams[r]])<<0)+((this._alphaBlendFuncParams[n]===null?1:Ic[this._alphaBlendFuncParams[n]])<<5)+((this._alphaBlendFuncParams[a]===null?1:Ic[this._alphaBlendFuncParams[a]])<<10)+((this._alphaBlendFuncParams[o]===null?1:Ic[this._alphaBlendFuncParams[o]])<<15)+(u+h*5)*(1<<20)}i&1&&(t=t||this._states[Ut.ColorStates1+e]!==ra[e],this._states[Ut.ColorStates1+e]=ra[e],e++)}t&&(this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ut.ColorStates1))}_setDepthStencilState(){const e=this._stencilEnabled?this._stencilFrontCompare+(this._stencilFrontDepthFailOp<<3)+(this._stencilFrontPassOp<<6)+(this._stencilFrontFailOp<<9)+(this._stencilBackCompare<<12)+(this._stencilBackDepthFailOp<<15)+(this._stencilBackPassOp<<18)+(this._stencilBackFailOp<<21):2421327,t=this._depthStencilFormat+((this._depthTestEnabled?this._depthCompare:7)<<6)+e*1024;this._depthStencilState!==t&&(this._depthStencilState=t,this._states[Ut.DepthStencilState]=this._depthStencilState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ut.DepthStencilState))}_setVertexState(e){var c;const t=this._statesLength;let i=Ut.VertexState;const r=e._pipelineContext,n=r.shaderProcessingContext.attributeNamesFromEffect,a=r.shaderProcessingContext.attributeLocationsFromEffect;let o,l=0;for(let u=0;u<n.length;u++){const h=a[u];let d=(this._overrideVertexBuffers&&this._overrideVertexBuffers[n[u]])??this._vertexBuffers[n[u]];d||(d=this._emptyVertexBuffer,lt.LogErrorIfNoVertexBuffer&&N.Error(`No vertex buffer is provided for the "${n[u]}" attribute. A default empty vertex buffer will be used, but this may generate errors in some browsers.`));const f=(c=d.effectiveBuffer)==null?void 0:c.underlyingResource;if(d._validOffsetRange===void 0){const g=d.effectiveByteOffset,v=d.getSize(!0),E=d.effectiveByteStride;d._validOffsetRange=g+v<=this._kMaxVertexBufferStride&&E===0||E!==0&&g+v<=E}o&&o===f&&d._validOffsetRange||(this.vertexBuffers[l++]=d,o=d._validOffsetRange?f:null);const m=d.hashCode+(h<<7);this._isDirty=this._isDirty||this._states[i]!==m,this._states[i++]=m}this.vertexBuffers.length=l,this._statesLength=i,this._isDirty=this._isDirty||i!==t,this._isDirty&&(this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ut.VertexState))}_setTextureState(e){this._textureState!==e&&(this._textureState=e,this._states[Ut.TextureStage]=this._textureState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ut.TextureStage))}_createPipelineLayout(e){if(this._useTextureStage)return this._createPipelineLayoutWithTextureStage(e);const t=[],i=e.shaderProcessingContext.bindGroupLayoutEntries;for(let r=0;r<i.length;r++){const n=i[r];t[r]=this._device.createBindGroupLayout({entries:n})}return e.bindGroupLayouts[0]=t,this._device.createPipelineLayout({bindGroupLayouts:t})}_createPipelineLayoutWithTextureStage(e){const t=e.shaderProcessingContext,i=t.bindGroupLayoutEntries;let r=1;for(let a=0;a<i.length;a++){const o=i[a];for(let l=0;l<o.length;l++){const c=i[a][l];if(c.texture){const u=t.bindGroupLayoutEntryInfo[a][c.binding].name,h=t.availableTextures[u],d=h.autoBindSampler?t.availableSamplers[u+"Sampler"]:null;let f=h.sampleType,m=(d==null?void 0:d.type)??"filtering";if(this._textureState&r&&f!=="depth"&&(h.autoBindSampler&&(m="non-filtering"),f="unfilterable-float"),c.texture.sampleType=f,d){const g=t.bindGroupLayoutEntryInfo[d.binding.groupIndex][d.binding.bindingIndex].index;i[d.binding.groupIndex][g].sampler.type=m}r=r<<1}}}const n=[];for(let a=0;a<i.length;++a)n[a]=this._device.createBindGroupLayout({entries:i[a]});return e.bindGroupLayouts[this._textureState]=n,this._device.createPipelineLayout({bindGroupLayouts:n})}_getVertexInputDescriptor(e){var l;const t=[],i=e._pipelineContext,r=i.shaderProcessingContext.attributeNamesFromEffect,n=i.shaderProcessingContext.attributeLocationsFromEffect;let a,o;for(let c=0;c<r.length;c++){const u=n[c];let h=(this._overrideVertexBuffers&&this._overrideVertexBuffers[r[c]])??this._vertexBuffers[r[c]];h||(h=this._emptyVertexBuffer);let d=(l=h.effectiveBuffer)==null?void 0:l.underlyingResource,f=h.effectiveByteOffset;const m=!h._validOffsetRange;if(!(a&&o&&a===d)||m){const g={arrayStride:h.effectiveByteStride,stepMode:h.getIsInstanced()?"instance":"vertex",attributes:[]};t.push(g),o=g.attributes,m&&(f=0,d=null)}o.push({shaderLocation:u,offset:f,format:lt._GetVertexInputDescriptorFormat(h)}),a=d}return t}_createRenderPipeline(e,t,i){var f;const r=e._pipelineContext,n=this._getVertexInputDescriptor(e),a=this._createPipelineLayout(r),o=[];if(this._vertexBuffers&&lR(this._vertexBuffers,e),this._mrtAttachments>0)for(let m=0;m<this._mrtFormats.length;++m){const g=this._mrtFormats[m];if(g){const v={format:g,writeMask:this._mrtEnabledMask&1<<m?this._writeMask:0},E=this._getAphaBlendState(m<this._numAlphaBlendTargetsEnabled?m:0),T=this._getColorBlendState(m<this._numAlphaBlendTargetsEnabled?m:0);E&&T&&(v.blend={alpha:E,color:T}),o.push(v)}else o.push(null)}else if(this._webgpuColorFormat[0]){const m={format:this._webgpuColorFormat[0],writeMask:this._writeMask},g=this._getAphaBlendState(0),v=this._getColorBlendState(0);g&&v&&(m.blend={alpha:g,color:v}),o.push(m)}else o.push(null);const l={compare:lt._GetCompareFunction(this._stencilEnabled?this._stencilFrontCompare:7),depthFailOp:lt._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontDepthFailOp:1),failOp:lt._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontFailOp:1),passOp:lt._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontPassOp:1)},c={compare:lt._GetCompareFunction(this._stencilEnabled?this._stencilBackCompare:7),depthFailOp:lt._GetStencilOpFunction(this._stencilEnabled?this._stencilBackDepthFailOp:1),failOp:lt._GetStencilOpFunction(this._stencilEnabled?this._stencilBackFailOp:1),passOp:lt._GetStencilOpFunction(this._stencilEnabled?this._stencilBackPassOp:1)},u=t==="triangle-list"||t==="triangle-strip";let h;(t==="line-strip"||t==="triangle-strip")&&(h=!this.indexBuffer||this.indexBuffer.is32Bits?"uint32":"uint16");const d=this._webgpuDepthStencilFormat?Qe.HasStencilAspect(this._webgpuDepthStencilFormat):!1;return this._device.createRenderPipeline({label:`RenderPipeline_${((f=o[0])==null?void 0:f.format)??"nooutput"}_${this._webgpuDepthStencilFormat??"nodepth"}_samples${i}_textureState${this._textureState}`,layout:a,vertex:{module:r.stages.vertexStage.module,entryPoint:r.stages.vertexStage.entryPoint,buffers:n},primitive:{topology:t,stripIndexFormat:h,frontFace:this._frontFace===1?"ccw":"cw",cullMode:this._cullEnabled?this._cullFace===2?"front":"back":"none"},fragment:r.stages.fragmentStage?{module:r.stages.fragmentStage.module,entryPoint:r.stages.fragmentStage.entryPoint,targets:o}:void 0,multisample:{count:i},depthStencil:this._webgpuDepthStencilFormat===void 0?void 0:{depthWriteEnabled:this._depthWriteEnabled,depthCompare:this._depthTestEnabled?lt._GetCompareFunction(this._depthCompare):"always",format:this._webgpuDepthStencilFormat,stencilFront:this._stencilEnabled&&d?l:void 0,stencilBack:this._stencilEnabled&&d?c:void 0,stencilReadMask:this._stencilEnabled&&d?this._stencilReadMask:void 0,stencilWriteMask:this._stencilEnabled&&d?this._stencilWriteMask:void 0,depthBias:this._depthBias,depthBiasClamp:u?this._depthBiasClamp:0,depthBiasSlopeScale:u?this._depthBiasSlopeScale:0}})}}lt.LogErrorIfNoVertexBuffer=!1;lt.NumCacheHitWithoutHash=0;lt.NumCacheHitWithHash=0;lt.NumCacheMiss=0;lt.NumPipelineCreationLastFrame=0;lt._NumPipelineCreationCurrentFrame=0;class vd{constructor(){this.values={}}count(){let e=0,t=this.pipeline?1:0;for(const i in this.values){const r=this.values[i],[n,a]=r.count();e+=n,t+=a,e++}return[e,t]}}class cs extends lt{static GetNodeCounts(){const e=cs._Cache.count();return{nodeCount:e[0],pipelineCount:e[1]}}static _GetPipelines(e,t,i,r){if(e.pipeline){const n=i.slice();n.length=r,t.push(n)}for(const n in e.values){const a=e.values[n];i[r]=parseInt(n),cs._GetPipelines(a,t,i,r+1)}}static GetPipelines(){const e=[];return cs._GetPipelines(cs._Cache,e,[],0),e}static ResetCache(){cs._Cache=new vd}reset(){this._nodeStack=[],this._nodeStack[0]=cs._Cache,super.reset()}_getRenderPipeline(e){let t=this._nodeStack[this._stateDirtyLowestIndex];for(let i=this._stateDirtyLowestIndex;i<this._statesLength;++i){let r=t.values[this._states[i]];r||(r=new vd,t.values[this._states[i]]=r),t=r,this._nodeStack[i+1]=t}e.token=t,e.pipeline=t.pipeline}_setRenderPipeline(e){e.token.pipeline=e.pipeline}}cs._Cache=new vd;class Ow extends sD{constructor(e){super(!1),this._cache=e,this.reset()}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._cache.setStencilCompare(e))}get backFunc(){return this._backFunc}set backFunc(e){this._backFunc!==e&&(this._backFunc=e,this._cache.setStencilBackCompare(e))}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._cache.setStencilReadMask(e))}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._cache.setStencilFailOp(e))}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._cache.setStencilDepthFailOp(e))}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._cache.setStencilPassOp(e))}get backOpStencilFail(){return this._backOpStencilFail}set backOpStencilFail(e){this._backOpStencilFail!==e&&(this._backOpStencilFail=e,this._cache.setStencilBackFailOp(e))}get backOpDepthFail(){return this._backOpDepthFail}set backOpDepthFail(e){this._backOpDepthFail!==e&&(this._backOpDepthFail=e,this._cache.setStencilBackDepthFailOp(e))}get backOpStencilDepthPass(){return this._backOpStencilDepthPass}set backOpStencilDepthPass(e){this._backOpStencilDepthPass!==e&&(this._backOpStencilDepthPass=e,this._cache.setStencilBackPassOp(e))}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._cache.setStencilWriteMask(e))}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._cache.setStencilEnabled(e))}reset(){super.reset(),this._cache.resetStencilState()}apply(){var t;const e=!this.useStencilGlobalOnly&&!!((t=this.stencilMaterial)!=null&&t.enabled);this.enabled=e?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.enabled&&(this.mask=e?this.stencilMaterial.mask:this.stencilGlobal.mask,this.funcRef=e?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=e?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.func=e?this.stencilMaterial.func:this.stencilGlobal.func,this.opStencilFail=e?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=e?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=e?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.backFunc=e?this.stencilMaterial.backFunc:this.stencilGlobal.backFunc,this.backOpStencilFail=e?this.stencilMaterial.backOpStencilFail:this.stencilGlobal.backOpStencilFail,this.backOpDepthFail=e?this.stencilMaterial.backOpDepthFail:this.stencilGlobal.backOpDepthFail,this.backOpStencilDepthPass=e?this.stencilMaterial.backOpStencilDepthPass:this.stencilGlobal.backOpStencilDepthPass)}}class Nw extends nD{constructor(e){super(!1),this._cache=e,this.reset()}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0,this._cache.setDepthBiasSlopeScale(e))}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0,this._cache.setDepthBias(e))}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0,this._cache.setCullFace(e??1))}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0,this._cache.setCullEnabled(!!e))}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0,this._cache.setDepthCompare(e))}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0,this._cache.setDepthWriteEnabled(e))}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0,this._cache.setDepthTestEnabled(e))}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0,this._cache.setFrontFace(e??2))}reset(){super.reset(),this._cache.resetDepthCullingState()}apply(){}}class hR{static IsExternalTexture(e){return e.underlyingResource!==void 0}getClassName(){return"ExternalTexture"}get underlyingResource(){return this._video}constructor(e){this.useMipMaps=!1,this.type=16,this.format=4294967295,this._video=e,this.uniqueId=$t._Counter++}isReady(){return this._video.readyState>=this._video.HAVE_CURRENT_DATA}dispose(){}}class ih{get forceBindGroupCreation(){return this._numExternalTextures>0}get hasFloatOrDepthTextures(){return this._numFloatOrDepthTextures>0}constructor(){this.useVertexPulling=!1,this.uniqueId=ih._Counter++,this.updateId=0,this.textureState=0,this.reset()}reset(){this.samplers={},this.textures={},this.isDirty=!0,this._numFloatOrDepthTextures=0,this._numExternalTextures=0}setSampler(e,t){let i=this.samplers[e],r=-1;i?r=i.hashCode:this.samplers[e]=i={sampler:t,hashCode:0},i.sampler=t,i.hashCode=t?fa.GetSamplerHashCode(t):0;const n=r!==i.hashCode;n&&this.updateId++,this.isDirty||(this.isDirty=n)}setTexture(e,t){var a;let i=this.textures[e],r=-1;i?r=((a=i.texture)==null?void 0:a.uniqueId)??-1:this.textures[e]=i={texture:t,isFloatOrDepthTexture:!1,isExternalTexture:!1},i.isExternalTexture&&this._numExternalTextures--,i.isFloatOrDepthTexture&&this._numFloatOrDepthTextures--,t?(i.isFloatOrDepthTexture=t.type===1||t.format>=13&&t.format<=18,i.isExternalTexture=hR.IsExternalTexture(t),i.isFloatOrDepthTexture&&this._numFloatOrDepthTextures++,i.isExternalTexture&&this._numExternalTextures++):(i.isFloatOrDepthTexture=!1,i.isExternalTexture=!1),i.texture=t;const n=r!==((t==null?void 0:t.uniqueId)??-1);n&&this.updateId++,this.isDirty||(this.isDirty=n)}}ih._Counter=0;class rh{isDirty(e){return this._isDirty||this._materialContextUpdateId!==e}resetIsDirty(e){this._isDirty=!1,this._materialContextUpdateId=e}get enableIndirectDraw(){return this._enableIndirectDraw}set enableIndirectDraw(e){this._enableIndirectDrawInCompatMode=!0,this._enableIndirectDraw!==e&&(this._enableIndirectDraw=e,!e&&!this._useInstancing&&this.indirectDrawBuffer?(this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0):e&&!this.indirectDrawBuffer&&(this.indirectDrawBuffer=this._bufferManager.createRawBuffer(20,$e.CopyDst|$e.Indirect|$e.Storage,void 0,"IndirectDrawBuffer"),this._indirectDrawData=new Uint32Array(5),this._indirectDrawData[3]=0,this._indirectDrawData[4]=0))}get useInstancing(){return this._useInstancing}set useInstancing(e){if(this._useInstancing===e)return;this._useInstancing=e,this._currentInstanceCount=-1;const t=this._enableIndirectDrawInCompatMode;this.enableIndirectDraw=e,this._enableIndirectDrawInCompatMode=t}constructor(e,t){this._dummyIndexBuffer=t,this._enableIndirectDrawInCompatMode=!1,this._bufferManager=e,this.uniqueId=rh._Counter++,this._useInstancing=!1,this._currentInstanceCount=0,this._enableIndirectDraw=!1,this._vertexPullingEnabled=!1,this.reset()}reset(){this.buffers={},this._isDirty=!0,this._materialContextUpdateId=0,this.fastBundle=void 0,this.bindGroups=void 0,this._vertexPullingEnabled=!1}setBuffer(e,t){var i;this._isDirty||(this._isDirty=(t==null?void 0:t.uniqueId)!==((i=this.buffers[e])==null?void 0:i.uniqueId)),this.buffers[e]=t}setIndirectData(e,t,i,r=!1){!r&&t===this._currentInstanceCount||!this.indirectDrawBuffer||!this._indirectDrawData||(this._currentInstanceCount=t,this._indirectDrawData[0]=e,this._indirectDrawData[1]=t,this._indirectDrawData[2]=i,this._bufferManager.setRawData(this.indirectDrawBuffer,0,this._indirectDrawData,0,20))}setVertexPulling(e,t,i,r,n){if(this._vertexPullingEnabled===e)return;this._vertexPullingEnabled=e,this._isDirty=!0;const a=t.shaderProcessingContext.bufferNames;if(n)for(const o in n){const l=n[o];if(!l||a.indexOf(o)===-1)continue;const c=l.effectiveBuffer;this.setBuffer(o,e?c:null)}for(const o in i){if(n&&o in n)continue;const l=i[o];if(!l||a.indexOf(o)===-1)continue;const c=l.effectiveBuffer;this.setBuffer(o,e?c:null)}a.indexOf("indices")!==-1&&this.setBuffer("indices",e?r??this._dummyIndexBuffer:null)}dispose(){this.indirectDrawBuffer&&(this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this.fastBundle=void 0,this.bindGroups=void 0,this.buffers=void 0,this._enableIndirectDraw=!1}}rh._Counter=0;const Dw=1<<20,Mw=2**35;class dl{constructor(){this.values={}}}class nt{static get Statistics(){return{totalCreated:nt.NumBindGroupsCreatedTotal,lastFrameCreated:nt.NumBindGroupsCreatedLastFrame,lookupLastFrame:nt.NumBindGroupsLookupLastFrame,noLookupLastFrame:nt.NumBindGroupsNoLookupLastFrame}}static ResetCache(){nt._Cache=new dl,nt.NumBindGroupsCreatedTotal=0,nt.NumBindGroupsCreatedLastFrame=0,nt.NumBindGroupsLookupLastFrame=0,nt.NumBindGroupsNoLookupLastFrame=0,nt._NumBindGroupsCreatedCurrentFrame=0,nt._NumBindGroupsLookupCurrentFrame=0,nt._NumBindGroupsNoLookupCurrentFrame=0}constructor(e,t,i){this.disabled=!1,this._device=e,this._cacheSampler=t,this._engine=i}endFrame(){nt.NumBindGroupsCreatedLastFrame=nt._NumBindGroupsCreatedCurrentFrame,nt.NumBindGroupsLookupLastFrame=nt._NumBindGroupsLookupCurrentFrame,nt.NumBindGroupsNoLookupLastFrame=nt._NumBindGroupsNoLookupCurrentFrame,nt._NumBindGroupsCreatedCurrentFrame=0,nt._NumBindGroupsLookupCurrentFrame=0,nt._NumBindGroupsNoLookupCurrentFrame=0}getBindGroups(e,t,i){var l,c,u,h,d,f;let r,n=nt._Cache;const a=this.disabled||i.forceBindGroupCreation;if(!a){if(!t.isDirty(i.updateId)&&!i.isDirty)return nt._NumBindGroupsNoLookupCurrentFrame++,t.bindGroups;for(const m of e.shaderProcessingContext.bufferNames){const g=(((l=t.buffers[m])==null?void 0:l.uniqueId)??0)+Dw;let v=n.values[g];v||(v=new dl,n.values[g]=v),n=v}for(const m of e.shaderProcessingContext.samplerNames){const g=((c=i.samplers[m])==null?void 0:c.hashCode)??0;let v=n.values[g];v||(v=new dl,n.values[g]=v),n=v}for(const m of e.shaderProcessingContext.textureNames){const g=(((h=(u=i.textures[m])==null?void 0:u.texture)==null?void 0:h.uniqueId)??0)+Mw;let v=n.values[g];v||(v=new dl,n.values[g]=v),n=v}r=n.bindGroups}if(t.resetIsDirty(i.updateId),i.isDirty=!1,r)return t.bindGroups=r,nt._NumBindGroupsLookupCurrentFrame++,r;r=[],t.bindGroups=r,a||(n.bindGroups=r),nt.NumBindGroupsCreatedTotal++,nt._NumBindGroupsCreatedCurrentFrame++;const o=e.bindGroupLayouts[i.textureState];for(let m=0;m<e.shaderProcessingContext.bindGroupLayoutEntries.length;m++){const g=e.shaderProcessingContext.bindGroupLayoutEntries[m],v=e.shaderProcessingContext.bindGroupEntries[m];for(let T=0;T<g.length;T++){const C=e.shaderProcessingContext.bindGroupLayoutEntries[m][T],A=e.shaderProcessingContext.bindGroupLayoutEntryInfo[m][C.binding],I=A.nameInArrayOfTexture??A.name;if(C.sampler){const F=i.samplers[I];if(F){const V=F.sampler;if(!V){this._engine.dbgSanityChecks&&N.Error(`Trying to bind a null sampler! entry=${JSON.stringify(C)}, name=${I}, bindingInfo=${JSON.stringify(F,(D,w)=>D==="texture"?"<no dump>":w)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}v[T].resource=this._cacheSampler.getSampler(V,!1,F.hashCode,V.label)}else N.Error(`Sampler "${I}" not found in the material context. Make sure you bound it. entry=${JSON.stringify(C)}, materialContext=${JSON.stringify(i,(V,D)=>V==="texture"||V==="sampler"?"<no dump>":D)}`,50)}else if(C.texture||C.storageTexture){const F=i.textures[I];if(F){if(this._engine.dbgSanityChecks&&F.texture===null){N.Error(`Trying to bind a null texture! name="${I}", entry=${JSON.stringify(C)}, bindingInfo=${JSON.stringify(F,(D,w)=>D==="texture"?"<no dump>":w)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}const V=F.texture._hardwareTexture;if(this._engine.dbgSanityChecks&&(!V||C.texture&&!V.view||C.storageTexture&&!V.viewForWriting)){N.Error(`Trying to bind a null gpu texture or view! entry=${JSON.stringify(C)}, name=${I}, bindingInfo=${JSON.stringify(F,(D,w)=>D==="texture"?"<no dump>":w)}, isReady=${(d=F.texture)==null?void 0:d.isReady}, materialContext.uniqueId=${i.uniqueId}`,50);continue}v[T].resource=C.storageTexture?V.viewForWriting:V.view}else N.Error(`Texture "${I}" not found in the material context. Make sure you bound it (something like effect.setTexture("${I}", texture)). entry=${JSON.stringify(C)}, materialContext=${JSON.stringify(i,(V,D)=>V==="texture"||V==="sampler"?"<no dump>":D)}`,50)}else if(C.externalTexture){const F=i.textures[I];if(F){if(this._engine.dbgSanityChecks&&F.texture===null){N.Error(`Trying to bind a null external texture! entry=${JSON.stringify(C)}, name=${I}, bindingInfo=${JSON.stringify(F,(D,w)=>D==="texture"?"<no dump>":w)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}const V=F.texture.underlyingResource;if(this._engine.dbgSanityChecks&&!V){N.Error(`Trying to bind a null gpu external texture! entry=${JSON.stringify(C)}, name=${I}, bindingInfo=${JSON.stringify(F,(D,w)=>D==="texture"?"<no dump>":w)}, isReady=${(f=F.texture)==null?void 0:f.isReady}, materialContext.uniqueId=${i.uniqueId}`,50);continue}v[T].resource=this._device.importExternalTexture({source:V})}else N.Error(`External texture "${I}" not found in the material context. Make sure you bound it. entry=${JSON.stringify(C)}, materialContext=${JSON.stringify(i,(V,D)=>V==="texture"||V==="sampler"?"<no dump>":D)}`,50)}else if(C.buffer){const F=t.buffers[I];if(F){const V=F.underlyingResource;v[T].resource.buffer=V,v[T].resource.size=F.capacity}else N.Error(`Can't find buffer "${I}" in the draw context. Make sure you bound it. entry=${JSON.stringify(C)}, buffers=${JSON.stringify(t.buffers)}, drawContext.uniqueId=${t.uniqueId}`,50)}}const E=o[m];r[m]=this._device.createBindGroup({layout:E,entries:v})}return r}}nt.NumBindGroupsCreatedTotal=0;nt.NumBindGroupsCreatedLastFrame=0;nt.NumBindGroupsLookupLastFrame=0;nt.NumBindGroupsNoLookupLastFrame=0;nt._Cache=new dl;nt._NumBindGroupsCreatedCurrentFrame=0;nt._NumBindGroupsLookupCurrentFrame=0;nt._NumBindGroupsNoLookupCurrentFrame=0;const JS="clearQuadVertexShader",Fw=`uniform depthValue: f32;const pos=array(
vec2f(-1.0,1.0),
vec2f(1.0,1.0),
vec2f(-1.0,-1.0),
vec2f(1.0,-1.0)
);
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
vertexOutputs.position=vec4f(pos[input.vertexIndex],uniforms.depthValue,1.0);
#define CUSTOM_VERTEX_MAIN_END
}
`;S.ShadersStoreWGSL[JS]||(S.ShadersStoreWGSL[JS]=Fw);const ev="clearQuadPixelShader",Lw=`uniform color: vec4f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=uniforms.color;}
`;S.ShadersStoreWGSL[ev]||(S.ShadersStoreWGSL[ev]=Lw);class ww{setDepthStencilFormat(e){this._depthTextureFormat=e,this._cacheRenderPipeline.setDepthStencilFormat(e)}setColorFormat(e){this._cacheRenderPipeline.setColorFormat(e)}setMRTAttachments(e,t,i){this._cacheRenderPipeline.setMRT(t,i),this._cacheRenderPipeline.setMRTAttachments(e)}constructor(e,t,i){this._bindGroups={},this._bundleCache={},this._keyTemp=[],this._device=e,this._engine=t,this._cacheRenderPipeline=new cs(this._device,i),this._cacheRenderPipeline.setDepthTestEnabled(!1),this._cacheRenderPipeline.setStencilReadMask(255),this._effect=t.createEffect("clearQuad",[],["color","depthValue"],void 0,void 0,void 0,void 0,void 0,void 0,1)}clear(e,t,i,r,n=1){let a,o=null,l;const c=!!this._engine._currentRenderTarget;if(e)a=e;else{let v=0;this._keyTemp.length=0;for(let T=0;T<this._cacheRenderPipeline.colorFormats.length;++T)this._keyTemp[v++]=Ps[this._cacheRenderPipeline.colorFormats[T]??""];const E=Ps[this._depthTextureFormat??0];if(this._keyTemp[v]=(t?t.r+t.g*256+t.b*256*256+t.a*256*256*256:0)+(i?2**32:0)+(r?2**33:0)+(this._engine.useReverseDepthBuffer?2**34:0)+(c?2**35:0)+(n>1?2**36:0)+E*2**37,l=this._keyTemp.join("_"),o=this._bundleCache[l],o)return o;a=this._device.createRenderBundleEncoder({label:"clearQuadRenderBundle",colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:Qe.GetSample(n)})}this._cacheRenderPipeline.setDepthWriteEnabled(!!i),this._cacheRenderPipeline.setStencilEnabled(!!r&&!!this._depthTextureFormat&&Qe.HasStencilAspect(this._depthTextureFormat)),this._cacheRenderPipeline.setStencilWriteMask(r?255:0),this._cacheRenderPipeline.setStencilCompare(r?519:512),this._cacheRenderPipeline.setStencilPassOp(r?7681:7680),this._cacheRenderPipeline.setWriteMask(t?15:0);const u=this._cacheRenderPipeline.getRenderPipeline(7,this._effect,n),h=this._effect._pipelineContext;t&&this._effect.setDirectColor4("color",t),this._effect.setFloat("depthValue",this._engine.useReverseDepthBuffer?this._engine._clearReverseDepthValue:this._engine._clearDepthValue),h.uniformBuffer.update();const d=c?this._engine._ubInvertY:this._engine._ubDontInvertY,f=h.uniformBuffer.getBuffer(),m=f.uniqueId+"-"+d.uniqueId;let g=this._bindGroups[m];if(!g){const v=h.bindGroupLayouts[0];g=this._bindGroups[m]=[],g.push(this._device.createBindGroup({label:`clearQuadBindGroup0-${m}`,layout:v[0],entries:[]})),Sr._SimplifiedKnownBindings||g.push(this._device.createBindGroup({label:`clearQuadBindGroup1-${m}`,layout:v[1],entries:[]})),g.push(this._device.createBindGroup({label:`clearQuadBindGroup${Sr._SimplifiedKnownBindings?1:2}-${m}`,layout:v[Sr._SimplifiedKnownBindings?1:2],entries:[{binding:0,resource:{buffer:d.underlyingResource,size:d.capacity}},{binding:1,resource:{buffer:f.underlyingResource,size:f.capacity}}]}))}a.setPipeline(u);for(let v=0;v<g.length;++v)a.setBindGroup(v,g[v]);return a.draw(4,1,0,0),e||(o=a.finish(),this._bundleCache[l]=o),o}}class u_{constructor(e,t,i,r){this.x=Math.floor(e),this.y=Math.floor(t),this.w=Math.floor(i),this.h=Math.floor(r)}run(e){e.setViewport(this.x,this.y,this.w,this.h,0,1)}clone(){return new u_(this.x,this.y,this.w,this.h)}}class h_{constructor(e,t,i,r){this.x=e,this.y=t,this.w=i,this.h=r}run(e){e.setScissorRect(this.x,this.y,this.w,this.h)}clone(){return new h_(this.x,this.y,this.w,this.h)}}class tu{constructor(e){this.ref=e}run(e){e.setStencilReference(this.ref)}clone(){return new tu(this.ref)}}class d_{constructor(e){this.color=e}run(e){e.setBlendConstant(this.color)}clone(){return new d_(this.color)}}class f_{constructor(e){this.query=e}run(e){e.beginOcclusionQuery(this.query)}clone(){return new f_(this.query)}}class p_{constructor(){}run(e){e.endOcclusionQuery()}clone(){return new p_}}class m_{constructor(){this.bundles=[]}run(e){e.executeBundles(this.bundles)}clone(){const e=new m_;return e.bundles=this.bundles,e}}class __{constructor(e){this.numDrawCalls=0,this._device=e,this._list=new Array(10),this._listLength=0}addBundle(e){if(!this._currentItemIsBundle){const t=new m_;this._list[this._listLength++]=t,this._currentBundleList=t.bundles,this._currentItemIsBundle=!0}e&&this._currentBundleList.push(e)}_finishBundle(){this._currentItemIsBundle&&this._bundleEncoder&&(this._currentBundleList.push(this._bundleEncoder.finish()),this._bundleEncoder=void 0,this._currentItemIsBundle=!1)}addItem(e){this._finishBundle(),this._list[this._listLength++]=e,this._currentItemIsBundle=!1}getBundleEncoder(e,t,i){return this._currentItemIsBundle||(this.addBundle(),this._bundleEncoder=this._device.createRenderBundleEncoder({colorFormats:e,depthStencilFormat:t,sampleCount:Qe.GetSample(i)})),this._bundleEncoder}close(){this._finishBundle()}run(e){this.close();for(let t=0;t<this._listLength;++t)this._list[t].run(e)}reset(){this._listLength=0,this._currentItemIsBundle=!1,this.numDrawCalls=0}clone(){this.close();const e=new __(this._device);e._list=new Array(this._listLength),e._listLength=this._listLength,e.numDrawCalls=this.numDrawCalls;for(let t=0;t<this._listLength;++t)e._list[t]=this._list[t].clone();return e}}class dR{get querySet(){return this._querySet}constructor(e,t,i,r,n,a=!0,o){this._dstBuffers=[],this._engine=e,this._device=r,this._bufferManager=n,this._count=t,this._canUseMultipleBuffers=a,this._querySet=r.createQuerySet({label:o??"QuerySet",type:i,count:t}),this._queryBuffer=n.createRawBuffer(8*t,$e.QueryResolve|$e.CopySrc,void 0,"QueryBuffer"),a||this._dstBuffers.push(this._bufferManager.createRawBuffer(8*this._count,$e.MapRead|$e.CopyDst,void 0,"QueryBufferNoMultipleBuffers"))}_getBuffer(e,t){if(!this._canUseMultipleBuffers&&this._dstBuffers.length===0)return null;const i=this._device.createCommandEncoder();let r;return this._dstBuffers.length===0?r=this._bufferManager.createRawBuffer(8*this._count,$e.MapRead|$e.CopyDst,void 0,"QueryBufferAdditionalBuffer"):(r=this._dstBuffers[this._dstBuffers.length-1],this._dstBuffers.length--),i.resolveQuerySet(this._querySet,e,t,this._queryBuffer,0),i.copyBufferToBuffer(this._queryBuffer,0,r,0,8*t),this._device.queue.submit([i.finish()]),r}async readValues(e=0,t=1){const i=this._getBuffer(e,t);if(i===null)return null;const r=this._engine.uniqueId;try{await i.mapAsync(1);const n=new BigUint64Array(i.getMappedRange()).slice();return i.unmap(),this._dstBuffers[this._dstBuffers.length]=i,n}catch(n){if(this._engine.isDisposed||this._engine.uniqueId!==r)return null;throw n}}async readValue(e=0){const t=this._getBuffer(e,1);if(t===null)return null;const i=this._engine.uniqueId;try{await t.mapAsync(1);const r=new BigUint64Array(t.getMappedRange()),n=Number(r[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,n}catch(r){if(this._engine.isDisposed||this._engine.uniqueId!==i)return 0;throw r}}async readTwoValuesAndSubtract(e=0){const t=this._getBuffer(e,2);if(t===null)return null;const i=this._engine.uniqueId;try{await t.mapAsync(1);const r=new BigUint64Array(t.getMappedRange()),n=Number(r[1]-r[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,n}catch(r){if(this._engine.isDisposed||this._engine.uniqueId!==i)return 0;throw r}}dispose(){this._querySet.destroy(),this._bufferManager.releaseBuffer(this._queryBuffer);for(let e=0;e<this._dstBuffers.length;++e)this._bufferManager.releaseBuffer(this._dstBuffers[e])}}class Bw{get gpuFrameTimeCounter(){return this._gpuFrameTimeCounter}constructor(e,t,i){this._enabled=!1,this._gpuFrameTimeCounter=new vu,this._measureDurationState=0,this._engine=e,this._device=t,this._bufferManager=i}get enable(){return this._enabled}set enable(e){if(this._enabled!==e)if(this._enabled=e,this._measureDurationState=0,e)try{this._measureDuration=new Vw(this._engine,this._device,this._bufferManager,2e3,"QuerySet_TimestampQuery")}catch(t){this._enabled=!1,N.Error(`Could not create a WebGPUDurationMeasure!
Error: `+t.message+`
Make sure timestamp query is supported and enabled in your browser.`);return}else this._measureDuration.dispose()}startFrame(e){this._enabled&&this._measureDurationState===0&&(this._measureDuration.start(e),this._measureDurationState=1)}endFrame(e){this._measureDurationState===1&&(this._measureDurationState=2,this._measureDuration.stop(e).then(t=>{t!==null&&t>=0&&(this._gpuFrameTimeCounter.fetchNewFrame(),this._gpuFrameTimeCounter.addCount(t,!0)),this._measureDurationState=0}))}startPass(e,t){this._enabled?this._measureDuration.startPass(e,t):e.timestampWrites=void 0}endPass(e,t){if(!this._enabled||!t)return;const i=this._engine.frameId;this._measureDuration.stopPass(e).then(r=>{t._addDuration(i,r!==null&&r>0?r:0)})}dispose(){var e;(e=this._measureDuration)==null||e.dispose()}}class Vw{constructor(e,t,i,r=2,n){this._count=r,this._querySet=new dR(e,r,"timestamp",t,i,!0,n)}start(e){var t;(t=e.writeTimestamp)==null||t.call(e,this._querySet.querySet,0)}async stop(e){var t;return(t=e.writeTimestamp)==null||t.call(e,this._querySet.querySet,1),e.writeTimestamp?await this._querySet.readTwoValuesAndSubtract(0):0}startPass(e,t){if(t+3>this._count)throw new Error("WebGPUDurationMeasure: index out of range ("+t+")");e.timestampWrites={querySet:this._querySet.querySet,beginningOfPassWriteIndex:t+2,endOfPassWriteIndex:t+3}}async stopPass(e){return await this._querySet.readTwoValuesAndSubtract(e+2)}dispose(){this._querySet.dispose()}}class Uw{get querySet(){return this._querySet.querySet}get hasQueries(){return this._currentTotalIndices!==this._availableIndices.length}canBeginQuery(e){if(this._frameQuerySetIsDirty===this._engine.frameId||this._queryFrameId[e]===this._engine.frameId)return!1;const t=this._engine._getCurrentRenderPassWrapper().renderPassDescriptor.occlusionQuerySet!==void 0;return t&&(this._queryFrameId[e]=this._engine.frameId),t}constructor(e,t,i,r=50,n=100){this._availableIndices=[],this._frameQuerySetIsDirty=-1,this._queryFrameId=[],this._engine=e,this._device=t,this._bufferManager=i,this._frameLastBuffer=-1,this._currentTotalIndices=0,this._countIncrement=n,this._allocateNewIndices(r)}createQuery(){this._availableIndices.length===0&&this._allocateNewIndices();const e=this._availableIndices[this._availableIndices.length-1];return this._availableIndices.length--,e}deleteQuery(e){this._availableIndices[this._availableIndices.length]=e}isQueryResultAvailable(e){return this._retrieveQueryBuffer(),!!this._lastBuffer&&e<this._lastBuffer.length}getQueryResult(e){var t;return Number(((t=this._lastBuffer)==null?void 0:t[e])??-1)}_retrieveQueryBuffer(){this._lastBuffer&&this._frameLastBuffer===this._engine.frameId||this._frameLastBuffer!==this._engine.frameId&&(this._frameLastBuffer=this._engine.frameId,this._querySet.readValues(0,this._currentTotalIndices).then(e=>{this._lastBuffer=e}))}_allocateNewIndices(e){e=e??this._countIncrement,this._delayQuerySetDispose();for(let t=0;t<e;++t)this._availableIndices.push(this._currentTotalIndices+t);this._currentTotalIndices+=e,this._querySet=new dR(this._engine,this._currentTotalIndices,"occlusion",this._device,this._bufferManager,!1,"QuerySet_OcclusionQuery_count_"+this._currentTotalIndices),this._frameQuerySetIsDirty=this._engine.frameId}_delayQuerySetDispose(){const e=this._querySet;e&&setTimeout(()=>e.dispose,1e3)}dispose(){var e;(e=this._querySet)==null||e.dispose(),this._availableIndices.length=0}}class fr{async initTwgsl(e){if(!fr._Twgsl){if(e=e||{},e={...fr._TwgslDefaultOptions,...e},e.twgsl){fr._Twgsl=e.twgsl;return}if(e.jsPath&&e.wasmPath&&await j.LoadBabylonScriptAsync(e.jsPath),self.twgsl){fr._Twgsl=await self.twgsl(j.GetBabylonScriptURL(e.wasmPath));return}throw new Error("twgsl is not available.")}}convertSpirV2WGSL(e,t=!1){const i=fr._Twgsl.convertSpirV2WGSL(e,fr.DisableUniformityAnalysis||t);return fr.ShowWGSLShaderCode&&(N.Log(i),N.Log("***********************************************")),fr.DisableUniformityAnalysis||t?`diagnostic(off, derivative_uniformity);
`+i:i}}fr._TwgslDefaultOptions={jsPath:`${j._DefaultCdnUrl}/twgsl/twgsl.js`,wasmPath:`${j._DefaultCdnUrl}/twgsl/twgsl.wasm`};fr.ShowWGSLShaderCode=!1;fr.DisableUniformityAnalysis=!1;fr._Twgsl=null;class kw{constructor(e,t,i){this._record=!1,this._play=!1,this._playBundleListIndex=0,this._allBundleLists=[],this._enabled=!1,this.showDebugLogs=!1,this._engine=e,this._mode=t,this._bundleList=i}get enabled(){return this._enabled}get play(){return this._play}get record(){return this._record}set enabled(e){this._log("enabled",`activate=${e}, mode=${this._mode}`),this._allBundleLists.length=0,this._record=this._enabled=e,this._play=!1,e&&(this._modeSaved=this._mode,this._mode=0)}get mode(){return this._mode}set mode(e){this._record?this._modeSaved=e:this._mode=e}endRenderPass(e){if(!this._record&&!this._play)return!1;let t=null;return this._record?(t=this._bundleList.clone(),this._allBundleLists.push(t),this._bundleList.reset(),this._log("endRenderPass",`bundleList recorded at position #${this._allBundleLists.length-1}`)):this._playBundleListIndex>=this._allBundleLists.length?this._log("endRenderPass",`empty or out-of-sync bundleList (_allBundleLists.length=${this._allBundleLists.length}, playBundleListIndex=${this._playBundleListIndex})`):(this._log("endRenderPass",`run bundleList #${this._playBundleListIndex}`),t=this._allBundleLists[this._playBundleListIndex++]),t&&(t.run(e),this._mode===1&&this._engine._reportDrawCall(t.numDrawCalls)),!0}endFrame(){this._record&&(this._record=!1,this._play=!0,this._mode=this._modeSaved,this._log("endFrame","bundles recorded, switching to play mode")),this._playBundleListIndex=0}reset(){this._log("reset","called"),this._record&&(this._mode=this._modeSaved),this.enabled=!1,this.enabled=!0}_log(e,t){this.showDebugLogs&&N.Log(`[Frame: ${this._engine.frameId}] WebGPUSnapshotRendering:${e} - ${t}`)}}class Gw extends hR{constructor(e){super(e)}}Et.prototype.createRawTexture=function(s,e,t,i,r,n,a,o=null,l=0,c=0,u=!1){const h=new $t(this,3);return h.baseWidth=e,h.baseHeight=t,h.width=e,h.height=t,h.format=i,h.generateMipMaps=r,h.samplingMode=a,h.invertY=n,h._compression=o,h.type=l,h._creationFlags=c,h._useSRGBBuffer=u,this._doNotHandleContextLost||(h._bufferView=s),this._textureHelper.createGPUTextureForInternalTexture(h,e,t,void 0,c),this.updateRawTexture(h,s,i,n,o,l,u),this._internalTexturesCache.push(h),h};Et.prototype.updateRawTexture=function(s,e,t,i,r=null,n=0,a=!1){if(s){if(this._doNotHandleContextLost||(s._bufferView=e,s.invertY=i,s._compression=r,s._useSRGBBuffer=a),e){const o=s._hardwareTexture;t===4&&(e=ec(e,s.width,s.height,n));const c=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(c,s,s.width,s.height,s.depth,o.format,0,0,i,!1,0,0),s.generateMipMaps&&this._generateMipmaps(s,this._uploadEncoder)}s.isReady=!0}};Et.prototype.createRawCubeTexture=function(s,e,t,i,r,n,a,o=null){const l=new $t(this,8);if(i===1&&!this._caps.textureFloatLinearFiltering?(r=!1,a=1,N.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):i===2&&!this._caps.textureHalfFloatLinearFiltering?(r=!1,a=1,N.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):i===1&&!this._caps.textureFloatRender?(r=!1,N.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):i===2&&!this._caps.colorBufferFloat&&(r=!1,N.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")),l.isCube=!0,l._originalFormat=t,l.format=t===4?5:t,l.type=i,l.generateMipMaps=r,l.width=e,l.height=e,l.samplingMode=a,this._doNotHandleContextLost||(l._bufferViewArray=s),l.invertY=n,l._compression=o,l._cachedWrapU=0,l._cachedWrapV=0,this._textureHelper.createGPUTextureForInternalTexture(l),t===4){const c=l._hardwareTexture;c._originalFormatIsRGB=!0}return s&&this.updateRawCubeTexture(l,s,t,i,n,o),l.isReady=!0,l};Et.prototype.updateRawCubeTexture=function(s,e,t,i,r,n=null){s._bufferViewArray=e,s.invertY=r,s._compression=n;const a=s._hardwareTexture,o=a._originalFormatIsRGB,l=[0,2,4,1,3,5],c=[];for(let u=0;u<e.length;++u){let h=e[l[u]];o&&(h=ec(h,s.width,s.height,i)),c.push(new Uint8Array(h.buffer,h.byteOffset,h.byteLength))}this._textureHelper.updateCubeTextures(c,a.underlyingResource,s.width,s.height,a.format,r,!1,0,0),s.generateMipMaps&&this._generateMipmaps(s,this._uploadEncoder),s.isReady=!0};Et.prototype.createRawCubeTextureFromUrl=function(s,e,t,i,r,n,a,o,l=null,c=null,u=3,h=!1){const d=this.createRawCubeTexture(null,t,i,r,!n,h,u,null);e==null||e.addPendingData(d),d.url=s,d.isReady=!1,this._internalTexturesCache.push(d);const f=(g,v)=>{e==null||e.removePendingData(d),c&&g&&c(g.status+" "+g.statusText,v)},m=async g=>{const v=a(g);if(!v)return;const E=v instanceof Promise?await v:v,T=d.width;if(o){const C=i===4,A=o(E),I=d._hardwareTexture,F=[0,1,2,3,4,5];for(let V=0;V<A.length;V++){const D=T>>V,w=[];for(let B=0;B<6;B++){let Q=A[V][F[B]];C&&(Q=ec(Q,D,D,r)),w.push(new Uint8Array(Q.buffer,Q.byteOffset,Q.byteLength))}this._textureHelper.updateCubeTextures(w,I.underlyingResource,D,D,I.format,h,!1,0,0)}}else this.updateRawCubeTexture(d,E,i,r,h);d.isReady=!0,e==null||e.removePendingData(d),l&&l()};return this._loadFile(s,g=>{m(g).catch(v=>{f(void 0,v)})},void 0,e==null?void 0:e.offlineProvider,!0,f),d};Et.prototype.createRawTexture3D=function(s,e,t,i,r,n,a,o,l=null,c=0,u=0){const d=new $t(this,10);return d.baseWidth=e,d.baseHeight=t,d.baseDepth=i,d.width=e,d.height=t,d.depth=i,d.format=r,d.type=c,d.generateMipMaps=n,d.samplingMode=o,d.is3D=!0,d._creationFlags=u,this._doNotHandleContextLost||(d._bufferView=s),this._textureHelper.createGPUTextureForInternalTexture(d,e,t,void 0,u),this.updateRawTexture3D(d,s,r,a,l,c),this._internalTexturesCache.push(d),d};Et.prototype.updateRawTexture3D=function(s,e,t,i,r=null,n=0){if(this._doNotHandleContextLost||(s._bufferView=e,s.format=t,s.invertY=i,s._compression=r),e){const a=s._hardwareTexture;t===4&&(e=ec(e,s.width,s.height,n));const l=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(l,s,s.width,s.height,s.depth,a.format,0,0,i,!1,0,0),s.generateMipMaps&&this._generateMipmaps(s,this._uploadEncoder)}s.isReady=!0};Et.prototype.createRawTexture2DArray=function(s,e,t,i,r,n,a,o,l=null,c=0,u=0){const d=new $t(this,11);return d.baseWidth=e,d.baseHeight=t,d.baseDepth=i,d.width=e,d.height=t,d.depth=i,d.format=r,d.type=c,d.generateMipMaps=n,d.samplingMode=o,d.is2DArray=!0,d._creationFlags=u,this._doNotHandleContextLost||(d._bufferView=s),this._textureHelper.createGPUTextureForInternalTexture(d,e,t,i,u),this.updateRawTexture2DArray(d,s,r,a,l,c),this._internalTexturesCache.push(d),d};Et.prototype.updateRawTexture2DArray=function(s,e,t,i,r=null,n=0){if(this._doNotHandleContextLost||(s._bufferView=e,s.format=t,s.invertY=i,s._compression=r),e){const a=s._hardwareTexture;t===4&&(e=ec(e,s.width,s.height,n));const l=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(l,s,s.width,s.height,s.depth,a.format,0,0,i,!1,0,0),s.generateMipMaps&&this._generateMipmaps(s,this._uploadEncoder)}s.isReady=!0};function ec(s,e,t,i){let r,n=1;i===1?r=new Float32Array(e*t*4):i===2?(r=new Uint16Array(e*t*4),n=15360):i===7?r=new Uint32Array(e*t*4):r=new Uint8Array(e*t*4);for(let a=0;a<e;a++)for(let o=0;o<t;o++){const l=(o*e+a)*3,c=(o*e+a)*4;r[c+0]=s[l+0],r[c+1]=s[l+1],r[c+2]=s[l+2],r[c+3]=n}return r}Et.prototype._readTexturePixels=function(s,e,t,i=-1,r=0,n=null,a=!0,o=!1,l=0,c=0){const u=s._hardwareTexture;return a&&this.flushFramebuffer(),this._textureHelper.readPixels(u.underlyingResource,l,c,e,t,u.format,i,r,n,o)};Et.prototype._readTexturePixelsSync=function(){throw"_readTexturePixelsSync is unsupported in WebGPU!"};Et.prototype._createDepthStencilCubeTexture=function(s,e){const t=new $t(this,e.generateStencil?12:14);t.isCube=!0,t.label=e.label;const i={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,depthTextureFormat:e.generateStencil?13:14,...e};t.format=i.depthTextureFormat,this._setupDepthStencilTexture(t,s,i.bilinearFiltering,i.comparisonFunction,i.samples),this._textureHelper.createGPUTextureForInternalTexture(t);const r=t._hardwareTexture;return t.type=Qe.GetTextureTypeFromFormat(r.format),this._internalTexturesCache.push(t),t};Et.prototype.createCubeTexture=function(s,e,t,i,r=null,n=null,a,o=null,l=!1,c=0,u=0,h=null,d,f=!1,m=null){return this.createCubeTextureBase(s,e,t,!!i,r,n,a,o,l,c,u,h,null,(g,v)=>{const E=v,T=E[0].width,C=T;this._setCubeMapTextureParams(g,!i),g.format=a??-1;const A=this._textureHelper.createGPUTextureForInternalTexture(g,T,C);this._textureHelper.updateCubeTextures(E,A.underlyingResource,T,C,A.format,!1,!1,0,0),i||this._generateMipmaps(g,this._uploadEncoder),g.isReady=!0,g.onLoadedObservable.notifyObservers(g),g.onLoadedObservable.clear(),r&&r()},!!f,m)};Et.prototype._setCubeMapTextureParams=function(s,e,t){s.samplingMode=e?3:2,s._cachedWrapU=0,s._cachedWrapV=0,t&&(s._maxLodLevel=t)};Et.prototype.generateMipMapsForCubemap=function(s){var e;s.generateMipMaps&&((e=s._hardwareTexture)!=null&&e.underlyingResource||this._textureHelper.createGPUTextureForInternalTexture(s),this._generateMipmaps(s))};class zw extends rI{constructor(e,t,i,r,n){super(e,t,i,r,n),r.enableGPUTimingMeasurements&&(this.gpuTimeInFrame=new c_)}}Et.prototype._createHardwareRenderTargetWrapper=function(s,e,t){const i=new zw(s,e,t,this);return this._renderTargetWrapperCache.push(i),i};Et.prototype.createRenderTargetTexture=function(s,e){var n;const t=this._createHardwareRenderTargetWrapper(!1,!1,s),i={};e!==void 0&&typeof e=="object"?(i.generateMipMaps=e.generateMipMaps,i.generateDepthBuffer=e.generateDepthBuffer===void 0?!0:e.generateDepthBuffer,i.generateStencilBuffer=i.generateDepthBuffer&&e.generateStencilBuffer,i.samplingMode=e.samplingMode===void 0?3:e.samplingMode,i.creationFlags=e.creationFlags??0,i.noColorAttachment=!!e.noColorAttachment,i.colorAttachment=e.colorAttachment,i.samples=e.samples,i.label=e.label,i.format=e.format,i.type=e.type):(i.generateMipMaps=e,i.generateDepthBuffer=!0,i.generateStencilBuffer=!1,i.samplingMode=3,i.creationFlags=0,i.noColorAttachment=!1);const r=i.colorAttachment||(i.noColorAttachment?null:this._createInternalTexture(s,i,!0,5));return t.label=i.label??"RenderTargetWrapper",t._samples=((n=i.colorAttachment)==null?void 0:n.samples)??i.samples??1,t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=!!i.generateStencilBuffer,t.setTextures(r),(t._generateDepthBuffer||t._generateStencilBuffer)&&t.createDepthStencilTexture(0,!1,t._generateStencilBuffer,t.samples,i.generateStencilBuffer?13:14,i.label?i.label+"-DepthStencil":void 0),r&&!i.colorAttachment&&(e!==void 0&&typeof e=="object"&&e.createMipMaps&&!i.generateMipMaps&&(r.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(r,void 0,void 0,void 0,i.creationFlags),e!==void 0&&typeof e=="object"&&e.createMipMaps&&!i.generateMipMaps&&(r.generateMipMaps=!1)),t};Et.prototype._createDepthStencilTexture=function(s,e,t){const i={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,depthTextureFormat:e.generateStencil?13:14,...e},r=wm(i.depthTextureFormat);t._depthStencilTextureWithStencil=r;const n=new $t(this,r?12:14);return n.label=e.label,n.format=i.depthTextureFormat,n.type=nI(n.format),this._setupDepthStencilTexture(n,s,i.bilinearFiltering,i.comparisonFunction,i.samples),this._textureHelper.createGPUTextureForInternalTexture(n),this._internalTexturesCache.push(n),n};Et.prototype._setupDepthStencilTexture=function(s,e,t,i,r=1){const n=e.width??e,a=e.height??e,o=e.layers||0,l=e.depth||0;s.baseWidth=n,s.baseHeight=a,s.width=n,s.height=a,s.is2DArray=o>0,s.is3D=l>0,s.depth=o||l,s.isReady=!0,s.samples=r,s.generateMipMaps=!1,s.samplingMode=t?2:1,s.type=1,s._comparisonFunction=i,s._cachedWrapU=0,s._cachedWrapV=0};Et.prototype.updateRenderTargetTextureSampleCount=function(s,e){return!s||!s.texture||s.samples===e||(e=Math.min(e,this.getCaps().maxMSAASamples),this._textureHelper.createMSAATexture(s.texture,e),s._depthStencilTexture&&(this._textureHelper.createMSAATexture(s._depthStencilTexture,e),s._depthStencilTexture.samples=e),s._samples=e,s.texture.samples=e),e};Et.prototype.setDepthStencilTexture=function(s,e,t,i){!t||!t.depthStencilTexture?this._setTexture(s,null,void 0,void 0,i):this._setTexture(s,t,!1,!0,i)};Et.prototype.createRenderTargetCubeTexture=function(s,e){const t=this._createHardwareRenderTargetWrapper(!1,!0,s),i={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,samples:1,...e};i.generateStencilBuffer=i.generateDepthBuffer&&i.generateStencilBuffer,t.label=i.label??"RenderTargetWrapper",t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=i.generateStencilBuffer;const r=new $t(this,5);return r.width=s,r.height=s,r.depth=0,r.isReady=!0,r.isCube=!0,r.samples=i.samples,r.generateMipMaps=i.generateMipMaps,r.samplingMode=i.samplingMode,r.type=i.type,r.format=i.format,this._internalTexturesCache.push(r),t.setTextures(r),(t._generateDepthBuffer||t._generateStencilBuffer)&&t.createDepthStencilTexture(0,i.samplingMode===void 0||i.samplingMode===2||i.samplingMode===2||i.samplingMode===3||i.samplingMode===3||i.samplingMode===5||i.samplingMode===6||i.samplingMode===7||i.samplingMode===11,t._generateStencilBuffer,t.samples),e&&e.createMipMaps&&!i.generateMipMaps&&(r.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(r),e&&e.createMipMaps&&!i.generateMipMaps&&(r.generateMipMaps=!1),t};Et.prototype.getGPUFrameTimeCounter=function(){return this._timestampQuery.gpuFrameTimeCounter};Et.prototype.captureGPUFrameTime=function(s){this._timestampQuery.enable=s&&!!this._caps.timerQuery};Et.prototype.createQuery=function(){return this._occlusionQuery.createQuery()};Et.prototype.deleteQuery=function(s){return this._occlusionQuery.deleteQuery(s),this};Et.prototype.isQueryResultAvailable=function(s){return this._occlusionQuery.isQueryResultAvailable(s)};Et.prototype.getQueryResult=function(s){return this._occlusionQuery.getQueryResult(s)};Et.prototype.beginOcclusionQuery=function(s,e){var t;if(this.compatibilityMode){if(this._occlusionQuery.canBeginQuery(e))return(t=this._currentRenderPass)==null||t.beginOcclusionQuery(e),!0}else return this._bundleList.addItem(new f_(e)),!0;return!1};Et.prototype.endOcclusionQuery=function(){var s;return this.compatibilityMode?(s=this._currentRenderPass)==null||s.endOcclusionQuery():this._bundleList.addItem(new p_),this};const tv={label:"TextureView_SwapChain_ResolveTarget",dimension:"2d",format:void 0,mipLevelCount:1,arrayLayerCount:1},iv={label:"TextureView_SwapChain",dimension:"2d",format:void 0,mipLevelCount:1,arrayLayerCount:1},Ww=new Te;class ct extends Et{get snapshotRenderingMode(){return this._snapshotRendering.mode}set snapshotRenderingMode(e){this._snapshotRendering.mode=e}snapshotRenderingReset(){this._snapshotRendering.reset()}get snapshotRendering(){return this._snapshotRendering.enabled}set snapshotRendering(e){this._snapshotRendering.enabled=e}get disableCacheSamplers(){return this._cacheSampler?this._cacheSampler.disabled:!1}set disableCacheSamplers(e){this._cacheSampler&&(this._cacheSampler.disabled=e)}get disableCacheRenderPipelines(){return this._cacheRenderPipeline?this._cacheRenderPipeline.disabled:!1}set disableCacheRenderPipelines(e){this._cacheRenderPipeline&&(this._cacheRenderPipeline.disabled=e)}get disableCacheBindGroups(){return this._cacheBindGroups?this._cacheBindGroups.disabled:!1}set disableCacheBindGroups(e){this._cacheBindGroups&&(this._cacheBindGroups.disabled=e)}areAllEffectsReady(){return!0}getFontOffset(e){return aD(e)}static get IsSupportedAsync(){return navigator.gpu?navigator.gpu.requestAdapter().then(e=>!!e,()=>!1).catch(()=>!1):Promise.resolve(!1)}static get IsSupported(){return N.Warn("You must call IsSupportedAsync for WebGPU!"),!1}get supportsUniformBuffers(){return!0}get supportedExtensions(){return this._adapterSupportedExtensions}get enabledExtensions(){return this._deviceEnabledExtensions}get supportedLimits(){return this._adapterSupportedLimits}get currentLimits(){return this._deviceLimits}get description(){return this.name+this.version}get version(){return 1}getInfo(){return{vendor:this._adapterInfo.vendor||"unknown vendor",renderer:this._adapterInfo.architecture||"unknown renderer",version:this._adapterInfo.description||"unknown version"}}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=e}get currentSampleCount(){return this._currentRenderTarget?this._currentRenderTarget.samples:this._mainPassSampleCount}static CreateAsync(e,t={}){const i=new ct(e,t);return new Promise(r=>{i.initAsync(t.glslangOptions,t.twgslOptions).then(()=>r(i))})}constructor(e,t={}){if(super(t.antialias??!0,t),this.uniqueId=-1,this._uploadEncoderDescriptor={label:"upload"},this._renderEncoderDescriptor={label:"render"},this._clearDepthValue=1,this._clearReverseDepthValue=0,this._clearStencilValue=0,this._defaultSampleCount=4,this._glslang=null,this._tintWASM=null,this._glslangAndTintAreFullyLoaded=!1,this._adapterInfo={vendor:"",architecture:"",device:"",description:"",subgroupMinSize:0,subgroupMaxSize:0,isFallbackAdapter:!1},this._compiledComputeEffects={},this._counters={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.countersLastFrame={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.numMaxUncapturedErrors=20,this.scenes=[],this._virtualScenes=new Array,this._commandBuffers=[null,null],this._mainRenderPassWrapper={renderPassDescriptor:null,colorAttachmentViewDescriptor:null,depthAttachmentViewDescriptor:null,colorAttachmentGPUTextures:[],depthTextureFormat:void 0},this._rttRenderPassWrapper={renderPassDescriptor:null,colorAttachmentViewDescriptor:null,depthAttachmentViewDescriptor:null,colorAttachmentGPUTextures:[],depthTextureFormat:void 0},this._pendingDebugCommands=[],this._currentVertexBuffers={},this._currentOverrideVertexBuffers=null,this._currentIndexBuffer=null,this._colorWriteLocal=!0,this._forceEnableEffect=!1,this.isNDCHalfZRange=!0,this.hasOriginBottomLeft=!1,this._workingGlslangAndTintPromise=null,this._viewportsCurrent={x:0,y:0,w:0,h:0},this._scissorsCurrent={x:0,y:0,w:0,h:0},this._scissorCached={x:0,y:0,z:0,w:0},this._stencilRefsCurrent=-1,this._blendColorsCurrent=[null,null,null,null],this._performanceMonitor=new oD,this._name="WebGPU",this._drawCalls=new vu,t.deviceDescriptor=t.deviceDescriptor||{},t.enableGPUDebugMarkers=t.enableGPUDebugMarkers??!1,N.Log(`Babylon.js v${te.Version} - ${this.description} engine`),!navigator.gpu){N.Error("WebGPU is not supported by your browser.");return}t.swapChainFormat=t.swapChainFormat||navigator.gpu.getPreferredCanvasFormat(),this._isWebGPU=!0,this._shaderPlatformName="WEBGPU",this._renderingCanvas=e,this._options=t,this._mainPassSampleCount=t.antialias?this._defaultSampleCount:1,navigator&&navigator.userAgent&&this._setupMobileChecks(),this._sharedInit(this._renderingCanvas),this._shaderProcessor=new uw,this._shaderProcessorWGSL=new pw}prepareGlslangAndTintAsync(){return this._workingGlslangAndTintPromise||(this._workingGlslangAndTintPromise=new Promise(e=>{var t;this._initGlslangAsync(this._glslangOptions??((t=this._options)==null?void 0:t.glslangOptions)).then(i=>{var r;this._glslang=i,this._tintWASM=new fr,this._tintWASM.initTwgsl(this._twgslOptions??((r=this._options)==null?void 0:r.twgslOptions)).then(()=>{this._glslangAndTintAreFullyLoaded=!0,e()})})})),this._workingGlslangAndTintPromise}initAsync(e,t){return this.uniqueId=ct._InstanceId++,this._glslangOptions=e,this._twgslOptions=t,navigator.gpu.requestAdapter(this._options).then(async i=>{var r;if(i){this._adapter=i,this._adapterSupportedExtensions=[],(r=this._adapter.features)==null||r.forEach(o=>{this._adapterSupportedExtensions.push(o)}),this._adapterSupportedLimits=this._adapter.limits,this._adapterInfo=this._adapter.info;const n=this._options.deviceDescriptor??{},a=(n==null?void 0:n.requiredFeatures)??(this._options.enableAllFeatures?this._adapterSupportedExtensions:void 0);if(a){const o=a,l=[];for(const c of o)this._adapterSupportedExtensions.indexOf(c)!==-1&&l.push(c);n.requiredFeatures=l}if(this._options.setMaximumLimits&&!n.requiredLimits){n.requiredLimits={};for(const o in this._adapterSupportedLimits)o==="minSubgroupSize"||o==="maxSubgroupSize"||(n.requiredLimits[o]=this._adapterSupportedLimits[o])}return n.label=`BabylonWebGPUDevice${this.uniqueId}`,await this._adapter.requestDevice(n)}else throw"Could not retrieve a WebGPU adapter (adapter is null)."}).then(i=>{var n,a;this._device=i,this._deviceEnabledExtensions=[],(n=this._device.features)==null||n.forEach(o=>{this._deviceEnabledExtensions.push(o)}),this._deviceLimits=i.limits;let r=-1;this._device.addEventListener("uncapturederror",o=>{++r<this.numMaxUncapturedErrors?N.Warn(`WebGPU uncaptured error (${r+1}): ${o.error} - ${o.error.message}`):r++===this.numMaxUncapturedErrors&&N.Warn(`WebGPU uncaptured error: too many warnings (${this.numMaxUncapturedErrors}), no more warnings will be reported to the console for this engine.`)}),this._doNotHandleContextLost||(a=this._device.lost)==null||a.then(o=>{this._isDisposed||(this._contextWasLost=!0,N.Warn("WebGPU context lost. "+o),this.onContextLostObservable.notifyObservers(this),this._restoreEngineAfterContextLost(async()=>{var m,g;const l=this.snapshotRenderingMode,c=this.snapshotRendering,u=this.disableCacheSamplers,h=this.disableCacheRenderPipelines,d=this.disableCacheBindGroups,f=this.enableGPUTimingMeasurements;await this.initAsync(this._glslangOptions??((m=this._options)==null?void 0:m.glslangOptions),this._twgslOptions??((g=this._options)==null?void 0:g.twgslOptions)),this.snapshotRenderingMode=l,this.snapshotRendering=c,this.disableCacheSamplers=u,this.disableCacheRenderPipelines=h,this.disableCacheBindGroups=d,this.enableGPUTimingMeasurements=f,this._currentRenderPass=null}))})}).then(()=>{this._initializeLimits(),this._bufferManager=new eu(this,this._device),this._textureHelper=new yw(this,this._device,this._bufferManager,this._deviceEnabledExtensions),this._cacheSampler=new fa(this._device),this._cacheBindGroups=new nt(this._device,this._cacheSampler,this),this._timestampQuery=new Bw(this,this._device,this._bufferManager),this._occlusionQuery=this._device.createQuerySet?new Uw(this,this._device,this._bufferManager):void 0,this._bundleList=new __(this._device),this._snapshotRendering=new kw(this,this._snapshotRenderingMode,this._bundleList),this._ubInvertY=this._bufferManager.createBuffer(new Float32Array([-1,0]),$e.Uniform|$e.CopyDst,"UBInvertY"),this._ubDontInvertY=this._bufferManager.createBuffer(new Float32Array([1,0]),$e.Uniform|$e.CopyDst,"UBDontInvertY"),this.dbgVerboseLogsForFirstFrames&&this._count===void 0&&(this._count=0,N.Log(["%c frame #"+this._count+" - begin","background: #ffff00"])),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._emptyVertexBuffer=new M(this,[0],"",{stride:1,offset:0,size:1,label:"EmptyVertexBuffer"}),this._dummyIndexBuffer=this._bufferManager.createBuffer(new Uint16Array([0,0,0,0]),$e.Storage|$e.CopyDst,"DummyIndices"),this._cacheRenderPipeline=new cs(this._device,this._emptyVertexBuffer),this._depthCullingState=new Nw(this._cacheRenderPipeline),this._stencilStateComposer=new Ow(this._cacheRenderPipeline),this._stencilStateComposer.stencilGlobal=this._stencilState,this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=515,this._depthCullingState.depthMask=!0,this._textureHelper.setCommandEncoder(this._uploadEncoder),this._clearQuad=new ww(this._device,this,this._emptyVertexBuffer),this._defaultDrawContext=this.createDrawContext(),this._currentDrawContext=this._defaultDrawContext,this._defaultMaterialContext=this.createMaterialContext(),this._currentMaterialContext=this._defaultMaterialContext,this._initializeContextAndSwapChain(),this._initializeMainAttachments(),this.resize()}).catch(i=>{throw N.Error("A fatal error occurred during WebGPU creation/initialization."),i})}_initGlslangAsync(e){if(e=e||{},e={...ct._GlslangDefaultOptions,...e},e.glslang)return e.glslang;if(self.glslang)return self.glslang(e.wasmPath);if(e.jsPath&&e.wasmPath)return j.LoadBabylonScriptAsync(e.jsPath).then(()=>self.glslang(j.GetBabylonScriptURL(e.wasmPath)));throw new Error("glslang is not available")}_initializeLimits(){const e=this._deviceEnabledExtensions.indexOf("texture-formats-tier1")>=0;this._caps={maxTexturesImageUnits:this._deviceLimits.maxSampledTexturesPerShaderStage,maxVertexTextureImageUnits:this._deviceLimits.maxSampledTexturesPerShaderStage,maxCombinedTexturesImageUnits:this._deviceLimits.maxSampledTexturesPerShaderStage*2,maxTextureSize:this._deviceLimits.maxTextureDimension2D,maxCubemapTextureSize:this._deviceLimits.maxTextureDimension2D,maxRenderTextureSize:this._deviceLimits.maxTextureDimension2D,maxVertexAttribs:this._deviceLimits.maxVertexAttributes,maxDrawBuffers:8,maxVaryingVectors:this._deviceLimits.maxInterStageShaderVariables,maxFragmentUniformVectors:Math.floor(this._deviceLimits.maxUniformBufferBindingSize/4),maxVertexUniformVectors:Math.floor(this._deviceLimits.maxUniformBufferBindingSize/4),shaderFloatPrecision:23,standardDerivatives:!0,astc:this._deviceEnabledExtensions.indexOf("texture-compression-astc")>=0?!0:void 0,s3tc:this._deviceEnabledExtensions.indexOf("texture-compression-bc")>=0?!0:void 0,pvrtc:null,etc1:null,etc2:this._deviceEnabledExtensions.indexOf("texture-compression-etc2")>=0?!0:void 0,bptc:this._deviceEnabledExtensions.indexOf("texture-compression-bc")>=0?!0:void 0,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!0,highPrecisionShaderSupported:!0,colorBufferFloat:!0,blendFloat:this._deviceEnabledExtensions.indexOf("float32-blendable")>=0,supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:this._deviceEnabledExtensions.indexOf("rg11b10ufloat-renderable")>=0,textureFloat:!0,textureFloatLinearFiltering:this._deviceEnabledExtensions.indexOf("float32-filterable")>=0,textureFloatRender:!0,textureHalfFloat:!0,textureHalfFloatLinearFiltering:!0,textureHalfFloatRender:!0,textureLOD:!0,texelFetch:!0,drawBuffersExtension:!0,depthTextureExtension:!0,vertexArrayObject:!1,instancedArrays:!0,timerQuery:typeof BigUint64Array<"u"&&this._deviceEnabledExtensions.indexOf("timestamp-query")!==-1?!0:void 0,supportOcclusionQuery:typeof BigUint64Array<"u",canUseTimestampForTimerQuery:!0,multiview:!1,oculusMultiview:!1,parallelShaderCompile:void 0,blendMinMax:!0,maxMSAASamples:4,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!0,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!0,texture2DArrayMaxLayerCount:this._deviceLimits.maxTextureArrayLayers,disableMorphTargetTexture:!1,textureNorm16:e,blendParametersPerTarget:!0,dualSourceBlending:!0},this._features={forceBitmapOverHTMLImageElement:!0,supportRenderAndCopyToLodForFloatTextures:!0,supportDepthStencilTexture:!0,supportShadowSamplers:!0,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!0,trackUbosInFrame:!0,checkUbosContentBeforeUpload:!0,supportCSM:!0,basisNeedsPOT:!1,support3DTextures:!0,needTypeSuffixInShaderConstants:!0,supportMSAA:!0,supportSSAO2:!0,supportIBLShadows:!0,supportExtendedTextureFormats:!0,supportSwitchCaseInShader:!0,supportSyncTextureRead:!1,needsInvertingBitmap:!1,useUBOBindingCache:!1,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!0,supportRenderPasses:!0,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!0,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!0,_collectUbosUpdatedInFrame:!1},this._alphaState=new lD(this._caps.blendParametersPerTarget)}_initializeContextAndSwapChain(){if(!this._renderingCanvas)throw"The rendering canvas has not been set!";this._context=this._renderingCanvas.getContext("webgpu"),this._configureContext(),this._colorFormat=this._options.swapChainFormat,this._mainRenderPassWrapper.colorAttachmentGPUTextures=[new Gc(this)],this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].format=this._colorFormat,this._setColorFormat(this._mainRenderPassWrapper)}_initializeMainAttachments(){if(!this._bufferManager)return;this.flushFramebuffer(),this._mainTextureExtends={width:this.getRenderWidth(!0),height:this.getRenderHeight(!0),depthOrArrayLayers:1};const e=new Float32Array([this.getRenderHeight(!0)]);this._bufferManager.setSubData(this._ubInvertY,4,e),this._bufferManager.setSubData(this._ubDontInvertY,4,e);let t;if(this._options.antialias){const n={label:`Texture_MainColor_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}_antialiasing`,size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:"2d",format:this._options.swapChainFormat,usage:16};this._mainTexture&&this._textureHelper.releaseTexture(this._mainTexture),this._mainTexture=this._device.createTexture(n),t=[{view:this._mainTexture.createView({label:"TextureView_MainColor_antialiasing",dimension:"2d",format:this._options.swapChainFormat,mipLevelCount:1,arrayLayerCount:1}),clearValue:new Te(0,0,0,1),loadOp:"clear",storeOp:"store"}]}else t=[{view:void 0,clearValue:new Te(0,0,0,1),loadOp:"clear",storeOp:"store"}];this._mainRenderPassWrapper.depthTextureFormat=this.isStencilEnable?"depth24plus-stencil8":"depth32float",this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper);const i={label:`Texture_MainDepthStencil_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}`,size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:"2d",format:this._mainRenderPassWrapper.depthTextureFormat,usage:16};this._depthTexture&&this._textureHelper.releaseTexture(this._depthTexture),this._depthTexture=this._device.createTexture(i);const r={view:this._depthTexture.createView({label:`TextureView_MainDepthStencil_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}`,dimension:"2d",format:this._depthTexture.format,mipLevelCount:1,arrayLayerCount:1}),depthClearValue:this._clearDepthValue,depthLoadOp:"clear",depthStoreOp:"store",stencilClearValue:this._clearStencilValue,stencilLoadOp:this.isStencilEnable?"clear":void 0,stencilStoreOp:this.isStencilEnable?"store":void 0};this._mainRenderPassWrapper.renderPassDescriptor={label:"MainRenderPass",colorAttachments:t,depthStencilAttachment:r},this.beginFrame(),this._startMainRenderPass(!0,null,!0,!1),this._endCurrentRenderPass(),this.endFrame(),this._frameId--}_sharedInit(e){super._sharedInit(e),cD(this,e,this._creationOptions)}_configureContext(){this._context.configure({device:this._device,format:this._options.swapChainFormat,usage:17,alphaMode:this.premultipliedAlpha?"premultiplied":"opaque"})}resizeImageBitmap(e,t,i){return uD(this,e,t,i)}async _createImageBitmapFromSource(e,t){return await hD(this,e,t)}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}enterFullscreen(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&dD(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&fD()}enterPointerlock(){this._renderingCanvas&&pD(this._renderingCanvas)}exitPointerlock(){mD()}_rebuildBuffers(){super._rebuildBuffers();for(const e of this._storageBuffers)e.getBuffer().engineId!==this.uniqueId&&e._rebuild()}_restoreEngineAfterContextLost(e){cs.ResetCache(),nt.ResetCache();const t=r=>{var n;for(const a of r){for(const o of a.meshes){const l=o.subMeshes;if(l)for(const c of l)c._drawWrappers=[]}for(const o of a.materials)(n=o._materialContext)==null||n.reset()}};t(this.scenes),t(this._virtualScenes);const i=[];for(const r of this._uniformBuffers)r.name.indexOf("leftOver")<0&&i.push(r);this._uniformBuffers=i,super._restoreEngineAfterContextLost(e)}setSize(e,t,i=!1){return super.setSize(e,t,i)?(this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&N.Log(["frame #"+this._count+" - setSize -",e,t])),this._initializeMainAttachments(),this.snapshotRendering&&this.snapshotRenderingReset(),!0):!1}_getShaderProcessor(e){return e===1?this._shaderProcessorWGSL:this._shaderProcessor}_getShaderProcessingContext(e,t){return new Sr(e,t)}_getCurrentRenderPass(){return this._currentRenderTarget&&!this._currentRenderPass?this._startRenderTargetRenderPass(this._currentRenderTarget,!1,null,!1,!1):this._currentRenderPass||this._startMainRenderPass(!1),this._currentRenderPass}_getCurrentRenderPassWrapper(){return this._currentRenderTarget?this._rttRenderPassWrapper:this._mainRenderPassWrapper}applyStates(){this._stencilStateComposer.apply(),this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState._alphaBlend,this._alphaState._numTargetEnabled)}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._forceEnableEffect=!0,this._currentIndexBuffer=null,this._currentOverrideVertexBuffers=null,this._cacheRenderPipeline.setBuffers(null,null,null),e&&(this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=515,this._alphaState.reset(),this._resetAlphaMode(),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters),this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState._alphaBlend,this._alphaState._numTargetEnabled),this.setColorWrite(!0)),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}setColorWrite(e){this._colorWriteLocal=e,this._cacheRenderPipeline.setWriteMask(e?15:0)}getColorWrite(){return this._colorWriteLocal}_mustUpdateViewport(){const e=this._viewportCached.x,t=this._viewportCached.y,i=this._viewportCached.z,r=this._viewportCached.w,n=this._viewportsCurrent.x!==e||this._viewportsCurrent.y!==t||this._viewportsCurrent.w!==i||this._viewportsCurrent.h!==r;return n&&(this._viewportsCurrent.x=this._viewportCached.x,this._viewportsCurrent.y=this._viewportCached.y,this._viewportsCurrent.w=this._viewportCached.z,this._viewportsCurrent.h=this._viewportCached.w),n}_applyViewport(e){const t=Math.floor(this._viewportCached.x),i=Math.floor(this._viewportCached.z),r=Math.floor(this._viewportCached.w);let n=Math.floor(this._viewportCached.y);this._currentRenderTarget||(n=this.getRenderHeight(!0)-n-r),e?e.addItem(new u_(t,n,i,r)):this._getCurrentRenderPass().setViewport(t,n,i,r,0,1),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&N.Log(["frame #"+this._count+" - viewport applied - (",this._viewportCached.x,this._viewportCached.y,this._viewportCached.z,this._viewportCached.w,") current pass is main pass="+this._currentPassIsMainPass()]))}_viewport(e,t,i,r){this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=r}_mustUpdateScissor(){const e=this._scissorCached.x,t=this._scissorCached.y,i=this._scissorCached.z,r=this._scissorCached.w,n=this._scissorsCurrent.x!==e||this._scissorsCurrent.y!==t||this._scissorsCurrent.w!==i||this._scissorsCurrent.h!==r;return n&&(this._scissorsCurrent.x=this._scissorCached.x,this._scissorsCurrent.y=this._scissorCached.y,this._scissorsCurrent.w=this._scissorCached.z,this._scissorsCurrent.h=this._scissorCached.w),n}_applyScissor(e){const t=this._currentRenderTarget?this._scissorCached.y:this.getRenderHeight()-this._scissorCached.w-this._scissorCached.y;e?e.addItem(new h_(this._scissorCached.x,t,this._scissorCached.z,this._scissorCached.w)):this._getCurrentRenderPass().setScissorRect(this._scissorCached.x,t,this._scissorCached.z,this._scissorCached.w),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&N.Log(["frame #"+this._count+" - scissor applied - (",this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w,") current pass is main pass="+this._currentPassIsMainPass()]))}_scissorIsActive(){return this._scissorCached.x!==0||this._scissorCached.y!==0||this._scissorCached.z!==0||this._scissorCached.w!==0}enableScissor(e,t,i,r){this._scissorCached.x=e,this._scissorCached.y=t,this._scissorCached.z=i,this._scissorCached.w=r}disableScissor(){this._scissorCached.x=this._scissorCached.y=this._scissorCached.z=this._scissorCached.w=0,this._scissorsCurrent.x=this._scissorsCurrent.y=this._scissorsCurrent.w=this._scissorsCurrent.h=0}_mustUpdateStencilRef(){const e=this._stencilStateComposer.funcRef!==this._stencilRefsCurrent;return e&&(this._stencilRefsCurrent=this._stencilStateComposer.funcRef),e}_applyStencilRef(e){e?e.addItem(new tu(this._stencilStateComposer.funcRef??0)):this._getCurrentRenderPass().setStencilReference(this._stencilStateComposer.funcRef??0)}_mustUpdateBlendColor(){const e=this._alphaState._blendConstants,t=e[0]!==this._blendColorsCurrent[0]||e[1]!==this._blendColorsCurrent[1]||e[2]!==this._blendColorsCurrent[2]||e[3]!==this._blendColorsCurrent[3];return t&&(this._blendColorsCurrent[0]=e[0],this._blendColorsCurrent[1]=e[1],this._blendColorsCurrent[2]=e[2],this._blendColorsCurrent[3]=e[3]),t}_applyBlendColor(e){e?e.addItem(new d_(this._alphaState._blendConstants.slice())):this._getCurrentRenderPass().setBlendConstant(this._alphaState._blendConstants)}_resetRenderPassStates(){this._viewportsCurrent.x=this._viewportsCurrent.y=this._viewportsCurrent.w=this._viewportsCurrent.h=0,this._scissorsCurrent.x=this._scissorsCurrent.y=this._scissorsCurrent.w=this._scissorsCurrent.h=0,this._stencilRefsCurrent=-1,this._blendColorsCurrent[0]=this._blendColorsCurrent[1]=this._blendColorsCurrent[2]=this._blendColorsCurrent[3]=null}clear(e,t,i,r=!1,n=0){e&&e.a===void 0&&(e.a=1),r&&(this._clearStencilValue=n);const a=this._scissorIsActive();this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&N.Log(["frame #"+this._count+" - clear - backBuffer=",t," depth=",i," stencil=",r," scissor is active=",a])),this._currentRenderTarget?a?(this._currentRenderPass||this._startRenderTargetRenderPass(this._currentRenderTarget,!1,t?e:null,i,r),this._applyScissor(this.compatibilityMode?null:this._bundleList),this._clearFullQuad(t?e:null,i,r)):(this._currentRenderPass&&this._endCurrentRenderPass(),this._startRenderTargetRenderPass(this._currentRenderTarget,!0,t?e:null,i,r)):((!this._currentRenderPass||!a)&&this._startMainRenderPass(!a,t?e:null,i,r),a&&(this._applyScissor(this.compatibilityMode?null:this._bundleList),this._clearFullQuad(t?e:null,i,r)))}_clearFullQuad(e,t,i){const r=this.compatibilityMode?this._getCurrentRenderPass():null;this._clearQuad.setColorFormat(this._colorFormat),this._clearQuad.setDepthStencilFormat(this._depthTextureFormat),this._clearQuad.setMRTAttachments(this._cacheRenderPipeline.mrtAttachments??[],this._cacheRenderPipeline.mrtTextureArray??[],this._cacheRenderPipeline.mrtTextureCount),this.compatibilityMode?r.setStencilReference(this._clearStencilValue):this._bundleList.addItem(new tu(this._clearStencilValue));const n=this._clearQuad.clear(r,e,t,i,this.currentSampleCount);this.compatibilityMode?this._applyStencilRef(null):(this._bundleList.addBundle(n),this._applyStencilRef(this._bundleList),this._reportDrawCall())}createVertexBuffer(e,t,i){let r;return e instanceof Array?r=new Float32Array(e):e instanceof ArrayBuffer?r=new Uint8Array(e):r=e,this._bufferManager.createBuffer(r,$e.Vertex|$e.CopyDst|$e.Storage,i)}createDynamicVertexBuffer(e,t){return this.createVertexBuffer(e,void 0,t)}createIndexBuffer(e,t,i){let r=!0,n;if(e instanceof Uint32Array||e instanceof Int32Array)n=e;else if(e instanceof Uint16Array)n=e,r=!1;else{for(let o=0;o<e.length;o++)if(e[o]>65535){n=new Uint32Array(e);break}n||(n=new Uint16Array(e),r=!1)}const a=this._bufferManager.createBuffer(n,$e.Index|$e.CopyDst|$e.Storage,i);return a.is32Bits=r,a}updateDynamicIndexBuffer(e,t,i=0){const r=e;let n;e.is32Bits?n=t instanceof Uint32Array?t:new Uint32Array(t):n=t instanceof Uint16Array?t:new Uint16Array(t),this._bufferManager.setSubData(r,i,n)}updateDynamicVertexBuffer(e,t,i,r){const n=e;i===void 0&&(i=0);let a;r===void 0?(t instanceof Array?a=new Float32Array(t):t instanceof ArrayBuffer?a=new Uint8Array(t):a=t,r=a.byteLength):t instanceof Array?a=new Float32Array(t):t instanceof ArrayBuffer?a=new Uint8Array(t):a=t,this._bufferManager.setSubData(n,i,a,0,r)}_createBuffer(e,t,i){let r;e instanceof Array?r=new Float32Array(e):e instanceof ArrayBuffer?r=new Uint8Array(e):r=e;let n=0;return t&1&&(n|=$e.CopySrc),t&2&&(n|=$e.CopyDst),t&4&&(n|=$e.Uniform),t&8&&(n|=$e.Vertex),t&16&&(n|=$e.Index),t&32&&(n|=$e.Storage),t&64&&(n|=$e.Indirect),this._bufferManager.createBuffer(r,n,i)}bindBuffersDirectly(){throw"Not implemented on WebGPU"}updateAndBindInstancesBuffer(){throw"Not implemented on WebGPU"}unbindInstanceAttributes(){}bindBuffers(e,t,i,r){this._currentVertexBuffers=e,this._currentIndexBuffer=t,this._currentOverrideVertexBuffers=r??null,this._cacheRenderPipeline.setBuffers(this._currentVertexBuffers,this._currentIndexBuffer,this._currentOverrideVertexBuffers)}_releaseBuffer(e){return this._bufferManager.releaseBuffer(e)}createUniformBuffer(e,t){let i;return e instanceof Array?i=new Float32Array(e):i=e,this._bufferManager.createBuffer(i,$e.Uniform|$e.CopyDst,t)}createDynamicUniformBuffer(e,t){return this.createUniformBuffer(e,t)}updateUniformBuffer(e,t,i,r){i===void 0&&(i=0);const n=e;let a;r===void 0?(t instanceof Float32Array?a=t:a=new Float32Array(t),r=a.byteLength):t instanceof Float32Array?a=t:a=new Float32Array(t),this._bufferManager.setSubData(n,i,a,0,r)}bindUniformBufferBase(e,t,i){this._currentDrawContext.setBuffer(i,e)}bindUniformBlock(){}createEffect(e,t,i,r,n,a,o,l,c,u=0,h){const d=typeof e=="string"?e:e.vertexToken||e.vertexSource||e.vertexElement||e.vertex,f=typeof e=="string"?e:e.fragmentToken||e.fragmentSource||e.fragmentElement||e.fragment,m=this._getGlobalDefines(),g=t.attributes!==void 0;let v=n??t.defines??"";m&&(v+=`
`+m);const E=d+"+"+f+"@"+v;if(this._compiledEffects[E]){const C=this._compiledEffects[E];return o&&C.isReady()&&o(C),C._refCount++,C}const T=new jr(e,t,g?this:i,r,this,n,a,o,l,c,E,t.shaderLanguage??u,t.extraInitializationsAsync??h);return this._compiledEffects[E]=T,T}_compileRawShaderToSpirV(e,t){return this._glslang.compileGLSL(e,t)}_compileShaderToSpirV(e,t,i,r){return this._compileRawShaderToSpirV(r+(i?i+`
`:"")+e,t)}_getWGSLShader(e,t,i){return i?i="//"+i.split(`
`).join(`
//`)+`
`:i="",i+e}_createPipelineStageDescriptor(e,t,i,r,n){return this._tintWASM&&i===0&&(e=this._tintWASM.convertSpirV2WGSL(e,r),t=this._tintWASM.convertSpirV2WGSL(t,n)),{vertexStage:{module:this._device.createShaderModule({label:"vertex",code:e}),entryPoint:"main"},fragmentStage:{module:this._device.createShaderModule({label:"fragment",code:t}),entryPoint:"main"}}}_compileRawPipelineStageDescriptor(e,t,i){const r=e.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,n=t.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,a=i===0?this._compileRawShaderToSpirV(e,"vertex"):e,o=i===0?this._compileRawShaderToSpirV(t,"fragment"):t;return this._createPipelineStageDescriptor(a,o,i,r,n)}_compilePipelineStageDescriptor(e,t,i,r){this.onBeforeShaderCompilationObservable.notifyObservers(this);const n=e.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,a=t.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,o=`#version 450
`,l=r===0?this._compileShaderToSpirV(e,"vertex",i,o):this._getWGSLShader(e,"vertex",i),c=r===0?this._compileShaderToSpirV(t,"fragment",i,o):this._getWGSLShader(t,"fragment",i),u=this._createPipelineStageDescriptor(l,c,r,n,a);return this.onAfterShaderCompilationObservable.notifyObservers(this),u}createRawShaderProgram(){throw"Not available on WebGPU"}createShaderProgram(){throw"Not available on WebGPU"}inlineShaderCode(e){const t=new va(e);return t.debug=!1,t.processCode(),t.code}createPipelineContext(e){return new ow(e,this)}createMaterialContext(){return new ih}createDrawContext(){return new rh(this._bufferManager,this._dummyIndexBuffer)}async _preparePipelineContextAsync(e,t,i,r,n,a,o,l,c,u,h){const d=e,f=d.shaderProcessingContext.shaderLanguage;f===0&&!this._glslangAndTintAreFullyLoaded&&await this.prepareGlslangAndTintAsync(),this.dbgShowShaderCode&&(N.Log(["defines",l]),N.Log(t),N.Log(i),N.Log("***********************************************")),d.sources={fragment:i,vertex:t,rawVertex:n,rawFragment:a},r?d.stages=this._compileRawPipelineStageDescriptor(t,i,f):d.stages=this._compilePipelineStageDescriptor(t,i,l,f),h()}getAttributes(e,t){const i=new Array(t.length),r=e;for(let n=0;n<t.length;n++){const a=t[n],o=r.shaderProcessingContext.availableAttributes[a];o!==void 0&&(i[n]=o)}return i}enableEffect(e){if(e){if(!_D(e))this._currentEffect=e,this._currentMaterialContext=this._defaultMaterialContext,this._currentDrawContext=this._defaultDrawContext,this._counters.numEnableEffects++,this.dbgLogIfNotDrawWrapper&&N.Warn(`enableEffect has been called with an Effect and not a Wrapper! effect.uniqueId=${e.uniqueId}, effect.name=${e.name}, effect.name.vertex=${typeof e.name=="string"?"":e.name.vertex}, effect.name.fragment=${typeof e.name=="string"?"":e.name.fragment}`,10);else if(!e.effect||e.effect===this._currentEffect&&e.materialContext===this._currentMaterialContext&&e.drawContext===this._currentDrawContext&&!this._forceEnableEffect){if(!e.effect&&this.dbgShowEmptyEnableEffectCalls)throw N.Log(["drawWrapper=",e]),"Invalid call to enableEffect: the effect property is empty!";return}else if(this._currentEffect=e.effect,this._currentMaterialContext=e.materialContext,this._currentDrawContext=e.drawContext,this._counters.numEnableDrawWrapper++,!this._currentMaterialContext)throw N.Log(["drawWrapper=",e]),"Invalid call to enableEffect: the materialContext property is empty!";this._stencilStateComposer.stencilMaterial=void 0,this._forceEnableEffect=!1,this._currentEffect.onBind&&this._currentEffect.onBind(this._currentEffect),this._currentEffect._onBindObservable&&this._currentEffect._onBindObservable.notifyObservers(this._currentEffect)}}_releaseEffect(e){this._compiledEffects[e._key]&&(delete this._compiledEffects[e._key],this._deletePipelineContext(e.getPipelineContext()))}releaseEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(t)}this._compiledEffects={},this.onReleaseEffectsObservable.notifyObservers(this)}_deletePipelineContext(e){const t=e;t&&gD(t)}get needPOTTextures(){return!1}_createHardwareTexture(){return new Gc(this)}_releaseTexture(e){const t=this._internalTexturesCache.indexOf(e);t!==-1&&this._internalTexturesCache.splice(t,1),this._textureHelper.releaseTexture(e)}_getRGBABufferInternalSizedFormat(){return 5}updateTextureComparisonFunction(e,t){e._comparisonFunction=t}_createInternalTexture(e,t,i=!0,r=0){const n={};t!==void 0&&typeof t=="object"?(n.generateMipMaps=t.generateMipMaps,n.createMipMaps=t.createMipMaps,n.type=t.type===void 0?0:t.type,n.samplingMode=t.samplingMode===void 0?3:t.samplingMode,n.format=t.format===void 0?5:t.format,n.samples=t.samples??1,n.creationFlags=t.creationFlags??0,n.useSRGBBuffer=t.useSRGBBuffer??!1,n.label=t.label):(n.generateMipMaps=t,n.type=0,n.samplingMode=3,n.format=5,n.samples=1,n.creationFlags=0,n.useSRGBBuffer=!1),(n.type===1&&!this._caps.textureFloatLinearFiltering||n.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(n.samplingMode=1),n.type===1&&!this._caps.textureFloat&&(n.type=0,N.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const a=new $t(this,r),o=e.width??e,l=e.height??e,c=e.depth??0,u=e.layers??0;if(a.baseWidth=o,a.baseHeight=l,a.width=o,a.height=l,a.depth=c||u,a.isReady=!0,a.samples=n.samples,a.generateMipMaps=!!n.generateMipMaps,a.samplingMode=n.samplingMode,a.type=n.type,a.format=n.format,a.is2DArray=u>0,a.is3D=c>0,a._cachedWrapU=0,a._cachedWrapV=0,a._useSRGBBuffer=n.useSRGBBuffer,a.label=n.label,this._internalTexturesCache.push(a),!i){const h=!n.generateMipMaps&&n.createMipMaps;h&&(a.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(a,o,l,u||1,n.creationFlags),h&&(a.generateMipMaps=!1)}return a}createTexture(e,t,i,r,n=3,a=null,o=null,l=null,c=null,u=null,h=null,d,f,m,g){return this._createTextureBase(e,t,i,r,n,a,o,(v,E,T,C,A,I,F,V)=>{var w;const D=C;if(v.baseWidth=D.width,v.baseHeight=D.height,v.width=D.width,v.height=D.height,v.format=v.format!==-1?v.format:u??5,v.type=v.type!==-1?v.type:0,v._creationFlags=m??0,V(v.width,v.height,D,E,v,()=>{}),(w=v._hardwareTexture)!=null&&w.underlyingResource)!I&&!F&&this._generateMipmaps(v,this._uploadEncoder);else{const B=this._textureHelper.createGPUTextureForInternalTexture(v,D.width,D.height,void 0,m);Qe.IsImageBitmap(D)&&(this._textureHelper.updateTexture(D,v,D.width,D.height,v.depth,B.format,0,0,A,!1,0,0),!I&&!F&&this._generateMipmaps(v,this._uploadEncoder))}T&&T.removePendingData(v),v.isReady=!0,v.onLoadedObservable.notifyObservers(v),v.onLoadedObservable.clear()},()=>!1,l,c,u,h,d,f,g)}wrapWebGPUTexture(e){const t=new Gc(this,e),i=new $t(this,0,!0);return i._hardwareTexture=t,i.isReady=!0,i}wrapWebGLTexture(){throw new Error("wrapWebGLTexture is not supported, use wrapWebGPUTexture instead.")}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers}_unpackFlipY(e){}updateTextureSamplingMode(e,t,i=!1){i&&(t.generateMipMaps=!0,this._generateMipmaps(t)),t.samplingMode=e}updateTextureWrappingMode(e,t,i=null,r=null){t!==null&&(e._cachedWrapU=t),i!==null&&(e._cachedWrapV=i),(e.is2DArray||e.is3D)&&r!==null&&(e._cachedWrapR=r)}updateTextureDimensions(e,t,i,r=1){if(!e._hardwareTexture||e.width===t&&e.height===i&&e.depth===r)return;const n=e._hardwareTexture.textureAdditionalUsages;e._hardwareTexture.release(),this._textureHelper.createGPUTextureForInternalTexture(e,t,i,r,n)}_setInternalTexture(e,t,i){if(i=i??e,this._currentEffect){const n=this._currentEffect._pipelineContext.shaderProcessingContext.availableTextures[i];if(this._currentMaterialContext.setTexture(e,t),n&&n.autoBindSampler){const a=i+"Sampler";this._currentMaterialContext.setSampler(a,t)}}}createPrefilteredCubeTexture(e,t,i,r,n=null,a=null,o,l=null,c=!0){const u=h=>{if(!h){n&&n(null);return}const d=h.texture;c?h.info.sphericalPolynomial&&(d._sphericalPolynomial=h.info.sphericalPolynomial):d._sphericalPolynomial=new aI,d._source=9,n&&n(d)};return this.createCubeTexture(e,t,null,!1,u,a,o,l,c,i,r)}setTexture(e,t,i,r){this._setTexture(e,i,!1,!1,r,r)}setTextureArray(e,t,i,r){for(let n=0;n<i.length;n++)this._setTexture(-1,i[n],!0,!1,r+n.toString(),r)}_setTexture(e,t,i=!1,r=!1,n="",a){if(a=a??n,this._currentEffect){if(!t)return this._currentMaterialContext.setTexture(n,null),!1;if(t.video)t.update();else if(t.delayLoadState===4)return t.delayLoad(),!1;let o=null;if(r?o=t.depthStencilTexture:t.isReady()?o=t.getInternalTexture():t.isCube?o=this.emptyCubeTexture:t.is3D?o=this.emptyTexture3D:t.is2DArray?o=this.emptyTexture2DArray:o=this.emptyTexture,o&&!o.isMultiview){if(o.isCube&&o._cachedCoordinatesMode!==t.coordinatesMode){o._cachedCoordinatesMode=t.coordinatesMode;const l=t.coordinatesMode!==3&&t.coordinatesMode!==5?1:0;t.wrapU=l,t.wrapV=l}o._cachedWrapU=t.wrapU,o._cachedWrapV=t.wrapV,o.is3D&&(o._cachedWrapR=t.wrapR),this._setAnisotropicLevel(0,o,t.anisotropicFilteringLevel)}this._setInternalTexture(n,o,a)}else this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&N.Log(["frame #"+this._count+" - _setTexture called with a null _currentEffect! texture=",t]));return!0}_setAnisotropicLevel(e,t,i){t._cachedAnisotropicFilteringLevel!==i&&(t._cachedAnisotropicFilteringLevel=Math.min(i,this._caps.maxAnisotropy))}_bindTexture(e,t,i){e!==void 0&&this._setInternalTexture(i,t)}generateMipmaps(e){this._generateMipmaps(e)}updateTextureData(e,t,i,r,n,a,o=0,l=0,c=!1){var d;let u=e._hardwareTexture;(d=e._hardwareTexture)!=null&&d.underlyingResource||(u=this._textureHelper.createGPUTextureForInternalTexture(e));const h=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(h,e,n,a,e.depth,u.format,o,l,e.invertY,!1,i,r),c&&this._generateMipmaps(e)}_uploadCompressedDataToTextureDirectly(e,t,i,r,n,a=0,o=0){var u;let l=e._hardwareTexture;(u=e._hardwareTexture)!=null&&u.underlyingResource||(e.format=t,l=this._textureHelper.createGPUTextureForInternalTexture(e,i,r));const c=new Uint8Array(n.buffer,n.byteOffset,n.byteLength);this._textureHelper.updateTexture(c,e,i,r,e.depth,l.format,a,o,!1,!1,0,0)}_uploadDataToTextureDirectly(e,t,i=0,r=0,n,a=!1){var f;const o=Math.round(Math.log(e.width)*Math.LOG2E),l=Math.round(Math.log(e.height)*Math.LOG2E),c=a?e.width:Math.pow(2,Math.max(o-r,0)),u=a?e.height:Math.pow(2,Math.max(l-r,0));let h=e._hardwareTexture;(f=e._hardwareTexture)!=null&&f.underlyingResource||(h=this._textureHelper.createGPUTextureForInternalTexture(e,c,u));const d=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(d,e,c,u,e.depth,h.format,i,r,e.invertY,!1,0,0)}_uploadArrayBufferViewToTexture(e,t,i=0,r=0){this._uploadDataToTextureDirectly(e,t,i,r)}_uploadImageToTexture(e,t,i=0,r=0){var c;let n=e._hardwareTexture;if((c=e._hardwareTexture)!=null&&c.underlyingResource||(n=this._textureHelper.createGPUTextureForInternalTexture(e)),t instanceof HTMLImageElement)throw"WebGPU engine: HTMLImageElement not supported in _uploadImageToTexture!";const a=t,o=Math.ceil(e.width/(1<<r)),l=Math.ceil(e.height/(1<<r));this._textureHelper.updateTexture(a,e,o,l,e.depth,n.format,i,r,e.invertY,!1,0,0)}readPixels(e,t,i,r,n=!0,a=!0,o=null){const c=this._getCurrentRenderPassWrapper().colorAttachmentGPUTextures[0];if(!c)return Promise.resolve(new Uint8Array(0));const u=c.underlyingResource,h=c.format;return u?(a&&this.flushFramebuffer(),this._textureHelper.readPixels(u,e,t,i,r,h,void 0,void 0,o)):Promise.resolve(new Uint8Array(0))}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}get performanceMonitor(){return this._performanceMonitor}beginFrame(){this._measureFps(),super.beginFrame()}endFrame(){if(this._endCurrentRenderPass(),this._snapshotRendering.endFrame(),this._timestampQuery.endFrame(this._renderEncoder),this._timestampIndex=0,this.flushFramebuffer(),this._textureHelper.destroyDeferredTextures(),this._bufferManager.destroyDeferredBuffers(),this._features._collectUbosUpdatedInFrame){if(this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){const e=[];for(const t in hn._UpdatedUbosInFrame)e.push(t+":"+hn._UpdatedUbosInFrame[t]);N.Log(["frame #"+this._count+" - updated ubos -",e.join(", ")])}hn._UpdatedUbosInFrame={}}this.countersLastFrame.numEnableEffects=this._counters.numEnableEffects,this.countersLastFrame.numEnableDrawWrapper=this._counters.numEnableDrawWrapper,this.countersLastFrame.numBundleCreationNonCompatMode=this._counters.numBundleCreationNonCompatMode,this.countersLastFrame.numBundleReuseNonCompatMode=this._counters.numBundleReuseNonCompatMode,this._counters.numEnableEffects=0,this._counters.numEnableDrawWrapper=0,this._counters.numBundleCreationNonCompatMode=0,this._counters.numBundleReuseNonCompatMode=0,this._cacheRenderPipeline.endFrame(),this._cacheBindGroups.endFrame(),this._pendingDebugCommands.length=0,this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),this._count<this.dbgVerboseLogsNumFrames&&N.Log(["%c frame #"+this._count+" - end","background: #ffff00"]),this._count<this.dbgVerboseLogsNumFrames&&(this._count++,this._count!==this.dbgVerboseLogsNumFrames&&N.Log(["%c frame #"+this._count+" - begin","background: #ffff00"]))),super.endFrame()}extractDriverInfo(){return""}flushFramebuffer(){this._endCurrentRenderPass(),this._commandBuffers[0]=this._uploadEncoder.finish(),this._commandBuffers[1]=this._renderEncoder.finish(),this._device.queue.submit(this._commandBuffers),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._timestampQuery.startFrame(this._uploadEncoder),this._textureHelper.setCommandEncoder(this._uploadEncoder),this._bundleList.reset()}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentPassIsMainPass()}_startRenderTargetRenderPass(e,t,i,r,n){var C,A,I,F;this._endCurrentRenderPass();const a=e,o=a._depthStencilTexture,l=o==null?void 0:o._hardwareTexture,c=l==null?void 0:l.underlyingResource,u=l==null?void 0:l.getMSAATexture(0),h=c==null?void 0:c.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),d=u==null?void 0:u.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),f=l?Qe.HasStencilAspect(l.format):!1,m=[];this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();const g=Ww;i&&(g.r=i.r*255,g.g=i.g*255,g.b=i.b*255,g.a=i.a*255);const v=t&&i,E=t&&r,T=t&&n;if(a._attachments&&a.isMulti){(!this._mrtAttachments||this._mrtAttachments.length===0)&&(this._mrtAttachments=a._defaultAttachments);for(let V=0;V<this._mrtAttachments.length;++V){const D=this._mrtAttachments[V],w=a.textures[V],B=w==null?void 0:w._hardwareTexture,Q=B==null?void 0:B.underlyingResource;if(B&&Q){const J=a.getBaseArrayLayer(V),re=B.getMSAATexture(J),ne={...this._rttRenderPassWrapper.colorAttachmentViewDescriptor,dimension:w.is3D?"3d":"2d",format:B.format,baseArrayLayer:J},fe={...this._rttRenderPassWrapper.colorAttachmentViewDescriptor,dimension:w.is3D?"3d":"2d",format:B.format,baseArrayLayer:0},be=w.type===7||w.type===5,Me=Q.createView(ne),ce=re==null?void 0:re.createView(fe);m.push({view:ce||Me,resolveTarget:re?Me:void 0,depthSlice:w.is3D?((C=a.layerIndices)==null?void 0:C[V])??0:void 0,clearValue:D!==0&&v?be?g:i:void 0,loadOp:D!==0&&v?"clear":"load",storeOp:"store"})}}this._cacheRenderPipeline.setMRT(a.textures,this._mrtAttachments.length),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)}else{const V=a.texture;if(V){const D=V._hardwareTexture,w=D.underlyingResource;let B;a.is3D&&(B=this._rttRenderPassWrapper.colorAttachmentViewDescriptor.baseArrayLayer,this._rttRenderPassWrapper.colorAttachmentViewDescriptor.baseArrayLayer=0);const Q=D.getMSAATexture(0),J=w.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor),re=Q==null?void 0:Q.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor),ne=V.type===7||V.type===5;m.push({view:re||J,resolveTarget:Q?J:void 0,depthSlice:B,clearValue:v?ne?g:i:void 0,loadOp:v?"clear":"load",storeOp:"store"})}else m.push(null)}if((A=this._debugPushGroup)==null||A.call(this,"render target pass"+(e.label?" ("+e.label+")":""),0),this._rttRenderPassWrapper.renderPassDescriptor={label:(e.label??"RTT")+" - RenderPass",colorAttachments:m,depthStencilAttachment:o&&c?{view:d||h,depthClearValue:E?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,depthLoadOp:a.depthReadOnly?void 0:E?"clear":"load",depthStoreOp:a.depthReadOnly?void 0:"store",depthReadOnly:a.depthReadOnly,stencilClearValue:a._depthStencilTextureWithStencil&&T?this._clearStencilValue:void 0,stencilLoadOp:a.stencilReadOnly?void 0:f?a._depthStencilTextureWithStencil&&T?"clear":"load":void 0,stencilStoreOp:a.stencilReadOnly?void 0:f?"store":void 0,stencilReadOnly:a.stencilReadOnly}:void 0,occlusionQuerySet:(I=this._occlusionQuery)!=null&&I.hasQueries?this._occlusionQuery.querySet:void 0},this._timestampQuery.startPass(this._rttRenderPassWrapper.renderPassDescriptor,this._timestampIndex),this._currentRenderPass=this._renderEncoder.beginRenderPass(this._rttRenderPassWrapper.renderPassDescriptor),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){const V=a.texture;N.Log(["frame #"+this._count+" - render target begin pass - rtt name="+e.label+", internalTexture.uniqueId="+V.uniqueId+", width="+V.width+", height="+V.height+", setClearStates="+t,"renderPassDescriptor=",this._rttRenderPassWrapper.renderPassDescriptor])}(F=this._debugFlushPendingCommands)==null||F.call(this),this._resetRenderPassStates(),(!l||!Qe.HasStencilAspect(l.format))&&(this._stencilStateComposer.enabled=!1)}_startMainRenderPass(e,t,i,r){var c,u,h;this._endCurrentRenderPass(),this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();const n=e&&t,a=e&&i,o=e&&r;this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].clearValue=n?t:void 0,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].loadOp=n?"clear":"load",this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthClearValue=a?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthLoadOp=a?"clear":"load",this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilClearValue=o?this._clearStencilValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilLoadOp=this.isStencilEnable?o?"clear":"load":void 0,this._mainRenderPassWrapper.renderPassDescriptor.occlusionQuerySet=(c=this._occlusionQuery)!=null&&c.hasQueries?this._occlusionQuery.querySet:void 0;const l=this._context.getCurrentTexture();this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].set(l),this._options.antialias?(tv.format=l.format,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].resolveTarget=l.createView(tv)):(iv.format=l.format,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].view=l.createView(iv)),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&N.Log(["frame #"+this._count+" - main begin pass - texture width="+this._mainTextureExtends.width," height="+this._mainTextureExtends.height+", setClearStates="+e,"renderPassDescriptor=",this._mainRenderPassWrapper.renderPassDescriptor])),(u=this._debugPushGroup)==null||u.call(this,"main pass",0),this._timestampQuery.startPass(this._mainRenderPassWrapper.renderPassDescriptor,this._timestampIndex),this._currentRenderPass=this._renderEncoder.beginRenderPass(this._mainRenderPassWrapper.renderPassDescriptor),this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper),(h=this._debugFlushPendingCommands)==null||h.call(this),this._resetRenderPassStates(),this._isStencilEnable||(this._stencilStateComposer.enabled=!1)}bindFramebuffer(e,t=0,i,r,n,a=0,o=0){var u,h;const l=(u=e.texture)==null?void 0:u._hardwareTexture;this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass(),this._currentRenderTarget=e;const c=this._currentRenderTarget._depthStencilTexture;this._rttRenderPassWrapper.colorAttachmentGPUTextures[0]=l,this._rttRenderPassWrapper.depthTextureFormat=c?Qe.GetWebGPUTextureFormat(-1,c.format):void 0,this._setDepthTextureFormat(this._rttRenderPassWrapper),this._setColorFormat(this._rttRenderPassWrapper),this._rttRenderPassWrapper.colorAttachmentViewDescriptor={format:this._colorFormat,dimension:e.is3D?"3d":"2d",mipLevelCount:1,baseArrayLayer:e.isCube?o*6+t:o,baseMipLevel:a,arrayLayerCount:1,aspect:"all"},this._rttRenderPassWrapper.depthAttachmentViewDescriptor={format:this._depthTextureFormat,dimension:c&&c.is3D?"3d":"2d",mipLevelCount:1,baseArrayLayer:c?c.isCube?o*6+t:o:0,baseMipLevel:0,arrayLayerCount:1,aspect:"all"},this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&N.Log(["frame #"+this._count+" - bindFramebuffer - rtt name="+e.label+", internalTexture.uniqueId="+((h=e.texture)==null?void 0:h.uniqueId)+", face="+t+", lodLevel="+a+", layer="+o,"colorAttachmentViewDescriptor=",this._rttRenderPassWrapper.colorAttachmentViewDescriptor,"depthAttachmentViewDescriptor=",this._rttRenderPassWrapper.depthAttachmentViewDescriptor])),(this._snapshotRendering.play||this._snapshotRendering.record)&&this._startRenderTargetRenderPass(this._currentRenderTarget,!1,null,!1,!1),this._cachedViewport&&!n?this.setViewport(this._cachedViewport,i,r):(i||(i=e.width,a&&(i=i/Math.pow(2,a))),r||(r=e.height,a&&(r=r/Math.pow(2,a))),this._viewport(0,0,i,r)),this.wipeCaches()}unBindFramebuffer(e,t=!1,i){var n;const r=this._currentRenderTarget;this._currentRenderTarget=null,i&&i(),this._currentRenderTarget=r,this._endCurrentRenderPass(),t||(e.isMulti?this.generateMipMapsMultiFramebuffer(e):this.generateMipMapsFramebuffer(e)),this._currentRenderTarget=null,this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&N.Log("frame #"+this._count+" - unBindFramebuffer - rtt name="+e.label+", internalTexture.uniqueId=",(n=e.texture)==null?void 0:n.uniqueId)),this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)}generateMipMapsFramebuffer(e){var t;!e.isMulti&&((t=e.texture)!=null&&t.generateMipMaps)&&!e.isCube&&this._generateMipmaps(e.texture)}resolveFramebuffer(e){throw new Error("resolveFramebuffer is not yet implemented in WebGPU!")}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._currentRenderPass||this._startMainRenderPass(!1),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_setColorFormat(e){var i;const t=((i=e.colorAttachmentGPUTextures[0])==null?void 0:i.format)??null;this._cacheRenderPipeline.setColorFormat(t),this._colorFormat!==t&&(this._colorFormat=t)}_setDepthTextureFormat(e){this._cacheRenderPipeline.setDepthStencilFormat(e.depthTextureFormat),this._depthTextureFormat!==e.depthTextureFormat&&(this._depthTextureFormat=e.depthTextureFormat)}setDitheringState(){}setRasterizerState(){}_executeWhenRenderingStateIsCompiled(e,t){t()}bindSamplers(){}_getUnpackAlignement(){return 1}_bindTextureDirectly(){return!1}setStateCullFaceType(e,t=!1){const i=this.cullBackFaces??e??!0?1:2;(this._depthCullingState.cullFace!==i||t)&&(this._depthCullingState.cullFace=i)}setState(e,t=0,i,r=!1,n,a,o=0){(this._depthCullingState.cull!==e||i)&&(this._depthCullingState.cull=e),this.setStateCullFaceType(n,i),this.setZOffset(t),this.setZOffsetUnits(o);const l=r?this._currentRenderTarget?1:2:this._currentRenderTarget?2:1;(this._depthCullingState.frontFace!==l||i)&&(this._depthCullingState.frontFace=l),this._stencilStateComposer.stencilMaterial=a}_applyRenderPassChanges(e){const t=this._stencilStateComposer.enabled?this._mustUpdateStencilRef():!1,i=this._alphaState.alphaBlend?this._mustUpdateBlendColor():!1;this._mustUpdateViewport()&&this._applyViewport(e),this._mustUpdateScissor()&&this._applyScissor(e),t&&this._applyStencilRef(e),i&&this._applyBlendColor(e)}_draw(e,t,i,r,n){var v;const a=this._getCurrentRenderPass(),o=this._bundleList;this.applyStates();const l=this._currentEffect._pipelineContext;if(this.bindUniformBufferBase(this._currentRenderTarget?this._ubInvertY:this._ubDontInvertY,0,jt.InternalsUBOName),this._currentDrawContext.setVertexPulling(this._currentMaterialContext.useVertexPulling,l,this._currentVertexBuffers,this._cacheRenderPipeline.indexBuffer,this._currentOverrideVertexBuffers),l.uniformBuffer&&(l.uniformBuffer.update(),this.bindUniformBufferBase(l.uniformBuffer.getBuffer(),0,jt.LeftOvertUBOName)),this._snapshotRendering.play){this._reportDrawCall();return}!this.compatibilityMode&&(this._currentDrawContext.isDirty(this._currentMaterialContext.updateId)||this._currentMaterialContext.isDirty||this._currentMaterialContext.forceBindGroupCreation)&&(this._currentDrawContext.fastBundle=void 0);const c=!this.compatibilityMode&&this._currentDrawContext.fastBundle;let u=a;if(c||this._snapshotRendering.record){if(this._applyRenderPassChanges(o),!this._snapshotRendering.record){this._counters.numBundleReuseNonCompatMode++,this._currentDrawContext.indirectDrawBuffer&&this._currentDrawContext.setIndirectData(r,n||1,i),o.addBundle(this._currentDrawContext.fastBundle),this._reportDrawCall();return}u=o.getBundleEncoder(this._cacheRenderPipeline.colorFormats,this._depthTextureFormat,this.currentSampleCount),o.numDrawCalls++}let h=0;if(this._currentMaterialContext.hasFloatOrDepthTextures){let E=1;for(let T=0;T<l.shaderProcessingContext.textureNames.length;++T){const C=l.shaderProcessingContext.textureNames[T],A=(v=this._currentMaterialContext.textures[C])==null?void 0:v.texture,I=A&&A.format>=13&&A.format<=18;((A==null?void 0:A.type)===1&&!this._caps.textureFloatLinearFiltering||I)&&(h|=E),E=E<<1}}this._currentMaterialContext.textureState=h;const d=this._cacheRenderPipeline.getRenderPipeline(t,this._currentEffect,this.currentSampleCount,h),f=this._cacheBindGroups.getBindGroups(l,this._currentDrawContext,this._currentMaterialContext);this._snapshotRendering.record||(this._applyRenderPassChanges(this.compatibilityMode?null:o),this.compatibilityMode||(this._counters.numBundleCreationNonCompatMode++,u=this._device.createRenderBundleEncoder({colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:Qe.GetSample(this.currentSampleCount)}))),u.setPipeline(d),this._currentIndexBuffer&&u.setIndexBuffer(this._currentIndexBuffer.underlyingResource,this._currentIndexBuffer.is32Bits?"uint32":"uint16",0);const m=this._cacheRenderPipeline.vertexBuffers;for(let E=0;E<m.length;E++){const T=m[E],C=T.effectiveBuffer;C&&u.setVertexBuffer(E,C.underlyingResource,T._validOffsetRange?0:T.byteOffset)}for(let E=0;E<f.length;E++)u.setBindGroup(E,f[E]);const g=!this.compatibilityMode&&!this._snapshotRendering.record;(g||this._currentDrawContext._enableIndirectDrawInCompatMode)&&this._currentDrawContext.indirectDrawBuffer?(this._currentDrawContext.setIndirectData(r,n||1,i),e===0?u.drawIndexedIndirect(this._currentDrawContext.indirectDrawBuffer,0):u.drawIndirect(this._currentDrawContext.indirectDrawBuffer,0)):e===0?u.drawIndexed(r,n||1,i,0,0):u.draw(r,n||1,i,0),g&&(this._currentDrawContext.fastBundle=u.finish(),o.addBundle(this._currentDrawContext.fastBundle)),this._reportDrawCall()}drawElementsType(e,t,i,r=1){this._draw(0,e,t,i,r)}drawArraysType(e,t,i,r=1){this._currentIndexBuffer=null,this._draw(1,e,t,i,r)}dispose(){var e,t;this._isDisposed=!0,this.hideLoadingUI(),this._timestampQuery.dispose(),(e=this._mainTexture)==null||e.destroy(),(t=this._depthTexture)==null||t.destroy(),this._textureHelper.destroyDeferredTextures(),this._bufferManager.destroyDeferredBuffers(),this._device.destroy(),SD(this,this._renderingCanvas),super.dispose()}getRenderWidth(e=!1){var t;return!e&&this._currentRenderTarget?this._currentRenderTarget.width:((t=this._renderingCanvas)==null?void 0:t.width)??0}getRenderHeight(e=!1){var t;return!e&&this._currentRenderTarget?this._currentRenderTarget.height:((t=this._renderingCanvas)==null?void 0:t.height)??0}getError(){return 0}createExternalTexture(e){return new Gw(e)}setExternalTexture(e,t){if(!t){this._currentMaterialContext.setTexture(e,null);return}this._setInternalTexture(e,t)}setTextureSampler(e,t){var i;(i=this._currentMaterialContext)==null||i.setSampler(e,t)}createStorageBuffer(e,t,i){return this._createBuffer(e,t|32,i)}clearStorageBuffer(e,t,i){this._renderEncoder.clearBuffer(e.underlyingResource,t,i)}updateStorageBuffer(e,t,i,r){const n=e;i===void 0&&(i=0);let a;r===void 0?(t instanceof Array?a=new Float32Array(t):t instanceof ArrayBuffer?a=new Uint8Array(t):a=t,r=a.byteLength):t instanceof Array?a=new Float32Array(t):t instanceof ArrayBuffer?a=new Uint8Array(t):a=t,this._bufferManager.setSubData(n,i,a,0,r)}async _readFromGPUBuffer(e,t,i,r){return await new Promise((n,a)=>{const o=()=>{e.mapAsync(1,0,t).then(()=>{const l=e.getMappedRange(0,t);let c=i;if(c===void 0)c=new Uint8Array(t),c.set(new Uint8Array(l));else{const u=c.constructor;c=new u(c.buffer),c.set(new u(l))}e.unmap(),this._bufferManager.releaseBuffer(e),n(c)},l=>{this.isDisposed?n(new Uint8Array):a(l)})};r?(this.flushFramebuffer(),o()):this.onEndFrameObservable.addOnce(()=>{o()})})}readFromStorageBuffer(e,t,i,r,n){i=i||e.capacity;const a=this._bufferManager.createRawBuffer(i,$e.MapRead|$e.CopyDst,void 0,"TempReadFromStorageBuffer");return this._renderEncoder.copyBufferToBuffer(e.underlyingResource,t??0,a,0,i),this._readFromGPUBuffer(a,i,r,n)}readFromMultipleStorageBuffers(e,t,i,r,n){i=i||e[0].capacity;const a=this._bufferManager.createRawBuffer(i*e.length,$e.MapRead|$e.CopyDst,void 0,"TempReadFromMultipleStorageBuffers");for(let o=0;o<e.length;o++)this._renderEncoder.copyBufferToBuffer(e[o].underlyingResource,t??0,a,o*i,i);return this._readFromGPUBuffer(a,i*e.length,r,n)}setStorageBuffer(e,t){var i;(i=this._currentDrawContext)==null||i.setBuffer(e,(t==null?void 0:t.getBuffer())??null)}}ct._GlslangDefaultOptions={jsPath:`${j._DefaultCdnUrl}/glslang/glslang.js`,wasmPath:`${j._DefaultCdnUrl}/glslang/glslang.wasm`};ct._InstanceId=0;class sh{getBindGroups(e,t,i){if(!i)throw new Error("WebGPUComputeContext.getBindGroups: bindingsMapping is required until browsers support reflection for wgsl shaders!");if(this._bindGroups.length===0){const r=this._bindGroupEntries.length>0;for(const n in e){const a=e[n],o=i[n],l=o.group,c=o.binding,u=a.type,h=a.object;let d=a.indexInGroupEntries,f=this._bindGroupEntries[l];switch(f||(f=this._bindGroupEntries[l]=[]),u){case 5:{const m=h;d!==void 0&&r?f[d].resource=this._cacheSampler.getSampler(m):(a.indexInGroupEntries=f.length,f.push({binding:c,resource:this._cacheSampler.getSampler(m)}));break}case 0:case 4:{const m=h,g=m._texture._hardwareTexture;d!==void 0&&r?(u===0&&(f[d++].resource=this._cacheSampler.getSampler(m._texture)),f[d].resource=g.view):(a.indexInGroupEntries=f.length,u===0&&f.push({binding:c-1,resource:this._cacheSampler.getSampler(m._texture)}),f.push({binding:c,resource:g.view}));break}case 8:{const g=h._hardwareTexture;d!==void 0&&r?f[d].resource=g.view:(a.indexInGroupEntries=f.length,f.push({binding:c,resource:g.view}));break}case 1:{const m=h,g=m._texture._hardwareTexture;g.textureAdditionalUsages&8||N.Error(`computeDispatch: The texture (name=${m.name}, uniqueId=${m.uniqueId}) is not a storage texture!`,50),d!==void 0&&r?f[d].resource=g.viewForWriting:(a.indexInGroupEntries=f.length,f.push({binding:c,resource:g.viewForWriting}));break}case 6:{const g=h.underlyingResource;d!==void 0&&r?f[d].resource=this._device.importExternalTexture({source:g}):(a.indexInGroupEntries=f.length,f.push({binding:c,resource:this._device.importExternalTexture({source:g})}));break}case 2:case 3:case 7:{const m=u===7?h:h.getBuffer(),g=m.underlyingResource;d!==void 0&&r?(f[d].resource.buffer=g,f[d].resource.size=m.capacity):(a.indexInGroupEntries=f.length,f.push({binding:c,resource:{buffer:g,offset:0,size:m.capacity}}));break}}}for(let n=0;n<this._bindGroupEntries.length;++n){const a=this._bindGroupEntries[n];if(!a){this._bindGroups[n]=void 0;continue}this._bindGroups[n]=this._device.createBindGroup({layout:t.getBindGroupLayout(n),entries:a})}this._bindGroups.length=this._bindGroupEntries.length}return this._bindGroups}constructor(e,t){this._device=e,this._cacheSampler=t,this.uniqueId=sh._Counter++,this._bindGroupEntries=[],this.clear()}clear(){this._bindGroups=[]}}sh._Counter=0;class Hw{get isAsync(){return!1}get isReady(){return this.isAsync,!1}constructor(e){this._name="unnamed",this.engine=e}_getComputeShaderCode(){var e;return(e=this.sources)==null?void 0:e.compute}dispose(){}}const rv={};ct.prototype.createComputeContext=function(){return new sh(this._device,this._cacheSampler)};ct.prototype.createComputeEffect=function(s,e){const i=(typeof s=="string"?s:s.computeToken||s.computeSource||s.computeElement||s.compute)+"@"+e.defines;if(this._compiledComputeEffects[i]){const n=this._compiledComputeEffects[i];return e.onCompiled&&n.isReady()&&e.onCompiled(n),n}const r=new To(s,e,this,i);return this._compiledComputeEffects[i]=r,r};ct.prototype.createComputePipelineContext=function(){return new Hw(this)};ct.prototype.areAllComputeEffectsReady=function(){for(const s in this._compiledComputeEffects)if(!this._compiledComputeEffects[s].isReady())return!1;return!0};ct.prototype.computeDispatch=function(s,e,t,i,r=1,n=1,a,o){this._computeDispatch(s,e,t,i,r,n,void 0,void 0,a,o)};ct.prototype.computeDispatchIndirect=function(s,e,t,i,r=0,n,a){this._computeDispatch(s,e,t,void 0,void 0,void 0,i,r,n,a)};ct.prototype._computeDispatch=function(s,e,t,i,r,n,a,o,l,c){this._endCurrentRenderPass();const u=s._pipelineContext,h=e;u.computePipeline||(u.computePipeline=this._device.createComputePipeline({layout:"auto",compute:u.stage})),c&&this._timestampQuery.startPass(rv,this._timestampIndex);const d=this._renderEncoder.beginComputePass(rv);d.setPipeline(u.computePipeline);const f=h.getBindGroups(t,u.computePipeline,l);for(let m=0;m<f.length;++m){const g=f[m];g&&d.setBindGroup(m,g)}a!==void 0?d.dispatchWorkgroupsIndirect(a.underlyingResource,o):i+r+n>0&&d.dispatchWorkgroups(i,r,n),d.end(),c&&(this._timestampQuery.endPass(this._timestampIndex,c),this._timestampIndex+=2)};ct.prototype.releaseComputeEffects=function(){for(const s in this._compiledComputeEffects){const e=this._compiledComputeEffects[s].getPipelineContext();this._deleteComputePipelineContext(e)}this._compiledComputeEffects={}};ct.prototype._prepareComputePipelineContext=function(s,e,t,i,r){const n=s;this.dbgShowShaderCode&&(N.Log(i),N.Log(e)),n.sources={compute:e,rawCompute:t},n.stage=this._createComputePipelineStageDescriptor(e,i,r)};ct.prototype._releaseComputeEffect=function(s){this._compiledComputeEffects[s._key]&&(delete this._compiledComputeEffects[s._key],this._deleteComputePipelineContext(s.getPipelineContext()))};ct.prototype._rebuildComputeEffects=function(){for(const s in this._compiledComputeEffects){const e=this._compiledComputeEffects[s];e._pipelineContext=null,e._wasPreviouslyReady=!1,e._prepareEffect()}};ct.prototype._executeWhenComputeStateIsCompiled=function(s,e){s.stage.module.getCompilationInfo().then(t=>{const i={numErrors:0,messages:[]};for(const r of t.messages)r.type==="error"&&i.numErrors++,i.messages.push({type:r.type,text:r.message,line:r.lineNum,column:r.linePos,length:r.length,offset:r.offset});e(i)})};ct.prototype._deleteComputePipelineContext=function(s){s&&s.dispose()};ct.prototype._createComputePipelineStageDescriptor=function(s,e,t){return e?e="//"+e.split(`
`).join(`
//`)+`
`:e="",{module:this._device.createShaderModule({code:e+s}),entryPoint:t}};ct.prototype._debugPushGroup=function(s,e){this._options.enableGPUDebugMarkers&&(e===0||e===1?(e===1&&(this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass()),this._renderEncoder.pushDebugGroup(s)):this._currentRenderPass?(this._currentRenderPass.pushDebugGroup(s),this._debugStackRenderPass.push(s)):this._pendingDebugCommands.push(["push",s,e]))};ct.prototype._debugPopGroup=function(s){this._options.enableGPUDebugMarkers&&(s===0||s===1?(s===1&&(this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass()),this._renderEncoder.popDebugGroup()):this._currentRenderPass?(this._currentRenderPass.popDebugGroup(),this._debugStackRenderPass.pop()):this._pendingDebugCommands.push(["pop",null,s]))};ct.prototype._debugInsertMarker=function(s,e){this._options.enableGPUDebugMarkers&&(e===0||e===1?(e===1&&(this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass()),this._renderEncoder.insertDebugMarker(s)):this._currentRenderPass?this._currentRenderPass.insertDebugMarker(s):this._pendingDebugCommands.push(["insert",s,e]))};ct.prototype._debugFlushPendingCommands=function(){if(this._debugStackRenderPass.length!==0){const s=this._debugStackRenderPass.slice();this._debugStackRenderPass.length=0;for(let e=0;e<s.length;++e)this._debugPushGroup(s[e],2)}for(let s=0;s<this._pendingDebugCommands.length;++s){const[e,t,i]=this._pendingDebugCommands[s];switch(e){case"push":this._debugPushGroup(t,i);break;case"pop":this._debugPopGroup(i);break;case"insert":this._debugInsertMarker(t,i);break}}this._pendingDebugCommands.length=0};ct.prototype.createDynamicTexture=function(s,e,t,i){const r=new $t(this,4);return r.baseWidth=s,r.baseHeight=e,t&&(s=this.needPOTTextures?$n(s,this._caps.maxTextureSize):s,e=this.needPOTTextures?$n(e,this._caps.maxTextureSize):e),r.width=s,r.height=e,r.isReady=!1,r.generateMipMaps=t,r.samplingMode=i,this.updateTextureSamplingMode(i,r),this._internalTexturesCache.push(r),s&&e&&this._textureHelper.createGPUTextureForInternalTexture(r,s,e),r};ct.prototype.updateDynamicTexture=function(s,e,t,i=!1,r,n,a){var u;if(!s)return;const o=e.width,l=e.height;let c=s._hardwareTexture;(u=s._hardwareTexture)!=null&&u.underlyingResource||(c=this._textureHelper.createGPUTextureForInternalTexture(s,o,l)),this._textureHelper.updateTexture(e,s,o,l,s.depth,c.format,0,0,t,i,0,0,a),s.generateMipMaps&&this._generateMipmaps(s),s._dynamicTextureSource=e,s._premulAlpha=i,s.invertY=t||!1,s.isReady=!0};ct.prototype.unBindMultiColorAttachmentFramebuffer=function(s,e=!1,t){t&&t(),this._endCurrentRenderPass(),e||this.generateMipMapsMultiFramebuffer(s),this._currentRenderTarget=null,this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)};ct.prototype.createMultipleRenderTarget=function(s,e,t){let i=!1,r=!0,n=!1,a=!1,o=15,l=1,c=1;const u=0,h=3,d=!1,f=5,m=3553;let g=[],v=[],E=[],T=[],C=[],A=[],I=[],F=[],V=[],D=[],w=!1;const B=this._createHardwareRenderTargetWrapper(!0,!1,s);e!==void 0&&(i=e.generateMipMaps??!1,r=e.generateDepthBuffer??!0,n=e.generateStencilBuffer??!1,a=e.generateDepthTexture??!1,l=e.textureCount??1,o=e.depthTextureFormat??15,g=e.types||g,v=e.samplingModes||v,E=e.useSRGBBuffers||E,T=e.formats||T,C=e.targetTypes||C,A=e.faceIndex||A,I=e.layerIndex||I,F=e.layerCounts||F,V=e.labels||V,D=e.creationFlags||D,c=e.samples??c,w=e.dontCreateTextures??!1);const Q=s.width??s,J=s.height??s,re=[],ne=[],fe=[];B.label=(e==null?void 0:e.label)??"MultiRenderTargetWrapper",B._generateDepthBuffer=r,B._generateStencilBuffer=n,B._attachments=ne,B._defaultAttachments=fe;let be=null;(r||n||a)&&!w&&(a||(r&&n?o=13:r?o=14:o=19),be=B.createDepthStencilTexture(0,!1,n,1,o,B.label+"-DepthStencil"));const Me=e!==void 0&&typeof e=="object"&&e.createMipMaps&&!i;for(let ce=0;ce<l;ce++){let bt=v[ce]||h,Pt=g[ce]||u;const Yt=T[ce]||f,mt=(E[ce]||d)&&this._caps.supportSRGBBuffers,Ot=C[ce]||m,Wi=F[ce]??1,zr=D[ce];if((Pt===1&&!this._caps.textureFloatLinearFiltering||Pt===2&&!this._caps.textureHalfFloatLinearFiltering)&&(bt=1),Pt===1&&!this._caps.textureFloat&&(Pt=0,N.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),ne.push(ce+1),fe.push(t?ce+1:ce===0?1:0),Ot===-1||w)continue;const ut=new $t(this,6);switch(re[ce]=ut,Ot){case 34067:ut.isCube=!0;break;case 32879:ut.is3D=!0,ut.baseDepth=ut.depth=Wi;break;case 35866:ut.is2DArray=!0,ut.baseDepth=ut.depth=Wi;break}ut.baseWidth=Q,ut.baseHeight=J,ut.width=Q,ut.height=J,ut.isReady=!0,ut.samples=1,ut.generateMipMaps=i,ut.samplingMode=bt,ut.type=Pt,ut._cachedWrapU=0,ut._cachedWrapV=0,ut._useSRGBBuffer=mt,ut.format=Yt,ut.label=V[ce]??B.label+"-Texture"+ce,this._internalTexturesCache.push(ut),Me&&(ut.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(ut,void 0,void 0,void 0,zr,!0),Me&&(ut.generateMipMaps=!1)}return be&&(be.incrementReferences(),re[l]=be,this._internalTexturesCache.push(be)),B.setTextures(re),B.setLayerAndFaceIndices(I,A),w?B._samples=c:this.updateMultipleRenderTargetTextureSampleCount(B,c),B};ct.prototype.updateMultipleRenderTargetTextureSampleCount=function(s,e){if(!s||!s.textures||s.textures.length===0||s.textures[0].samples===e)return e;const t=s.textures.length;if(t===0)return 1;e=Math.min(e,this.getCaps().maxMSAASamples);for(let r=0;r<t;++r){const a=s.textures[r]._hardwareTexture;a==null||a.releaseMSAATexture(s.getBaseArrayLayer(r))}const i=s._depthStencilTexture===s.textures[t-1];for(let r=0;r<t;++r){const n=s.textures[r];this._textureHelper.createMSAATexture(n,e,!1,s.getBaseArrayLayer(r)),n.samples=e}return s._depthStencilTexture&&!i&&(this._textureHelper.createMSAATexture(s._depthStencilTexture,e),s._depthStencilTexture.samples=e),s._samples=e,e};ct.prototype.generateMipMapsMultiFramebuffer=function(s){const e=s;if(!e.isMulti)return;const i=e._attachments.length;for(let r=0;r<i;r++){const n=e.textures[r];n.generateMipMaps&&!n.isCube&&!n.is3D&&this._generateMipmaps(n)}};ct.prototype.resolveMultiFramebuffer=function(s){throw new Error("resolveMultiFramebuffer is not yet implemented in WebGPU!")};ct.prototype.bindAttachments=function(s){s.length===0||!this._currentRenderTarget||(this._mrtAttachments=s,this._currentRenderPass&&this._cacheRenderPipeline.setMRTAttachments(s))};ct.prototype.buildTextureLayout=function(s,e=!1){const t=[];if(e)t.push(1);else for(let i=0;i<s.length;i++)s[i]?t.push(i+1):t.push(0);return t};ct.prototype.restoreSingleAttachment=function(){};ct.prototype.restoreSingleAttachmentForRenderTarget=function(){};function $w(s){return!!(s&&s.underlyingResource!==void 0)}ct.prototype.updateVideoTexture=function(s,e,t){var r;if(!s||s._isDisabled)return;this._videoTextureSupported===void 0&&(this._videoTextureSupported=!0);let i=s._hardwareTexture;if((r=s._hardwareTexture)!=null&&r.underlyingResource||(i=this._textureHelper.createGPUTextureForInternalTexture(s)),$w(e)){if(e.isReady()){try{this._textureHelper.copyVideoToTexture(e,s,i.format,!t),s.generateMipMaps&&this._generateMipmaps(s)}catch{}s.isReady=!0}}else e&&this.createImageBitmap(e).then(n=>{this._textureHelper.updateTexture(n,s,s.width,s.height,s.depth,i.format,0,0,!t,!1,0,0),s.generateMipMaps&&this._generateMipmaps(s),s.isReady=!0}).catch(()=>{s.isReady=!0})};class Ue{constructor(e){this.value=this._toInt(e)}_toInt(e){return e|0}add(e){return new Ue(this.value+e.value)}subtract(e){return new Ue(this.value-e.value)}multiply(e){return new Ue(Math.imul(this.value,e.value))}divide(e){return new Ue(this.value/e.value)}getClassName(){return Ue.ClassName}equals(e){return this.value===e.value}static FromValue(e){return new Ue(e)}toString(){return this.value.toString()}}Ue.ClassName="FlowGraphInteger";y("FlowGraphInteger",Ue);class ir{constructor(e=[1,0,0,1]){this._m=e}get m(){return this._m}transformVector(e){return this.transformVectorToRef(e,new X)}transformVectorToRef(e,t){return t.x=e.x*this._m[0]+e.y*this._m[1],t.y=e.x*this._m[2]+e.y*this._m[3],t}asArray(){return this.toArray()}toArray(e=[]){for(let t=0;t<4;t++)e[t]=this._m[t];return e}fromArray(e){for(let t=0;t<4;t++)this._m[t]=e[t];return this}multiplyToRef(e,t){const i=e._m,r=this._m,n=t._m;return n[0]=i[0]*r[0]+i[1]*r[2],n[1]=i[0]*r[1]+i[1]*r[3],n[2]=i[2]*r[0]+i[3]*r[2],n[3]=i[2]*r[1]+i[3]*r[3],t}multiply(e){return this.multiplyToRef(e,new ir)}divideToRef(e,t){const i=this._m,r=e._m,n=t._m;return n[0]=i[0]/r[0],n[1]=i[1]/r[1],n[2]=i[2]/r[2],n[3]=i[3]/r[3],t}divide(e){return this.divideToRef(e,new ir)}addToRef(e,t){const i=this._m,r=e.m,n=t.m;return n[0]=i[0]+r[0],n[1]=i[1]+r[1],n[2]=i[2]+r[2],n[3]=i[3]+r[3],t}add(e){return this.addToRef(e,new ir)}subtractToRef(e,t){const i=this._m,r=e.m,n=t.m;return n[0]=i[0]-r[0],n[1]=i[1]-r[1],n[2]=i[2]-r[2],n[3]=i[3]-r[3],t}subtract(e){return this.subtractToRef(e,new ir)}transpose(){const e=this._m;return new ir([e[0],e[2],e[1],e[3]])}determinant(){const e=this._m;return e[0]*e[3]-e[1]*e[2]}inverse(){const e=this.determinant();if(e===0)throw new Error("Matrix is not invertible");const t=this._m,i=1/e;return new ir([t[3]*i,-t[1]*i,-t[2]*i,t[0]*i])}equals(e,t=0){const i=this._m,r=e.m;return t===0?i[0]===r[0]&&i[1]===r[1]&&i[2]===r[2]&&i[3]===r[3]:Math.abs(i[0]-r[0])<t&&Math.abs(i[1]-r[1])<t&&Math.abs(i[2]-r[2])<t&&Math.abs(i[3]-r[3])<t}getClassName(){return"FlowGraphMatrix2D"}toString(){return`FlowGraphMatrix2D(${this._m.join(", ")})`}}class rr{constructor(e=[1,0,0,0,1,0,0,0,1]){this._m=e}get m(){return this._m}transformVector(e){return this.transformVectorToRef(e,new x)}transformVectorToRef(e,t){const i=this._m;return t.x=e.x*i[0]+e.y*i[1]+e.z*i[2],t.y=e.x*i[3]+e.y*i[4]+e.z*i[5],t.z=e.x*i[6]+e.y*i[7]+e.z*i[8],t}multiplyToRef(e,t){const i=e._m,r=this._m,n=t.m;return n[0]=i[0]*r[0]+i[1]*r[3]+i[2]*r[6],n[1]=i[0]*r[1]+i[1]*r[4]+i[2]*r[7],n[2]=i[0]*r[2]+i[1]*r[5]+i[2]*r[8],n[3]=i[3]*r[0]+i[4]*r[3]+i[5]*r[6],n[4]=i[3]*r[1]+i[4]*r[4]+i[5]*r[7],n[5]=i[3]*r[2]+i[4]*r[5]+i[5]*r[8],n[6]=i[6]*r[0]+i[7]*r[3]+i[8]*r[6],n[7]=i[6]*r[1]+i[7]*r[4]+i[8]*r[7],n[8]=i[6]*r[2]+i[7]*r[5]+i[8]*r[8],t}multiply(e){return this.multiplyToRef(e,new rr)}divideToRef(e,t){const i=this._m,r=e.m,n=t.m;return n[0]=i[0]/r[0],n[1]=i[1]/r[1],n[2]=i[2]/r[2],n[3]=i[3]/r[3],n[4]=i[4]/r[4],n[5]=i[5]/r[5],n[6]=i[6]/r[6],n[7]=i[7]/r[7],n[8]=i[8]/r[8],t}divide(e){return this.divideToRef(e,new rr)}addToRef(e,t){const i=this._m,r=e.m,n=t.m;return n[0]=i[0]+r[0],n[1]=i[1]+r[1],n[2]=i[2]+r[2],n[3]=i[3]+r[3],n[4]=i[4]+r[4],n[5]=i[5]+r[5],n[6]=i[6]+r[6],n[7]=i[7]+r[7],n[8]=i[8]+r[8],t}add(e){return this.addToRef(e,new rr)}subtractToRef(e,t){const i=this._m,r=e.m,n=t.m;return n[0]=i[0]-r[0],n[1]=i[1]-r[1],n[2]=i[2]-r[2],n[3]=i[3]-r[3],n[4]=i[4]-r[4],n[5]=i[5]-r[5],n[6]=i[6]-r[6],n[7]=i[7]-r[7],n[8]=i[8]-r[8],t}subtract(e){return this.subtractToRef(e,new rr)}toArray(e=[]){for(let t=0;t<9;t++)e[t]=this._m[t];return e}asArray(){return this.toArray()}fromArray(e){for(let t=0;t<9;t++)this._m[t]=e[t];return this}transpose(){const e=this._m;return new rr([e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8]])}determinant(){const e=this._m;return e[0]*(e[4]*e[8]-e[5]*e[7])-e[1]*(e[3]*e[8]-e[5]*e[6])+e[2]*(e[3]*e[7]-e[4]*e[6])}inverse(){const e=this.determinant();if(e===0)throw new Error("Matrix is not invertible");const t=this._m,i=1/e;return new rr([(t[4]*t[8]-t[5]*t[7])*i,(t[2]*t[7]-t[1]*t[8])*i,(t[1]*t[5]-t[2]*t[4])*i,(t[5]*t[6]-t[3]*t[8])*i,(t[0]*t[8]-t[2]*t[6])*i,(t[2]*t[3]-t[0]*t[5])*i,(t[3]*t[7]-t[4]*t[6])*i,(t[1]*t[6]-t[0]*t[7])*i,(t[0]*t[4]-t[1]*t[3])*i])}equals(e,t=0){const i=this._m,r=e.m;return t===0?i[0]===r[0]&&i[1]===r[1]&&i[2]===r[2]&&i[3]===r[3]&&i[4]===r[4]&&i[5]===r[5]&&i[6]===r[6]&&i[7]===r[7]&&i[8]===r[8]:Math.abs(i[0]-r[0])<t&&Math.abs(i[1]-r[1])<t&&Math.abs(i[2]-r[2])<t&&Math.abs(i[3]-r[3])<t&&Math.abs(i[4]-r[4])<t&&Math.abs(i[5]-r[5])<t&&Math.abs(i[6]-r[6])<t&&Math.abs(i[7]-r[7])<t&&Math.abs(i[8]-r[8])<t}getClassName(){return"FlowGraphMatrix3D"}toString(){return`FlowGraphMatrix3D(${this._m.join(", ")})`}}var sv;(function(s){s.Any="any",s.String="string",s.Number="number",s.Boolean="boolean",s.Object="object",s.Integer="FlowGraphInteger",s.Vector2="Vector2",s.Vector3="Vector3",s.Vector4="Vector4",s.Quaternion="Quaternion",s.Matrix="Matrix",s.Matrix2D="Matrix2D",s.Matrix3D="Matrix3D",s.Color3="Color3",s.Color4="Color4"})(sv||(sv={}));class Cr{constructor(e,t,i=-1){this.typeName=e,this.defaultValue=t,this.animationType=i}serialize(e){e.typeName=this.typeName,e.defaultValue=this.defaultValue}}const Y=new Cr("any",void 0),g_=new Cr("string",""),_e=new Cr("number",0,0),Si=new Cr("boolean",!1),vn=new Cr("Vector2",X.Zero(),5),ui=new Cr("Vector3",x.Zero(),1),nh=new Cr("Vector4",Ee.Zero()),Zn=new Cr("Matrix",z.Identity(),3),ah=new Cr("Matrix2D",new ir),oh=new Cr("Matrix3D",new rr),S_=new Cr("Color3",q.Black(),4),v_=new Cr("Color4",new Te(0,0,0,0),7),wr=new Cr("Quaternion",Z.Identity(),2);wr.typeTransformer=s=>{if(s.getClassName){if(s.getClassName()==="Vector4")return Z.FromArray(s.asArray());if(s.getClassName()==="Vector3")return Z.FromEulerVector(s);if(s.getClassName()==="Matrix")return Z.FromRotationMatrix(s)}return s};const wt=new Cr("FlowGraphInteger",new Ue(0),0);function Xw(s){const e=s;switch(typeof s){case"string":return g_;case"number":return _e;case"boolean":return Si;case"object":if(e.getClassName)switch(e.getClassName()){case"Vector2":return vn;case"Vector3":return ui;case"Vector4":return nh;case"Matrix":return Zn;case"Color3":return S_;case"Color4":return v_;case"Quaternion":return wr;case"FlowGraphInteger":return wt;case"Matrix2D":return ah;case"Matrix3D":return oh}return Y;default:return Y}}function pt(s){switch(s){case"string":return g_;case"number":return _e;case"boolean":return Si;case"Vector2":return vn;case"Vector3":return ui;case"Vector4":return nh;case"Matrix":return Zn;case"Color3":return S_;case"Color4":return v_;case"Quaternion":return wr;case"FlowGraphInteger":return wt;case"Matrix2D":return ah;case"Matrix3D":return oh;default:return Y}}function Yw(s){switch(s){case 0:return _e;case 5:return vn;case 1:return ui;case 3:return Zn;case 4:return S_;case 7:return v_;case 2:return wr;default:return Y}}function jw(s){return s==="Vector2"||s==="Vector3"||s==="Vector4"||s==="Quaternion"||s==="Color3"||s==="Color4"}function qw(s){return s==="Matrix"||s==="Matrix2D"||s==="Matrix3D"}function lh(s,e,t){var r;const i=((r=e==null?void 0:e.getClassName)==null?void 0:r.call(e))??"";if(jw(i)||qw(i))t[s]={value:e.asArray(),className:i};else if(i==="FlowGraphInteger")t[s]={value:e.value,className:i};else if(i&&(e.id||e.name))t[s]={id:e.id,name:e.name,className:i};else if(typeof e!="object")t[s]=e;else throw new Error(`Could not serialize value ${e}`)}var nv;(function(s){s.Animation="Animation",s.AnimationGroup="AnimationGroup",s.Mesh="Mesh",s.Material="Material",s.Camera="Camera",s.Light="Light"})(nv||(nv={}));function fR(s,e,t,i){switch(e){case"Animation":return i?s.animations.find(r=>r.uniqueId===t)??null:s.animations[t]??null;case"AnimationGroup":return i?s.animationGroups.find(r=>r.uniqueId===t)??null:s.animationGroups[t]??null;case"Mesh":return i?s.meshes.find(r=>r.uniqueId===t)??null:s.meshes[t]??null;case"Material":return i?s.materials.find(r=>r.uniqueId===t)??null:s.materials[t]??null;case"Camera":return i?s.cameras.find(r=>r.uniqueId===t)??null:s.cameras[t]??null;case"Light":return i?s.lights.find(r=>r.uniqueId===t)??null:s.lights[t]??null;default:return null}}var av;(function(s){s.ExecuteBlock="ExecuteBlock",s.ExecuteEvent="ExecuteEvent",s.TriggerConnection="TriggerConnection",s.ContextVariableSet="ContextVariableSet",s.GlobalVariableSet="GlobalVariableSet",s.GlobalVariableDelete="GlobalVariableDelete",s.GlobalVariableGet="GlobalVariableGet",s.AddConnection="AddConnection",s.GetConnectionValue="GetConnectionValue",s.SetConnectionValue="SetConnectionValue",s.ActivateSignal="ActivateSignal",s.ContextVariableGet="ContextVariableGet"})(av||(av={}));class Zw{constructor(){this.logToConsole=!1,this.log=[]}addLogItem(e){var t;if(e.time||(e.time=Date.now()),this.log.push(e),this.logToConsole){const i=(t=e.payload)==null?void 0:t.value;typeof i=="object"&&i.getClassName?N.Log(`[FGLog] ${e.className}:${e.uniqueId.split("-")[0]} ${e.action} - ${JSON.stringify(i.getClassName())}: ${i.toString()}`):N.Log(`[FGLog] ${e.className}:${e.uniqueId.split("-")[0]} ${e.action} - ${JSON.stringify(e.payload)}`)}}getItemsOfType(e){return this.log.filter(t=>t.action===e)}}class pR{get enableLogging(){return this._enableLogging}set enableLogging(e){this._enableLogging!==e&&(this._enableLogging=e,this._enableLogging?(this.logger=new Zw,this.logger.logToConsole=!0):this.logger=null)}constructor(e){this.uniqueId=Bm(),this._userVariables={},this._executionVariables={},this._globalContextVariables={},this._connectionValues={},this._pendingBlocks=[],this._executionId=0,this.onNodeExecutedObservable=new k,this.treatDataAsRightHanded=!1,this._enableLogging=!1,this._configuration=e,this.assetsContext=e.assetsContext??e.scene}hasVariable(e){return e in this._userVariables}setVariable(e,t){var i;this._userVariables[e]=t,(i=this.logger)==null||i.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"ContextVariableSet",payload:{name:e,value:t}})}getAsset(e,t){return fR(this.assetsContext,e,t)}getVariable(e){var t;return(t=this.logger)==null||t.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"ContextVariableGet",payload:{name:e,value:this._userVariables[e]}}),this._userVariables[e]}get userVariables(){return this._userVariables}getScene(){return this._configuration.scene}_getUniqueIdPrefixedName(e,t){return`${e.uniqueId}_${t}`}_getGlobalContextVariable(e,t){var i;return(i=this.logger)==null||i.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"GlobalVariableGet",payload:{name:e,defaultValue:t,possibleValue:this._globalContextVariables[e]}}),this._hasGlobalContextVariable(e)?this._globalContextVariables[e]:t}_setGlobalContextVariable(e,t){var i;(i=this.logger)==null||i.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"GlobalVariableSet",payload:{name:e,value:t}}),this._globalContextVariables[e]=t}_deleteGlobalContextVariable(e){var t;(t=this.logger)==null||t.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"GlobalVariableDelete",payload:{name:e}}),delete this._globalContextVariables[e]}_hasGlobalContextVariable(e){return e in this._globalContextVariables}_setExecutionVariable(e,t,i){this._executionVariables[this._getUniqueIdPrefixedName(e,t)]=i}_getExecutionVariable(e,t,i){return this._hasExecutionVariable(e,t)?this._executionVariables[this._getUniqueIdPrefixedName(e,t)]:i}_deleteExecutionVariable(e,t){delete this._executionVariables[this._getUniqueIdPrefixedName(e,t)]}_hasExecutionVariable(e,t){return this._getUniqueIdPrefixedName(e,t)in this._executionVariables}_hasConnectionValue(e){return e.uniqueId in this._connectionValues}_setConnectionValue(e,t){var i;this._connectionValues[e.uniqueId]=t,(i=this.logger)==null||i.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"SetConnectionValue",payload:{connectionPointId:e.uniqueId,value:t}})}_setConnectionValueByKey(e,t){this._connectionValues[e]=t}_getConnectionValue(e){var t;return(t=this.logger)==null||t.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"GetConnectionValue",payload:{connectionPointId:e.uniqueId,value:this._connectionValues[e.uniqueId]}}),this._connectionValues[e.uniqueId]}get configuration(){return this._configuration}get hasPendingBlocks(){return this._pendingBlocks.length>0}_addPendingBlock(e){this._pendingBlocks.includes(e)||(this._pendingBlocks.push(e),this._pendingBlocks.sort((t,i)=>t.priority-i.priority))}_removePendingBlock(e){const t=this._pendingBlocks.indexOf(e);t!==-1&&this._pendingBlocks.splice(t,1)}_clearPendingBlocks(){for(const e of this._pendingBlocks)e._cancelPendingTasks(this);this._pendingBlocks.length=0}_notifyExecuteNode(e){var t;this.onNodeExecutedObservable.notifyObservers(e),(t=this.logger)==null||t.addLogItem({time:Date.now(),className:e.getClassName(),uniqueId:e.uniqueId,action:"ExecuteBlock"})}_notifyOnTick(e){var t;this._setGlobalContextVariable("timeSinceStart",e.timeSinceStart),this._setGlobalContextVariable("deltaTime",e.deltaTime);for(const i of this._pendingBlocks)(t=i._executeOnTick)==null||t.call(i,this)}_increaseExecutionId(){this._executionId++}get executionId(){return this._executionId}serialize(e={},t=lh){var i;e.uniqueId=this.uniqueId,e._userVariables={};for(const r in this._userVariables)t(r,this._userVariables[r],e._userVariables);e._connectionValues={};for(const r in this._connectionValues)t(r,this._connectionValues[r],e._connectionValues);this.assetsContext!==this.getScene()&&(e._assetsContext={meshes:this.assetsContext.meshes.map(r=>r.id),materials:this.assetsContext.materials.map(r=>r.id),textures:this.assetsContext.textures.map(r=>r.name),animations:this.assetsContext.animations.map(r=>r.name),lights:this.assetsContext.lights.map(r=>r.id),cameras:this.assetsContext.cameras.map(r=>r.id),sounds:(i=this.assetsContext.sounds)==null?void 0:i.map(r=>r.name),skeletons:this.assetsContext.skeletons.map(r=>r.id),particleSystems:this.assetsContext.particleSystems.map(r=>r.name),geometries:this.assetsContext.geometries.map(r=>r.id),multiMaterials:this.assetsContext.multiMaterials.map(r=>r.id),transformNodes:this.assetsContext.transformNodes.map(r=>r.id)})}getClassName(){return"FlowGraphContext"}}_([R()],pR.prototype,"uniqueId",void 0);var ov;(function(s){s[s.Input=0]="Input",s[s.Output=1]="Output"})(ov||(ov={}));class mR{constructor(e,t,i){this._ownerBlock=i,this._connectedPoint=[],this.uniqueId=Bm(),this.connectedPointIds=[],this.name=e,this._connectionType=t}get connectionType(){return this._connectionType}_isSingularConnection(){return!0}isConnected(){return this._connectedPoint.length>0}connectTo(e){if(this._connectionType===e._connectionType)throw new Error(`Cannot connect two points of type ${this.connectionType}`);if(this._isSingularConnection()&&this._connectedPoint.length>0||e._isSingularConnection()&&e._connectedPoint.length>0)throw new Error("Max number of connections for point reached");this._connectedPoint.push(e),e._connectedPoint.push(this)}disconnectFrom(e,t=!0){const i=this._connectedPoint.indexOf(e),r=e._connectedPoint.indexOf(this);i===-1||r===-1||(t&&this._connectedPoint.splice(i,1),e._connectedPoint.splice(r,1))}disconnectFromAll(){for(const e of this._connectedPoint)this.disconnectFrom(e,!1);this._connectedPoint.length=0}dispose(){for(const e of this._connectedPoint)this.disconnectFrom(e)}serialize(e={}){e.uniqueId=this.uniqueId,e.name=this.name,e._connectionType=this._connectionType,e.connectedPointIds=[],e.className=this.getClassName();for(const t of this._connectedPoint)e.connectedPointIds.push(t.uniqueId)}getClassName(){return"FGConnection"}deserialize(e){this.uniqueId=e.uniqueId,this.name=e.name,this._connectionType=e._connectionType,this.connectedPointIds=e.connectedPointIds}}class xd extends mR{constructor(e,t,i,r,n=r.defaultValue,a=!1){super(e,t,i),this.richType=r,this._defaultValue=n,this._optional=a,this._isDisabled=!1,this._lastValue=null,this.dataTransformer=null,this.onValueChangedObservable=new k}get optional(){return this._optional}get isDisabled(){return this._isDisabled}set isDisabled(e){this._isDisabled!==e&&(this._isDisabled=e,this._isDisabled&&this.disconnectFromAll())}_isSingularConnection(){return this.connectionType===0}setValue(e,t){t._getConnectionValue(this)!==e&&(t._setConnectionValue(this,e),this.onValueChangedObservable.notifyObservers(e))}resetToDefaultValue(e){e._setConnectionValue(this,this._defaultValue)}connectTo(e){this._isDisabled||super.connectTo(e)}_getValueOrDefault(e){const t=e._getConnectionValue(this)??this._defaultValue;return this.dataTransformer?this.dataTransformer(t):t}getValue(e){if(this.connectionType===1){e._notifyExecuteNode(this._ownerBlock),this._ownerBlock._updateOutputs(e);const i=this._getValueOrDefault(e);return this._lastValue=i,this.richType.typeTransformer?this.richType.typeTransformer(i):i}const t=this.isConnected()?this._connectedPoint[0].getValue(e):this._getValueOrDefault(e);return this._lastValue=t,this.richType.typeTransformer?this.richType.typeTransformer(t):t}_getLastValue(){return this._lastValue}getClassName(){return"FlowGraphDataConnection"}serialize(e={}){super.serialize(e),e.richType={},this.richType.serialize(e.richType),e.optional=this._optional,lh("defaultValue",this._defaultValue,e)}}y("FlowGraphDataConnection",xd);class Ni{constructor(e){var t;this.config=e,this.uniqueId=Bm(),this.name=((t=this.config)==null?void 0:t.name)??this.getClassName(),this.dataInputs=[],this.dataOutputs=[]}_updateOutputs(e){}registerDataInput(e,t,i){const r=new xd(e,0,this,t,i);return this.dataInputs.push(r),r}registerDataOutput(e,t,i){const r=new xd(e,1,this,t,i);return this.dataOutputs.push(r),r}getDataInput(e){return this.dataInputs.find(t=>t.name===e)}getDataOutput(e){return this.dataOutputs.find(t=>t.name===e)}serialize(e={},t=lh){if(e.uniqueId=this.uniqueId,e.config={},this.config){const i=this.config,r=Object.keys(i);for(const n of r)t(n,i[n],e.config)}e.dataInputs=[],e.dataOutputs=[],e.className=this.getClassName();for(const i of this.dataInputs){const r={};i.serialize(r),e.dataInputs.push(r)}for(const i of this.dataOutputs){const r={};i.serialize(r),e.dataOutputs.push(r)}}deserialize(e){}_log(e,t,i){var r;(r=e.logger)==null||r.addLogItem({action:t,payload:i,className:this.getClassName(),uniqueId:this.uniqueId})}getClassName(){return"FlowGraphBlock"}}class Ed extends mR{constructor(){super(...arguments),this.priority=0}_isSingularConnection(){return!1}connectTo(e){super.connectTo(e),this._connectedPoint.sort((t,i)=>i.priority-t.priority)}_activateSignal(e){var t;if((t=e.logger)==null||t.addLogItem({action:"ActivateSignal",className:this._ownerBlock.getClassName(),uniqueId:this._ownerBlock.uniqueId,payload:{connectionType:this.connectionType,name:this.name}}),this.connectionType===0)e._notifyExecuteNode(this._ownerBlock),this._ownerBlock._execute(e,this),e._increaseExecutionId();else for(const i of this._connectedPoint)i._activateSignal(e)}}y("FlowGraphSignalConnection",Ed);class La extends Ni{constructor(e){super(e),this.priority=0,this.signalInputs=[],this.signalOutputs=[],this.in=this._registerSignalInput("in"),this.error=this._registerSignalOutput("error")}_registerSignalInput(e){const t=new Ed(e,0,this);return this.signalInputs.push(t),t}_registerSignalOutput(e){const t=new Ed(e,1,this);return this.signalOutputs.push(t),t}_unregisterSignalInput(e){const t=this.signalInputs.findIndex(i=>i.name===e);t!==-1&&(this.signalInputs[t].dispose(),this.signalInputs.splice(t,1))}_unregisterSignalOutput(e){const t=this.signalOutputs.findIndex(i=>i.name===e);t!==-1&&(this.signalOutputs[t].dispose(),this.signalOutputs.splice(t,1))}_reportError(e,t){this.error.payload=typeof t=="string"?new Error(t):t,this.error._activateSignal(e)}getSignalInput(e){return this.signalInputs.find(t=>t.name===e)}getSignalOutput(e){return this.signalOutputs.find(t=>t.name===e)}serialize(e={}){super.serialize(e),e.signalInputs=[],e.signalOutputs=[];for(const t of this.signalInputs){const i={};t.serialize(i),e.signalInputs.push(i)}for(const t of this.signalOutputs){const i={};t.serialize(i),e.signalOutputs.push(i)}}deserialize(e){for(let t=0;t<e.signalInputs.length;t++){const i=this.getSignalInput(e.signalInputs[t].name);if(i)i.deserialize(e.signalInputs[t]);else throw new Error("Could not find signal input with name "+e.signalInputs[t].name+" in block "+e.className)}for(let t=0;t<e.signalOutputs.length;t++){const i=this.getSignalOutput(e.signalOutputs[t].name);if(i)i.deserialize(e.signalOutputs[t]);else throw new Error("Could not find signal output with name "+e.signalOutputs[t].name+" in block "+e.className)}}getClassName(){return"FlowGraphExecutionBlock"}}class Qw{constructor(e){this.onEventTriggeredObservable=new k,this.sceneReadyTriggered=!1,this._pointerUnderMeshState={},this._startingTime=0,this._scene=e,this._initialize()}_initialize(){this._sceneReadyObserver=this._scene.onReadyObservable.add(()=>{this.sceneReadyTriggered||(this.onEventTriggeredObservable.notifyObservers({type:"SceneReady"}),this.sceneReadyTriggered=!0)}),this._sceneDisposeObserver=this._scene.onDisposeObservable.add(()=>{this.onEventTriggeredObservable.notifyObservers({type:"SceneDispose"})}),this._sceneOnBeforeRenderObserver=this._scene.onBeforeRenderObservable.add(()=>{const e=this._scene.getEngine().getDeltaTime()/1e3;this.onEventTriggeredObservable.notifyObservers({type:"SceneBeforeRender",payload:{timeSinceStart:this._startingTime,deltaTime:e}}),this._startingTime+=e}),this._meshPickedObserver=this._scene.onPointerObservable.add(e=>{this.onEventTriggeredObservable.notifyObservers({type:"MeshPick",payload:e})},ze.POINTERPICK),this._meshUnderPointerObserver=this._scene.onMeshUnderPointerUpdatedObservable.add(e=>{const t=e.pointerId,i=e.mesh,r=this._pointerUnderMeshState[t];!r&&i?this.onEventTriggeredObservable.notifyObservers({type:"PointerOver",payload:{pointerId:t,mesh:i}}):r&&!i?this.onEventTriggeredObservable.notifyObservers({type:"PointerOut",payload:{pointerId:t,mesh:r}}):r&&i&&r!==i&&(this.onEventTriggeredObservable.notifyObservers({type:"PointerOut",payload:{pointerId:t,mesh:r,over:i}}),this.onEventTriggeredObservable.notifyObservers({type:"PointerOver",payload:{pointerId:t,mesh:i,out:r}})),this._pointerUnderMeshState[t]=i},ze.POINTERMOVE)}dispose(){var e,t,i,r,n;(e=this._sceneDisposeObserver)==null||e.remove(),(t=this._sceneReadyObserver)==null||t.remove(),(i=this._sceneOnBeforeRenderObserver)==null||i.remove(),(r=this._meshPickedObserver)==null||r.remove(),(n=this._meshUnderPointerObserver)==null||n.remove(),this.onEventTriggeredObservable.clear()}}function Ca(s,e){return!!(s.parent&&(s.parent===e||Ca(s.parent,e)))}function Gi(s){if(s.getClassName)return s.getClassName()}function tc(s,e){return s===e&&(s==="Vector2"||s==="Vector3"||s==="Vector4"||s==="Quaternion")}function ic(s,e){return s===e&&(s==="Matrix"||s==="Matrix2D"||s==="Matrix3D")}function rc(s,e){return s==="FlowGraphInteger"&&e==="FlowGraphInteger"}function Io(s,e){const t=typeof s=="number"||typeof(s==null?void 0:s.value)=="number";return t&&!e?!isNaN(Rt(s)):t}function Rt(s){return typeof s=="number"?s:s.value}var lv;(function(s){s[s.Stopped=0]="Stopped",s[s.Started=1]="Started"})(lv||(lv={}));class Kw{get state(){return this._state}set state(e){this._state=e,this.onStateChangedObservable.notifyObservers(e)}constructor(e){this.onStateChangedObservable=new k,this._eventBlocks={SceneReady:[],SceneDispose:[],SceneBeforeRender:[],MeshPick:[],PointerDown:[],PointerUp:[],PointerMove:[],PointerOver:[],PointerOut:[],SceneAfterRender:[],NoTrigger:[]},this._executionContexts=[],this._state=0,this._scene=e.scene,this._sceneEventCoordinator=new Qw(this._scene),this._coordinator=e.coordinator,this._eventObserver=this._sceneEventCoordinator.onEventTriggeredObservable.add(t=>{for(const i of this._executionContexts){const r=this._getContextualOrder(t.type,i);for(const n of r)if(!n._executeEvent(i,t.payload))break}switch(t.type){case"SceneReady":this._sceneEventCoordinator.sceneReadyTriggered=!0;break;case"SceneBeforeRender":for(const i of this._executionContexts)i._notifyOnTick(t.payload);break;case"SceneDispose":this.dispose();break}})}createContext(){const e=new pR({scene:this._scene,coordinator:this._coordinator});return this._executionContexts.push(e),e}getContext(e){return this._executionContexts[e]}addEventBlock(e){if((e.type==="PointerOver"||e.type==="PointerOut")&&(this._scene.constantlyUpdateMeshUnderPointer=!0),e.type!=="NoTrigger"&&this._eventBlocks[e.type].push(e),this.state===1)for(const t of this._executionContexts)e._startPendingTasks(t);else this.onStateChangedObservable.addOnce(t=>{if(t===1)for(const i of this._executionContexts)e._startPendingTasks(i)})}start(){this.state!==1&&(this._executionContexts.length===0&&this.createContext(),this.onStateChangedObservable.add(e=>{e===1&&(this._startPendingEvents(),this._scene.isReady(!0)&&this._sceneEventCoordinator.onEventTriggeredObservable.notifyObservers({type:"SceneReady"}))}),this.state=1)}_startPendingEvents(){for(const e of this._executionContexts)for(const t in this._eventBlocks){const i=this._getContextualOrder(t,e);for(const r of i)r._startPendingTasks(e)}}_getContextualOrder(e,t){const i=this._eventBlocks[e].sort((r,n)=>n.initPriority-r.initPriority);if(e==="MeshPick"){const r=[];for(const n of i){const a=n.asset.getValue(t);let o=0;for(;o<i.length;o++){const c=i[o].asset.getValue(t);if(a&&c&&Ca(a,c))break}r.splice(o,0,n)}return r}return i}dispose(){var e;if(this.state!==0){this.state=0;for(const t of this._executionContexts)t._clearPendingBlocks();this._executionContexts.length=0;for(const t in this._eventBlocks)this._eventBlocks[t].length=0;(e=this._eventObserver)==null||e.remove(),this._sceneEventCoordinator.dispose()}}visitAllBlocks(e){const t=[],i=new Set;for(const r in this._eventBlocks)for(const n of this._eventBlocks[r])t.push(n),i.add(n.uniqueId);for(;t.length>0;){const r=t.pop();e(r);for(const n of r.dataInputs)for(const a of n._connectedPoint)i.has(a._ownerBlock.uniqueId)||(t.push(a._ownerBlock),i.add(a._ownerBlock.uniqueId));if(r instanceof La)for(const n of r.signalOutputs)for(const a of n._connectedPoint)i.has(a._ownerBlock.uniqueId)||(t.push(a._ownerBlock),i.add(a._ownerBlock.uniqueId))}}serialize(e={},t){e.allBlocks=[],this.visitAllBlocks(i=>{const r={};i.serialize(r),e.allBlocks.push(r)}),e.executionContexts=[];for(const i of this._executionContexts){const r={};i.serialize(r,t),e.executionContexts.push(r)}}}class yr extends La{constructor(e){super(e),this.out=this._registerSignalOutput("out")}}class ch extends yr{constructor(e,t){if(super(e),this._eventsSignalOutputs={},this.done=this._registerSignalOutput("done"),t)for(const i of t)this._eventsSignalOutputs[i]=this._registerSignalOutput(i+"Event")}_executeOnTick(e){}_startPendingTasks(e){e._getExecutionVariable(this,"_initialized",!1)&&(this._cancelPendingTasks(e),this._resetAfterCanceled(e)),this._preparePendingTasks(e),e._addPendingBlock(this),this.out._activateSignal(e),e._setExecutionVariable(this,"_initialized",!0)}_resetAfterCanceled(e){e._deleteExecutionVariable(this,"_initialized"),e._removePendingBlock(this)}}class Ho extends ch{constructor(){super(...arguments),this.initPriority=0,this.type="NoTrigger"}_execute(e){e._notifyExecuteNode(this),this.done._activateSignal(e)}}class Fs{constructor(e){this.config=e,this.dispatchEventsSynchronously=!0,this._flowGraphs=[],this._customEventsMap=new Map,this._eventExecutionCounter=new Map,this._executeOnNextFrame=[],this._eventUniqueId=0,this._disposeObserver=this.config.scene.onDisposeObservable.add(()=>{this.dispose()}),this._onBeforeRenderObserver=this.config.scene.onBeforeRenderObservable.add(()=>{this._eventExecutionCounter.clear();const i=this._executeOnNextFrame.slice(0);if(i.length)for(const r of i){this.notifyCustomEvent(r.id,r.data,!1);const n=this._executeOnNextFrame.findIndex(a=>a.uniqueId===r.uniqueId);n!==-1&&this._executeOnNextFrame.splice(n,1)}}),(Fs.SceneCoordinators.get(this.config.scene)??[]).push(this)}createGraph(){const e=new Kw({scene:this.config.scene,coordinator:this});return this._flowGraphs.push(e),e}removeGraph(e){const t=this._flowGraphs.indexOf(e);t!==-1&&(e.dispose(),this._flowGraphs.splice(t,1))}start(){for(const e of this._flowGraphs)e.start()}dispose(){var i,r;for(const n of this._flowGraphs)n.dispose();this._flowGraphs.length=0,(i=this._disposeObserver)==null||i.remove(),(r=this._onBeforeRenderObserver)==null||r.remove();const e=Fs.SceneCoordinators.get(this.config.scene)??[],t=e.indexOf(this);t!==-1&&e.splice(t,1)}serialize(e,t){e._flowGraphs=[];for(const i of this._flowGraphs){const r={};i.serialize(r,t),e._flowGraphs.push(r)}e.dispatchEventsSynchronously=this.dispatchEventsSynchronously}get flowGraphs(){return this._flowGraphs}getCustomEventObservable(e){let t=this._customEventsMap.get(e);return t||(t=new k,this._customEventsMap.set(e,t)),t}notifyCustomEvent(e,t,i=!this.dispatchEventsSynchronously){if(i){this._executeOnNextFrame.push({id:e,data:t,uniqueId:this._eventUniqueId++});return}if(this._eventExecutionCounter.has(e)){const n=this._eventExecutionCounter.get(e);if(this._eventExecutionCounter.set(e,n+1),n>=Fs.MaxEventTypeExecutionPerFrame){n===Fs.MaxEventTypeExecutionPerFrame&&N.Warn(`FlowGraphCoordinator: Too many executions of event "${e}".`);return}}else this._eventExecutionCounter.set(e,1);const r=this._customEventsMap.get(e);r&&r.notifyObservers(t)}}Fs.MaxEventsPerType=30;Fs.MaxEventTypeExecutionPerFrame=30;Fs.SceneCoordinators=new Map;const cv=new RegExp(/\/\{(\w+)\}(?=\/|$)/g);class Jw{constructor(e,t){this.path=e,this.ownerBlock=t,this.templatedInputs=[];let i=cv.exec(e);const r=new Set;for(;i;){const[,n]=i;if(r.has(n))throw new Error("Duplicate template variable detected.");r.add(n),this.templatedInputs.push(t.registerDataInput(n,wt,new Ue(0))),i=cv.exec(e)}}getAccessor(e,t){let i=this.path;for(const r of this.templatedInputs){const n=r.getValue(t).value;if(typeof n!="number"||n<0)throw new Error("Invalid value for templated input.");i=i.replace(`{${r.name}}`,n.toString())}return e.convert(i)}}class e2 extends yr{constructor(e){if(super(e),this.message=this.registerDataInput("message",Y),this.logType=this.registerDataInput("logType",Y,"log"),e!=null&&e.messageTemplate){const t=this._getTemplateMatches(e.messageTemplate);for(const i of t)this.registerDataInput(i,Y)}}_execute(e){const t=this.logType.getValue(e),i=this._getMessageValue(e);t==="warn"?N.Warn(i):t==="error"?N.Error(i):N.Log(i),this.out._activateSignal(e)}getClassName(){return"FlowGraphConsoleLogBlock"}_getMessageValue(e){var t,i;if((t=this.config)!=null&&t.messageTemplate){let r=this.config.messageTemplate;const n=this._getTemplateMatches(r);for(const a of n){const o=(i=this.getDataInput(a))==null?void 0:i.getValue(e);o!==void 0&&(r=r.replace(new RegExp(`\\{${a}\\}`,"g"),o.toString()))}return r}else return this.message.getValue(e)}_getTemplateMatches(e){const t=/\{([^}]+)\}/g,i=[];let r;for(;(r=t.exec(e))!==null;)i.push(r[1]);return i}}y("FlowGraphConsoleLogBlock",e2);class t2 extends La{constructor(e){super(e),this.condition=this.registerDataInput("condition",Si),this.onTrue=this._registerSignalOutput("onTrue"),this.onFalse=this._registerSignalOutput("onFalse")}_execute(e){this.condition.getValue(e)?this.onTrue._activateSignal(e):this.onFalse._activateSignal(e)}getClassName(){return"FlowGraphBranchBlock"}}y("FlowGraphBranchBlock",t2);class i2 extends yr{constructor(e={}){super(e),this.config=e,this.config.startIndex=e.startIndex??new Ue(0),this.reset=this._registerSignalInput("reset"),this.maxExecutions=this.registerDataInput("maxExecutions",wt),this.executionCount=this.registerDataOutput("executionCount",wt,new Ue(0))}_execute(e,t){if(t===this.reset)this.executionCount.setValue(this.config.startIndex,e);else{const i=this.executionCount.getValue(e);i.value<this.maxExecutions.getValue(e).value&&(this.executionCount.setValue(new Ue(i.value+1),e),this.out._activateSignal(e))}}getClassName(){return"FlowGraphDoNBlock"}}y("FlowGraphDoNBlock",i2);class uh extends yr{constructor(e){super(e),this.startIndex=this.registerDataInput("startIndex",Y,0),this.endIndex=this.registerDataInput("endIndex",Y),this.step=this.registerDataInput("step",_e,1),this.index=this.registerDataOutput("index",wt,new Ue(Rt((e==null?void 0:e.initialIndex)??0))),this.executionFlow=this._registerSignalOutput("executionFlow"),this.completed=this._registerSignalOutput("completed"),this._unregisterSignalOutput("out")}_execute(e){var n;const t=Rt(this.startIndex.getValue(e)),i=this.step.getValue(e);let r=Rt(this.endIndex.getValue(e));for(let a=t;a<r&&(this.index.setValue(new Ue(a),e),this.executionFlow._activateSignal(e),r=Rt(this.endIndex.getValue(e)),!(a>uh.MaxLoopIterations*i));a+=i);(n=this.config)!=null&&n.incrementIndexWhenLoopDone&&this.index.setValue(new Ue(Rt(this.index.getValue(e))+i),e),this.completed._activateSignal(e)}getClassName(){return"FlowGraphForLoopBlock"}}uh.MaxLoopIterations=1e3;y("FlowGraphForLoopBlock",uh);class r2 extends yr{constructor(e){super(e),this.reset=this._registerSignalInput("reset"),this.duration=this.registerDataInput("duration",_e),this.lastRemainingTime=this.registerDataOutput("lastRemainingTime",_e,NaN)}_execute(e,t){if(t===this.reset){this.lastRemainingTime.setValue(NaN,e),e._setExecutionVariable(this,"lastRemainingTime",NaN),e._setExecutionVariable(this,"timestamp",0);return}const i=this.duration.getValue(e);if(i<=0||isNaN(i)||!isFinite(i))return this._reportError(e,"Invalid duration in Throttle block");const r=e._getExecutionVariable(this,"lastRemainingTime",NaN),n=Date.now();if(isNaN(r))return this.lastRemainingTime.setValue(0,e),e._setExecutionVariable(this,"lastRemainingTime",0),e._setExecutionVariable(this,"timestamp",n),this.out._activateSignal(e);{const a=n-e._getExecutionVariable(this,"timestamp",0),o=i*1e3;if(o<=a)return this.lastRemainingTime.setValue(0,e),e._setExecutionVariable(this,"lastRemainingTime",0),e._setExecutionVariable(this,"timestamp",n),this.out._activateSignal(e);{const l=o-a;this.lastRemainingTime.setValue(l/1e3,e),e._setExecutionVariable(this,"lastRemainingTime",l)}}}getClassName(){return"FlowGraphThrottleBlock"}}y("FlowGraphThrottleBlock",r2);class s2 extends La{constructor(e){super(e),this.config=e,this.outputSignals=[],this.reset=this._registerSignalInput("reset"),this.lastIndex=this.registerDataOutput("lastIndex",wt,new Ue(-1)),this.setNumberOfOutputSignals(e==null?void 0:e.outputSignalCount)}_getNextIndex(e){if(e.includes(!1)||this.config.isLoop&&e.fill(!1),this.config.isRandom){const t=e.map((i,r)=>i?-1:r).filter(i=>i!==-1);return t.length?t[Math.floor(Math.random()*t.length)]:-1}else return e.indexOf(!1)}setNumberOfOutputSignals(e=1){for(;this.outputSignals.length>e;){const t=this.outputSignals.pop();t&&(t.disconnectFromAll(),this._unregisterSignalOutput(t.name))}for(;this.outputSignals.length<e;)this.outputSignals.push(this._registerSignalOutput(`out_${this.outputSignals.length}`))}_execute(e,t){if(e._hasExecutionVariable(this,"indexesUsed")||e._setExecutionVariable(this,"indexesUsed",this.outputSignals.map(()=>!1)),t===this.reset){e._deleteExecutionVariable(this,"indexesUsed"),this.lastIndex.setValue(new Ue(-1),e);return}const i=e._getExecutionVariable(this,"indexesUsed",[]),r=this._getNextIndex(i);r>-1&&(this.lastIndex.setValue(new Ue(r),e),i[r]=!0,e._setExecutionVariable(this,"indexesUsed",i),this.outputSignals[r]._activateSignal(e))}getClassName(){return"FlowGraphMultiGateBlock"}serialize(e){super.serialize(e),e.config.outputSignalCount=this.config.outputSignalCount,e.config.isRandom=this.config.isRandom,e.config.loop=this.config.isLoop,e.config.startIndex=this.config.startIndex}}y("FlowGraphMultiGateBlock",s2);class n2 extends La{constructor(e){super(e),this.config=e,this.default=this._registerSignalOutput("default"),this._caseToOutputFlow=new Map,this.case=this.registerDataInput("case",Y);const t=this.config.cases||[];for(const i of t)this._caseToOutputFlow.set(i,this._registerSignalOutput(`out_${i}`))}_execute(e,t){const i=this.case.getValue(e);let r;Io(i)?r=this._getOutputFlowForCase(Rt(i)):r=this._getOutputFlowForCase(i),r?r._activateSignal(e):this.default._activateSignal(e)}addCase(e){this.config.cases.includes(e)||(this.config.cases.push(e),this._caseToOutputFlow.set(e,this._registerSignalOutput(`out_${e}`)))}removeCase(e){if(!this.config.cases.includes(e))return;const t=this.config.cases.indexOf(e);this.config.cases.splice(t,1),this._caseToOutputFlow.delete(e)}_getOutputFlowForCase(e){return this._caseToOutputFlow.get(e)}getClassName(){return"FlowGraphSwitchBlock"}serialize(e){super.serialize(e),e.cases=this.config.cases}}y("FlowGraphSwitchBlock",n2);class a2 extends yr{constructor(e){super(e),this.config=e,this.inFlows=[],this._cachedActivationState=[],this.reset=this._registerSignalInput("reset"),this.completed=this._registerSignalOutput("completed"),this.remainingInputs=this.registerDataOutput("remainingInputs",wt,new Ue(this.config.inputSignalCount||0));for(let t=0;t<this.config.inputSignalCount;t++)this.inFlows.push(this._registerSignalInput(`in_${t}`));this._unregisterSignalInput("in")}_getCurrentActivationState(e){const t=this._cachedActivationState;if(t.length=0,e._hasExecutionVariable(this,"activationState")){const i=e._getExecutionVariable(this,"activationState",[]);for(let r=0;r<i.length;r++)t.push(i[r])}else for(let i=0;i<this.config.inputSignalCount;i++)t.push(!1);return t}_execute(e,t){const i=this._getCurrentActivationState(e);if(t===this.reset)for(let r=0;r<this.config.inputSignalCount;r++)i[r]=!1;else{const r=this.inFlows.indexOf(t);r>=0&&(i[r]=!0)}if(this.remainingInputs.setValue(new Ue(i.filter(r=>!r).length),e),e._setExecutionVariable(this,"activationState",i.slice()),i.includes(!1))t!==this.reset&&this.out._activateSignal(e);else{this.completed._activateSignal(e);for(let r=0;r<this.config.inputSignalCount;r++)i[r]=!1}}getClassName(){return"FlowGraphWaitAllBlock"}serialize(e){super.serialize(e),e.config.inputFlows=this.config.inputSignalCount}}y("FlowGraphWaitAllBlock",a2);class o2 extends yr{constructor(e){super(e),this.count=this.registerDataOutput("count",_e),this.reset=this._registerSignalInput("reset")}_execute(e,t){if(t===this.reset){e._setExecutionVariable(this,"count",0),this.count.setValue(0,e);return}const i=e._getExecutionVariable(this,"count",0)+1;e._setExecutionVariable(this,"count",i),this.count.setValue(i,e),this.out._activateSignal(e)}getClassName(){return"FlowGraphCallCounterBlock"}}y("FlowGraphCallCounterBlock",o2);class hh extends yr{constructor(e){super(e),this.config=e,this.condition=this.registerDataInput("condition",Si),this.executionFlow=this._registerSignalOutput("executionFlow"),this.completed=this._registerSignalOutput("completed"),this._unregisterSignalOutput("out")}_execute(e,t){var n;let i=this.condition.getValue(e);(n=this.config)!=null&&n.doWhile&&!i&&this.executionFlow._activateSignal(e);let r=0;for(;i;){if(this.executionFlow._activateSignal(e),++r,r>=hh.MaxLoopCount){N.Warn("FlowGraphWhileLoopBlock: Max loop count reached. Breaking.");break}i=this.condition.getValue(e)}this.completed._activateSignal(e)}getClassName(){return"FlowGraphWhileLoopBlock"}}hh.MaxLoopCount=1e3;y("FlowGraphWhileLoopBlock",hh);class l2 extends yr{constructor(e){super(e),this.count=this.registerDataInput("count",_e),this.reset=this._registerSignalInput("reset"),this.currentCount=this.registerDataOutput("currentCount",_e)}_execute(e,t){if(t===this.reset){e._setExecutionVariable(this,"debounceCount",0);return}const i=this.count.getValue(e),n=e._getExecutionVariable(this,"debounceCount",0)+1;this.currentCount.setValue(n,e),e._setExecutionVariable(this,"debounceCount",n),n>=i&&(this.out._activateSignal(e),e._setExecutionVariable(this,"debounceCount",0))}getClassName(){return"FlowGraphDebounceBlock"}}y("FlowGraphDebounceBlock",l2);class c2 extends La{constructor(e){super(e),this.onOn=this._registerSignalOutput("onOn"),this.onOff=this._registerSignalOutput("onOff"),this.value=this.registerDataOutput("value",Si)}_execute(e,t){var r;let i=e._getExecutionVariable(this,"value",typeof((r=this.config)==null?void 0:r.startValue)=="boolean"?!this.config.startValue:!1);i=!i,e._setExecutionVariable(this,"value",i),this.value.setValue(i,e),i?this.onOn._activateSignal(e):this.onOff._activateSignal(e)}getClassName(){return"FlowGraphFlipFlopBlock"}}y("FlowGraphFlipFlopBlock",c2);class u2 extends La{constructor(e){super(e),this.config=e,this.executionSignals=[],this.setNumberOfOutputSignals(this.config.outputSignalCount)}_execute(e){for(let t=0;t<this.executionSignals.length;t++)this.executionSignals[t]._activateSignal(e)}setNumberOfOutputSignals(e=1){for(;this.executionSignals.length>e;){const t=this.executionSignals.pop();t&&(t.disconnectFromAll(),this._unregisterSignalOutput(t.name))}for(;this.executionSignals.length<e;)this.executionSignals.push(this._registerSignalOutput(`out_${this.executionSignals.length}`))}getClassName(){return"FlowGraphSequenceBlock"}}y("FlowGraphSequenceBlock",u2);var uv;(function(s){s[s.INIT=0]="INIT",s[s.STARTED=1]="STARTED",s[s.ENDED=2]="ENDED"})(uv||(uv={}));function Rc(s){let e=0;const t=Date.now();s.observableParameters=s.observableParameters??{};const i=s.contextObservable.add(r=>{const n=Date.now();e=n-t;const a={startTime:t,currentTime:n,deltaTime:e,completeRate:e/s.timeout,payload:r};s.onTick&&s.onTick(a),s.breakCondition&&s.breakCondition()&&(s.contextObservable.remove(i),s.onAborted&&s.onAborted(a)),e>=s.timeout&&(s.contextObservable.remove(i),s.onEnded&&s.onEnded(a))},s.observableParameters.mask,s.observableParameters.insertFirst,s.observableParameters.scope);return i}class h2{constructor(e){this.onEachCountObservable=new k,this.onTimerAbortedObservable=new k,this.onTimerEndedObservable=new k,this.onStateChangedObservable=new k,this._observer=null,this._breakOnNextTick=!1,this._tick=t=>{const i=Date.now();this._timer=i-this._startTime;const r={startTime:this._startTime,currentTime:i,deltaTime:this._timer,completeRate:this._timer/this._timeToEnd,payload:t},n=this._breakOnNextTick||this._breakCondition(r);n||this._timer>=this._timeToEnd?this._stop(r,n):this.onEachCountObservable.notifyObservers(r)},this._setState(0),this._contextObservable=e.contextObservable,this._observableParameters=e.observableParameters??{},this._breakCondition=e.breakCondition??(()=>!1),this._timeToEnd=e.timeout,e.onEnded&&this.onTimerEndedObservable.add(e.onEnded),e.onTick&&this.onEachCountObservable.add(e.onTick),e.onAborted&&this.onTimerAbortedObservable.add(e.onAborted)}set breakCondition(e){this._breakCondition=e}clearObservables(){this.onEachCountObservable.clear(),this.onTimerAbortedObservable.clear(),this.onTimerEndedObservable.clear(),this.onStateChangedObservable.clear()}start(e=this._timeToEnd){if(this._state===1)throw new Error("Timer already started. Please stop it before starting again");this._timeToEnd=e,this._startTime=Date.now(),this._timer=0,this._observer=this._contextObservable.add(this._tick,this._observableParameters.mask,this._observableParameters.insertFirst,this._observableParameters.scope),this._setState(1)}stop(){this._state===1&&(this._breakOnNextTick=!0)}dispose(){this._observer&&this._contextObservable.remove(this._observer),this.clearObservables()}_setState(e){this._state=e,this.onStateChangedObservable.notifyObservers(this._state)}_stop(e,t=!1){this._contextObservable.remove(this._observer),this._setState(2),t?this.onTimerAbortedObservable.notifyObservers(e):this.onTimerEndedObservable.notifyObservers(e)}}class dh extends ch{constructor(e){super(e),this.cancel=this._registerSignalInput("cancel"),this.duration=this.registerDataInput("duration",_e),this.lastDelayIndex=this.registerDataOutput("lastDelayIndex",wt,new Ue(-1))}_preparePendingTasks(e){const t=this.duration.getValue(e);if(t<0||isNaN(t)||!isFinite(t))return this._reportError(e,"Invalid duration in SetDelay block");if(e._getGlobalContextVariable("activeDelays",0)>=dh.MaxParallelDelayCount)return this._reportError(e,"Max parallel delays reached");const r=e._getGlobalContextVariable("lastDelayIndex",-1),n=e._getExecutionVariable(this,"pendingDelays",[]),a=e.configuration.scene,o=new h2({timeout:t*1e3,contextObservable:a.onBeforeRenderObservable,onEnded:()=>this._onEnded(o,e)});o.start();const l=r+1;this.lastDelayIndex.setValue(new Ue(l),e),e._setGlobalContextVariable("lastDelayIndex",l),n[l]=o,e._setExecutionVariable(this,"pendingDelays",n),this._updateGlobalTimers(e)}_cancelPendingTasks(e){const t=e._getExecutionVariable(this,"pendingDelays",[]);for(const i of t)i==null||i.dispose();e._deleteExecutionVariable(this,"pendingDelays"),this.lastDelayIndex.setValue(new Ue(-1),e),this._updateGlobalTimers(e)}_execute(e,t){if(t===this.cancel){this._cancelPendingTasks(e);return}else this._preparePendingTasks(e),this.out._activateSignal(e)}getClassName(){return"FlowGraphSetDelayBlock"}_onEnded(e,t){const i=t._getExecutionVariable(this,"pendingDelays",[]),r=i.indexOf(e);r!==-1?i.splice(r,1):N.Warn("FlowGraphTimerBlock: Timer ended but was not found in the running timers list"),t._removePendingBlock(this),this.done._activateSignal(t),this._updateGlobalTimers(t)}_updateGlobalTimers(e){const t=e._getExecutionVariable(this,"pendingDelays",[]),i=e._getGlobalContextVariable("pendingDelays",[]);for(let r=0;r<t.length;r++){if(!t[r])continue;const n=t[r];i[r]&&i[r]!==n?N.Warn("FlowGraphTimerBlock: Timer ended but was not found in the running timers list"):i[r]=n}e._setGlobalContextVariable("pendingDelays",i)}}dh.MaxParallelDelayCount=100;y("FlowGraphSetDelayBlock",dh);class d2 extends yr{constructor(e){super(e),this.delayIndex=this.registerDataInput("delayIndex",wt)}_execute(e,t){const i=Rt(this.delayIndex.getValue(e));if(i<=0||isNaN(i)||!isFinite(i))return this._reportError(e,"Invalid delay index");const n=e._getGlobalContextVariable("pendingDelays",[])[i];n&&n.dispose(),this.out._activateSignal(e)}getClassName(){return"FlowGraphCancelDelayBlock"}}y("FlowGraphCancelDelayBlock",d2);class f2 extends ch{constructor(e){super(e,["animationLoop","animationEnd","animationGroupLoop"]),this.config=e,this.speed=this.registerDataInput("speed",_e),this.loop=this.registerDataInput("loop",Si),this.from=this.registerDataInput("from",_e,0),this.to=this.registerDataInput("to",_e),this.currentFrame=this.registerDataOutput("currentFrame",_e),this.currentTime=this.registerDataOutput("currentTime",_e),this.currentAnimationGroup=this.registerDataOutput("currentAnimationGroup",Y),this.animationGroup=this.registerDataInput("animationGroup",Y,e==null?void 0:e.animationGroup),this.animation=this.registerDataInput("animation",Y),this.object=this.registerDataInput("object",Y)}_preparePendingTasks(e){const t=this.animationGroup.getValue(e),i=this.animation.getValue(e);if(!t&&!i)return this._reportError(e,"No animation or animation group provided");{const r=this.currentAnimationGroup.getValue(e);r&&r!==t&&r.dispose();let n=t;if(i&&!n){const h=this.object.getValue(e);if(!h)return this._reportError(e,"No target object provided");const d=Array.isArray(i)?i:[i],f=d[0].name;n=new Rs("flowGraphAnimationGroup-"+f+"-"+h.name,e.configuration.scene);let m=!1;const g=e._getGlobalContextVariable("interpolationAnimations",[]);for(const v of d)n.addTargetedAnimation(v,h),g.indexOf(v.uniqueId)!==-1&&(m=!0);m&&this._checkInterpolationDuplications(e,d,h)}const a=this.speed.getValue(e)||1,o=this.from.getValue(e)??0,l=this.to.getValue(e)||n.to,c=!isFinite(l)||this.loop.getValue(e);this.currentAnimationGroup.setValue(n,e);const u=e._getGlobalContextVariable("currentlyRunningAnimationGroups",[]);u.indexOf(n.uniqueId)!==-1&&n.stop();try{n.start(c,a,o,l),n.onAnimationGroupEndObservable.add(()=>this._onAnimationGroupEnd(e)),n.onAnimationEndObservable.add(()=>this._eventsSignalOutputs.animationEnd._activateSignal(e)),n.onAnimationLoopObservable.add(()=>this._eventsSignalOutputs.animationLoop._activateSignal(e)),n.onAnimationGroupLoopObservable.add(()=>this._eventsSignalOutputs.animationGroupLoop._activateSignal(e)),u.push(n.uniqueId),e._setGlobalContextVariable("currentlyRunningAnimationGroups",u)}catch(h){this._reportError(e,h)}}}_reportError(e,t){super._reportError(e,t),this.currentFrame.setValue(-1,e),this.currentTime.setValue(-1,e)}_executeOnTick(e){var i;const t=this.currentAnimationGroup.getValue(e);t&&(this.currentFrame.setValue(t.getCurrentFrame(),e),this.currentTime.setValue(((i=t.animatables[0])==null?void 0:i.elapsedTime)??0,e))}_execute(e){this._startPendingTasks(e)}_onAnimationGroupEnd(e){this._removeFromCurrentlyRunning(e,this.currentAnimationGroup.getValue(e)),this._resetAfterCanceled(e),this.done._activateSignal(e)}_checkInterpolationDuplications(e,t,i){const r=e._getGlobalContextVariable("currentlyRunningAnimationGroups",[]);for(const n of r){const a=e.assetsContext.animationGroups.find(o=>o.uniqueId===n);if(a)for(const o of a.targetedAnimations)for(const l of t)o.animation.targetProperty===l.targetProperty&&o.target===i&&this._stopAnimationGroup(e,a)}}_stopAnimationGroup(e,t){t.stop(!0),t.dispose(),this._removeFromCurrentlyRunning(e,t)}_removeFromCurrentlyRunning(e,t){const i=e._getGlobalContextVariable("currentlyRunningAnimationGroups",[]),r=i.indexOf(t.uniqueId);r!==-1&&(i.splice(r,1),e._setGlobalContextVariable("currentlyRunningAnimationGroups",i))}_cancelPendingTasks(e){const t=this.currentAnimationGroup.getValue(e);t&&this._stopAnimationGroup(e,t)}getClassName(){return"FlowGraphPlayAnimationBlock"}}y("FlowGraphPlayAnimationBlock",f2);class p2 extends ch{constructor(e){super(e),this.animationGroup=this.registerDataInput("animationGroup",Y),this.stopAtFrame=this.registerDataInput("stopAtFrame",_e,-1)}_preparePendingTasks(e){const t=this.animationGroup.getValue(e),i=this.stopAtFrame.getValue(e)??-1,r=e._getGlobalContextVariable("pendingStopAnimations",[]);r.push({uniqueId:t.uniqueId,stopAtFrame:i}),e._setGlobalContextVariable("pendingStopAnimations",r)}_cancelPendingTasks(e){const t=this.animationGroup.getValue(e),i=e._getGlobalContextVariable("pendingStopAnimations",[]);for(let r=0;r<i.length;r++)if(i[r].uniqueId===t.uniqueId){i.splice(r,1),e._setGlobalContextVariable("pendingStopAnimations",i);break}}_execute(e){const t=this.animationGroup.getValue(e),i=this.stopAtFrame.getValue(e)??-1;if(!t)return N.Warn("No animation group provided to stop."),this._reportError(e,"No animation group provided to stop.");if(isNaN(i))return this._reportError(e,"Invalid stop time.");i>0?this._startPendingTasks(e):this._stopAnimation(t,e),this.out._activateSignal(e)}_executeOnTick(e){const t=this.animationGroup.getValue(e),i=e._getGlobalContextVariable("pendingStopAnimations",[]);for(let r=0;r<i.length;r++)if(i[r].uniqueId===t.uniqueId&&t.getCurrentFrame()>=i[r].stopAtFrame){this._stopAnimation(t,e),i.splice(r,1),e._setGlobalContextVariable("pendingStopAnimations",i),this.done._activateSignal(e),e._removePendingBlock(this);break}}getClassName(){return"FlowGraphStopAnimationBlock"}_stopAnimation(e,t){const i=t._getGlobalContextVariable("currentlyRunningAnimationGroups",[]),r=i.indexOf(e.uniqueId);r!==-1&&(e.stop(),i.splice(r,1),t._setGlobalContextVariable("currentlyRunningAnimationGroups",i))}}y("FlowGraphStopAnimationBlock",p2);class m2 extends yr{constructor(e){super(e),this.animationToPause=this.registerDataInput("animationToPause",Y)}_execute(e){this.animationToPause.getValue(e).pause(),this.out._activateSignal(e)}getClassName(){return"FlowGraphPauseAnimationBlock"}}y("FlowGraphPauseAnimationBlock",m2);class _2 extends Ni{constructor(e={}){super(e),this.keyFrames=[];const t=typeof(e==null?void 0:e.animationType)=="string"?pt(e.animationType):Yw((e==null?void 0:e.animationType)??0),i=(e==null?void 0:e.keyFramesCount)??1,r=this.registerDataInput("duration_0",_e,0),n=this.registerDataInput("value_0",t);this.keyFrames.push({duration:r,value:n});for(let a=1;a<i+1;a++){const o=this.registerDataInput(`duration_${a}`,_e,a===i?e.duration:void 0),l=this.registerDataInput(`value_${a}`,t);this.keyFrames.push({duration:o,value:l})}this.initialValue=this.keyFrames[0].value,this.endValue=this.keyFrames[i].value,this.easingFunction=this.registerDataInput("easingFunction",Y),this.animation=this.registerDataOutput("animation",Y),this.propertyName=this.registerDataInput("propertyName",Y,e==null?void 0:e.propertyName),this.customBuildAnimation=this.registerDataInput("customBuildAnimation",Y)}_updateOutputs(e){const t=e._getGlobalContextVariable("interpolationAnimations",[]),i=this.propertyName.getValue(e),r=this.easingFunction.getValue(e),n=this._createAnimation(e,i,r);if(this.animation.setValue(n,e),Array.isArray(n))for(const a of n)t.push(a.uniqueId);else t.push(n.uniqueId);e._setGlobalContextVariable("interpolationAnimations",t)}_createAnimation(e,t,i){var c,u,h;const r=this.initialValue.richType,n=[],a=this.initialValue.getValue(e)||r.defaultValue;n.push({frame:0,value:a});const o=((c=this.config)==null?void 0:c.numberOfKeyFrames)??1;for(let d=1;d<o+1;d++){const f=(u=this.keyFrames[d].duration)==null?void 0:u.getValue(e);let m=(h=this.keyFrames[d].value)==null?void 0:h.getValue(e);d===o-1&&(m=m||r.defaultValue),f!==void 0&&m&&n.push({frame:f*60,value:m})}const l=this.customBuildAnimation.getValue(e);if(l)return l(null,null,e)(n,60,r.animationType,i);if(typeof t=="string"){const d=pe.CreateAnimation(t,r.animationType,60,i);return d.setKeys(n),[d]}else return t.map(f=>{const m=pe.CreateAnimation(f,r.animationType,60,i);return m.setKeys(n),m})}getClassName(){return"FlowGraphInterpolationBlock"}}y("FlowGraphInterpolationBlock",_2);var hv;(function(s){s[s.CircleEase=0]="CircleEase",s[s.BackEase=1]="BackEase",s[s.BounceEase=2]="BounceEase",s[s.CubicEase=3]="CubicEase",s[s.ElasticEase=4]="ElasticEase",s[s.ExponentialEase=5]="ExponentialEase",s[s.PowerEase=6]="PowerEase",s[s.QuadraticEase=7]="QuadraticEase",s[s.QuarticEase=8]="QuarticEase",s[s.QuinticEase=9]="QuinticEase",s[s.SineEase=10]="SineEase",s[s.BezierCurveEase=11]="BezierCurveEase"})(hv||(hv={}));function g2(s,...e){switch(s){case 11:return new oI(...e);case 0:return new Pn;case 1:return new oa(...e);case 2:return new vD(...e);case 3:return new aa;case 4:return new na(...e);case 5:return new sa(...e);default:throw new Error("Easing type not yet implemented")}}class S2 extends Ni{constructor(e){super(e),this.config=e,this._easingFunctions={},this.type=this.registerDataInput("type",Y,11),this.mode=this.registerDataInput("mode",_e,0),this.parameters=this.registerDataInput("parameters",Y,[1,0,0,1]),this.easingFunction=this.registerDataOutput("easingFunction",Y)}_updateOutputs(e){const t=this.type.getValue(e),i=this.mode.getValue(e),r=this.parameters.getValue(e);if(t===void 0||i===void 0)return;const n=`${t}-${i}-${r.join("-")}`;if(!this._easingFunctions[n]){const a=g2(t,...r);a.setEasingMode(i),this._easingFunctions[n]=a}this.easingFunction.setValue(this._easingFunctions[n],e)}getClassName(){return"FlowGraphEasingBlock"}}y("FlowGraphEasingBlock",S2);class v2 extends Ni{constructor(e){super(e),this.config=e,this._easingFunctions={},this.mode=this.registerDataInput("mode",_e,0),this.controlPoint1=this.registerDataInput("controlPoint1",vn),this.controlPoint2=this.registerDataInput("controlPoint2",vn),this.easingFunction=this.registerDataOutput("easingFunction",Y)}_updateOutputs(e){const t=this.mode.getValue(e),i=this.controlPoint1.getValue(e),r=this.controlPoint2.getValue(e);if(t===void 0)return;const n=`${t}-${i.x}-${i.y}-${r.x}-${r.y}`;if(!this._easingFunctions[n]){const a=new oI(i.x,i.y,r.x,r.y);a.setEasingMode(t),this._easingFunctions[n]=a}this.easingFunction.setValue(this._easingFunctions[n],e)}getClassName(){return"FlowGraphBezierCurveEasing"}}y("FlowGraphBezierCurveEasing",v2);class x2 extends Ni{constructor(e){super(e),this.condition=this.registerDataInput("condition",Si),this.onTrue=this.registerDataInput("onTrue",Y),this.onFalse=this.registerDataInput("onFalse",Y),this.output=this.registerDataOutput("output",Y)}_updateOutputs(e){const t=this.condition.getValue(e);this.output.setValue(t?this.onTrue.getValue(e):this.onFalse.getValue(e),e)}getClassName(){return"FlowGraphConditionalBlock"}}y("FlowGraphConditionalBlock",x2);class E2 extends Ni{constructor(e){super(e),this.config=e,this.value=this.registerDataOutput("value",Y,e.initialValue)}_updateOutputs(e){const t=this.config.variable;e.hasVariable(t)&&this.value.setValue(e.getVariable(t),e)}serialize(e){super.serialize(e),e.config.variable=this.config.variable}getClassName(){return"FlowGraphGetVariableBlock"}}y("FlowGraphGetVariableBlock",E2);class T2 extends yr{constructor(e){if(super(e),!e.variable&&!e.variables)throw new Error("FlowGraphSetVariableBlock: variable/variables is not defined");if(e.variables&&e.variable)throw new Error("FlowGraphSetVariableBlock: variable and variables are both defined");if(e.variables)for(const t of e.variables)this.registerDataInput(t,Y);else this.registerDataInput("value",Y)}_execute(e,t){var i,r;if((i=this.config)!=null&&i.variables)for(const n of this.config.variables)this._saveVariable(e,n);else this._saveVariable(e,(r=this.config)==null?void 0:r.variable,"value");this.out._activateSignal(e)}_saveVariable(e,t,i){var a;const r=e._getGlobalContextVariable("currentlyRunningAnimationGroups",[]);for(const o of r){const l=e.assetsContext.animationGroups.find(c=>c.uniqueId==o);if(l){for(const c of l.targetedAnimations)if(c.target===e&&c.animation.targetProperty===t){l.stop();const u=r.indexOf(o);u>-1&&r.splice(u,1),e._setGlobalContextVariable("currentlyRunningAnimationGroups",r);break}}}const n=(a=this.getDataInput(i||t))==null?void 0:a.getValue(e);e.setVariable(t,n)}getClassName(){return"FlowGraphSetVariableBlock"}serialize(e){var t;super.serialize(e),e.config.variable=(t=this.config)==null?void 0:t.variable}}y("FlowGraphSetVariableBlock",T2);class b2 extends Ni{constructor(e){super(e),this.sourceSystem=this.registerDataInput("sourceSystem",Y),this.destinationSystem=this.registerDataInput("destinationSystem",Y),this.inputCoordinates=this.registerDataInput("inputCoordinates",ui),this.outputCoordinates=this.registerDataOutput("outputCoordinates",ui)}_updateOutputs(e){const t=this.sourceSystem.getValue(e),i=this.destinationSystem.getValue(e),r=this.inputCoordinates.getValue(e),n=t.getWorldMatrix(),a=i.getWorldMatrix(),o=G.Matrix[0].copyFrom(a);o.invert();const l=G.Matrix[1];o.multiplyToRef(n,l);const c=this.outputCoordinates.getValue(e);x.TransformCoordinatesToRef(r,l,c)}getClassName(){return"FlowGraphTransformCoordinatesSystemBlock"}}y("FlowGraphTransformCoordinatesSystemBlock",b2);const dv="cachedOperationValue",fv="cachedExecutionId";class wa extends Ni{constructor(e,t){super(t),this.value=this.registerDataOutput("value",e),this.isValid=this.registerDataOutput("isValid",Si)}_updateOutputs(e){const t=e._getExecutionVariable(this,fv,-1),i=e._getExecutionVariable(this,dv,null);if(i!=null&&t===e.executionId)this.isValid.setValue(!0,e),this.value.setValue(i,e);else try{const r=this._doOperation(e);if(r==null){this.isValid.setValue(!1,e);return}e._setExecutionVariable(this,dv,r),e._setExecutionVariable(this,fv,e.executionId),this.value.setValue(r,e),this.isValid.setValue(!0,e)}catch{this.isValid.setValue(!1,e)}}}class C2 extends wa{constructor(e){super(Y,e),this.config=e,this.object=this.registerDataInput("object",Y,e.object),this.propertyName=this.registerDataInput("propertyName",Y,e.propertyName),this.customGetFunction=this.registerDataInput("customGetFunction",Y)}_doOperation(e){const t=this.customGetFunction.getValue(e);let i;if(t)i=t(this.object.getValue(e),this.propertyName.getValue(e),e);else{const r=this.object.getValue(e),n=this.propertyName.getValue(e);i=r&&n?this._getPropertyValue(r,n):void 0}return i}_getPropertyValue(e,t){const i=t.split(".");let r=e;for(const n of i)if(r=r[n],r===void 0)return;return r}getClassName(){return"FlowGraphGetPropertyBlock"}}y("FlowGraphGetPropertyBlock",C2);class y2 extends yr{constructor(e){super(e),this.config=e,this.object=this.registerDataInput("object",Y,e.target),this.value=this.registerDataInput("value",Y),this.propertyName=this.registerDataInput("propertyName",Y,e.propertyName),this.customSetFunction=this.registerDataInput("customSetFunction",Y)}_execute(e,t){try{const i=this.object.getValue(e),r=this.value.getValue(e),n=this.propertyName.getValue(e);this._stopRunningAnimations(e,i,n);const a=this.customSetFunction.getValue(e);a?a(i,n,r,e):this._setPropertyValue(i,n,r)}catch(i){this._reportError(e,i)}this.out._activateSignal(e)}_stopRunningAnimations(e,t,i){const r=e._getGlobalContextVariable("currentlyRunningAnimationGroups",[]);for(const n of r){const a=e.assetsContext.animationGroups.find(o=>o.uniqueId===n);if(a){for(const o of a.targetedAnimations)if(o.target===t&&o.animation.targetProperty===i){a.stop(!0),a.dispose();const l=r.indexOf(n);l!==-1&&(r.splice(l,1),e._setGlobalContextVariable("currentlyRunningAnimationGroups",r))}}}}_setPropertyValue(e,t,i){const r=t.split(".");let n=e;for(let a=0;a<r.length-1;a++){const o=r[a];n[o]===void 0&&(n[o]={}),n=n[o]}n[r[r.length-1]]=i}getClassName(){return"FlowGraphSetPropertyBlock"}}y("FlowGraphSetPropertyBlock",y2);class I2 extends Ni{constructor(e){super(e),this.config=e,this.output=this.registerDataOutput("output",Xw(e.value))}_updateOutputs(e){this.output.setValue(this.config.value,e)}getClassName(){return"FlowGraphConstantBlock"}serialize(e={},t=lh){super.serialize(e),t("value",this.config.value,e.config)}}y("FlowGraphConstantBlock",I2);class R2 extends Ni{constructor(e){super(e),this.config=e,this.type=this.registerDataInput("type",Y,e.type),this.value=this.registerDataOutput("value",Y),this.index=this.registerDataInput("index",Y,new Ue(Rt(e.index??-1)))}_updateOutputs(e){const t=this.type.getValue(e),i=this.index.getValue(e),r=fR(e.assetsContext,t,Rt(i),this.config.useIndexAsUniqueId);this.value.setValue(r,e)}getClassName(){return"FlowGraphGetAssetBlock"}}y("FlowGraphGetAssetBlock",R2);class A2 extends Ni{constructor(e){super(e),this.config=e,this._inputCases=new Map,this.case=this.registerDataInput("case",Y,NaN),this.default=this.registerDataInput("default",Y),this.value=this.registerDataOutput("value",Y);const t=this.config.cases||[];for(let i of t){if(i=Rt(i),this.config.treatCasesAsIntegers&&(i=i|0,this._inputCases.has(i)))return;this._inputCases.set(i,this.registerDataInput(`in_${i}`,Y))}}_updateOutputs(e){const t=this.case.getValue(e);let i;Io(t)&&(i=this._getOutputValueForCase(Rt(t),e)),i||(i=this.default.getValue(e)),this.value.setValue(i,e)}_getOutputValueForCase(e,t){var i;return(i=this._inputCases.get(e))==null?void 0:i.getValue(t)}getClassName(){return"FlowGraphDataSwitchBlock"}}y("FlowGraphDataSwitchBlock",A2);class Ft extends wa{constructor(e,t,i,r,n,a){super(i,a),this._operation=r,this._className=n,this.a=this.registerDataInput("a",e),this.b=this.registerDataInput("b",t)}_doOperation(e){const t=this.a.getValue(e),i=this.b.getValue(e);return this._operation(t,i)}getClassName(){return this._className}}class sc extends wa{constructor(e,t,i,r){super(e,r),this._operation=t,this._className=i}_doOperation(e){return this._operation(e)}getClassName(){return this._className}}class He extends wa{constructor(e,t,i,r,n){super(t,n),this._operation=i,this._className=r,this.a=this.registerDataInput("a",e)}_doOperation(e){return this._operation(this.a.getValue(e))}getClassName(){return this._className}}class _R extends wa{constructor(e,t,i,r,n,a,o){super(r,o),this._operation=n,this._className=a,this.a=this.registerDataInput("a",e),this.b=this.registerDataInput("b",t),this.c=this.registerDataInput("c",i)}_doOperation(e){return this._operation(this.a.getValue(e),this.b.getValue(e),this.c.getValue(e))}getClassName(){return this._className}}class P2 extends Ft{constructor(e){super(pt(e==null?void 0:e.type),pt(e==null?void 0:e.type),pt(e==null?void 0:e.type),(t,i)=>this._polymorphicAdd(t,i),"FlowGraphAddBlock",e)}_polymorphicAdd(e,t){var n;const i=Gi(e),r=Gi(t);if(tc(i,r)||ic(i,r)||rc(i,r))return e.add(t);if(i==="Quaternion"||r==="Vector4")return new Ee(e.x,e.y,e.z,e.w).addInPlace(t);if(i==="Vector4"||r==="Quaternion")return e.add(t);if((n=this.config)!=null&&n.preventIntegerFloatArithmetic&&typeof e!=typeof t)throw new Error("Cannot add different types of numbers.");return Rt(e)+Rt(t)}}y("FlowGraphAddBlock",P2);class O2 extends Ft{constructor(e){super(pt(e==null?void 0:e.type),pt(e==null?void 0:e.type),pt(e==null?void 0:e.type),(t,i)=>this._polymorphicSubtract(t,i),"FlowGraphSubtractBlock",e)}_polymorphicSubtract(e,t){var n;const i=Gi(e),r=Gi(t);if(tc(i,r)||rc(i,r)||ic(i,r))return e.subtract(t);if(i==="Quaternion"||r==="Vector4")return new Ee(e.x,e.y,e.z,e.w).subtractInPlace(t);if(i==="Vector4"||r==="Quaternion")return e.subtract(t);if((n=this.config)!=null&&n.preventIntegerFloatArithmetic&&typeof e!=typeof t)throw new Error("Cannot add different types of numbers.");return Rt(e)-Rt(t)}}y("FlowGraphSubtractBlock",O2);class N2 extends Ft{constructor(e){super(pt(e==null?void 0:e.type),pt(e==null?void 0:e.type),pt(e==null?void 0:e.type),(t,i)=>this._polymorphicMultiply(t,i),"FlowGraphMultiplyBlock",e)}_polymorphicMultiply(e,t){var n,a;const i=Gi(e),r=Gi(t);if(tc(i,r)||rc(i,r))return e.multiply(t);if(i==="Quaternion"||r==="Vector4")return new Ee(e.x,e.y,e.z,e.w).multiplyInPlace(t);if(i==="Vector4"||r==="Quaternion")return e.multiply(t);if(ic(i,r))if((n=this.config)!=null&&n.useMatrixPerComponent){const o=e.m;for(let l=0;l<o.length;l++)o[l]*=t.m[l];return i==="Matrix2D"?new ir(o):i==="Matrix3D"?new rr(o):z.FromArray(o)}else return e=e,t=t,t.multiply(e);else{if((a=this.config)!=null&&a.preventIntegerFloatArithmetic&&typeof e!=typeof t)throw new Error("Cannot add different types of numbers.");return Rt(e)*Rt(t)}}}y("FlowGraphMultiplyBlock",N2);class D2 extends Ft{constructor(e){super(pt(e==null?void 0:e.type),pt(e==null?void 0:e.type),pt(e==null?void 0:e.type),(t,i)=>this._polymorphicDivide(t,i),"FlowGraphDivideBlock",e)}_polymorphicDivide(e,t){var n,a;const i=Gi(e),r=Gi(t);if(tc(i,r)||rc(i,r))return e.divide(t);if(i==="Quaternion"||r==="Quaternion"){const o=e.clone();return o.x/=t.x,o.y/=t.y,o.z/=t.z,o.w/=t.w,o}else{if(i==="Quaternion"||r==="Vector4")return new Ee(e.x,e.y,e.z,e.w).divideInPlace(t);if(i==="Vector4"||r==="Quaternion")return e.divide(t);if(ic(i,r))if((n=this.config)!=null&&n.useMatrixPerComponent){const o=e.m;for(let l=0;l<o.length;l++)o[l]/=t.m[l];return i==="Matrix2D"?new ir(o):i==="Matrix3D"?new rr(o):z.FromArray(o)}else return e=e,t=t,e.divide(t);else{if((a=this.config)!=null&&a.preventIntegerFloatArithmetic&&typeof e!=typeof t)throw new Error("Cannot add different types of numbers.");return Rt(e)/Rt(t)}}}}y("FlowGraphDivideBlock",D2);class M2 extends sc{constructor(e){super(_e,t=>this._random(t),"FlowGraphRandomBlock",e),this.min=this.registerDataInput("min",_e,(e==null?void 0:e.min)??0),this.max=this.registerDataInput("max",_e,(e==null?void 0:e.max)??1),e!=null&&e.seed&&(this._seed=e.seed)}_isSeed(e=this._seed){return e!==void 0}_getRandomValue(){if(this._isSeed(this._seed)){const e=Math.sin(this._seed++)*1e4;return e-Math.floor(e)}return Math.random()}_random(e){const t=this.min.getValue(e),i=this.max.getValue(e);return this._getRandomValue()*(i-t)+t}}y("FlowGraphRandomBlock",M2);class F2 extends sc{constructor(e){super(_e,()=>Math.E,"FlowGraphEBlock",e)}}y("FlowGraphEBlock",F2);class L2 extends sc{constructor(e){super(_e,()=>Math.PI,"FlowGraphPIBlock",e)}}y("FlowGraphPIBlock",L2);class w2 extends sc{constructor(e){super(_e,()=>Number.POSITIVE_INFINITY,"FlowGraphInfBlock",e)}}y("FlowGraphInfBlock",w2);class B2 extends sc{constructor(e){super(_e,()=>Number.NaN,"FlowGraphNaNBlock",e)}}y("FlowGraphNaNBlock",B2);function Gt(s,e){switch(Gi(s)){case"FlowGraphInteger":return s=s,new Ue(e(s.value));case"Vector2":return s=s,new X(e(s.x),e(s.y));case"Vector3":return s=s,new x(e(s.x),e(s.y),e(s.z));case"Vector4":return s=s,new Ee(e(s.x),e(s.y),e(s.z),e(s.w));case"Quaternion":return s=s,new Z(e(s.x),e(s.y),e(s.z),e(s.w));case"Matrix":return s=s,z.FromArray(s.m.map(e));case"Matrix2D":return s=s,new ir(s.m.map(e));case"Matrix3D":return s=s,new rr(s.m.map(e));default:return s=s,e(s)}}class V2 extends He{constructor(e){super(_e,_e,t=>this._polymorphicAbs(t),"FlowGraphAbsBlock",e)}_polymorphicAbs(e){return Gt(e,Math.abs)}}y("FlowGraphAbsBlock",V2);class U2 extends He{constructor(e){super(_e,_e,t=>this._polymorphicSign(t),"FlowGraphSignBlock",e)}_polymorphicSign(e){return Gt(e,Math.sign)}}y("FlowGraphSignBlock",U2);class k2 extends He{constructor(e){super(_e,_e,t=>this._polymorphicTrunc(t),"FlowGraphTruncBlock",e)}_polymorphicTrunc(e){return Gt(e,Math.trunc)}}y("FlowGraphTruncBlock",k2);class G2 extends He{constructor(e){super(_e,_e,t=>this._polymorphicFloor(t),"FlowGraphFloorBlock",e)}_polymorphicFloor(e){return Gt(e,Math.floor)}}y("FlowGraphFloorBlock",G2);class z2 extends He{constructor(e){super(Y,Y,t=>this._polymorphicCeiling(t),"FlowGraphCeilBlock",e)}_polymorphicCeiling(e){return Gt(e,Math.ceil)}}y("FlowGraphCeilBlock",z2);class W2 extends He{constructor(e){super(Y,Y,t=>this._polymorphicRound(t),"FlowGraphRoundBlock",e)}_polymorphicRound(e){return Gt(e,t=>{var i;return t<0&&((i=this.config)!=null&&i.roundHalfAwayFromZero)?-Math.round(-t):Math.round(t)})}}y("FlowGraphRoundBlock",W2);class H2 extends He{constructor(e){super(Y,Y,t=>this._polymorphicFraction(t),"FlowGraphFractBlock",e)}_polymorphicFraction(e){return Gt(e,t=>t-Math.floor(t))}}y("FlowGraphFractBlock",H2);class $2 extends He{constructor(e){super(Y,Y,t=>this._polymorphicNeg(t),"FlowGraphNegationBlock",e)}_polymorphicNeg(e){return Gt(e,t=>-t)}}y("FlowGraphNegationBlock",$2);function nc(s,e,t){switch(Gi(s)){case"FlowGraphInteger":return s=s,e=e,new Ue(t(s.value,e.value));case"Vector2":return s=s,e=e,new X(t(s.x,e.x),t(s.y,e.y));case"Vector3":return s=s,e=e,new x(t(s.x,e.x),t(s.y,e.y),t(s.z,e.z));case"Vector4":return s=s,e=e,new Ee(t(s.x,e.x),t(s.y,e.y),t(s.z,e.z),t(s.w,e.w));case"Quaternion":return s=s,e=e,new Z(t(s.x,e.x),t(s.y,e.y),t(s.z,e.z),t(s.w,e.w));case"Matrix":return s=s,z.FromArray(s.m.map((r,n)=>t(r,e.m[n])));case"Matrix2D":return s=s,new ir(s.m.map((r,n)=>t(r,e.m[n])));case"Matrix3D":return s=s,new rr(s.m.map((r,n)=>t(r,e.m[n])));default:return t(Rt(s),Rt(e))}}class X2 extends Ft{constructor(e){super(Y,Y,Y,(t,i)=>this._polymorphicRemainder(t,i),"FlowGraphModuloBlock",e)}_polymorphicRemainder(e,t){return nc(e,t,(i,r)=>i%r)}}y("FlowGraphModuloBlock",X2);class Y2 extends Ft{constructor(e){super(Y,Y,Y,(t,i)=>this._polymorphicMin(t,i),"FlowGraphMinBlock",e)}_polymorphicMin(e,t){return nc(e,t,Math.min)}}y("FlowGraphMinBlock",Y2);class j2 extends Ft{constructor(e){super(Y,Y,Y,(t,i)=>this._polymorphicMax(t,i),"FlowGraphMaxBlock",e)}_polymorphicMax(e,t){return nc(e,t,Math.max)}}y("FlowGraphMaxBlock",j2);function q2(s,e,t){return Math.min(Math.max(s,Math.min(e,t)),Math.max(e,t))}function gR(s,e,t,i){switch(Gi(s)){case"FlowGraphInteger":return s=s,e=e,t=t,new Ue(i(s.value,e.value,t.value));case"Vector2":return s=s,e=e,t=t,new X(i(s.x,e.x,t.x),i(s.y,e.y,t.y));case"Vector3":return s=s,e=e,t=t,new x(i(s.x,e.x,t.x),i(s.y,e.y,t.y),i(s.z,e.z,t.z));case"Vector4":return s=s,e=e,t=t,new Ee(i(s.x,e.x,t.x),i(s.y,e.y,t.y),i(s.z,e.z,t.z),i(s.w,e.w,t.w));case"Quaternion":return s=s,e=e,t=t,new Z(i(s.x,e.x,t.x),i(s.y,e.y,t.y),i(s.z,e.z,t.z),i(s.w,e.w,t.w));case"Matrix":return z.FromArray(s.m.map((n,a)=>i(n,e.m[a],t.m[a])));case"Matrix2D":return new ir(s.m.map((n,a)=>i(n,e.m[a],t.m[a])));case"Matrix3D":return new rr(s.m.map((n,a)=>i(n,e.m[a],t.m[a])));default:return i(Rt(s),Rt(e),Rt(t))}}class Z2 extends _R{constructor(e){super(Y,Y,Y,Y,(t,i,r)=>this._polymorphicClamp(t,i,r),"FlowGraphClampBlock",e)}_polymorphicClamp(e,t,i){return gR(e,t,i,q2)}}y("FlowGraphClampBlock",Z2);function Q2(s){return Math.min(Math.max(s,0),1)}class K2 extends He{constructor(e){super(Y,Y,t=>this._polymorphicSaturate(t),"FlowGraphSaturateBlock",e)}_polymorphicSaturate(e){return Gt(e,Q2)}}y("FlowGraphSaturateBlock",K2);function J2(s,e,t){return(1-t)*s+t*e}class eB extends _R{constructor(e){super(Y,Y,Y,Y,(t,i,r)=>this._polymorphicInterpolate(t,i,r),"FlowGraphMathInterpolationBlock",e)}_polymorphicInterpolate(e,t,i){return gR(e,t,i,J2)}}y("FlowGraphMathInterpolationBlock",eB);class tB extends Ft{constructor(e){super(Y,Y,Si,(t,i)=>this._polymorphicEq(t,i),"FlowGraphEqualityBlock",e)}_polymorphicEq(e,t){const i=Gi(e),r=Gi(t);return typeof e!=typeof t?!1:tc(i,r)||ic(i,r)||rc(i,r)?e.equals(t):e===t}}y("FlowGraphEqualityBlock",tB);function fh(s,e,t){if(Io(s)&&Io(e))return t(Rt(s),Rt(e));throw new Error(`Cannot compare ${s} and ${e}`)}class iB extends Ft{constructor(e){super(Y,Y,Si,(t,i)=>this._polymorphicLessThan(t,i),"FlowGraphLessThanBlock",e)}_polymorphicLessThan(e,t){return fh(e,t,(i,r)=>i<r)}}y("FlowGraphLessThanBlock",iB);class rB extends Ft{constructor(e){super(Y,Y,Si,(t,i)=>this._polymorphicLessThanOrEqual(t,i),"FlowGraphLessThanOrEqualBlock",e)}_polymorphicLessThanOrEqual(e,t){return fh(e,t,(i,r)=>i<=r)}}y("FlowGraphLessThanOrEqualBlock",rB);class sB extends Ft{constructor(e){super(Y,Y,Si,(t,i)=>this._polymorphicGreaterThan(t,i),"FlowGraphGreaterThanBlock",e)}_polymorphicGreaterThan(e,t){return fh(e,t,(i,r)=>i>r)}}y("FlowGraphGreaterThanBlock",sB);class nB extends Ft{constructor(e){super(Y,Y,Si,(t,i)=>this._polymorphicGreaterThanOrEqual(t,i),"FlowGraphGreaterThanOrEqualBlock",e)}_polymorphicGreaterThanOrEqual(e,t){return fh(e,t,(i,r)=>i>=r)}}y("FlowGraphGreaterThanOrEqualBlock",nB);class aB extends He{constructor(e){super(Y,Si,t=>this._polymorphicIsNan(t),"FlowGraphIsNaNBlock",e)}_polymorphicIsNan(e){if(Io(e,!0))return isNaN(Rt(e));throw new Error(`Cannot get NaN of ${e}`)}}y("FlowGraphIsNaNBlock",aB);class oB extends He{constructor(e){super(Y,Si,t=>this._polymorphicIsInf(t),"FlowGraphIsInfBlock",e)}_polymorphicIsInf(e){if(Io(e))return!isFinite(Rt(e));throw new Error(`Cannot get isInf of ${e}`)}}y("FlowGraphIsInfBlock",oB);class lB extends He{constructor(e){super(Y,Y,t=>this._polymorphicDegToRad(t),"FlowGraphDegToRadBlock",e)}_degToRad(e){return e*Math.PI/180}_polymorphicDegToRad(e){return Gt(e,this._degToRad)}}y("FlowGraphDegToRadBlock",lB);class cB extends He{constructor(e){super(Y,Y,t=>this._polymorphicRadToDeg(t),"FlowGraphRadToDegBlock",e)}_radToDeg(e){return e*180/Math.PI}_polymorphicRadToDeg(e){return Gt(e,this._radToDeg)}}y("FlowGraphRadToDegBlock",cB);class uB extends He{constructor(e){super(_e,_e,t=>this._polymorphicAsin(t),"FlowGraphASinBlock",e)}_polymorphicAsin(e){return Gt(e,Math.asin)}}y("FlowGraphASinBlock",uB);class hB extends He{constructor(e){super(_e,_e,t=>this._polymorphicAcos(t),"FlowGraphACosBlock",e)}_polymorphicAcos(e){return Gt(e,Math.acos)}}y("FlowGraphACosBlock",hB);class dB extends He{constructor(e){super(_e,_e,t=>this._polymorphicAtan(t),"FlowGraphATanBlock",e)}_polymorphicAtan(e){return Gt(e,Math.atan)}}y("FlowGraphATanBlock",dB);class fB extends Ft{constructor(e){super(Y,Y,Y,(t,i)=>this._polymorphicAtan2(t,i),"FlowGraphATan2Block",e)}_polymorphicAtan2(e,t){return nc(e,t,Math.atan2)}}y("FlowGraphATan2Block",fB);class pB extends He{constructor(e){super(Y,Y,t=>this._polymorphicSinh(t),"FlowGraphSinhBlock",e)}_polymorphicSinh(e){return Gt(e,Math.sinh)}}y("FlowGraphSinhBlock",pB);class mB extends He{constructor(e){super(Y,Y,t=>this._polymorphicCosh(t),"FlowGraphCoshBlock",e)}_polymorphicCosh(e){return Gt(e,Math.cosh)}}y("FlowGraphCoshBlock",mB);class _B extends He{constructor(e){super(Y,Y,t=>this._polymorphicTanh(t),"FlowGraphTanhBlock",e)}_polymorphicTanh(e){return Gt(e,Math.tanh)}}y("FlowGraphTanhBlock",_B);class gB extends He{constructor(e){super(Y,_e,t=>this._polymorphicAsinh(t),"FlowGraphASinhBlock",e)}_polymorphicAsinh(e){return Gt(e,Math.asinh)}}y("FlowGraphASinhBlock",gB);class SB extends He{constructor(e){super(Y,_e,t=>this._polymorphicAcosh(t),"FlowGraphACoshBlock",e)}_polymorphicAcosh(e){return Gt(e,Math.acosh)}}y("FlowGraphACoshBlock",SB);class vB extends He{constructor(e){super(Y,_e,t=>this._polymorphicAtanh(t),"FlowGraphATanhBlock",e)}_polymorphicAtanh(e){return Gt(e,Math.atanh)}}y("FlowGraphATanhBlock",vB);class xB extends He{constructor(e){super(Y,_e,t=>this._polymorphicExp(t),"FlowGraphExponentialBlock",e)}_polymorphicExp(e){return Gt(e,Math.exp)}}y("FlowGraphExponentialBlock",xB);class EB extends He{constructor(e){super(Y,_e,t=>this._polymorphicLog(t),"FlowGraphLogBlock",e)}_polymorphicLog(e){return Gt(e,Math.log)}}y("FlowGraphLogBlock",EB);class TB extends He{constructor(e){super(Y,_e,t=>this._polymorphicLog2(t),"FlowGraphLog2Block",e)}_polymorphicLog2(e){return Gt(e,Math.log2)}}y("FlowGraphLog2Block",TB);class bB extends He{constructor(e){super(Y,_e,t=>this._polymorphicLog10(t),"FlowGraphLog10Block",e)}_polymorphicLog10(e){return Gt(e,Math.log10)}}y("FlowGraphLog10Block",bB);class CB extends He{constructor(e){super(Y,_e,t=>this._polymorphicSqrt(t),"FlowGraphSquareRootBlock",e)}_polymorphicSqrt(e){return Gt(e,Math.sqrt)}}y("FlowGraphSquareRootBlock",CB);class yB extends He{constructor(e){super(Y,_e,t=>this._polymorphicCubeRoot(t),"FlowGraphCubeRootBlock",e)}_polymorphicCubeRoot(e){return Gt(e,Math.cbrt)}}y("FlowGraphCubeRootBlock",yB);class IB extends Ft{constructor(e){super(Y,_e,_e,(t,i)=>this._polymorphicPow(t,i),"FlowGraphPowerBlock",e)}_polymorphicPow(e,t){return nc(e,t,Math.pow)}}y("FlowGraphPowerBlock",IB);class RB extends He{constructor(e){super(pt((e==null?void 0:e.valueType)||"FlowGraphInteger"),pt((e==null?void 0:e.valueType)||"FlowGraphInteger"),t=>typeof t=="boolean"?!t:typeof t=="number"?~t:new Ue(~t.value),"FlowGraphBitwiseNotBlock",e)}}y("FlowGraphBitwiseNotBlock",RB);class AB extends Ft{constructor(e){super(pt((e==null?void 0:e.valueType)||"FlowGraphInteger"),pt((e==null?void 0:e.valueType)||"FlowGraphInteger"),pt((e==null?void 0:e.valueType)||"FlowGraphInteger"),(t,i)=>{if(typeof t=="boolean"&&typeof i=="boolean")return t&&i;if(typeof t=="number"&&typeof i=="number")return t&i;if(typeof t=="object"&&typeof i=="object")return new Ue(t.value&i.value);throw new Error(`Cannot perform bitwise AND on ${t} and ${i}`)},"FlowGraphBitwiseAndBlock",e)}}y("FlowGraphBitwiseAndBlock",AB);class PB extends Ft{constructor(e){super(pt((e==null?void 0:e.valueType)||"FlowGraphInteger"),pt((e==null?void 0:e.valueType)||"FlowGraphInteger"),pt((e==null?void 0:e.valueType)||"FlowGraphInteger"),(t,i)=>{if(typeof t=="boolean"&&typeof i=="boolean")return t||i;if(typeof t=="number"&&typeof i=="number")return t|i;if(typeof t=="object"&&typeof i=="object")return new Ue(t.value|i.value);throw new Error(`Cannot perform bitwise OR on ${t} and ${i}`)},"FlowGraphBitwiseOrBlock",e)}}y("FlowGraphBitwiseOrBlock",PB);class OB extends Ft{constructor(e){super(pt((e==null?void 0:e.valueType)||"FlowGraphInteger"),pt((e==null?void 0:e.valueType)||"FlowGraphInteger"),pt((e==null?void 0:e.valueType)||"FlowGraphInteger"),(t,i)=>{if(typeof t=="boolean"&&typeof i=="boolean")return t!==i;if(typeof t=="number"&&typeof i=="number")return t^i;if(typeof t=="object"&&typeof i=="object")return new Ue(t.value^i.value);throw new Error(`Cannot perform bitwise XOR on ${t} and ${i}`)},"FlowGraphBitwiseXorBlock",e)}}y("FlowGraphBitwiseXorBlock",OB);class NB extends Ft{constructor(e){super(wt,wt,wt,(t,i)=>new Ue(t.value<<i.value),"FlowGraphBitwiseLeftShiftBlock",e)}}y("FlowGraphBitwiseLeftShiftBlock",NB);class DB extends Ft{constructor(e){super(wt,wt,wt,(t,i)=>new Ue(t.value>>i.value),"FlowGraphBitwiseRightShiftBlock",e)}}y("FlowGraphBitwiseRightShiftBlock",DB);class MB extends He{constructor(e){super(wt,wt,t=>new Ue(Math.clz32(t.value)),"FlowGraphLeadingZerosBlock",e)}}y("FlowGraphLeadingZerosBlock",MB);class FB extends He{constructor(e){super(wt,wt,t=>new Ue(t.value?31-Math.clz32(t.value&-t.value):32),"FlowGraphTrailingZerosBlock",e)}}y("FlowGraphTrailingZerosBlock",FB);function LB(s){let e=0;for(;s;)e+=s&1,s>>=1;return e}class wB extends He{constructor(e){super(wt,wt,t=>new Ue(LB(t.value)),"FlowGraphOneBitsCounterBlock",e)}}y("FlowGraphOneBitsCounterBlock",wB);class $o extends wa{constructor(e,t,i){super(t,i);for(let r=0;r<e;r++)this.registerDataInput(`input_${r}`,_e,0)}}class Xo extends Ni{constructor(e,t,i){super(i),this.registerDataInput("input",t);for(let r=0;r<e;r++)this.registerDataOutput(`output_${r}`,_e,0)}}class BB extends $o{constructor(e){super(2,vn,e)}_doOperation(e){e._hasExecutionVariable(this,"cachedVector")||e._setExecutionVariable(this,"cachedVector",new X);const t=e._getExecutionVariable(this,"cachedVector",null);return t.set(this.getDataInput("input_0").getValue(e),this.getDataInput("input_1").getValue(e)),t}getClassName(){return"FlowGraphCombineVector2Block"}}y("FlowGraphCombineVector2Block",BB);class VB extends $o{constructor(e){super(3,ui,e)}_doOperation(e){e._hasExecutionVariable(this,"cachedVector")||e._setExecutionVariable(this,"cachedVector",new x);const t=e._getExecutionVariable(this,"cachedVector",null);return t.set(this.getDataInput("input_0").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_2").getValue(e)),t}getClassName(){return"FlowGraphCombineVector3Block"}}y("FlowGraphCombineVector3Block",VB);class UB extends $o{constructor(e){super(4,nh,e)}_doOperation(e){e._hasExecutionVariable(this,"cachedVector")||e._setExecutionVariable(this,"cachedVector",new Ee);const t=e._getExecutionVariable(this,"cachedVector",null);return t.set(this.getDataInput("input_0").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_3").getValue(e)),t}getClassName(){return"FlowGraphCombineVector4Block"}}y("FlowGraphCombineVector4Block",UB);class kB extends $o{constructor(e){super(16,Zn,e)}_doOperation(e){var i;e._hasExecutionVariable(this,"cachedMatrix")||e._setExecutionVariable(this,"cachedMatrix",new z);const t=e._getExecutionVariable(this,"cachedMatrix",null);return(i=this.config)!=null&&i.inputIsColumnMajor?t.set(this.getDataInput("input_0").getValue(e),this.getDataInput("input_4").getValue(e),this.getDataInput("input_8").getValue(e),this.getDataInput("input_12").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_5").getValue(e),this.getDataInput("input_9").getValue(e),this.getDataInput("input_13").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_6").getValue(e),this.getDataInput("input_10").getValue(e),this.getDataInput("input_14").getValue(e),this.getDataInput("input_3").getValue(e),this.getDataInput("input_7").getValue(e),this.getDataInput("input_11").getValue(e),this.getDataInput("input_15").getValue(e)):t.set(this.getDataInput("input_0").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_3").getValue(e),this.getDataInput("input_4").getValue(e),this.getDataInput("input_5").getValue(e),this.getDataInput("input_6").getValue(e),this.getDataInput("input_7").getValue(e),this.getDataInput("input_8").getValue(e),this.getDataInput("input_9").getValue(e),this.getDataInput("input_10").getValue(e),this.getDataInput("input_11").getValue(e),this.getDataInput("input_12").getValue(e),this.getDataInput("input_13").getValue(e),this.getDataInput("input_14").getValue(e),this.getDataInput("input_15").getValue(e)),t}getClassName(){return"FlowGraphCombineMatrixBlock"}}y("FlowGraphCombineMatrixBlock",kB);class GB extends $o{constructor(e){super(4,ah,e)}_doOperation(e){var r;e._hasExecutionVariable(this,"cachedMatrix")||e._setExecutionVariable(this,"cachedMatrix",new ir);const t=e._getExecutionVariable(this,"cachedMatrix",null),i=(r=this.config)!=null&&r.inputIsColumnMajor?[this.getDataInput("input_0").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_3").getValue(e)]:[this.getDataInput("input_0").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_3").getValue(e)];return t.fromArray(i),t}getClassName(){return"FlowGraphCombineMatrix2DBlock"}}y("FlowGraphCombineMatrix2DBlock",GB);class zB extends $o{constructor(e){super(9,oh,e)}_doOperation(e){var r;e._hasExecutionVariable(this,"cachedMatrix")||e._setExecutionVariable(this,"cachedMatrix",new rr);const t=e._getExecutionVariable(this,"cachedMatrix",null),i=(r=this.config)!=null&&r.inputIsColumnMajor?[this.getDataInput("input_0").getValue(e),this.getDataInput("input_3").getValue(e),this.getDataInput("input_6").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_4").getValue(e),this.getDataInput("input_7").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_5").getValue(e),this.getDataInput("input_8").getValue(e)]:[this.getDataInput("input_0").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_3").getValue(e),this.getDataInput("input_4").getValue(e),this.getDataInput("input_5").getValue(e),this.getDataInput("input_6").getValue(e),this.getDataInput("input_7").getValue(e),this.getDataInput("input_8").getValue(e)];return t.fromArray(i),t}getClassName(){return"FlowGraphCombineMatrix3DBlock"}}y("FlowGraphCombineMatrix3DBlock",zB);class WB extends Xo{constructor(e){super(2,vn,e)}_updateOutputs(e){var i;let t=(i=this.getDataInput("input"))==null?void 0:i.getValue(e);t||(t=X.Zero(),this.getDataInput("input").setValue(t,e)),this.getDataOutput("output_0").setValue(t.x,e),this.getDataOutput("output_1").setValue(t.y,e)}getClassName(){return"FlowGraphExtractVector2Block"}}y("FlowGraphExtractVector2Block",WB);class HB extends Xo{constructor(e){super(3,ui,e)}_updateOutputs(e){var i;let t=(i=this.getDataInput("input"))==null?void 0:i.getValue(e);t||(t=x.Zero(),this.getDataInput("input").setValue(t,e)),this.getDataOutput("output_0").setValue(t.x,e),this.getDataOutput("output_1").setValue(t.y,e),this.getDataOutput("output_2").setValue(t.z,e)}getClassName(){return"FlowGraphExtractVector3Block"}}y("FlowGraphExtractVector3Block",HB);class $B extends Xo{constructor(e){super(4,nh,e)}_updateOutputs(e){var i;let t=(i=this.getDataInput("input"))==null?void 0:i.getValue(e);t||(t=Ee.Zero(),this.getDataInput("input").setValue(t,e)),this.getDataOutput("output_0").setValue(t.x,e),this.getDataOutput("output_1").setValue(t.y,e),this.getDataOutput("output_2").setValue(t.z,e),this.getDataOutput("output_3").setValue(t.w,e)}getClassName(){return"FlowGraphExtractVector4Block"}}y("FlowGraphExtractVector4Block",$B);class XB extends Xo{constructor(e){super(16,Zn,e)}_updateOutputs(e){var i;let t=(i=this.getDataInput("input"))==null?void 0:i.getValue(e);t||(t=z.Identity(),this.getDataInput("input").setValue(t,e));for(let r=0;r<16;r++)this.getDataOutput(`output_${r}`).setValue(t.m[r],e)}getClassName(){return"FlowGraphExtractMatrixBlock"}}y("FlowGraphExtractMatrixBlock",XB);class YB extends Xo{constructor(e){super(4,ah,e)}_updateOutputs(e){var i;let t=(i=this.getDataInput("input"))==null?void 0:i.getValue(e);t||(t=new ir,this.getDataInput("input").setValue(t,e));for(let r=0;r<4;r++)this.getDataOutput(`output_${r}`).setValue(t.m[r],e)}getClassName(){return"FlowGraphExtractMatrix2DBlock"}}y("FlowGraphExtractMatrix2DBlock",YB);class jB extends Xo{constructor(e){super(9,oh,e)}_updateOutputs(e){var i;let t=(i=this.getDataInput("input"))==null?void 0:i.getValue(e);t||(t=new rr,this.getDataInput("input").setValue(t,e));for(let r=0;r<9;r++)this.getDataOutput(`output_${r}`).setValue(t.m[r],e)}getClassName(){return"FlowGraphExtractMatrix3DBlock"}}y("FlowGraphExtractMatrix3DBlock",jB);class qB extends He{constructor(e){super(pt((e==null?void 0:e.matrixType)||"Matrix"),pt((e==null?void 0:e.matrixType)||"Matrix"),t=>t.transpose?t.transpose():z.Transpose(t),"FlowGraphTransposeBlock",e)}}y("FlowGraphTransposeBlock",qB);class ZB extends He{constructor(e){super(pt((e==null?void 0:e.matrixType)||"Matrix"),_e,t=>t.determinant(),"FlowGraphDeterminantBlock",e)}}y("FlowGraphDeterminantBlock",ZB);class QB extends He{constructor(e){super(pt((e==null?void 0:e.matrixType)||"Matrix"),pt((e==null?void 0:e.matrixType)||"Matrix"),t=>t.inverse?t.inverse():z.Invert(t),"FlowGraphInvertMatrixBlock",e)}}y("FlowGraphInvertMatrixBlock",QB);class KB extends Ft{constructor(e){super(pt((e==null?void 0:e.matrixType)||"Matrix"),pt((e==null?void 0:e.matrixType)||"Matrix"),pt((e==null?void 0:e.matrixType)||"Matrix"),(t,i)=>i.multiply(t),"FlowGraphMatrixMultiplicationBlock",e)}}y("FlowGraphMatrixMultiplicationBlock",KB);class JB extends Ni{constructor(e){super(e),this.input=this.registerDataInput("input",Zn),this.position=this.registerDataOutput("position",ui),this.rotationQuaternion=this.registerDataOutput("rotationQuaternion",wr),this.scaling=this.registerDataOutput("scaling",ui),this.isValid=this.registerDataOutput("isValid",Si,!1)}_updateOutputs(e){const t=e._getExecutionVariable(this,"executionId",-1),i=e._getExecutionVariable(this,"cachedPosition",null),r=e._getExecutionVariable(this,"cachedRotation",null),n=e._getExecutionVariable(this,"cachedScaling",null);if(t===e.executionId&&i&&r&&n)this.position.setValue(i,e),this.rotationQuaternion.setValue(r,e),this.scaling.setValue(n,e);else{const a=this.input.getValue(e),o=i||new x,l=r||new Z,c=n||new x,u=Math.round(a.m[3]*1e4)/1e4,h=Math.round(a.m[7]*1e4)/1e4,d=Math.round(a.m[11]*1e4)/1e4,f=Math.round(a.m[15]*1e4)/1e4;if(u!==0||h!==0||d!==0||f!==1){this.isValid.setValue(!1,e),this.position.setValue(x.Zero(),e),this.rotationQuaternion.setValue(Z.Identity(),e),this.scaling.setValue(x.One(),e);return}const m=a.decompose(c,l,o);this.isValid.setValue(m,e),this.position.setValue(o,e),this.rotationQuaternion.setValue(l,e),this.scaling.setValue(c,e),e._setExecutionVariable(this,"cachedPosition",o),e._setExecutionVariable(this,"cachedRotation",l),e._setExecutionVariable(this,"cachedScaling",c),e._setExecutionVariable(this,"executionId",e.executionId)}}getClassName(){return"FlowGraphMatrixDecompose"}}y("FlowGraphMatrixDecompose",JB);class e1 extends Ni{constructor(e){super(e),this.position=this.registerDataInput("position",ui),this.rotationQuaternion=this.registerDataInput("rotationQuaternion",wr),this.scaling=this.registerDataInput("scaling",ui),this.value=this.registerDataOutput("value",Zn)}_updateOutputs(e){const t=e._getExecutionVariable(this,"executionId",-1),i=e._getExecutionVariable(this,"cachedMatrix",null);if(t===e.executionId&&i)this.value.setValue(i,e);else{const r=z.Compose(this.scaling.getValue(e),this.rotationQuaternion.getValue(e),this.position.getValue(e));this.value.setValue(r,e),e._setExecutionVariable(this,"cachedMatrix",r),e._setExecutionVariable(this,"executionId",e.executionId)}}getClassName(){return"FlowGraphMatrixCompose"}}y("FlowGraphMatrixCompose",e1);function SR(s,e){return`{X: ${s.x.toFixed(e)} Y: ${s.y.toFixed(e)}}`}function vR(s,e){return`{X: ${s._x.toFixed(e)} Y: ${s._y.toFixed(e)} Z: ${s._z.toFixed(e)}}`}function t1(s,e){return`{X: ${s.x.toFixed(e)} Y: ${s.y.toFixed(e)} Z: ${s.z.toFixed(e)} W: ${s.w.toFixed(e)}}`}function i1(s,e){return Math.acos(ls(Z.Dot(s,e)))*2}const pv="cachedOperationAxis",mv="cachedOperationAngle",_v="cachedExecutionId";class r1 extends He{constructor(e){super(Y,_e,t=>this._polymorphicLength(t),"FlowGraphLengthBlock",e)}_polymorphicLength(e){switch(Gi(e)){case"Vector2":case"Vector3":case"Vector4":case"Quaternion":return e.length();default:throw new Error(`Cannot compute length of value ${e}`)}}}y("FlowGraphLengthBlock",r1);class s1 extends He{constructor(e){super(Y,Y,t=>this._polymorphicNormalize(t),"FlowGraphNormalizeBlock",e)}_polymorphicNormalize(e){var r;const t=Gi(e);let i;switch(t){case"Vector2":case"Vector3":case"Vector4":case"Quaternion":return i=e.normalizeToNew(),(r=this.config)!=null&&r.nanOnZeroLength&&e.length()===0&&i.setAll(NaN),i;default:throw new Error(`Cannot normalize value ${e}`)}}}y("FlowGraphNormalizeBlock",s1);class n1 extends Ft{constructor(e){super(Y,Y,_e,(t,i)=>this._polymorphicDot(t,i),"FlowGraphDotBlock",e)}_polymorphicDot(e,t){switch(Gi(e)){case"Vector2":case"Vector3":case"Vector4":case"Quaternion":return e.dot(t);default:throw new Error(`Cannot get dot product of ${e} and ${t}`)}}}y("FlowGraphDotBlock",n1);class a1 extends Ft{constructor(e){super(ui,ui,ui,(t,i)=>x.Cross(t,i),"FlowGraphCrossBlock",e)}}y("FlowGraphCrossBlock",a1);class o1 extends Ft{constructor(e){super(vn,_e,vn,(t,i)=>t.rotate(i),"FlowGraphRotate2DBlock",e)}}y("FlowGraphRotate2DBlock",o1);class l1 extends Ft{constructor(e){super(ui,wr,ui,(t,i)=>t.applyRotationQuaternion(i),"FlowGraphRotate3DBlock",e)}}y("FlowGraphRotate3DBlock",l1);function c1(s,e){switch(Gi(s)){case"Vector2":return e.transformVector(s);case"Vector3":return e.transformVector(s);case"Vector4":return s=s,new Ee(s.x*e.m[0]+s.y*e.m[1]+s.z*e.m[2]+s.w*e.m[3],s.x*e.m[4]+s.y*e.m[5]+s.z*e.m[6]+s.w*e.m[7],s.x*e.m[8]+s.y*e.m[9]+s.z*e.m[10]+s.w*e.m[11],s.x*e.m[12]+s.y*e.m[13]+s.z*e.m[14]+s.w*e.m[15]);default:throw new Error(`Cannot transform value ${s}`)}}class u1 extends Ft{constructor(e){const t=(e==null?void 0:e.vectorType)||"Vector3",i=t==="Vector2"?"Matrix2D":t==="Vector3"?"Matrix3D":"Matrix";super(pt(t),pt(i),pt(t),c1,"FlowGraphTransformVectorBlock",e)}}y("FlowGraphTransformVectorBlock",u1);class h1 extends Ft{constructor(e){super(ui,Zn,ui,(t,i)=>x.TransformCoordinates(t,i),"FlowGraphTransformCoordinatesBlock",e)}}y("FlowGraphTransformCoordinatesBlock",h1);class d1 extends He{constructor(e){super(wr,wr,t=>t.conjugate(),"FlowGraphConjugateBlock",e)}}y("FlowGraphConjugateBlock",d1);class f1 extends Ft{constructor(e){super(wr,wr,_e,(t,i)=>i1(t,i),"FlowGraphAngleBetweenBlock",e)}}y("FlowGraphAngleBetweenBlock",f1);class p1 extends Ft{constructor(e){super(ui,_e,wr,(t,i)=>Z.RotationAxis(t,i),"FlowGraphQuaternionFromAxisAngleBlock",e)}}y("FlowGraphQuaternionFromAxisAngleBlock",p1);class m1 extends Ni{constructor(e){super(e),this.a=this.registerDataInput("a",wr),this.axis=this.registerDataOutput("axis",ui),this.angle=this.registerDataOutput("angle",_e),this.isValid=this.registerDataOutput("isValid",Si)}_updateOutputs(e){const t=e._getExecutionVariable(this,_v,-1),i=e._getExecutionVariable(this,pv,null),r=e._getExecutionVariable(this,mv,null);if(i!=null&&r!==void 0&&r!==null&&t===e.executionId)this.axis.setValue(i,e),this.angle.setValue(r,e);else try{const{axis:n,angle:a}=this.a.getValue(e).toAxisAngle();e._setExecutionVariable(this,pv,n),e._setExecutionVariable(this,mv,a),e._setExecutionVariable(this,_v,e.executionId),this.axis.setValue(n,e),this.angle.setValue(a,e),this.isValid.setValue(!0,e)}catch{this.isValid.setValue(!1,e)}}getClassName(){return"FlowGraphAxisAngleFromQuaternionBlock"}}y("FlowGraphAxisAngleFromQuaternionBlock",m1);class _1 extends wa{constructor(e){super(Y,e),this.config=e,this.object=this.registerDataOutput("object",Y),this.propertyName=this.registerDataOutput("propertyName",Y),this.setterFunction=this.registerDataOutput("setFunction",Y,this._setPropertyValue.bind(this)),this.getterFunction=this.registerDataOutput("getFunction",Y,this._getPropertyValue.bind(this)),this.generateAnimationsFunction=this.registerDataOutput("generateAnimationsFunction",Y,this._getInterpolationAnimationPropertyInfo.bind(this)),this.templateComponent=new Jw(e.jsonPointer,this)}_doOperation(e){var a,o,l;const t=this.templateComponent.getAccessor(this.config.pathConverter,e),i=t.info.get(t.object),r=(o=(a=t.info).getTarget)==null?void 0:o.call(a,t.object),n=(l=t.info.getPropertyName)==null?void 0:l[0](t.object);if(r)this.object.setValue(r,e),n&&this.propertyName.setValue(n,e);else throw new Error("Object is undefined");return i}_setPropertyValue(e,t,i,r){var o,l;const n=this.templateComponent.getAccessor(this.config.pathConverter,r),a=n.info.type;a.startsWith("Color")&&(i=gv(i,a)),(l=(o=n.info).set)==null||l.call(o,i,n.object)}_getPropertyValue(e,t,i){const r=this.templateComponent.getAccessor(this.config.pathConverter,i),n=r.info.type,a=r.info.get(r.object);return n.startsWith("Color")?g1(a):a}_getInterpolationAnimationPropertyInfo(e,t,i){const r=this.templateComponent.getAccessor(this.config.pathConverter,i);return(n,a,o,l)=>{var h;const c=[],u=r.info.type;return u.startsWith("Color")&&(n=n.map(d=>({frame:d.frame,value:gv(d.value,u)}))),(h=r.info.interpolation)==null||h.forEach((d,f)=>{var E;const m=((E=r.info.getPropertyName)==null?void 0:E[f](r.object))||"Animation-interpolation-"+f;let g=n;o!==d.type&&(g=n.map(T=>({frame:T.frame,value:d.getValue(void 0,T.value.asArray?T.value.asArray():[T.value],0,1)})));const v=d.buildAnimations(r.object,m,60,g);for(const T of v)l&&T.babylonAnimation.setEasingFunction(l),c.push(T.babylonAnimation)}),c}}getClassName(){return"FlowGraphJsonPointerParserBlock"}}function gv(s,e){return s.getClassName().startsWith("Color")?s:e==="Color3"?new q(s.x,s.y,s.z):e==="Color4"?new Te(s.x,s.y,s.z,s.w):s}function g1(s){if(s instanceof q)return new x(s.r,s.g,s.b);if(s instanceof Te)return new Ee(s.r,s.g,s.b,s.a);throw new Error("Invalid color type")}y("FlowGraphJsonPointerParserBlock",_1);class S1 extends He{constructor(e){super(Si,_e,t=>+t,"FlowGraphBooleanToFloat",e)}}y("FlowGraphBooleanToFloat",S1);class v1 extends He{constructor(e){super(Si,wt,t=>Ue.FromValue(+t),"FlowGraphBooleanToInt",e)}}y("FlowGraphBooleanToInt",v1);class x1 extends He{constructor(e){super(_e,Si,t=>!!t,"FlowGraphFloatToBoolean",e)}}y("FlowGraphFloatToBoolean",x1);class E1 extends He{constructor(e){super(wt,Si,t=>!!t.value,"FlowGraphIntToBoolean",e)}}y("FlowGraphIntToBoolean",E1);class T1 extends He{constructor(e){super(wt,_e,t=>t.value,"FlowGraphIntToFloat",e)}}y("FlowGraphIntToFloat",T1);class b1 extends He{constructor(e){super(_e,wt,t=>{switch(e==null?void 0:e.roundingMode){case"floor":return Ue.FromValue(Math.floor(t));case"ceil":return Ue.FromValue(Math.ceil(t));case"round":return Ue.FromValue(Math.round(t));default:return Ue.FromValue(t)}},"FlowGraphFloatToInt",e)}}y("FlowGraphFloatToInt",b1);class C1 extends Ni{constructor(e){super(e),this.userVariables=this.registerDataOutput("userVariables",Y),this.executionId=this.registerDataOutput("executionId",_e)}_updateOutputs(e){this.userVariables.setValue(e.userVariables,e),this.executionId.setValue(e.executionId,e)}serialize(e){super.serialize(e)}getClassName(){return"FlowGraphContextBlock"}}y("FlowGraphContextBlock",C1);class y1 extends Ni{constructor(e){super(e),this.config=e,this.array=this.registerDataInput("array",Y),this.index=this.registerDataInput("index",Y,new Ue(-1)),this.value=this.registerDataOutput("value",Y)}_updateOutputs(e){const t=this.array.getValue(e),i=Rt(this.index.getValue(e));t&&i>=0&&i<t.length?this.value.setValue(t[i],e):this.value.setValue(null,e)}serialize(e){super.serialize(e)}getClassName(){return"FlowGraphArrayIndexBlock"}}y("FlowGraphArrayIndexBlock",y1);class I1 extends Ni{constructor(e){super(e),this.config=e,this.object=this.registerDataInput("object",Y),this.array=this.registerDataInput("array",Y),this.index=this.registerDataOutput("index",wt,new Ue(-1))}_updateOutputs(e){const t=this.object.getValue(e),i=this.array.getValue(e);i&&this.index.setValue(new Ue(i.indexOf(t)),e)}serialize(e){super.serialize(e)}getClassName(){return"FlowGraphIndexOfBlock"}}y("FlowGraphIndexOfBlock",I1);class R1 extends Ni{constructor(e){super(e),this.functionName=this.registerDataInput("functionName",g_),this.object=this.registerDataInput("object",Y),this.context=this.registerDataInput("context",Y,null),this.output=this.registerDataOutput("output",Y)}_updateOutputs(e){const t=this.functionName.getValue(e),i=this.object.getValue(e),r=this.context.getValue(e);if(i&&t){const n=i[t];n&&typeof n=="function"&&this.output.setValue(n.bind(r),e)}}getClassName(){return"FlowGraphFunctionReference"}}y("FlowGraphFunctionReference",R1);class A1 extends Ho{constructor(e){super(e),this.config=e,this.type="MeshPick",this.asset=this.registerDataInput("asset",Y,e==null?void 0:e.targetMesh),this.pickedPoint=this.registerDataOutput("pickedPoint",ui),this.pickOrigin=this.registerDataOutput("pickOrigin",ui),this.pointerId=this.registerDataOutput("pointerId",_e),this.pickedMesh=this.registerDataOutput("pickedMesh",Y),this.pointerType=this.registerDataInput("pointerType",Y,ze.POINTERPICK)}_getReferencedMesh(e){return this.asset.getValue(e)}_executeEvent(e,t){var n,a,o,l,c;if(this.pointerType.getValue(e)!==t.type)return!0;const r=this._getReferencedMesh(e);return r&&((n=t.pickInfo)!=null&&n.pickedMesh)&&(((a=t.pickInfo)==null?void 0:a.pickedMesh)===r||Ca((o=t.pickInfo)==null?void 0:o.pickedMesh,r))?(this.pointerId.setValue(t.event.pointerId,e),this.pickOrigin.setValue((l=t.pickInfo.ray)==null?void 0:l.origin,e),this.pickedPoint.setValue(t.pickInfo.pickedPoint,e),this.pickedMesh.setValue(t.pickInfo.pickedMesh,e),this._execute(e),!((c=this.config)!=null&&c.stopPropagation)):(this.pointerId.resetToDefaultValue(e),this.pickOrigin.resetToDefaultValue(e),this.pickedPoint.resetToDefaultValue(e),this.pickedMesh.resetToDefaultValue(e),!0)}_preparePendingTasks(e){}_cancelPendingTasks(e){}getClassName(){return"FlowGraphMeshPickEventBlock"}}y("FlowGraphMeshPickEventBlock",A1);class P1 extends Ho{constructor(){super(...arguments),this.initPriority=-1,this.type="SceneReady"}_executeEvent(e,t){return this._execute(e),!0}_preparePendingTasks(e){}_cancelPendingTasks(e){}getClassName(){return"FlowGraphSceneReadyEventBlock"}}y("FlowGraphSceneReadyEventBlock",P1);class O1 extends Ho{constructor(e){super(e),this.config=e,this.initPriority=1;for(const t in this.config.eventData)this.registerDataOutput(t,this.config.eventData[t].type)}_preparePendingTasks(e){const t=e.configuration.coordinator.getCustomEventObservable(this.config.eventId);if(t&&t.hasObservers()&&t.observers.length>Fs.MaxEventsPerType){this._reportError(e,`FlowGraphReceiveCustomEventBlock: Too many observers for event ${this.config.eventId}. Max is ${Fs.MaxEventsPerType}.`);return}const i=t.add(r=>{var a;const n=Object.keys(r);for(const o of n)(a=this.getDataOutput(o))==null||a.setValue(r[o],e);this._execute(e)});e._setExecutionVariable(this,"_eventObserver",i)}_cancelPendingTasks(e){const t=e.configuration.coordinator.getCustomEventObservable(this.config.eventId);if(t){const i=e._getExecutionVariable(this,"_eventObserver",null);t.remove(i)}else j.Warn(`FlowGraphReceiveCustomEventBlock: Missing observable for event ${this.config.eventId}`)}_executeEvent(e,t){return!0}getClassName(){return"FlowGraphReceiveCustomEventBlock"}}y("FlowGraphReceiveCustomEventBlock",O1);class N1 extends yr{constructor(e){super(e),this.config=e;for(const t in this.config.eventData)this.registerDataInput(t,this.config.eventData[t].type,this.config.eventData[t].value)}_execute(e){const t=this.config.eventId,i={};for(const r of this.dataInputs)i[r.name]=r.getValue(e);e.configuration.coordinator.notifyCustomEvent(t,i),this.out._activateSignal(e)}getClassName(){return"FlowGraphReceiveCustomEventBlock"}}y("FlowGraphReceiveCustomEventBlock",N1);class D1 extends Ho{constructor(){super(),this.type="SceneBeforeRender",this.timeSinceStart=this.registerDataOutput("timeSinceStart",_e),this.deltaTime=this.registerDataOutput("deltaTime",_e)}_preparePendingTasks(e){}_executeEvent(e,t){return this.timeSinceStart.setValue(t.timeSinceStart,e),this.deltaTime.setValue(t.deltaTime,e),this._execute(e),!0}_cancelPendingTasks(e){}getClassName(){return"FlowGraphSceneTickEventBlock"}}y("FlowGraphSceneTickEventBlock",D1);class M1 extends Ho{constructor(e){super(e),this.type="PointerOut",this.pointerId=this.registerDataOutput("pointerId",_e),this.targetMesh=this.registerDataInput("targetMesh",Y,e==null?void 0:e.targetMesh),this.meshOutOfPointer=this.registerDataOutput("meshOutOfPointer",Y)}_executeEvent(e,t){var n;const i=this.targetMesh.getValue(e);return this.meshOutOfPointer.setValue(t.mesh,e),this.pointerId.setValue(t.pointerId,e),!(t.over&&Ca(t.mesh,i))&&(t.mesh===i||Ca(t.mesh,i))?(this._execute(e),!((n=this.config)!=null&&n.stopPropagation)):!0}_preparePendingTasks(e){}_cancelPendingTasks(e){}getClassName(){return"FlowGraphPointerOutEventBlock"}}y("FlowGraphPointerOutEventBlock",M1);class F1 extends Ho{constructor(e){super(e),this.type="PointerOver",this.pointerId=this.registerDataOutput("pointerId",_e),this.targetMesh=this.registerDataInput("targetMesh",Y,e==null?void 0:e.targetMesh),this.meshUnderPointer=this.registerDataOutput("meshUnderPointer",Y)}_executeEvent(e,t){var n;const i=this.targetMesh.getValue(e);this.meshUnderPointer.setValue(t.mesh,e);const r=t.out&&Ca(t.out,i);return this.pointerId.setValue(t.pointerId,e),!r&&(t.mesh===i||Ca(t.mesh,i))?(this._execute(e),!((n=this.config)!=null&&n.stopPropagation)):!0}_preparePendingTasks(e){}_cancelPendingTasks(e){}getClassName(){return"FlowGraphPointerOverEventBlock"}}y("FlowGraphPointerOverEventBlock",F1);var Sv;(function(s){s.PlayAnimation="FlowGraphPlayAnimationBlock",s.StopAnimation="FlowGraphStopAnimationBlock",s.PauseAnimation="FlowGraphPauseAnimationBlock",s.ValueInterpolation="FlowGraphInterpolationBlock",s.SceneReadyEvent="FlowGraphSceneReadyEventBlock",s.SceneTickEvent="FlowGraphSceneTickEventBlock",s.SendCustomEvent="FlowGraphSendCustomEventBlock",s.ReceiveCustomEvent="FlowGraphReceiveCustomEventBlock",s.MeshPickEvent="FlowGraphMeshPickEventBlock",s.PointerEvent="FlowGraphPointerEventBlock",s.PointerDownEvent="FlowGraphPointerDownEventBlock",s.PointerUpEvent="FlowGraphPointerUpEventBlock",s.PointerMoveEvent="FlowGraphPointerMoveEventBlock",s.PointerOverEvent="FlowGraphPointerOverEventBlock",s.PointerOutEvent="FlowGraphPointerOutEventBlock",s.E="FlowGraphEBlock",s.PI="FlowGraphPIBlock",s.Inf="FlowGraphInfBlock",s.NaN="FlowGraphNaNBlock",s.Random="FlowGraphRandomBlock",s.Add="FlowGraphAddBlock",s.Subtract="FlowGraphSubtractBlock",s.Multiply="FlowGraphMultiplyBlock",s.Divide="FlowGraphDivideBlock",s.Abs="FlowGraphAbsBlock",s.Sign="FlowGraphSignBlock",s.Trunc="FlowGraphTruncBlock",s.Floor="FlowGraphFloorBlock",s.Ceil="FlowGraphCeilBlock",s.Round="FlowGraphRoundBlock",s.Fraction="FlowGraphFractBlock",s.Negation="FlowGraphNegationBlock",s.Modulo="FlowGraphModuloBlock",s.Min="FlowGraphMinBlock",s.Max="FlowGraphMaxBlock",s.Clamp="FlowGraphClampBlock",s.Saturate="FlowGraphSaturateBlock",s.MathInterpolation="FlowGraphMathInterpolationBlock",s.Equality="FlowGraphEqualityBlock",s.LessThan="FlowGraphLessThanBlock",s.LessThanOrEqual="FlowGraphLessThanOrEqualBlock",s.GreaterThan="FlowGraphGreaterThanBlock",s.GreaterThanOrEqual="FlowGraphGreaterThanOrEqualBlock",s.IsNaN="FlowGraphIsNaNBlock",s.IsInfinity="FlowGraphIsInfBlock",s.DegToRad="FlowGraphDegToRadBlock",s.RadToDeg="FlowGraphRadToDegBlock",s.Sin="FlowGraphSinBlock",s.Cos="FlowGraphCosBlock",s.Tan="FlowGraphTanBlock",s.Asin="FlowGraphASinBlock",s.Acos="FlowGraphACosBlock",s.Atan="FlowGraphATanBlock",s.Atan2="FlowGraphATan2Block",s.Sinh="FlowGraphSinhBlock",s.Cosh="FlowGraphCoshBlock",s.Tanh="FlowGraphTanhBlock",s.Asinh="FlowGraphASinhBlock",s.Acosh="FlowGraphACoshBlock",s.Atanh="FlowGraphATanhBlock",s.Exponential="FlowGraphExponentialBlock",s.Log="FlowGraphLogBlock",s.Log2="FlowGraphLog2Block",s.Log10="FlowGraphLog10Block",s.SquareRoot="FlowGraphSquareRootBlock",s.CubeRoot="FlowGraphCubeRootBlock",s.Power="FlowGraphPowerBlock",s.Length="FlowGraphLengthBlock",s.Normalize="FlowGraphNormalizeBlock",s.Dot="FlowGraphDotBlock",s.Cross="FlowGraphCrossBlock",s.Rotate2D="FlowGraphRotate2DBlock",s.Rotate3D="FlowGraphRotate3DBlock",s.Transpose="FlowGraphTransposeBlock",s.Determinant="FlowGraphDeterminantBlock",s.InvertMatrix="FlowGraphInvertMatrixBlock",s.MatrixMultiplication="FlowGraphMatrixMultiplicationBlock",s.BitwiseAnd="FlowGraphBitwiseAndBlock",s.BitwiseOr="FlowGraphBitwiseOrBlock",s.BitwiseXor="FlowGraphBitwiseXorBlock",s.BitwiseNot="FlowGraphBitwiseNotBlock",s.BitwiseLeftShift="FlowGraphBitwiseLeftShiftBlock",s.BitwiseRightShift="FlowGraphBitwiseRightShiftBlock",s.LeadingZeros="FlowGraphLeadingZerosBlock",s.TrailingZeros="FlowGraphTrailingZerosBlock",s.OneBitsCounter="FlowGraphOneBitsCounterBlock",s.Branch="FlowGraphBranchBlock",s.SetDelay="FlowGraphSetDelayBlock",s.CancelDelay="FlowGraphCancelDelayBlock",s.CallCounter="FlowGraphCallCounterBlock",s.Debounce="FlowGraphDebounceBlock",s.Throttle="FlowGraphThrottleBlock",s.DoN="FlowGraphDoNBlock",s.FlipFlop="FlowGraphFlipFlopBlock",s.ForLoop="FlowGraphForLoopBlock",s.MultiGate="FlowGraphMultiGateBlock",s.Sequence="FlowGraphSequenceBlock",s.Switch="FlowGraphSwitchBlock",s.WaitAll="FlowGraphWaitAllBlock",s.WhileLoop="FlowGraphWhileLoopBlock",s.ConsoleLog="FlowGraphConsoleLogBlock",s.Conditional="FlowGraphConditionalBlock",s.Constant="FlowGraphConstantBlock",s.TransformCoordinatesSystem="FlowGraphTransformCoordinatesSystemBlock",s.GetAsset="FlowGraphGetAssetBlock",s.GetProperty="FlowGraphGetPropertyBlock",s.SetProperty="FlowGraphSetPropertyBlock",s.GetVariable="FlowGraphGetVariableBlock",s.SetVariable="FlowGraphSetVariableBlock",s.JsonPointerParser="FlowGraphJsonPointerParserBlock",s.CombineVector2="FlowGraphCombineVector2Block",s.CombineVector3="FlowGraphCombineVector3Block",s.CombineVector4="FlowGraphCombineVector4Block",s.CombineMatrix="FlowGraphCombineMatrixBlock",s.CombineMatrix2D="FlowGraphCombineMatrix2DBlock",s.CombineMatrix3D="FlowGraphCombineMatrix3DBlock",s.ExtractVector2="FlowGraphExtractVector2Block",s.ExtractVector3="FlowGraphExtractVector3Block",s.ExtractVector4="FlowGraphExtractVector4Block",s.ExtractMatrix="FlowGraphExtractMatrixBlock",s.ExtractMatrix2D="FlowGraphExtractMatrix2DBlock",s.ExtractMatrix3D="FlowGraphExtractMatrix3DBlock",s.TransformVector="FlowGraphTransformVectorBlock",s.TransformCoordinates="FlowGraphTransformCoordinatesBlock",s.Conjugate="FlowGraphConjugateBlock",s.AngleBetween="FlowGraphAngleBetweenBlock",s.QuaternionFromAxisAngle="FlowGraphQuaternionFromAxisAngleBlock",s.AxisAngleFromQuaternion="FlowGraphAxisAngleFromQuaternionBlock",s.QuaternionFromDirections="FlowGraphQuaternionFromDirectionsBlock",s.MatrixDecompose="FlowGraphMatrixDecompose",s.MatrixCompose="FlowGraphMatrixCompose",s.BooleanToFloat="FlowGraphBooleanToFloat",s.BooleanToInt="FlowGraphBooleanToInt",s.FloatToBoolean="FlowGraphFloatToBoolean",s.IntToBoolean="FlowGraphIntToBoolean",s.IntToFloat="FlowGraphIntToFloat",s.FloatToInt="FlowGraphFloatToInt",s.Easing="FlowGraphEasingBlock",s.Context="FlowGraphContextBlock",s.ArrayIndex="FlowGraphArrayIndexBlock",s.CodeExecution="FlowGraphCodeExecutionBlock",s.IndexOf="FlowGraphIndexOfBlock",s.FunctionReference="FlowGraphFunctionReference",s.BezierCurveEasing="FlowGraphBezierCurveEasing",s.DataSwitch="FlowGraphDataSwitchBlock"})(Sv||(Sv={}));var H;(function(s){s[s.Texture=1]="Texture",s[s.TextureBackBuffer=2]="TextureBackBuffer",s[s.TextureBackBufferDepthStencilAttachment=4]="TextureBackBufferDepthStencilAttachment",s[s.TextureDepthStencilAttachment=8]="TextureDepthStencilAttachment",s[s.TextureViewDepth=16]="TextureViewDepth",s[s.TextureViewNormal=32]="TextureViewNormal",s[s.TextureAlbedo=64]="TextureAlbedo",s[s.TextureReflectivity=128]="TextureReflectivity",s[s.TextureWorldPosition=256]="TextureWorldPosition",s[s.TextureVelocity=512]="TextureVelocity",s[s.TextureIrradiance=1024]="TextureIrradiance",s[s.TextureAlbedoSqrt=2048]="TextureAlbedoSqrt",s[s.TextureScreenDepth=4096]="TextureScreenDepth",s[s.TextureWorldNormal=8192]="TextureWorldNormal",s[s.TextureLocalPosition=16384]="TextureLocalPosition",s[s.TextureLinearVelocity=32768]="TextureLinearVelocity",s[s.TextureNormalizedViewDepth=65536]="TextureNormalizedViewDepth",s[s.TextureAllButBackBufferDepthStencil=1048571]="TextureAllButBackBufferDepthStencil",s[s.TextureAllButBackBuffer=1048569]="TextureAllButBackBuffer",s[s.TextureAll=1048575]="TextureAll",s[s.ResourceContainer=1048576]="ResourceContainer",s[s.ShadowGenerator=2097152]="ShadowGenerator",s[s.ShadowLight=4194304]="ShadowLight",s[s.Camera=16777216]="Camera",s[s.ObjectList=33554432]="ObjectList",s[s.AutoDetect=268435456]="AutoDetect",s[s.BasedOnInput=536870912]="BasedOnInput",s[s.Undefined=1073741824]="Undefined",s[s.Object=2147483648]="Object",s[s.All=4294967295]="All"})(H||(H={}));var vv;(function(s){s[s.Compatible=0]="Compatible",s[s.TypeIncompatible=1]="TypeIncompatible",s[s.HierarchyIssue=2]="HierarchyIssue"})(vv||(vv={}));var xv;(function(s){s[s.Input=0]="Input",s[s.Output=1]="Output"})(xv||(xv={}));class pa{get direction(){return this._direction}static IsTextureHandle(e){return e!==void 0&&Number.isFinite(e)}static IsShadowGenerator(e){return e!==void 0&&e.mapSize!==void 0}static IsShadowLight(e){return e!==void 0&&e.setShadowProjectionMatrix!==void 0}get type(){if(this._type===H.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource){if(this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.type;if(this._linkedConnectionSource._defaultConnectionPointType)return this._linkedConnectionSource._defaultConnectionPointType}if(this._defaultConnectionPointType)return this._defaultConnectionPointType}if(this._type===H.BasedOnInput){if(this._typeConnectionSource){const e=typeof this._typeConnectionSource=="function"?this._typeConnectionSource():this._typeConnectionSource;return e.isConnected?e._connectedPoint.type:this._defaultConnectionPointType??e.type}else if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._type=e}get isConnected(){return this.connectedPoint!==null||this.hasEndpoints}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return this._endpoints.length===0?[]:this._endpoints.map(e=>e.ownerBlock)}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get innerType(){return this._linkedConnectionSource&&!this._isMainLinkSource&&this._linkedConnectionSource.isConnected?this.type:this._type}createCustomInputBlock(){return null}constructor(e,t,i){this._connectedPoint=null,this._acceptedConnectionPointType=null,this._endpoints=new Array,this._type=H.Undefined,this._linkedConnectionSource=null,this._isMainLinkSource=!1,this._typeConnectionSource=null,this._defaultConnectionPointType=null,this.needDualDirectionValidation=!1,this.acceptedConnectionPointTypes=[],this.excludedConnectionPointTypes=[],this.onConnectionObservable=new k,this.onDisconnectionObservable=new k,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeRenderGraphConnectionPoint"}canConnectTo(e){return this.checkCompatibilityState(e)===0}checkCompatibilityState(e){const t=this._ownerBlock,i=e.ownerBlock;if(this.type!==e.type&&e.innerType!==H.AutoDetect)return e.acceptedConnectionPointTypes&&e.acceptedConnectionPointTypes.indexOf(this.type)!==-1?0:1;if(e.excludedConnectionPointTypes&&e.excludedConnectionPointTypes.indexOf(this.type)!==-1)return 1;let r=i,n=t;return this.direction===0&&(r=t,n=i),r.isAnAncestorOf(n)?2:0}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw`Cannot connect these two connectors. source: "${this.ownerBlock.name}".${this.name}, target: "${e.ownerBlock.name}".${e.name}`;return this._endpoints.push(e),e._connectedPoint=this,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){const t=this._endpoints.indexOf(e);return t===-1?this:(this._endpoints.splice(t,1),e._connectedPoint=null,this.onDisconnectionObservable.notifyObservers(e),e.onDisconnectionObservable.notifyObservers(this),this)}addExcludedConnectionPointFromAllowedTypes(e){let t=0,i=2**t;for(;i<H.All;)e&i||this.excludedConnectionPointTypes.push(i),t++,i=2**t}addAcceptedConnectionPointTypes(e){let t=0,i=2**t;for(;i<H.All;)e&i&&this.acceptedConnectionPointTypes.indexOf(i)===-1&&this.acceptedConnectionPointTypes.push(i),t++,i=2**t}serialize(e=!0){const t={};return t.name=this.name,t.displayName=this.displayName,e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear(),this.onDisconnectionObservable.clear()}}class Di{get disabled(){var e;return!!((e=this._frameGraphTask)!=null&&e.disabled)}set disabled(e){this._frameGraphTask&&(this._frameGraphTask.disabled=e)}get task(){return this._frameGraphTask}get inputs(){return this._inputs}get outputs(){return this._outputs}get name(){return this._name}set name(e){this._name=e}get isInput(){return this._isInput}get isTeleportOut(){return this._isTeleportOut}get isTeleportIn(){return this._isTeleportIn}get isDebug(){return this._isDebug}get isUnique(){return this._isUnique}getClassName(){return"NodeRenderGraphBlock"}_inputRename(e){return e}_outputRename(e){return e}isAnAncestorOf(e){for(const t of this._outputs)if(t.hasEndpoints){for(const i of t.endpoints)if(i.ownerBlock===e||i.ownerBlock.isAnAncestorOf(e))return!0}return!1}isAnAncestorOfType(e){if(this.getClassName()===e)return!0;for(const t of this._outputs)if(t.hasEndpoints){for(const i of t.endpoints)if(i.ownerBlock.isAnAncestorOfType(e))return!0}return!1}getDescendantOfPredicate(e){if(e(this))return this;for(const t of this._outputs)if(t.hasEndpoints)for(const i of t.endpoints){const r=i.ownerBlock.getDescendantOfPredicate(e);if(r)return r}return null}constructor(e,t,i,...r){this._name="",this._isInput=!1,this._isTeleportOut=!1,this._isTeleportIn=!1,this._isDebug=!1,this._isUnique=!1,this.onBuildObservable=new k,this._inputs=new Array,this._outputs=new Array,this._codeVariableName="",this._additionalConstructionParameters=null,this.visibleOnFrame=!1,this._name=e,this._frameGraph=t,this._scene=i,this._engine=i.getEngine(),this.uniqueId=bn.UniqueId}registerInput(e,t,i=!1,r){return r=r??new pa(e,this,0),r.type=t,r.isOptional=i,this._inputs.push(r),this}registerOutput(e,t,i){return i=i??new pa(e,this,1),i.type=t,this._outputs.push(i),this}_addDependenciesInput(e=0){this.registerInput("dependencies",H.AutoDetect,!0);const t=this.getInputByName("dependencies");return t.addExcludedConnectionPointFromAllowedTypes(H.TextureAllButBackBuffer|H.ResourceContainer|H.ShadowGenerator|e),t}_buildBlock(e){}_customBuildStep(e){}_propagateInputValueToOutput(e,t){e.connectedPoint&&(t.value=e.connectedPoint.value)}build(e){var t;if(this._buildId===e.buildId)return!0;this._buildId=e.buildId;for(const i of this._inputs){if(!i.connectedPoint){i.isOptional||e._notConnectedNonOptionalInputs.push(i);continue}const r=i.connectedPoint.ownerBlock;r&&r!==this&&r.build(e)}if(this._customBuildStep(e),e.verbose&&N.Log(`Building ${this.name} [${this.getClassName()}]`),this._frameGraphTask&&(this._frameGraphTask.name=this.name),this._buildBlock(e),this._frameGraphTask){this._frameGraphTask.dependencies=void 0;const i=(t=this.getInputByName("dependencies"))==null?void 0:t.connectedPoint;if(i)if(i.type===H.ResourceContainer){const r=i.ownerBlock;for(let n=0;n<r.inputs.length;n++){const a=r.inputs[n];a.connectedPoint&&a.connectedPoint.value!==void 0&&pa.IsTextureHandle(a.connectedPoint.value)&&(this._frameGraphTask.dependencies=this._frameGraphTask.dependencies||new Set,this._frameGraphTask.dependencies.add(a.connectedPoint.value))}}else pa.IsTextureHandle(i.value)&&(this._frameGraphTask.dependencies=this._frameGraphTask.dependencies||new Set,this._frameGraphTask.dependencies.add(i.value));this._frameGraph.addTask(this._frameGraphTask)}return this.onBuildObservable.notifyObservers(this),!1}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:(this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[e]._isMainLinkSource=!0),this._inputs[t]._linkedConnectionSource=this._inputs[e]}initialize(){}autoConfigure(){}getInputByName(e){const t=this._inputs.filter(i=>i.name===e);return t.length?t[0]:null}getOutputByName(e){const t=this._outputs.filter(i=>i.name===e);return t.length?t[0]:null}serialize(){const e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.comments=this.comments,e.visibleOnFrame=this.visibleOnFrame,e.disabled=this.disabled,this._additionalConstructionParameters&&(e.additionalConstructionParameters=this._additionalConstructionParameters),e.inputs=[],e.outputs=[];for(const t of this.inputs)e.inputs.push(t.serialize());for(const t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e){this._name=e.name,this.comments=e.comments,this.visibleOnFrame=e.visibleOnFrame,this.disabled=e.disabled,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){const t=e.inputs,i=e.outputs;if(t)for(const r of t){const n=this.inputs.find(a=>a.name===r.name);n&&(r.displayName&&(n.displayName=r.displayName),r.isExposedOnFrame&&(n.isExposedOnFrame=r.isExposedOnFrame,n.exposedPortPosition=r.exposedPortPosition))}if(i)for(let r=0;r<i.length;r++){const n=i[r];n.displayName&&(this.outputs[r].displayName=n.displayName),n.isExposedOnFrame&&(this.outputs[r].isExposedOnFrame=n.isExposedOnFrame,this.outputs[r].exposedPortPosition=n.exposedPortPosition)}}_dumpPropertiesCode(){const e=this._codeVariableName;return`${e}.visibleOnFrame = ${this.visibleOnFrame};
${e}.disabled = ${this.disabled};
`}_dumpCodeForOutputConnections(e){let t="";if(e.indexOf(this)!==-1)return t;e.push(this);for(const i of this.inputs){if(!i.isConnected)continue;const r=i.connectedPoint,n=r.ownerBlock;t+=n._dumpCodeForOutputConnections(e),t+=`${n._codeVariableName}.${n._outputRename(r.name)}.connectTo(${this._codeVariableName}.${this._inputRename(i.name)});
`}return t}_dumpCode(e,t){t.push(this);const i=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=i||`${this.getClassName()}_${this.uniqueId}`,e.indexOf(this._codeVariableName)!==-1){let a=0;do a++,this._codeVariableName=i+a;while(e.indexOf(this._codeVariableName)!==-1)}e.push(this._codeVariableName);let r=`
// ${this.getClassName()}
`;this.comments&&(r+=`// ${this.comments}
`);const n=this.getClassName();if(n==="NodeRenderGraphInputBlock"){const o=this.type;r+=`var ${this._codeVariableName} = new BABYLON.NodeRenderGraphInputBlock("${this.name}", nodeRenderGraph.frameGraph, scene, BABYLON.NodeRenderGraphBlockConnectionPointTypes.${H[o]});
`}else this._additionalConstructionParameters?r+=`var ${this._codeVariableName} = new BABYLON.${n}("${this.name}", nodeRenderGraph.frameGraph, scene, ...${JSON.stringify(this._additionalConstructionParameters)});
`:r+=`var ${this._codeVariableName} = new BABYLON.${n}("${this.name}", nodeRenderGraph.frameGraph, scene);
`;r+=this._dumpPropertiesCode()+`
`;for(const a of this.inputs){if(!a.isConnected)continue;const l=a.connectedPoint.ownerBlock;t.indexOf(l)===-1&&(r+=l._dumpCode(e,t))}for(const a of this.outputs)if(a.hasEndpoints)for(const o of a.endpoints){const l=o.ownerBlock;l&&t.indexOf(l)===-1&&(r+=l._dumpCode(e,t))}return r}clone(){const e=this.serialize(),t=ki(e.customType);if(t){const i=e.additionalConstructionParameters,r=i?new t("",this._frameGraph,this._scene,...i):new t("",this._frameGraph,this._scene);return r._deserialize(e),r}return null}dispose(){var e;for(const t of this.inputs)t.dispose();for(const t of this.outputs)t.dispose();(e=this._frameGraphTask)==null||e.dispose(),this._frameGraphTask=void 0,this.onBuildObservable.clear()}}_([R("comment")],Di.prototype,"comments",void 0);class L1 extends Br{record(){if(this.sourceTexture===void 0)throw new Error(`FrameGraphCopyToBackbufferColorTask "${this.name}": sourceTexture is required`);const e=this._frameGraph.addRenderPass(this.name);e.addDependencies(this.sourceTexture),e.setRenderTarget(Ji),e.setExecuteFunc(i=>{i.isBackbuffer(this.sourceTexture)||i.copyTexture(this.sourceTexture)});const t=this._frameGraph.addRenderPass(this.name+"_disabled",!0);t.setRenderTarget(Ji),t.setExecuteFunc(i=>{})}}class xR extends Di{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this._isUnique=!0,this.registerInput("texture",H.Texture),this.texture.addAcceptedConnectionPointTypes(H.TextureAll),this._frameGraphTask=new L1(e,t)}getClassName(){return"NodeRenderGraphOutputBlock"}get texture(){return this._inputs[0]}_buildBlock(e){super._buildBlock(e),this._frameGraphTask.name=this.name;const t=this.texture.connectedPoint;t&&(this._frameGraphTask.sourceTexture=t.value)}}y("BABYLON.NodeRenderGraphOutputBlock",xR);var Ev;(function(s){s[s.None=0]="None",s[s.ToLinearSpace=1]="ToLinearSpace",s[s.ToGammaSpace=2]="ToGammaSpace"})(Ev||(Ev={}));class ER{get shaderLanguage(){return this._shaderLanguage}_textureIsInternal(e){return e.getInternalTexture===void 0}constructor(e,t=!1,i=!1){this._shaderLanguage=0,this._shadersLoaded=!1,this._engine=e,this._isDepthTexture=t,this._renderer=new go(e),this._initShaderSourceAsync(t,i)}async _initShaderSourceAsync(e,t){const i=this._engine;i.isWebGPU?(this._shaderLanguage=1,await U(()=>Promise.resolve().then(()=>xH),void 0)):await U(()=>Promise.resolve().then(()=>SH),void 0),this._shadersLoaded=!0;const r=[];e&&r.push("#define DEPTH_TEXTURE"),t&&r.push("#define NO_SAMPLER"),this._effectWrapper=new gt({engine:i,name:"CopyTextureToTexture",fragmentShader:"copyTextureToTexture",useShaderStore:!0,uniformNames:["conversion"],samplerNames:["textureSampler"],defines:r,shaderLanguage:this._shaderLanguage}),this._effectWrapper.onApplyObservable.add(()=>{e?(i.setState(!1),i.setDepthBuffer(!0),i.depthCullingState.depthMask=!0,i.depthCullingState.depthFunc=519):i.depthCullingState.depthMask=!1,this._textureIsInternal(this._source)?this._effectWrapper.effect._bindTexture("textureSampler",this._source):this._effectWrapper.effect.setTexture("textureSampler",this._source),this._effectWrapper.effect.setFloat("conversion",this._conversion)})}isReady(){var e,t;return this._shadersLoaded&&!!((t=(e=this._effectWrapper)==null?void 0:e.effect)!=null&&t.isReady())}copy(e,t=null,i=0){if(!this.isReady())return!1;this._source=e,this._conversion=i;const r=this._engine.getDepthFunction(),n=this._engine.getDepthWrite();return this._renderer.render(this._effectWrapper,t),this._engine.setDepthWrite(n),this._isDepthTexture&&r&&this._engine.setDepthFunction(r),!0}dispose(){var e;(e=this._effectWrapper)==null||e.dispose(),this._renderer.dispose()}}class TR{constructor(e,t,i){this._engine=e,this._textureManager=t,this._scene=i}renderUnmanaged(e,t=!0){const i=this._engine._currentRenderTarget;this._scene.incrementRenderId(),this._scene.resetCachedMaterial(),this._scene._intermediateRendering=t,e.render(),this._scene._intermediateRendering=!1,this._engine._currentRenderTarget!==i&&(i?this._engine.bindFramebuffer(i):this._engine.restoreDefaultFramebuffer())}getTextureFromHandle(e){return this._textureManager.getTextureFromHandle(e)}pushDebugGroup(e){var t,i;(i=(t=this._engine)._debugPushGroup)==null||i.call(t,e,1)}popDebugGroup(){var e,t;(t=(e=this._engine)._debugPopGroup)==null||t.call(e,1)}saveDepthStates(){this._depthTest=this._engine.getDepthBuffer(),this._depthWrite=this._engine.getDepthWrite()}restoreDepthStates(){this._engine.setDepthBuffer(this._depthTest),this._engine.setDepthWrite(this._depthWrite)}setDepthStates(e,t){this._engine.setDepthBuffer(e),this._engine.setDepthWrite(t)}}class x_ extends TR{static _IsObjectRenderer(e){return e.initRender!==void 0}constructor(e,t,i){super(e,t,i),this._debugMessageHasBeenPushed=!1,this._renderTargetIsBound=!0,this._effectRenderer=new go(this._engine),this._effectRendererBack=new go(this._engine,{positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,2,1,0,3,2]}),this._copyTexture=new ER(this._engine)}isBackbuffer(e){return this._textureManager._isBackbuffer(e)}isBackbufferColor(e){return this._textureManager.isBackbufferColor(e)}isBackbufferDepthStencil(e){return this._textureManager.isBackbufferDepthStencil(e)}createRenderTarget(e,t,i,r,n){return this._textureManager.createRenderTarget(e,t,i,r,n)}clear(e,t,i,r,n=0){this._applyRenderTarget(),this._engine.clear(e,t,i,r,n)}clearColorAttachments(e,t){this._applyRenderTarget(),this._engine.bindAttachments(t),this._engine.clear(e,!0,!1,!1)}clearAttachments(e,t,i,r,n,a=0){this._applyRenderTarget(),this._engine.bindAttachments(t),this._engine.clear(e,i,r,n,a)}bindAttachments(e){this._applyRenderTarget(),this._engine.bindAttachments(e)}generateMipMaps(){var t;if(((t=this._currentRenderTarget)==null?void 0:t.renderTargetWrapper)===void 0)return;this._renderTargetIsBound&&this._engine._currentRenderTarget&&(this._flushDebugMessages(),this._engine.unBindFramebuffer(this._engine._currentRenderTarget),this._renderTargetIsBound=!1);const e=this._currentRenderTarget.renderTargetWrapper.textures;if(e)for(const i of e)this._engine.generateMipmaps(i)}setTextureSamplingMode(e,t){const i=this._textureManager.getTextureFromHandle(e);i&&i.samplingMode!==t&&this._engine.updateTextureSamplingMode(t,i)}bindTextureHandle(e,t,i){let r;const n=this._textureManager._historyTextures.get(i);n?(r=n.textures[n.index],this._currentRenderTarget!==void 0&&this._currentRenderTarget.renderTargetWrapper!==void 0&&this._currentRenderTarget.renderTargetWrapper.textures.includes(r)&&(r=n.textures[n.index^1])):r=this._textureManager._textures.get(i).texture,e._bindTexture(t,r)}applyFullScreenEffect(e,t,i,r,n,a){var c;if(!((c=e.effect)!=null&&c.isReady()))return!1;this._applyRenderTarget();const o=this._engine.getDepthWrite(),l=n?this._effectRendererBack:this._effectRenderer;return l.saveStates(),l.setViewport(),this._engine.enableEffect(e),this._engine.setState(!1,void 0,void 0,void 0,void 0,i),this._engine.setDepthBuffer(!!a),r&&this._engine.setColorWrite(!1),this._engine.setDepthWrite(!1),l.bindBuffers(e.effect),t==null||t(),l.draw(),l.restoreStates(),r&&this._engine.setColorWrite(!0),this._engine.setDepthWrite(o),this._engine.setAlphaMode(0),!0}copyTexture(e,t=!1){t&&this.bindRenderTarget(),this._applyRenderTarget(),this._copyTexture.copy(this._textureManager.getTextureFromHandle(e,!0))}render(e,t,i){x_._IsObjectRenderer(e)?(this._scene._intermediateRendering=!0,e.shouldRender()&&(this._scene.incrementRenderId(),this._scene.resetCachedMaterial(),this._applyRenderTarget(),e.prepareRenderList(),e.initRender(t,i),e.render(),e.finishRender()),this._scene._intermediateRendering=!1):(this._applyRenderTarget(),e.render())}bindRenderTarget(e,t,i=!1){var r,n;if((e==null?void 0:e.renderTargetWrapper)===void 0&&this._currentRenderTarget===void 0||e&&this._currentRenderTarget&&e.equals(this._currentRenderTarget)){this._flushDebugMessages(),t!==void 0&&((n=(r=this._engine)._debugPushGroup)==null||n.call(r,t,2),this._debugMessageWhenTargetBound=void 0,this._debugMessageHasBeenPushed=!0),i&&this._applyRenderTarget();return}this._currentRenderTarget=(e==null?void 0:e.renderTargetWrapper)===void 0?void 0:e,this._debugMessageWhenTargetBound=t,this._renderTargetIsBound=!1,i&&this._applyRenderTarget()}_flushDebugMessages(){var e,t;this._debugMessageHasBeenPushed&&((t=(e=this._engine)._debugPopGroup)==null||t.call(e,2),this._debugMessageHasBeenPushed=!1)}_applyRenderTarget(){var t,i,r;if(this._renderTargetIsBound)return;this._flushDebugMessages();const e=(t=this._currentRenderTarget)==null?void 0:t.renderTargetWrapper;e===void 0?this._engine.restoreDefaultFramebuffer():(this._engine._currentRenderTarget&&this._engine.unBindFramebuffer(this._engine._currentRenderTarget),this._engine.bindFramebuffer(e)),this._debugMessageWhenTargetBound!==void 0&&((r=(i=this._engine)._debugPushGroup)==null||r.call(i,this._debugMessageWhenTargetBound,2),this._debugMessageWhenTargetBound=void 0,this._debugMessageHasBeenPushed=!0),this._renderTargetIsBound=!0}_isReady(){return this._copyTexture.isReady()}_dispose(){this._effectRenderer.dispose(),this._effectRendererBack.dispose(),this._copyTexture.dispose()}}class w1{constructor(e,t,i,r){this._isBackBuffer=!1,this.name=e,this._textureManager=t,this._renderTargets=i===void 0?void 0:Array.isArray(i)?i:[i],this._renderTargetDepth=r}get renderTargetWrapper(){var e;if(!this._isBackBuffer){if(!this._renderTargetWrapper){const t=this._textureManager.engine,i=this._renderTargets===void 0||this._renderTargets.length===0?this._renderTargetDepth:this._renderTargets[0];if(this._textureManager.isBackbuffer(i)){this._isBackBuffer=!0;return}const r=this._textureManager.getTextureDescription(i),n={textureCount:((e=this._renderTargets)==null?void 0:e.length)??0,generateDepthBuffer:!1,label:this.name,samples:r.options.samples??1,dontCreateTextures:!0};this._renderTargetWrapper=t.createMultipleRenderTarget(r.size,n,!0);for(let a=0;a<n.textureCount;a++){const o=this._renderTargets[a],l=this._textureManager.getTextureFromHandle(o);if(!l)throw new Error(`FrameGraphRenderTarget.renderTargetWrapper: Failed to get texture from handle. handle: ${o}, name: ${this.name}, index: ${a}, renderTargets: ${this._renderTargets}`);this._renderTargetWrapper.setTexture(l,a,!1)}this._renderTargetDepth!==void 0&&this._renderTargetWrapper.setDepthStencilTexture(this._textureManager.getTextureFromHandle(this._renderTargetDepth),!1)}return this._renderTargetWrapper}}equals(e){const t=this._renderTargets,i=e._renderTargets;if(t!==void 0&&i!==void 0){if(t.length!==i.length)return!1;for(let r=0;r<t.length;r++)if(t[r]!==i[r])return!1}else if(t===void 0&&i!==void 0||t!==void 0&&i===void 0)return!1;return this._renderTargetDepth===e._renderTargetDepth}}var wi;(function(s){s[s.Task=0]="Task",s[s.Graph=1]="Graph",s[s.External=2]="External"})(wi||(wi={}));class os{constructor(e,t=!1,i){this.engine=e,this._debugTextures=t,this._scene=i,this._textures=new Map,this._historyTextures=new Map,this._isRecordingTask=!1,this.showDebugLogsForTextureAllcationOptimization=!1,this._backBufferTextureEntry=null,this._backBufferDepthStencilTextureEntry=null,this._backBufferTextureOverriden=!1,this._addSystemTextures()}isBackbuffer(e){return this._backBufferTextureOverriden?!1:this._isBackbuffer(e)}_isBackbuffer(e){if(e===Ji||e===ss)return!0;const t=this._textures.get(e);return t?t.refHandle===Ji||t.refHandle===ss:!1}isBackbufferColor(e){if(this._backBufferTextureOverriden)return!1;if(e===Ji)return!0;const t=this._textures.get(e);return t?t.refHandle===Ji:!1}isBackbufferDepthStencil(e){if(this._backBufferTextureOverriden)return!1;if(e===ss)return!0;const t=this._textures.get(e);return t?t.refHandle===ss:!1}isHistoryTexture(e,t=!1){var r;const i=this._textures.get(e);return i?(e=i.refHandle??e,t?((r=this._textures.get(e))==null?void 0:r.historyTexture)===!0:this._historyTextures.has(e)):!1}getTextureCreationOptions(e,t=!1){var n;e=((n=this._textures.get(e))==null?void 0:n.refHandle)??e;const i=this._textures.get(e),r=i.creationOptions;return{size:ja(r.size)?{...r.size}:r.size,sizeIsPercentage:r.sizeIsPercentage,options:os.CloneTextureOptions(r.options,i.textureIndex),isHistoryTexture:t?r.isHistoryTexture:!1}}getTextureDescription(e){const t=this.getTextureCreationOptions(e);return{size:t.sizeIsPercentage?this.getAbsoluteDimensions(t.size):ja(t.size)?t.size:{width:t.size,height:t.size},options:t.options}}getTextureHandleOrCreateTexture(e,t,i){if(e===void 0){if(t===void 0||i===void 0)throw new Error("getTextureHandleOrCreateTexture: Either handle or newTextureName and creationOptions must be provided.");return this.createRenderTargetTexture(t,i)}return e}getTextureFromHandle(e,t){const i=this._textures.get(e),r=i==null?void 0:i.refHandle,n=r!==void 0?this._textures.get(r):i,a=r!==void 0?r:e,o=this._historyTextures.get(a);return o?o.textures[t?o.index:o.index^1]:n.texture}importTexture(e,t,i){i!==void 0&&this._freeEntry(i);const r={size:{width:t.width,height:t.height},sizeIsPercentage:!1,isHistoryTexture:!1,options:{createMipMaps:t.generateMipMaps,samples:t.samples,types:[t.type],formats:[t.format],useSRGBBuffers:[t._useSRGBBuffer],creationFlags:[t._creationFlags],labels:t.label?[t.label]:["imported"]}};return this._createHandleForTexture(e,t,r,wi.External,i)}createRenderTargetTexture(e,t,i){return this._createHandleForTexture(e,null,{size:ja(t.size)?{...t.size}:t.size,sizeIsPercentage:t.sizeIsPercentage,isHistoryTexture:t.isHistoryTexture,options:os.CloneTextureOptions(t.options,void 0,!0)},this._isRecordingTask?wi.Task:wi.Graph,i)}createRenderTarget(e,t,i,r,n){var l;const a=new w1(e,this,t,i),o=a.renderTargetWrapper;if(o!==void 0&&(o.depthReadOnly=!!r,o.stencilReadOnly=!!n,t)){const c=Array.isArray(t)?t:[t];for(let u=0;u<c.length;u++){let h=c[u];h=((l=this._textures.get(h))==null?void 0:l.refHandle)??h;const d=this._historyTextures.get(h);d&&(d.references.push({renderTargetWrapper:o,textureIndex:u}),o.setTexture(d.textures[d.index],u,!1))}}return a}createDanglingHandle(){return os._Counter++}resolveDanglingHandle(e,t,i,r){if(t===void 0){if(i===void 0||r===void 0)throw new Error("resolveDanglingHandle: Either handle or newTextureName and creationOptions must be provided.");this.createRenderTargetTexture(i,r,e);return}const n=this._textures.get(t);if(n===void 0)throw new Error(`resolveDanglingHandle: Handle ${t} does not exist!`);t=n.refHandle??t,this._textures.set(e,{texture:n.texture,refHandle:t,name:n.name,creationOptions:{size:{...n.creationOptions.size},options:os.CloneTextureOptions(n.creationOptions.options),sizeIsPercentage:n.creationOptions.sizeIsPercentage,isHistoryTexture:!1},namespace:n.namespace,textureIndex:n.textureIndex})}getAbsoluteDimensions(e,t,i){if(this._backBufferTextureOverriden){const a=this._textures.get(Ji).creationOptions.size;t??(t=a.width),i??(i=a.height)}else t??(t=this.engine.getRenderWidth(!0)),i??(i=this.engine.getRenderHeight(!0));const{width:r,height:n}=qc(e);return{width:Math.floor(r*t/100),height:Math.floor(n*i/100)}}computeTotalTextureSize(e,t,i){let r=0;return this._textures.forEach((n,a)=>{var f;if(!this._backBufferTextureOverriden&&(a===Ji||a===ss)||n.refHandle!==void 0||e&&n.aliasHandle!==void 0)return;const o=n.creationOptions,l=n.textureIndex||0,c=o.sizeIsPercentage?this.getAbsoluteDimensions(o.size,t,i):qc(o.size),u=os._GetTextureBlockInformation(((f=o.options.types)==null?void 0:f[l])??0,o.options.formats[l]),h=Math.ceil(c.width/u.width)*Math.ceil(c.height/u.height)*u.length;let d=h;o.options.createMipMaps&&(d=Math.floor(d*4/3)),(o.options.samples||1)>1&&(d+=h),r+=d}),r}get backBufferTextureOverriden(){return this._backBufferTextureOverriden}setBackBufferTextures(e,t,i,r){var a,o,l,c;if((e===0||t===0)&&(!i||!r)){if(this._backBufferTextureOverriden){let u=this._textures.get(Ji);(a=u.texture)==null||a.dispose(),u.texture=null,(o=u.debug)==null||o.dispose(),u.debug=void 0,u=this._textures.get(ss),(l=u.texture)==null||l.dispose(),u.texture=null,(c=u.debug)==null||c.dispose(),u.debug=void 0}this._backBufferTextureEntry=null,this._backBufferDepthStencilTextureEntry=null,this._backBufferTextureOverriden=!1,this._addSystemTextures();return}this._backBufferTextureOverriden=!0;const n={width:e,height:t};this._backBufferTextureEntry={name:"backbuffer color",texture:null,creationOptions:i??{size:n,options:{createMipMaps:!1,samples:this.engine.getCreationOptions().antialias?4:1,types:[0],formats:[5],useSRGBBuffers:[!1],creationFlags:[0],labels:["backbuffer color"]},sizeIsPercentage:!1},namespace:wi.Graph,lifespan:{firstTask:Number.MAX_VALUE,lastTask:0}},this._backBufferTextureEntry.textureDescriptionHash=this._createTextureDescriptionHash(this._backBufferTextureEntry.creationOptions),this._backBufferDepthStencilTextureEntry={name:"backbuffer depth/stencil",texture:null,creationOptions:r??{size:n,options:{createMipMaps:!1,samples:this.engine.getCreationOptions().antialias?4:1,types:[0],formats:[this.engine.isStencilEnable?13:14],useSRGBBuffers:[!1],creationFlags:[0],labels:["backbuffer depth/stencil"]},sizeIsPercentage:!1},namespace:wi.Graph,lifespan:{firstTask:Number.MAX_VALUE,lastTask:0}},this._backBufferDepthStencilTextureEntry.textureDescriptionHash=this._createTextureDescriptionHash(this._backBufferDepthStencilTextureEntry.creationOptions),this._addSystemTextures()}resetBackBufferTextures(){this.setBackBufferTextures(0,0)}get hasHistoryTextures(){return this._historyTextures.size>0}_dispose(){this._releaseTextures()}_allocateTextures(e){e&&this._optimizeTextureAllocation(e),this._textures.forEach(t=>{var i,r,n,a,o,l,c;if(!t.texture){if(t.refHandle!==void 0){const u=this._textures.get(t.refHandle);t.texture=u.texture,(i=t.texture)==null||i.incrementReferences(),u.refHandle===Ji&&(t.refHandle=Ji),u.refHandle===ss&&(t.refHandle=ss)}else if(t.namespace!==wi.External)if(t.aliasHandle!==void 0){const u=this._textures.get(t.aliasHandle);t.texture=u.texture,t.texture.incrementReferences()}else{const u=t.creationOptions,h=u.sizeIsPercentage?this.getAbsoluteDimensions(u.size):u.size,d=t.textureIndex||0,f={createMipMaps:u.options.createMipMaps,samples:u.options.samples,type:(r=u.options.types)==null?void 0:r[d],format:(n=u.options.formats)==null?void 0:n[d],useSRGBBuffer:(a=u.options.useSRGBBuffers)==null?void 0:a[d],creationFlags:(o=u.options.creationFlags)==null?void 0:o[d],label:((l=u.options.labels)==null?void 0:l[d])??`${t.name}${d>0?"#"+d:""}`,samplingMode:1,createMSAATexture:u.options.samples>1},m=xD(f.format),g=wm(f.format),v=m&&g?12:m||g?14:5,E=this.engine._createInternalTexture(h,f,!1,v);m&&(E.type=nI(E.format)),t.texture=E}}t.texture&&t.refHandle===void 0&&((c=t.debug)==null||c.dispose(),t.debug=this._createDebugTexture(t.name,t.texture))}),this._historyTextures.forEach(t=>{for(let i=0;i<t.handles.length;i++)t.textures[i]=this._textures.get(t.handles[i]).texture})}_releaseTextures(e=!0){this._textures.forEach((t,i)=>{var r,n;t.lifespan&&(t.lifespan.firstTask=Number.MAX_VALUE,t.lifespan.lastTask=0),t.aliasHandle=void 0,(e||t.namespace!==wi.External)&&((r=t.debug)==null||r.dispose(),t.debug=void 0),t.namespace!==wi.External&&((n=t.texture)==null||n.dispose(),t.texture=null,(e||t.namespace===wi.Task)&&(this._textures.delete(i),this._historyTextures.delete(i)))}),this._historyTextures.forEach(t=>{for(let i=0;i<t.handles.length;i++)t.textures[i]=null}),e&&(this._textures.clear(),this._historyTextures.clear(),this._addSystemTextures())}_updateHistoryTextures(){this._historyTextures.forEach(e=>{e.index=e.index^1;const t=e.textures[e.index];if(t)for(const{renderTargetWrapper:i,textureIndex:r}of e.references)i.setTexture(t,r,!1)})}_addSystemTextures(){const e={width:this.engine.getRenderWidth(!0),height:this.engine.getRenderHeight(!0)};this._textures.set(Ji,this._backBufferTextureEntry??{name:"backbuffer color",texture:null,creationOptions:{size:e,options:{createMipMaps:!1,samples:this.engine.getCreationOptions().antialias?4:1,types:[0],formats:[5],useSRGBBuffers:[!1],creationFlags:[0],labels:["backbuffer color"]},sizeIsPercentage:!1},namespace:wi.External}),this._textures.set(ss,this._backBufferDepthStencilTextureEntry??{name:"backbuffer depth/stencil",texture:null,creationOptions:{size:e,options:{createMipMaps:!1,samples:this.engine.getCreationOptions().antialias?4:1,types:[0],formats:[16],useSRGBBuffers:[!1],creationFlags:[0],labels:["backbuffer depth/stencil"]},sizeIsPercentage:!1},namespace:wi.External})}_createDebugTexture(e,t){if(!this._debugTextures)return;const i=new $(null,this._scene);return i.name=e,i._texture=t,i._texture.incrementReferences(),i}_freeEntry(e){var i;const t=this._textures.get(e);t&&((i=t.debug)==null||i.dispose(),this._textures.delete(e))}_createHandleForTexture(e,t,i,r,n,a){var u;n=n??os._Counter++,a=a||0;const o=i.isHistoryTexture?`${e} ping`:e;let l=((u=i.options.labels)==null?void 0:u[a])??"";l===o&&(l="");const c={texture:t,name:`${o}${l?" "+l:""}`,creationOptions:{size:ja(i.size)?i.size:{width:i.size,height:i.size},options:i.options,sizeIsPercentage:i.sizeIsPercentage,isHistoryTexture:i.isHistoryTexture},namespace:r,textureIndex:a,textureDescriptionHash:this._createTextureDescriptionHash(i),lifespan:{firstTask:Number.MAX_VALUE,lastTask:0},historyTexture:i.isHistoryTexture};if(this._textures.set(n,c),r===wi.External)return n;if(i.isHistoryTexture){const h={size:{...c.creationOptions.size},options:{...c.creationOptions.options},sizeIsPercentage:c.creationOptions.sizeIsPercentage,isHistoryTexture:!1},d=this._createHandleForTexture(`${e} pong`,null,h,r);return this._textures.get(d).historyTexture=!0,this._historyTextures.set(n,{textures:[null,null],handles:[n,d],index:0,references:[]}),n}if(i.options.types&&i.options.types.length>1&&a===0){const h=i.options.types.length,d={size:ja(i.size)?i.size:{width:i.size,height:i.size},options:i.options,sizeIsPercentage:i.sizeIsPercentage};for(let f=1;f<h;f++)this._createHandleForTexture(o,null,d,r,n+f,f);os._Counter+=h-1}return n}_createTextureDescriptionHash(e){const t=[];return t.push(ja(e.size)?`${e.size.width}_${e.size.height}`:`${e.size}`),t.push(e.sizeIsPercentage?"%":"A"),t.push(e.options.createMipMaps?"M":"N"),t.push(e.options.samples?`${e.options.samples}`:"S1"),t.push(e.options.types?e.options.types.join("_"):"0"),t.push(e.options.formats?e.options.formats.join("_"):"5"),t.push(e.options.useSRGBBuffers?e.options.useSRGBBuffers.join("_"):"false"),t.push(e.options.creationFlags?e.options.creationFlags.join("_"):"0"),t.join("_")}_optimizeTextureAllocation(e){this._computeTextureLifespan(e),this.showDebugLogsForTextureAllcationOptimization&&N.Log("================== Optimization of texture allocation ==================");const t=new Map,i=this._textures.keys();for(let r=i.next();r.done!==!0;r=i.next()){const n=r.value,a=this._textures.get(n);if(a.refHandle!==void 0||a.namespace===wi.External||this.isHistoryTexture(n,!0))continue;const o=a.textureDescriptionHash,l=a.lifespan,c=t.get(o);if(c){let u=!1;for(const h of c){const[d,f]=h;let m=!1;for(const g of f)if(g.firstTask<=l.lastTask&&g.lastTask>=l.firstTask){m=!0;break}if(!m){this.showDebugLogsForTextureAllcationOptimization&&N.Log(`Texture ${n} (${a.name}) reuses cache entry ${d}`),f.push(l),a.aliasHandle=d,u=!0;break}}u||c.push([n,[l]])}else t.set(o,[[n,[l]]])}}_computeTextureLifespan(e){this.showDebugLogsForTextureAllcationOptimization&&N.Log("================== Dump of texture dependencies for all tasks/passes ==================");for(let t=0;t<e.length;++t){const i=e[t];i.passes.length>0&&this._computeTextureLifespanForPasses(i,t,i.passes),i.passesDisabled.length>0&&this._computeTextureLifespanForPasses(i,t,i.passesDisabled),i.dependencies&&(this.showDebugLogsForTextureAllcationOptimization&&N.Log(`task#${t} (${i.name}), global dependencies`),this._updateLifespan(t*100+99,i.dependencies))}if(this.showDebugLogsForTextureAllcationOptimization){N.Log("================== Texture lifespans ==================");const t=this._textures.keys();for(let i=t.next();i.done!==!0;i=t.next()){const r=i.value,n=this._textures.get(r);n.refHandle!==void 0||n.namespace===wi.External||this._historyTextures.has(r)||N.Log(`${r} (${n.name}): ${n.lifespan.firstTask} - ${n.lifespan.lastTask}`)}}}_computeTextureLifespanForPasses(e,t,i){for(let r=0;r<i.length;++r){const n=new Set,a=i[r];lI.IsRenderPass(a)&&(a.collectDependencies(n),this.showDebugLogsForTextureAllcationOptimization&&N.Log(`task#${t} (${e.name}), pass#${r} (${a.name})`),this._updateLifespan(t*100+r,n))}}_updateLifespan(e,t){const i=t.keys();for(let r=i.next();r.done!==!0;r=i.next()){const n=r.value;if(this.isBackbuffer(n))continue;let a=this._textures.get(n);if(!a)throw new Error(`FrameGraph._computeTextureLifespan: Texture handle "${n}" not found in the texture manager.`);let o=n;for(;a.refHandle!==void 0;)if(o=a.refHandle,a=this._textures.get(o),!a)throw new Error(`FrameGraph._computeTextureLifespan: Texture handle "${o}" not found in the texture manager (source handle="${n}").`);a.namespace===wi.External||this._historyTextures.has(o)||(this.showDebugLogsForTextureAllcationOptimization&&N.Log(`    ${o} (${a.name})`),a.lifespan.firstTask=Math.min(a.lifespan.firstTask,e),a.lifespan.lastTask=Math.max(a.lifespan.lastTask,e))}}static CloneTextureOptions(e,t,i){return t!==void 0?{createMipMaps:e.createMipMaps,samples:e.samples,types:e.types?[e.types[t]]:void 0,formats:e.formats?[e.formats[t]]:void 0,useSRGBBuffers:e.useSRGBBuffers?[e.useSRGBBuffers[t]]:void 0,creationFlags:e.creationFlags?[e.creationFlags[t]]:void 0,labels:e.labels?[e.labels[t]]:void 0}:{createMipMaps:e.createMipMaps,samples:e.samples,types:e.types?[...e.types]:void 0,formats:e.formats?[...e.formats]:void 0,useSRGBBuffers:e.useSRGBBuffers?[...e.useSRGBBuffers]:void 0,creationFlags:e.creationFlags?[...e.creationFlags]:void 0,labels:e.labels&&i?[...e.labels]:void 0}}static _GetTextureBlockInformation(e,t){switch(t){case 15:return{width:1,height:1,length:2};case 16:return{width:1,height:1,length:3};case 13:return{width:1,height:1,length:4};case 14:return{width:1,height:1,length:4};case 18:return{width:1,height:1,length:5};case 19:return{width:1,height:1,length:1};case 36492:return{width:4,height:4,length:16};case 36495:return{width:4,height:4,length:16};case 36494:return{width:4,height:4,length:16};case 33779:return{width:4,height:4,length:16};case 33778:return{width:4,height:4,length:16};case 33777:case 33776:return{width:4,height:4,length:8};case 37808:return{width:4,height:4,length:16};case 36196:case 37492:return{width:4,height:4,length:8};case 37496:return{width:4,height:4,length:16}}switch(e){case 3:case 0:switch(t){case 6:case 8:case 0:case 1:case 2:return{width:1,height:1,length:1};case 7:case 9:return{width:1,height:1,length:2};case 4:case 10:return{width:1,height:1,length:3};case 11:return{width:1,height:1,length:4};default:return{width:1,height:1,length:4}}case 4:case 5:switch(t){case 8:return{width:1,height:1,length:2};case 9:return{width:1,height:1,length:4};case 10:return{width:1,height:1,length:6};case 11:return{width:1,height:1,length:8};default:return{width:1,height:1,length:8}}case 6:case 7:switch(t){case 8:return{width:1,height:1,length:4};case 9:return{width:1,height:1,length:8};case 10:return{width:1,height:1,length:12};case 11:return{width:1,height:1,length:16};default:return{width:1,height:1,length:16}}case 1:switch(t){case 6:return{width:1,height:1,length:4};case 7:return{width:1,height:1,length:8};case 4:return{width:1,height:1,length:12};case 5:return{width:1,height:1,length:16};default:return{width:1,height:1,length:16}}case 2:switch(t){case 6:return{width:1,height:1,length:2};case 7:return{width:1,height:1,length:4};case 4:return{width:1,height:1,length:6};case 5:return{width:1,height:1,length:8};default:return{width:1,height:1,length:8}}case 10:return{width:1,height:1,length:2};case 13:switch(t){case 5:case 11:return{width:1,height:1,length:4};default:return{width:1,height:1,length:4}}case 14:switch(t){case 5:case 11:return{width:1,height:1,length:4};default:return{width:1,height:1,length:4}}case 8:return{width:1,height:1,length:2};case 9:return{width:1,height:1,length:2};case 11:switch(t){case 5:return{width:1,height:1,length:4};case 11:return{width:1,height:1,length:4};default:return{width:1,height:1,length:4}}}return{width:1,height:1,length:4}}}os._Counter=2;var ha;(function(s){s[s.Normal=0]="Normal",s[s.Render=1]="Render",s[s.Cull=2]="Cull"})(ha||(ha={}));class B1{get engine(){return this._engine}get scene(){return this._scene}get tasks(){return this._tasks}getLinkedNodeRenderGraph(){return this._linkedNodeRenderGraph}constructor(e,t=!1,i=null){this._linkedNodeRenderGraph=i,this._tasks=[],this._currentProcessedTask=null,this._whenReadyAsyncCancel=null,this.name="Frame Graph",this.uniqueId=bn.UniqueId,this.optimizeTextureAllocation=!0,this.onBuildObservable=new k,this.pausedExecution=!1,this._scene=e,this._engine=e.getEngine(),this.textureManager=new os(this._engine,t,e),this._passContext=new TR(this._engine,this.textureManager,e),this._renderContext=new x_(this._engine,this.textureManager,e),this._scene.addFrameGraph(this)}getClassName(){return"FrameGraph"}getTaskByName(e){return this._tasks.find(t=>t.name===e)}getTasksByType(e){return this._tasks.filter(t=>t instanceof e)}addTask(e){if(this._currentProcessedTask!==null)throw new Error(`FrameGraph.addTask: Can't add the task "${e.name}" while another task is currently building (task: ${this._currentProcessedTask.name}).`);this._tasks.push(e)}addPass(e,t=!1){return this._addPass(e,ha.Normal,t)}addRenderPass(e,t=!1){return this._addPass(e,ha.Render,t)}addCullPass(e,t=!1){return this._addPass(e,ha.Cull,t)}_addPass(e,t,i=!1){if(!this._currentProcessedTask)throw new Error("FrameGraph: A pass must be created during a Task.record execution only.");let r;switch(t){case ha.Render:r=new lI(e,this._currentProcessedTask,this._renderContext,this._engine);break;case ha.Cull:r=new TD(e,this._currentProcessedTask,this._passContext,this._engine);break;default:r=new ED(e,this._currentProcessedTask,this._passContext);break}return this._currentProcessedTask._addPass(r,i),r}build(){this.textureManager._releaseTextures(!1);try{for(const e of this._tasks)e._reset(),this._currentProcessedTask=e,this.textureManager._isRecordingTask=!0,e.record(),this.textureManager._isRecordingTask=!1,this._currentProcessedTask=null;this.textureManager._allocateTextures(this.optimizeTextureAllocation?this._tasks:void 0);for(const e of this._tasks)e._checkTask();for(const e of this._tasks)e.onTexturesAllocatedObservable.notifyObservers(this._renderContext);this.onBuildObservable.notifyObservers(this)}catch(e){throw this._tasks.length=0,this._currentProcessedTask=null,this.textureManager._isRecordingTask=!1,e}}async whenReadyAsync(e=16,t=3e4){let i=null;return await new Promise(r=>{this._whenReadyAsyncCancel=Wn(()=>{let n=this._renderContext._isReady();for(const a of this._tasks){const o=a.isReady();!o&&!i&&(i=a),n&&(n=o)}return n},()=>{this._whenReadyAsyncCancel=null,r()},(n,a)=>{this._whenReadyAsyncCancel=null,a?(N.Error(`FrameGraph: Timeout while waiting for the frame graph to be ready.${i?` First task not ready: ${i.name}`:""}`),n&&N.Error(n)):(N.Error("FrameGraph: An unexpected error occurred while waiting for the frame graph to be ready."),n&&(N.Error(n),n.stack&&N.Error(n.stack)))},e,t)})}execute(){if(!this.pausedExecution){this._renderContext.bindRenderTarget(),this.textureManager._updateHistoryTextures();for(const e of this._tasks){const t=e._getPasses();for(const i of t)i._execute()}this._renderContext.bindRenderTarget(void 0,void 0,!0)}}clear(){var e;(e=this._whenReadyAsyncCancel)==null||e.call(this),this._whenReadyAsyncCancel=null;for(const t of this._tasks)t._reset();this._tasks.length=0,this.textureManager._releaseTextures(),this._currentProcessedTask=null}dispose(){var e;(e=this._whenReadyAsyncCancel)==null||e.call(this),this._whenReadyAsyncCancel=null,this.clear(),this.textureManager._dispose(),this._renderContext._dispose(),this._scene.removeFrameGraph(this)}}var Tv;(function(s){s[s.Boolean=0]="Boolean",s[s.Float=1]="Float",s[s.Int=2]="Int",s[s.Vector2=3]="Vector2",s[s.Vector3=4]="Vector3",s[s.List=5]="List",s[s.Color4=6]="Color4",s[s.SamplingMode=7]="SamplingMode",s[s.TextureFormat=8]="TextureFormat",s[s.TextureType=9]="TextureType",s[s.String=10]="String",s[s.Matrix=11]="Matrix"})(Tv||(Tv={}));function O(s,e=0,t="PROPERTIES",i){return(r,n)=>{let a=r._propStore;a||(a=[],r._propStore=a),a.push({propertyName:n,displayName:s,type:e,groupName:t,options:i??{},className:r.getClassName()})}}class no extends Di{get type(){return this._type}constructor(e,t,i,r=H.Undefined){super(e,t,i),this._storedValue=null,this._type=H.Undefined,this.onValueChangedObservable=new k,this.isExternal=!1,this._type=r,this._isInput=!0,this.registerOutput("output",r),this.setDefaultValue()}setDefaultValue(){switch(this.type){case H.Texture:case H.TextureViewDepth:case H.TextureScreenDepth:case H.TextureNormalizedViewDepth:case H.TextureViewNormal:case H.TextureWorldNormal:case H.TextureAlbedo:case H.TextureReflectivity:case H.TextureLocalPosition:case H.TextureWorldPosition:case H.TextureVelocity:case H.TextureLinearVelocity:case H.TextureIrradiance:case H.TextureAlbedoSqrt:{const e={size:{width:100,height:100},options:{createMipMaps:!1,types:[0],formats:[5],samples:1,useSRGBBuffers:[!1]},sizeIsPercentage:!0,isHistoryTexture:!1};this.creationOptions=e;break}case H.TextureDepthStencilAttachment:{const e={size:{width:100,height:100},options:{createMipMaps:!1,types:[0],formats:[13],useSRGBBuffers:[!1],labels:[this.name],samples:1},sizeIsPercentage:!0,isHistoryTexture:!1};this.creationOptions=e;break}case H.ObjectList:this.value={meshes:null,particleSystems:null},this.isExternal=!0;break;case H.Camera:this.value=this._scene.cameras[0],this.isExternal=!0;break;default:this.isExternal=!0}}get value(){return this._storedValue}set value(e){this._storedValue=e,this.output.value=void 0,this.onValueChangedObservable.notifyObservers(this)}getTypedValue(){return this._storedValue}getInternalTextureFromValue(){return this._storedValue._swapAndDie?this._storedValue:null}getClassName(){return"NodeRenderGraphInputBlock"}get output(){return this._outputs[0]}isAnyTexture(){return(this.type&H.TextureAll)!==0}isBackBuffer(){return(this.type&H.TextureBackBuffer)!==0}isBackBufferDepthStencilAttachment(){return(this.type&H.TextureBackBufferDepthStencilAttachment)!==0}isCamera(){return(this.type&H.Camera)!==0}isObjectList(){return(this.type&H.ObjectList)!==0}isShadowLight(){return(this.type&H.ShadowLight)!==0}_buildBlock(e){if(super._buildBlock(e),this.isExternal){if(this.isBackBuffer())this.output.value=Ji;else if(this.isBackBufferDepthStencilAttachment())this.output.value=ss;else if(this.isCamera())this.output.value=this.getTypedValue();else if(this.isObjectList())this.output.value=this.getTypedValue();else if(this.isShadowLight())this.output.value=this.getTypedValue();else{if(this._storedValue===void 0||this._storedValue===null)throw new Error(`NodeRenderGraphInputBlock: External input "${this.name}" is not set`);const t=this.getInternalTextureFromValue();t&&(this.output.value=this._frameGraph.textureManager.importTexture(this.name,t,this.output.value))}return}if(this.type&H.TextureAllButBackBuffer){const t=this.creationOptions;if(!t)throw new Error(`NodeRenderGraphInputBlock: Creation options are missing for texture "${this.name}"`);this.output.value=this._frameGraph.textureManager.createRenderTargetTexture(this.name,t)}}dispose(){this._storedValue=null,this.onValueChangedObservable.clear(),super.dispose()}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.isExternal = ${this.isExternal};`),this.isAnyTexture()?this.isExternal?e.push(`${this._codeVariableName}.value = EXTERNAL_TEXTURE; // TODO: set the external texture`):e.push(`${this._codeVariableName}.creationOptions = ${JSON.stringify(this.creationOptions)};`):this.isCamera()?e.push(`${this._codeVariableName}.value = EXTERNAL_CAMERA; // TODO: set the external camera`):this.isObjectList()?e.push(`${this._codeVariableName}.value = EXTERNAL_OBJECT_LIST; // TODO: set the external object list`):this.isShadowLight()&&e.push(`${this._codeVariableName}.value = EXTERNAL_SHADOW_LIGHT; // TODO: set the external shadow light`),super._dumpPropertiesCode()+e.join(`
`)}serialize(){const e=super.serialize();return e.type=this.type,e.isExternal=this.isExternal,this.creationOptions&&(e.creationOptions=this.creationOptions),e}_deserialize(e){super._deserialize(e),this._type=e.type,this.output.type=this._type,this.isExternal=e.isExternal,e.creationOptions&&(e.creationOptions.options.depthTextureFormat!==void 0&&(e.creationOptions.options.formats=[e.creationOptions.options.depthTextureFormat]),this.creationOptions=e.creationOptions)}}_([O("Is external",0,"PROPERTIES")],no.prototype,"isExternal",void 0);y("BABYLON.NodeRenderGraphInputBlock",no);class bR extends Br{constructor(e,t){super(e,t),this.color=new Te(.2,.2,.3,1),this.clearColor=!0,this.convertColorToLinearSpace=!1,this.clearDepth=!1,this.clearStencil=!1,this.stencilValue=0,this.outputTexture=this._frameGraph.textureManager.createDanglingHandle(),this.outputDepthTexture=this._frameGraph.textureManager.createDanglingHandle()}record(){if(this.targetTexture===void 0&&this.depthTexture===void 0)throw new Error(`FrameGraphClearTextureTask ${this.name}: targetTexture and depthTexture can't both be undefined.`);const e=this.targetTexture!==void 0?Array.isArray(this.targetTexture)?this.targetTexture:[this.targetTexture]:void 0;let t=0,i=0;if(this.targetTexture!==void 0&&(t=this._frameGraph.textureManager.getTextureDescription(e[0]).options.samples||1,this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,e[0])),this.depthTexture!==void 0&&(i=this._frameGraph.textureManager.getTextureDescription(this.depthTexture).options.samples||1,this._frameGraph.textureManager.resolveDanglingHandle(this.outputDepthTexture,this.depthTexture)),t!==i&&t!==0&&i!==0)throw new Error(`FrameGraphClearTextureTask ${this.name}: the depth texture and the target texture must have the same number of samples.`);const r=this._frameGraph.engine.buildTextureLayout(e?Array(e.length).fill(!0):[],this.targetTexture===Ji&&!this._frameGraph.textureManager.backBufferTextureOverriden),n=st.Color4[0],a=this._frameGraph.addRenderPass(this.name);a.setRenderTarget(e),a.setRenderTargetDepth(this.depthTexture),a.setExecuteFunc(l=>{n.copyFrom(this.color),this.convertColorToLinearSpace&&n.toLinearSpaceToRef(n),l.clearAttachments(n,r,!!this.clearColor,!!this.clearDepth,!!this.clearStencil,this.stencilValue)});const o=this._frameGraph.addRenderPass(this.name+"_disabled",!0);return o.setRenderTarget(e),o.setRenderTargetDepth(this.depthTexture),o.setExecuteFunc(l=>{}),a}}class Ba extends Di{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("target",H.AutoDetect,!0),this.registerInput("depth",H.AutoDetect,!0),this._addDependenciesInput(),this.registerOutput("output",H.BasedOnInput),this.registerOutput("outputDepth",H.BasedOnInput),this.target.addExcludedConnectionPointFromAllowedTypes(H.TextureAll),this.depth.addExcludedConnectionPointFromAllowedTypes(H.TextureDepthStencilAttachment|H.TextureBackBufferDepthStencilAttachment),this.output._typeConnectionSource=this.target,this.outputDepth._typeConnectionSource=this.depth,this._frameGraphTask=new bR(e,t)}get color(){return this._frameGraphTask.color}set color(e){this._frameGraphTask.color=e}get clearColor(){return!!this._frameGraphTask.clearColor}set clearColor(e){this._frameGraphTask.clearColor=e}get convertColorToLinearSpace(){return!!this._frameGraphTask.convertColorToLinearSpace}set convertColorToLinearSpace(e){this._frameGraphTask.convertColorToLinearSpace=e}get clearDepth(){return!!this._frameGraphTask.clearDepth}set clearDepth(e){this._frameGraphTask.clearDepth=e}get clearStencil(){return!!this._frameGraphTask.clearStencil}set clearStencil(e){this._frameGraphTask.clearStencil=e}getClassName(){return"NodeRenderGraphClearBlock"}get target(){return this._inputs[0]}get depth(){return this._inputs[1]}get output(){return this._outputs[0]}get outputDepth(){return this._outputs[1]}_buildBlock(e){var t,i;super._buildBlock(e),this._propagateInputValueToOutput(this.target,this.output),this._propagateInputValueToOutput(this.depth,this.outputDepth),this._frameGraphTask.targetTexture=(t=this.target.connectedPoint)==null?void 0:t.value,this._frameGraphTask.depthTexture=(i=this.depth.connectedPoint)==null?void 0:i.value}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.color = new BABYLON.Color4(${this.color.r}, ${this.color.g}, ${this.color.b}, ${this.color.a});`),e.push(`${this._codeVariableName}.clearColor = ${this.clearColor};`),e.push(`${this._codeVariableName}.convertColorToLinearSpace = ${this.convertColorToLinearSpace};`),e.push(`${this._codeVariableName}.clearDepth = ${this.clearDepth};`),e.push(`${this._codeVariableName}.clearStencil = ${this.clearStencil};`),super._dumpPropertiesCode()+e.join(`
`)}serialize(){const e=super.serialize();return e.color=this.color.asArray(),e.clearColor=this.clearColor,e.convertColorToLinearSpace=this.convertColorToLinearSpace,e.clearDepth=this.clearDepth,e.clearStencil=this.clearStencil,e}_deserialize(e){super._deserialize(e),this.color=Te.FromArray(e.color),this.clearColor=e.clearColor,this.convertColorToLinearSpace=!!e.convertColorToLinearSpace,this.clearDepth=e.clearDepth,this.clearStencil=e.clearStencil}}_([O("Color",6)],Ba.prototype,"color",null);_([O("Clear color",0,void 0,{embedded:!0})],Ba.prototype,"clearColor",null);_([O("Convert color to linear space",0)],Ba.prototype,"convertColorToLinearSpace",null);_([O("Clear depth",0,void 0,{embedded:!0})],Ba.prototype,"clearDepth",null);_([O("Clear stencil",0,void 0,{embedded:!0})],Ba.prototype,"clearStencil",null);y("BABYLON.NodeRenderGraphClearBlock",Ba);class ac extends pa{constructor(e,t,i,r,n){super(e,t,i),this._blockType=r,this._blockName=n,this.needDualDirectionValidation=!0}checkCompatibilityState(e){return e instanceof ac&&e._blockName===this._blockName?0:1}createCustomInputBlock(){return[new this._blockType(this._blockName),this.name]}}class Mi extends Di{get task(){return this._frameGraphTask}constructor(e,t,i,r=!0,n=!0){super(e,t,i),this._additionalConstructionParameters=[r,n],this.registerInput("target",H.AutoDetect),this.registerInput("depth",H.AutoDetect,!0),this.registerInput("camera",H.Camera),this.registerInput("objects",H.ObjectList),this._addDependenciesInput(),this.registerInput("shadowGenerators",H.AutoDetect,!0),this.registerOutput("output",H.BasedOnInput),this.registerOutput("outputDepth",H.BasedOnInput),this.registerOutput("objectRenderer",H.Object,new ac("objectRenderer",this,1,Mi,"NodeRenderGraphBaseObjectRendererBlock")),this.target.addExcludedConnectionPointFromAllowedTypes(H.TextureAllButBackBufferDepthStencil),this.depth.addExcludedConnectionPointFromAllowedTypes(H.TextureDepthStencilAttachment|H.TextureBackBufferDepthStencilAttachment),this.shadowGenerators.addExcludedConnectionPointFromAllowedTypes(H.ShadowGenerator|H.ResourceContainer),this.output._typeConnectionSource=this.target,this.outputDepth._typeConnectionSource=this.depth,this._createFrameGraphObject()}_createFrameGraphObject(){var e;(e=this._frameGraphTask)==null||e.dispose(),this._frameGraphTask=new xu(this.name,this._frameGraph,this._scene,{doNotChangeAspectRatio:this._additionalConstructionParameters[0],enableClusteredLights:this._additionalConstructionParameters[1]})}_saveState(e){e.disabled=this._frameGraphTask.disabled,e.isMainObjectRenderer=this.isMainObjectRenderer,e.depthTest=this.depthTest,e.depthWrite=this.depthWrite,e.disableShadows=this.disableShadows,e.renderInLinearSpace=this.renderInLinearSpace,e.renderParticles=this.renderParticles,e.renderSprites=this.renderSprites,e.forceLayerMaskCheck=this.forceLayerMaskCheck,e.enableBoundingBoxRendering=this.enableBoundingBoxRendering,e.enableOutlineRendering=this.enableOutlineRendering}_restoreState(e){this._frameGraphTask.disabled=e.disabled,this.isMainObjectRenderer=e.isMainObjectRenderer,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.disableShadows=e.disableShadows,this.renderInLinearSpace=e.renderInLinearSpace,this.renderParticles=e.renderParticles,this.renderSprites=e.renderSprites,this.forceLayerMaskCheck=e.forceLayerMaskCheck,this.enableBoundingBoxRendering=e.enableBoundingBoxRendering,this.enableOutlineRendering=e.enableOutlineRendering}_createFrameGraphObjectWithState(e,t){const i={};this._saveState(i),this._additionalConstructionParameters=[e,t],this._createFrameGraphObject(),this._restoreState(i)}get isMainObjectRenderer(){return this._frameGraphTask.isMainObjectRenderer}set isMainObjectRenderer(e){this._frameGraphTask.isMainObjectRenderer=e}get depthTest(){return this._frameGraphTask.depthTest}set depthTest(e){this._frameGraphTask.depthTest=e}get depthWrite(){return this._frameGraphTask.depthWrite}set depthWrite(e){this._frameGraphTask.depthWrite=e}get renderParticles(){return this._frameGraphTask.renderParticles}set renderParticles(e){this._frameGraphTask.renderParticles=e}get renderSprites(){return this._frameGraphTask.renderSprites}set renderSprites(e){this._frameGraphTask.renderSprites=e}get forceLayerMaskCheck(){return this._frameGraphTask.forceLayerMaskCheck}set forceLayerMaskCheck(e){this._frameGraphTask.forceLayerMaskCheck=e}get enableBoundingBoxRendering(){return this._frameGraphTask.enableBoundingBoxRendering}set enableBoundingBoxRendering(e){this._frameGraphTask.enableBoundingBoxRendering=e}get enableOutlineRendering(){return this._frameGraphTask.enableOutlineRendering}set enableOutlineRendering(e){this._frameGraphTask.enableOutlineRendering=e}get disableShadows(){return this._frameGraphTask.disableShadows}set disableShadows(e){this._frameGraphTask.disableShadows=e}get renderInLinearSpace(){return this._frameGraphTask.disableImageProcessing}set renderInLinearSpace(e){this._frameGraphTask.disableImageProcessing=e}get doNotChangeAspectRatio(){return this._frameGraphTask.objectRenderer.options.doNotChangeAspectRatio}set doNotChangeAspectRatio(e){this._createFrameGraphObjectWithState(e,this.enableClusteredLights)}get enableClusteredLights(){return this._frameGraphTask.objectRenderer.options.enableClusteredLights}set enableClusteredLights(e){this._createFrameGraphObjectWithState(this.doNotChangeAspectRatio,e)}getClassName(){return"NodeRenderGraphBaseObjectRendererBlock"}get target(){return this._inputs[0]}get depth(){return this._inputs[1]}get camera(){return this._inputs[2]}get objects(){return this._inputs[3]}get dependencies(){return this._inputs[4]}get shadowGenerators(){return this._inputs[5]}get output(){return this._outputs[0]}get outputDepth(){return this._outputs[1]}get objectRenderer(){return this._outputs[2]}_buildBlock(e){var i,r,n,a;super._buildBlock(e),this.output.value=this._frameGraphTask.outputTexture,this.outputDepth.value=this._frameGraphTask.outputDepthTexture,this.objectRenderer.value=this._frameGraphTask,this._frameGraphTask.targetTexture=(i=this.target.connectedPoint)==null?void 0:i.value,this._frameGraphTask.depthTexture=(r=this.depth.connectedPoint)==null?void 0:r.value,this._frameGraphTask.camera=(n=this.camera.connectedPoint)==null?void 0:n.value,this._frameGraphTask.objectList=(a=this.objects.connectedPoint)==null?void 0:a.value,this._frameGraphTask.shadowGenerators=[];const t=this.shadowGenerators.connectedPoint;if(t)if(t.type===H.ResourceContainer){const o=t.ownerBlock;for(const l of o.inputs)l.connectedPoint&&l.connectedPoint.value!==void 0&&pa.IsShadowGenerator(l.connectedPoint.value)&&this._frameGraphTask.shadowGenerators.push(l.connectedPoint.value)}else pa.IsShadowGenerator(t.value)&&(this._frameGraphTask.shadowGenerators[0]=t.value)}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.isMainObjectRenderer = ${this.isMainObjectRenderer};`),e.push(`${this._codeVariableName}.depthTest = ${this.depthTest};`),e.push(`${this._codeVariableName}.depthWrite = ${this.depthWrite};`),e.push(`${this._codeVariableName}.renderParticles = ${this.renderParticles};`),e.push(`${this._codeVariableName}.renderSprites = ${this.renderSprites};`),e.push(`${this._codeVariableName}.forceLayerMaskCheck = ${this.forceLayerMaskCheck};`),e.push(`${this._codeVariableName}.enableBoundingBoxRendering = ${this.enableBoundingBoxRendering};`),e.push(`${this._codeVariableName}.enableOutlineRendering = ${this.enableOutlineRendering};`),e.push(`${this._codeVariableName}.disableShadows = ${this.disableShadows};`),e.push(`${this._codeVariableName}.renderInLinearSpace = ${this.renderInLinearSpace};`),super._dumpPropertiesCode()+e.join(`
`)}serialize(){const e=super.serialize();return e.isMainObjectRenderer=this.isMainObjectRenderer,e.depthTest=this.depthTest,e.depthWrite=this.depthWrite,e.renderParticles=this.renderParticles,e.renderSprites=this.renderSprites,e.forceLayerMaskCheck=this.forceLayerMaskCheck,e.enableBoundingBoxRendering=this.enableBoundingBoxRendering,e.enableOutlineRendering=this.enableOutlineRendering,e.disableShadows=this.disableShadows,e.renderInLinearSpace=this.renderInLinearSpace,e}_deserialize(e){super._deserialize(e),this.isMainObjectRenderer=!!e.isMainObjectRenderer,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.renderParticles=e.renderParticles??!0,this.renderSprites=e.renderSprites??!0,this.forceLayerMaskCheck=e.forceLayerMaskCheck??!0,this.enableBoundingBoxRendering=e.enableBoundingBoxRendering??!0,this.enableOutlineRendering=e.enableOutlineRendering??!0,this.disableShadows=e.disableShadows,this.renderInLinearSpace=!!e.renderInLinearSpace}}_([O("Is main object renderer",0,"PROPERTIES")],Mi.prototype,"isMainObjectRenderer",null);_([O("Depth test",0,"PROPERTIES")],Mi.prototype,"depthTest",null);_([O("Depth write",0,"PROPERTIES")],Mi.prototype,"depthWrite",null);_([O("Render particles",0,"PROPERTIES")],Mi.prototype,"renderParticles",null);_([O("Render sprites",0,"PROPERTIES")],Mi.prototype,"renderSprites",null);_([O("Force layer mask check",0,"PROPERTIES")],Mi.prototype,"forceLayerMaskCheck",null);_([O("Enable bounding box rendering",0,"PROPERTIES")],Mi.prototype,"enableBoundingBoxRendering",null);_([O("Enable outline/overlay rendering",0,"PROPERTIES")],Mi.prototype,"enableOutlineRendering",null);_([O("Disable shadows",0,"PROPERTIES")],Mi.prototype,"disableShadows",null);_([O("Disable image processing",0,"PROPERTIES")],Mi.prototype,"renderInLinearSpace",null);_([O("Do not change aspect ratio",0,"PROPERTIES")],Mi.prototype,"doNotChangeAspectRatio",null);_([O("Enable clustered lights",0,"PROPERTIES")],Mi.prototype,"enableClusteredLights",null);class CR extends Mi{getClassName(){return"NodeRenderGraphObjectRendererBlock"}}y("BABYLON.NodeRenderGraphObjectRendererBlock",CR);class V1{constructor(){this.verbose=!1,this._notConnectedNonOptionalInputs=[]}emitErrors(e=null){let t="";for(const i of this._notConnectedNonOptionalInputs)t+=`input "${i.name}" from block "${i.ownerBlock.name}"[${i.ownerBlock.getClassName()}] is not connected and is not optional.
`;return t?(e&&e.notifyObservers(t),N.Error(`Build of node render graph failed:
`+t),!1):!0}}class U1 extends Br{constructor(e,t,i){super(e,t),this._scene=i,this.outputObjectList={meshes:null,particleSystems:null}}record(){if(this.objectList===void 0||this.camera===void 0)throw new Error(`FrameGraphCullObjectsTask ${this.name}: objectList and camera are required`);this.outputObjectList.meshes=this.objectList.meshes,this.outputObjectList.particleSystems=this.objectList.particleSystems;const e=this._frameGraph.addCullPass(this.name);e.setObjectList(this.outputObjectList),e.setExecuteFunc(i=>{if(this.outputObjectList.particleSystems=this.objectList.particleSystems,this._scene._activeMeshesFrozen)return;this.outputObjectList.meshes=[],this.camera._updateFrustumPlanes();const r=this.camera._frustumPlanes,n=this.objectList.meshes||this._scene.meshes;for(let a=0;a<n.length;a++){const o=n[a];o.isBlocked||!o.isReady()||!o.isEnabled()||o.scaling.hasAZeroComponent||o.isVisible&&o.visibility>0&&o.layerMask&this.camera.layerMask&&(this._scene.skipFrustumClipping||o.alwaysSelectAsActiveMesh||o.isInFrustum(r))&&this.outputObjectList.meshes.push(o)}});const t=this._frameGraph.addCullPass(this.name+"_disabled",!0);t.setObjectList(this.outputObjectList),t.setExecuteFunc(i=>{this.outputObjectList.meshes=this.objectList.meshes,this.outputObjectList.particleSystems=this.objectList.particleSystems})}}class yR extends Di{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("camera",H.Camera),this.registerInput("objects",H.ObjectList),this._addDependenciesInput(),this.registerOutput("output",H.ObjectList),this._frameGraphTask=new U1(this.name,t,i)}getClassName(){return"NodeRenderGraphCullObjectsBlock"}get camera(){return this._inputs[0]}get objects(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){var t,i;super._buildBlock(e),this.output.value=this._frameGraphTask.outputObjectList,this._frameGraphTask.camera=(t=this.camera.connectedPoint)==null?void 0:t.value,this._frameGraphTask.objectList=(i=this.objects.connectedPoint)==null?void 0:i.value}_dumpPropertiesCode(){const e=[];return super._dumpPropertiesCode()+e.join(`
`)}serialize(){return super.serialize()}_deserialize(e){super._deserialize(e)}}y("BABYLON.NodeRenderGraphCullObjectsBlock",yR);class pr{_getGlobalNodeRenderGraphEditor(){if(typeof NODERENDERGRAPHEDITOR<"u")return NODERENDERGRAPHEDITOR;if(typeof BABYLON<"u"&&typeof BABYLON.NodeRenderGraphEditor<"u")return BABYLON}get onBuildObservable(){return this._frameGraph.onBuildObservable}get frameGraph(){return this._frameGraph}getScene(){return this._scene}constructor(e,t,i){this._buildId=pr._BuildIdGenerator++,this.BJSNODERENDERGRAPHEDITOR=this._getGlobalNodeRenderGraphEditor(),this.editorData=null,this.attachedBlocks=[],this.onBuildErrorObservable=new k,this.outputBlock=null,this._resizeObserver=null,this.name=e,this._scene=t,this._engine=t.getEngine(),i={debugTextures:!1,autoConfigure:!1,verbose:!1,rebuildGraphOnEngineResize:!0,autoFillExternalInputs:!0,...i},this._options=i,this._frameGraph=new B1(this._scene,i.debugTextures,this),this._frameGraph.name=e,i.rebuildGraphOnEngineResize&&(this._resizeObserver=this._engine.onResizeObservable.add(()=>{this.build()}))}getClassName(){return"NodeRenderGraph"}getBlockByName(e){let t=null;for(const i of this.attachedBlocks)if(i.name===e)if(!t)t=i;else return j.Warn("More than one block was found with the name `"+e+"`"),t;return t}getBlockByPredicate(e){for(const t of this.attachedBlocks)if(e(t))return t;return null}getBlocksByPredicate(e){const t=[];for(const i of this.attachedBlocks)e(i)&&t.push(i);return t}getInputBlocks(){const e=[];for(const t of this.attachedBlocks)t.isInput&&e.push(t);return e}async edit(e){return await new Promise(t=>{if(this.BJSNODERENDERGRAPHEDITOR=this.BJSNODERENDERGRAPHEDITOR||this._getGlobalNodeRenderGraphEditor(),typeof this.BJSNODERENDERGRAPHEDITOR>"u"){const i=e&&e.editorURL?e.editorURL:pr.EditorURL;j.LoadBabylonScript(i,()=>{this.BJSNODERENDERGRAPHEDITOR=this.BJSNODERENDERGRAPHEDITOR||this._getGlobalNodeRenderGraphEditor(),this._createNodeEditor(e==null?void 0:e.nodeRenderGraphEditorConfig),t()})}else this._createNodeEditor(e==null?void 0:e.nodeRenderGraphEditorConfig),t()})}_createNodeEditor(e){const t={nodeRenderGraph:this,...e};this.BJSNODERENDERGRAPHEDITOR.NodeRenderGraphEditor.Show(t)}build(e=!1){if(!this.outputBlock)throw new Error("You must define the outputBlock property before building the node render graph");this._initializeBlock(this.outputBlock),this._frameGraph.clear();const t=new V1;t.buildId=this._buildId,t.verbose=this._options.verbose,this._options.autoFillExternalInputs&&this._autoFillExternalInputs();const i=this.getBlocksByPredicate(r=>r instanceof Mi);i.length>0&&!i.find(r=>r.isMainObjectRenderer)&&(i[0].isMainObjectRenderer=!0);try{this.outputBlock.build(t),e||this._frameGraph.build()}finally{this._buildId=pr._BuildIdGenerator++,t.emitErrors(this.onBuildErrorObservable)}}_autoFillExternalInputs(){const e=this.getInputBlocks(),t=[];for(const n of this._scene.lights)n.setShadowProjectionMatrix!==void 0&&t.push(n);let i=0,r=0;for(const n of e)if(n.isExternal&&n.isAnAncestorOfType("NodeRenderGraphOutputBlock")&&!(n.type&H.TextureAllButBackBuffer))if(n.isCamera()){const a=this._scene.cameras[i++]||this._scene.cameras[0];this._scene.cameraToUseForPointers||(this._scene.cameraToUseForPointers=a),n.value=a}else n.isObjectList()?n.value={meshes:this._scene.meshes,particleSystems:this._scene.particleSystems}:n.isShadowLight()&&r<t.length&&(n.value=t[r++],r=r%t.length)}whenReadyAsync(e=16,t=3e4){return this._frameGraph.whenReadyAsync(e,t)}execute(){this._frameGraph.execute()}_initializeBlock(e){e.initialize(),this._options.autoConfigure&&e.autoConfigure(),this.attachedBlocks.indexOf(e)===-1&&this.attachedBlocks.push(e);for(const t of e.inputs){const i=t.connectedPoint;if(i){const r=i.ownerBlock;r!==e&&this._initializeBlock(r)}}}clear(){this.outputBlock=null,this.attachedBlocks.length=0}removeBlock(e){const t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e===this.outputBlock&&(this.outputBlock=null)}parseSerializedObject(e,t=!1){t||this.clear();const i={};for(const r of e.blocks){const n=ki(r.customType);if(n){const a=r.additionalConstructionParameters,o=a?new n("",this._frameGraph,this._scene,...a):new n("",this._frameGraph,this._scene);o._deserialize(r),i[r.id]=o,this.attachedBlocks.push(o)}}for(const r of this.attachedBlocks)if(r.isTeleportOut){const n=r,a=n._tempEntryPointUniqueId;if(a){const o=i[a];o&&o.attachToEndpoint(n)}}for(let r=0;r<e.blocks.length;r++){const n=e.blocks[r],a=i[n.id];a&&(a.inputs.length&&n.inputs.some(o=>o.targetConnectionName)&&!t||this._restoreConnections(a,e,i))}if(e.outputNodeId&&(this.outputBlock=i[e.outputNodeId]),e.locations||e.editorData&&e.editorData.locations){const r=e.locations||e.editorData.locations;for(const a of r)i[a.blockId]&&(a.blockId=i[a.blockId].uniqueId);t&&this.editorData&&this.editorData.locations&&r.concat(this.editorData.locations),e.locations?this.editorData={locations:r}:(this.editorData=e.editorData,this.editorData.locations=r);const n={};for(const a in i)n[a]=i[a].uniqueId;this.editorData.map=n}this.comment=e.comment}_restoreConnections(e,t,i){for(const r of e.outputs)for(const n of t.blocks){const a=i[n.id];if(a){for(const o of n.inputs)if(i[o.targetBlockId]===e&&o.targetConnectionName===r.name){const l=a.getInputByName(o.inputName);if(!l||l.isConnected)continue;r.connectTo(l,!0),this._restoreConnections(a,t,i);continue}}}}generateCode(){let e=[];const t=[],i=["const","var","let"];this.outputBlock&&this._gatherBlocks(this.outputBlock,t);const r=JSON.stringify(this._options);let n=`let nodeRenderGraph = new BABYLON.NodeRenderGraph("${this.name||"render graph"}", scene, ${r});
`;for(const a of t)a.isInput&&e.indexOf(a)===-1&&(n+=a._dumpCode(i,e)+`
`);return this.outputBlock&&(e=[],n+=`// Connections
`,n+=this.outputBlock._dumpCodeForOutputConnections(e),n+=`// Output nodes
`,n+=`nodeRenderGraph.outputBlock = ${this.outputBlock._codeVariableName};
`,n+=`nodeRenderGraph.build();
`),n}_gatherBlocks(e,t){if(t.indexOf(e)===-1){t.push(e);for(const i of e.inputs){const r=i.connectedPoint;if(r){const n=r.ownerBlock;n!==e&&this._gatherBlocks(n,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._gatherBlocks(i.entryPoint,t)}}}setToDefault(){this.clear(),this.editorData=null;const e=new no("Color Texture",this._frameGraph,this._scene,H.Texture);e.creationOptions.options.samples=4;const t=new no("Depth Texture",this._frameGraph,this._scene,H.TextureDepthStencilAttachment);t.creationOptions.options.samples=4;const i=new Ba("Clear",this._frameGraph,this._scene);i.clearDepth=!0,i.clearStencil=!0,e.output.connectTo(i.target),t.output.connectTo(i.depth);const r=new no("Camera",this._frameGraph,this._scene,H.Camera),n=new no("Object List",this._frameGraph,this._scene,H.ObjectList),a=new yR("Cull",this._frameGraph,this._scene);r.output.connectTo(a.camera),n.output.connectTo(a.objects);const o=new CR("Main Rendering",this._frameGraph,this._scene);r.output.connectTo(o.camera),a.output.connectTo(o.objects),i.output.connectTo(o.target),i.outputDepth.connectTo(o.depth);const l=new xR("Output",this._frameGraph,this._scene);o.output.connectTo(l.texture),this.outputBlock=l}clone(e){const t=this.serialize(),i=me.Clone(()=>new pr(e,this._scene),this);return i.name=e,i.parseSerializedObject(t),i._buildId=this._buildId,i.build(),i}serialize(e){const t=e?{}:me.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];e?i=e:(t.customType="BABYLON.NodeRenderGraph",this.outputBlock&&(t.outputNodeId=this.outputBlock.uniqueId)),t.blocks=[];for(const r of i)t.blocks.push(r.serialize());if(!e)for(const r of this.attachedBlocks)i.indexOf(r)===-1&&t.blocks.push(r.serialize());return t}dispose(){for(const e of this.attachedBlocks)e.dispose();this._frameGraph.dispose(),this._frameGraph=void 0,this._engine.onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null,this.attachedBlocks.length=0,this.onBuildErrorObservable.clear()}static CreateDefault(e,t,i){const r=new pr(e,t,i);return r.setToDefault(),r.build(),r}static Parse(e,t,i,r=!0){const n=me.Parse(()=>new pr(e.name,t,i),e,null);return n.parseSerializedObject(e),r||n.build(),n}static ParseFromSnippetAsync(e,t,i,r,n=!0){return e==="_BLANK"?Promise.resolve(pr.CreateDefault("blank",t,i)):new Promise((a,o)=>{const l=new dn;l.addEventListener("readystatechange",()=>{if(l.readyState==4)if(l.status==200){const c=JSON.parse(JSON.parse(l.responseText).jsonPayload),u=JSON.parse(c.nodeRenderGraph);r||(r=me.Parse(()=>new pr(e,t,i),u,null)),r.parseSerializedObject(u),r.snippetId=e;try{n||r.build(),a(r)}catch(h){o(h)}}else o("Unable to load the snippet "+e)}),l.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),l.send()})}}pr._BuildIdGenerator=0;pr.EditorURL=`${j._DefaultCdnUrl}/v${ft.Version}/NodeRenderGraph/babylon.nodeRenderGraph.js`;pr.SnippetUrl="https://snippet.babylonjs.com";_([R()],pr.prototype,"name",void 0);_([R("comment")],pr.prototype,"comment",void 0);class k1 extends Di{constructor(e,t,i){super(e,t,i),this.registerInput("input",H.AutoDetect),this.registerOutput("output",H.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"NodeRenderGraphElbowBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];this._propagateInputValueToOutput(i,t)}}y("BABYLON.NodeRenderGraphElbowBlock",k1);class Td extends Br{constructor(e,t){super(e,t)}record(){if(!this.func)throw new Error("FrameGraphExecuteTask: Execute task must have a function.");const e=this._frameGraph.addPass(this.name);return e.setExecuteFunc(i=>{this.func(i)}),this._frameGraph.addPass(this.name+"_disabled",!0).setExecuteFunc(i=>{var r;(r=this.funcDisabled)==null||r.call(this,i)}),e}}class G1 extends Di{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this._addDependenciesInput(H.Camera|H.ShadowLight|H.ObjectList),this.registerOutput("output",H.ResourceContainer),this._frameGraphTask=new Td(e,t)}getClassName(){return"NodeRenderGraphExecuteBlock"}get output(){return this._outputs[0]}}y("BABYLON.NodeRenderGraphExecuteBlock",G1);class z1 extends Di{constructor(e,t,i){super(e,t,i),this.registerInput("resource0",H.AutoDetect,!0),this.registerInput("resource1",H.AutoDetect,!0),this.registerInput("resource2",H.AutoDetect,!0),this.registerInput("resource3",H.AutoDetect,!0),this.registerInput("resource4",H.AutoDetect,!0),this.registerInput("resource5",H.AutoDetect,!0),this.registerInput("resource6",H.AutoDetect,!0),this.registerInput("resource7",H.AutoDetect,!0),this.registerOutput("output",H.ResourceContainer),this.resource0.addExcludedConnectionPointFromAllowedTypes(H.TextureAllButBackBuffer|H.ShadowGenerator),this.resource1.addExcludedConnectionPointFromAllowedTypes(H.TextureAllButBackBuffer|H.ShadowGenerator),this.resource2.addExcludedConnectionPointFromAllowedTypes(H.TextureAllButBackBuffer|H.ShadowGenerator),this.resource3.addExcludedConnectionPointFromAllowedTypes(H.TextureAllButBackBuffer|H.ShadowGenerator),this.resource4.addExcludedConnectionPointFromAllowedTypes(H.TextureAllButBackBuffer|H.ShadowGenerator),this.resource5.addExcludedConnectionPointFromAllowedTypes(H.TextureAllButBackBuffer|H.ShadowGenerator),this.resource6.addExcludedConnectionPointFromAllowedTypes(H.TextureAllButBackBuffer|H.ShadowGenerator),this.resource7.addExcludedConnectionPointFromAllowedTypes(H.TextureAllButBackBuffer|H.ShadowGenerator)}getClassName(){return"NodeRenderGraphResourceContainerBlock"}get resource0(){return this._inputs[0]}get resource1(){return this._inputs[1]}get resource2(){return this._inputs[2]}get resource3(){return this._inputs[3]}get resource4(){return this._inputs[4]}get resource5(){return this._inputs[5]}get resource6(){return this._inputs[6]}get resource7(){return this._inputs[7]}get output(){return this._outputs[0]}}y("BABYLON.NodeRenderGraphResourceContainerBlock",z1);class ms extends gt{constructor(e,t=null,i,r,n){super({...n,name:e,engine:t||ft.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:ms.FragmentUrl,uniforms:ms.Uniforms}),this.direction=i,this.kernel=r,this.textureWidth=0,this.textureHeight=0}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(U(()=>Promise.resolve().then(()=>Eh),void 0))):t.push(U(()=>Promise.resolve().then(()=>xh),void 0)),super._gatherImports(e,t)}bind(){super.bind(),this._drawWrapper.effect.setFloat2("screenSize",this.textureWidth,this.textureHeight),this._drawWrapper.effect.setVector2("direction",this.direction),this._drawWrapper.effect.setFloat("blurWidth",this.kernel)}}ms.FragmentUrl="glowBlurPostProcess";ms.Uniforms=["screenSize","direction","blurWidth"];class Vn{get camera(){return this._options.camera}set camera(e){this._options.camera=e}get renderingGroupId(){return this._options.renderingGroupId}set renderingGroupId(e){this._options.renderingGroupId=e}get objectRenderer(){return this._objectRenderer}get shaderLanguage(){return this._shaderLanguage}setMaterialForRendering(e,t){if(this._objectRenderer.setMaterialForRendering(e,t),Array.isArray(e))for(let i=0;i<e.length;++i){const r=e[i];t?this._materialForRendering[r.uniqueId]=[r,t]:delete this._materialForRendering[r.uniqueId]}else t?this._materialForRendering[e.uniqueId]=[e,t]:delete this._materialForRendering[e.uniqueId]}getEffectIntensity(e){return this._effectIntensity[e.uniqueId]??1}setEffectIntensity(e,t){this._effectIntensity[e.uniqueId]=t}constructor(e,t,i=!1,r=!1,n){this._additionalImportShadersAsync=n,this._vertexBuffers={},this._dontCheckIfReady=!1,this._shouldRender=!0,this._emissiveTextureAndColor={texture:null,color:new Te},this._effectIntensity={},this._postProcesses=[],this.neutralColor=new Te,this.isEnabled=!0,this.disableBoundingBoxesFromEffectLayer=!1,this.onDisposeObservable=new k,this.onBeforeRenderLayerObservable=new k,this.onBeforeComposeObservable=new k,this.onBeforeRenderMeshToEffect=new k,this.onAfterRenderMeshToEffect=new k,this.onAfterComposeObservable=new k,this.onBeforeBlurObservable=new k,this.onAfterBlurObservable=new k,this._shaderLanguage=0,this._materialForRendering={},this._shadersLoaded=!1,this.name=e,this._scene=t||De.LastCreatedScene,this._dontCheckIfReady=r,this._scene.getEngine().isWebGPU&&!i&&!Vn.ForceGLSL&&(this._shaderLanguage=1),this._engine=this._scene.getEngine(),this._mergeDrawWrapper=[],this._generateIndexBuffer(),this._generateVertexBuffer()}getEffectName(){return""}isReady(e,t){return!0}needStencil(){return!1}_createMergeEffect(){throw new Error("Effect Layer: no merge effect defined")}_createTextureAndPostProcesses(){}_internalCompose(e,t){}_setEmissiveTextureAndColor(e,t,i){}_numInternalDraws(){return 1}_init(e){this._options={mainTextureRatio:.5,mainTextureFixedSize:0,mainTextureType:0,alphaBlendingMode:2,camera:null,renderingGroupId:-1,...e},this._createObjectRenderer()}_generateIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._engine.createIndexBuffer(e)}_generateVertexBuffer(){const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1);const t=new M(this._engine,e,M.PositionKind,!1,!1,2);this._vertexBuffers[M.PositionKind]=t}_createObjectRenderer(){this._objectRenderer=new iI(`ObjectRenderer for thin effect layer ${this.name}`,this._scene,{doNotChangeAspectRatio:!0}),this._objectRenderer.activeCamera=this._options.camera,this._objectRenderer.renderParticles=!1,this._objectRenderer.renderList=null;const e=!!this._scene.getBoundingBoxRenderer;let t=!1;e&&(this._objectRenderer.onBeforeRenderObservable.add(()=>{t=this._scene.getBoundingBoxRenderer().enabled,this._scene.getBoundingBoxRenderer().enabled=!this.disableBoundingBoxesFromEffectLayer&&t}),this._objectRenderer.onAfterRenderObservable.add(()=>{this._scene.getBoundingBoxRenderer().enabled=t})),this._objectRenderer.customIsReadyFunction=(i,r,n)=>{if((n||r===0)&&i.subMeshes)for(let a=0;a<i.subMeshes.length;++a){const o=i.subMeshes[a],l=o.getMaterial(),c=o.getRenderingMesh();if(!l)continue;const h=c._getInstancesRenderList(o._id,!!o.getReplacementMesh()).hardwareInstancedRendering[o._id]||c.hasThinInstances;if(this._setEmissiveTextureAndColor(c,o,l),!this._isSubMeshReady(o,h,this._emissiveTextureAndColor.texture))return!1}return!0},this._objectRenderer.customRenderFunction=(i,r,n,a)=>{this.onBeforeRenderLayerObservable.notifyObservers(this);let o;const l=this._scene.getEngine();if(a.length){for(l.setColorWrite(!1),o=0;o<a.length;o++)this._renderSubMesh(a.data[o]);l.setColorWrite(!0)}for(o=0;o<i.length;o++)this._renderSubMesh(i.data[o]);for(o=0;o<r.length;o++)this._renderSubMesh(r.data[o]);const c=l.getAlphaMode();for(o=0;o<n.length;o++){const u=n.data[o],h=u.getMaterial();if(h&&h.needDepthPrePass){const d=h.getScene().getEngine();d.setColorWrite(!1),this._renderSubMesh(u),d.setColorWrite(!0)}this._renderSubMesh(u,!0)}l.setAlphaMode(c)}}_addCustomEffectDefines(e){}_internalIsSubMeshReady(e,t,i){var C;const r=this._scene.getEngine(),n=e.getMesh(),a=(C=n._internalAbstractMeshDataInfo._materialForRenderPass)==null?void 0:C[r.currentRenderPassId];if(a)return a.isReadyForSubMesh(n,e,t);const o=e.getMaterial();if(!o)return!1;if(this._useMeshMaterial(e.getRenderingMesh()))return o.isReadyForSubMesh(e.getMesh(),e,t);const l=[],c=[M.PositionKind];let u=!1,h=!1;const d=!1;if(o){const A=o.needAlphaTestingForMesh(n),I=o.getAlphaTestTexture(),F=I&&I.hasAlpha&&(o.useAlphaFromDiffuseTexture||o._useAlphaFromAlbedoTexture);I&&(A||F)&&(l.push("#define DIFFUSE"),n.isVerticesDataPresent(M.UV2Kind)&&I.coordinatesIndex===1?(l.push("#define DIFFUSEUV2"),h=!0):n.isVerticesDataPresent(M.UVKind)&&(l.push("#define DIFFUSEUV1"),u=!0),A&&(l.push("#define ALPHATEST"),l.push("#define ALPHATESTVALUE 0.4")),I.gammaSpace||l.push("#define DIFFUSE_ISLINEAR"));const V=o.opacityTexture;V&&(l.push("#define OPACITY"),n.isVerticesDataPresent(M.UV2Kind)&&V.coordinatesIndex===1?(l.push("#define OPACITYUV2"),h=!0):n.isVerticesDataPresent(M.UVKind)&&(l.push("#define OPACITYUV1"),u=!0))}i&&(l.push("#define EMISSIVE"),n.isVerticesDataPresent(M.UV2Kind)&&i.coordinatesIndex===1?(l.push("#define EMISSIVEUV2"),h=!0):n.isVerticesDataPresent(M.UVKind)&&(l.push("#define EMISSIVEUV1"),u=!0),i.gammaSpace||l.push("#define EMISSIVE_ISLINEAR")),n.useVertexColors&&n.isVerticesDataPresent(M.ColorKind)&&n.hasVertexAlpha&&o.transparencyMode!==Le.MATERIAL_OPAQUE&&(c.push(M.ColorKind),l.push("#define VERTEXALPHA")),u&&(c.push(M.UVKind),l.push("#define UV1")),h&&(c.push(M.UV2Kind),l.push("#define UV2"));const f=new Ma;if(n.useBones&&n.computeBonesUsingShaders){c.push(M.MatricesIndicesKind),c.push(M.MatricesWeightsKind),n.numBoneInfluencers>4&&(c.push(M.MatricesIndicesExtraKind),c.push(M.MatricesWeightsExtraKind)),l.push("#define NUM_BONE_INFLUENCERS "+n.numBoneInfluencers);const A=n.skeleton;A&&A.isUsingTextureForMatrices?l.push("#define BONETEXTURE"):l.push("#define BonesPerMesh "+(A?A.bones.length+1:0)),n.numBoneInfluencers>0&&f.addCPUSkinningFallback(0,n)}else l.push("#define NUM_BONE_INFLUENCERS 0");const m=n.morphTargetManager?Eu(n.morphTargetManager,l,c,n,!0,!1,!1,u,h,d):0;t&&(l.push("#define INSTANCES"),Tu(c),e.getRenderingMesh().hasThinInstances&&l.push("#define THIN_INSTANCES")),Vm(o,this._scene,l),this._addCustomEffectDefines(l);const g=e._getDrawWrapper(void 0,!0),v=g.defines,E=l.join(`
`);if(v!==E){const A=["world","mBones","viewProjection","glowColor","morphTargetInfluences","morphTargetCount","boneTextureWidth","diffuseMatrix","emissiveMatrix","opacityMatrix","opacityIntensity","morphTargetTextureInfo","morphTargetTextureIndices","glowIntensity"];Na(A),g.setEffect(this._engine.createEffect("glowMapGeneration",c,A,["diffuseSampler","emissiveSampler","opacitySampler","boneSampler","morphTargets"],E,f,void 0,void 0,{maxSimultaneousMorphTargets:m},this._shaderLanguage,this._shadersLoaded?void 0:async()=>{await this._importShadersAsync(),this._shadersLoaded=!0}),E)}return g.effect.isReady()&&(this._dontCheckIfReady||!this._dontCheckIfReady&&this.isLayerReady())}_isSubMeshReady(e,t,i){return this._internalIsSubMeshReady(e,t,i)}async _importShadersAsync(){var e;this._shaderLanguage===1?await Promise.all([U(()=>Promise.resolve().then(()=>JV),void 0),U(()=>Promise.resolve().then(()=>QV),void 0)]):await Promise.all([U(()=>Promise.resolve().then(()=>qV),void 0),U(()=>Promise.resolve().then(()=>YV),void 0)]),(e=this._additionalImportShadersAsync)==null||e.call(this)}_internalIsLayerReady(){let e=!0;for(let i=0;i<this._postProcesses.length;i++)e=this._postProcesses[i].isReady()&&e;const t=this._numInternalDraws();for(let i=0;i<t;++i){let r=this._mergeDrawWrapper[i];r||(r=this._mergeDrawWrapper[i]=new gn(this._engine),r.setEffect(this._createMergeEffect())),e=r.effect.isReady()&&e}return e}isLayerReady(){return this._internalIsLayerReady()}compose(){if(!this._dontCheckIfReady&&!this.isLayerReady())return!1;const e=this._scene.getEngine(),t=this._numInternalDraws();this.onBeforeComposeObservable.notifyObservers(this);const i=e.getAlphaMode();for(let r=0;r<t;++r){const n=this._mergeDrawWrapper[r];e.enableEffect(n),e.setState(!1),e.bindBuffers(this._vertexBuffers,this._indexBuffer,n.effect),e.setAlphaMode(this._options.alphaBlendingMode),this._internalCompose(n.effect,r)}return e.setAlphaMode(i),this.onAfterComposeObservable.notifyObservers(this),!0}_internalHasMesh(e){return this.renderingGroupId===-1||e.renderingGroupId===this.renderingGroupId}hasMesh(e){return this._internalHasMesh(e)}_internalShouldRender(){return this.isEnabled&&this._shouldRender}shouldRender(){return this._internalShouldRender()}_shouldRenderMesh(e){return!0}_internalCanRenderMesh(e,t){return!t.needAlphaBlendingForMesh(e)}_canRenderMesh(e,t){return this._internalCanRenderMesh(e,t)}_renderSubMesh(e,t=!1){var g;if(!this._internalShouldRender())return;const i=e.getMaterial(),r=e.getMesh(),n=e.getReplacementMesh(),a=e.getRenderingMesh(),o=e.getEffectiveMesh(),l=this._scene,c=l.getEngine();if(o._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!i||!this._canRenderMesh(a,i))return;let u=i._getEffectiveOrientation(a);o._getWorldMatrixDeterminant()<0&&(u=u===Le.ClockWiseSideOrientation?Le.CounterClockWiseSideOrientation:Le.ClockWiseSideOrientation);const d=u===Le.ClockWiseSideOrientation;c.setState(i.backFaceCulling,i.zOffset,void 0,d,i.cullBackFaces,void 0,i.zOffsetUnits);const f=a._getInstancesRenderList(e._id,!!n);if(f.mustReturn||!this._shouldRenderMesh(a))return;const m=f.hardwareInstancedRendering[e._id]||a.hasThinInstances;if(this._setEmissiveTextureAndColor(a,e,i),this.onBeforeRenderMeshToEffect.notifyObservers(r),this._useMeshMaterial(a))e.getMaterial()._glowModeEnabled=!0,a.render(e,t,n||void 0),e.getMaterial()._glowModeEnabled=!1;else if(this._isSubMeshReady(e,m,this._emissiveTextureAndColor.texture)){const v=(g=o._internalAbstractMeshDataInfo._materialForRenderPass)==null?void 0:g[c.currentRenderPassId];let E=e._getDrawWrapper();if(!E&&v&&(E=v._getDrawWrapper()),!E)return;const T=E.effect;if(c.enableEffect(E),m||a._bind(e,T,i.fillMode),v?v.bindForSubMesh(o.getWorldMatrix(),o,e):(T.setMatrix("viewProjection",l.getTransformMatrix()),T.setMatrix("world",o.getWorldMatrix()),T.setFloat4("glowColor",this._emissiveTextureAndColor.color.r,this._emissiveTextureAndColor.color.g,this._emissiveTextureAndColor.color.b,this._emissiveTextureAndColor.color.a)),!v){const C=i.needAlphaTestingForMesh(o),A=i.getAlphaTestTexture(),I=A&&A.hasAlpha&&(i.useAlphaFromDiffuseTexture||i._useAlphaFromAlbedoTexture);if(A&&(C||I)){T.setTexture("diffuseSampler",A);const V=A.getTextureMatrix();V&&T.setMatrix("diffuseMatrix",V)}const F=i.opacityTexture;if(F){T.setTexture("opacitySampler",F),T.setFloat("opacityIntensity",F.level);const V=F.getTextureMatrix();V&&T.setMatrix("opacityMatrix",V)}if(this._emissiveTextureAndColor.texture&&(T.setTexture("emissiveSampler",this._emissiveTextureAndColor.texture),T.setMatrix("emissiveMatrix",this._emissiveTextureAndColor.texture.getTextureMatrix())),a.useBones&&a.computeBonesUsingShaders&&a.skeleton){const V=a.skeleton;if(V.isUsingTextureForMatrices){const D=V.getTransformMatrixTexture(a);if(!D)return;T.setTexture("boneSampler",D),T.setFloat("boneTextureWidth",4*(V.bones.length+1))}else T.setMatrices("mBones",V.getTransformMatrices(a))}Da(a,T),a.morphTargetManager&&a.morphTargetManager.isUsingTextureForTargets&&a.morphTargetManager._bind(T),t&&c.setAlphaMode(i.alphaMode),T.setFloat("glowIntensity",this.getEffectIntensity(a)),jn(T,i,l)}a._processRendering(o,e,T,i.fillMode,f,m,(C,A)=>T.setMatrix("world",A))}else this._objectRenderer.resetRefreshCounter();this.onAfterRenderMeshToEffect.notifyObservers(r)}_useMeshMaterial(e){return!1}_rebuild(){const e=this._vertexBuffers[M.PositionKind];e&&e._rebuild(),this._generateIndexBuffer()}dispose(){const e=this._vertexBuffers[M.PositionKind];e&&(e.dispose(),this._vertexBuffers[M.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);for(const t of this._mergeDrawWrapper)t.dispose();this._mergeDrawWrapper=[],this._objectRenderer.dispose(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderLayerObservable.clear(),this.onBeforeComposeObservable.clear(),this.onBeforeRenderMeshToEffect.clear(),this.onAfterRenderMeshToEffect.clear(),this.onAfterComposeObservable.clear()}}Vn.ForceGLSL=!1;class ya extends Vn{get ldrMerge(){return this._options.ldrMerge}set blurKernelSize(e){if(e===this._options.blurKernelSize)return;this._options.blurKernelSize=e;const t=this._getEffectiveBlurKernelSize();this._horizontalBlurPostprocess1.kernel=t,this._verticalBlurPostprocess1.kernel=t,this._horizontalBlurPostprocess2.kernel=t,this._verticalBlurPostprocess2.kernel=t}get blurKernelSize(){return this._options.blurKernelSize}set intensity(e){this._intensity=e}get intensity(){return this._intensity}constructor(e,t,i,r=!1){super(e,t,!1,r),this._intensity=1,this._includedOnlyMeshes=[],this._excludedMeshes=[],this._meshesUsingTheirOwnMaterials=[],this._renderPassId=0,this.neutralColor=new Te(0,0,0,1),this._options={mainTextureRatio:.5,mainTextureFixedSize:0,mainTextureType:0,blurKernelSize:32,camera:null,renderingGroupId:-1,ldrMerge:!1,alphaBlendingMode:1,...i},this._init(this._options),r&&this._createTextureAndPostProcesses()}getClassName(){return"GlowLayer"}async _importShadersAsync(){this._shaderLanguage===1?await Promise.all([U(()=>Promise.resolve().then(()=>iA),void 0),U(()=>Promise.resolve().then(()=>sA),void 0),U(()=>Promise.resolve().then(()=>Eh),void 0)]):await Promise.all([U(()=>Promise.resolve().then(()=>QR),void 0),U(()=>Promise.resolve().then(()=>JR),void 0),U(()=>Promise.resolve().then(()=>xh),void 0)]),await super._importShadersAsync()}getEffectName(){return ya.EffectName}_createMergeEffect(){let e=`#define EMISSIVE 
`;return this._options.ldrMerge&&(e+=`#define LDR 
`),this._engine.createEffect("glowMapMerge",[M.PositionKind],["offset"],["textureSampler","textureSampler2"],e,void 0,void 0,void 0,void 0,this.shaderLanguage,this._shadersLoaded?void 0:async()=>{await this._importShadersAsync(),this._shadersLoaded=!0})}_createTextureAndPostProcesses(){const e=this._getEffectiveBlurKernelSize();this._horizontalBlurPostprocess1=new hs("GlowLayerHBP1",this._scene.getEngine(),new X(1,0),e),this._verticalBlurPostprocess1=new hs("GlowLayerVBP1",this._scene.getEngine(),new X(0,1),e),this._horizontalBlurPostprocess2=new hs("GlowLayerHBP2",this._scene.getEngine(),new X(1,0),e),this._verticalBlurPostprocess2=new hs("GlowLayerVBP2",this._scene.getEngine(),new X(0,1),e),this._postProcesses=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1,this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2]}_getEffectiveBlurKernelSize(){return this._options.blurKernelSize/2}isReady(e,t){const i=e.getMaterial(),r=e.getRenderingMesh();if(!i||!r)return!1;const n=i.emissiveTexture;return super._isSubMeshReady(e,t,n)}_canRenderMesh(e,t){return!0}_internalCompose(e){this.bindTexturesForCompose(e),e.setFloat("offset",this._intensity);const t=this._engine,i=t.getStencilBuffer();t.setStencilBuffer(!1),t.drawElementsType(Le.TriangleFillMode,0,6),t.setStencilBuffer(i)}_setEmissiveTextureAndColor(e,t,i){let r=1;if(this.customEmissiveTextureSelector?this._emissiveTextureAndColor.texture=this.customEmissiveTextureSelector(e,t,i):i?(this._emissiveTextureAndColor.texture=i.emissiveTexture,this._emissiveTextureAndColor.texture&&(r=this._emissiveTextureAndColor.texture.level)):this._emissiveTextureAndColor.texture=null,this.customEmissiveColorSelector)this.customEmissiveColorSelector(e,t,i,this._emissiveTextureAndColor.color);else if(i.emissiveColor){const n=i.emissiveIntensity??1;r*=n,this._emissiveTextureAndColor.color.set(i.emissiveColor.r*r,i.emissiveColor.g*r,i.emissiveColor.b*r,i.alpha)}else this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a)}_shouldRenderMesh(e){return this.hasMesh(e)}_addCustomEffectDefines(e){e.push("#define GLOW")}addExcludedMesh(e){this._excludedMeshes.indexOf(e.uniqueId)===-1&&this._excludedMeshes.push(e.uniqueId)}removeExcludedMesh(e){const t=this._excludedMeshes.indexOf(e.uniqueId);t!==-1&&this._excludedMeshes.splice(t,1)}addIncludedOnlyMesh(e){this._includedOnlyMeshes.indexOf(e.uniqueId)===-1&&this._includedOnlyMeshes.push(e.uniqueId)}removeIncludedOnlyMesh(e){const t=this._includedOnlyMeshes.indexOf(e.uniqueId);t!==-1&&this._includedOnlyMeshes.splice(t,1)}hasMesh(e){return super.hasMesh(e)?this._includedOnlyMeshes.length?this._includedOnlyMeshes.indexOf(e.uniqueId)!==-1:this._excludedMeshes.length?this._excludedMeshes.indexOf(e.uniqueId)===-1:!0:!1}_useMeshMaterial(e){var t;return(t=e.material)!=null&&t._supportGlowLayer?!0:this._meshesUsingTheirOwnMaterials.length==0?!1:this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId)>-1}referenceMeshToUseItsOwnMaterial(e){e.resetDrawCache(this._renderPassId),this._meshesUsingTheirOwnMaterials.push(e.uniqueId),e.onDisposeObservable.add(()=>{this._disposeMesh(e)})}unReferenceMeshFromUsingItsOwnMaterial(e,t){let i=this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId);for(;i>=0;)this._meshesUsingTheirOwnMaterials.splice(i,1),i=this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId);e.resetDrawCache(t)}_disposeMesh(e){this.removeIncludedOnlyMesh(e),this.removeExcludedMesh(e)}}ya.EffectName="GlowLayer";ya.DefaultBlurKernelSize=32;class Ro extends Bt{constructor(e,t,i){super(e,t,i||new hs(e,t.engine,new X(1,0),10))}record(e=!1,t,i){const r=super.record(e,t,i);return this.postProcess.textureWidth=this._outputWidth,this.postProcess.textureHeight=this._outputHeight,r}}class bv extends Bt{constructor(e,t,i){super(e,t,i||new ms(e,t.engine,new X(1,0),1))}record(e=!1,t,i){const r=super.record(e,t,i);return this.postProcess.textureWidth=this._outputWidth,this.postProcess.textureHeight=this._outputHeight,r}}class IR extends Br{get name(){return this._name}set name(e){if(this._name=e,this._blurX)for(let t=0;t<this._blurX.length;t++)this._blurX[t].name=`${e} Blur X${t}`,this._blurY[t].name=`${e} Blur Y${t}`;this._clearLayerTextures&&(this._clearLayerTextures.name=e+" Clear Layer"),this._objectRendererForLayer&&(this._objectRendererForLayer.name=e+" Render to Layer")}get objectRendererForLayer(){return this._objectRendererForLayer}constructor(e,t,i,r,n,a=!1,o=!1,l=!1){super(e,t),this._setRenderTargetDepth=o,this._notifyBlurObservable=l,this._blurX=[],this._blurY=[],this._onBeforeBlurTask=null,this._onAfterBlurTask=null,this._onBeforeObservableObserver=null,this._onAfterObservableObserver=null,this._onAfterRenderingGroupObserver=null,this._scene=i,this._engine=i.getEngine(),this.layer=r;for(let c=0;c<n;c++)a?(this._blurX.push(new bv(`${e} Blur X${c}`,this._frameGraph,this.layer._postProcesses[1+c*2+0])),this._blurY.push(new bv(`${e} Blur Y${c}`,this._frameGraph,this.layer._postProcesses[1+c*2+1]))):(this._blurX.push(new Ro(`${e} Blur X${c}`,this._frameGraph,this.layer._postProcesses[c*2+0])),this._blurY.push(new Ro(`${e} Blur Y${c}`,this._frameGraph,this.layer._postProcesses[c*2+1])));this._clearLayerTextures=new bR(e+" Clear Layer",t),this._clearLayerTextures.clearColor=!0,this._clearLayerTextures.clearDepth=!0,this._objectRendererForLayer=new xu(e+" Render to Layer",t,i,void 0,this.layer.objectRenderer),this._notifyBlurObservable&&(this._onBeforeBlurTask=new Td(e+" On Before Blur",t),this._onAfterBlurTask=new Td(e+" On After Blur",t),this._onBeforeBlurTask.func=()=>{this.layer.onBeforeBlurObservable.hasObservers()&&this.layer.onBeforeBlurObservable.notifyObservers(this.layer)},this._onAfterBlurTask.func=()=>{this.layer.onAfterBlurObservable.hasObservers()&&this.layer.onAfterBlurObservable.notifyObservers(this.layer)}),this.outputTexture=this._frameGraph.textureManager.createDanglingHandle()}isReady(){return this._objectRendererForLayer.isReady()&&this.layer.isLayerReady()}record(){var g,v;if(this.targetTexture===void 0||this.objectRendererTask===void 0)throw new Error(`${this.constructor.name} "${this.name}": targetTexture and objectRendererTask are required`);this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture);let e,t,i;if(this.layerTexture)i=this.layerTexture,t=this._frameGraph.textureManager.getTextureCreationOptions(this.layerTexture),e=qc(t.size),t.size=e;else{const E=this._frameGraph.textureManager.getTextureCreationOptions(this.targetTexture),T=this.layer._options.mainTextureFixedSize?Math.max(2,this.layer._options.mainTextureFixedSize):0;e=qc(E.size),e.width=T||Math.floor(e.width*(this.layer._options.mainTextureRatio||.1))||1,e.height=T||Math.floor(e.height*(this.layer._options.mainTextureRatio||.1))||1,t={size:e,options:{createMipMaps:!1,types:[this.layer._options.mainTextureType],formats:[5],samples:1,useSRGBBuffers:[!1],creationFlags:[0]},sizeIsPercentage:this.layer._options.mainTextureFixedSize?!1:E.sizeIsPercentage},i=this._frameGraph.textureManager.createRenderTargetTexture(`${this.name} Color`,t)}const r={size:e,options:os.CloneTextureOptions(t.options),sizeIsPercentage:t.sizeIsPercentage};r.options.formats[0]=14;const n=this._frameGraph.textureManager.createRenderTargetTexture(`${this.name} Depth`,r);this._clearLayerTextures.targetTexture=i,this._clearLayerTextures.depthTexture=n,this._clearLayerTextures.color=this.layer.neutralColor,this._clearLayerTextures.clearDepth=!0;const a=this._clearLayerTextures.record();this._objectRendererForLayer.targetTexture=this._clearLayerTextures.outputTexture,this._objectRendererForLayer.depthTexture=this._clearLayerTextures.outputDepthTexture,this._objectRendererForLayer.camera=this.objectRendererTask.camera,this._objectRendererForLayer.objectList=this.objectRendererTask.objectList,this._objectRendererForLayer.disableShadows=!0;const o=this._objectRendererForLayer.record();let l=0;this._engine.getCaps().textureHalfFloatRender?l=2:l=0,t.options.types[0]=l;const c=this.layer._options.blurTextureSizeRatio!==void 0?this.layer._options.blurTextureSizeRatio||.1:void 0;c!==void 0&&(e.width=Math.floor(e.width*c)||1,e.height=Math.floor(e.height*c)||1);const u=(g=this._onBeforeBlurTask)==null?void 0:g.record(),h=[];for(let E=0;E<this._blurX.length;E++){const T=this._frameGraph.textureManager.createRenderTargetTexture(this._blurX[E].name,t);this._blurX[E].sourceTexture=E===0?this._objectRendererForLayer.outputTexture:this._blurY[E-1].outputTexture,this._blurX[E].sourceSamplingMode=2,this._blurX[E].targetTexture=T,h.push(this._blurX[E].record(!0));const C=this._frameGraph.textureManager.createRenderTargetTexture(this._blurY[E].name,t);this._blurY[E].sourceTexture=this._blurX[E].outputTexture,this._blurY[E].sourceSamplingMode=2,this._blurY[E].targetTexture=C,h.push(this._blurY[E].record(!0)),e.width=e.width>>1,e.height=e.height>>1}const d=(v=this._onAfterBlurTask)==null?void 0:v.record();this.objectRendererTask.objectRenderer.onBeforeRenderObservable.remove(this._onBeforeObservableObserver),this._onBeforeObservableObserver=this.objectRendererTask.objectRenderer.onBeforeRenderObservable.add(()=>{const E=this.layer.shouldRender();a.disabled=!E,o.disabled=!E,u&&(u.disabled=!E);for(let T=0;T<h.length;T++)h[T].disabled=!E;d&&(d.disabled=!E),E&&this.layer.needStencil()&&(this._engine.setStencilBuffer(!0),this._engine.setStencilFunctionReference(1))}),this.objectRendererTask.objectRenderer.onAfterRenderObservable.remove(this._onAfterObservableObserver),this._onAfterObservableObserver=this.objectRendererTask.objectRenderer.onAfterRenderObservable.add(()=>{this.layer.shouldRender()&&this.layer.needStencil()&&this._engine.setStencilBuffer(!1)}),this.layer.bindTexturesForCompose=void 0,this._clearAfterRenderingGroupObserver();const f=this._frameGraph.addRenderPass(this.name);for(let E=0;E<this._blurY.length;E++)f.addDependencies(this._blurY[E].outputTexture);f.setRenderTarget(this.outputTexture),this._setRenderTargetDepth&&f.setRenderTargetDepth(this.objectRendererTask.depthTexture),f.setExecuteFunc(E=>{E.setTextureSamplingMode(this._blurY[this._blurY.length-1].targetTexture,2),this.layer.bindTexturesForCompose||(this.layer.bindTexturesForCompose=T=>{for(let C=0;C<this._blurY.length;C++)E.bindTextureHandle(T,`textureSampler${C>0?C+1:""}`,this._blurY[C].outputTexture)}),this.layer._options.renderingGroupId!==-1?this._onAfterRenderingGroupObserver||(this._onAfterRenderingGroupObserver=this._scene.onAfterRenderingGroupObservable.add(T=>{!this.layer.shouldRender()||T.renderingGroupId!==this.layer._options.renderingGroupId||T.renderingManager!==this.objectRendererTask.objectRenderer.renderingManager||(this._objectRendererForLayer.objectList=this.objectRendererTask.objectList,E.saveDepthStates(),E.setDepthStates(!1,!1),E._applyRenderTarget(),this.layer.compose(),E.restoreDepthStates())})):(this._clearAfterRenderingGroupObserver(),this.layer.shouldRender()&&(this._objectRendererForLayer.objectList=this.objectRendererTask.objectList,E.setDepthStates(!1,!1),E._applyRenderTarget(),this.layer.compose()))});const m=this._frameGraph.addRenderPass(this.name+"_disabled",!0);m.setRenderTarget(this.outputTexture),this._setRenderTargetDepth&&m.setRenderTargetDepth(this.objectRendererTask.depthTexture),m.setExecuteFunc(E=>{})}_clearAfterRenderingGroupObserver(){this._scene.onAfterRenderingGroupObservable.remove(this._onAfterRenderingGroupObserver),this._onAfterRenderingGroupObserver=null}dispose(){var e,t;this._clearAfterRenderingGroupObserver(),this._clearLayerTextures.dispose(),this._objectRendererForLayer.dispose(),(e=this._onBeforeBlurTask)==null||e.dispose(),(t=this._onAfterBlurTask)==null||t.dispose(),this.layer.dispose();for(let i=0;i<this._blurX.length;i++)this._blurX[i].dispose(),this._blurY[i].dispose();super.dispose()}}class Cv extends IR{constructor(e,t,i,r){super(e,t,i,new ya(e,i,r,!0),2),this.layer._renderPassId=this._objectRendererForLayer.objectRenderer.renderPassId}}class Va extends Di{get task(){return this._frameGraphTask}constructor(e,t,i,r=!1,n=.5,a,o=0){super(e,t,i),this._additionalConstructionParameters=[r,n,a,o],this.registerInput("target",H.AutoDetect),this.registerInput("layer",H.AutoDetect,!0),this.registerInput("objectRenderer",H.Object,!0,new ac("objectRenderer",this,0,Mi,"NodeRenderGraphBaseObjectRendererBlock")),this._addDependenciesInput(),this.registerOutput("output",H.BasedOnInput),this.target.addExcludedConnectionPointFromAllowedTypes(H.TextureAllButBackBufferDepthStencil),this.layer.addExcludedConnectionPointFromAllowedTypes(H.TextureAllButBackBuffer),this.output._typeConnectionSource=this.target,this._frameGraphTask=new Cv(this.name,this._frameGraph,this._scene,{ldrMerge:r,mainTextureRatio:n,mainTextureFixedSize:a,mainTextureType:o})}_createTask(e,t,i,r){var o;const n=this.blurKernelSize,a=this.intensity;(o=this._frameGraphTask)==null||o.dispose(),this._frameGraphTask=new Cv(this.name,this._frameGraph,this._scene,{ldrMerge:e,mainTextureRatio:t,mainTextureFixedSize:i,mainTextureType:r}),this.blurKernelSize=n,this.intensity=a,this._additionalConstructionParameters=[e,t,i,r]}get ldrMerge(){return this._frameGraphTask.layer.ldrMerge}set ldrMerge(e){const t=this._frameGraphTask.layer._options;this._createTask(e,t.mainTextureRatio,t.mainTextureFixedSize,t.mainTextureType)}get layerTextureRatio(){return this._frameGraphTask.layer._options.mainTextureRatio}set layerTextureRatio(e){const t=this._frameGraphTask.layer._options;this._createTask(t.ldrMerge,e,t.mainTextureFixedSize,t.mainTextureType)}get layerTextureFixedSize(){return this._frameGraphTask.layer._options.mainTextureFixedSize}set layerTextureFixedSize(e){const t=this._frameGraphTask.layer._options;this._createTask(t.ldrMerge,t.mainTextureRatio,e,t.mainTextureType)}get layerTextureType(){return this._frameGraphTask.layer._options.mainTextureType}set layerTextureType(e){const t=this._frameGraphTask.layer._options;this._createTask(t.ldrMerge,t.mainTextureRatio,t.mainTextureFixedSize,e)}get blurKernelSize(){return this._frameGraphTask.layer.blurKernelSize}set blurKernelSize(e){this._frameGraphTask.layer.blurKernelSize=e}get intensity(){return this._frameGraphTask.layer.intensity}set intensity(e){this._frameGraphTask.layer.intensity=e}getClassName(){return"NodeRenderGraphGlowLayerBlock"}get target(){return this._inputs[0]}get layer(){return this._inputs[1]}get objectRenderer(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){var t,i,r;super._buildBlock(e),this.output.value=this._frameGraphTask.outputTexture,this._frameGraphTask.targetTexture=(t=this.target.connectedPoint)==null?void 0:t.value,this._frameGraphTask.layerTexture=(i=this.layer.connectedPoint)==null?void 0:i.value,this._frameGraphTask.objectRendererTask=(r=this.objectRenderer.connectedPoint)==null?void 0:r.value}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.blurKernelSize = ${this.blurKernelSize};`),e.push(`${this._codeVariableName}.intensity = ${this.intensity};`),super._dumpPropertiesCode()+e.join(`
`)}serialize(){const e=super.serialize();return e.blurKernelSize=this.blurKernelSize,e.intensity=this.intensity,e}_deserialize(e){super._deserialize(e),this.blurKernelSize=e.blurKernelSize,this.intensity=e.intensity}}_([O("LDR merge",0,"PROPERTIES")],Va.prototype,"ldrMerge",null);_([O("Layer texture ratio",1,"PROPERTIES")],Va.prototype,"layerTextureRatio",null);_([O("Layer texture fixed size",1,"PROPERTIES")],Va.prototype,"layerTextureFixedSize",null);_([O("Layer texture type",9,"PROPERTIES")],Va.prototype,"layerTextureType",null);_([O("Blur kernel size",2,"PROPERTIES",{min:1,max:256})],Va.prototype,"blurKernelSize",null);_([O("Intensity",1,"PROPERTIES",{min:0,max:5})],Va.prototype,"intensity",null);y("BABYLON.NodeRenderGraphGlowLayerBlock",Va);class Nr extends Vn{set blurHorizontalSize(e){this._horizontalBlurPostprocess.kernel=e,this._options.blurHorizontalSize=e}set blurVerticalSize(e){this._verticalBlurPostprocess.kernel=e,this._options.blurVerticalSize=e}get blurHorizontalSize(){return this._horizontalBlurPostprocess.kernel}get blurVerticalSize(){return this._verticalBlurPostprocess.kernel}constructor(e,t,i,r=!1){super(e,t,i!==void 0?!!i.forceGLSL:!1),this.innerGlow=!0,this.outerGlow=!0,this._instanceGlowingMeshStencilReference=Nr.GlowingMeshStencilReference++,this._meshes={},this._excludedMeshes={},this._mainObjectRendererRenderPassId=-1,this.neutralColor=Nr.NeutralColor,this._options={mainTextureRatio:.5,blurTextureSizeRatio:.5,mainTextureFixedSize:0,blurHorizontalSize:1,blurVerticalSize:1,alphaBlendingMode:2,camera:null,renderingGroupId:-1,forceGLSL:!1,mainTextureType:0,isStroke:!1,...i},this._init(this._options),this._shouldRender=!1,r&&this._createTextureAndPostProcesses()}getClassName(){return"HighlightLayer"}async _importShadersAsync(){this._shaderLanguage===1?await Promise.all([U(()=>Promise.resolve().then(()=>iA),void 0),U(()=>Promise.resolve().then(()=>sA),void 0),U(()=>Promise.resolve().then(()=>Eh),void 0)]):await Promise.all([U(()=>Promise.resolve().then(()=>QR),void 0),U(()=>Promise.resolve().then(()=>JR),void 0),U(()=>Promise.resolve().then(()=>xh),void 0)]),await super._importShadersAsync()}getEffectName(){return Nr.EffectName}_numInternalDraws(){return 2}_createMergeEffect(){return this._engine.createEffect("glowMapMerge",[M.PositionKind],["offset"],["textureSampler"],this._options.isStroke?`#define STROKE 
`:void 0,void 0,void 0,void 0,void 0,this._shaderLanguage,this._shadersLoaded?void 0:async()=>{await this._importShadersAsync(),this._shadersLoaded=!0})}_createTextureAndPostProcesses(){this._options.alphaBlendingMode===2?(this._downSamplePostprocess=new Km("HighlightLayerPPP",this._scene.getEngine()),this._horizontalBlurPostprocess=new ms("HighlightLayerHBP",this._scene.getEngine(),new X(1,0),this._options.blurHorizontalSize),this._verticalBlurPostprocess=new ms("HighlightLayerVBP",this._scene.getEngine(),new X(0,1),this._options.blurVerticalSize),this._postProcesses=[this._downSamplePostprocess,this._horizontalBlurPostprocess,this._verticalBlurPostprocess]):(this._horizontalBlurPostprocess=new hs("HighlightLayerHBP",this._scene.getEngine(),new X(1,0),this._options.blurHorizontalSize/2),this._verticalBlurPostprocess=new hs("HighlightLayerVBP",this._scene.getEngine(),new X(0,1),this._options.blurVerticalSize/2),this._postProcesses=[this._horizontalBlurPostprocess,this._verticalBlurPostprocess])}needStencil(){return!0}isReady(e,t){const i=e.getMaterial(),r=e.getRenderingMesh();if(!i||!r||!this._meshes)return!1;let n=null;const a=this._meshes[r.uniqueId];return a&&a.glowEmissiveOnly&&i&&(n=i.emissiveTexture),super._isSubMeshReady(e,t,n)}_canRenderMesh(e,t){return!0}_internalCompose(e,t){this.bindTexturesForCompose(e);const i=this._engine;i.cacheStencilState(),i.setStencilOperationPass(7681),i.setStencilOperationFail(7680),i.setStencilOperationDepthFail(7680),i.setStencilMask(0),i.setStencilBuffer(!0),i.setStencilFunctionReference(this._instanceGlowingMeshStencilReference),this.outerGlow&&t===0&&(e.setFloat("offset",0),i.setStencilFunction(517),i.drawElementsType(Le.TriangleFillMode,0,6)),this.innerGlow&&t===1&&(e.setFloat("offset",1),i.setStencilFunction(514),i.drawElementsType(Le.TriangleFillMode,0,6)),i.restoreStencilState()}_setEmissiveTextureAndColor(e,t,i){const r=this._meshes[e.uniqueId];r?this._emissiveTextureAndColor.color.set(r.color.r,r.color.g,r.color.b,1):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a),r&&r.glowEmissiveOnly&&i?(this._emissiveTextureAndColor.texture=i.emissiveTexture,this._emissiveTextureAndColor.color.set(1,1,1,1)):this._emissiveTextureAndColor.texture=null}shouldRender(){return!!(this._meshes&&super.shouldRender())}_shouldRenderMesh(e){return this._excludedMeshes&&this._excludedMeshes[e.uniqueId]?!1:super.hasMesh(e)}_addCustomEffectDefines(e){e.push("#define HIGHLIGHT")}addExcludedMesh(e){if(!this._excludedMeshes)return;if(!this._excludedMeshes[e.uniqueId]){const i={mesh:e,beforeBind:null,afterRender:null,stencilState:!1};i.beforeBind=e.onBeforeBindObservable.add(r=>{this._mainObjectRendererRenderPassId!==-1&&this._mainObjectRendererRenderPassId!==this._engine.currentRenderPassId||(i.stencilState=r.getEngine().getStencilBuffer(),r.getEngine().setStencilBuffer(!1))}),i.afterRender=e.onAfterRenderObservable.add(r=>{this._mainObjectRendererRenderPassId!==-1&&this._mainObjectRendererRenderPassId!==this._engine.currentRenderPassId||r.getEngine().setStencilBuffer(i.stencilState)}),this._excludedMeshes[e.uniqueId]=i}}removeExcludedMesh(e){if(!this._excludedMeshes)return;const t=this._excludedMeshes[e.uniqueId];t&&(t.beforeBind&&e.onBeforeBindObservable.remove(t.beforeBind),t.afterRender&&e.onAfterRenderObservable.remove(t.afterRender)),this._excludedMeshes[e.uniqueId]=null}hasMesh(e){return!this._meshes||!super.hasMesh(e)?!1:!!this._meshes[e.uniqueId]}addMesh(e,t,i=!1){if(!this._meshes)return;const r=this._meshes[e.uniqueId];r?r.color=t:(this._meshes[e.uniqueId]={mesh:e,color:t,observerHighlight:e.onBeforeBindObservable.add(n=>{this._mainObjectRendererRenderPassId!==-1&&this._mainObjectRendererRenderPassId!==this._engine.currentRenderPassId||this.isEnabled&&(this._excludedMeshes&&this._excludedMeshes[n.uniqueId]?this._defaultStencilReference(n):n.getScene().getEngine().setStencilFunctionReference(this._instanceGlowingMeshStencilReference))}),observerDefault:e.onAfterRenderObservable.add(n=>{this._mainObjectRendererRenderPassId!==-1&&this._mainObjectRendererRenderPassId!==this._engine.currentRenderPassId||this.isEnabled&&this._defaultStencilReference(n)}),glowEmissiveOnly:i},e.onDisposeObservable.add(()=>{this._disposeMesh(e)})),this._shouldRender=!0}removeMesh(e){if(!this._meshes)return;const t=this._meshes[e.uniqueId];t&&(t.observerHighlight&&e.onBeforeBindObservable.remove(t.observerHighlight),t.observerDefault&&e.onAfterRenderObservable.remove(t.observerDefault),delete this._meshes[e.uniqueId]),this._shouldRender=!1;for(const i in this._meshes)if(this._meshes[i]){this._shouldRender=!0;break}}removeAllMeshes(){if(this._meshes){for(const e in this._meshes)if(Object.prototype.hasOwnProperty.call(this._meshes,e)){const t=this._meshes[e];t&&this.removeMesh(t.mesh)}}}_defaultStencilReference(e){e.getScene().getEngine().setStencilFunctionReference(Nr.NormalMeshStencilReference)}_disposeMesh(e){this.removeMesh(e),this.removeExcludedMesh(e)}dispose(){if(this._meshes){for(const e in this._meshes){const t=this._meshes[e];t&&t.mesh&&(t.observerHighlight&&t.mesh.onBeforeBindObservable.remove(t.observerHighlight),t.observerDefault&&t.mesh.onAfterRenderObservable.remove(t.observerDefault))}this._meshes=null}if(this._excludedMeshes){for(const e in this._excludedMeshes){const t=this._excludedMeshes[e];t&&(t.beforeBind&&t.mesh.onBeforeBindObservable.remove(t.beforeBind),t.afterRender&&t.mesh.onAfterRenderObservable.remove(t.afterRender))}this._excludedMeshes=null}super.dispose()}}Nr.EffectName="HighlightLayer";Nr.NeutralColor=new Te(0,0,0,0);Nr.GlowingMeshStencilReference=2;Nr.NormalMeshStencilReference=1;class yv extends IR{constructor(e,t,i,r){const n=(r==null?void 0:r.alphaBlendingMode)??2;super(e,t,i,new Nr(e,i,r,!0),1,n===2,!0,!0)}record(){if(!this.objectRendererTask.depthTexture)throw new Error(`FrameGraphHighlightLayerTask "${this.name}": objectRendererTask must have a depthTexture input`);const e=this._frameGraph.textureManager.getTextureCreationOptions(this.objectRendererTask.depthTexture);if(!e.options.formats||!wm(e.options.formats[0]))throw new Error(`FrameGraphHighlightLayerTask "${this.name}": objectRendererTask depthTexture must have a stencil aspect`);super.record(),this.layer._mainObjectRendererRenderPassId=this.objectRendererTask.objectRenderer.renderPassId}}class Qn extends Di{get task(){return this._frameGraphTask}constructor(e,t,i,r=.5,n,a=.5,o=!1,l=0){super(e,t,i),this._additionalConstructionParameters=[r,n,a,o,l],this.registerInput("target",H.AutoDetect),this.registerInput("layer",H.AutoDetect,!0),this.registerInput("objectRenderer",H.Object,!0,new ac("objectRenderer",this,0,Mi,"NodeRenderGraphBaseObjectRendererBlock")),this._addDependenciesInput(),this.registerOutput("output",H.BasedOnInput),this.target.addExcludedConnectionPointFromAllowedTypes(H.TextureAllButBackBufferDepthStencil),this.layer.addExcludedConnectionPointFromAllowedTypes(H.TextureAllButBackBuffer),this.output._typeConnectionSource=this.target,this._frameGraphTask=new yv(this.name,this._frameGraph,this._scene,{mainTextureRatio:r,mainTextureFixedSize:n,blurTextureSizeRatio:a,isStroke:o,mainTextureType:l})}_createTask(e,t,i,r,n){var l;const a=this.blurHorizontalSize,o=this.blurVerticalSize;(l=this._frameGraphTask)==null||l.dispose(),this._frameGraphTask=new yv(this.name,this._frameGraph,this._scene,{mainTextureRatio:e,mainTextureFixedSize:t,blurTextureSizeRatio:i,isStroke:r,mainTextureType:n}),this.blurHorizontalSize=a,this.blurVerticalSize=o,this._additionalConstructionParameters=[e,t,i,r,n]}get layerTextureRatio(){return this._frameGraphTask.layer._options.mainTextureRatio}set layerTextureRatio(e){const t=this._frameGraphTask.layer._options;this._createTask(e,t.mainTextureFixedSize,t.blurTextureSizeRatio,t.isStroke,t.mainTextureType)}get layerTextureFixedSize(){return this._frameGraphTask.layer._options.mainTextureFixedSize}set layerTextureFixedSize(e){const t=this._frameGraphTask.layer._options;this._createTask(t.mainTextureRatio,e,t.blurTextureSizeRatio,t.isStroke,t.mainTextureType)}get blurTextureSizeRatio(){return this._frameGraphTask.layer._options.blurTextureSizeRatio}set blurTextureSizeRatio(e){const t=this._frameGraphTask.layer._options;this._createTask(t.mainTextureRatio,t.mainTextureFixedSize,e,t.isStroke,t.mainTextureType)}get isStroke(){return this._frameGraphTask.layer._options.isStroke}set isStroke(e){const t=this._frameGraphTask.layer._options;this._createTask(t.mainTextureRatio,t.mainTextureFixedSize,t.blurTextureSizeRatio,e,t.mainTextureType)}get layerTextureType(){return this._frameGraphTask.layer._options.mainTextureType}set layerTextureType(e){const t=this._frameGraphTask.layer._options;this._createTask(t.mainTextureRatio,t.mainTextureFixedSize,t.blurTextureSizeRatio,t.isStroke,e)}get blurHorizontalSize(){return this._frameGraphTask.layer.blurHorizontalSize}set blurHorizontalSize(e){this._frameGraphTask.layer.blurHorizontalSize=e}get blurVerticalSize(){return this._frameGraphTask.layer.blurVerticalSize}set blurVerticalSize(e){this._frameGraphTask.layer.blurVerticalSize=e}getClassName(){return"NodeRenderGraphHighlightLayerBlock"}get target(){return this._inputs[0]}get layer(){return this._inputs[1]}get objectRenderer(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){var t,i,r;super._buildBlock(e),this.output.value=this._frameGraphTask.outputTexture,this._frameGraphTask.targetTexture=(t=this.target.connectedPoint)==null?void 0:t.value,this._frameGraphTask.layerTexture=(i=this.layer.connectedPoint)==null?void 0:i.value,this._frameGraphTask.objectRendererTask=(r=this.objectRenderer.connectedPoint)==null?void 0:r.value}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.blurHorizontalSize = ${this.blurHorizontalSize};`),e.push(`${this._codeVariableName}.blurVerticalSize = ${this.blurVerticalSize};`),super._dumpPropertiesCode()+e.join(`
`)}serialize(){const e=super.serialize();return e.blurHorizontalSize=this.blurHorizontalSize,e.blurVerticalSize=this.blurVerticalSize,e}_deserialize(e){super._deserialize(e),this.blurHorizontalSize=e.blurHorizontalSize,this.blurVerticalSize=e.blurVerticalSize}}_([O("Layer texture ratio",1,"PROPERTIES")],Qn.prototype,"layerTextureRatio",null);_([O("Layer texture fixed size",1,"PROPERTIES")],Qn.prototype,"layerTextureFixedSize",null);_([O("Blur texture size ratio",1,"PROPERTIES")],Qn.prototype,"blurTextureSizeRatio",null);_([O("Is stroke",0,"PROPERTIES")],Qn.prototype,"isStroke",null);_([O("Layer texture type",9,"PROPERTIES")],Qn.prototype,"layerTextureType",null);_([O("Blur horizontal size",1,"PROPERTIES",{min:0,max:4})],Qn.prototype,"blurHorizontalSize",null);_([O("Blur vertical size",1,"PROPERTIES",{min:0,max:4})],Qn.prototype,"blurVerticalSize",null);y("BABYLON.NodeRenderGraphHighlightLayerBlock",Qn);class W1 extends Bt{constructor(e,t,i){super(e,t,i||new Bs(e,t.engine))}record(e=!1){if(this.sourceTexture===void 0||this.leftTexture===void 0)throw new Error(`FrameGraphAnaglyphTask "${this.name}": sourceTexture and leftTexture are required`);const t=super.record(e,void 0,i=>{i.bindTextureHandle(this._postProcessDrawWrapper.effect,"leftSampler",this.leftTexture)});return t.addDependencies(this.leftTexture),t}}class ri extends Di{constructor(e,t,i){super(e,t,i),this.registerInput("source",H.AutoDetect),this.registerInput("target",H.AutoDetect,!0),this.source.addExcludedConnectionPointFromAllowedTypes(H.TextureAllButBackBuffer),this.target.addExcludedConnectionPointFromAllowedTypes(H.TextureAll)}_finalizeInputOutputRegistering(){this._addDependenciesInput(),this.registerOutput("output",H.BasedOnInput),this.output._typeConnectionSource=()=>this.target.isConnected?this.target:this.source}get sourceSamplingMode(){return this._frameGraphTask.sourceSamplingMode}set sourceSamplingMode(e){this._frameGraphTask.sourceSamplingMode=e}getClassName(){return"NodeRenderGraphBasePostProcessBlock"}get source(){return this._inputs[0]}get target(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){var t,i;super._buildBlock(e),this.output.value=this._frameGraphTask.outputTexture,this._frameGraphTask.sourceTexture=(t=this.source.connectedPoint)==null?void 0:t.value,this._frameGraphTask.targetTexture=(i=this.target.connectedPoint)==null?void 0:i.value}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.sourceSamplingMode = ${this.sourceSamplingMode};`),super._dumpPropertiesCode()+e.join(`
`)}serialize(){const e=super.serialize();return e.sourceSamplingMode=this.sourceSamplingMode,e}_deserialize(e){super._deserialize(e),this.sourceSamplingMode=e.sourceSamplingMode}}_([O("Source sampling mode",7,"PROPERTIES")],ri.prototype,"sourceSamplingMode",null);class H1 extends ri{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("leftTexture",H.AutoDetect),this.leftTexture.addExcludedConnectionPointFromAllowedTypes(H.TextureAllButBackBuffer),this._finalizeInputOutputRegistering(),this._frameGraphTask=new W1(this.name,t,new Bs(e,i.getEngine()))}getClassName(){return"NodeRenderGraphAnaglyphPostProcessBlock"}get leftTexture(){return this._inputs[2]}_buildBlock(e){var t;super._buildBlock(e),this._frameGraphTask.leftTexture=(t=this.leftTexture.connectedPoint)==null?void 0:t.value}}y("BABYLON.NodeRenderGraphAnaglyphPostProcessBlock",H1);class Vs extends gt{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(U(()=>Promise.resolve().then(()=>VX),void 0))):t.push(U(()=>Promise.resolve().then(()=>wX),void 0))}constructor(e,t=null,i){super({...i,name:e,engine:t||ft.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Vs.FragmentUrl,uniforms:Vs.Uniforms}),this.degree=1}bind(e=!1){super.bind(e),this._drawWrapper.effect.setFloat("degree",this.degree)}}Vs.FragmentUrl="blackAndWhite";Vs.Uniforms=["degree"];class $1 extends Bt{constructor(e,t,i){super(e,t,i||new Vs(e,t.engine))}}class RR extends ri{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this._finalizeInputOutputRegistering(),this._frameGraphTask=new $1(this.name,t,new Vs(e,i.getEngine()))}get degree(){return this._frameGraphTask.postProcess.degree}set degree(e){this._frameGraphTask.postProcess.degree=e}getClassName(){return"NodeRenderGraphBlackAndWhitePostProcessBlock"}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.degree = ${this.degree};`),super._dumpPropertiesCode()+e.join(`
`)}serialize(){const e=super.serialize();return e.degree=this.degree,e}_deserialize(e){super._deserialize(e),this.degree=e.degree}}_([O("Degree",1,"PROPERTIES",{min:0,max:1})],RR.prototype,"degree",null);y("BABYLON.NodeRenderGraphBlackAndWhitePostProcessBlock",RR);class Dr extends gt{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(U(()=>Promise.resolve().then(()=>TX),void 0))):t.push(U(()=>Promise.resolve().then(()=>xX),void 0))}constructor(e,t=null,i){super({...i,name:e,engine:t||ft.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Dr.FragmentUrl,uniforms:Dr.Uniforms,samplers:Dr.Samplers}),this.weight=1}bind(e=!1){super.bind(e),this._drawWrapper.effect.setFloat("bloomWeight",this.weight)}}Dr.FragmentUrl="bloomMerge";Dr.Uniforms=["bloomWeight"];Dr.Samplers=["bloomBlur"];class X1 extends Bt{constructor(e,t,i){super(e,t,i||new Dr(e,t.engine))}record(e=!1){if(this.sourceTexture===void 0||this.blurTexture===void 0)throw new Error(`FrameGraphBloomMergeTask "${this.name}": sourceTexture and blurTexture are required`);const t=super.record(e,void 0,i=>{i.bindTextureHandle(this._postProcessDrawWrapper.effect,"bloomBlur",this.blurTexture)});return t.addDependencies(this.blurTexture),t}}class _s extends gt{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(U(()=>Promise.resolve().then(()=>IX),void 0))):t.push(U(()=>Promise.resolve().then(()=>CX),void 0))}constructor(e,t=null,i){super({...i,name:e,engine:t||ft.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:_s.FragmentUrl,uniforms:_s.Uniforms}),this.threshold=.9,this._exposure=1}bind(e=!1){super.bind(e);const t=this._drawWrapper.effect;t.setFloat("threshold",Math.pow(this.threshold,Bc)),t.setFloat("exposure",this._exposure)}}_s.FragmentUrl="extractHighlights";_s.Uniforms=["threshold","exposure"];class AR{get threshold(){return this._downscale.threshold}set threshold(e){this._downscale.threshold=e}get weight(){return this._merge.weight}set weight(e){this._merge.weight=e}get kernel(){return this._blurX.kernel/this.scale}set kernel(e){this._blurX.kernel=e*this.scale,this._blurY.kernel=e*this.scale}constructor(e,t,i,r=!1){this.scale=i,this._downscale=new _s(e+"_downscale",t,{blockCompilation:r}),this._blurX=new hs(e+"_blurX",t,new X(1,0),10,{blockCompilation:r}),this._blurY=new hs(e+"_blurY",t,new X(0,1),10,{blockCompilation:r}),this._merge=new Dr(e+"_merge",t,{blockCompilation:r})}isReady(){return this._downscale.isReady()&&this._blurX.isReady()&&this._blurY.isReady()&&this._merge.isReady()}}class PR extends Bt{constructor(e,t,i){super(e,t,i||new _s(e,t.engine))}}class Iv extends Br{get name(){return this._name}set name(e){this._name=e,this._downscale&&(this._downscale.name=`${e} Downscale`),this._blurX&&(this._blurX.name=`${e} Blur X`),this._blurY&&(this._blurY.name=`${e} Blur Y`),this._merge&&(this._merge.name=`${e} Merge`)}constructor(e,t,i,r,n,a=!1,o=.5){if(super(e,t),this.sourceSamplingMode=2,this.hdr=a,this._defaultPipelineTextureType=0,a){const l=t.engine.getCaps();l.textureHalfFloatRender?this._defaultPipelineTextureType=2:l.textureFloatRender&&(this._defaultPipelineTextureType=1)}this.bloom=new AR(e,t.engine,o),this.bloom.threshold=n,this.bloom.kernel=r,this.bloom.weight=i,this._downscale=new PR(`${e} Downscale`,this._frameGraph,this.bloom._downscale),this._blurX=new Ro(`${e} Blur X`,this._frameGraph,this.bloom._blurX),this._blurY=new Ro(`${e} Blur Y`,this._frameGraph,this.bloom._blurY),this._merge=new X1(`${e} Merge`,this._frameGraph,this.bloom._merge),this.outputTexture=this._frameGraph.textureManager.createDanglingHandle()}isReady(){return this.bloom.isReady()}record(){if(this.sourceTexture===void 0)throw new Error("FrameGraphBloomTask: sourceTexture is required");const e=this._frameGraph.textureManager.getTextureDescription(this.sourceTexture),t={size:{width:Math.floor(e.size.width*this.bloom.scale)||1,height:Math.floor(e.size.height*this.bloom.scale)||1},options:{createMipMaps:!1,types:[this._defaultPipelineTextureType],formats:[5],samples:1,useSRGBBuffers:[!1],labels:[""]},sizeIsPercentage:!1},i=this._frameGraph.textureManager.createRenderTargetTexture(this._downscale.name,t);this._downscale.sourceTexture=this.sourceTexture,this._downscale.sourceSamplingMode=2,this._downscale.targetTexture=i,this._downscale.record(!0);const r=this._frameGraph.textureManager.createRenderTargetTexture(this._blurX.name,t);this._blurX.sourceTexture=i,this._blurX.sourceSamplingMode=2,this._blurX.targetTexture=r,this._blurX.record(!0);const n=this._frameGraph.textureManager.createRenderTargetTexture(this._blurY.name,t);this._blurY.sourceTexture=r,this._blurY.sourceSamplingMode=2,this._blurY.targetTexture=n,this._blurY.record(!0);const a=this._frameGraph.textureManager.getTextureCreationOptions(this.sourceTexture);this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture,this._merge.name,a),this._merge.sourceTexture=this.sourceTexture,this._merge.sourceSamplingMode=this.sourceSamplingMode,this._merge.blurTexture=n,this._merge.targetTexture=this.outputTexture,this._merge.record(!0);const o=this._frameGraph.addRenderPass(this.name+"_disabled",!0);o.addDependencies(this.sourceTexture),o.setRenderTarget(this.outputTexture),o.setExecuteFunc(l=>{l.copyTexture(this.sourceTexture)})}dispose(){this._downscale.dispose(),this._blurX.dispose(),this._blurY.dispose(),this._merge.dispose(),super.dispose()}}class Yo extends ri{get task(){return this._frameGraphTask}constructor(e,t,i,r=!1,n=.5){super(e,t,i),this._additionalConstructionParameters=[r,n],this._finalizeInputOutputRegistering(),this._frameGraphTask=new Iv(this.name,t,.75,64,.2,r,n)}_createTask(e,t){const i=this._frameGraphTask.sourceSamplingMode,r=this._frameGraphTask.bloom.threshold,n=this._frameGraphTask.bloom.weight,a=this._frameGraphTask.bloom.kernel;this._frameGraphTask.dispose(),this._frameGraphTask=new Iv(this.name,this._frameGraph,n,a,r,t,e),this._frameGraphTask.sourceSamplingMode=i,this._additionalConstructionParameters=[t,e]}get bloomScale(){return this._frameGraphTask.bloom.scale}set bloomScale(e){this._createTask(e,this._frameGraphTask.hdr)}get hdr(){return this._frameGraphTask.hdr}set hdr(e){this._createTask(this._frameGraphTask.bloom.scale,e)}get threshold(){return this._frameGraphTask.bloom.threshold}set threshold(e){this._frameGraphTask.bloom.threshold=e}get weight(){return this._frameGraphTask.bloom.weight}set weight(e){this._frameGraphTask.bloom.weight=e}get kernel(){return this._frameGraphTask.bloom.kernel}set kernel(e){this._frameGraphTask.bloom.kernel=e}getClassName(){return"NodeRenderGraphBloomPostProcessBlock"}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.threshold = ${this.threshold};`),e.push(`${this._codeVariableName}.weight = ${this.weight};`),e.push(`${this._codeVariableName}.kernel = ${this.kernel};`),super._dumpPropertiesCode()+e.join(`
`)}serialize(){const e=super.serialize();return e.threshold=this.threshold,e.weight=this.weight,e.kernel=this.kernel,e}_deserialize(e){super._deserialize(e),this.threshold=e.threshold,this.weight=e.weight,this.kernel=e.kernel}}_([O("Bloom scale",1,"PROPERTIES")],Yo.prototype,"bloomScale",null);_([O("HDR",0,"PROPERTIES")],Yo.prototype,"hdr",null);_([O("Threshold",1,"PROPERTIES",{min:0,max:2})],Yo.prototype,"threshold",null);_([O("Weight",1,"PROPERTIES",{min:0,max:3})],Yo.prototype,"weight",null);_([O("Kernel",2,"PROPERTIES",{min:1,max:128})],Yo.prototype,"kernel",null);y("BABYLON.NodeRenderGraphBloomPostProcessBlock",Yo);class E_ extends ri{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this._finalizeInputOutputRegistering(),this._frameGraphTask=new Ro(this.name,t,new hs(e,i.getEngine(),new X(1,0),32))}get direction(){return this._frameGraphTask.postProcess.direction}set direction(e){this._frameGraphTask.postProcess.direction=e}get kernel(){return this._frameGraphTask.postProcess.kernel}set kernel(e){this._frameGraphTask.postProcess.kernel=e}getClassName(){return"NodeRenderGraphBlurPostProcessBlock"}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.direction = new BABYLON.Vector2(${this.direction.x}, ${this.direction.y});`),e.push(`${this._codeVariableName}.kernel = ${this.kernel};`),super._dumpPropertiesCode()+e.join(`
`)}serialize(){const e=super.serialize();return e.direction=this.direction.asArray(),e.kernel=this.kernel,e}_deserialize(e){super._deserialize(e),this.direction.fromArray(e.direction),this.kernel=e.kernel}}_([O("Direction",3,"PROPERTIES")],E_.prototype,"direction",null);_([O("Kernel",2,"PROPERTIES",{min:1,max:256})],E_.prototype,"kernel",null);y("BABYLON.NodeRenderGraphBlurPostProcessBlock",E_);class Us extends gt{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(U(()=>Promise.resolve().then(()=>uX),void 0))):t.push(U(()=>Promise.resolve().then(()=>l$),void 0))}constructor(e,t=null,i){super({...i,name:e,engine:t||ft.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Us.FragmentUrl,uniforms:Us.Uniforms}),this.aberrationAmount=30,this.radialIntensity=0,this.direction=new X(.707,.707),this.centerPosition=new X(.5,.5)}bind(e=!1){super.bind(e);const t=this._drawWrapper.effect;t.setFloat("chromatic_aberration",this.aberrationAmount),t.setFloat("screen_width",this.screenWidth),t.setFloat("screen_height",this.screenHeight),t.setFloat("radialIntensity",this.radialIntensity),t.setFloat2("direction",this.direction.x,this.direction.y),t.setFloat2("centerPosition",this.centerPosition.x,this.centerPosition.y)}}Us.FragmentUrl="chromaticAberration";Us.Uniforms=["chromatic_aberration","screen_width","screen_height","direction","radialIntensity","centerPosition"];class Y1 extends Bt{constructor(e,t,i){super(e,t,i||new Us(e,t.engine))}record(e=!1,t,i){const r=super.record(e,t,i);return this.postProcess.screenWidth=this._sourceWidth,this.postProcess.screenHeight=this._sourceHeight,r}}class ph extends ri{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this._finalizeInputOutputRegistering(),this._frameGraphTask=new Y1(this.name,t,new Us(e,i.getEngine()))}get aberrationAmount(){return this._frameGraphTask.postProcess.aberrationAmount}set aberrationAmount(e){this._frameGraphTask.postProcess.aberrationAmount=e}get radialIntensity(){return this._frameGraphTask.postProcess.radialIntensity}set radialIntensity(e){this._frameGraphTask.postProcess.radialIntensity=e}get direction(){return this._frameGraphTask.postProcess.direction}set direction(e){this._frameGraphTask.postProcess.direction=e}getClassName(){return"NodeRenderGraphChromaticAberrationPostProcessBlock"}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.aberrationAmount = ${this.aberrationAmount};`),e.push(`${this._codeVariableName}.radialIntensity = ${this.radialIntensity};`),e.push(`${this._codeVariableName}.direction = new BABYLON.Vector2(${this.direction.x}, ${this.direction.y});`),super._dumpPropertiesCode()+e.join(`
`)}serialize(){const e=super.serialize();return e.aberrationAmount=this.aberrationAmount,e.radialIntensity=this.radialIntensity,e.direction=this.direction.asArray(),e}_deserialize(e){super._deserialize(e),this.aberrationAmount=e.aberrationAmount,this.radialIntensity=e.radialIntensity,this.direction=X.FromArray(e.direction)}}_([O("Amount",1,"PROPERTIES",{min:-1e3,max:1e3})],ph.prototype,"aberrationAmount",null);_([O("Radial intensity",1,"PROPERTIES",{min:.1,max:5})],ph.prototype,"radialIntensity",null);_([O("Direction",3,"PROPERTIES")],ph.prototype,"direction",null);y("BABYLON.NodeRenderGraphChromaticAberrationPostProcessBlock",ph);class Vi extends gt{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(U(()=>Promise.resolve().then(()=>SX),void 0))):t.push(U(()=>Promise.resolve().then(()=>_X),void 0))}constructor(e,t=null,i){super({...i,name:e,engine:t||ft.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Vi.FragmentUrl,uniforms:Vi.Uniforms,samplers:Vi.Samplers,defines:i!=null&&i.depthNotNormalized?Vi.DefinesDepthNotNormalized:void 0}),this.lensSize=50,this.fStop=1.4,this.focusDistance=2e3,this.focalLength=50}bind(e=!1){super.bind(e);const t=this.options,i=this._drawWrapper.effect;t.depthNotNormalized||i.setFloat2("cameraMinMaxZ",this.camera.minZ,this.camera.maxZ-this.camera.minZ);const n=this.lensSize/this.fStop*this.focalLength/(this.focusDistance-this.focalLength);i.setFloat("focusDistance",this.focusDistance),i.setFloat("cocPrecalculation",n)}}Vi.FragmentUrl="circleOfConfusion";Vi.Uniforms=["cameraMinMaxZ","focusDistance","cocPrecalculation"];Vi.Samplers=["depthSampler"];Vi.DefinesDepthNotNormalized="#define COC_DEPTH_NOT_NORMALIZED";class OR extends Bt{constructor(e,t,i){super(e,t,i||new Vi(e,t.engine)),this.depthSamplingMode=2}record(e=!1){if(this.sourceTexture===void 0||this.depthTexture===void 0||this.camera===void 0)throw new Error(`FrameGraphCircleOfConfusionTask "${this.name}": sourceTexture, depthTexture and camera are required`);const t=super.record(e,i=>{this.postProcess.camera=this.camera,i.setTextureSamplingMode(this.depthTexture,this.depthSamplingMode)},i=>{i.bindTextureHandle(this._postProcessDrawWrapper.effect,"depthSampler",this.depthTexture)});return t.addDependencies(this.depthTexture),t}}class jo extends ri{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("geomViewDepth",H.TextureViewDepth),this.registerInput("camera",H.Camera),this._finalizeInputOutputRegistering(),this._frameGraphTask=new OR(this.name,t,new Vi(e,i.getEngine(),{depthNotNormalized:!0}))}get depthSamplingMode(){return this._frameGraphTask.depthSamplingMode}set depthSamplingMode(e){this._frameGraphTask.depthSamplingMode=e}get lensSize(){return this._frameGraphTask.postProcess.lensSize}set lensSize(e){this._frameGraphTask.postProcess.lensSize=e}get fStop(){return this._frameGraphTask.postProcess.fStop}set fStop(e){this._frameGraphTask.postProcess.fStop=e}get focusDistance(){return this._frameGraphTask.postProcess.focusDistance}set focusDistance(e){this._frameGraphTask.postProcess.focusDistance=e}get focalLength(){return this._frameGraphTask.postProcess.focalLength}set focalLength(e){this._frameGraphTask.postProcess.focalLength=e}getClassName(){return"NodeRenderGraphCircleOfConfusionPostProcessBlock"}get geomViewDepth(){return this._inputs[2]}get camera(){return this._inputs[3]}_buildBlock(e){var t,i;super._buildBlock(e),this._frameGraphTask.depthTexture=(t=this.geomViewDepth.connectedPoint)==null?void 0:t.value,this._frameGraphTask.camera=(i=this.camera.connectedPoint)==null?void 0:i.value}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.lensSize = ${this.lensSize};`),e.push(`${this._codeVariableName}.fStop = ${this.fStop};`),e.push(`${this._codeVariableName}.focusDistance = ${this.focusDistance};`),e.push(`${this._codeVariableName}.focalLength = ${this.focalLength};`),e.push(`${this._codeVariableName}.depthSamplingMode = ${this.depthSamplingMode};`),super._dumpPropertiesCode()+e.join(`
`)}serialize(){const e=super.serialize();return e.lensSize=this.lensSize,e.fStop=this.fStop,e.focusDistance=this.focusDistance,e.focalLength=this.focalLength,e.depthSamplingMode=this.depthSamplingMode,e}_deserialize(e){super._deserialize(e),this.lensSize=e.lensSize,this.fStop=e.fStop,this.focusDistance=e.focusDistance,this.focalLength=e.focalLength,this.depthSamplingMode=e.depthSamplingMode}}_([O("Depth sampling mode",7,"PROPERTIES")],jo.prototype,"depthSamplingMode",null);_([O("Lens size",1,"PROPERTIES")],jo.prototype,"lensSize",null);_([O("F-Stop",1,"PROPERTIES")],jo.prototype,"fStop",null);_([O("Focus distance",1,"PROPERTIES")],jo.prototype,"focusDistance",null);_([O("Focal length",1,"PROPERTIES")],jo.prototype,"focalLength",null);y("BABYLON.NodeRenderGraphCircleOfConfusionPostProcessBlock",jo);class gs extends gt{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(U(()=>Promise.resolve().then(()=>ZX),void 0))):t.push(U(()=>Promise.resolve().then(()=>jX),void 0))}constructor(e,t,i,r){super({...r,name:e,engine:t==null?void 0:t.getEngine(),useShaderStore:!0,useAsPostProcess:!0,fragmentShader:gs.FragmentUrl,samplers:gs.Samplers}),this._colorTableTexture=new $(i,t,!0,!1,$.TRILINEAR_SAMPLINGMODE),this._colorTableTexture.anisotropicFilteringLevel=1,this._colorTableTexture.wrapU=$.CLAMP_ADDRESSMODE,this._colorTableTexture.wrapV=$.CLAMP_ADDRESSMODE,this.colorTableUrl=i}bind(e=!1){super.bind(e),this._drawWrapper.effect.setTexture("colorTable",this._colorTableTexture)}}gs.FragmentUrl="colorCorrection";gs.Samplers=["colorTable"];class Rv extends Bt{constructor(e,t,i,r){super(e,t,r||new gs(e,t.scene,i))}}class NR extends ri{get task(){return this._frameGraphTask}constructor(e,t,i,r=""){super(e,t,i),this._additionalConstructionParameters=[r],this._finalizeInputOutputRegistering(),this._frameGraphTask=new Rv(this.name,t,r,new gs(e,t.scene,r))}_createTask(e){const t=this._frameGraphTask.sourceSamplingMode;this._frameGraphTask.dispose(),this._frameGraphTask=new Rv(this.name,this._frameGraph,e,new gs(this.name,this._frameGraph.scene,e)),this._frameGraphTask.sourceSamplingMode=t,this._additionalConstructionParameters=[e]}get colorTableUrl(){return this._frameGraphTask.postProcess.colorTableUrl}set colorTableUrl(e){this._createTask(e)}getClassName(){return"NodeRenderGraphColorCorrectionPostProcessBlock"}}_([O("Color Table URL",10,"PROPERTIES")],NR.prototype,"colorTableUrl",null);y("BABYLON.NodeRenderGraphColorCorrectionPostProcessBlock",NR);class tt extends gt{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(U(()=>Promise.resolve().then(()=>XX),void 0))):t.push(U(()=>Promise.resolve().then(()=>HX),void 0))}constructor(e,t=null,i,r){super({...r,name:e,engine:t||ft.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:tt.FragmentUrl,uniforms:tt.Uniforms}),this.textureWidth=0,this.textureHeight=0,this.kernel=i}bind(e=!1){super.bind(e);const t=this._drawWrapper.effect;t.setFloat2("screenSize",this.textureWidth,this.textureHeight),t.setArray("kernel",this.kernel)}}tt.EdgeDetect0Kernel=[1,0,-1,0,0,0,-1,0,1];tt.EdgeDetect1Kernel=[0,1,0,1,-4,1,0,1,0];tt.EdgeDetect2Kernel=[-1,-1,-1,-1,8,-1,-1,-1,-1];tt.SharpenKernel=[0,-1,0,-1,5,-1,0,-1,0];tt.EmbossKernel=[-2,-1,0,-1,1,1,0,1,2];tt.GaussianKernel=[0,1,0,1,1,1,0,1,0];tt.FragmentUrl="convolution";tt.Uniforms=["kernel","screenSize"];class Av extends Bt{constructor(e,t,i){super(e,t,i||new tt(e,t.engine,tt.EmbossKernel))}record(e=!1,t,i){const r=super.record(e,t,i);return this.postProcess.textureWidth=this._sourceWidth,this.postProcess.textureHeight=this._sourceHeight,r}}class DR extends ri{get task(){return this._frameGraphTask}constructor(e,t,i,r=tt.EmbossKernel){super(e,t,i),this._additionalConstructionParameters=[r],this._finalizeInputOutputRegistering(),this._frameGraphTask=new Av(this.name,t,new tt(e,t.engine,r))}_createTask(e){const t=this._frameGraphTask.sourceSamplingMode;this._frameGraphTask.dispose();let i=tt.EmbossKernel;switch(e){case 0:i=tt.EdgeDetect0Kernel;break;case 1:i=tt.EdgeDetect1Kernel;break;case 2:i=tt.EdgeDetect2Kernel;break;case 3:i=tt.SharpenKernel;break;case 4:i=tt.EmbossKernel;break;case 5:i=tt.GaussianKernel;break}this._frameGraphTask=new Av(this.name,this._frameGraph,new tt(this.name,this._frameGraph.engine,i)),this._frameGraphTask.sourceSamplingMode=t,this._additionalConstructionParameters=[i]}get kernel(){const e=this._frameGraphTask.postProcess.kernel;return e.every((t,i)=>t===tt.EdgeDetect0Kernel[i])?0:e.every((t,i)=>t===tt.EdgeDetect1Kernel[i])?1:e.every((t,i)=>t===tt.EdgeDetect2Kernel[i])?2:e.every((t,i)=>t===tt.SharpenKernel[i])?3:e.every((t,i)=>t===tt.EmbossKernel[i])?4:e.every((t,i)=>t===tt.GaussianKernel[i])?5:0}set kernel(e){this._createTask(e)}getClassName(){return"NodeRenderGraphConvolutionPostProcessBlock"}}_([O("Kernel",5,"PROPERTIES",{options:[{label:"EdgeDetect0",value:0},{label:"EdgeDetect1",value:1},{label:"EdgeDetect2",value:2},{label:"Sharpen",value:3},{label:"Emboss",value:4},{label:"Gaussian",value:5}]})],DR.prototype,"kernel",null);y("BABYLON.NodeRenderGraphConvolutionPostProcessBlock",DR);class ks extends gt{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(U(()=>Promise.resolve().then(()=>pX),void 0))):t.push(U(()=>Promise.resolve().then(()=>dX),void 0))}constructor(e,t=null,i){super({...i,name:e,engine:t||ft.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:ks.FragmentUrl,samplers:ks.Samplers})}}ks.FragmentUrl="depthOfFieldMerge";ks.Samplers=["circleOfConfusionSampler","blurStep0","blurStep1","blurStep2"];class j1 extends Bt{constructor(e,t,i){super(e,t,i||new ks(e,t.engine)),this.blurSteps=[]}record(e=!1){if(this.sourceTexture===void 0||this.circleOfConfusionTexture===void 0||this.blurSteps.length===0)throw new Error(`FrameGraphBloomMergeTask "${this.name}": sourceTexture, circleOfConfusionTexture and blurSteps are required`);this.postProcess.updateEffect("#define BLUR_LEVEL "+(this.blurSteps.length-1)+`
`);const t=super.record(e,i=>{i.setTextureSamplingMode(this.blurSteps[this.blurSteps.length-1],2)},i=>{i.bindTextureHandle(this._postProcessDrawWrapper.effect,"circleOfConfusionSampler",this.circleOfConfusionTexture);for(let r=0;r<this.blurSteps.length;r++){const n=this.blurSteps[r];i.bindTextureHandle(this._postProcessDrawWrapper.effect,"blurStep"+(this.blurSteps.length-r-1),n)}});return t.addDependencies(this.circleOfConfusionTexture),t.addDependencies(this.blurSteps),t}}class iu extends hs{constructor(e,t=null,i,r,n){super(e,t,i,r,{...n,defines:`#define DOF 1
`})}}class Pv extends Ro{constructor(e,t,i){super(e,t,i||new iu(e,t.engine,new X(1,0),10)),this.circleOfConfusionSamplingMode=2}record(e=!1){if(this.sourceTexture===void 0||this.circleOfConfusionTexture===void 0)throw new Error(`FrameGraphDepthOfFieldBlurTask "${this.name}": sourceTexture and circleOfConfusionTexture are required`);const t=super.record(e,i=>{i.setTextureSamplingMode(this.circleOfConfusionTexture,this.circleOfConfusionSamplingMode)},i=>{i.bindTextureHandle(this._postProcessDrawWrapper.effect,"circleOfConfusionSampler",this.circleOfConfusionTexture)});return t.addDependencies(this.circleOfConfusionTexture),t}}var Ov;(function(s){s[s.Low=0]="Low",s[s.Medium=1]="Medium",s[s.High=2]="High"})(Ov||(Ov={}));class MR{set focalLength(e){this._circleOfConfusion.focalLength=e}get focalLength(){return this._circleOfConfusion.focalLength}set fStop(e){this._circleOfConfusion.fStop=e}get fStop(){return this._circleOfConfusion.fStop}set focusDistance(e){this._circleOfConfusion.focusDistance=e}get focusDistance(){return this._circleOfConfusion.focusDistance}set lensSize(e){this._circleOfConfusion.lensSize=e}get lensSize(){return this._circleOfConfusion.lensSize}constructor(e,t,i=0,r=!1,n=!1){this._depthOfFieldBlurX=[],this._depthOfFieldBlurY=[],this._circleOfConfusion=new Vi(e,t,{depthNotNormalized:r,blockCompilation:n}),this.blurLevel=i;let a=1,o=15;switch(i){case 2:{a=3,o=51;break}case 1:{a=2,o=31;break}default:{o=15,a=1;break}}const l=o/Math.pow(2,a-1);let c=1;for(let u=0;u<a;u++)this._depthOfFieldBlurY.push([new iu(e,t,new X(0,1),l,{blockCompilation:n}),c]),c=.75/Math.pow(2,u),this._depthOfFieldBlurX.push([new iu(e,t,new X(1,0),l,{blockCompilation:n}),c]);this._dofMerge=new ks(e,t,{blockCompilation:n})}isReady(){let e=this._circleOfConfusion.isReady()&&this._dofMerge.isReady();for(let t=0;t<this._depthOfFieldBlurX.length;t++)e=e&&this._depthOfFieldBlurX[t][0].isReady()&&this._depthOfFieldBlurY[t][0].isReady();return e}}class Nv extends Br{get name(){return this._name}set name(e){if(this._name=e,this._circleOfConfusion&&(this._circleOfConfusion.name=`${e} Circle of Confusion`),this._blurX)for(let t=0;t<this._blurX.length;t++)this._blurX[t].name=`${e} Blur X${t}`,this._blurY[t].name=`${e} Blur Y${t}`;this._merge&&(this._merge.name=`${e} Merge`)}constructor(e,t,i=0,r=!1){if(super(e,t),this.sourceSamplingMode=2,this.depthSamplingMode=2,this._blurX=[],this._blurY=[],this._engine=t.engine,this.hdr=r,this._defaultPipelineTextureType=0,r){const a=t.engine.getCaps();a.textureHalfFloatRender?this._defaultPipelineTextureType=2:a.textureFloatRender&&(this._defaultPipelineTextureType=1)}this.depthOfField=new MR(e,t.engine,i,!0),this._circleOfConfusion=new OR(`${e} Circle of Confusion`,this._frameGraph,this.depthOfField._circleOfConfusion);const n=this.depthOfField._depthOfFieldBlurX.length;for(let a=0;a<n;a++)this._blurX.push(new Pv(`${e} Blur X${a}`,this._frameGraph,this.depthOfField._depthOfFieldBlurX[a][0])),this._blurY.push(new Pv(`${e} Blur Y${a}`,this._frameGraph,this.depthOfField._depthOfFieldBlurY[a][0]));this._merge=new j1(`${e} Merge`,this._frameGraph,this.depthOfField._dofMerge),this.outputTexture=this._frameGraph.textureManager.createDanglingHandle()}isReady(){return this.depthOfField.isReady()}record(){if(this.sourceTexture===void 0||this.depthTexture===void 0||this.camera===void 0)throw new Error("FrameGraphDepthOfFieldTask: sourceTexture, depthTexture and camera are required");const e=this._frameGraph.textureManager.getTextureDescription(this.sourceTexture),t={width:e.size.width,height:e.size.height},i=this._engine.isWebGPU||this._engine.version>1?6:5,r={size:t,options:{createMipMaps:!1,types:[this._defaultPipelineTextureType],formats:[i],samples:1,useSRGBBuffers:[!1],labels:[""]},sizeIsPercentage:!1},n=this._frameGraph.textureManager.createRenderTargetTexture(this._circleOfConfusion.name,r);this._circleOfConfusion.sourceTexture=this.sourceTexture,this._circleOfConfusion.depthTexture=this.depthTexture,this._circleOfConfusion.depthSamplingMode=this.depthSamplingMode,this._circleOfConfusion.camera=this.camera,this._circleOfConfusion.targetTexture=n,this._circleOfConfusion.record(!0),r.options.formats=[5];const a=[];for(let c=0;c<this._blurX.length;c++){const u=this.depthOfField._depthOfFieldBlurX[c][1];t.width=Math.floor(e.size.width*u)||1,t.height=Math.floor(e.size.height*u)||1,r.options.labels[0]="step "+(c+1);const h=this._frameGraph.textureManager.createRenderTargetTexture(this._blurY[c].name,r);this._blurY[c].sourceTexture=c===0?this.sourceTexture:this._blurX[c-1].outputTexture,this._blurY[c].sourceSamplingMode=2,this._blurY[c].circleOfConfusionTexture=n,this._blurY[c].targetTexture=h,this._blurY[c].record(!0);const d=this._frameGraph.textureManager.createRenderTargetTexture(this._blurX[c].name,r);this._blurX[c].sourceTexture=this._blurY[c].outputTexture,this._blurX[c].sourceSamplingMode=2,this._blurX[c].circleOfConfusionTexture=n,this._blurX[c].targetTexture=d,this._blurX[c].record(!0),a.push(d)}const o=this._frameGraph.textureManager.getTextureCreationOptions(this.sourceTexture);this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture,this._merge.name,o),this._merge.sourceTexture=this.sourceTexture,this._merge.sourceSamplingMode=this.sourceSamplingMode,this._merge.circleOfConfusionTexture=n,this._merge.blurSteps=a,this._merge.targetTexture=this.outputTexture,this._merge.record(!0);const l=this._frameGraph.addRenderPass(this.name+"_disabled",!0);l.addDependencies(this.sourceTexture),l.setRenderTarget(this.outputTexture),l.setExecuteFunc(c=>{c.copyTexture(this.sourceTexture)})}dispose(){this._circleOfConfusion.dispose();for(let e=0;e<this._blurX.length;e++)this._blurX[e].dispose(),this._blurY[e].dispose();this._merge.dispose(),super.dispose()}}class Kn extends ri{get task(){return this._frameGraphTask}constructor(e,t,i,r=0,n=!1){super(e,t,i),this._additionalConstructionParameters=[r,n],this.registerInput("geomViewDepth",H.TextureViewDepth),this.registerInput("camera",H.Camera),this._finalizeInputOutputRegistering(),this._frameGraphTask=new Nv(this.name,t,r,n)}_createTask(e,t){const i=this._frameGraphTask.sourceSamplingMode,r=this._frameGraphTask.depthSamplingMode,n=this._frameGraphTask.depthOfField.focalLength,a=this._frameGraphTask.depthOfField.fStop,o=this._frameGraphTask.depthOfField.focusDistance,l=this._frameGraphTask.depthOfField.lensSize;this._frameGraphTask.dispose(),this._frameGraphTask=new Nv(this.name,this._frameGraph,e,t),this._frameGraphTask.sourceSamplingMode=i,this._frameGraphTask.depthSamplingMode=r,this._frameGraphTask.depthOfField.focalLength=n,this._frameGraphTask.depthOfField.fStop=a,this._frameGraphTask.depthOfField.focusDistance=o,this._frameGraphTask.depthOfField.lensSize=l,this._additionalConstructionParameters=[e,t]}get blurLevel(){return this._frameGraphTask.depthOfField.blurLevel}set blurLevel(e){this._createTask(e,this._frameGraphTask.hdr)}get hdr(){return this._frameGraphTask.hdr}set hdr(e){this._createTask(this._frameGraphTask.depthOfField.blurLevel,e)}get depthSamplingMode(){return this._frameGraphTask.depthSamplingMode}set depthSamplingMode(e){this._frameGraphTask.depthSamplingMode=e}get focalLength(){return this._frameGraphTask.depthOfField.focalLength}set focalLength(e){this._frameGraphTask.depthOfField.focalLength=e}get fStop(){return this._frameGraphTask.depthOfField.fStop}set fStop(e){this._frameGraphTask.depthOfField.fStop=e}get focusDistance(){return this._frameGraphTask.depthOfField.focusDistance}set focusDistance(e){this._frameGraphTask.depthOfField.focusDistance=e}get lensSize(){return this._frameGraphTask.depthOfField.lensSize}set lensSize(e){this._frameGraphTask.depthOfField.lensSize=e}getClassName(){return"NodeRenderGraphDepthOfFieldPostProcessBlock"}get geomViewDepth(){return this._inputs[2]}get camera(){return this._inputs[3]}_buildBlock(e){var t,i;super._buildBlock(e),this.output.value=this._frameGraphTask.outputTexture,this._frameGraphTask.depthTexture=(t=this.geomViewDepth.connectedPoint)==null?void 0:t.value,this._frameGraphTask.camera=(i=this.camera.connectedPoint)==null?void 0:i.value}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.lensSize = ${this.lensSize};`),e.push(`${this._codeVariableName}.fStop = ${this.fStop};`),e.push(`${this._codeVariableName}.focusDistance = ${this.focusDistance};`),e.push(`${this._codeVariableName}.focalLength = ${this.focalLength};`),e.push(`${this._codeVariableName}.depthSamplingMode = ${this.depthSamplingMode};`),super._dumpPropertiesCode()+e.join(`
`)}serialize(){const e=super.serialize();return e.lensSize=this.lensSize,e.fStop=this.fStop,e.focusDistance=this.focusDistance,e.focalLength=this.focalLength,e.depthSamplingMode=this.depthSamplingMode,e}_deserialize(e){super._deserialize(e),this.lensSize=e.lensSize,this.fStop=e.fStop,this.focusDistance=e.focusDistance,this.focalLength=e.focalLength,this.depthSamplingMode=e.depthSamplingMode}}_([O("Blur level",5,"PROPERTIES",{options:[{label:"Low",value:0},{label:"Medium",value:1},{label:"High",value:2}]})],Kn.prototype,"blurLevel",null);_([O("HDR",0,"PROPERTIES")],Kn.prototype,"hdr",null);_([O("Depth sampling mode",7,"PROPERTIES")],Kn.prototype,"depthSamplingMode",null);_([O("Focal length",1,"PROPERTIES")],Kn.prototype,"focalLength",null);_([O("F-Stop",1,"PROPERTIES")],Kn.prototype,"fStop",null);_([O("Focus distance",1,"PROPERTIES")],Kn.prototype,"focusDistance",null);_([O("Lens size",1,"PROPERTIES")],Kn.prototype,"lensSize",null);y("BABYLON.NodeRenderGraphDepthOfFieldPostProcessBlock",Kn);class FR extends ri{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this._finalizeInputOutputRegistering(),this._frameGraphTask=new PR(this.name,t,new _s(e,i.getEngine()))}get threshold(){return this._frameGraphTask.postProcess.threshold}set threshold(e){this._frameGraphTask.postProcess.threshold=e}getClassName(){return"NodeRenderGraphExtractHighlightsPostProcessBlock"}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.threshold = ${this.threshold};`),super._dumpPropertiesCode()+e.join(`
`)}serialize(){const e=super.serialize();return e.threshold=this.threshold,e}_deserialize(e){super._deserialize(e),this.threshold=e.threshold}}_([O("Threshold",1,"PROPERTIES",{min:0,max:1})],FR.prototype,"threshold",null);y("BABYLON.NodeRenderGraphExtractHighlightsPostProcessBlock",FR);class Gs extends gt{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(U(()=>Promise.resolve().then(()=>s5),void 0))):t.push(U(()=>Promise.resolve().then(()=>i5),void 0))}constructor(e,t=null,i){super({...i,name:e,engine:t||ft.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Gs.FragmentUrl,uniforms:Gs.Uniforms}),this.kernelMatrix=z.Identity()}bind(e=!1){super.bind(e),this._drawWrapper.effect.setMatrix("kernelMatrix",this.kernelMatrix)}}Gs.FragmentUrl="filter";Gs.Uniforms=["kernelMatrix"];class q1 extends Bt{constructor(e,t,i){super(e,t,i||new Gs(e,t.engine))}}class LR extends ri{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this._finalizeInputOutputRegistering(),this._frameGraphTask=new q1(this.name,t,new Gs(e,i.getEngine()))}get kernelMatrix(){return this._frameGraphTask.postProcess.kernelMatrix}set kernelMatrix(e){this._frameGraphTask.postProcess.kernelMatrix=e}getClassName(){return"NodeRenderGraphFilterPostProcessBlock"}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.kernelMatrix = ${this.kernelMatrix};`),super._dumpPropertiesCode()+e.join(`
`)}serialize(){const e=super.serialize();return e.kernelMatrix=this.kernelMatrix.asArray(),e}_deserialize(e){super._deserialize(e),this.kernelMatrix=z.FromArray(e.kernelMatrix)}}_([O("Matrix",11,"PROPERTIES")],LR.prototype,"kernelMatrix",null);y("BABYLON.NodeRenderGraphFilterPostProcessBlock",LR);class Mr extends gt{static _GetDefines(e){return e&&e.extractDriverInfo().toLowerCase().indexOf("mali")>-1?`#define MALI 1
`:null}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([U(()=>Promise.resolve().then(()=>DX),void 0),U(()=>Promise.resolve().then(()=>FX),void 0)]))):t.push(Promise.all([U(()=>Promise.resolve().then(()=>AX),void 0),U(()=>Promise.resolve().then(()=>OX),void 0)]))}constructor(e,t=null,i){const r={...i,name:e,engine:t||ft.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,vertexShader:Mr.VertexUrl,fragmentShader:Mr.FragmentUrl,uniforms:Mr.Uniforms};super({...r,defines:Mr._GetDefines(r.engine)}),this.texelSize=new X(0,0)}bind(e=!1){super.bind(e),this._drawWrapper.effect.setFloat2("texelSize",this.texelSize.x,this.texelSize.y)}}Mr.VertexUrl="fxaa";Mr.FragmentUrl="fxaa";Mr.Uniforms=["texelSize"];class wR extends Bt{constructor(e,t,i){super(e,t,i||new Mr(e,t.engine))}record(e=!1,t,i){const r=super.record(e,t,i);return this.postProcess.texelSize.x=1/this._sourceWidth,this.postProcess.texelSize.y=1/this._sourceHeight,r}}class Z1 extends ri{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this._finalizeInputOutputRegistering(),this._frameGraphTask=new wR(this.name,t,new Mr(e,i.getEngine()))}getClassName(){return"NodeRenderGraphFXAAPostProcessBlock"}}y("BABYLON.NodeRenderGraphFXAAPostProcessBlock",Z1);class zs extends gt{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(U(()=>Promise.resolve().then(()=>lX),void 0))):t.push(U(()=>Promise.resolve().then(()=>aX),void 0))}constructor(e,t=null,i){super({...i,name:e,engine:t||ft.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:zs.FragmentUrl,uniforms:zs.Uniforms}),this.intensity=30,this.animated=!1}bind(e=!1){super.bind(e),this._drawWrapper.effect.setFloat("intensity",this.intensity),this._drawWrapper.effect.setFloat("animatedSeed",this.animated?Math.random()+1:1)}}zs.FragmentUrl="grain";zs.Uniforms=["intensity","animatedSeed"];class Q1 extends Bt{constructor(e,t,i){super(e,t,i||new zs(e,t.engine))}}class T_ extends ri{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this._finalizeInputOutputRegistering(),this._frameGraphTask=new Q1(this.name,t,new zs(e,i.getEngine()))}get intensity(){return this._frameGraphTask.postProcess.intensity}set intensity(e){this._frameGraphTask.postProcess.intensity=e}get animated(){return this._frameGraphTask.postProcess.animated}set animated(e){this._frameGraphTask.postProcess.animated=e}getClassName(){return"NodeRenderGraphGrainPostProcessBlock"}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.intensity = ${this.intensity};`),e.push(`${this._codeVariableName}.animated = ${this.animated};`),super._dumpPropertiesCode()+e.join(`
`)}serialize(){const e=super.serialize();return e.intensity=this.intensity,e.animated=this.animated,e}_deserialize(e){super._deserialize(e),this.intensity=e.intensity,this.animated=e.animated}}_([O("Intensity",1,"PROPERTIES",{min:0,max:200})],T_.prototype,"intensity",null);_([O("Animated",0,"PROPERTIES")],T_.prototype,"animated",null);y("BABYLON.NodeRenderGraphGrainPostProcessBlock",T_);class Ia extends gt{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(U(()=>Promise.resolve().then(()=>eX),void 0))):t.push(U(()=>Promise.resolve().then(()=>iX),void 0))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){e.applyByPostProcess=!0,this._attachImageProcessingConfiguration(e)}_attachImageProcessingConfiguration(e,t=!1){if(e!==this._imageProcessingConfiguration){if(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e)this._imageProcessingConfiguration=e;else{let i=this.options.scene;if(!i){const r=this.options.engine;if(r&&r.scenes){const n=r.scenes;i=n[n.length-1]}else i=De.LastCreatedScene}i?this._imageProcessingConfiguration=i.imageProcessingConfiguration:this._imageProcessingConfiguration=new bi}this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._updateParameters()})),t||this._updateParameters()}}get colorCurves(){return this.imageProcessingConfiguration.colorCurves}set colorCurves(e){this.imageProcessingConfiguration.colorCurves=e}get colorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set colorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get colorGradingTexture(){return this.imageProcessingConfiguration.colorGradingTexture}set colorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get colorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set colorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get exposure(){return this.imageProcessingConfiguration.exposure}set exposure(e){this.imageProcessingConfiguration.exposure=e}get toneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set toneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get toneMappingType(){return this._imageProcessingConfiguration.toneMappingType}set toneMappingType(e){this._imageProcessingConfiguration.toneMappingType=e}get contrast(){return this.imageProcessingConfiguration.contrast}set contrast(e){this.imageProcessingConfiguration.contrast=e}get vignetteStretch(){return this.imageProcessingConfiguration.vignetteStretch}set vignetteStretch(e){this.imageProcessingConfiguration.vignetteStretch=e}get vignetteCentreX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCentreX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteCentreY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCentreY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCenterY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCenterX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteWeight(){return this.imageProcessingConfiguration.vignetteWeight}set vignetteWeight(e){this.imageProcessingConfiguration.vignetteWeight=e}get vignetteColor(){return this.imageProcessingConfiguration.vignetteColor}set vignetteColor(e){this.imageProcessingConfiguration.vignetteColor=e}get vignetteCameraFov(){return this.imageProcessingConfiguration.vignetteCameraFov}set vignetteCameraFov(e){this.imageProcessingConfiguration.vignetteCameraFov=e}get vignetteBlendMode(){return this.imageProcessingConfiguration.vignetteBlendMode}set vignetteBlendMode(e){this.imageProcessingConfiguration.vignetteBlendMode=e}get vignetteEnabled(){return this.imageProcessingConfiguration.vignetteEnabled}set vignetteEnabled(e){this.imageProcessingConfiguration.vignetteEnabled=e}get ditheringIntensity(){return this.imageProcessingConfiguration.ditheringIntensity}set ditheringIntensity(e){this.imageProcessingConfiguration.ditheringIntensity=e}get ditheringEnabled(){return this.imageProcessingConfiguration.ditheringEnabled}set ditheringEnabled(e){this.imageProcessingConfiguration.ditheringEnabled=e}get fromLinearSpace(){return this._fromLinearSpace}set fromLinearSpace(e){this._fromLinearSpace!==e&&(this._fromLinearSpace=e,this._updateParameters())}get outputTextureWidth(){return this.imageProcessingConfiguration.outputTextureWidth}set outputTextureWidth(e){this.imageProcessingConfiguration.outputTextureWidth=e}get outputTextureHeight(){return this.imageProcessingConfiguration.outputTextureHeight}set outputTextureHeight(e){this.imageProcessingConfiguration.outputTextureHeight=e}constructor(e,t=null,i){super({...i,name:e,engine:t||ft.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Ia.FragmentUrl}),this._fromLinearSpace=!0,this._defines={IMAGEPROCESSING:!1,VIGNETTE:!1,VIGNETTEBLENDMODEMULTIPLY:!1,VIGNETTEBLENDMODEOPAQUE:!1,TONEMAPPING:0,CONTRAST:!1,COLORCURVES:!1,COLORGRADING:!1,COLORGRADING3D:!1,FROMLINEARSPACE:!1,SAMPLER3DGREENDEPTH:!1,SAMPLER3DBGRMAP:!1,DITHER:!1,IMAGEPROCESSINGPOSTPROCESS:!1,EXPOSURE:!1,SKIPFINALCOLORCLAMP:!1};const r=i==null?void 0:i.imageProcessingConfiguration;r?(r.applyByPostProcess=!0,this._attachImageProcessingConfiguration(r,!0),this._updateParameters()):(this._attachImageProcessingConfiguration(null,!0),this.imageProcessingConfiguration.applyByPostProcess=!0)}_updateParameters(){this._defines.FROMLINEARSPACE=this._fromLinearSpace,this.imageProcessingConfiguration.prepareDefines(this._defines,!0);let e="";for(const r in this._defines){const n=this._defines[r];switch(typeof n){case"number":case"string":e+=`#define ${r} ${n};
`;break;default:n&&(e+=`#define ${r};
`);break}}const t=["textureSampler"],i=["scale"];bi&&(bi.PrepareSamplers(t,this._defines),bi.PrepareUniforms(i,this._defines)),this.updateEffect(e,i,t)}bind(e=!1){super.bind(e),this.imageProcessingConfiguration.bind(this.effect,this.overrideAspectRatio)}dispose(){super.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration&&(this.imageProcessingConfiguration.applyByPostProcess=!1)}}Ia.FragmentUrl="imageProcessing";class K1 extends Bt{constructor(e,t,i){super(e,t,i||new Ia(e,t.engine))}record(e=!1,t,i){const r=super.record(e,t,i);return this.postProcess.outputTextureWidth=this._outputWidth,this.postProcess.outputTextureHeight=this._outputHeight,r}}class ur extends ri{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this._finalizeInputOutputRegistering(),this._frameGraphTask=new K1(this.name,t,new Ia(e,i.getEngine(),{scene:i,imageProcessingConfiguration:new bi}))}get contrast(){return this._frameGraphTask.postProcess.contrast}set contrast(e){this._frameGraphTask.postProcess.contrast=e}get exposure(){return this._frameGraphTask.postProcess.exposure}set exposure(e){this._frameGraphTask.postProcess.exposure=e}get toneMappingEnabled(){return this._frameGraphTask.postProcess.toneMappingEnabled}set toneMappingEnabled(e){this._frameGraphTask.postProcess.toneMappingEnabled=e}get toneMappingType(){return this._frameGraphTask.postProcess.toneMappingType}set toneMappingType(e){this._frameGraphTask.postProcess.toneMappingType=e}get vignetteEnabled(){return this._frameGraphTask.postProcess.vignetteEnabled}set vignetteEnabled(e){this._frameGraphTask.postProcess.vignetteEnabled=e}get vignetteWeight(){return this._frameGraphTask.postProcess.vignetteWeight}set vignetteWeight(e){this._frameGraphTask.postProcess.vignetteWeight=e}get vignetteStretch(){return this._frameGraphTask.postProcess.vignetteStretch}set vignetteStretch(e){this._frameGraphTask.postProcess.vignetteStretch=e}get vignetteCameraFov(){return this._frameGraphTask.postProcess.vignetteCameraFov}set vignetteCameraFov(e){this._frameGraphTask.postProcess.vignetteCameraFov=e}get vignetteCenterX(){return this._frameGraphTask.postProcess.vignetteCenterX}set vignetteCenterX(e){this._frameGraphTask.postProcess.vignetteCenterX=e}get vignetteCenterY(){return this._frameGraphTask.postProcess.vignetteCenterY}set vignetteCenterY(e){this._frameGraphTask.postProcess.vignetteCenterY=e}get vignetteColor(){return this._frameGraphTask.postProcess.vignetteColor}set vignetteColor(e){this._frameGraphTask.postProcess.vignetteColor=e}get vignetteBlendMode(){return this._frameGraphTask.postProcess.vignetteBlendMode}set vignetteBlendMode(e){this._frameGraphTask.postProcess.vignetteBlendMode=e}get ditheringEnabled(){return this._frameGraphTask.postProcess.ditheringEnabled}set ditheringEnabled(e){this._frameGraphTask.postProcess.ditheringEnabled=e}get ditheringIntensity(){return this._frameGraphTask.postProcess.ditheringIntensity}set ditheringIntensity(e){this._frameGraphTask.postProcess.ditheringIntensity=e}getClassName(){return"NodeRenderGraphImageProcessingPostProcessBlock"}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.contrast = ${this.contrast};`),e.push(`${this._codeVariableName}.exposure = ${this.exposure};`),e.push(`${this._codeVariableName}.toneMappingEnabled = ${this.toneMappingEnabled};`),e.push(`${this._codeVariableName}.toneMappingType = ${this.toneMappingType};`),e.push(`${this._codeVariableName}.vignetteEnabled = ${this.vignetteEnabled};`),e.push(`${this._codeVariableName}.vignetteWeight = ${this.vignetteWeight};`),e.push(`${this._codeVariableName}.vignetteStretch = ${this.vignetteStretch};`),e.push(`${this._codeVariableName}.vignetteCameraFov = ${this.vignetteCameraFov};`),e.push(`${this._codeVariableName}.vignetteCenterX = ${this.vignetteCenterX};`),e.push(`${this._codeVariableName}.vignetteCenterY = ${this.vignetteCenterY};`),e.push(`${this._codeVariableName}.vignetteColor = new BABYLON.Color4(${this.vignetteColor.r}, ${this.vignetteColor.g}, ${this.vignetteColor.b}, 1);`),e.push(`${this._codeVariableName}.vignetteBlendMode = ${this.vignetteBlendMode};`),e.push(`${this._codeVariableName}.ditheringEnabled = ${this.ditheringEnabled};`),e.push(`${this._codeVariableName}.ditheringIntensity = ${this.ditheringIntensity};`),super._dumpPropertiesCode()+e.join(`
`)}serialize(){const e=super.serialize();return e.contrast=this.contrast,e.exposure=this.exposure,e.toneMappingEnabled=this.toneMappingEnabled,e.toneMappingType=this.toneMappingType,e.vignetteEnabled=this.vignetteEnabled,e.vignetteWeight=this.vignetteWeight,e.vignetteStretch=this.vignetteStretch,e.vignetteCameraFov=this.vignetteCameraFov,e.vignetteCenterX=this.vignetteCenterX,e.vignetteCenterY=this.vignetteCenterY,e.vignetteColor=this.vignetteColor.asArray(),e.vignetteBlendMode=this.vignetteBlendMode,e.ditheringEnabled=this.ditheringEnabled,e.ditheringIntensity=this.ditheringIntensity,e}_deserialize(e){super._deserialize(e),this.contrast=e.contrast,this.exposure=e.exposure,this.toneMappingEnabled=e.toneMappingEnabled,this.toneMappingType=e.toneMappingType,this.vignetteEnabled=e.vignetteEnabled,this.vignetteWeight=e.vignetteWeight,this.vignetteStretch=e.vignetteStretch,this.vignetteCameraFov=e.vignetteCameraFov,this.vignetteCenterX=e.vignetteCenterX,this.vignetteCenterY=e.vignetteCenterY,this.vignetteColor=Te.FromArray(e.vignetteColor),this.vignetteBlendMode=e.vignetteBlendMode,this.ditheringEnabled=e.ditheringEnabled,this.ditheringIntensity=e.ditheringIntensity}}_([O("Contrast",1,"PROPERTIES",{min:0,max:4})],ur.prototype,"contrast",null);_([O("Exposure",1,"PROPERTIES",{min:0,max:4})],ur.prototype,"exposure",null);_([O("Enabled",0,"TONE MAPPING")],ur.prototype,"toneMappingEnabled",null);_([O("Type",5,"TONE MAPPING",{options:[{value:bi.TONEMAPPING_STANDARD,label:"Standard"},{value:bi.TONEMAPPING_ACES,label:"ACES"},{value:bi.TONEMAPPING_KHR_PBR_NEUTRAL,label:"KHR PBR Neutral"}]})],ur.prototype,"toneMappingType",null);_([O("Enabled",0,"VIGNETTE")],ur.prototype,"vignetteEnabled",null);_([O("Weight",1,"VIGNETTE",{min:0,max:4})],ur.prototype,"vignetteWeight",null);_([O("Stretch",1,"VIGNETTE",{min:0,max:1})],ur.prototype,"vignetteStretch",null);_([O("FOV",1,"VIGNETTE",{min:0,max:3.14159})],ur.prototype,"vignetteCameraFov",null);_([O("Center X",1,"VIGNETTE",{min:0,max:1})],ur.prototype,"vignetteCenterX",null);_([O("Center Y",1,"VIGNETTE",{min:0,max:1})],ur.prototype,"vignetteCenterY",null);_([O("Color",6,"VIGNETTE")],ur.prototype,"vignetteColor",null);_([O("Blend mode",5,"VIGNETTE",{options:[{value:bi.VIGNETTEMODE_MULTIPLY,label:"Multiply"},{value:bi.VIGNETTEMODE_OPAQUE,label:"Opaque"}]})],ur.prototype,"vignetteBlendMode",null);_([O("Enabed",0,"DITHERING")],ur.prototype,"ditheringEnabled",null);_([O("Intensity",1,"DITHERING",{min:0,max:1})],ur.prototype,"ditheringIntensity",null);y("BABYLON.NodeRenderGraphImageProcessingPostProcessBlock",ur);class ji extends gt{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(U(()=>Promise.resolve().then(()=>e5),void 0))):t.push(U(()=>Promise.resolve().then(()=>KX),void 0))}constructor(e,t,i){super({...i,name:e,engine:t.getEngine(),useShaderStore:!0,useAsPostProcess:!0,fragmentShader:ji.FragmentUrl,uniforms:ji.Uniforms,samplers:ji.Samplers,defines:ji.Defines}),this._invViewProjection=z.Identity(),this._previousViewProjection=z.Identity(),this.motionStrength=1,this._motionBlurSamples=32,this._isObjectBased=!0,this.textureWidth=0,this.textureHeight=0,this._scene=t,this._applyMode()}get motionBlurSamples(){return this._motionBlurSamples}set motionBlurSamples(e){this._motionBlurSamples=e,this._updateEffect()}get isObjectBased(){return this._isObjectBased}set isObjectBased(e){this._isObjectBased!==e&&(this._isObjectBased=e,this._applyMode())}bind(e=!1){super.bind(e);const t=this._drawWrapper.effect;if(t.setFloat2("screenSize",this.textureWidth,this.textureHeight),t.setFloat("motionScale",this._scene.getAnimationRatio()),t.setFloat("motionStrength",this.motionStrength),!this.isObjectBased){const i=G.Matrix[0];i.copyFrom(this._scene.getTransformMatrix()),i.invertToRef(this._invViewProjection),t.setMatrix("inverseViewProjection",this._invViewProjection),t.setMatrix("prevViewProjection",this._previousViewProjection),this._previousViewProjection.copyFrom(i),t.setMatrix("projection",this._scene.getProjectionMatrix())}}_updateEffect(){const e=["#define GEOMETRY_SUPPORTED","#define SAMPLES "+this._motionBlurSamples.toFixed(1),this._isObjectBased?"#define OBJECT_BASED":"#define SCREEN_BASED"];this.updateEffect(e.join(`
`))}_applyMode(){this._updateEffect(),this._previousViewProjection.copyFrom(this._scene.getTransformMatrix())}}ji.FragmentUrl="motionBlur";ji.Uniforms=["motionStrength","motionScale","screenSize","inverseViewProjection","prevViewProjection","projection"];ji.Samplers=["velocitySampler","depthSampler"];ji.Defines=`#define GEOMETRY_SUPPORTED
#define SAMPLES 64.0
#define OBJECT_BASED`;class J1 extends Bt{constructor(e,t,i){super(e,t,i||new ji(e,t.scene))}record(e=!1){if(this.sourceTexture===void 0)throw new Error(`FrameGraphMotionBlurTask "${this.name}": sourceTexture is required`);const t=super.record(e,void 0,i=>{if(this.velocityTexture)i.bindTextureHandle(this._postProcessDrawWrapper.effect,"velocitySampler",this.velocityTexture);else if(this.postProcess.isObjectBased)throw new Error(`FrameGraphMotionBlurTask "${this.name}": velocityTexture is required for object-based motion blur`);if(this.depthTexture)i.bindTextureHandle(this._postProcessDrawWrapper.effect,"depthSampler",this.depthTexture);else if(!this.postProcess.isObjectBased)throw new Error(`FrameGraphMotionBlurTask "${this.name}": depthTexture is required for screen-based motion blur`)});return t.addDependencies(this.velocityTexture),t.addDependencies(this.depthTexture),this.postProcess.textureWidth=this._sourceWidth,this.postProcess.textureHeight=this._sourceHeight,t}}class mh extends ri{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("geomVelocity",H.TextureVelocity,!0),this.registerInput("geomViewDepth",H.TextureViewDepth,!0),this._finalizeInputOutputRegistering(),this._frameGraphTask=new J1(this.name,t,new ji(e,t.scene))}get motionStrength(){return this._frameGraphTask.postProcess.motionStrength}set motionStrength(e){this._frameGraphTask.postProcess.motionStrength=e}get motionBlurSamples(){return this._frameGraphTask.postProcess.motionBlurSamples}set motionBlurSamples(e){this._frameGraphTask.postProcess.motionBlurSamples=e}get isObjectBased(){return this._frameGraphTask.postProcess.isObjectBased}set isObjectBased(e){this._frameGraphTask.postProcess.isObjectBased=e}getClassName(){return"NodeRenderGraphMotionBlurPostProcessBlock"}get geomVelocity(){return this._inputs[2]}get geomViewDepth(){return this._inputs[3]}_buildBlock(e){var t,i;super._buildBlock(e),this._frameGraphTask.velocityTexture=(t=this.geomVelocity.connectedPoint)==null?void 0:t.value,this._frameGraphTask.depthTexture=(i=this.geomViewDepth.connectedPoint)==null?void 0:i.value}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.motionStrength = ${this.motionStrength};`),e.push(`${this._codeVariableName}.motionBlurSamples = ${this.motionBlurSamples};`),e.push(`${this._codeVariableName}.isObjectBased = ${this.isObjectBased};`),super._dumpPropertiesCode()+e.join(`
`)}serialize(){const e=super.serialize();return e.motionStrength=this.motionStrength,e.motionBlurSamples=this.motionBlurSamples,e.isObjectBased=this.isObjectBased,e}_deserialize(e){super._deserialize(e),this.motionStrength=e.motionStrength,this.motionBlurSamples=e.motionBlurSamples,this.isObjectBased=e.isObjectBased}}_([O("Strength",1,"PROPERTIES")],mh.prototype,"motionStrength",null);_([O("Samples",1,"PROPERTIES")],mh.prototype,"motionBlurSamples",null);_([O("Object based",0,"PROPERTIES")],mh.prototype,"isObjectBased",null);y("BABYLON.NodeRenderGraphMotionBlurPostProcessBlock",mh);class BR extends Bt{constructor(e,t,i){super(e,t,i||new Km(e,t.engine))}}class eV extends Bt{constructor(e,t,i){super(e,t,i||new II(e,t.engine))}}class tV extends ri{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this._finalizeInputOutputRegistering(),this._frameGraphTask=new BR(this.name,t,new Km(e,i.getEngine()))}getClassName(){return"NodeRenderGraphPassPostProcessBlock"}}y("BABYLON.NodeRenderGraphPassPostProcessBlock",tV);class iV extends ri{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this._finalizeInputOutputRegistering(),this._frameGraphTask=new eV(this.name,t,new II(e,i.getEngine()))}getClassName(){return"NodeRenderGraphPassCubePostProcessBlock"}}y("BABYLON.NodeRenderGraphPassCubePostProcessBlock",iV);class Ws extends gt{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(U(()=>Promise.resolve().then(()=>sX),void 0))):t.push(U(()=>Promise.resolve().then(()=>s$),void 0))}constructor(e,t=null,i){super({...i,name:e,engine:t||ft.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Ws.FragmentUrl,uniforms:Ws.Uniforms}),this.colorAmount=1,this.edgeAmount=.3,this.textureWidth=0,this.textureHeight=0}bind(e=!1){super.bind(e);const t=this._drawWrapper.effect;t.setFloat2("screenSize",this.textureWidth,this.textureHeight),t.setFloat2("sharpnessAmounts",this.edgeAmount,this.colorAmount)}}Ws.FragmentUrl="sharpen";Ws.Uniforms=["sharpnessAmounts","screenSize"];class rV extends Bt{constructor(e,t,i){super(e,t,i||new Ws(e,t.engine))}record(e=!1,t,i){const r=super.record(e,t,i);return this.postProcess.textureWidth=this._sourceWidth,this.postProcess.textureHeight=this._sourceHeight,r}}class b_ extends ri{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this._finalizeInputOutputRegistering(),this._frameGraphTask=new rV(this.name,t,new Ws(e,i.getEngine()))}get colorAmount(){return this._frameGraphTask.postProcess.colorAmount}set colorAmount(e){this._frameGraphTask.postProcess.colorAmount=e}get edgeAmount(){return this._frameGraphTask.postProcess.edgeAmount}set edgeAmount(e){this._frameGraphTask.postProcess.edgeAmount=e}getClassName(){return"NodeRenderGraphSharpenPostProcessBlock"}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.colorAmount = ${this.colorAmount};`),e.push(`${this._codeVariableName}.edgeAmount = ${this.edgeAmount};`),super._dumpPropertiesCode()+e.join(`
`)}serialize(){const e=super.serialize();return e.colorAmount=this.colorAmount,e.edgeAmount=this.edgeAmount,e}_deserialize(e){super._deserialize(e),this.colorAmount=e.colorAmount,this.edgeAmount=e.edgeAmount}}_([O("Color Amount",1,"PROPERTIES",{min:0,max:1})],b_.prototype,"colorAmount",null);_([O("Edge Amount",1,"PROPERTIES",{min:0,max:1})],b_.prototype,"edgeAmount",null);y("BABYLON.NodeRenderGraphSharpenPostProcessBlock",b_);class Fr extends gt{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(U(()=>import("./screenSpaceCurvature.fragment-61d1896a.js"),["assets/screenSpaceCurvature.fragment-61d1896a.js","assets/main-e8601b72.js","assets/index-ad665221.css"]))):t.push(U(()=>Promise.resolve().then(()=>j$),void 0))}constructor(e,t=null,i){super({...i,name:e,engine:t||ft.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Fr.FragmentUrl,uniforms:Fr.Uniforms,samplers:Fr.Samplers}),this.ridge=1,this.valley=1}bind(e=!1){super.bind(e);const t=this._drawWrapper.effect;t.setFloat("curvature_ridge",.5/Math.max(this.ridge*this.ridge,1e-4)),t.setFloat("curvature_valley",.7/Math.max(this.valley*this.valley,1e-4))}}Fr.FragmentUrl="screenSpaceCurvature";Fr.Uniforms=["curvature_ridge","curvature_valley"];Fr.Samplers=["normalSampler"];class sV extends Bt{constructor(e,t,i){super(e,t,i||new Fr(e,t.engine))}record(e=!1){if(this.sourceTexture===void 0||this.normalTexture===void 0)throw new Error(`FrameGraphScreenSpaceCurvatureTask "${this.name}": sourceTexture and normalTexture are required`);const t=super.record(e,void 0,i=>{i.bindTextureHandle(this._postProcessDrawWrapper.effect,"normalSampler",this.normalTexture)});return t.addDependencies(this.normalTexture),t}}class C_ extends ri{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("geomViewNormal",H.TextureViewNormal),this._finalizeInputOutputRegistering(),this._frameGraphTask=new sV(this.name,t,new Fr(e,i.getEngine()))}get ridge(){return this._frameGraphTask.postProcess.ridge}set ridge(e){this._frameGraphTask.postProcess.ridge=e}get valley(){return this._frameGraphTask.postProcess.valley}set valley(e){this._frameGraphTask.postProcess.valley=e}getClassName(){return"NodeRenderGraphScreenSpaceCurvaturePostProcessBlock"}get geomViewNormal(){return this._inputs[2]}_buildBlock(e){var t;super._buildBlock(e),this._frameGraphTask.normalTexture=(t=this.geomViewNormal.connectedPoint)==null?void 0:t.value}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.ridge = ${this.ridge};`),e.push(`${this._codeVariableName}.valley = ${this.valley};`),super._dumpPropertiesCode()+e.join(`
`)}serialize(){const e=super.serialize();return e.ridge=this.ridge,e.valley=this.valley,e}_deserialize(e){super._deserialize(e),this.ridge=e.ridge,this.valley=e.valley}}_([O("Ridge",1,"PROPERTIES",{min:0,max:1})],C_.prototype,"ridge",null);_([O("Valley",1,"PROPERTIES",{min:0,max:1})],C_.prototype,"valley",null);y("BABYLON.NodeRenderGraphScreenSpaceCurvaturePostProcessBlock",C_);class _r extends gt{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(U(()=>Promise.resolve().then(()=>dP),void 0))):t.push(U(()=>Promise.resolve().then(()=>uP),void 0))}get textureWidth(){return this._textureWidth}set textureWidth(e){this._textureWidth!==e&&(this._textureWidth=e)}get textureHeight(){return this._textureHeight}set textureHeight(e){this._textureHeight!==e&&(this._textureHeight=e)}set samples(e){this._samples=e,this.updateEffect(this._getDefinesForSSAO()),this._sampleSphere=this._generateHemisphere()}get samples(){return this._samples}set epsilon(e){this._epsilon=e,this.updateEffect(this._getDefinesForSSAO())}get epsilon(){return this._epsilon}constructor(e,t,i){super({...i,name:e,engine:t.getEngine(),useShaderStore:!0,useAsPostProcess:!0,fragmentShader:_r.FragmentUrl,uniforms:_r.Uniforms,samplers:_r.Samplers,defines:`#define SSAO
#define SAMPLES 8
#define EPSILON 0.0001`,shaderLanguage:t.getEngine().isWebGPU?1:0}),this.camera=null,this._textureWidth=0,this._textureHeight=0,this._samples=8,this.totalStrength=1,this.radius=2,this.maxZ=100,this.minZAspect=.2,this.base=0,this._epsilon=.02,this._bits=new Uint32Array(1),this._scene=t,this._createRandomTexture(),this.updateEffect(this._getDefinesForSSAO()),this._sampleSphere=this._generateHemisphere()}bind(e=!1){super.bind(e);const t=this._drawWrapper.effect,i=this.camera;if(!i)return;const r=i.getProjectionMatrix();if(t.setArray3("sampleSphere",this._sampleSphere),t.setFloat("randTextureTiles",32),t.setFloat("samplesFactor",1/this.samples),t.setFloat("totalStrength",this.totalStrength),t.setFloat2("texelSize",1/this.textureWidth,1/this.textureHeight),t.setFloat("radius",this.radius),t.setFloat("maxZ",this.maxZ),t.setFloat("minZAspect",this.minZAspect),t.setFloat("base",this.base),t.setFloat("near",i.minZ),i.mode===dt.PERSPECTIVE_CAMERA)t.setMatrix3x3("depthProjection",_r.PERSPECTIVE_DEPTH_PROJECTION),t.setFloat("xViewport",Math.tan(i.fov/2)*this._scene.getEngine().getAspectRatio(i,!0)),t.setFloat("yViewport",Math.tan(i.fov/2));else{const n=this._scene.getEngine().getRenderWidth()/2,a=this._scene.getEngine().getRenderHeight()/2,o=i.orthoLeft??-n,l=i.orthoRight??n,c=i.orthoBottom??-a,u=i.orthoTop??a;t.setMatrix3x3("depthProjection",_r.ORTHO_DEPTH_PROJECTION),t.setFloat4("viewport",o,l,c,u)}t.setMatrix("projection",r),t.setTexture("randomSampler",this._randomTexture)}dispose(){this._randomTexture.dispose(),super.dispose()}_createRandomTexture(){const t=new Uint8Array(65536),i=X.Zero();for(let n=0;n<t.length;)i.set(It(0,1),It(0,1)).normalize().scaleInPlace(255),t[n++]=Math.floor(i.x),t[n++]=Math.floor(i.y),t[n++]=0,t[n++]=255;const r=gi.CreateRGBATexture(t,128,128,this._scene,!1,!1,2);r.name="SSAORandomTexture",r.wrapU=$.WRAP_ADDRESSMODE,r.wrapV=$.WRAP_ADDRESSMODE,this._randomTexture=r}_radicalInverseVdC(e){return this._bits[0]=e,this._bits[0]=(this._bits[0]<<16|this._bits[0]>>16)>>>0,this._bits[0]=(this._bits[0]&1431655765)<<1|(this._bits[0]&2863311530)>>>1>>>0,this._bits[0]=(this._bits[0]&858993459)<<2|(this._bits[0]&3435973836)>>>2>>>0,this._bits[0]=(this._bits[0]&252645135)<<4|(this._bits[0]&4042322160)>>>4>>>0,this._bits[0]=(this._bits[0]&16711935)<<8|(this._bits[0]&4278255360)>>>8>>>0,this._bits[0]*23283064365386963e-26}_hammersley(e,t){return[e/t,this._radicalInverseVdC(e)]}_hemisphereSampleUniform(e,t){const i=t*2*Math.PI,r=1-e*.85,n=Math.sqrt(1-r*r);return new x(Math.cos(i)*n,Math.sin(i)*n,r)}_generateHemisphere(){const e=this.samples,t=[];let i,r=0;for(;r<e;){if(e<16)i=this._hemisphereSampleUniform(Math.random(),Math.random());else{const n=this._hammersley(r,e);i=this._hemisphereSampleUniform(n[0],n[1])}t.push(i.x,i.y,i.z),r++}return t}_getDefinesForSSAO(){var t;let e=`#define SSAO
#define SAMPLES ${this.samples}
#define EPSILON ${this.epsilon.toFixed(4)}`;return((t=this.camera)==null?void 0:t.mode)===dt.ORTHOGRAPHIC_CAMERA&&(e+=`
#define ORTHOGRAPHIC_CAMERA`),e}}_r.ORTHO_DEPTH_PROJECTION=[1,0,0,0,1,0,0,0,1];_r.PERSPECTIVE_DEPTH_PROJECTION=[0,0,0,0,0,0,1,1,1];_r.FragmentUrl="ssao2";_r.Uniforms=["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","base","range","projection","near","texelSize","xViewport","yViewport","viewport","maxZ","minZAspect","depthProjection"];_r.Samplers=["randomSampler","depthSampler","normalSampler"];class Ss extends gt{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(U(()=>Promise.resolve().then(()=>dP),void 0))):t.push(U(()=>Promise.resolve().then(()=>uP),void 0))}constructor(e,t=null,i,r){super({...r,name:e,engine:t||ft.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Ss.FragmentUrl,uniforms:Ss.Uniforms,samplers:Ss.Samplers,defines:`#define BLUR
`+(i?`#define BLUR_H
`:"")}),this._bypassBlur=!1,this.textureSize=0,this.bilateralSamples=16,this.bilateralSoften=0,this.bilateralTolerance=0,this._expensiveBlur=!0,this._isHorizontal=i;const n=this._getDefinesForBlur(this.expensiveBlur,this.bypassBlur),a=this._getSamplersForBlur(this.bypassBlur);this.updateEffect(n,null,a)}set bypassBlur(e){const t=this._getDefinesForBlur(this.expensiveBlur,e),i=this._getSamplersForBlur(e);this.updateEffect(t,null,i),this._bypassBlur=e}get bypassBlur(){return this._bypassBlur}set expensiveBlur(e){const t=this._getDefinesForBlur(e,this._bypassBlur);this.updateEffect(t),this._expensiveBlur=e}get expensiveBlur(){return this._expensiveBlur}bind(e=!1){super.bind(e);const t=this._drawWrapper.effect;t.setFloat("outSize",this.textureSize),t.setInt("samples",this.bilateralSamples),t.setFloat("soften",this.bilateralSoften),t.setFloat("tolerance",this.bilateralTolerance)}_getSamplersForBlur(e){return e?["textureSampler"]:["textureSampler","depthSampler"]}_getDefinesForBlur(e,t){let i=`#define BLUR
`;return t&&(i+=`#define BLUR_BYPASS
`),e||(i+=`#define BLUR_LEGACY
`),this._isHorizontal?i+`#define BLUR_H
`:i}}Ss.FragmentUrl="ssao2";Ss.Uniforms=["outSize","samples","soften","tolerance"];Ss.Samplers=["textureSampler","depthSampler"];class pn extends gt{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(U(()=>Promise.resolve().then(()=>y$),void 0))):t.push(U(()=>Promise.resolve().then(()=>p$),void 0))}constructor(e,t=null,i){super({...i,name:e,engine:t||ft.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:pn.FragmentUrl,uniforms:pn.Uniforms,samplers:pn.Samplers}),this.camera=null,this.useViewportInCombineStage=!0}bind(e=!1){super.bind(e);const t=this._drawWrapper.effect;if(this.camera){const i=this.camera.viewport;this.useViewportInCombineStage?t.setVector4("viewport",G.Vector4[0].copyFromFloats(i.x,i.y,i.width,i.height)):t.setVector4("viewport",G.Vector4[0].copyFromFloats(0,0,1,1))}}}pn.FragmentUrl="ssaoCombine";pn.Uniforms=["viewport"];pn.Samplers=["originalColor"];class VR{get camera(){return this._ssaoPostProcess.camera}set camera(e){this._ssaoPostProcess.camera=e,this._ssaoCombinePostProcess.camera=e}set samples(e){this._ssaoPostProcess.samples=e}get samples(){return this._ssaoPostProcess.samples}get totalStrength(){return this._ssaoPostProcess.totalStrength}set totalStrength(e){this._ssaoPostProcess.totalStrength=e}get radius(){return this._ssaoPostProcess.radius}set radius(e){this._ssaoPostProcess.radius=e}get maxZ(){return this._ssaoPostProcess.maxZ}set maxZ(e){this._ssaoPostProcess.maxZ=e}get minZAspect(){return this._ssaoPostProcess.minZAspect}set minZAspect(e){this._ssaoPostProcess.minZAspect=e}get base(){return this._ssaoPostProcess.base}set base(e){this._ssaoPostProcess.base=e}get epsilon(){return this._ssaoPostProcess.epsilon}set epsilon(e){this._ssaoPostProcess.epsilon=e}set bypassBlur(e){this._ssaoBlurXPostProcess.bypassBlur=e,this._ssaoBlurYPostProcess.bypassBlur=e}get bypassBlur(){return this._ssaoBlurXPostProcess.bypassBlur}set expensiveBlur(e){this._ssaoBlurXPostProcess.expensiveBlur=e,this._ssaoBlurYPostProcess.expensiveBlur=e}get expensiveBlur(){return this._ssaoBlurXPostProcess.expensiveBlur}get bilateralSamples(){return this._ssaoBlurXPostProcess.bilateralSamples}set bilateralSamples(e){this._ssaoBlurXPostProcess.bilateralSamples=e,this._ssaoBlurYPostProcess.bilateralSamples=e}get bilateralSoften(){return this._ssaoBlurXPostProcess.bilateralSoften}set bilateralSoften(e){this._ssaoBlurXPostProcess.bilateralSoften=e,this._ssaoBlurYPostProcess.bilateralSoften=e}get bilateralTolerance(){return this._ssaoBlurXPostProcess.bilateralTolerance}set bilateralTolerance(e){this._ssaoBlurXPostProcess.bilateralTolerance=e,this._ssaoBlurYPostProcess.bilateralTolerance=e}get useViewportInCombineStage(){return this._ssaoCombinePostProcess.useViewportInCombineStage}set useViewportInCombineStage(e){this._ssaoCombinePostProcess.useViewportInCombineStage=e}isReady(){return this._ssaoPostProcess.isReady()&&this._ssaoBlurXPostProcess.isReady()&&this._ssaoBlurYPostProcess.isReady()&&this._ssaoCombinePostProcess.isReady()}constructor(e,t){this.name=e,this._scene=t,this._ssaoPostProcess=new _r(this.name,this._scene),this._ssaoBlurXPostProcess=new Ss(this.name+" BlurX",this._scene.getEngine(),!0),this._ssaoBlurYPostProcess=new Ss(this.name+" BlurY",this._scene.getEngine(),!1),this._ssaoCombinePostProcess=new pn(this.name+" Combiner",this._scene.getEngine())}dispose(){var e,t,i,r;(e=this._ssaoPostProcess)==null||e.dispose(),(t=this._ssaoBlurXPostProcess)==null||t.dispose(),(i=this._ssaoBlurYPostProcess)==null||i.dispose(),(r=this._ssaoCombinePostProcess)==null||r.dispose()}}class nV extends Bt{constructor(e,t,i){super(e,t,i||new _r(e,t.scene))}record(e=!1){if(this.sourceTexture===void 0||this.depthTexture===void 0||this.normalTexture===void 0||this.camera===void 0)throw new Error(`FrameGraphSSAO2Task "${this.name}": sourceTexture, depthTexture, normalTexture and camera are required`);const t=super.record(e,i=>{this.postProcess.camera=this.camera,i.setTextureSamplingMode(this.depthTexture,2),i.setTextureSamplingMode(this.normalTexture,2)},i=>{i.bindTextureHandle(this._postProcessDrawWrapper.effect,"depthSampler",this.depthTexture),i.bindTextureHandle(this._postProcessDrawWrapper.effect,"normalSampler",this.normalTexture)});return t.addDependencies([this.depthTexture]),this.postProcess.textureWidth=this._sourceWidth,this.postProcess.textureHeight=this._sourceHeight,t}}class Dv extends Bt{constructor(e,t,i,r){super(e,t,r||new Ss(e,t.engine,i)),this._isHorizontal=i}record(e=!1){if(this.sourceTexture===void 0||this.depthTexture===void 0)throw new Error(`FrameGraphSSAO2BlurTask "${this.name}": sourceTexture and depthTexture are required`);const t=super.record(e,i=>{i.setTextureSamplingMode(this.depthTexture,2)},i=>{i.bindTextureHandle(this._postProcessDrawWrapper.effect,"depthSampler",this.depthTexture)});return this.postProcess.textureSize=this._isHorizontal?this._outputWidth:this._outputHeight,t}}class Mv extends Br{get camera(){return this._camera}set camera(e){e!==this._camera&&(this._camera=e,this.ssao.camera=e)}get name(){return this._name}set name(e){this._name=e,this._ssao&&(this._ssao.name=`${e} SSAO2 main`),this._ssaoBlurX&&(this._ssaoBlurX.name=`${e} SSAO2 Blur X`),this._ssaoBlurY&&(this._ssaoBlurY.name=`${e} SSAO2 Blur Y`),this._ssaoCombine&&(this._ssaoCombine.name=`${e} SSAO2 Combine`)}constructor(e,t,i,r,n=0){super(e,t),this.sourceSamplingMode=2,this.ratioSSAO=i,this.ratioBlur=r,this.textureType=n,this.ssao=new VR(e,t.scene),this._ssao=new nV(`${e} SSAO2 main`,this._frameGraph,this.ssao._ssaoPostProcess),this._ssaoBlurX=new Dv(`${e} SSAO2 Blur X`,this._frameGraph,!0,this.ssao._ssaoBlurXPostProcess),this._ssaoBlurY=new Dv(`${e} SSAO2 Blur Y`,this._frameGraph,!1,this.ssao._ssaoBlurYPostProcess),this._ssaoCombine=new Bt(`${e} SSAO2 Combine`,this._frameGraph,this.ssao._ssaoCombinePostProcess),this.outputTexture=this._frameGraph.textureManager.createDanglingHandle()}isReady(){return this.ssao.isReady()}record(){if(this.sourceTexture===void 0||this.depthTexture===void 0||this.normalTexture===void 0||this.camera===void 0)throw new Error(`FrameGraphSSAO2RenderingPipelineTask "${this.name}": sourceTexture, depthTexture, normalTexture and camera are required`);const e=this._frameGraph.textureManager.getTextureDescription(this.sourceTexture);this._ssao.sourceTexture=this.sourceTexture,this._ssao.sourceSamplingMode=this.sourceSamplingMode,this._ssao.camera=this.camera,this._ssao.depthTexture=this.depthTexture,this._ssao.normalTexture=this.normalTexture;const t={width:Math.floor(e.size.width*this.ratioSSAO)||1,height:Math.floor(e.size.height*this.ratioSSAO)||1},i={size:t,options:{createMipMaps:!1,types:[this.textureType],formats:[5],samples:1,useSRGBBuffers:[!1],labels:[""]},sizeIsPercentage:!1},r=this._frameGraph.textureManager.createRenderTargetTexture(this._ssao.name,i);this._ssao.targetTexture=r,this._ssao.record(!0),t.width=Math.floor(e.size.width*this.ratioBlur)||1,t.height=Math.floor(e.size.height*this.ratioBlur)||1;const n=this._frameGraph.textureManager.getTextureCreationOptions(this.sourceTexture);this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture,this.name+" Output",n);const a=this._frameGraph.textureManager.createRenderTargetTexture(this._ssaoBlurX.name,i);this._ssaoBlurX.sourceTexture=r,this._ssaoBlurX.depthTexture=this.depthTexture,this._ssaoBlurX.sourceSamplingMode=2,this._ssaoBlurX.targetTexture=a,this._ssaoBlurX.record(!0);const o=this._frameGraph.textureManager.createRenderTargetTexture(this._ssaoBlurY.name,i);this._ssaoBlurY.sourceTexture=a,this._ssaoBlurY.depthTexture=this.depthTexture,this._ssaoBlurY.sourceSamplingMode=2,this._ssaoBlurY.targetTexture=o,this._ssaoBlurY.record(!0),this._ssaoCombine.sourceTexture=this.sourceTexture,this._ssaoCombine.sourceSamplingMode=this.sourceSamplingMode,this._ssaoCombine.targetTexture=this.outputTexture,this._ssaoCombine.record(!0,u=>{u.setTextureSamplingMode(this.sourceTexture,this.sourceSamplingMode),u.setTextureSamplingMode(o,2)},u=>{u.bindTextureHandle(this._ssaoCombine.drawWrapper.effect,"textureSampler",o),u.bindTextureHandle(this._ssaoCombine.drawWrapper.effect,"originalColor",this.sourceTexture)}).addDependencies(o);const c=this._frameGraph.addRenderPass(this.name+"_disabled",!0);c.addDependencies(this.sourceTexture),c.setRenderTarget(this.outputTexture),c.setExecuteFunc(u=>{u.copyTexture(this.sourceTexture)})}dispose(){this._ssao.dispose(),this._ssaoBlurX.dispose(),this._ssaoBlurY.dispose(),this._ssaoCombine.dispose(),this.ssao.dispose(),super.dispose()}}class zi extends ri{get task(){return this._frameGraphTask}constructor(e,t,i,r=1,n=1,a=0){super(e,t,i),this._additionalConstructionParameters=[r,n,a],this.registerInput("camera",H.Camera),this.registerInput("geomDepth",H.TextureViewDepth),this.registerInput("geomNormal",H.TextureViewNormal),this._finalizeInputOutputRegistering(),this._frameGraphTask=new Mv(this.name,t,r,n,a)}_createTask(e,t,i){const r=this.sourceSamplingMode,n=this.samples,a=this.totalStrength,o=this.base,l=this.maxZ,c=this.minZAspect,u=this.radius,h=this.epsilon,d=this.useViewportInCombineStage,f=this.bypassBlur,m=this.expensiveBlur,g=this.bilateralSoften,v=this.bilateralSamples,E=this.bilateralTolerance;this._frameGraphTask.dispose(),this._frameGraphTask=new Mv(this.name,this._frameGraph,e,t,i),this.sourceSamplingMode=r,this.samples=n,this.totalStrength=a,this.base=o,this.maxZ=l,this.minZAspect=c,this.radius=u,this.epsilon=h,this.useViewportInCombineStage=d,this.bypassBlur=f,this.expensiveBlur=m,this.bilateralSoften=g,this.bilateralSamples=v,this.bilateralTolerance=E,this._additionalConstructionParameters=[e,t,i]}get textureType(){return this._frameGraphTask.textureType}set textureType(e){this._createTask(this._frameGraphTask.ratioSSAO,this._frameGraphTask.ratioBlur,e)}get ratioSSAO(){return this._frameGraphTask.ratioSSAO}set ratioSSAO(e){this._createTask(e,this._frameGraphTask.ratioBlur,this._frameGraphTask.textureType)}get ratioBlur(){return this._frameGraphTask.ratioBlur}set ratioBlur(e){this._createTask(this._frameGraphTask.ratioSSAO,e,this._frameGraphTask.textureType)}get samples(){return this._frameGraphTask.ssao.samples}set samples(e){this._frameGraphTask.ssao.samples=e}get totalStrength(){return this._frameGraphTask.ssao.totalStrength}set totalStrength(e){this._frameGraphTask.ssao.totalStrength=e}get base(){return this._frameGraphTask.ssao.base}set base(e){this._frameGraphTask.ssao.base=e}get maxZ(){return this._frameGraphTask.ssao.maxZ}set maxZ(e){this._frameGraphTask.ssao.maxZ=e}get minZAspect(){return this._frameGraphTask.ssao.minZAspect}set minZAspect(e){this._frameGraphTask.ssao.minZAspect=e}get radius(){return this._frameGraphTask.ssao.radius}set radius(e){this._frameGraphTask.ssao.radius=e}get epsilon(){return this._frameGraphTask.ssao.epsilon}set epsilon(e){this._frameGraphTask.ssao.epsilon=e}get useViewportInCombineStage(){return this._frameGraphTask.ssao.useViewportInCombineStage}set useViewportInCombineStage(e){this._frameGraphTask.ssao.useViewportInCombineStage=e}get bypassBlur(){return this._frameGraphTask.ssao.bypassBlur}set bypassBlur(e){this._frameGraphTask.ssao.bypassBlur=e}get expensiveBlur(){return this._frameGraphTask.ssao.expensiveBlur}set expensiveBlur(e){this._frameGraphTask.ssao.expensiveBlur=e}get bilateralSamples(){return this._frameGraphTask.ssao.bilateralSamples}set bilateralSamples(e){this._frameGraphTask.ssao.bilateralSamples=e}get bilateralSoften(){return this._frameGraphTask.ssao.bilateralSoften}set bilateralSoften(e){this._frameGraphTask.ssao.bilateralSoften=e}get bilateralTolerance(){return this._frameGraphTask.ssao.bilateralTolerance}set bilateralTolerance(e){this._frameGraphTask.ssao.bilateralTolerance=e}getClassName(){return"NodeRenderGraphSSAO2PostProcessBlock"}get camera(){return this._inputs[2]}get geomDepth(){return this._inputs[3]}get geomNormal(){return this._inputs[4]}_buildBlock(e){var t,i,r;super._buildBlock(e),this._frameGraphTask.normalTexture=(t=this.geomNormal.connectedPoint)==null?void 0:t.value,this._frameGraphTask.depthTexture=(i=this.geomDepth.connectedPoint)==null?void 0:i.value,this._frameGraphTask.camera=(r=this.camera.connectedPoint)==null?void 0:r.value}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.samples = ${this.samples};`),e.push(`${this._codeVariableName}.totalStrength = ${this.totalStrength};`),e.push(`${this._codeVariableName}.base = ${this.base};`),e.push(`${this._codeVariableName}.maxZ = ${this.maxZ};`),e.push(`${this._codeVariableName}.minZAspect = ${this.minZAspect};`),e.push(`${this._codeVariableName}.radius = ${this.radius};`),e.push(`${this._codeVariableName}.epsilon = ${this.epsilon};`),e.push(`${this._codeVariableName}.useViewportInCombineStage = ${this.useViewportInCombineStage};`),e.push(`${this._codeVariableName}.bypassBlur = ${this.bypassBlur};`),e.push(`${this._codeVariableName}.expensiveBlur = ${this.expensiveBlur};`),e.push(`${this._codeVariableName}.bilateralSamples = ${this.bilateralSamples};`),e.push(`${this._codeVariableName}.bilateralSoften = ${this.bilateralSoften};`),e.push(`${this._codeVariableName}.bilateralTolerance = ${this.bilateralTolerance};`),super._dumpPropertiesCode()+e.join(`
`)}serialize(){const e=super.serialize();return e.samples=this.samples,e.totalStrength=this.totalStrength,e.base=this.base,e.maxZ=this.maxZ,e.minZAspect=this.minZAspect,e.radius=this.radius,e.epsilon=this.epsilon,e.useViewportInCombineStage=this.useViewportInCombineStage,e.bypassBlur=this.bypassBlur,e.expensiveBlur=this.expensiveBlur,e.bilateralSoften=this.bilateralSoften,e.bilateralSamples=this.bilateralSamples,e.bilateralTolerance=this.bilateralTolerance,e}_deserialize(e){super._deserialize(e),this.samples=e.samples,this.totalStrength=e.totalStrength,this.base=e.base,this.maxZ=e.maxZ,this.minZAspect=e.minZAspect,this.radius=e.radius,this.epsilon=e.epsilon,this.useViewportInCombineStage=e.useViewportInCombineStage,this.bypassBlur=e.bypassBlur,this.expensiveBlur=e.expensiveBlur,this.bilateralSoften=e.bilateralSoften,this.bilateralSamples=e.bilateralSamples,this.bilateralTolerance=e.bilateralTolerance}}_([O("Texture type",9,"TEXTURE")],zi.prototype,"textureType",null);_([O("SSAO texture ratio",1,"TEXTURE",{min:.1,max:1})],zi.prototype,"ratioSSAO",null);_([O("SSAO blur texture ratio",1,"TEXTURE",{min:.1,max:1})],zi.prototype,"ratioBlur",null);_([O("Samples",2,"SSAO",{min:1,max:128})],zi.prototype,"samples",null);_([O("Strength",1,"SSAO",{min:0,max:3})],zi.prototype,"totalStrength",null);_([O("Base",1,"SSAO",{min:0,max:1})],zi.prototype,"base",null);_([O("Max Z",1,"SSAO",{min:0,max:1e4})],zi.prototype,"maxZ",null);_([O("Min Z aspect",1,"SSAO",{min:0,max:.5})],zi.prototype,"minZAspect",null);_([O("Radius",1,"SSAO",{min:0,max:10})],zi.prototype,"radius",null);_([O("Epsilon",1,"SSAO",{min:0,max:1})],zi.prototype,"epsilon",null);_([O("Use viewport in combine stage",0,"SSAO")],zi.prototype,"useViewportInCombineStage",null);_([O("Bypass blur",0,"Blur")],zi.prototype,"bypassBlur",null);_([O("Expensive blur",0,"Blur")],zi.prototype,"expensiveBlur",null);_([O("Samples",2,"Blur",{min:1,max:128})],zi.prototype,"bilateralSamples",null);_([O("Soften",1,"Blur",{min:0,max:1})],zi.prototype,"bilateralSoften",null);_([O("Tolerance",1,"Blur",{min:0,max:1})],zi.prototype,"bilateralTolerance",null);y("BABYLON.NodeRenderGraphSSAO2PostProcessBlock",zi);const aV=z.Compose(new x(.5,.5,.5),Z.Identity(),new x(.5,.5,.5)),oV=z.Compose(new x(.5,.5,1),Z.Identity(),new x(.5,.5,0));class Jr extends gt{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(U(()=>Promise.resolve().then(()=>L$),void 0))):t.push(U(()=>Promise.resolve().then(()=>A$),void 0))}get reflectivityThreshold(){return this._reflectivityThreshold}set reflectivityThreshold(e){e!==this._reflectivityThreshold&&(e===0&&this._reflectivityThreshold!==0||e!==0&&this._reflectivityThreshold===0?(this._reflectivityThreshold=e,this._updateEffectDefines()):this._reflectivityThreshold=e)}get useBlur(){return this._useBlur}set useBlur(e){this._useBlur!==e&&(this._useBlur=e,this._updateEffectDefines())}get enableSmoothReflections(){return this._enableSmoothReflections}set enableSmoothReflections(e){e!==this._enableSmoothReflections&&(this._enableSmoothReflections=e,this._updateEffectDefines())}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e,this._updateEffectDefines()}get environmentTextureIsProbe(){return this._environmentTextureIsProbe}set environmentTextureIsProbe(e){this._environmentTextureIsProbe=e,this._updateEffectDefines()}get attenuateScreenBorders(){return this._attenuateScreenBorders}set attenuateScreenBorders(e){this._attenuateScreenBorders!==e&&(this._attenuateScreenBorders=e,this._updateEffectDefines())}get attenuateIntersectionDistance(){return this._attenuateIntersectionDistance}set attenuateIntersectionDistance(e){this._attenuateIntersectionDistance!==e&&(this._attenuateIntersectionDistance=e,this._updateEffectDefines())}get attenuateIntersectionIterations(){return this._attenuateIntersectionIterations}set attenuateIntersectionIterations(e){this._attenuateIntersectionIterations!==e&&(this._attenuateIntersectionIterations=e,this._updateEffectDefines())}get attenuateFacingCamera(){return this._attenuateFacingCamera}set attenuateFacingCamera(e){this._attenuateFacingCamera!==e&&(this._attenuateFacingCamera=e,this._updateEffectDefines())}get attenuateBackfaceReflection(){return this._attenuateBackfaceReflection}set attenuateBackfaceReflection(e){this._attenuateBackfaceReflection!==e&&(this._attenuateBackfaceReflection=e,this._updateEffectDefines())}get clipToFrustum(){return this._clipToFrustum}set clipToFrustum(e){this._clipToFrustum!==e&&(this._clipToFrustum=e,this._updateEffectDefines())}get useFresnel(){return this._useFresnel}set useFresnel(e){this._useFresnel!==e&&(this._useFresnel=e,this._updateEffectDefines())}get enableAutomaticThicknessComputation(){return this._enableAutomaticThicknessComputation}set enableAutomaticThicknessComputation(e){this._enableAutomaticThicknessComputation!==e&&(this._enableAutomaticThicknessComputation=e,this._updateEffectDefines())}get inputTextureColorIsInGammaSpace(){return this._inputTextureColorIsInGammaSpace}set inputTextureColorIsInGammaSpace(e){this._inputTextureColorIsInGammaSpace!==e&&(this._inputTextureColorIsInGammaSpace=e,this._updateEffectDefines())}get generateOutputInGammaSpace(){return this._generateOutputInGammaSpace}set generateOutputInGammaSpace(e){this._generateOutputInGammaSpace!==e&&(this._generateOutputInGammaSpace=e,this._updateEffectDefines())}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,this._updateEffectDefines())}get textureWidth(){return this._textureWidth}set textureWidth(e){this._textureWidth!==e&&(this._textureWidth=e)}get textureHeight(){return this._textureHeight}set textureHeight(e){this._textureHeight!==e&&(this._textureHeight=e)}get useScreenspaceDepth(){return this._useScreenspaceDepth}set useScreenspaceDepth(e){this._useScreenspaceDepth!==e&&(this._useScreenspaceDepth=e,this._updateEffectDefines())}get normalsAreInWorldSpace(){return this._normalsAreInWorldSpace}set normalsAreInWorldSpace(e){this._normalsAreInWorldSpace!==e&&(this._normalsAreInWorldSpace=e,this._updateEffectDefines())}get normalsAreUnsigned(){return this._normalsAreUnsigned}set normalsAreUnsigned(e){this._normalsAreUnsigned!==e&&(this._normalsAreUnsigned=e,this._updateEffectDefines())}constructor(e,t,i){super({...i,name:e,engine:t.getEngine(),useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Jr.FragmentUrl,uniforms:Jr.Uniforms,samplers:Jr.Samplers,shaderLanguage:t.getEngine().isWebGPU?1:0}),this.isSSRSupported=!0,this.maxDistance=1e3,this.step=1,this.thickness=.5,this.strength=1,this.reflectionSpecularFalloffExponent=1,this.maxSteps=1e3,this.roughnessFactor=.2,this.selfCollisionNumSkip=1,this._reflectivityThreshold=.04,this._useBlur=!1,this._enableSmoothReflections=!1,this._environmentTextureIsProbe=!1,this._attenuateScreenBorders=!0,this._attenuateIntersectionDistance=!0,this._attenuateIntersectionIterations=!0,this._attenuateFacingCamera=!1,this._attenuateBackfaceReflection=!1,this._clipToFrustum=!0,this._useFresnel=!1,this._enableAutomaticThicknessComputation=!1,this._inputTextureColorIsInGammaSpace=!0,this._generateOutputInGammaSpace=!0,this._debug=!1,this._textureWidth=0,this._textureHeight=0,this.camera=null,this._useScreenspaceDepth=!1,this._normalsAreInWorldSpace=!1,this._normalsAreUnsigned=!1,this._scene=t,this._updateEffectDefines()}bind(e=!1){super.bind(e);const t=this._drawWrapper.effect,i=this.camera;if(!i)return;const r=i.getViewMatrix(),n=i.getProjectionMatrix();n.invertToRef(G.Matrix[0]),r.invertToRef(G.Matrix[1]),t.setMatrix("projection",n),t.setMatrix("view",r),t.setMatrix("invView",G.Matrix[1]),t.setMatrix("invProjectionMatrix",G.Matrix[0]),t.setFloat("thickness",this.thickness),t.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),t.setFloat("strength",this.strength),t.setFloat("stepSize",this.step),t.setFloat("maxSteps",this.maxSteps),t.setFloat("roughnessFactor",this.roughnessFactor),t.setFloat("nearPlaneZ",i.minZ),t.setFloat("farPlaneZ",i.maxZ),t.setFloat("maxDistance",this.maxDistance),t.setFloat("selfCollisionNumSkip",this.selfCollisionNumSkip),t.setFloat("reflectivityThreshold",this._reflectivityThreshold),z.ScalingToRef(this.textureWidth,this.textureHeight,1,G.Matrix[2]),n.multiplyToRef(this._scene.getEngine().isWebGPU?oV:aV,G.Matrix[3]),G.Matrix[3].multiplyToRef(G.Matrix[2],G.Matrix[4]),t.setMatrix("projectionPixel",G.Matrix[4]),this._environmentTexture&&(t.setTexture("envCubeSampler",this._environmentTexture),this._environmentTexture.boundingBoxSize&&(t.setVector3("vReflectionPosition",this._environmentTexture.boundingBoxPosition),t.setVector3("vReflectionSize",this._environmentTexture.boundingBoxSize)))}_updateEffectDefines(){const e=[];this.isSSRSupported&&e.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&e.push("#define SSRAYTRACE_ENABLE_REFINEMENT"),this._scene.useRightHandedSystem&&e.push("#define SSRAYTRACE_RIGHT_HANDED_SCENE"),this._useScreenspaceDepth&&e.push("#define SSRAYTRACE_SCREENSPACE_DEPTH"),this._environmentTexture&&(e.push("#define SSR_USE_ENVIRONMENT_CUBE"),this._environmentTexture.boundingBoxSize&&e.push("#define SSR_USE_LOCAL_REFLECTIONMAP_CUBIC"),this._environmentTexture.gammaSpace&&e.push("#define SSR_ENVIRONMENT_CUBE_IS_GAMMASPACE")),this._environmentTextureIsProbe&&e.push("#define SSR_INVERTCUBICMAP"),this._enableAutomaticThicknessComputation&&e.push("#define SSRAYTRACE_USE_BACK_DEPTHBUFFER"),this._attenuateScreenBorders&&e.push("#define SSR_ATTENUATE_SCREEN_BORDERS"),this._attenuateIntersectionDistance&&e.push("#define SSR_ATTENUATE_INTERSECTION_DISTANCE"),this._attenuateIntersectionIterations&&e.push("#define SSR_ATTENUATE_INTERSECTION_NUMITERATIONS"),this._attenuateFacingCamera&&e.push("#define SSR_ATTENUATE_FACING_CAMERA"),this._attenuateBackfaceReflection&&e.push("#define SSR_ATTENUATE_BACKFACE_REFLECTION"),this._clipToFrustum&&e.push("#define SSRAYTRACE_CLIP_TO_FRUSTUM"),this.useBlur&&e.push("#define SSR_USE_BLUR"),this._debug&&e.push("#define SSRAYTRACE_DEBUG"),this._inputTextureColorIsInGammaSpace&&e.push("#define SSR_INPUT_IS_GAMMA_SPACE"),this._generateOutputInGammaSpace&&e.push("#define SSR_OUTPUT_IS_GAMMA_SPACE"),this._useFresnel&&e.push("#define SSR_BLEND_WITH_FRESNEL"),this._reflectivityThreshold===0&&e.push("#define SSR_DISABLE_REFLECTIVITY_TEST"),this._normalsAreInWorldSpace&&e.push("#define SSR_NORMAL_IS_IN_WORLDSPACE"),this._normalsAreUnsigned&&e.push("#define SSR_DECODE_NORMAL"),this.camera&&this.camera.mode===1&&e.push("#define ORTHOGRAPHIC_CAMERA"),this.updateEffect(e.join(`
`))}}Jr.FragmentUrl="screenSpaceReflection2";Jr.Uniforms=["projection","invProjectionMatrix","view","invView","thickness","reflectionSpecularFalloffExponent","strength","stepSize","maxSteps","roughnessFactor","projectionPixel","nearPlaneZ","farPlaneZ","maxDistance","selfCollisionNumSkip","vReflectionPosition","vReflectionSize","backSizeFactor","reflectivityThreshold"];Jr.Samplers=["textureSampler","normalSampler","reflectivitySampler","depthSampler","envCubeSampler","backDepthSampler"];class Yi extends gt{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(U(()=>Promise.resolve().then(()=>B$),void 0))):t.push(U(()=>Promise.resolve().then(()=>O$),void 0))}constructor(e,t=null,i,r,n){super({...n,name:e,engine:t||ft.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Yi.FragmentUrl,uniforms:Yi.Uniforms,samplers:Yi.Samplers}),this.textureWidth=0,this.textureHeight=0,this.direction=new X(1,0),this.blurStrength=.03,i!==void 0&&(this.direction=i),r!==void 0&&(this.blurStrength=r)}bind(e=!1){super.bind(e),this._drawWrapper.effect.setFloat2("texelOffsetScale",1/this.textureWidth*this.direction.x*this.blurStrength,1/this.textureHeight*this.direction.y*this.blurStrength)}}Yi.FragmentUrl="screenSpaceReflection2Blur";Yi.Uniforms=["texelOffsetScale"];Yi.Samplers=["textureSampler"];class vs extends gt{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(U(()=>Promise.resolve().then(()=>U$),void 0))):t.push(U(()=>Promise.resolve().then(()=>D$),void 0))}constructor(e,t=null,i){super({...i,name:e,engine:t||ft.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:vs.FragmentUrl,uniforms:vs.Uniforms,samplers:vs.Samplers}),this.strength=1,this.reflectionSpecularFalloffExponent=1,this.camera=null,this._useFresnel=!1,this._useScreenspaceDepth=!1,this._inputTextureColorIsInGammaSpace=!0,this._generateOutputInGammaSpace=!0,this._debug=!1,this._reflectivityThreshold=.04,this._normalsAreInWorldSpace=!1,this._normalsAreUnsigned=!1,this._updateEffectDefines()}get useFresnel(){return this._useFresnel}set useFresnel(e){this._useFresnel!==e&&(this._useFresnel=e,this._updateEffectDefines())}get useScreenspaceDepth(){return this._useScreenspaceDepth}set useScreenspaceDepth(e){this._useScreenspaceDepth!==e&&(this._useScreenspaceDepth=e,this._updateEffectDefines())}get inputTextureColorIsInGammaSpace(){return this._inputTextureColorIsInGammaSpace}set inputTextureColorIsInGammaSpace(e){this._inputTextureColorIsInGammaSpace!==e&&(this._inputTextureColorIsInGammaSpace=e,this._updateEffectDefines())}get generateOutputInGammaSpace(){return this._generateOutputInGammaSpace}set generateOutputInGammaSpace(e){this._generateOutputInGammaSpace!==e&&(this._generateOutputInGammaSpace=e,this._updateEffectDefines())}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,this._updateEffectDefines())}get reflectivityThreshold(){return this._reflectivityThreshold}set reflectivityThreshold(e){e!==this._reflectivityThreshold&&(e===0&&this._reflectivityThreshold!==0||e!==0&&this._reflectivityThreshold===0?(this._reflectivityThreshold=e,this._updateEffectDefines()):this._reflectivityThreshold=e)}get normalsAreInWorldSpace(){return this._normalsAreInWorldSpace}set normalsAreInWorldSpace(e){this._normalsAreInWorldSpace!==e&&(this._normalsAreInWorldSpace=e,this._updateEffectDefines())}get normalsAreUnsigned(){return this._normalsAreUnsigned}set normalsAreUnsigned(e){this._normalsAreUnsigned!==e&&(this._normalsAreUnsigned=e,this._updateEffectDefines())}bind(e=!1){super.bind(e);const t=this._drawWrapper.effect;if(t.setFloat("strength",this.strength),t.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),t.setFloat("reflectivityThreshold",this.reflectivityThreshold),this.useFresnel&&this.camera){const i=this.camera.getProjectionMatrix();i.invertToRef(G.Matrix[0]),t.setMatrix("projection",i),t.setMatrix("invProjectionMatrix",G.Matrix[0]),t.setMatrix("view",this.camera.getViewMatrix()),this.useScreenspaceDepth&&(t.setFloat("nearPlaneZ",this.camera.minZ),t.setFloat("farPlaneZ",this.camera.maxZ))}}_updateEffectDefines(){let e="";this._debug&&(e+=`#define SSRAYTRACE_DEBUG
`),this._inputTextureColorIsInGammaSpace&&(e+=`#define SSR_INPUT_IS_GAMMA_SPACE
`),this._generateOutputInGammaSpace&&(e+=`#define SSR_OUTPUT_IS_GAMMA_SPACE
`),this._useFresnel&&(e+=`#define SSR_BLEND_WITH_FRESNEL
`),this._useScreenspaceDepth&&(e+=`#define SSRAYTRACE_SCREENSPACE_DEPTH
`),this._reflectivityThreshold===0&&(e+=`#define SSR_DISABLE_REFLECTIVITY_TEST
`),this._normalsAreInWorldSpace&&(e+=`#define SSR_NORMAL_IS_IN_WORLDSPACE
`),this._normalsAreUnsigned&&(e+=`#define SSR_DECODE_NORMAL
`),this.updateEffect(e)}}vs.FragmentUrl="screenSpaceReflection2BlurCombiner";vs.Uniforms=["strength","reflectionSpecularFalloffExponent","reflectivityThreshold","projection","invProjectionMatrix","nearPlaneZ","farPlaneZ","view"];vs.Samplers=["textureSampler","depthSampler","normalSampler","mainSampler","reflectivitySampler"];class UR{get isSSRSupported(){return this._ssrPostProcess.isSSRSupported}set isSSRSupported(e){this._ssrPostProcess.isSSRSupported=e}get maxDistance(){return this._ssrPostProcess.maxDistance}set maxDistance(e){this._ssrPostProcess.maxDistance=e}get step(){return this._ssrPostProcess.step}set step(e){this._ssrPostProcess.step=e}get thickness(){return this._ssrPostProcess.thickness}set thickness(e){this._ssrPostProcess.thickness=e}get strength(){return this._ssrPostProcess.strength}set strength(e){this._ssrPostProcess.strength=e,this._ssrBlurCombinerPostProcess.strength=e}get reflectionSpecularFalloffExponent(){return this._ssrPostProcess.reflectionSpecularFalloffExponent}set reflectionSpecularFalloffExponent(e){this._ssrPostProcess.reflectionSpecularFalloffExponent=e,this._ssrBlurCombinerPostProcess.reflectionSpecularFalloffExponent=e}get maxSteps(){return this._ssrPostProcess.maxSteps}set maxSteps(e){this._ssrPostProcess.maxSteps=e}get roughnessFactor(){return this._ssrPostProcess.roughnessFactor}set roughnessFactor(e){this._ssrPostProcess.roughnessFactor=e}get selfCollisionNumSkip(){return this._ssrPostProcess.selfCollisionNumSkip}set selfCollisionNumSkip(e){this._ssrPostProcess.selfCollisionNumSkip=e}get reflectivityThreshold(){return this._ssrPostProcess.reflectivityThreshold}set reflectivityThreshold(e){const t=this._ssrPostProcess.reflectivityThreshold;e!==t&&(this._ssrPostProcess.reflectivityThreshold=e,this._ssrBlurCombinerPostProcess.reflectivityThreshold=e)}get blurDispersionStrength(){return this._ssrBlurXPostProcess.blurStrength}set blurDispersionStrength(e){e!==this._ssrBlurXPostProcess.blurStrength&&(this._ssrPostProcess.useBlur=e>0,this._ssrBlurXPostProcess.blurStrength=e,this._ssrBlurYPostProcess.blurStrength=e)}get enableSmoothReflections(){return this._ssrPostProcess.enableSmoothReflections}set enableSmoothReflections(e){this._ssrPostProcess.enableSmoothReflections=e}get environmentTexture(){return this._ssrPostProcess.environmentTexture}set environmentTexture(e){this._ssrPostProcess.environmentTexture=e}get environmentTextureIsProbe(){return this._ssrPostProcess.environmentTextureIsProbe}set environmentTextureIsProbe(e){this._ssrPostProcess.environmentTextureIsProbe=e}get attenuateScreenBorders(){return this._ssrPostProcess.attenuateScreenBorders}set attenuateScreenBorders(e){this._ssrPostProcess.attenuateScreenBorders=e}get attenuateIntersectionDistance(){return this._ssrPostProcess.attenuateIntersectionDistance}set attenuateIntersectionDistance(e){this._ssrPostProcess.attenuateIntersectionDistance=e}get attenuateIntersectionIterations(){return this._ssrPostProcess.attenuateIntersectionIterations}set attenuateIntersectionIterations(e){this._ssrPostProcess.attenuateIntersectionIterations=e}get attenuateFacingCamera(){return this._ssrPostProcess.attenuateFacingCamera}set attenuateFacingCamera(e){this._ssrPostProcess.attenuateFacingCamera=e}get attenuateBackfaceReflection(){return this._ssrPostProcess.attenuateBackfaceReflection}set attenuateBackfaceReflection(e){this._ssrPostProcess.attenuateBackfaceReflection=e}get clipToFrustum(){return this._ssrPostProcess.clipToFrustum}set clipToFrustum(e){this._ssrPostProcess.clipToFrustum=e}get useFresnel(){return this._ssrPostProcess.useFresnel}set useFresnel(e){this._ssrPostProcess.useFresnel=e,this._ssrBlurCombinerPostProcess.useFresnel=e}get enableAutomaticThicknessComputation(){return this._ssrPostProcess.enableAutomaticThicknessComputation}set enableAutomaticThicknessComputation(e){this._ssrPostProcess.enableAutomaticThicknessComputation!==e&&(this._ssrPostProcess.enableAutomaticThicknessComputation=e)}get inputTextureColorIsInGammaSpace(){return this._ssrPostProcess.inputTextureColorIsInGammaSpace}set inputTextureColorIsInGammaSpace(e){this._ssrPostProcess.inputTextureColorIsInGammaSpace!==e&&(this._ssrPostProcess.inputTextureColorIsInGammaSpace=e,this._ssrBlurCombinerPostProcess.inputTextureColorIsInGammaSpace=e)}get generateOutputInGammaSpace(){return this._ssrPostProcess.generateOutputInGammaSpace}set generateOutputInGammaSpace(e){this._ssrPostProcess.generateOutputInGammaSpace!==e&&(this._ssrPostProcess.generateOutputInGammaSpace=e,this._ssrBlurCombinerPostProcess.generateOutputInGammaSpace=e)}get debug(){return this._ssrPostProcess.debug}set debug(e){this._ssrPostProcess.debug!==e&&(this._ssrPostProcess.debug=e,this._ssrBlurCombinerPostProcess.debug=e)}get camera(){return this._ssrPostProcess.camera}set camera(e){this._ssrPostProcess.camera=e,this._ssrBlurCombinerPostProcess.camera=e}get useScreenspaceDepth(){return this._ssrPostProcess.useScreenspaceDepth}set useScreenspaceDepth(e){this._ssrPostProcess.useScreenspaceDepth=e,this._ssrBlurCombinerPostProcess.useScreenspaceDepth=e}get normalsAreInWorldSpace(){return this._ssrPostProcess.normalsAreInWorldSpace}set normalsAreInWorldSpace(e){this._ssrPostProcess.normalsAreInWorldSpace=e,this._ssrBlurCombinerPostProcess.normalsAreInWorldSpace=e}get normalsAreUnsigned(){return this._ssrPostProcess.normalsAreUnsigned}set normalsAreUnsigned(e){this._ssrPostProcess.normalsAreUnsigned=e,this._ssrBlurCombinerPostProcess.normalsAreUnsigned=e}isReady(){return this._ssrPostProcess.isReady()&&this._ssrBlurXPostProcess.isReady()&&this._ssrBlurYPostProcess.isReady()&&this._ssrBlurCombinerPostProcess.isReady()}constructor(e,t){this.ssrDownsample=0,this.blurDownsample=0,this.name=e,this._scene=t,this._ssrPostProcess=new Jr(this.name,this._scene),this._ssrBlurXPostProcess=new Yi(this.name+" BlurX",this._scene.getEngine(),new X(1,0)),this._ssrBlurYPostProcess=new Yi(this.name+" BlurY",this._scene.getEngine(),new X(0,1)),this._ssrBlurCombinerPostProcess=new vs(this.name+" BlurCombiner",this._scene.getEngine()),this._ssrPostProcess.useBlur=this._ssrBlurXPostProcess.blurStrength>0}dispose(){var e,t,i,r;(e=this._ssrPostProcess)==null||e.dispose(),(t=this._ssrBlurXPostProcess)==null||t.dispose(),(i=this._ssrBlurYPostProcess)==null||i.dispose(),(r=this._ssrBlurCombinerPostProcess)==null||r.dispose()}}class lV extends Bt{constructor(e,t,i){super(e,t,i||new Jr(e,t.scene))}record(e=!1){if(this.sourceTexture===void 0||this.normalTexture===void 0||this.depthTexture===void 0||this.reflectivityTexture===void 0||this.camera===void 0)throw new Error(`FrameGraphSSRTask "${this.name}": sourceTexture, normalTexture, depthTexture, reflectivityTexture and camera are required`);const t=super.record(e,i=>{this.postProcess.camera=this.camera,i.setTextureSamplingMode(this.normalTexture,2),i.setTextureSamplingMode(this.depthTexture,2),i.setTextureSamplingMode(this.reflectivityTexture,2),this.backDepthTexture&&i.setTextureSamplingMode(this.backDepthTexture,1)},i=>{i.bindTextureHandle(this._postProcessDrawWrapper.effect,"normalSampler",this.normalTexture),i.bindTextureHandle(this._postProcessDrawWrapper.effect,"depthSampler",this.depthTexture),i.bindTextureHandle(this._postProcessDrawWrapper.effect,"reflectivitySampler",this.reflectivityTexture),this.backDepthTexture&&i.bindTextureHandle(this._postProcessDrawWrapper.effect,"backDepthSampler",this.backDepthTexture),this.postProcess.enableAutomaticThicknessComputation&&this._postProcessDrawWrapper.effect.setFloat("backSizeFactor",1)});return t.addDependencies([this.normalTexture,this.depthTexture,this.reflectivityTexture]),this.postProcess.textureWidth=this._sourceWidth,this.postProcess.textureHeight=this._sourceHeight,t}}class Fv extends Bt{constructor(e,t,i){super(e,t,i||new Yi(e,t.engine,new X(1,0),.03))}record(e=!1,t,i){const r=super.record(e,t,i);return this.postProcess.textureWidth=this._sourceWidth,this.postProcess.textureHeight=this._sourceHeight,r}}class Lv extends Br{get camera(){return this._camera}set camera(e){e!==this._camera&&(this._camera=e,this.ssr.camera=e)}get name(){return this._name}set name(e){this._name=e,this._ssr&&(this._ssr.name=`${e} SSR main`),this._ssrBlurX&&(this._ssrBlurX.name=`${e} SSR Blur X`),this._ssrBlurY&&(this._ssrBlurY.name=`${e} SSR Blur Y`),this._ssrBlurCombiner&&(this._ssrBlurCombiner.name=`${e} SSR Blur Combiner`)}constructor(e,t,i=0){super(e,t),this.sourceSamplingMode=2,this.textureType=i,this.ssr=new UR(e,t.scene),this._ssr=new lV(`${e} SSR main`,this._frameGraph,this.ssr._ssrPostProcess),this._ssrBlurX=new Fv(`${e} SSR Blur X`,this._frameGraph,this.ssr._ssrBlurXPostProcess),this._ssrBlurY=new Fv(`${e} SSR Blur Y`,this._frameGraph,this.ssr._ssrBlurYPostProcess),this._ssrBlurCombiner=new Bt(`${e} SSR Blur Combiner`,this._frameGraph,this.ssr._ssrBlurCombinerPostProcess),this.outputTexture=this._frameGraph.textureManager.createDanglingHandle()}isReady(){return this.ssr.isReady()}record(){if(this.sourceTexture===void 0||this.normalTexture===void 0||this.depthTexture===void 0||this.reflectivityTexture===void 0||this.camera===void 0)throw new Error(`FrameGraphSSRRenderingPipelineTask "${this.name}": sourceTexture, normalTexture, depthTexture, reflectivityTexture and camera are required`);const e=this._frameGraph.textureManager.getTextureDescription(this.sourceTexture);this._ssr.sourceTexture=this.sourceTexture,this._ssr.sourceSamplingMode=this.sourceSamplingMode,this._ssr.camera=this.camera,this._ssr.normalTexture=this.normalTexture,this._ssr.depthTexture=this.depthTexture,this._ssr.backDepthTexture=this.backDepthTexture,this._ssr.reflectivityTexture=this.reflectivityTexture;let t;const i={width:Math.floor(e.size.width/(this.ssr.ssrDownsample+1))||1,height:Math.floor(e.size.height/(this.ssr.ssrDownsample+1))||1},r={size:i,options:{createMipMaps:!1,types:[this.textureType],formats:[5],samples:1,useSRGBBuffers:[!1],labels:[""]},sizeIsPercentage:!1};if((this.ssr.blurDispersionStrength>0||!this.targetTexture)&&(t=this._frameGraph.textureManager.createRenderTargetTexture(this._ssr.name,r)),this.ssr.blurDispersionStrength===0)this._ssr.targetTexture=this.outputTexture,t!==void 0?this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,t):this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture),this._ssr.record(!0);else{this._ssr.targetTexture=t,this._ssr.record(!0),i.width=Math.floor(e.size.width/(this.ssr.blurDownsample+1))||1,i.height=Math.floor(e.size.height/(this.ssr.blurDownsample+1))||1;const a=this._frameGraph.textureManager.getTextureCreationOptions(this.sourceTexture);this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture,this.name+" Output",a);const o=this._frameGraph.textureManager.createRenderTargetTexture(this._ssrBlurX.name,r);this._ssrBlurX.sourceTexture=t,this._ssrBlurX.sourceSamplingMode=2,this._ssrBlurX.targetTexture=o,this._ssrBlurX.record(!0);const l=this._frameGraph.textureManager.createRenderTargetTexture(this._ssrBlurY.name,r);this._ssrBlurY.sourceTexture=o,this._ssrBlurY.sourceSamplingMode=2,this._ssrBlurY.targetTexture=l,this._ssrBlurY.record(!0),this._ssrBlurCombiner.sourceTexture=this.sourceTexture,this._ssrBlurCombiner.sourceSamplingMode=this.sourceSamplingMode,this._ssrBlurCombiner.targetTexture=this.outputTexture,this._ssrBlurCombiner.record(!0,void 0,u=>{u.bindTextureHandle(this._ssrBlurCombiner.drawWrapper.effect,"mainSampler",this.sourceTexture),u.bindTextureHandle(this._ssrBlurCombiner.drawWrapper.effect,"textureSampler",l),u.bindTextureHandle(this._ssrBlurCombiner.drawWrapper.effect,"reflectivitySampler",this.reflectivityTexture),this.ssr.useFresnel&&(u.bindTextureHandle(this._ssrBlurCombiner.drawWrapper.effect,"normalSampler",this.normalTexture),u.bindTextureHandle(this._ssrBlurCombiner.drawWrapper.effect,"depthSampler",this.depthTexture))}).addDependencies(l)}const n=this._frameGraph.addRenderPass(this.name+"_disabled",!0);n.addDependencies(this.sourceTexture),n.setRenderTarget(this.outputTexture),n.setExecuteFunc(a=>{a.copyTexture(this.sourceTexture)})}dispose(){this._ssr.dispose(),this._ssrBlurX.dispose(),this._ssrBlurY.dispose(),this._ssrBlurCombiner.dispose(),this.ssr.dispose(),super.dispose()}}class zt extends ri{get task(){return this._frameGraphTask}constructor(e,t,i,r=0){super(e,t,i),this._additionalConstructionParameters=[r],this.registerInput("camera",H.Camera),this.registerInput("geomDepth",H.AutoDetect),this.registerInput("geomNormal",H.AutoDetect),this.registerInput("geomReflectivity",H.TextureReflectivity),this.registerInput("geomBackDepth",H.AutoDetect,!0),this.geomNormal.addExcludedConnectionPointFromAllowedTypes(H.TextureWorldNormal|H.TextureViewNormal),this.geomDepth.addExcludedConnectionPointFromAllowedTypes(H.TextureScreenDepth|H.TextureViewDepth),this.geomBackDepth.addExcludedConnectionPointFromAllowedTypes(H.TextureScreenDepth|H.TextureViewDepth),this._finalizeInputOutputRegistering(),this._frameGraphTask=new Lv(this.name,t,r)}_createTask(e){const t=this.sourceSamplingMode,i=this.maxDistance,r=this.step,n=this.thickness,a=this.strength,o=this.reflectionSpecularFalloffExponent,l=this.maxSteps,c=this.roughnessFactor,u=this.selfCollisionNumSkip,h=this.reflectivityThreshold,d=this.ssrDownsample,f=this.blurDispersionStrength,m=this.blurDownsample,g=this.enableSmoothReflections,v=this.attenuateScreenBorders,E=this.attenuateIntersectionDistance,T=this.attenuateIntersectionIterations,C=this.attenuateFacingCamera,A=this.attenuateBackfaceReflection,I=this.clipToFrustum,F=this.enableAutomaticThicknessComputation,V=this.useFresnel,D=this.inputTextureColorIsInGammaSpace,w=this.generateOutputInGammaSpace,B=this.debug;this._frameGraphTask.dispose(),this._frameGraphTask=new Lv(this.name,this._frameGraph,e),this.sourceSamplingMode=t,this.maxDistance=i,this.step=r,this.thickness=n,this.strength=a,this.reflectionSpecularFalloffExponent=o,this.maxSteps=l,this.roughnessFactor=c,this.selfCollisionNumSkip=u,this.reflectivityThreshold=h,this.ssrDownsample=d,this.blurDispersionStrength=f,this.blurDownsample=m,this.enableSmoothReflections=g,this.attenuateScreenBorders=v,this.attenuateIntersectionDistance=E,this.attenuateIntersectionIterations=T,this.attenuateFacingCamera=C,this.attenuateBackfaceReflection=A,this.clipToFrustum=I,this.useFresnel=V,this.enableAutomaticThicknessComputation=F,this.inputTextureColorIsInGammaSpace=D,this.generateOutputInGammaSpace=w,this.debug=B,this._additionalConstructionParameters=[e]}get textureType(){return this._frameGraphTask.textureType}set textureType(e){this._createTask(e)}get debug(){return this._frameGraphTask.ssr.debug}set debug(e){this._frameGraphTask.ssr.debug=e}get strength(){return this._frameGraphTask.ssr.strength}set strength(e){this._frameGraphTask.ssr.strength=e}get reflectionSpecularFalloffExponent(){return this._frameGraphTask.ssr.reflectionSpecularFalloffExponent}set reflectionSpecularFalloffExponent(e){this._frameGraphTask.ssr.reflectionSpecularFalloffExponent=e}get reflectivityThreshold(){return this._frameGraphTask.ssr.reflectivityThreshold}set reflectivityThreshold(e){this._frameGraphTask.ssr.reflectivityThreshold=e}get thickness(){return this._frameGraphTask.ssr.thickness}set thickness(e){this._frameGraphTask.ssr.thickness=e}get step(){return this._frameGraphTask.ssr.step}set step(e){this._frameGraphTask.ssr.step=e}get enableSmoothReflections(){return this._frameGraphTask.ssr.enableSmoothReflections}set enableSmoothReflections(e){this._frameGraphTask.ssr.enableSmoothReflections=e}get maxSteps(){return this._frameGraphTask.ssr.maxSteps}set maxSteps(e){this._frameGraphTask.ssr.maxSteps=e}get maxDistance(){return this._frameGraphTask.ssr.maxDistance}set maxDistance(e){this._frameGraphTask.ssr.maxDistance=e}get roughnessFactor(){return this._frameGraphTask.ssr.roughnessFactor}set roughnessFactor(e){this._frameGraphTask.ssr.roughnessFactor=e}get selfCollisionNumSkip(){return this._frameGraphTask.ssr.selfCollisionNumSkip}set selfCollisionNumSkip(e){this._frameGraphTask.ssr.selfCollisionNumSkip=e}get ssrDownsample(){return this._frameGraphTask.ssr.ssrDownsample}set ssrDownsample(e){this._frameGraphTask.ssr.ssrDownsample=e}get clipToFrustum(){return this._frameGraphTask.ssr.clipToFrustum}set clipToFrustum(e){this._frameGraphTask.ssr.clipToFrustum=e}get enableAutomaticThicknessComputation(){return this._frameGraphTask.ssr.enableAutomaticThicknessComputation}set enableAutomaticThicknessComputation(e){this._frameGraphTask.ssr.enableAutomaticThicknessComputation=e}get useFresnel(){return this._frameGraphTask.ssr.useFresnel}set useFresnel(e){this._frameGraphTask.ssr.useFresnel=e}get blurDispersionStrength(){return this._frameGraphTask.ssr.blurDispersionStrength}set blurDispersionStrength(e){this._frameGraphTask.ssr.blurDispersionStrength=e}get blurDownsample(){return this._frameGraphTask.ssr.blurDownsample}set blurDownsample(e){this._frameGraphTask.ssr.blurDownsample=e}get attenuateScreenBorders(){return this._frameGraphTask.ssr.attenuateScreenBorders}set attenuateScreenBorders(e){this._frameGraphTask.ssr.attenuateScreenBorders=e}get attenuateIntersectionDistance(){return this._frameGraphTask.ssr.attenuateIntersectionDistance}set attenuateIntersectionDistance(e){this._frameGraphTask.ssr.attenuateIntersectionDistance=e}get attenuateIntersectionIterations(){return this._frameGraphTask.ssr.attenuateIntersectionIterations}set attenuateIntersectionIterations(e){this._frameGraphTask.ssr.attenuateIntersectionIterations=e}get attenuateFacingCamera(){return this._frameGraphTask.ssr.attenuateFacingCamera}set attenuateFacingCamera(e){this._frameGraphTask.ssr.attenuateFacingCamera=e}get attenuateBackfaceReflection(){return this._frameGraphTask.ssr.attenuateBackfaceReflection}set attenuateBackfaceReflection(e){this._frameGraphTask.ssr.attenuateBackfaceReflection=e}get inputTextureColorIsInGammaSpace(){return this._frameGraphTask.ssr.inputTextureColorIsInGammaSpace}set inputTextureColorIsInGammaSpace(e){this._frameGraphTask.ssr.inputTextureColorIsInGammaSpace=e}get generateOutputInGammaSpace(){return this._frameGraphTask.ssr.generateOutputInGammaSpace}set generateOutputInGammaSpace(e){this._frameGraphTask.ssr.generateOutputInGammaSpace=e}getClassName(){return"NodeRenderGraphSSRPostProcessBlock"}get camera(){return this._inputs[2]}get geomDepth(){return this._inputs[3]}get geomNormal(){return this._inputs[4]}get geomReflectivity(){return this._inputs[5]}get geomBackDepth(){return this._inputs[6]}_buildBlock(e){var t,i,r,n,a;if(super._buildBlock(e),this._frameGraphTask.normalTexture=(t=this.geomNormal.connectedPoint)==null?void 0:t.value,this._frameGraphTask.depthTexture=(i=this.geomDepth.connectedPoint)==null?void 0:i.value,this._frameGraphTask.reflectivityTexture=(r=this.geomReflectivity.connectedPoint)==null?void 0:r.value,this._frameGraphTask.backDepthTexture=(n=this.geomBackDepth.connectedPoint)==null?void 0:n.value,this._frameGraphTask.camera=(a=this.camera.connectedPoint)==null?void 0:a.value,this.enableAutomaticThicknessComputation){if(!this._frameGraphTask.backDepthTexture)throw new Error(`SSR post process "${this.name}": Automatic thickness computation requires a back depth texture to be connected!`);const o=this.geomBackDepth.connectedPoint.ownerBlock;if(o.getClassName()==="NodeRenderGraphGeometryRendererBlock"){if(!o.reverseCulling)throw new Error(`SSR post process "${this.name}": Automatic thickness computation requires the geometry renderer block for the back depth texture to have reverse culling enabled!`);if(this._frameGraphTask.depthTexture&&this.geomDepth.connectedPoint.ownerBlock.getClassName()==="NodeRenderGraphGeometryRendererBlock"){const u=this.geomDepth.connectedPoint.type,h=this.geomBackDepth.connectedPoint.type;if(u!==h)throw new Error(`SSR post process "${this.name}": Automatic thickness computation requires that geomDepth and geomBackDepth have the same type (view or screen space depth)!`)}}}this.geomNormal.connectedPoint&&this.geomNormal.connectedPoint.type===H.TextureWorldNormal&&(this._frameGraphTask.ssr.normalsAreInWorldSpace=!0,this._frameGraphTask.ssr.normalsAreUnsigned=!0),this.geomDepth.connectedPoint&&this.geomDepth.connectedPoint.type===H.TextureScreenDepth&&(this._frameGraphTask.ssr.useScreenspaceDepth=!0)}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.debug = ${this.debug};`),e.push(`${this._codeVariableName}.strength = ${this.strength};`),e.push(`${this._codeVariableName}.reflectionSpecularFalloffExponent = ${this.reflectionSpecularFalloffExponent};`),e.push(`${this._codeVariableName}.reflectivityThreshold = ${this.reflectivityThreshold};`),e.push(`${this._codeVariableName}.thickness = ${this.thickness};`),e.push(`${this._codeVariableName}.step = ${this.step};`),e.push(`${this._codeVariableName}.enableSmoothReflections = ${this.enableSmoothReflections};`),e.push(`${this._codeVariableName}.maxSteps = ${this.maxSteps};`),e.push(`${this._codeVariableName}.maxDistance = ${this.maxDistance};`),e.push(`${this._codeVariableName}.roughnessFactor = ${this.roughnessFactor};`),e.push(`${this._codeVariableName}.selfCollisionNumSkip = ${this.selfCollisionNumSkip};`),e.push(`${this._codeVariableName}.ssrDownsample = ${this.ssrDownsample};`),e.push(`${this._codeVariableName}.clipToFrustum = ${this.clipToFrustum};`),e.push(`${this._codeVariableName}.useFresnel = ${this.useFresnel};`),e.push(`${this._codeVariableName}.enableAutomaticThicknessComputation = ${this.enableAutomaticThicknessComputation};`),e.push(`${this._codeVariableName}.blurDispersionStrength = ${this.blurDispersionStrength};`),e.push(`${this._codeVariableName}.blurDownsample = ${this.blurDownsample};`),e.push(`${this._codeVariableName}.attenuateScreenBorders = ${this.attenuateScreenBorders};`),e.push(`${this._codeVariableName}.attenuateIntersectionDistance = ${this.attenuateIntersectionDistance};`),e.push(`${this._codeVariableName}.attenuateIntersectionIterations = ${this.attenuateIntersectionIterations};`),e.push(`${this._codeVariableName}.attenuateFacingCamera = ${this.attenuateFacingCamera};`),e.push(`${this._codeVariableName}.attenuateBackfaceReflection = ${this.attenuateBackfaceReflection};`),e.push(`${this._codeVariableName}.inputTextureColorIsInGammaSpace = ${this.inputTextureColorIsInGammaSpace};`),e.push(`${this._codeVariableName}.generateOutputInGammaSpace = ${this.generateOutputInGammaSpace};`),super._dumpPropertiesCode()+e.join(`
`)}serialize(){const e=super.serialize();return e.debug=this.debug,e.strength=this.strength,e.reflectionSpecularFalloffExponent=this.reflectionSpecularFalloffExponent,e.reflectivityThreshold=this.reflectivityThreshold,e.thickness=this.thickness,e.step=this.step,e.enableSmoothReflections=this.enableSmoothReflections,e.maxSteps=this.maxSteps,e.maxDistance=this.maxDistance,e.roughnessFactor=this.roughnessFactor,e.selfCollisionNumSkip=this.selfCollisionNumSkip,e.ssrDownsample=this.ssrDownsample,e.clipToFrustum=this.clipToFrustum,e.useFresnel=this.useFresnel,e.enableAutomaticThicknessComputation=this.enableAutomaticThicknessComputation,e.blurDispersionStrength=this.blurDispersionStrength,e.blurDownsample=this.blurDownsample,e.attenuateScreenBorders=this.attenuateScreenBorders,e.attenuateIntersectionDistance=this.attenuateIntersectionDistance,e.attenuateIntersectionIterations=this.attenuateIntersectionIterations,e.attenuateFacingCamera=this.attenuateFacingCamera,e.attenuateBackfaceReflection=this.attenuateBackfaceReflection,e.inputTextureColorIsInGammaSpace=this.inputTextureColorIsInGammaSpace,e.generateOutputInGammaSpace=this.generateOutputInGammaSpace,e}_deserialize(e){super._deserialize(e),this.debug=e.debug,this.strength=e.strength,this.reflectionSpecularFalloffExponent=e.reflectionSpecularFalloffExponent,this.reflectivityThreshold=e.reflectivityThreshold,this.thickness=e.thickness,this.step=e.step,this.enableSmoothReflections=e.enableSmoothReflections,this.maxSteps=e.maxSteps,this.maxDistance=e.maxDistance,this.roughnessFactor=e.roughnessFactor,this.selfCollisionNumSkip=e.selfCollisionNumSkip,this.ssrDownsample=e.ssrDownsample,this.clipToFrustum=e.clipToFrustum,this.useFresnel=e.useFresnel,this.enableAutomaticThicknessComputation=e.enableAutomaticThicknessComputation,this.blurDispersionStrength=e.blurDispersionStrength,this.blurDownsample=e.blurDownsample,this.attenuateScreenBorders=e.attenuateScreenBorders,this.attenuateIntersectionDistance=e.attenuateIntersectionDistance,this.attenuateIntersectionIterations=e.attenuateIntersectionIterations,this.attenuateFacingCamera=e.attenuateFacingCamera,this.attenuateBackfaceReflection=e.attenuateBackfaceReflection,this.inputTextureColorIsInGammaSpace=e.inputTextureColorIsInGammaSpace,this.generateOutputInGammaSpace=e.generateOutputInGammaSpace}}_([O("Texture type",9,"SSR")],zt.prototype,"textureType",null);_([O("Debug",0,"SSR")],zt.prototype,"debug",null);_([O("Strength",1,"SSR",{min:0,max:5})],zt.prototype,"strength",null);_([O("Reflection exponent",1,"SSR",{min:0,max:5})],zt.prototype,"reflectionSpecularFalloffExponent",null);_([O("Reflectivity threshold",1,"SSR",{min:0,max:1})],zt.prototype,"reflectivityThreshold",null);_([O("Thickness",1,"SSR",{min:0,max:10})],zt.prototype,"thickness",null);_([O("Step",2,"SSR",{min:1,max:50})],zt.prototype,"step",null);_([O("Smooth reflections",0,"SSR")],zt.prototype,"enableSmoothReflections",null);_([O("Max steps",2,"SSR",{min:1,max:3e3})],zt.prototype,"maxSteps",null);_([O("Max distance",1,"SSR",{min:1,max:3e3})],zt.prototype,"maxDistance",null);_([O("Roughness factor",1,"SSR",{min:0,max:1})],zt.prototype,"roughnessFactor",null);_([O("Self collision skips",2,"SSR",{min:1,max:10})],zt.prototype,"selfCollisionNumSkip",null);_([O("SSR downsample",2,"SSR",{min:0,max:5})],zt.prototype,"ssrDownsample",null);_([O("Clip to frustum",0,"SSR")],zt.prototype,"clipToFrustum",null);_([O("Automatic thickness computation",0,"SSR")],zt.prototype,"enableAutomaticThicknessComputation",null);_([O("Use Fresnel",0,"SSR")],zt.prototype,"useFresnel",null);_([O("Strength",1,"Blur",{min:0,max:.15})],zt.prototype,"blurDispersionStrength",null);_([O("Blur downsample",2,"Blur",{min:0,max:5})],zt.prototype,"blurDownsample",null);_([O("Screen borders",0,"Attenuations")],zt.prototype,"attenuateScreenBorders",null);_([O("Distance",0,"Attenuations")],zt.prototype,"attenuateIntersectionDistance",null);_([O("Step iterations",0,"Attenuations")],zt.prototype,"attenuateIntersectionIterations",null);_([O("Facing camera",0,"Attenuations")],zt.prototype,"attenuateFacingCamera",null);_([O("Backface reflections",0,"Attenuations")],zt.prototype,"attenuateBackfaceReflection",null);_([O("Input is in gamma space",0,"Color space")],zt.prototype,"inputTextureColorIsInGammaSpace",null);_([O("Output to gamma space",0,"Color space")],zt.prototype,"generateOutputInGammaSpace",null);y("BABYLON.NodeRenderGraphSSRPostProcessBlock",zt);var wv;(function(s){s[s.Hable=0]="Hable",s[s.Reinhard=1]="Reinhard",s[s.HejiDawson=2]="HejiDawson",s[s.Photographic=3]="Photographic"})(wv||(wv={}));class xs extends gt{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(U(()=>Promise.resolve().then(()=>p5),void 0))):t.push(U(()=>Promise.resolve().then(()=>d5),void 0))}constructor(e,t=null,i){const r=(i==null?void 0:i.operator)??1;let n="#define ";r===0?n+="HABLE_TONEMAPPING":r===1?n+="REINHARD_TONEMAPPING":r===2?n+="OPTIMIZED_HEJIDAWSON_TONEMAPPING":r===3&&(n+="PHOTOGRAPHIC_TONEMAPPING"),super({...i,name:e,engine:t||ft.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:xs.FragmentUrl,uniforms:xs.Uniforms,defines:n}),this.operator=1,this.exposureAdjustment=1,this.operator=r,this.exposureAdjustment=(i==null?void 0:i.exposureAdjustment)??1}bind(e=!1){super.bind(e),this._drawWrapper.effect.setFloat("_ExposureAdjustment",this.exposureAdjustment)}}xs.FragmentUrl="tonemap";xs.Uniforms=["_ExposureAdjustment"];class Bv extends Bt{constructor(e,t,i){super(e,t,i||new xs(e,t.engine))}}class y_ extends ri{get task(){return this._frameGraphTask}constructor(e,t,i,r=1){super(e,t,i),this._additionalConstructionParameters=[r],this._finalizeInputOutputRegistering(),this._frameGraphTask=new Bv(this.name,t,new xs(e,t.engine,{operator:r}))}_createTask(e){const t=this._frameGraphTask.sourceSamplingMode,i=this._frameGraphTask.postProcess.exposureAdjustment;this._frameGraphTask.dispose(),this._frameGraphTask=new Bv(this.name,this._frameGraph,new xs(this.name,this._frameGraph.engine,{operator:e})),this._frameGraphTask.sourceSamplingMode=t,this._frameGraphTask.postProcess.exposureAdjustment=i,this._additionalConstructionParameters=[e]}get operator(){return this._frameGraphTask.postProcess.operator}set operator(e){this._createTask(e)}get exposureAdjustment(){return this._frameGraphTask.postProcess.exposureAdjustment}set exposureAdjustment(e){this._frameGraphTask.postProcess.exposureAdjustment=e}getClassName(){return"NodeRenderGraphTonemapPostProcessBlock"}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.exposureAdjustment = ${this.exposureAdjustment};`),super._dumpPropertiesCode()+e.join(`
`)}serialize(){const e=super.serialize();return e.exposureAdjustment=this.exposureAdjustment,e}_deserialize(e){super._deserialize(e),this.exposureAdjustment=e.exposureAdjustment}}_([O("Operator",5,"PROPERTIES",{options:[{label:"Hable",value:0},{label:"Reinhard",value:1},{label:"HejiDawson",value:2},{label:"Photographic",value:3}]})],y_.prototype,"operator",null);_([O("Exposure adjustment",1,"PROPERTIES")],y_.prototype,"exposureAdjustment",null);y("BABYLON.NodeRenderGraphTonemapPostProcessBlock",y_);class Ur extends Di{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("light",H.ShadowLight),this.registerInput("objects",H.ObjectList),this.registerInput("camera",H.Camera)}_finalizeInputOutputRegistering(){this._addDependenciesInput(),this.registerOutput("generator",H.ShadowGenerator),this.registerOutput("output",H.Texture)}get mapSize(){return this._frameGraphTask.mapSize}set mapSize(e){this._frameGraphTask.mapSize=e}get useFloat32TextureType(){return this._frameGraphTask.useFloat32TextureType}set useFloat32TextureType(e){this._frameGraphTask.useFloat32TextureType=e}get useRedTextureFormat(){return this._frameGraphTask.useRedTextureFormat}set useRedTextureFormat(e){this._frameGraphTask.useRedTextureFormat=e}get bias(){return this._frameGraphTask.bias}set bias(e){this._frameGraphTask.bias=e}get normalBias(){return this._frameGraphTask.normalBias}set normalBias(e){this._frameGraphTask.normalBias=e}get darkness(){return this._frameGraphTask.darkness}set darkness(e){this._frameGraphTask.darkness=e}get filter(){return this._frameGraphTask.filter}set filter(e){this._frameGraphTask.filter=e}get filteringQuality(){return this._frameGraphTask.filteringQuality}set filteringQuality(e){this._frameGraphTask.filteringQuality=e}get transparencyShadow(){return this._frameGraphTask.transparencyShadow}set transparencyShadow(e){this._frameGraphTask.transparencyShadow=e}get enableSoftTransparentShadow(){return this._frameGraphTask.enableSoftTransparentShadow}set enableSoftTransparentShadow(e){this._frameGraphTask.enableSoftTransparentShadow=e}get useOpacityTextureForTransparentShadow(){return this._frameGraphTask.useOpacityTextureForTransparentShadow}set useOpacityTextureForTransparentShadow(e){this._frameGraphTask.useOpacityTextureForTransparentShadow=e}getClassName(){return"NodeRenderGraphBaseShadowGeneratorBlock"}get light(){return this._inputs[0]}get objects(){return this._inputs[1]}get camera(){return this._inputs[2]}get generator(){return this._outputs[0]}get output(){return this._outputs[1]}_buildBlock(e){var t,i,r;super._buildBlock(e),this._frameGraphTask.light=(t=this.light.connectedPoint)==null?void 0:t.value,this._frameGraphTask.objectList=(i=this.objects.connectedPoint)==null?void 0:i.value,this._frameGraphTask.camera=(r=this.camera.connectedPoint)==null?void 0:r.value,this.generator.value=this._frameGraphTask,this.output.value=this._frameGraphTask.outputTexture}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.mapSize = ${this.mapSize};`),e.push(`${this._codeVariableName}.useFloat32TextureType = ${this.useFloat32TextureType};`),e.push(`${this._codeVariableName}.useRedTextureFormat = ${this.useRedTextureFormat};`),e.push(`${this._codeVariableName}.bias = ${this.bias};`),e.push(`${this._codeVariableName}.normalBias = ${this.normalBias};`),e.push(`${this._codeVariableName}.darkness = ${this.darkness};`),e.push(`${this._codeVariableName}.filter = ${this.filter};`),e.push(`${this._codeVariableName}.filteringQuality = ${this.filteringQuality};`),e.push(`${this._codeVariableName}.transparencyShadow = ${this.transparencyShadow};`),e.push(`${this._codeVariableName}.enableSoftTransparentShadow = ${this.enableSoftTransparentShadow};`),e.push(`${this._codeVariableName}.useOpacityTextureForTransparentShadow = ${this.useOpacityTextureForTransparentShadow};`),super._dumpPropertiesCode()+e.join(`
`)}serialize(){const e=super.serialize();return e.mapSize=this.mapSize,e.useFloat32TextureType=this.useFloat32TextureType,e.useRedTextureFormat=this.useRedTextureFormat,e.bias=this.bias,e.normalBias=this.normalBias,e.darkness=this.darkness,e.filter=this.filter,e.filteringQuality=this.filteringQuality,e.transparencyShadow=this.transparencyShadow,e.enableSoftTransparentShadow=this.enableSoftTransparentShadow,e.useOpacityTextureForTransparentShadow=this.useOpacityTextureForTransparentShadow,e}_deserialize(e){super._deserialize(e),this.mapSize=e.mapSize,this.useFloat32TextureType=e.useFloat32TextureType,this.useRedTextureFormat=e.useRedTextureFormat,this.bias=e.bias,this.normalBias=e.normalBias,this.darkness=e.darkness,this.filter=e.filter,this.filteringQuality=e.filteringQuality,this.transparencyShadow=e.transparencyShadow,this.enableSoftTransparentShadow=e.enableSoftTransparentShadow,this.useOpacityTextureForTransparentShadow=e.useOpacityTextureForTransparentShadow}}_([O("Map size",5,"PROPERTIES",{options:[{label:"128",value:128},{label:"256",value:256},{label:"512",value:512},{label:"1024",value:1024},{label:"2048",value:2048},{label:"4096",value:4096},{label:"8192",value:8192}]})],Ur.prototype,"mapSize",null);_([O("Use 32 bits float texture type",0,"PROPERTIES")],Ur.prototype,"useFloat32TextureType",null);_([O("Use red texture format",0,"PROPERTIES")],Ur.prototype,"useRedTextureFormat",null);_([O("Bias",1,"PROPERTIES",{min:0,max:1})],Ur.prototype,"bias",null);_([O("Normal bias",1,"PROPERTIES",{min:0,max:1})],Ur.prototype,"normalBias",null);_([O("Darkness",1,"PROPERTIES",{min:0,max:1})],Ur.prototype,"darkness",null);_([O("Filter",5,"PROPERTIES",{options:[{label:"None",value:Ar.FILTER_NONE},{label:"Exponential",value:Ar.FILTER_EXPONENTIALSHADOWMAP},{label:"Poisson Sampling",value:Ar.FILTER_POISSONSAMPLING},{label:"Blur exponential",value:Ar.FILTER_BLUREXPONENTIALSHADOWMAP},{label:"Close exponential",value:Ar.FILTER_CLOSEEXPONENTIALSHADOWMAP},{label:"Blur close exponential",value:Ar.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP},{label:"PCF",value:Ar.FILTER_PCF},{label:"PCSS",value:Ar.FILTER_PCSS}]})],Ur.prototype,"filter",null);_([O("Filter quality",5,"PROPERTIES",{options:[{label:"Low",value:Ar.QUALITY_LOW},{label:"Medium",value:Ar.QUALITY_MEDIUM},{label:"High",value:Ar.QUALITY_HIGH}]})],Ur.prototype,"filteringQuality",null);_([O("Transparency shadow",0,"PROPERTIES")],Ur.prototype,"transparencyShadow",null);_([O("Enable soft transparent shadows",0,"PROPERTIES")],Ur.prototype,"enableSoftTransparentShadow",null);_([O("Use opacity texture for transparent shadows",0,"PROPERTIES")],Ur.prototype,"useOpacityTextureForTransparentShadow",null);class js extends Ur{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("geomDepth",H.AutoDetect,!0),this.geomDepth.addExcludedConnectionPointFromAllowedTypes(H.TextureNormalizedViewDepth|H.TextureViewDepth|H.TextureScreenDepth),this._finalizeInputOutputRegistering(),this._frameGraphTask=new bD(this.name,t,i)}get numCascades(){return this._frameGraphTask.numCascades}set numCascades(e){this._frameGraphTask.numCascades=e}get debug(){return this._frameGraphTask.debug}set debug(e){this._frameGraphTask.debug=e}get stabilizeCascades(){return this._frameGraphTask.stabilizeCascades}set stabilizeCascades(e){this._frameGraphTask.stabilizeCascades=e}get lambda(){return this._frameGraphTask.lambda}set lambda(e){this._frameGraphTask.lambda=e}get cascadeBlendPercentage(){return this._frameGraphTask.cascadeBlendPercentage}set cascadeBlendPercentage(e){this._frameGraphTask.cascadeBlendPercentage=e}get depthClamp(){return this._frameGraphTask.depthClamp}set depthClamp(e){this._frameGraphTask.depthClamp=e}get autoCalcDepthBounds(){return this._frameGraphTask.autoCalcDepthBounds}set autoCalcDepthBounds(e){this._frameGraphTask.autoCalcDepthBounds=e}get autoCalcDepthBoundsRefreshRate(){return this._frameGraphTask.autoCalcDepthBoundsRefreshRate}set autoCalcDepthBoundsRefreshRate(e){this._frameGraphTask.autoCalcDepthBoundsRefreshRate=e}get shadowMaxZ(){return this._frameGraphTask.shadowMaxZ}set shadowMaxZ(e){this._frameGraphTask.shadowMaxZ=e}getClassName(){return"NodeRenderGraphCascadedShadowGeneratorBlock"}get geomDepth(){return this._inputs[3]}_buildBlock(e){var t;if(super._buildBlock(e),this._frameGraphTask.depthTexture=(t=this.geomDepth.connectedPoint)==null?void 0:t.value,this.geomDepth.connectedPoint)switch(this.geomDepth.connectedPoint.type){case H.TextureScreenDepth:this._frameGraphTask.depthTextureType=2;break;case H.TextureNormalizedViewDepth:this._frameGraphTask.depthTextureType=0;break;case H.TextureViewDepth:this._frameGraphTask.depthTextureType=1;break}}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.numCascades = ${this.numCascades};`),e.push(`${this._codeVariableName}.debug = ${this.debug};`),e.push(`${this._codeVariableName}.stabilizeCascades = ${this.stabilizeCascades};`),e.push(`${this._codeVariableName}.lambda = ${this.lambda};`),e.push(`${this._codeVariableName}.cascadeBlendPercentage = ${this.cascadeBlendPercentage};`),e.push(`${this._codeVariableName}.depthClamp = ${this.depthClamp};`),e.push(`${this._codeVariableName}.autoCalcDepthBounds = ${this.autoCalcDepthBounds};`),e.push(`${this._codeVariableName}.autoCalcDepthBoundsRefreshRate = ${this.autoCalcDepthBoundsRefreshRate};`),e.push(`${this._codeVariableName}.shadowMaxZ = ${this.shadowMaxZ};`),super._dumpPropertiesCode()+e.join(`
`)}serialize(){const e=super.serialize();return e.numCascades=this.numCascades,e.debug=this.debug,e.stabilizeCascades=this.stabilizeCascades,e.lambda=this.lambda,e.cascadeBlendPercentage=this.cascadeBlendPercentage,e.depthClamp=this.depthClamp,e.autoCalcDepthBounds=this.autoCalcDepthBounds,e.autoCalcDepthBoundsRefreshRate=this.autoCalcDepthBoundsRefreshRate,e.shadowMaxZ=this.shadowMaxZ,e}_deserialize(e){super._deserialize(e),this.numCascades=e.numCascades,this.debug=e.debug,this.stabilizeCascades=e.stabilizeCascades,this.lambda=e.lambda,this.cascadeBlendPercentage=e.cascadeBlendPercentage,this.depthClamp=e.depthClamp,this.autoCalcDepthBounds=e.autoCalcDepthBounds,this.autoCalcDepthBoundsRefreshRate=e.autoCalcDepthBoundsRefreshRate??1,this.shadowMaxZ=e.shadowMaxZ}}_([O("Number of cascades",5,"CSM PROPERTIES",{options:[{label:"2",value:2},{label:"3",value:3},{label:"4",value:4}]})],js.prototype,"numCascades",null);_([O("Debug mode",0,"CSM PROPERTIES")],js.prototype,"debug",null);_([O("Stabilize cascades",0,"CSM PROPERTIES")],js.prototype,"stabilizeCascades",null);_([O("Lambda",1,"CSM PROPERTIES",{min:0,max:1})],js.prototype,"lambda",null);_([O("Cascade blend",1,"CSM PROPERTIES",{min:0,max:1})],js.prototype,"cascadeBlendPercentage",null);_([O("Depth clamp",0,"CSM PROPERTIES")],js.prototype,"depthClamp",null);_([O("Auto-Calc depth bounds",0,"CSM PROPERTIES")],js.prototype,"autoCalcDepthBounds",null);_([O("Auto-Calc depth bounds refresh rate",2,"CSM PROPERTIES")],js.prototype,"autoCalcDepthBoundsRefreshRate",null);_([O("Shadow maxZ",1,"CSM PROPERTIES")],js.prototype,"shadowMaxZ",null);y("BABYLON.NodeRenderGraphCascadedShadowGeneratorBlock",js);class St extends Di{get task(){return this._frameGraphTask}constructor(e,t,i,r=!0,n=!0){super(e,t,i),this.viewDepthFormat=6,this.viewDepthType=1,this.normalizedViewDepthFormat=6,this.normalizedViewDepthType=2,this.screenDepthFormat=6,this.screenDepthType=1,this.viewNormalFormat=5,this.viewNormalType=2,this.worldNormalFormat=5,this.worldNormalType=0,this.localPositionFormat=5,this.localPositionType=2,this.worldPositionFormat=5,this.worldPositionType=2,this.albedoFormat=5,this.albedoType=0,this.reflectivityFormat=5,this.reflectivityType=0,this.velocityFormat=5,this.velocityType=0,this.linearVelocityFormat=5,this.linearVelocityType=0,this._additionalConstructionParameters=[r,n],this.registerInput("depth",H.AutoDetect,!0),this.registerInput("camera",H.Camera),this.registerInput("objects",H.ObjectList),this._addDependenciesInput(),this.registerOutput("outputDepth",H.BasedOnInput),this.registerOutput("geomViewDepth",H.TextureViewDepth),this.registerOutput("geomNormViewDepth",H.TextureNormalizedViewDepth),this.registerOutput("geomScreenDepth",H.TextureScreenDepth),this.registerOutput("geomViewNormal",H.TextureViewNormal),this.registerOutput("geomWorldNormal",H.TextureWorldNormal),this.registerOutput("geomLocalPosition",H.TextureLocalPosition),this.registerOutput("geomWorldPosition",H.TextureWorldPosition),this.registerOutput("geomAlbedo",H.TextureAlbedo),this.registerOutput("geomReflectivity",H.TextureReflectivity),this.registerOutput("geomVelocity",H.TextureVelocity),this.registerOutput("geomLinearVelocity",H.TextureLinearVelocity),this.depth.addExcludedConnectionPointFromAllowedTypes(H.TextureDepthStencilAttachment|H.TextureBackBufferDepthStencilAttachment),this.outputDepth._typeConnectionSource=this.depth,this._frameGraphTask=new _d(this.name,t,i,{doNotChangeAspectRatio:r,enableClusteredLights:n})}get depthTest(){return this._frameGraphTask.depthTest}set depthTest(e){this._frameGraphTask.depthTest=e}get depthWrite(){return this._frameGraphTask.depthWrite}set depthWrite(e){this._frameGraphTask.depthWrite=e}get forceLayerMaskCheck(){return this._frameGraphTask.forceLayerMaskCheck}set forceLayerMaskCheck(e){this._frameGraphTask.forceLayerMaskCheck=e}_recreateFrameGraphObject(e,t){const i=this._frameGraphTask.disabled,r=this.depthTest,n=this.depthWrite,a=this.width,o=this.height,l=this.forceLayerMaskCheck,c=this.sizeInPercentage,u=this.samples,h=this.reverseCulling,d=this.dontRenderWhenMaterialDepthWriteIsDisabled;this._frameGraphTask.dispose(),this._frameGraphTask=new _d(this.name,this._frameGraph,this._scene,{doNotChangeAspectRatio:e,enableClusteredLights:t}),this._additionalConstructionParameters=[e,t],this.depthTest=r,this.depthWrite=n,this.width=a,this.height=o,this.forceLayerMaskCheck=l,this.sizeInPercentage=c,this.samples=u,this.reverseCulling=h,this.dontRenderWhenMaterialDepthWriteIsDisabled=d,this._frameGraphTask.disabled=i}get doNotChangeAspectRatio(){return this._frameGraphTask.objectRenderer.options.doNotChangeAspectRatio}set doNotChangeAspectRatio(e){this._recreateFrameGraphObject(e,this.enableClusteredLights)}get enableClusteredLights(){return this._frameGraphTask.objectRenderer.options.enableClusteredLights}set enableClusteredLights(e){this._recreateFrameGraphObject(this.doNotChangeAspectRatio,e)}get width(){return this._frameGraphTask.size.width}set width(e){this._frameGraphTask.size.width=e}get height(){return this._frameGraphTask.size.height}set height(e){this._frameGraphTask.size.height=e}get sizeInPercentage(){return this._frameGraphTask.sizeIsPercentage}set sizeInPercentage(e){this._frameGraphTask.sizeIsPercentage=e}get samples(){return this._frameGraphTask.samples}set samples(e){this._frameGraphTask.samples=e}get reverseCulling(){return this._frameGraphTask.reverseCulling}set reverseCulling(e){this._frameGraphTask.reverseCulling=e}get dontRenderWhenMaterialDepthWriteIsDisabled(){return this._frameGraphTask.dontRenderWhenMaterialDepthWriteIsDisabled}set dontRenderWhenMaterialDepthWriteIsDisabled(e){this._frameGraphTask.dontRenderWhenMaterialDepthWriteIsDisabled=e}getClassName(){return"NodeRenderGraphGeometryRendererBlock"}get depth(){return this._inputs[0]}get camera(){return this._inputs[1]}get objects(){return this._inputs[2]}get outputDepth(){return this._outputs[0]}get geomViewDepth(){return this._outputs[1]}get geomNormViewDepth(){return this._outputs[2]}get geomScreenDepth(){return this._outputs[3]}get geomViewNormal(){return this._outputs[4]}get geomWorldNormal(){return this._outputs[5]}get geomLocalPosition(){return this._outputs[6]}get geomWorldPosition(){return this._outputs[7]}get geomAlbedo(){return this._outputs[8]}get geomReflectivity(){return this._outputs[9]}get geomVelocity(){return this._outputs[10]}get geomLinearVelocity(){return this._outputs[11]}_buildBlock(e){var a,o,l;super._buildBlock(e);const t=[this.geomViewDepth.isConnected,this.geomNormViewDepth.isConnected,this.geomScreenDepth.isConnected,this.geomViewNormal.isConnected,this.geomWorldNormal.isConnected,this.geomLocalPosition.isConnected,this.geomWorldPosition.isConnected,this.geomAlbedo.isConnected,this.geomReflectivity.isConnected,this.geomVelocity.isConnected,this.geomLinearVelocity.isConnected];this.outputDepth.value=this._frameGraphTask.outputDepthTexture,this.geomViewDepth.value=this._frameGraphTask.geometryViewDepthTexture,this.geomNormViewDepth.value=this._frameGraphTask.geometryNormViewDepthTexture,this.geomScreenDepth.value=this._frameGraphTask.geometryScreenDepthTexture,this.geomViewNormal.value=this._frameGraphTask.geometryViewNormalTexture,this.geomWorldNormal.value=this._frameGraphTask.geometryWorldNormalTexture,this.geomLocalPosition.value=this._frameGraphTask.geometryLocalPositionTexture,this.geomWorldPosition.value=this._frameGraphTask.geometryWorldPositionTexture,this.geomAlbedo.value=this._frameGraphTask.geometryAlbedoTexture,this.geomReflectivity.value=this._frameGraphTask.geometryReflectivityTexture,this.geomVelocity.value=this._frameGraphTask.geometryVelocityTexture,this.geomLinearVelocity.value=this._frameGraphTask.geometryLinearVelocityTexture,this._frameGraphTask.depthTexture=(a=this.depth.connectedPoint)==null?void 0:a.value,this._frameGraphTask.camera=(o=this.camera.connectedPoint)==null?void 0:o.value,this._frameGraphTask.objectList=(l=this.objects.connectedPoint)==null?void 0:l.value,this._frameGraphTask.textureDescriptions=[];const i=[this.viewDepthFormat,this.normalizedViewDepthFormat,this.screenDepthFormat,this.viewNormalFormat,this.worldNormalFormat,this.localPositionFormat,this.worldPositionFormat,this.albedoFormat,this.reflectivityFormat,this.velocityFormat,this.linearVelocityFormat],r=[this.viewDepthType,this.normalizedViewDepthType,this.screenDepthType,this.viewNormalType,this.worldNormalType,this.localPositionType,this.worldPositionType,this.albedoType,this.reflectivityType,this.velocityType,this.linearVelocityType],n=[5,13,10,6,8,9,1,12,3,2,11];for(let c=0;c<t.length;c++)t[c]&&this._frameGraphTask.textureDescriptions.push({textureFormat:i[c],textureType:r[c],type:n[c]})}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.depthTest = ${this.depthTest};`),e.push(`${this._codeVariableName}.depthWrite = ${this.depthWrite};`),e.push(`${this._codeVariableName}.forceLayerMaskCheck = ${this.forceLayerMaskCheck};`),e.push(`${this._codeVariableName}.samples = ${this.samples};`),e.push(`${this._codeVariableName}.reverseCulling = ${this.reverseCulling};`),e.push(`${this._codeVariableName}.dontRenderWhenMaterialDepthWriteIsDisabled = ${this.dontRenderWhenMaterialDepthWriteIsDisabled};`),e.push(`${this._codeVariableName}.viewDepthFormat = ${this.viewDepthFormat};`),e.push(`${this._codeVariableName}.viewDepthType = ${this.viewDepthType};`),e.push(`${this._codeVariableName}.normalizedViewDepthFormat = ${this.normalizedViewDepthFormat};`),e.push(`${this._codeVariableName}.normalizedViewDepthType = ${this.normalizedViewDepthType};`),e.push(`${this._codeVariableName}.screenDepthFormat = ${this.screenDepthFormat};`),e.push(`${this._codeVariableName}.screenDepthType = ${this.screenDepthType};`),e.push(`${this._codeVariableName}.localPositionFormat = ${this.localPositionFormat};`),e.push(`${this._codeVariableName}.localPositionType = ${this.localPositionType};`),e.push(`${this._codeVariableName}.worldPositionFormat = ${this.worldPositionFormat};`),e.push(`${this._codeVariableName}.worldPositionType = ${this.worldPositionType};`),e.push(`${this._codeVariableName}.viewNormalFormat = ${this.viewNormalFormat};`),e.push(`${this._codeVariableName}.viewNormalType = ${this.viewNormalType};`),e.push(`${this._codeVariableName}.worldNormalFormat = ${this.worldNormalFormat};`),e.push(`${this._codeVariableName}.worldNormalType = ${this.worldNormalType};`),e.push(`${this._codeVariableName}.albedoFormat = ${this.albedoFormat};`),e.push(`${this._codeVariableName}.albedoType = ${this.albedoType};`),e.push(`${this._codeVariableName}.reflectivityFormat = ${this.reflectivityFormat};`),e.push(`${this._codeVariableName}.reflectivityType = ${this.reflectivityType};`),e.push(`${this._codeVariableName}.velocityFormat = ${this.velocityFormat};`),e.push(`${this._codeVariableName}.velocityType = ${this.velocityType};`),e.push(`${this._codeVariableName}.linearVelocityFormat = ${this.linearVelocityFormat};`),e.push(`${this._codeVariableName}.linearVelocityType = ${this.linearVelocityType};`),super._dumpPropertiesCode()+e.join(`
`)}serialize(){const e=super.serialize();return e.depthTest=this.depthTest,e.depthWrite=this.depthWrite,e.forceLayerMaskCheck=this.forceLayerMaskCheck,e.samples=this.samples,e.reverseCulling=this.reverseCulling,e.dontRenderWhenMaterialDepthWriteIsDisabled=this.dontRenderWhenMaterialDepthWriteIsDisabled,e.viewDepthFormat=this.viewDepthFormat,e.viewDepthType=this.viewDepthType,e.normalizedViewDepthFormat=this.normalizedViewDepthFormat,e.normalizedViewDepthType=this.normalizedViewDepthType,e.screenDepthFormat=this.screenDepthFormat,e.screenDepthType=this.screenDepthType,e.localPositionFormat=this.localPositionFormat,e.localPositionType=this.localPositionType,e.worldPositionFormat=this.worldPositionFormat,e.worldPositionType=this.worldPositionType,e.viewNormalFormat=this.viewNormalFormat,e.viewNormalType=this.viewNormalType,e.worldNormalFormat=this.worldNormalFormat,e.worldNormalType=this.worldNormalType,e.albedoFormat=this.albedoFormat,e.albedoType=this.albedoType,e.reflectivityFormat=this.reflectivityFormat,e.reflectivityType=this.reflectivityType,e.velocityFormat=this.velocityFormat,e.velocityType=this.velocityType,e.linearVelocityFormat=this.linearVelocityFormat,e.linearVelocityType=this.linearVelocityType,e}_deserialize(e){super._deserialize(e),this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.forceLayerMaskCheck=!!e.forceLayerMaskCheck,this.samples=e.samples,this.reverseCulling=e.reverseCulling,this.dontRenderWhenMaterialDepthWriteIsDisabled=e.dontRenderWhenMaterialDepthWriteIsDisabled,this.viewDepthFormat=e.viewDepthFormat,this.viewDepthType=e.viewDepthType,this.normalizedViewDepthFormat=e.normalizedViewDepthFormat??6,this.normalizedViewDepthType=e.normalizedViewDepthType??0,this.screenDepthFormat=e.screenDepthFormat,this.screenDepthType=e.screenDepthType,this.localPositionFormat=e.localPositionFormat,this.localPositionType=e.localPositionType,this.worldPositionFormat=e.worldPositionFormat,this.worldPositionType=e.worldPositionType,this.viewNormalFormat=e.viewNormalFormat,this.viewNormalType=e.viewNormalType,this.worldNormalFormat=e.worldNormalFormat,this.worldNormalType=e.worldNormalType,this.albedoFormat=e.albedoFormat,this.albedoType=e.albedoType,this.reflectivityFormat=e.reflectivityFormat,this.reflectivityType=e.reflectivityType,this.velocityFormat=e.velocityFormat,this.velocityType=e.velocityType,this.linearVelocityFormat=e.linearVelocityFormat,this.linearVelocityType=e.linearVelocityType}}_([O("Depth test",0,"PROPERTIES")],St.prototype,"depthTest",null);_([O("Depth write",0,"PROPERTIES")],St.prototype,"depthWrite",null);_([O("Force layer mask check",0,"PROPERTIES")],St.prototype,"forceLayerMaskCheck",null);_([O("Do not change aspect ratio",0,"PROPERTIES")],St.prototype,"doNotChangeAspectRatio",null);_([O("Enable clustered lights",0,"PROPERTIES")],St.prototype,"enableClusteredLights",null);_([O("Texture width",2,"PROPERTIES")],St.prototype,"width",null);_([O("Texture height",2,"PROPERTIES")],St.prototype,"height",null);_([O("Size is in percentage",0,"PROPERTIES")],St.prototype,"sizeInPercentage",null);_([O("Samples",2,"PROPERTIES",{min:1,max:8})],St.prototype,"samples",null);_([O("Reverse culling",0,"PROPERTIES")],St.prototype,"reverseCulling",null);_([O("Don't render if material depth write is disabled",0,"PROPERTIES")],St.prototype,"dontRenderWhenMaterialDepthWriteIsDisabled",null);_([O("View depth format",8,"GEOMETRY BUFFERS")],St.prototype,"viewDepthFormat",void 0);_([O("View depth type",9,"GEOMETRY BUFFERS")],St.prototype,"viewDepthType",void 0);_([O("Normalized view depth format",8,"GEOMETRY BUFFERS")],St.prototype,"normalizedViewDepthFormat",void 0);_([O("Normalized view depth type",9,"GEOMETRY BUFFERS")],St.prototype,"normalizedViewDepthType",void 0);_([O("Screen depth format",8,"GEOMETRY BUFFERS")],St.prototype,"screenDepthFormat",void 0);_([O("Screen depth type",9,"GEOMETRY BUFFERS")],St.prototype,"screenDepthType",void 0);_([O("View normal format",8,"GEOMETRY BUFFERS")],St.prototype,"viewNormalFormat",void 0);_([O("View normal type",9,"GEOMETRY BUFFERS")],St.prototype,"viewNormalType",void 0);_([O("World normal format",8,"GEOMETRY BUFFERS")],St.prototype,"worldNormalFormat",void 0);_([O("World normal type",9,"GEOMETRY BUFFERS")],St.prototype,"worldNormalType",void 0);_([O("Local position format",8,"GEOMETRY BUFFERS")],St.prototype,"localPositionFormat",void 0);_([O("Local position type",9,"GEOMETRY BUFFERS")],St.prototype,"localPositionType",void 0);_([O("World position format",8,"GEOMETRY BUFFERS")],St.prototype,"worldPositionFormat",void 0);_([O("World position type",9,"GEOMETRY BUFFERS")],St.prototype,"worldPositionType",void 0);_([O("Albedo format",8,"GEOMETRY BUFFERS")],St.prototype,"albedoFormat",void 0);_([O("Albedo type",9,"GEOMETRY BUFFERS")],St.prototype,"albedoType",void 0);_([O("Reflectivity format",8,"GEOMETRY BUFFERS")],St.prototype,"reflectivityFormat",void 0);_([O("Reflectivity type",9,"GEOMETRY BUFFERS")],St.prototype,"reflectivityType",void 0);_([O("Velocity format",8,"GEOMETRY BUFFERS")],St.prototype,"velocityFormat",void 0);_([O("Velocity type",9,"GEOMETRY BUFFERS")],St.prototype,"velocityType",void 0);_([O("Linear velocity format",8,"GEOMETRY BUFFERS")],St.prototype,"linearVelocityFormat",void 0);_([O("Linear velocity type",9,"GEOMETRY BUFFERS")],St.prototype,"linearVelocityType",void 0);y("BABYLON.NodeRenderGraphGeometryRendererBlock",St);class cV extends Ur{constructor(e,t,i){super(e,t,i),this._finalizeInputOutputRegistering(),this._frameGraphTask=new CD(this.name,t,i)}getClassName(){return"NodeRenderGraphShadowGeneratorBlock"}}y("BABYLON.NodeRenderGraphShadowGeneratorBlock",cV);class uV{constructor(e,t=2,i=3,r=1,n=1){this._curIndex=0,this._sequence=[],this._numSamples=0,this.x=0,this.y=0,this._width=r,this._height=n,this._baseX=t,this._baseY=i,this._generateSequence(e),this.next()}regenerate(e){this._generateSequence(e),this.next()}setDimensions(e,t){this._width=e,this._height=t}next(){this.x=this._sequence[this._curIndex]/this._width,this.y=this._sequence[this._curIndex+1]/this._height,this._curIndex+=2,this._curIndex>=this._numSamples*2&&(this._curIndex=0)}_generateSequence(e){this._sequence=[],this._curIndex=0,this._numSamples=e;for(let t=1;t<=e;++t)this._sequence.push(this._halton(t,this._baseX)-.5,this._halton(t,this._baseY)-.5)}_halton(e,t){let i=1,r=0;for(;e>0;)i/=t,r+=i*(e%t),e=~~(e/t);return r}}class mn extends gt{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(U(()=>Promise.resolve().then(()=>W$),void 0))):t.push(U(()=>Promise.resolve().then(()=>G$),void 0))}set samples(e){this._samples!==e&&(this._samples=e,this._hs.regenerate(e))}get samples(){return this._samples}get disabled(){return this._disabled}set disabled(e){this._disabled!==e&&(this._disabled=e,this._reset())}get textureWidth(){return this._textureWidth}set textureWidth(e){this._textureWidth!==e&&(this._textureWidth=e,this._reset())}get textureHeight(){return this._textureHeight}set textureHeight(e){this._textureHeight!==e&&(this._textureHeight=e,this._reset())}get reprojectHistory(){return this._reprojectHistory}set reprojectHistory(e){this._reprojectHistory!==e&&(this._reprojectHistory=e,this._updateEffect())}get clampHistory(){return this._clampHistory}set clampHistory(e){this._clampHistory!==e&&(this._clampHistory=e,this._updateEffect())}constructor(e,t=null,i){super({...i,name:e,engine:t||ft.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:mn.FragmentUrl,uniforms:mn.Uniforms,samplers:mn.Samplers}),this._samples=8,this.factor=.05,this._disabled=!1,this._textureWidth=0,this._textureHeight=0,this.disableOnCameraMove=!0,this._reprojectHistory=!1,this._clampHistory=!1,this._firstUpdate=!0,this._hs=new uV(this.samples)}_reset(){this._hs.setDimensions(this._textureWidth/2,this._textureHeight/2),this._hs.next(),this._firstUpdate=!0}nextJitterOffset(e=new X){return(!this.camera||!this.camera.hasMoved)&&this._hs.next(),e.set(this._hs.x,this._hs.y),e}updateProjectionMatrix(){if(!this.disabled){if(this.camera&&!this.camera.hasMoved)if(this.camera.mode===dt.PERSPECTIVE_CAMERA){const e=this.camera.getProjectionMatrix();e.setRowFromFloats(2,this._hs.x,this._hs.y,e.m[10],e.m[11])}else{const e=this.camera.getProjectionMatrix(!0);e.setRowFromFloats(3,this._hs.x+e.m[12],this._hs.y+e.m[13],e.m[14],e.m[15])}this._hs.next()}}bind(e=!1){var i;if(super.bind(e),this.disabled)return;this._drawWrapper.effect.setFloat("factor",(i=this.camera)!=null&&i.hasMoved&&this.disableOnCameraMove||this._firstUpdate?1:this.factor),this._firstUpdate=!1}_updateEffect(){const e=[],t=["textureSampler","historySampler"];this._reprojectHistory&&(e.push("#define TAA_REPROJECT_HISTORY"),t.push("velocitySampler")),this._clampHistory&&e.push("#define TAA_CLAMP_HISTORY"),this.updateEffect(e.join(`
`),null,t)}}mn.FragmentUrl="taa";mn.Uniforms=["factor"];mn.Samplers=["historySampler"];class Vv extends xu{constructor(e,t,i,r){super(e,t,i,r),this.postProcess=new mn(`${e} post-process`,i.getEngine()),this._postProcessDrawWrapper=this.postProcess.drawWrapper,this._renderer.dontSetTransformationMatrix=!0}record(){if(this.targetTexture===void 0||this.objectList===void 0)throw new Error(`FrameGraphTAAObjectRendererTask ${this.name}: destinationTexture and objectList are required`);const e=this._frameGraph.textureManager,t=Array.isArray(this.targetTexture)?this.targetTexture:[this.targetTexture];if(e.isBackbuffer(t[0])||this.depthTexture!==void 0&&e.isBackbuffer(this.depthTexture))throw new Error(`FrameGraphTAAObjectRendererTask ${this.name}: the back buffer color/depth textures are not allowed. Use regular textures instead.`);this._renderer.renderList=this.objectList.meshes,this._renderer.particleSystemList=this.objectList.particleSystems;const i=e.getTextureDescription(t[0]);let r=!1;if(this.depthTexture!==void 0){if(e.getTextureDescription(this.depthTexture).options.samples!==i.options.samples)throw new Error(`FrameGraphTAAObjectRendererTask ${this.name}: the depth texture and the output texture must have the same number of samples`);r=!0}this.postProcess.camera=this.camera,this.postProcess.textureWidth=i.size.width,this.postProcess.textureHeight=i.size.height;const n={size:i.size,options:{createMipMaps:i.options.createMipMaps,types:[2],formats:[5],samples:1,useSRGBBuffers:[!1],creationFlags:[0],labels:[""]},sizeIsPercentage:!1,isHistoryTexture:!0},a=e.createRenderTargetTexture(`${this.name} history`,n);e.resolveDanglingHandle(this.outputTexture,a),this.depthTexture!==void 0&&e.resolveDanglingHandle(this.outputDepthTexture,this.depthTexture),this._textureWidth=i.size.width,this._textureHeight=i.size.height;let o;this._setLightsForShadow(),this._renderer.onInitRenderingObservable.remove(this._initRenderingObserver),this._initRenderingObserver=this._renderer.onInitRenderingObservable.add(()=>{this._scene.setTransformMatrix(this.camera.getViewMatrix(),this.camera.getProjectionMatrix(this.postProcess.disabled))});const l=this._frameGraph.addRenderPass(this.name);l.setRenderTarget(this.targetTexture),l.setRenderTargetDepth(this.depthTexture),l.setExecuteFunc(u=>{this._renderer.renderList=this.objectList.meshes,this._renderer.particleSystemList=this.objectList.particleSystems,this.postProcess.updateProjectionMatrix(),u.setDepthStates(this.depthTest&&r,this.depthWrite&&r),u.render(this._renderer,this._textureWidth,this._textureHeight),this._scene.activeCamera=null,o=o||u.createRenderTarget(`${this.name} ping/pong`,a),u.bindRenderTarget(o,"frame graph - TAA merge with history texture"),this.postProcess.disabled?u.copyTexture(t[0]):u.applyFullScreenEffect(this._postProcessDrawWrapper,()=>{this.postProcess.bind(),u.bindTextureHandle(this._postProcessDrawWrapper.effect,"textureSampler",t[0]),u.bindTextureHandle(this._postProcessDrawWrapper.effect,"historySampler",a)})});const c=this._frameGraph.addRenderPass(this.name+"_disabled",!0);return c.setRenderTarget(this.outputTexture),c.setRenderTargetDepth(this.depthTexture),c.setExecuteFunc(u=>{u.copyTexture(t[0])}),l}dispose(){this._renderer.onInitRenderingObservable.remove(this._initRenderingObserver),super.dispose()}}class oc extends Mi{get task(){return this._frameGraphTask}constructor(e,t,i,r=!0){super(e,t,i),this._additionalConstructionParameters=[r,!1],this._frameGraphTask=new Vv(this.name,t,i,{doNotChangeAspectRatio:r})}_createFrameGraphObject(){this._frameGraphTask=new Vv(this.name,this._frameGraph,this._scene,{doNotChangeAspectRatio:this._additionalConstructionParameters[0]})}_saveState(e){super._saveState(e),e.samples=this.samples,e.factor=this.factor,e.disableOnCameraMove=this.disableOnCameraMove,e.disableTAA=this.disableTAA}_restoreState(e){super._restoreState(e),this.samples=e.samples,this.factor=e.factor,this.disableOnCameraMove=e.disableOnCameraMove,this.disableTAA=e.disableTAA}get samples(){return this._frameGraphTask.postProcess.samples}set samples(e){this._frameGraphTask.postProcess.samples=e}get factor(){return this._frameGraphTask.postProcess.factor}set factor(e){this._frameGraphTask.postProcess.factor=e}get disableOnCameraMove(){return this._frameGraphTask.postProcess.disableOnCameraMove}set disableOnCameraMove(e){this._frameGraphTask.postProcess.disableOnCameraMove=e}get disableTAA(){return this._frameGraphTask.postProcess.disabled}set disableTAA(e){this._frameGraphTask.postProcess.disabled=e}getClassName(){return"NodeRenderGraphTAAObjectRendererBlock"}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.samples = ${this.samples};`),e.push(`${this._codeVariableName}.factor = ${this.factor};`),e.push(`${this._codeVariableName}.disableOnCameraMove = ${this.disableOnCameraMove};`),e.push(`${this._codeVariableName}.disableTAA = ${this.disableTAA};`),super._dumpPropertiesCode()+e.join(`
`)}serialize(){const e=super.serialize();return e.samples=this.samples,e.factor=this.factor,e.disableOnCameraMove=this.disableOnCameraMove,e.disableTAA=this.disableTAA,e}_deserialize(e){super._deserialize(e),this.samples=e.samples,this.factor=e.factor,this.disableOnCameraMove=e.disableOnCameraMove,this.disableTAA=e.disableTAA}}_([O("Samples",2,"TEMPORAL ANTI-ALIASING")],oc.prototype,"samples",null);_([O("Factor",1,"TEMPORAL ANTI-ALIASING")],oc.prototype,"factor",null);_([O("Disable on camera move",0,"TEMPORAL ANTI-ALIASING")],oc.prototype,"disableOnCameraMove",null);_([O("Disable TAA",0,"TEMPORAL ANTI-ALIASING")],oc.prototype,"disableTAA",null);y("BABYLON.NodeRenderGraphTAAObjectRendererBlock",oc);class kR extends Di{get task(){return this._frameGraphTask}constructor(e,t,i,r=!0){super(e,t,i),this._additionalConstructionParameters=[r],this.registerInput("target",H.AutoDetect),this.registerInput("camera",H.Camera),this._addDependenciesInput(),this.registerOutput("output",H.BasedOnInput),this.target.addExcludedConnectionPointFromAllowedTypes(H.TextureAll),this.output._typeConnectionSource=this.target,this._frameGraphTask=new gd(e,t,i,r)}_createTask(e){const t=this._frameGraphTask.disabled;this._frameGraphTask.dispose(),this._frameGraphTask=new gd(this.name,this._frameGraph,this._scene,e),this._additionalConstructionParameters=[e],this._frameGraphTask.disabled=t}get handleEvents(){return this._frameGraphTask.layer.handleEvents}set handleEvents(e){this._createTask(e)}getClassName(){return"NodeRenderGraphUtilityLayerRendererBlock"}get target(){return this._inputs[0]}get camera(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){var t,i;super._buildBlock(e),this.output.value=this._frameGraphTask.outputTexture,this._frameGraphTask.targetTexture=(t=this.target.connectedPoint)==null?void 0:t.value,this._frameGraphTask.camera=(i=this.camera.connectedPoint)==null?void 0:i.value}}_([O("Handle events",0,"PROPERTIES")],kR.prototype,"handleEvents",null);y("BABYLON.NodeRenderGraphUtilityLayerRendererBlock",kR);class hV extends Di{get endpoints(){return this._endpoints}constructor(e,t,i){super(e,t,i),this._endpoints=[],this._isTeleportIn=!0,this.registerInput("input",H.AutoDetect)}getClassName(){return"NodeRenderGraphTeleportInBlock"}get input(){return this._inputs[0]}_dumpCode(e,t){let i=super._dumpCode(e,t);for(const r of this.endpoints)t.indexOf(r)===-1&&(i+=r._dumpCode(e,t));return i}isAnAncestorOfType(e){if(this.getClassName()===e)return!0;for(const t of this.endpoints)if(t.isAnAncestorOfType(e))return!0;return!1}isAnAncestorOf(e){for(const t of this.endpoints)if(t===e||t.isAnAncestorOf(e))return!0;return!1}getDescendantOfPredicate(e){if(e(this))return this;for(const t of this.endpoints){const i=t.getDescendantOfPredicate(e);if(i)return i}return null}attachToEndpoint(e){e.detach(),this._endpoints.push(e),e._entryPoint=this,e._outputs[0]._typeConnectionSource=this._inputs[0],e._tempEntryPointUniqueId=null,e.name="> "+this.name}detachFromEndpoint(e){const t=this._endpoints.indexOf(e);t!==-1&&(this._endpoints.splice(t,1),e._outputs[0]._typeConnectionSource=null,e._entryPoint=null)}dispose(){super.dispose();for(const e of this._endpoints)this.detachFromEndpoint(e);this._endpoints=[]}}y("BABYLON.NodeRenderGraphTeleportInBlock",hV);class dV extends Di{constructor(e,t,i){super(e,t,i),this._entryPoint=null,this._tempEntryPointUniqueId=null,this._isTeleportOut=!0,this.registerOutput("output",H.BasedOnInput)}get entryPoint(){return this._entryPoint}getClassName(){return"NodeRenderGraphTeleportOutBlock"}get output(){return this._outputs[0]}detach(){this._entryPoint&&this._entryPoint.detachFromEndpoint(this)}_buildBlock(){}_customBuildStep(e){this.entryPoint&&this.entryPoint.build(e)}_dumpCode(e,t){let i="";return this.entryPoint&&t.indexOf(this.entryPoint)===-1&&(i+=this.entryPoint._dumpCode(e,t)),i+super._dumpCode(e,t)}_dumpCodeForOutputConnections(e){let t=super._dumpCodeForOutputConnections(e);return this.entryPoint&&(t+=this.entryPoint._dumpCodeForOutputConnections(e)),t}clone(){const e=super.clone();return this.entryPoint&&this.entryPoint.attachToEndpoint(e),e}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.entryPoint&&(e+=`${this.entryPoint._codeVariableName}.attachToEndpoint(${this._codeVariableName});
`),e}serialize(){var t;const e=super.serialize();return e.entryPoint=((t=this.entryPoint)==null?void 0:t.uniqueId)??"",e}_deserialize(e){super._deserialize(e),this._tempEntryPointUniqueId=e.entryPoint}}y("BABYLON.NodeRenderGraphTeleportOutBlock",dV);class fV extends Br{constructor(e,t){super(e,t),this.outputTexture=this._frameGraph.textureManager.createDanglingHandle()}record(){if(this.sourceTexture===void 0||this.targetTexture===void 0)throw new Error(`FrameGraphCopyToTextureTask "${this.name}": sourceTexture and targetTexture are required`);this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture);const e=this._frameGraph.addRenderPass(this.name);e.addDependencies(this.sourceTexture),e.setRenderTarget(this.outputTexture),e.setExecuteFunc(i=>{i.copyTexture(this.sourceTexture)});const t=this._frameGraph.addRenderPass(this.name+"_disabled",!0);t.setRenderTarget(this.outputTexture),t.setExecuteFunc(i=>{})}}class pV extends Di{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("source",H.AutoDetect),this.registerInput("target",H.AutoDetect),this._addDependenciesInput(),this.registerOutput("output",H.BasedOnInput),this.source.addExcludedConnectionPointFromAllowedTypes(H.TextureAllButBackBuffer),this.target.addExcludedConnectionPointFromAllowedTypes(H.TextureAll),this.output._typeConnectionSource=this.source,this._frameGraphTask=new fV(e,t)}getClassName(){return"NodeRenderGraphCopyTextureBlock"}get source(){return this._inputs[0]}get target(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){var t,i;super._buildBlock(e),this.output.value=this._frameGraphTask.outputTexture,this._frameGraphTask.sourceTexture=(t=this.source.connectedPoint)==null?void 0:t.value,this._frameGraphTask.targetTexture=(i=this.target.connectedPoint)==null?void 0:i.value}}y("BABYLON.NodeRenderGraphCopyTextureBlock",pV);class mV extends Br{constructor(e,t){super(e,t),this.outputTexture=this._frameGraph.textureManager.createDanglingHandle()}record(){if(this.targetTexture===void 0)throw new Error(`FrameGraphGenerateMipMapsTask ${this.name}: targetTexture is required`);if(this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture),!this._frameGraph.textureManager.getTextureDescription(this.targetTexture).options.createMipMaps)throw new Error(`FrameGraphGenerateMipMapsTask ${this.name}: targetTexture must have createMipMaps set to true`);const t=this._frameGraph.addRenderPass(this.name);t.setRenderTarget(this.outputTexture),t.setExecuteFunc(r=>{r.generateMipMaps()});const i=this._frameGraph.addRenderPass(this.name+"_disabled",!0);i.setRenderTarget(this.outputTexture),i.setExecuteFunc(r=>{})}}class _V extends Di{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("target",H.AutoDetect),this._addDependenciesInput(),this.registerOutput("output",H.BasedOnInput),this.target.addExcludedConnectionPointFromAllowedTypes(H.TextureAllButBackBuffer),this.output._typeConnectionSource=this.target,this._frameGraphTask=new mV(e,t)}getClassName(){return"NodeRenderGraphGenerateMipmapsBlock"}get target(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){var t;super._buildBlock(e),this._propagateInputValueToOutput(this.target,this.output),this._frameGraphTask.targetTexture=(t=this.target.connectedPoint)==null?void 0:t.value}}y("BABYLON.NodeRenderGraphGenerateMipmapsBlock",_V);var Uv;(function(s){s[s.Rotation=0]="Rotation",s[s.Scaling=1]="Scaling"})(Uv||(Uv={}));function gV(s,e={},t){e.diameter||(e.diameter=1),e.segments||(e.segments=16);const i=Sn("",{slice:.5,diameter:e.diameter,segments:e.segments},t),r=yD("",{radius:e.diameter/2,tessellation:e.segments*3+(4-e.segments)},t);r.rotation.x=-Math.PI/2,r.parent=i;const n=Oe.MergeMeshes([r,i],!0);return n.name=s,n}Oe.CreateHemisphere=(s,e,t,i)=>gV(s,{segments:e,diameter:t},i);class _h extends Zi{set blurRatio(e){this._blurRatio!==e&&(this._blurRatio=e,this._preparePostProcesses())}get blurRatio(){return this._blurRatio}set adaptiveBlurKernel(e){this._adaptiveBlurKernel=e,this._autoComputeBlurKernel()}set blurKernel(e){this.blurKernelX=e,this.blurKernelY=e}set blurKernelX(e){this._blurKernelX!==e&&(this._blurKernelX=e,this._preparePostProcesses())}get blurKernelX(){return this._blurKernelX}set blurKernelY(e){this._blurKernelY!==e&&(this._blurKernelY=e,this._preparePostProcesses())}get blurKernelY(){return this._blurKernelY}_autoComputeBlurKernel(){const e=this.getScene().getEngine(),t=this.getRenderWidth()/e.getRenderWidth(),i=this.getRenderHeight()/e.getRenderHeight();this.blurKernelX=this._adaptiveBlurKernel*t,this.blurKernelY=this._adaptiveBlurKernel*i}_onRatioRescale(){this._sizeRatio&&(this.resize(this._initialSizeParameter),this._adaptiveBlurKernel||this._preparePostProcesses()),this._adaptiveBlurKernel&&this._autoComputeBlurKernel()}_updateGammaSpace(){const e=this.getScene();e&&(this.gammaSpace=!e.imageProcessingConfiguration.isEnabled||!e.imageProcessingConfiguration.applyByPostProcess)}constructor(e,t,i,r,n=0,a=$.BILINEAR_SAMPLINGMODE,o=!0){if(super(e,t,i,r,!0,n,!1,a,o),this.mirrorPlane=new jc(0,1,0,1),this._transformMatrix=z.Zero(),this._mirrorMatrix=z.Zero(),this._adaptiveBlurKernel=0,this._blurKernelX=0,this._blurKernelY=0,this._blurRatio=1,i=this.getScene(),!i)return this;this.ignoreCameraViewport=!0,this._updateGammaSpace(),this._imageProcessingConfigChangeObserver=i.imageProcessingConfiguration.onUpdateParameters.add(()=>{this._updateGammaSpace()}),i.getEngine().supportsUniformBuffers&&(this._sceneUBO=i.createSceneUniformBuffer(`Scene for Mirror Texture (name "${e}")`));let c;this.onBeforeRenderObservable.add(()=>{this._sceneUBO&&(this._currentSceneUBO=i.getSceneUniformBuffer(),i.setSceneUniformBuffer(this._sceneUBO),i.getSceneUniformBuffer().unbindEffect()),z.ReflectionToRef(this.mirrorPlane,this._mirrorMatrix),this._mirrorMatrix.multiplyToRef(i.getViewMatrix(),this._transformMatrix),i.setTransformMatrix(this._transformMatrix,i.getProjectionMatrix()),c=i.clipPlane,i.clipPlane=this.mirrorPlane,i._mirroredCameraPosition=x.TransformCoordinates(i.activeCamera.globalPosition,this._mirrorMatrix)}),this.onAfterRenderObservable.add(()=>{this._sceneUBO&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(),i._mirroredCameraPosition=null,i.clipPlane=c})}_preparePostProcesses(){if(this.clearPostProcesses(!0),this._blurKernelX&&this._blurKernelY){const e=this.getScene().getEngine(),t=e.getCaps().textureFloatRender&&e.getCaps().textureFloatLinearFiltering?1:2;this._blurX=new nr("horizontal blur",new X(1,0),this._blurKernelX,this._blurRatio,null,$.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurX.autoClear=!1,this._blurRatio===1&&this.samples<2&&this._texture?this._blurX.inputTexture=this._renderTarget:this._blurX.alwaysForcePOT=!0,this._blurY=new nr("vertical blur",new X(0,1),this._blurKernelY,this._blurRatio,null,$.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurY.autoClear=!1,this._blurY.alwaysForcePOT=this._blurRatio!==1,this.addPostProcess(this._blurX),this.addPostProcess(this._blurY)}else this._blurY&&(this.removePostProcess(this._blurY),this._blurY.dispose(),this._blurY=null),this._blurX&&(this.removePostProcess(this._blurX),this._blurX.dispose(),this._blurX=null)}clone(){const e=this.getScene();if(!e)return this;const t=this.getSize(),i=new _h(this.name,t.width,e,this._renderTargetOptions.generateMipMaps,this._renderTargetOptions.type,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.mirrorPlane=this.mirrorPlane.clone(),this.renderList&&(i.renderList=this.renderList.slice(0)),i}serialize(){if(!this.name)return null;const e=super.serialize();return e.mirrorPlane=this.mirrorPlane.asArray(),e}dispose(){var t;super.dispose();const e=this.getScene();e&&e.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigChangeObserver),(t=this._sceneUBO)==null||t.dispose()}}$._CreateMirror=(s,e,t,i)=>new _h(s,e,t,i);const kv=.8;class ii extends ps{set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(z.RotationY(this._rotationY))}get rotationY(){return this._rotationY}get noMipmap(){return this._noMipmap}get forcedExtension(){return this._forcedExtension}static CreateFromImages(e,t,i){let r="";for(const n of e)r+=n;return new ii(r,t,null,i,e)}static CreateFromPrefilteredData(e,t,i=null,r=!0){const n=t.useDelayedTextureLoading;t.useDelayedTextureLoading=!1;const a=new ii(e,t,null,!1,null,null,null,void 0,!0,i,r);return t.useDelayedTextureLoading=n,a}constructor(e,t,i=null,r=!1,n=null,a=null,o=null,l=5,c=!1,u=null,h=!1,d=kv,f=0,m,g){var T;super(t),this.onLoadObservable=new k,this.boundingBoxPosition=x.Zero(),this._rotationY=0,this._files=null,this._forcedExtension=null,this._extensions=null,this._textureMatrixRefraction=new z,this._buffer=null,this.name=e,this.url=e,this._noMipmap=r,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=z.Identity(),this.coordinatesMode=$.CUBIC_MODE;let v=null,E=null;i!==null&&!Array.isArray(i)?(v=i.extensions??null,this._noMipmap=i.noMipmap??!1,n=i.files??null,E=i.buffer??null,this._format=i.format??5,c=i.prefiltered??!1,u=i.forcedExtension??null,this._createPolynomials=i.createPolynomials??!1,this._lodScale=i.lodScale??kv,this._lodOffset=i.lodOffset??0,this._loaderOptions=i.loaderOptions,this._useSRGBBuffer=i.useSRGBBuffer,a=i.onLoad??null,o=i.onError??null):(this._noMipmap=r,this._format=l,this._createPolynomials=h,v=i,this._loaderOptions=m,this._useSRGBBuffer=g,this._lodScale=d,this._lodOffset=f),!(!e&&!n)&&this.updateURL(e,u,a,c,o,v,(T=this.getScene())==null?void 0:T.useDelayedTextureLoading,n,E)}getClassName(){return"CubeTexture"}updateURL(e,t=null,i=null,r=!1,n=null,a=null,o=!1,l=null,c=null){(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,t&&(this._forcedExtension=t);const u=e.lastIndexOf("."),h=t||(u>-1?e.substring(u).toLowerCase():""),d=h.indexOf(".dds")===0,f=h.indexOf(".env")===0,m=h.indexOf(".basis")===0;if(f?(this.gammaSpace=!1,this._prefiltered=!1,this.anisotropicFilteringLevel=1):(this._prefiltered=r,r&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1)),l)this._files=l;else if(!m&&!f&&!d&&!a&&(a=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._files=this._files||[],this._files.length=0,a){for(let g=0;g<a.length;g++)this._files.push(e+a[g]);this._extensions=a}this._buffer=c,o?(this.delayLoadState=4,this._delayedOnLoad=i,this._delayedOnError=n):this._loadTexture(i,n)}delayLoad(e){this.delayLoadState===4&&(e&&(this._forcedExtension=e),this.delayLoadState=1,this._loadTexture(this._delayedOnLoad,this._delayedOnError))}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){var n,a;if(e.updateFlag===this._textureMatrix.updateFlag||(e.isIdentity()!==this._textureMatrix.isIdentity()&&((n=this.getScene())==null||n.markAllMaterialsAsDirty(1,o=>o.getActiveTextures().indexOf(this)!==-1)),this._textureMatrix=e,!((a=this.getScene())!=null&&a.useRightHandedSystem)))return;const t=G.Vector3[0],i=G.Quaternion[0],r=G.Vector3[1];this._textureMatrix.decompose(t,i,r),i.z*=-1,i.w*=-1,z.ComposeToRef(t,i,r,this._textureMatrixRefraction)}getRefractionTextureMatrix(){var e;return(e=this.getScene())!=null&&e.useRightHandedSystem?this._textureMatrixRefraction:this._textureMatrix}_loadTexture(e=null,t=null){var o;const i=this.getScene(),r=this._texture;this._texture=this._getFromCache(this.url,this._noMipmap,void 0,void 0,this._useSRGBBuffer,this.isCube);const n=()=>{var l;this.onLoadObservable.notifyObservers(this),r&&(r.dispose(),(l=this.getScene())==null||l.markAllMaterialsAsDirty(1)),e&&e()},a=(l,c)=>{this._loadingError=!0,this._errorObject={message:l,exception:c},t&&t(l,c),$.OnTextureLoadErrorObservable.notifyObservers(this)};this._texture?this._texture.isReady?j.SetImmediate(()=>n()):this._texture.onLoadedObservable.add(()=>n()):(this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,i,this._lodScale,this._lodOffset,e,a,this._format,this._forcedExtension,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,i,this._files,this._noMipmap,e,a,this._format,this._forcedExtension,!1,this._lodScale,this._lodOffset,null,this._loaderOptions,!!this._useSRGBBuffer,this._buffer),(o=this._texture)==null||o.onLoadedObservable.add(()=>this.onLoadObservable.notifyObservers(this)))}static Parse(e,t,i){const r=me.Parse(()=>{let n=!1;return e.prefiltered&&(n=e.prefiltered),new ii(i+(e.url??e.name),t,e.extensions,!1,e.files||null,null,null,void 0,n,e.forcedExtension)},e,t);if(e.boundingBoxPosition&&(r.boundingBoxPosition=x.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(r.boundingBoxSize=x.FromArray(e.boundingBoxSize)),e.animations)for(let n=0;n<e.animations.length;n++){const a=e.animations[n],o=ki("BABYLON.Animation");o&&r.animations.push(o.Parse(a))}return r}clone(){let e=0;const t=me.Clone(()=>{const i=new ii(this.url,this.getScene()||this._getEngine(),this._extensions,this._noMipmap,this._files);return e=i.uniqueId,i},this);return t.uniqueId=e,t}}_([R()],ii.prototype,"url",void 0);_([Cn()],ii.prototype,"boundingBoxPosition",void 0);_([Cn()],ii.prototype,"boundingBoxSize",null);_([R("rotationY")],ii.prototype,"rotationY",null);_([R("files")],ii.prototype,"_files",void 0);_([R("forcedExtension")],ii.prototype,"_forcedExtension",void 0);_([R("extensions")],ii.prototype,"_extensions",void 0);_([Um("textureMatrix")],ii.prototype,"_textureMatrix",void 0);_([Um("textureMatrixRefraction")],ii.prototype,"_textureMatrixRefraction",void 0);$._CubeTextureParser=ii.Parse;y("BABYLON.CubeTexture",ii);class SV extends Oi{}class vV extends Ou(SV){constructor(){super(),this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.GAMMADIFFUSE=!1,this.DIFFUSEHASALPHA=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONBLUR=!1,this.REFLECTIONFRESNEL=!1,this.REFLECTIONFALLOFF=!1,this.TEXTURELODSUPPORT=!1,this.PREMULTIPLYALPHA=!1,this.USERGBCOLOR=!1,this.USEHIGHLIGHTANDSHADOWCOLORS=!1,this.BACKMAT_SHADOWONLY=!1,this.NOISE=!1,this.REFLECTIONBGR=!1,this.PROJECTED_GROUND=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.EQUIRECTANGULAR_RELFECTION_FOV=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.UV1=!1,this.UV2=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.NORMAL=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.INSTANCES=!1,this.SHADOWFLOAT=!1,this.LOGARITHMICDEPTH=!1,this.NONUNIFORMSCALING=!1,this.ALPHATEST=!1,this.rebuild()}}class xV extends Nu(Zl){}class Re extends xV{get _perceptualColor(){return this.__perceptualColor}set _perceptualColor(e){this.__perceptualColor=e,this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsLightsDirty()}get primaryColorShadowLevel(){return this._primaryColorShadowLevel}set primaryColorShadowLevel(e){this._primaryColorShadowLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}get primaryColorHighlightLevel(){return this._primaryColorHighlightLevel}set primaryColorHighlightLevel(e){this._primaryColorHighlightLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}set reflectionStandardFresnelWeight(e){let t=e;t<.5?(t=t*2,this.reflectionReflectance0=Re.StandardReflectance0*t,this.reflectionReflectance90=Re.StandardReflectance90*t):(t=t*2-1,this.reflectionReflectance0=Re.StandardReflectance0+(1-Re.StandardReflectance0)*t,this.reflectionReflectance90=Re.StandardReflectance90+(1-Re.StandardReflectance90)*t)}get fovMultiplier(){return this._fovMultiplier}set fovMultiplier(e){isNaN(e)&&(e=1),this._fovMultiplier=Math.max(0,Math.min(2,e))}constructor(e,t,i=!1){super(e,t,void 0,i),this.primaryColor=q.White(),this._primaryColorShadowLevel=0,this._primaryColorHighlightLevel=0,this.reflectionTexture=null,this.reflectionBlur=0,this.diffuseTexture=null,this._shadowLights=null,this.shadowLights=null,this.shadowLevel=0,this.sceneCenter=x.Zero(),this.opacityFresnel=!0,this.reflectionFresnel=!1,this.reflectionFalloffDistance=0,this.reflectionAmount=1,this.reflectionReflectance0=.05,this.reflectionReflectance90=.5,this.useRGBColor=!0,this.enableNoise=!1,this._fovMultiplier=1,this.useEquirectangularFOV=!1,this._maxSimultaneousLights=4,this.maxSimultaneousLights=4,this._shadowOnly=!1,this.shadowOnly=!1,this.switchToBGR=!1,this._enableGroundProjection=!1,this.enableGroundProjection=!1,this.projectedGroundRadius=1e3,this.projectedGroundHeight=10,this._renderTargets=new Xn(16),this._reflectionControls=Ee.Zero(),this._white=q.White(),this._primaryShadowColor=q.Black(),this._primaryHighlightColor=q.Black(),this._shadersLoaded=!1,this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._renderTargets.push(this._diffuseTexture),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._renderTargets)}get hasRenderTargetTextures(){return!!(this._diffuseTexture&&this._diffuseTexture.isRenderTarget||this._reflectionTexture&&this._reflectionTexture.isRenderTarget)}needAlphaTesting(){return!0}needAlphaBlending(){return this.alpha<1||this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._shadowOnly}isReadyForSubMesh(e,t,i=!1){const r=t._drawWrapper;if(r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new vV);const n=this.getScene(),a=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const o=n.getEngine();if(jl(n,e,a,!1,this._maxSimultaneousLights),a._needNormals=!0,bu(n,a),a._areTexturesDirty){if(a._needUVs=!1,n.texturesEnabled){if(n.getEngine().getCaps().textureLOD&&(a.TEXTURELODSUPPORT=!0),this._diffuseTexture&&K.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;Nt(this._diffuseTexture,a,"DIFFUSE"),a.DIFFUSEHASALPHA=this._diffuseTexture.hasAlpha,a.GAMMADIFFUSE=this._diffuseTexture.gammaSpace,a.OPACITYFRESNEL=this._opacityFresnel}else a.DIFFUSE=!1,a.DIFFUSEDIRECTUV=0,a.DIFFUSEHASALPHA=!1,a.GAMMADIFFUSE=!1,a.OPACITYFRESNEL=!1;const l=this._reflectionTexture;if(km(n,l,a),l&&K.ReflectionTextureEnabled){if(!l.isReadyOrNotBlocking())return!1;a.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV,a.REFLECTIONBGR=this.switchToBGR,a.REFLECTIONBLUR=this._reflectionBlur>0,this.reflectionFresnel?(a.REFLECTIONFRESNEL=!0,a.REFLECTIONFALLOFF=this.reflectionFalloffDistance>0,this._reflectionControls.x=this.reflectionAmount,this._reflectionControls.y=this.reflectionReflectance0,this._reflectionControls.z=this.reflectionReflectance90,this._reflectionControls.w=1/this.reflectionFalloffDistance):(a.REFLECTIONFRESNEL=!1,a.REFLECTIONFALLOFF=!1)}else a.REFLECTIONFRESNEL=!1,a.REFLECTIONFALLOFF=!1,a.REFLECTIONBLUR=!1}a.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,a.USERGBCOLOR=this._useRGBColor,a.NOISE=this._enableNoise}if(a._areLightsDirty&&(a.USEHIGHLIGHTANDSHADOWCOLORS=!this._useRGBColor&&(this._primaryColorShadowLevel!==0||this._primaryColorHighlightLevel!==0),a.BACKMAT_SHADOWONLY=this._shadowOnly),a._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(a)}if(a._areMiscDirty&&(a.REFLECTIONMAP_3D&&this._enableGroundProjection?(a.PROJECTED_GROUND=!0,a.REFLECTIONMAP_SKYBOX=!0):a.PROJECTED_GROUND=!1),Cu(e,n,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this.needAlphaTestingForMesh(e),a,void 0,void 0,void 0,this._setVertexOutputInvariant),yu(n,o,this,a,i,null,t.getRenderingMesh().hasThinInstances),Iu(e,a,!1,!0,!1)&&e&&!n.getEngine().getCaps().standardDerivatives&&!e.isVerticesDataPresent(M.NormalKind)&&(e.createNormals(!0),N.Warn("BackgroundMaterial: Normals have been created for the mesh: "+e.name)),a.isDirty){a.markAsProcessed(),n.resetCachedMaterial();const l=new Ma;a.FOG&&l.addFallback(0,"FOG"),a.POINTSIZE&&l.addFallback(1,"POINTSIZE"),a.MULTIVIEW&&l.addFallback(0,"MULTIVIEW"),Gm(a,l,this._maxSimultaneousLights);const c=[M.PositionKind];a.NORMAL&&c.push(M.NormalKind),a.UV1&&c.push(M.UVKind),a.UV2&&c.push(M.UV2Kind),zm(c,e,a,l),Ru(c,a);const u=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","mBones","vPrimaryColor","vPrimaryColorShadow","fFovMultiplier","shadowLevel","alpha","vBackgroundCenter","vReflectionControl","vDiffuseInfos","diffuseMatrix","projectedGroundInfos","logarithmicDepthConstant"];Na(u);const h=["diffuseSampler"];Wm(u,h,!1);const d=["Material","Scene"];bi&&(bi.PrepareUniforms(u,a),bi.PrepareSamplers(h,a)),Au({uniformsNames:u,uniformBuffersNames:d,samplers:h,defines:a,maxSimultaneousLights:this._maxSimultaneousLights});const f=a.toString(),m=n.getEngine().createEffect("background",{attributes:c,uniformsNames:u,uniformBuffersNames:d,samplers:h,defines:f,fallbacks:l,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights},shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{this.shaderLanguage===1?await Promise.all([U(()=>Promise.resolve().then(()=>U3),void 0),U(()=>Promise.resolve().then(()=>z3),void 0)]):await Promise.all([U(()=>Promise.resolve().then(()=>X3),void 0),U(()=>Promise.resolve().then(()=>Z3),void 0)]),this._shadersLoaded=!0}},o);t.setEffect(m,a,this._materialContext),this.buildUniformLayout()}return!t.effect||!t.effect.isReady()?!1:(a._renderId=n.getRenderId(),r._wasPreviouslyReady=!0,r._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),!0)}_computePrimaryColorFromPerceptualColor(){this.__perceptualColor&&(this._primaryColor.copyFrom(this.__perceptualColor),this._primaryColor.toLinearSpaceToRef(this._primaryColor,this.getScene().getEngine().useExactSrgbConversions),this._imageProcessingConfiguration&&this._primaryColor.scaleToRef(1/this._imageProcessingConfiguration.exposure,this._primaryColor),this._computePrimaryColors())}_computePrimaryColors(){this._primaryColorShadowLevel===0&&this._primaryColorHighlightLevel===0||(this._primaryColor.scaleToRef(this._primaryColorShadowLevel,this._primaryShadowColor),this._primaryColor.subtractToRef(this._primaryShadowColor,this._primaryShadowColor),this._white.subtractToRef(this._primaryColor,this._primaryHighlightColor),this._primaryHighlightColor.scaleToRef(this._primaryColorHighlightLevel,this._primaryHighlightColor),this._primaryColor.addToRef(this._primaryHighlightColor,this._primaryHighlightColor))}buildUniformLayout(){this._uniformBuffer.addUniform("vPrimaryColor",4),this._uniformBuffer.addUniform("vPrimaryColorShadow",4),this._uniformBuffer.addUniform("vDiffuseInfos",2),this._uniformBuffer.addUniform("diffuseMatrix",16),this._uniformBuffer.addUniform("fFovMultiplier",1),this._uniformBuffer.addUniform("pointSize",1),this._uniformBuffer.addUniform("shadowLevel",1),this._uniformBuffer.addUniform("alpha",1),this._uniformBuffer.addUniform("vBackgroundCenter",3),this._uniformBuffer.addUniform("vReflectionControl",4),this._uniformBuffer.addUniform("projectedGroundInfos",2),Hm(this._uniformBuffer,!0,!1,!1),this._uniformBuffer.create()}unbind(){this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._uniformBuffer.setTexture("diffuseSampler",null),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._uniformBuffer.setTexture("reflectionSampler",null),super.unbind()}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindForSubMesh(e,t,i){const r=this.getScene(),n=i.materialDefines;if(!n)return;const a=i.effect;if(!a)return;this._activeEffect=a,this.bindOnlyWorldMatrix(e),Bo(t,this._activeEffect);const o=this._mustRebind(r,a,i,t.visibility);if(o){this._uniformBuffer.bindToEffect(a,"Material"),this.bindViewProjection(a);const l=this._reflectionTexture;(!this._uniformBuffer.useUbo||!this.isFrozen||!this._uniformBuffer.isSync||i._drawWrapper._forceRebindOnNextCall)&&(r.texturesEnabled&&(this._diffuseTexture&&K.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),Dt(this._diffuseTexture,this._uniformBuffer,"diffuse")),$m(r,n,this._uniformBuffer,q.White(),l,!1,!0,!1,!1,!1,!1,this._reflectionBlur)),this.shadowLevel>0&&this._uniformBuffer.updateFloat("shadowLevel",this.shadowLevel),this._uniformBuffer.updateFloat("alpha",this.alpha),this.pointsCloud&&this._uniformBuffer.updateFloat("pointSize",this.pointSize),n.USEHIGHLIGHTANDSHADOWCOLORS?(this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryHighlightColor,1),this._uniformBuffer.updateColor4("vPrimaryColorShadow",this._primaryShadowColor,1)):this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryColor,1)),this._uniformBuffer.updateFloat("fFovMultiplier",this._fovMultiplier),r.texturesEnabled&&(this._diffuseTexture&&K.DiffuseTextureEnabled&&this._uniformBuffer.setTexture("diffuseSampler",this._diffuseTexture),l&&K.ReflectionTextureEnabled&&(Xm(r,n,this._uniformBuffer,l),n.REFLECTIONFRESNEL&&(this._uniformBuffer.updateFloat3("vBackgroundCenter",this.sceneCenter.x,this.sceneCenter.y,this.sceneCenter.z),this._uniformBuffer.updateFloat4("vReflectionControl",this._reflectionControls.x,this._reflectionControls.y,this._reflectionControls.z,this._reflectionControls.w))),n.PROJECTED_GROUND&&this._uniformBuffer.updateFloat2("projectedGroundInfos",this.projectedGroundRadius,this.projectedGroundHeight)),jn(this._activeEffect,this,r),r.bindEyePosition(a)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._uniformBuffer.bindToEffect(a,"Material"),this._needToBindSceneUbo=!0);(o||!this.isFrozen)&&(r.lightsEnabled&&ql(r,t,this._activeEffect,n,this._maxSimultaneousLights),this.bindView(a),Pu(r,t,this._activeEffect,!0),this._useLogarithmicDepth&&Vo(n,a,r),this._imageProcessingConfiguration&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect,i),this._uniformBuffer.update()}hasTexture(e){return!!(super.hasTexture(e)||this._reflectionTexture===e||this._diffuseTexture===e)}dispose(e=!1,t=!1){t&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e)}clone(e){return me.Clone(()=>new Re(e,this.getScene()),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.BackgroundMaterial",e}getClassName(){return"BackgroundMaterial"}static Parse(e,t,i){return me.Parse(()=>new Re(e.name,t),e,t,i)}}Re.StandardReflectance0=.05;Re.StandardReflectance90=.5;_([Xt()],Re.prototype,"_primaryColor",void 0);_([W("_markAllSubMeshesAsLightsDirty")],Re.prototype,"primaryColor",void 0);_([Xt()],Re.prototype,"__perceptualColor",void 0);_([R()],Re.prototype,"_primaryColorShadowLevel",void 0);_([R()],Re.prototype,"_primaryColorHighlightLevel",void 0);_([W("_markAllSubMeshesAsLightsDirty")],Re.prototype,"primaryColorHighlightLevel",null);_([We()],Re.prototype,"_reflectionTexture",void 0);_([W("_markAllSubMeshesAsTexturesDirty")],Re.prototype,"reflectionTexture",void 0);_([R()],Re.prototype,"_reflectionBlur",void 0);_([W("_markAllSubMeshesAsTexturesDirty")],Re.prototype,"reflectionBlur",void 0);_([We()],Re.prototype,"_diffuseTexture",void 0);_([W("_markAllSubMeshesAsTexturesDirty")],Re.prototype,"diffuseTexture",void 0);_([W("_markAllSubMeshesAsTexturesDirty")],Re.prototype,"shadowLights",void 0);_([R()],Re.prototype,"_shadowLevel",void 0);_([W("_markAllSubMeshesAsTexturesDirty")],Re.prototype,"shadowLevel",void 0);_([Cn()],Re.prototype,"_sceneCenter",void 0);_([W("_markAllSubMeshesAsTexturesDirty")],Re.prototype,"sceneCenter",void 0);_([R()],Re.prototype,"_opacityFresnel",void 0);_([W("_markAllSubMeshesAsTexturesDirty")],Re.prototype,"opacityFresnel",void 0);_([R()],Re.prototype,"_reflectionFresnel",void 0);_([W("_markAllSubMeshesAsTexturesDirty")],Re.prototype,"reflectionFresnel",void 0);_([R()],Re.prototype,"_reflectionFalloffDistance",void 0);_([W("_markAllSubMeshesAsTexturesDirty")],Re.prototype,"reflectionFalloffDistance",void 0);_([R()],Re.prototype,"_reflectionAmount",void 0);_([W("_markAllSubMeshesAsTexturesDirty")],Re.prototype,"reflectionAmount",void 0);_([R()],Re.prototype,"_reflectionReflectance0",void 0);_([W("_markAllSubMeshesAsTexturesDirty")],Re.prototype,"reflectionReflectance0",void 0);_([R()],Re.prototype,"_reflectionReflectance90",void 0);_([W("_markAllSubMeshesAsTexturesDirty")],Re.prototype,"reflectionReflectance90",void 0);_([R()],Re.prototype,"_useRGBColor",void 0);_([W("_markAllSubMeshesAsTexturesDirty")],Re.prototype,"useRGBColor",void 0);_([R()],Re.prototype,"_enableNoise",void 0);_([W("_markAllSubMeshesAsTexturesDirty")],Re.prototype,"enableNoise",void 0);_([R()],Re.prototype,"_maxSimultaneousLights",void 0);_([W("_markAllSubMeshesAsTexturesDirty")],Re.prototype,"maxSimultaneousLights",void 0);_([R()],Re.prototype,"_shadowOnly",void 0);_([W("_markAllSubMeshesAsLightsDirty")],Re.prototype,"shadowOnly",void 0);_([R(),W("_markAllSubMeshesAsMiscDirty")],Re.prototype,"enableGroundProjection",void 0);_([R()],Re.prototype,"projectedGroundRadius",void 0);_([R()],Re.prototype,"projectedGroundHeight",void 0);y("BABYLON.BackgroundMaterial",Re);class Ra{static _GetDefaultOptions(e){return{createGround:!0,groundSize:15,groundTexture:j.GetAssetUrl(this._GroundTextureCDNUrl),groundColor:new q(.2,.2,.3).toLinearSpace(e.getEngine().useExactSrgbConversions).scale(3),groundOpacity:.9,enableGroundShadow:!0,groundShadowLevel:.5,enableGroundMirror:!1,groundMirrorSizeRatio:.3,groundMirrorBlurKernel:64,groundMirrorAmount:1,groundMirrorFresnelWeight:1,groundMirrorFallOffDistance:0,groundMirrorTextureType:0,groundYBias:1e-5,createSkybox:!0,skyboxSize:20,skyboxTexture:j.GetAssetUrl(this._SkyboxTextureCDNUrl),skyboxColor:new q(.2,.2,.3).toLinearSpace(e.getEngine().useExactSrgbConversions).scale(3),backgroundYRotation:0,sizeAuto:!0,rootPosition:x.Zero(),setupImageProcessing:!0,environmentTexture:j.GetAssetUrl(this._EnvironmentTextureCDNUrl),cameraExposure:.8,cameraContrast:1.2,toneMappingEnabled:!0}}get rootMesh(){return this._rootMesh}get skybox(){return this._skybox}get skyboxTexture(){return this._skyboxTexture}get skyboxMaterial(){return this._skyboxMaterial}get ground(){return this._ground}get groundTexture(){return this._groundTexture}get groundMirror(){return this._groundMirror}get groundMirrorRenderList(){return this._groundMirror?this._groundMirror.renderList:null}get groundMaterial(){return this._groundMaterial}constructor(e,t){this._errorHandler=(i,r)=>{this.onErrorObservable.notifyObservers({message:i,exception:r})},this._options={...Ra._GetDefaultOptions(t),...e},this._scene=t,this.onErrorObservable=new k,this._setupBackground(),this._setupImageProcessing()}updateOptions(e){const t={...this._options,...e};this._ground&&!t.createGround&&(this._ground.dispose(),this._ground=null),this._groundMaterial&&!t.createGround&&(this._groundMaterial.dispose(),this._groundMaterial=null),this._groundTexture&&this._options.groundTexture!=t.groundTexture&&(this._groundTexture.dispose(),this._groundTexture=null),this._skybox&&!t.createSkybox&&(this._skybox.dispose(),this._skybox=null),this._skyboxMaterial&&!t.createSkybox&&(this._skyboxMaterial.dispose(),this._skyboxMaterial=null),this._skyboxTexture&&this._options.skyboxTexture!=t.skyboxTexture&&(this._skyboxTexture.dispose(),this._skyboxTexture=null),this._groundMirror&&!t.enableGroundMirror&&(this._groundMirror.dispose(),this._groundMirror=null),this._scene.environmentTexture&&this._options.environmentTexture!=t.environmentTexture&&this._scene.environmentTexture.dispose(),this._options=t,this._setupBackground(),this._setupImageProcessing()}setMainColor(e){this.groundMaterial&&(this.groundMaterial.primaryColor=e),this.skyboxMaterial&&(this.skyboxMaterial.primaryColor=e),this.groundMirror&&(this.groundMirror.clearColor=new Te(e.r,e.g,e.b,1))}_setupImageProcessing(){this._options.setupImageProcessing&&(this._scene.imageProcessingConfiguration.contrast=this._options.cameraContrast,this._scene.imageProcessingConfiguration.exposure=this._options.cameraExposure,this._scene.imageProcessingConfiguration.toneMappingEnabled=this._options.toneMappingEnabled,this._setupEnvironmentTexture())}_setupEnvironmentTexture(){if(this._scene.environmentTexture)return;if(this._options.environmentTexture instanceof ps){this._scene.environmentTexture=this._options.environmentTexture;return}const e=ii.CreateFromPrefilteredData(this._options.environmentTexture,this._scene);this._scene.environmentTexture=e}_setupBackground(){this._rootMesh||(this._rootMesh=new Oe("BackgroundHelper",this._scene)),this._rootMesh.rotation.y=this._options.backgroundYRotation;const e=this._getSceneSize();this._options.createGround&&(this._setupGround(e),this._setupGroundMaterial(),this._setupGroundDiffuseTexture(),this._options.enableGroundMirror&&this._setupGroundMirrorTexture(e),this._setupMirrorInGroundMaterial()),this._options.createSkybox&&(this._setupSkybox(e),this._setupSkyboxMaterial(),this._setupSkyboxReflectionTexture()),this._rootMesh.position.x=e.rootPosition.x,this._rootMesh.position.z=e.rootPosition.z,this._rootMesh.position.y=e.rootPosition.y}_getSceneSize(){let e=this._options.groundSize,t=this._options.skyboxSize,i=this._options.rootPosition;if(!this._scene.meshes||this._scene.meshes.length===1)return{groundSize:e,skyboxSize:t,rootPosition:i};const r=this._scene.getWorldExtends(a=>a!==this._ground&&a!==this._rootMesh&&a!==this._skybox),n=r.max.subtract(r.min);if(this._options.sizeAuto){this._scene.activeCamera instanceof wo&&this._scene.activeCamera.upperRadiusLimit&&(e=this._scene.activeCamera.upperRadiusLimit*2,t=e);const a=n.length();a>e&&(e=a*2,t=e),e*=1.1,t*=1.5,i=r.min.add(n.scale(.5)),i.y=r.min.y-this._options.groundYBias}return{groundSize:e,skyboxSize:t,rootPosition:i}}_setupGround(e){(!this._ground||this._ground.isDisposed())&&(this._ground=Ym("BackgroundPlane",{size:e.groundSize},this._scene),this._ground.rotation.x=Math.PI/2,this._ground.isPickable=!1,this._ground.parent=this._rootMesh,this._ground.onDisposeObservable.add(()=>{this._ground=null})),this._ground.receiveShadows=this._options.enableGroundShadow}_setupGroundMaterial(){this._groundMaterial||(this._groundMaterial=new Re("BackgroundPlaneMaterial",this._scene)),this._groundMaterial.alpha=this._options.groundOpacity,this._groundMaterial.alphaMode=8,this._groundMaterial.shadowLevel=this._options.groundShadowLevel,this._groundMaterial.primaryColor=this._options.groundColor,this._groundMaterial.useRGBColor=!1,this._groundMaterial.enableNoise=!0,this._ground&&(this._ground.material=this._groundMaterial)}_setupGroundDiffuseTexture(){if(this._groundMaterial&&!this._groundTexture){if(this._options.groundTexture instanceof ps){this._groundMaterial.diffuseTexture=this._options.groundTexture;return}this._groundTexture=new $(this._options.groundTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._groundTexture.gammaSpace=!1,this._groundTexture.hasAlpha=!0,this._groundMaterial.diffuseTexture=this._groundTexture}}_setupGroundMirrorTexture(e){const t=$.CLAMP_ADDRESSMODE;if(!this._groundMirror&&(this._groundMirror=new _h("BackgroundPlaneMirrorTexture",{ratio:this._options.groundMirrorSizeRatio},this._scene,!1,this._options.groundMirrorTextureType,$.BILINEAR_SAMPLINGMODE,!0),this._groundMirror.mirrorPlane=new jc(0,-1,0,e.rootPosition.y),this._groundMirror.anisotropicFilteringLevel=1,this._groundMirror.wrapU=t,this._groundMirror.wrapV=t,this._groundMirror.renderList))for(let r=0;r<this._scene.meshes.length;r++){const n=this._scene.meshes[r];n!==this._ground&&n!==this._skybox&&n!==this._rootMesh&&this._groundMirror.renderList.push(n)}const i=this._options.groundColor.toGammaSpace(this._scene.getEngine().useExactSrgbConversions);this._groundMirror.clearColor=new Te(i.r,i.g,i.b,1),this._groundMirror.adaptiveBlurKernel=this._options.groundMirrorBlurKernel}_setupMirrorInGroundMaterial(){this._groundMaterial&&(this._groundMaterial.reflectionTexture=this._groundMirror,this._groundMaterial.reflectionFresnel=!0,this._groundMaterial.reflectionAmount=this._options.groundMirrorAmount,this._groundMaterial.reflectionStandardFresnelWeight=this._options.groundMirrorFresnelWeight,this._groundMaterial.reflectionFalloffDistance=this._options.groundMirrorFallOffDistance)}_setupSkybox(e){(!this._skybox||this._skybox.isDisposed())&&(this._skybox=cI("BackgroundSkybox",{size:e.skyboxSize,sideOrientation:Oe.BACKSIDE},this._scene),this._skybox.isPickable=!1,this._skybox.onDisposeObservable.add(()=>{this._skybox=null})),this._skybox.parent=this._rootMesh}_setupSkyboxMaterial(){this._skybox&&(this._skyboxMaterial||(this._skyboxMaterial=new Re("BackgroundSkyboxMaterial",this._scene)),this._skyboxMaterial.useRGBColor=!1,this._skyboxMaterial.primaryColor=this._options.skyboxColor,this._skyboxMaterial.enableNoise=!0,this._skybox.material=this._skyboxMaterial)}_setupSkyboxReflectionTexture(){if(this._skyboxMaterial&&!this._skyboxTexture){if(this._options.skyboxTexture instanceof ps){this._skyboxMaterial.reflectionTexture=this._options.skyboxTexture;return}this._skyboxTexture=new ii(this._options.skyboxTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._skyboxTexture.coordinatesMode=$.SKYBOX_MODE,this._skyboxTexture.gammaSpace=!1,this._skyboxMaterial.reflectionTexture=this._skyboxTexture}}dispose(){this._groundMaterial&&this._groundMaterial.dispose(!0,!0),this._skyboxMaterial&&this._skyboxMaterial.dispose(!0,!0),this._rootMesh.dispose(!1)}}Ra._GroundTextureCDNUrl="https://assets.babylonjs.com/core/environments/backgroundGround.png";Ra._SkyboxTextureCDNUrl="https://assets.babylonjs.com/core/environments/backgroundSkybox.dds";Ra._EnvironmentTextureCDNUrl="https://assets.babylonjs.com/core/environments/environmentSpecular.env";class qi extends Es{get texture(){return this._texture}set texture(e){this._texture!==e&&(this._texture=e,this._useDirectMapping?(this._texture.wrapU=$.CLAMP_ADDRESSMODE,this._texture.wrapV=$.CLAMP_ADDRESSMODE,this._material.diffuseTexture=this._texture):(this._texture.coordinatesMode=$.FIXED_EQUIRECTANGULAR_MIRRORED_MODE,this._texture.wrapV=$.CLAMP_ADDRESSMODE,this._material.reflectionTexture=this._texture),this._changeTextureMode(this._textureMode))}get mesh(){return this._mesh}get fovMultiplier(){return this._material.fovMultiplier}set fovMultiplier(e){this._material.fovMultiplier=e}get textureMode(){return this._textureMode}set textureMode(e){this._textureMode!==e&&this._changeTextureMode(e)}get halfDome(){return this._halfDome}set halfDome(e){this._halfDome=e,this._halfDomeMask.setEnabled(e),this._changeTextureMode(this._textureMode)}set crossEye(e){this._crossEye=e,this._changeTextureMode(this._textureMode)}get crossEye(){return this._crossEye}get material(){return this._material}constructor(e,t,i,r,n=null){super(e,r),this.onError=n,this._halfDome=!1,this._crossEye=!1,this._useDirectMapping=!1,this._textureMode=qi.MODE_MONOSCOPIC,this._onBeforeCameraRenderObserver=null,this.onLoadErrorObservable=new k,this.onLoadObservable=new k,r=this.getScene(),e=e||"textureDome",i.resolution=Math.abs(i.resolution)|0||32,i.clickToPlay=!!i.clickToPlay,i.autoPlay=i.autoPlay===void 0?!0:!!i.autoPlay,i.loop=i.loop===void 0?!0:!!i.loop,i.size=Math.abs(i.size)||(r.activeCamera?r.activeCamera.maxZ*.48:1e3),i.useDirectMapping===void 0?this._useDirectMapping=!0:this._useDirectMapping=i.useDirectMapping,i.faceForward===void 0&&(i.faceForward=!0),this._setReady(!1),i.mesh?this._mesh=i.mesh:this._mesh=Sn(e+"_mesh",{segments:i.resolution,diameter:i.size,updatable:!1,sideOrientation:Oe.BACKSIDE},r);const a=this._material=new Re(e+"_material",r);a.useEquirectangularFOV=!0,a.fovMultiplier=1,a.opacityFresnel=!1;const o=this._initTexture(t,r,i);if(this.texture=o,this._mesh.material=a,this._mesh.parent=this,this._halfDomeMask=Sn("",{slice:.5,diameter:i.size*.98,segments:i.resolution*2,sideOrientation:Oe.BACKSIDE},r),this._halfDomeMask.rotate(Ms.X,-Math.PI/2),this._halfDomeMask.parent=this._mesh,this._halfDome=!!i.halfDomeMode,this._halfDomeMask.setEnabled(this._halfDome),this._crossEye=!!i.crossEyeMode,this._texture.anisotropicFilteringLevel=1,this._texture.onLoadObservable.addOnce(()=>{this._setReady(!0)}),i.faceForward&&r.activeCamera){const l=r.activeCamera,c=x.Forward(),u=x.TransformNormal(c,l.getViewMatrix());u.normalize(),this.rotation.y=Math.acos(x.Dot(c,u))}this._changeTextureMode(this._textureMode)}_changeTextureMode(e){switch(this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._textureMode=e,this._texture.uScale=1,this._texture.vScale=1,this._texture.uOffset=0,this._texture.vOffset=0,this._texture.vAng=0,e){case qi.MODE_MONOSCOPIC:this._halfDome&&(this._texture.uScale=2,this._texture.uOffset=-1);break;case qi.MODE_SIDEBYSIDE:{this._texture.uScale=this._halfDome?.99999:.5;const t=this._halfDome?0:.5,i=this._halfDome?-.5:0;this._onBeforeCameraRenderObserver=this._scene.onBeforeCameraRenderObservable.add(r=>{let n=r.isRightCamera;this._crossEye&&(n=!n),n?this._texture.uOffset=t:this._texture.uOffset=i});break}case qi.MODE_TOPBOTTOM:this._texture.vScale=this._halfDome?.99999:.5,this._onBeforeCameraRenderObserver=this._scene.onBeforeCameraRenderObservable.add(t=>{let i=t.isRightCamera;this._crossEye&&(i=!i),this._texture.vOffset=i?.5:0});break}}dispose(e,t=!1){this._texture.dispose(),this._mesh.dispose(),this._material.dispose(),this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this.onLoadErrorObservable.clear(),this.onLoadObservable.clear(),super.dispose(e,t)}}qi.MODE_MONOSCOPIC=0;qi.MODE_TOPBOTTOM=1;qi.MODE_SIDEBYSIDE=2;class I_ extends qi{get photoTexture(){return this.texture}set photoTexture(e){this.texture=e}get imageMode(){return this.textureMode}set imageMode(e){this.textureMode=e}_initTexture(e,t,i){return new $(e,t,!i.generateMipMaps,!this._useDirectMapping,void 0,()=>{this.onLoadObservable.notifyObservers()},(r,n)=>{this.onLoadErrorObservable.notifyObservers(r||"Unknown error occured"),this.onError&&this.onError(r,n)})}}I_.MODE_MONOSCOPIC=qi.MODE_MONOSCOPIC;I_.MODE_TOPBOTTOM=qi.MODE_TOPBOTTOM;I_.MODE_SIDEBYSIDE=qi.MODE_SIDEBYSIDE;const EV="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAgAElEQVR42u29yY5tWXIlZnbuiSaTbZFUkZRKrCKhElASQA0EoQABgn6hJvoXzfUP+gP9hWb6Bg00IgRoQJaKqUxmZmTEe8/v0uB2u7Fm2T7HIyIrnz88uPvt3f2a2WrMbOvf/u3PvvzP/sUf/N6//i8vf/lv/3v5H//d//Sb//Uq/5u8yf8hV/m/5Cp/L1f5hVzlG7nKJ7mKyJuIXN/hPwqXI/g++zq6rPI5u8z+WqfLre+zy7PrVv9L8brsMiGvk8XLmM/sdfHXal4e3ad6GXPdyu2ij8u/+uv/5cuf/OSLfdtEfvUr+dnf/d0X//t3H/7bf/hP//N/928h/0Yg/4VA/kogfyGQP5Wr/IFAvhbIlwK5CGQTPP+9z5uPeePJSW+yo2+s/GtN30Rnv1E+f5zxof9R/lSXv/nr//mrr3+i+5dfyX7ZZQP07Tffys//8R/l/9TtX7790T/7r/8G8pdy+/8XAvnnAvkzgfwzgfyxQP5AIL8vkJ8K5KsmMVzu1U7p5PA5AXxOAJ8TwPf7sX/51ZeXfcemqnp9w/W77/S7X/6T/vzf/7383RWCX3/z05/9i3/13/0PX//eX/2FyP8tIv+PiPy9iPy/IvIzEfm5iPxCRH4lIt/c/393//9BRD6KyKf7f488fP74/PH544dJAF9cLl98IZfLBZtuqterXr/7Dt9982v95S9+Lv+gF/3i7Spv/8lf/vnf/vGf/dF/JfKnIvLnIvLvReQ/NEngn0TklyLy6/v/34jIt00iGJOBlxAsdvv54/PH5493SQCXy9t2ueh2ueimKorrFbjq9eNH+fDtb+TXv/ol/vHyhX4Fxfbx7euPf/Lnf/PfiPyeiPyhiPxxkwB+fk8AvxzQgJcIrGTwFsiAEXH4/PH54/PHUgLY7whgu2C7bLqpQgHB2xvePn6SDx8+6G9+84384vKF/IPu8iVU9Y/+7C/+jWxffiHytYj8VER+X0T+oEEBvxqQwCMJeIngo5EI3goIwVMIPn98/vj8ESaAbbtu2ybbvl8u2ybbdtluSECA65u8ffqIDx8+6G++/VZ/efkV/sO261dQXP7wT/7kX8vl8qXIFyLylbySwe/dE0CLAr65B/9vGn0gQwRMMqgmhM/J4fPH548eAezbZd/lsm3YtssNAYiqiogAAkCvb5/k46cP8u2HD/rrb7+R/2/b9Wu9yJe//8d/9Ney6S5yEZFdRL68/38khG/uKOCnAwoYkcCoEXwkEgGDDq7CeQfyOTl8/vhd1QCum26ybZtu2yabbrKpQvXue1yvuF6v+vbpTT5+/CDffviAX1++1V9sO77WXb/66R/+4V/dgkbllQi+aBLBV/dE8LWRALwkYCWCNyMZXElkwLTMeMkga/P4/PH547ccAVwuctkvdxSw6bbdtYDbTfSZBN7e8PHTR/3u4wf55vKd/nL7DX6mu3791U9//5+/gkNFZGuSgZUQvnKowKgLWLTAQgRtEniTuEfwaELw0MJvf3LQzynud+53uG+X6y3gN9kul+2y6XVT1U27JCDAFVc8ksAn/e7jR/nN5YP+avtWfq6Xy9f7Vz/9w1dgRYngiyYhfNkkgzYBWHTg44AEMmqQUYQKOmDaiCIa8TmsfmzB+DnZDQjgcpGLbti2y3bZHjRAdRMVvb/dcYU8kcDbPQlsH/CrbddfbF98+RPZfvLFnAQeieCRDC5DMvju/vmD4JkEvjRQgKULeGggowdHkAHTYxihg89vu88I5UeGAPSOAFTlrgPopiqbKPSmCKreUoAAkCcSePukHz590m8vH+WbD9/JP335k6/+tA86KxFchv8jMvhiogE4JQm8XhfKqOAqx5qRPyeGzx8/cgSwbXcUoLJtim27C4Oi93+4v6VxQwKAvl2v+Hj9pB8+fZJvt4/yzfbF9lPdv/wJnsE2BogmyeCRED40tGFvksIXiSbgiYSRRpDNDZ6BDI6ghM+J4fPHeyKAO+zX7cb9t4tedMMNAQju5V+f1uAtBSiu1zsduMrHy5t8ePsk3376KN98sX/xE5FPAnm7/782o0DiUINXMkCXCB7/P94/e87AWUmARQWVvgMuKej9t1RLBp+Tw+ePgwngsutFFdu26WXbbl+rSvdfbnqAiuA23QcBgCugV1zl7e1NPm5v+LC96XfbJ/1W9y++fgXjA3bDYXV+MuhRwSPwL3JLMFYC+HS/LU8HYrGwIhwyNOF12SvgM4SgztdifP85MXz+KGsA2C6X7aJ6bXSAOwrY5OYIqGy3d5uq4P5GhABXuV6veLvRAf10fZMPb2/y3b7vX7+g+9v98/WOBq7GG7RNAlYy+Dgkhhb+Xxp0sE8IAC4SGAP/TbgVJK/PoJPBnAiwPKxsXfbbnRg+i3s/JAK4Q/4b9NfLtomBAqCickMBjy7BuywAUVyv8na94tMjCVzf9KNcLl/0SeA6oAEYb1i9g+FtSALb/bKL8/+t+wxXFMyswqiHoK4ToIgKqslgpg1qUC0QoYbvJZg/B/q5v4szHmPX7YEAsD0CX25OwEUVm9xag1+agKg+nxQArnKjAtDr9U0+Xd/k4/UqH7bL5YsewrcBBiMJZPRAp6TwQgWfjM9vgRbgUYGL8AvLWH2gqhesCokeUmCSwPsnhs8fP2YNYMO2XeSmAWxy2VQaXeDmDIhApf33rD4PTUCuV+DtCn27XuXT5ir8VmCJ2G5BpBM8/r/dEcJb8/0lEQMtJHA5TAlqNuLRhJChhEpSqFabH3di+G1AGj+W1/dyAR4IYJNNnuLf6+tWC9CHHiAtFhAIFLjK2/Uqn65X+SS67aK+3QeTDoy/IG2ogQ7fb/dAtz5vBgrYGqrwNtCHsVfgIvwK07OTQBURVNCBFpKCOjqCHn5L/67TgTN+fpySAC56nwSUi256kXsSuFGAVyLoUIDo8/Pz7fdoErr/v17lk162HbgHvFpIYDfoAJJfW4sGPjkU4VNAF8ZEcLmLhdc7kljdY1y1Dq9yLiI4IiRqcLujb138KIPn80ejATwRwIbtBvn1cqv+2J78/5EI5N4cJA8qIPcmwRsKAHDF9WYP6mV7VmrgLuTpxYTcMEW0LAmoQxFsuvAI8tv/a/C5fV2ZMMiKg++FCM7RDPRu8ebWY7VG6VJi+Bzk35MI2LsAckMAgwvQ0gC5DQjd3ABg2HQLAPpEAlZ1Bu7VV7MGHDFRAbo3VKsTbAY9sPWC/uvx86gBbDK3D1eEQS8pbAeSgSwmhepnJb6uBv/o/PzHLzxWA/X7TH77De5j6AGQi6o0CUGfCOD2X7cXAlCFQABtEsGLDtxuOyQB2UTQBKZe5GUPXgkUYCUAbZJRhBDeuq8xBf+bgwbehDm+BFQi2IJksOocvA8ysIMfxluVcRsY/eB3JzH8GFDAXQO48X/dcIf9jyDHptIigDsFkEe066tBSETQUYF7ElDdYEBytN4+rk9UcBPfrKaZqFHWcw3i4J8/X4ev2//bSXqAhwTay6OEIPLD2Ipt8OtAGzxkwLw9WVFRjTc/qC6H3+YK/b1oAA0KuOizHfieCLaHHiAb5NYTIC9EMEbZrVEQt1xwhVy1UfBh8PUOquMizwaap3tQXfY5B//tea/NZdfhsvbz+PURQTDSGWB87VX/7WSd4KxjUqrIgE0IUkoKGnhIvwvawpGf6eECXJ7tv4qbA7DJgwpsKthEmmYgfaAAffYF3HLxo0vwNjJ0SwRWMG4db4eh1gPNm18vQ+us/0eGmxDemu/fnM/X4evq/8342ksGHgLY5LyT/zg0wM8lcMjgGFXwqIOVFJBQw99eCvF9oZL9Mfl3QwAvIXDsBRC9R+fz8x0FPBLB0xJEpwUobrfAkARgIAF41h3wQgP6QAmX5E/7eI43IxGwwf/moIkRyWRJQIPgt9CA9b39nzt4bYUWjAlCjWDPgv8IEjgLJfzuaAsrv9VdVG4OwOXW/fdoA35qAdL0BDwvf6AAUVHd8LIEu94A3K+Q+2YxaB84MOH62P//qoo38fCRDERE2zf0JfmDa+MieElAjcDPKz+mRKCOtdgGtXaBjgNJ4H2owSpNeAW/rRH4CaHSpMwnBYYycjgSJwfie9CR6mPu20Uv8kABF206AvXlBMiIBPSlB9wjBW1fwEuSb94296VCqgMaGCt/G1BbExi3IG+r3a3J6P48Gv/J0YmEYoiGY7V/SxwFCwGoE/xa0AJ0CEiV9QPCJb1OJ5F1VTjEY2/MO9AEJvj1BJTQpqLfTlGwjABuzT962e4IoKnyrdh3+/6mzDVJ4PHOxj0JqGKoy20+wBMN6D1gLWi9NQHfVP5MEEPzjGYy8BMAOnTAJgEr8HUIejRo5xrA5xkR5AngmiSHs+zDDAmMgWzTg55GSJEmHE8IvWPAoYTfhWak/Wn/bQ0CGLSAjv83SUEfKp5q24LXuQICpzrjrgWoza8xVE00CQCORdhMJuTUT/rjuls0gO4Iby8BIEgK6gS7BsGuTtDrScH/fR68biUHNVGBnxjeNyHEvQe/ve3LZQqgG3rof6cEclsNflG9J4KtaQ8WHcVBHS1BtHE4QP9OBMS98mpbKTeDW7dJwRsnHpMBTFJpV4I+b0kY/NqInVFSyBLANbnMSgBM8F+Fqfxq/h657/Up+GaBnwV9hRqc9bZ/vA6vu+T9E8KPJWns94UfTeCj2QXwCHS9dNL8Xf3Ho/rfewSeFODGDV69AU0y6NFAE1DP3qK++rdB7/1HRxf86gT376zOr99T/h/ioBiXWQkgQgVeIrCC/WomhDmQK+hASI2ARQZKooHMLdCJwGEBBXC3+uERwg+VOHZ9ioAt9H80AI06wGgJ3nQA3BoCut6AhxYwgcPOFnxuFnrphk+NIKIGrWPQtgz3b0i7Y6D5rs1GKqTop0nQX52vmQC4BkjA+r4a7Kx9WLENGeegkhSETBCrNXIMdi/444Rw1n6E96ry7OPuj8UfLxtQ78NA2iSBbg7gIiIbdDLsb5agPhLC3RkYKv8NDbS2YGsatNRAG2oQwf9ZIOydgy1MAzBkAw8UwEEIDzSAqdPQ6za0PkeJAMH3Z0wXniUSZoHvBXU2mcjQgv56TedIKglCpIoQfgwCIjOytd8WgN0bfxoR8Fn9Gx0Aj5Zgq0lIZbsH/ibSJoFnS+C98g9ooHEELI3gliy25yONIiE6pb0NfBlyNEYyENoodkKwgl6I6s8kARgJ4ZoEfuYWHLEJa0LhSBXm7kImGeSfVdoJ1DO2G7WXsehAptupSOoyrCSF904k+6vt98X/ZcM98Hsd4JYIXhQAIg3/f9AAUYhsLQKAtkHVBnzjCKhOoYl2ym+iBtvzDzQ2DLXJ4PUmbJHAVnBQX4jkxfvHhNDqAdHXGQJgv0aSDGItgOseHIU+K9hXnIJzkoGlEKzNHagTdJ6VWEUH4iCKH4fd2AwDPaYBm4Wgng4gQ9V/CoGiuNmD04AQtNGMGzSAAQ2I2pzfogY9LRh7BrbOh4+D30sAencljFu2CUFrwY8UAWRfWwGvVOVfbx2uIILM0pwDv082dUTw8hYs8L+uIWiHGpWgClnAa1lMPJogovvvbePPs/q3Xr++kgCsfgB5oQF9WYKPJqEn6G+OE3i5AqouF59FQOmahQC8rlPLj38kg1c2f30vw+XaoIX24/pMGIgSBoZqoH3wo0sIIGlA9PWcCPrAtpPB8eBf6x1o6cHra+2+tpIFP4PgBfxZtZUJfo4qxELT948D9ucK8Mt9+ccjIQw6QJcEbrD/1g340ATuDgDkFfx6twSf1f9xvuBECYxq/7ythQQGm+5JDx6Brw4CkMGT3wgscCUoQ4sU2t6DR2ciBjTgtcpenQoZVX9NuL4Owc+dVaDursYVkVALX+shjSBKBuvCYDUZjE5BdNkxdHAUBexyHwB6NP7Iyw7sxUDViwge1t+mz8B/LAvVx/c3PeBBCToB8IUGOgqA3iV4yUg6UAOxaUFHDx6CYS8SorMOue0CCJGAf5YfRhoAI+A1CvwxqNkAY5yAIx2EQmkFfeWOXi+nEdSQQA0ZHMEItiagJArQxDXIrj8nCfQi4HZPAttrIahso9oPQ/2/JwV5JQU8zw+7I4D7/sBn4EO6rjw0FR+i3Z9fHtahzsFvJgM0X+tmVH5vaYiNDGAigewAz+gyNLThnjCURQFR1b9d3lZvnVqmj9mEPDKIUIC4KCCjBXywS4N+otp/Hk3QVthOkwEKlV9PQwXjT7s/zwF4Qf9toAAzFdjuaEB6S7D1//U5FIQu2MevO0rQQH8ZmoXE6B/IkgE60XCjVoq8gt2iCG0S8L5GdxkM1cGsfsCMArSCAnrr7dzAZxCEEpepvB8tqHJ/q+bmJGGts/AcAXFOMMeTwC7Pw0B6CtCtA2vWgonqBQJFSwH0JQK29OB2kvgj2HHXAoyeAIsCQO0kMNECAhFMqCBf8mElAkyBbX1tJQP2RJ/ha0gpAfS9l+/5n00CkrQpq0MZbOdAuxmMvHswog62jZj7BnYQe19b14kxNq2D/ehX/p68HEcF+x3yP7z/V/A/q/5DA3i5A/dzA5pdgbKp3v3/wQF4Bb70WkCTHGRAA6+KL0bFl6FJaFw0ImZwm6igSwbbwPn9RMBWf3sN2JgA/BVh/Rg0kQBgePf6HglAHLFQwqQQOwDjbdVxNZjR4iM6Qa3WxwvNxh0JFb3g/WzFQQS8b/ttKcDWoABtUMAd8j9hf0MB2uDXhzX4CHj03L9DBU3Qjz0C0l4mLSLQPicOOwZoVCB6P6dA7nDbGkVuxcNr8PU2JQO4wX5trEqmccZaHU4q8oCDFOpzAnOwqyMIMktNNNAHouDGxO37DgArQZzlmp/14W1QlqHTMaIIx7SCx0+5yza7AKJ3IXBrNAHVDcMZAU/BT/vgv/ULPOA+XiLggAREDF2g0ci6xNDRglegd7P7TWWH5oJfayliEg7bScQRBVgI4Ookg/F6rvpLWP29swREqA3CaG8/FpKqS8DTAV4TiBqIqtxfzaQRLys5I0XEFIFrPbZRQb+16Fgi2LvJv8EFUPW1gGfQv1T/F/d/HBnccP7rAwnIIyHI4ArgWeGbU4eHy6Tx/EeTZIb5bo/BsMBjmjBE08f/RB0PHYBd9eVRAGY7cHRwiBf8WeCPHY1bgBTa9xKTELzEkQX9CPtl0gJiqsAmCT7I8xbjivh3JGFI+D2nBcSJQJ8agDX+O9iBL7UfG4bzAkcaICrbtYHz1ycSmGmAjJfL3CMgT3tQpmrfB7gxSzC1DnvdhQMieG47u75+kTouKNkM8c/+vq/Q7ZYjO/hhVvRq8F/9gGfhP8aqE9EIdR6LTwJ1h0BItyDqB8iFwuNqASscRnYioxOg9ApvnYA35f8e9Ohbfe8J4rknoFkO0lmA2gmAG0YK0DkB4ieEjiLoMD8wBzom27ANZkzIoU8EMHk/uo1mzeVoEoRWKn8L/62EYAX/lsB7D/LXg74uAMr9oGivJ0CNJCGD6i9DhZdQF+gtOp4S+NODRzsDVbhdgv4BqTMNyIL9SCKwL9/FGPp5oQKxIf8A/UX6r231H7YIqLML0Ae2GtrADOvRQH5b/MPE9dt9BGLNG8jVTAQvIaK5TtvvvWQgDvyXIClUA78S9Nfg7VtIBlO7cbsEYkQDMot+ygQ7QwmOawTHnAM2XUSnJvPIYRYMmYPS+sv3J+cfP3d04JYIXsF/EwMbBKB9Q9AY+BiSwFj9mzrSXmcJhFPVHySTbgHJCPvRQ/z7G/SVUETsg0ZF+i3CRoCjhf7y1A9mOiDD7TwdwEoEXjLwAv+avLE2B7Jnb+OqDpBoAchoQJskxKnss0vu7Q2YhcDv4ySeLOg9GsCKiUIihP7yfW7zbTsBh0TQfN0iAWn9f72Z56/Ax9P7j5OAH/Qvv3/QxKfk0DgDuP+R3USg3bzBC7bO/QT9Eeh9QvDPG7glBQzJwK740lAFFgFk8P88CqDGAa223YckWYhr+c0BPdwetl2ocnsfzePAWcVnnAIp6gDVhDLyfV4nqFEDPxHsbWD3k4BDkN+pARqKMLYBPzYEvxp9xmCHQQdgWH/9EtH2TIFpu3AH/cdGydv1j0TQbRrq+D/mLcX3ZACZ15bF378CG0My6Kq/zoGOQwhASDFwFbxyNGBuSxbCEhQ/uEPe/6gAERWQObCVVfjPpQX+rexxYhYFxIkgpgX7Y/vPs+Pvxf9vwt8kAs7i32t3QCP+3SPaTwIytQXP38u0PESm+YER+o9B3vr8mETAUfDrEkPI80ck0FZ0dXh9U+HRbhey0cAc2H7A4y4egoD6y8JfkBiigLdFP8v2W00E8deT2IeAKujZ/QAVKpAtKI20gLWksHedfgPcb+0+NEHefd9vB9rayi8h7J91gBbaw20MsnWAF5xHkyDUCOoXp+yrOwwxcKj0aL6fFppaaKDv6OpHR5sgx5BAlK/+fYhuP1D196o8e7lFBaKqv5YIMnFQpd0FGVR35RJCnCDaABaXBtgbiSwtICMtalKC+1JQ6bx/PLcDPQL91QFodQNKpwOgF/9eqcBxBBqRcKAAVk+ArQOMx1RYGgB6naDhlK+uQQwJYx4meQbxtNnYQwMjt/d4f3M9ZE4UOld1LAh99fbfzOxiEkKFCkTJIUIMUeVnJ/9sDt8/e1NEJOi9oVHDGYhgnSLss9DX2IAqw1zALUncKcDr0FB5NP+0cBQNrEezDiyiADPkt9qGpwoPdL0AGPx/NOKeyf3b9WJNdfcFv6bKd2cLMJVfJ6Y3B6wB9WFUfWWEwKMfGiQL+3bz9XGQz2EHKhF41GCtZyDi/gUCsNhYoAr3UNJ58YidHKqnMb/6AB5J4N73/4L+t7mAkeeP3P+1LNSB/l0SkMEd8DcEuUlguEw6t2AU/PCE/q++Akw6QFf1u6SBrj1ZnnhG50AfkoGIdf7gJv1KcSfgzWWkQ9U33Z3tHXYASKJ9e/YhU90rvD+q9Ej69/wxYJVs506Eg/r3DkMDzEdDBRGgcZay49XihLA30P+l8N+hf1f57/0AoxbQbwYaan/rBMirE9Dk+sBzTkC8JNDEUlv5McB8PP19Y01Gayep+hC/2zvQ/2HGLAurowsNGlA1cnqGGzeH5weiYLZm7h3QQC4O2tXdhvMMk1ZS5ebpgI8eMrPvPGkwaxayk8Yc6PMOBPEdC1XZ+2UfbfOPtxLMQQAG9BcZFoF0gp/RKjxe7+oAw9T7ZPWhgedodgz0gf5KBtrtIZhQAZpAV1Bi36w6t98qVfH7hqGI318lLCjLCUFlxRHwqYEH9a2qb4XjWvDT7kBwfbZA5P0+PNuRuW1yf4yNQH3zzwv6b70QOJ0G9OT/dhoYRUGT15uQH/71MjQLtQlxfDuiCXrtM+SkA+icQdH6sU/xz7Ze7FlubV4TpoTQ2osdpaEjtqADmEU7OkBEFoLeC3IWFFeswJXKXzkboNL+wzcFHU8hTGKIboO7CLi1/P+5F+gydQhuvRbwEgxvtACmANikhLTbj0gCYk8KdlYgmj+4Ymaod7TwahwadICuX0Cm2fE5iNHPK0x/CDV66Kyg1MnqjNFBnhBoLQCgUULfaVe5nq/6EQWY67bXCszUb+7232fVPz51iGB12owK9peyP1T4raMFF/OEYJP792mgXYfZ04GHMAhBkCSmSj+dKqRPgVFGHbpLEGMiGFeQWfSgrY52VxaeDUPSNJI0P7NoisG729HHl78z6hxfs9rV3m4JjgM/lsui2qmThjCfDFSb+I9vwUqG5wwL55U7C+6ot8B+7N2o6r3q37T9trfpjgmTvv7PSQATLLeRAOZhIJHBQfDQQJPBdUwEbVW3+L08EcEE/9G4ANrCeWcnPKRHDupbNynMx5AA9IRYLmrc/YLSiD5EaEBS/s/TgnU9ILcH19n+CpHwegLejx7Mn/d25fdN+e9U/1vgb7bqf08MOtf8EXxaoh+GY8L6gDfhvs4i6HQ7seYI2sv1GchdMsBIG3xlvxcCRzdgCPTn+6q/TW00VE8Q9FaFv+R2VlOM1vm/hhjhDCdgNflVKME5B47I9xT8z0YgPAJ8myb/LqHy36j/Mwqw9AALxuO1JVjiuQAYLcFzIhiEPe05fk8tRjGw7yWQbsfuLAT2VqOId1osnr0F49VM8INACPHDoBz4B5mqqSnUgyh3ArjXxfQH5BbgUS8gP7aU+w0zHD9GGD0CGHf+P1p/DeivlhU4BbxR9a2kYFR58YaDZCUR2P0DMmgED2eg77puegy6PgDphEB0CwlG/i9d+/Hs34pBEQrBn0W51mqGnJAk3ACCHeiqkQ1XFQA5AlKH7Lk8yJKWY3/nym14h2C3JvxeMwD9ZVMz0BPMi1n1RbKl1cYhIVblF3G0ATsRiCMUvoK9//OgcwYMoe+ZKOLlC6/Xk50br9NFz9fanqA8UIYSpCwlBO4kHc4WLLBfBHVaKwKgLQjmP4Un61Vq+3s7Bsyi0WztmLjJwJwFeE0I2vD/1Q6MVwefxfUf32skCPbCnxQqf+QMPEUDHZ7vGeyj020JgkPXXwsldA7SYR1RE3h94NvNtugswcgxXEkIcBPCGZ1rmrgDC0A4K88nm2fn/eTnpQtWyZfybRoK8Dro4zYDIMGsf7saTBzvX0SMbkAD6o9CYbsfMK38cJKD9l2FJt9/VGs0h5Gib33pxMKWNsigFUh3G2un+/N1WUglI/EEx8fq27vUNnwsiOoKecL7kQS8VnWAGCFUgn6dBtQhv40CmIYggwK0uwDHRGAuBXVdfwzHUjZzATLMAoyJ4FmBhzaWBlrHld9CCWpPHRqofBqMReMGTJ78q9rDes1Tv7/0m0v0AFHXNR6P6g30SHivin7V1BOhh3iWPwvps/yE836L2XiwnUT8x2iHgfqhnwn667QHEE8oLQjEvtEW7GYBZDrDVkwNIO4G5GiBDf9fGoFM6n+vbEtzXwP6u9AduaWnGYSLAlVdl/AU+ikrSeEIKgwdaZ4AACAASURBVKj4/wtgHcHtdO2nWKcBkPfxcvnNQvsj2Me9f02r76T8q0IBn9OLKfz1HX8yVXQYGoAB/2UeBQ5/5kCL6+H/OGGoRnLSwdd3oH8r7KkGTbgIxEwVWvnF8KOpHnyzfF9Jod5Px+IF1h8owyitDw/XEgRb5bPqbt1uvn7qBIQ16vtS/u+DP3cR7CH0WWJgd5mTJKYgNzoGjQrfvu99NDBC+bnyW1x/qhTatv2OaMKgJWPvv5kwnMgxHYGFRtJW8VMl3uP+MgoqSZyWFKr7+KIDw1d6+IiOgZI4+d5iYL3imzbgyO+tph9t2oSBxOM3ugHtPoFZ1LM0hF4kXNEBssvVgPdjdXZWK7uKvyS3q1Xb1WQwtVDqSUggq+Vw3t56JA2cz7PXOwGNW1ecwxPhfe3QEUsDsFaAz8jg0nf+iZMAHNg/XSazDuC18Iq1HBRrOsAQ8NLB+16g614jmuSgs3bROxE55D+WDDQNA4ivdMJ9M1b309UqknaDU8ObV9/PwmMPATvTMAxpABLBzugUtV9bLdhNDQA+7B9tQJ06/7QNDHGSwtgZOCIA47InIoDdROQGtt0U1HI3GaoUnCnC/rzBMQJteN17+VaAzYNA7e+PFqHQUyXPUYB7iQYa5ZFjq1Zqpx8Uqu/XT7+6BWC1Xaj0GlBIwMoHu7UzcI/6/Acb8KIq+hzmGWmAYnADrIpvKP7TZeLaf0LAeQkGgebbq9FToI44p654F47tekKkI0L5PQNZPsDwPBpy/ni+wKMN76Vav4+2cFZFf8+JwAraMt0DFB7beA/u4Zz/a+RXx0M/ct4/jwaNAS8G17eSwmta0Fhx0VRxJkHMivso+onMXr+YwdWKbgioy1jp4x4AzIKg5lEA7wvHEYCRmdx11TAuT6lDLVl4KvXkAET9P4RT8H2u+lg9EPQIpw+/NpJ7RwE8HaDv/Mu4f3OdNkq/EfAiEiOANjEALvcWL9gfFV4NZbgbQc6qPky4Pm35QZxtH1f4j+P/jXuaYPcWwIEH/fmEPBoAO4m4LGxV3txOQqDU+dXgey+UwSzuqP++uImO/u/6ogCb7wTc1n61sL+vZi87rxnrNas+giTg6QLzaUCjIp6JfhwtGI7AjBBB9JjDY4ePYVR6ZPgN4owVv6Q2N5hhVHwNeYrM+w6dN6K1sMHZm/Ce7bHe3dzKr1xw1w4JrSQMZtgnoQHlr18fzunAszD4qurNUg/TDqzx/lfCaO6t4tACMUQ6P6htWjDPC1hCoZ8kpODzJ70MUR9AODcgwyqyPhmE+wfHYB/hvSqt6qeXUShhXH+d9SR8DzrDaZZdpSp/HxqLMQuATgDU/qDPRgOIeT8cvz/h/XC6BtE7ACLOWPE0KIS4UUjmZaJ2grBphiWgT41BUVWZfP3AnEIT6OrfoF122l2rMycBoU5i/OXoUZ4/aglsXwLzHNU++FVF3qikOj5HXm2PBitT1WuvJRAB+6O//W0/PY8vQH5IrAsMs/WuVmAdHBrQgrbOxJShXwRSsu08h8JMBpo0+aDTALwV4tbswgzHrftG/dJKIAQb5h9KCssWIMeto+GYqG12/HWGjx8kzqNJaa0noMWOr2KwW01AMwJoNvhMQda2/RKQP/3ecABM3g9uD6BY68Ntz9+nDOMb5iV+hIE+dP/Zs/wwJhJ9mgBnohBuStABUXjugF3hkXF9ZZJAjefKdHZCc389LoStKvIl7QIEb1d9RyciQgFDI9Cjyccc/23Aam7/PZJBhgDgin5CtQvbCzX8ip9YgIFtOAt+w0owp/hOiCWgEGbVHuYjRigPGR/YOnEoqPDoV5z5YqB3mRq2ox5ICmSSgAP1Ne+XV2NE+/vuFbCTRADxtS70VRBCjgBk2OyDUQiUgfl77b7DwaHm2rAZ7osRSOOUoHgKfNBSLI767+oDYrfwZvqChSpGfj3pFwZFsCJg2jeIQQBUiyI4WgD68ww4qO8khuWkkIuDrxWv2nv+UTBpJYiPd0KemTA8qqFiuUF1jWS3BoG6pADJq751JqBI0wvAVPyMQvjcX1zbELltKK+zBiXRFiRxG+b7q3M9xuLdzR8g0gCGNzSM5gNYfqGO9CBT8OHct6oB3KsSDBisUnwsFuISQaRHxDSv0vptt2oeLHMERfRn/FG/Cx01EpgIQG8LP+/i37PKw53xn6sYCM4/JwSRrCnIeB1ZkLsawDhaPKv/njU3wnZ/dBdGE8+YTHSG8+ofGgIjsC19YnwdM/KAnTSsqj6ig7uGgIPw3nYFzhhIIvriAxFP9CQd4HSlnzgxONIdrE7A8ZDPx9fjib8ifgegNIliRgdx95+E1T7+3nQVNNhEzDgGA3T2rEDLduwtPpuuouPcs8swwXFjdTaMKt+jA5gUAQPcf95KJQxYU0cYxEDvsBSmYuukp7AwnqniC9Afa5z8vboI68ImT0t26CvwBzSggkj447r9IojvCn7U92J/Hw0QSdwZKNNjxPCfSxRqnATkdwpOwh88oc4J8KTSm/wdbZjrc+4iFP8YO0/5JJDCfaijK5xVXevqfg6zGRrQf83chvX4aRfAE//6vv5+6490U4ADdO7QgM/5bcHP/n4OtCQhBEFeDWSvos8DPq8/IwzLzjpa8/U6MMSkBklDm8e0mn3QIY7XG1Om8wzN48y7HwhOK3P0/ZwUQHHv4psbdoVeb9VlAjChBCdtDDpOKTh9ZfcagOYq31RFjN4/gwBYzp8lAwYNwBELhZoxECeZxMlAzWGdCRV0fQWGHo8+8Kx+AAxnCIzowAxy9KvNepWfsfp4RR9kUrD88CPVTuXRybhqqTHcnxEGndsgub1Gdug8yz9fHt3Hpl57x/mfCOC29FOSQ7/noAZR5W3Ob24UMpuPYAYiQrQgk1gnFoUIKr4vKFpV15pHUJO3Y5rfH3UFHU4bGkU+NKJ9f2hJyOMxDBDpjAgwiYqvk5TqNl9EH2Arb6fA3yaA4cBtPWewhkEcIQJBlGzYp6zRmr1v+e3Fv27xpzvyI44NGDkCIi7CGNV9Dw0M8NtHC2vUwHINumCGNG8erxOwtQINsW88Tlwdoc+F85nI559ngEDpt2F/Uu3hiXYrkN/pBFS26hYDAkFgErMK67y9mGBA3L5ore5izf8b3n805MOq/t7XU4WHv1DUF/5gugCSOAIW/59uMwl6CHWAib8bvfxWl9/rBGEMTTwDfG+ezEYG4yk6FvRPuPwE+wvc39IRjENWM+/cm5b0W4Pf4WuKUnw/vD6eDbB1ETs5vl77Dhnm/51g6wPWwQAqxnivgQaeS3gy/u/1H4hpTPrIgHAN0mSgXUX13YP5PMIuQAfBr/f70cdeE+QoCX3i8nFMLcAjInBoAIYqt1LhC1WdtvmSab28AYffaeivCB+ohdYQgfUa/WS4ToMsNLHLc9nnvPZLwn1/EefPVf+U/xvnCVSEQEkEQEnEQJO7S7RvYDxNeNYKrG7DKMhtsQ8cMmhgPKKKj+F7CiHYFR5KIIPxOmg5IVAtu3ACQSPh7CzUQOgAej5CWEkIe3vgxz0ROGO//qYfz/dnLT+ZxDr4QW0eNCJBorCFOVC312Ec2TiY5Bk0cAaQmiA1VH1MOwDHQ0kHdEDDf+2UTWhS4Z8diQMicLx8MLBfverLcP/jQzF0P8EJj5+NGK9RCz755S6F/f1+X/gxeP+Wsedv+vF8/54aSPJYFjIQd624MDz/UDLQnr8HU3ztKHRf8Qeno1vyAQJBaLcMtTV3cvgP56COCqd/QP9xLgBkH4BxO13n4hNUDtACC6G1S3zqooZ6Ba4lp/zcAFb7iERKQwQcF39IFJjdXECGADw0IE4gg674pYAnk4HoHPx54tD5daO5vxrugSkMjgiiqc7TVKAT6AT8R4ckbHEQCYR/IZBxJgA+XZjsR7vaoRpIxWqeqfXuGC2CxwudicwePEB1kNkaZCuwyF0DuKv/4sz9mzP/Qxdg3BDkBTMC8Q+loD6UGBzx0Kz6eAX/KArOQTlPHFoI4vVtf4rNuLrca9edRn4xBP7k8w+9AgZCgBfEUZWfEs8iFNZ3UO7TqmkjCO/rWdgco/yIqHcQWaC2EGTzgz5y/iXQAvyx3riyxxV/JeBriaGB9OrTA5g9/eokM+37GszqfA/UZk9iW5UnCtBqBl3XoNN6Ag/+zy6A5evPAp+TIFDn15gQw9rjrOzFX0s2JBVAxa/nP1a6AsNWYGjPNGPLTQgBsNUFvOA3Ht9o/rGDN0tWOCcxJGp+f7++kkP7PxcGv1+GjkaLt/fawpwwerQxBJNW4b+PJsYEgiAYYdEAGIlDNaAbRkIgK3ut0jKByp+8yz23X6GttmBmjwDvChgiYLP5V/zhH6/110sGcKo5CkggCngxnIPoPja0j2B+1BRkiYJiviaLJqghDI63G2nAgAxMCuDdnoD0wIQm+urMB3VuAwbBrFGgGgnhAFqg9+ujKsLxB3qGCQNEEtPinIQlAj4WgIw7/iXc9V/x/yUWFs2KH504bAh4aYWf4TrTLGTy9YbftyLeVOWNfYNyt/ji29mQnqMAltU3ioTtbX343yv/1u0YPUBz6zB702tQucnX0gWaFh6DgPdmhXaapGotw0SFz1qDiTMdd8h45HfcqCPRUhA3+NmKz1l9teCPaMd4urGaewRitNBDdahR5c3AfQmDCFT9vmtQEwqAYXX4XI2n23Z9B/Yb1FL+LWox6wHGbZSo6FR1LzyG+3hriSZvWT6jfXhl2cmQZJDrAbuYAqAHo1GA/EOgD8eGcU7A8eDvH4fQBuAhBL/Zp/vamPTrRENDGLTV/7E1WEPLDlP/PwzU4YhusIMUgfIPAr6Dhv5R4y2r8ldFwiFoYHnmr8TAHbhRQSZOctH598ZYhqt6wP7q/ouqe77RJxvzFYaji/z4vna4v5cUMDXqDAJ5ytktqtBDckyjvJg04hl16LB0xFfyMfD77PZjErGQRRjYIfSvoAXntks0ok8MsUC4KARWnYPlJBeIgLeFrUgDOHYCag0/XNAbWgRwQuLAsaQwIhC1g7+jCNKuT38JfnYSyTi+QQEwwHeT4/dWHYxJPxfOj5oAnRQqgU3YgGZSOaDyK3n/qkDYBKptzR3oD6B4fyRKjp2AzSl80YR/3P+/1vBjX18Jbu+YsrMRgbqPP8zrDLTAaupphfeZtyPs9BPztpLSBZjowF3woYRwBwOWaqbev15b7X4RWsiqYiY6ZkFEIoUwUA2OrkeEQE8HYNyD/rl3m88jCGgO/nPW3xy8x4Q/HBcM1dYg5q8N+B/SBSYhtD0EY1PRGLDoKIBHF3yLz4H/gSYQJRETgqeB2d4vC8L2NVnQn4PoVJJAcP0inahAfdXVI8CFszjRagCTtRdV7Sr895NBpRKXIT64RMFw/iw5eChhEvmmyUIH+k+Qu3cLzOAN6ILlFvgWnx3YWFDz0f38ze9GlfP6UQ3ojEY0gtqRIEbA5/WgQFhsEuIeL75uTzvqHktAWfj/OD6sQXssROcGiRgFn0QVkld7OznMDT7CJKzhMIqxW9B+LCOQdH4uyxIcE49VTSeLj0wKjzcp2oDXQA8YoDEGBLMW0BJw+eAxXejPV/IXd59/tp5rVyYXDw5BlRetSpQAcvgfOwVM8ObzBq/AQ2wX4lwkQV3vNhYFfn2LFgaoDU1ogqsfqGkJYmrj9Tr22KQwBLzbLuzDeA9yzyJjVRfwegWq0H+FThDPA6ZhZwX2M2Kh4waovCzAWJTzD/qY00c+6PM8coz08VNqglzx54LfHuTJK7z2rwX35ABLg1DzsZ7Qv7l/f2yXDlbf4C/irg0MJ0aCuD0wP74MrxfdFlX7tq+vtRdCpvt599EG9Yz3V+P+Oj/n4zLruZHcJ7oMt/MNp9eD6HEeFb6/TMfbWo85Pb79HJo8t3371/PuIAZqMvjPC34nVV6ZB4hEuA7AzA5cfU0y2n6ux89D/35/n2/vWY5Bf0qwf3tPLISO1Tap9qzFB6eap/beqI94NCCbGwgqOItY3CGl446CaQ8i2Q9g0AvmgJOnBoAA0gu17tsKtKS7D4udgCYERy2QIceCX/P7mBW+g/7D9S6Mn50CS0eAoQPDcBjopIA5+EcxEjLweRjXq0UbLIjcBxsGx2IZvlf0ATjz/6qypAmY7bhrk4ahsIis6ccXKHdueAfUgk+RWPCLh42c6zEeKyJpRTdRAOqBbl/Wq/uT+q+Fx3FoTIuCzc6+hN8j4veGjuAnhSE5gKnco3A3XwYlq2sq+lmP4yEOpqEoG0M+mGDYuYT0pKCFHgLHKt3T7T9p8GcWH+n1UwGa8X6kQt2x4CeqPexegT6o/Z4Cr313PHdgrsS2ZReLfpKIf+IMFnmVmwxQ9AhithYT73+p2s+JIVfrjwiHnpAZrSsr9CMstQXP1+1+510N/q8E/YoekMN9OMFvi5LvkRDsy9rgFCOoPdpgaQIWBZjf5KCSQszZJ1ivTvLokpen6tsJAVND0NFqb6GUGg2Im4Dyx9Pn7/0dm4pADAslJzTv+dKNrAPQ0wyySm7bj1RQgbAXsRa4R+mBJzpaQmHLmy0BLoL+Nh2ZRca8uUc6P37k97n451fvTieAE8BdZ2ItqFEK6oOJIYPsiU4woo140Oh+H/UC++gatHYcOFT+2y3AYvD1rM/fpxdUcsAi70c0OxAEP45X/hymE9XeoC0zfYhbcqfbhs09HpwnKMDR6g0mmYyKth/UcLl9ITGQ8N1S6s+gA1HvQCc2pluPvN2Br8SyZyfyxPP/VhCi1L1HWX2CQCuAE8TIq/sBYdANZmTIwqq0sb0HIzhhugBeUpBZLFyA8y+EErsBUYDZHYN9QAAooQwOws+uQlhdESSSqk5Qsh8LSYI6LDS1AbmOvLlRBqQIeITvM36+TP63VfE5hFClCTr9zEyVFwS3STQBy66DMHB+PJWIrfgGnYBx2dTboPa2X49GaBVlePA7CFx4iaGi4ns0aLVjMGvtPTDtmO4XEE8E5Kb/8qYai+NHl60LgAICcUCoJPVeiYG6Pxw/X9VFNVbFn9FNPzXoIRDTyzcpREYB5Fm1EQQn3KRi9wKApR8Tz48SwxnV3qM0q7ZhpdKvr0zfY+gO4oQf+EGPFYW/Xf5hwWsUgxiBbShGoGIx+D2eH1h2EeR3UQMH4zMaUKr4033nzkSkfQADelFbLOQCalxdxvN8mInhPas9bxtGJw29Fx3Y8429MAS0fL33Oeo7qFZeiToCC3B/VSNYuU0fgDnkhxGgMFdxiYEY7MYel+OHPH30IMeVFK1C79l+QdXVpFqHlMAXEf3EYDyfkkGdNvJ8f3RAXU0jpgM7jMNA5yCrtfzOicKG/M9bgEkEjqqPPDEcDfqVwGZv6zcO9avDfOhf4OmLFd9OLBHHdxp51HvOBlnAoQksYjASA1xnIhPsapTCPjbsGB2YevpPpgM73EYeSYIftgPgte6CWesVBB9QEgfnWYMgoeC8ql69bWoRIqYHvSIv/u26bj/jdqZ9KSGk74JRo6QS9PuTiSHm6Z62kLUGH0UO4rwWrhtRETkR4iKRdI8giJ2D2nUCMjsA0TXiVDb98NAf/rCMlajA9wesWHZrAe1dlwRyVI2jx4KkyUHSx7YDe6YD4tOC6XW01puEdAJwaEJzf1uATHi6ZlSCpBQscsh6C1xRcWEG4bCFeKcAVhVlDu54JQIkTT21hptIT/Afk0kMcS9BKfjBJozcDXCrtgbWXxbMAw3INQIxtQJPAGwXmYaBbYh4SCsuKwLOAQ5awKskCMmRg8P3xwlBfbosQaDqyZqBkyQe1CLQACoTgN4qbyHsPwkTiF2pYaj6MAXBmUosQHnUEYCsBL3MW39SNKMJ5PfoBsT33DVJCEbFnBCMOkHfvj6Xq8uw+dgRIhGgAiUqf5QgKDFyhe8nnYrlqn9sG1GoAfirubygX4H+8IM1CmQrMFAJ5ExzKIp54nPoVU2Auh6eBShDlTV4u5c4HE/fVvjFrsII0Ik6QX+Iq68jB19ziLoKC27FYe0gC+j1RSS+BgB7AvAM3m8HLdy5fV60C8RMVuhD1ieQB32MCCq0QPJuvuw5IHF/geMKwOPdpmsxBwVEfGEOgeincJqNmuSFIPhPq/xM81CWIIi+gCFBqDX3QPYd2OcCRo6GZBoA3AM+00aesAOQ7/2Pe/vBCXoguD4OBD1WfPwClzcui12AuH+gC0gEwW72KfjBCQRBr05D0IQc7N8PzOCMehPWK384MPVDJQim7yDdoiRTItzzFV/ZOX9sYFetP0fsQzb6O7wOoFjxk89YoQXv+BmSN+yYHYO+BsDRAXHhuJXsEFbdIEGZQWUkNVNzGA9NZUVBIQL7jASR0AclE4Pb7JN3BO72mG92+o8UG3nybj+mASh0FsLKn9GPxDrEcS2Au35BzHO1BksriIJdpqWjKR1wlpR4fN977rZqI+XbYjYDgVDpcYQalOYKMiuQbB3G6Pu/HlMbi9a0EMkksXtjvvXTfgMKAEZRN/i/O7yD8Da2S2Bdh3ICWfp8yuMkYl5a4df4vVWt4UF0yyqEnaT6swYyWB8/j111Y1ERS9oB0SLMtBGDEBD1PEHwtdjUEAHnqmoHU4wCDAoAS+lHwtu9eQLUAgmxVvAuMB9cELMV3m8EUtcBYYI9nkNIEEJYrQeUHfnzzRyC39j8CgSkir/E0P2odnAmAqDnDIhqrtV9BDNS2POjv/0pwKr6z1h/PMz3uf9ykFYq9TtoAXSwpz0HljdvBCVAPY6t7osv6gFhMpkX13rcfXQMIpuTsfTibkfOPRAC2meLRipI4mDPwMD5x+v3+Ey+qEfACwoUEkKQSMZxYJDz9R68PyP43yvo2aYf881rNQbZgRU/jp80QnW/hdXqJxMvCFxXQSNHpE8QiF4XI+wFfQcw7VL2Md7RRajsKgh2D+6SLAKPF356+/7yXYBTUgFy/38StUjFHweD+iiHh8/LV/i/TSvGk4L5x7F6AsIKbgb4C0YjgdGRIToGUx7cgS3JKP8pRcgak95BJGQbjaJdBYQ1qHYnYHL8F45QgHx2gLMQ2cDxBD/4SeR0LSDi5XzPQNjM4ySE/HGG6g+ugltLNSARn281BPtNO72eJLjdX4ITSEgpQvJYFEUg24f1qAYQNQdxx6Q/RcB85j9f+03zf2QV33IDPHegNgPABTfqFR8cZK9TA7/ll0EQbUUHW8Gr1d+MSadia+LRHwhunv87yWoJ3h/pRDwJAbDNQQFd2P2mH4kP/wDT/ZeN3CK3+ZjvgVpw4r20AMafb58j4N1UMknuj6iCx883PU9g2VHVH5JX2eEcPghSgRBCKPzK0Q3fknwPN0Hk0CyC0zBkz//7duEetgFjVtypASDI4CsknYJgYDhqsBxxy29+eyxrAZX75EEf8f+CkOcijMDDHx4ASYGGu8WHgPwpHJc0qOG8FgFTuVk0cRZVePFwHEIUEu8xSHoL5qWg4I7/HgOKXe2dcnu2SSdCGIDTA+AcxY1zYL6Q6AAFu+/1GvjKPSeEoJV3NiM4Dz9C6oWkEav+NWjPWXNOIkKgNTi2I8LeBgaZHJxqrC4oNXoB9pzzMws/OW3ghSyQJgjbygOVEDhoj4nHLld8HPD6UUMFVLIgKrTL7cFoBRLQgEdXIseZ2/HhFPKbk4d5tYWwwR0nIFQSD2P5gQhs6meVfB+Bkyz2fOIvX/zxqsSODuAGIOLtPNnmIPCrv6Kqvgz3q4tCwNl9lWYfnsdHj2HTgQw5IBHwULmfSu1jEV3gDFSxTBmqSEVqiYK2IkWcRiAkwV/cyW9YhqHXDw9dkNQAcO6HFNJT7oChfrPUYc3KY17zAd+evAwF2w5SCKLV4EuCEKsKfjBVWHu9Q9Arh4CoBqEMWYBsNX7YgKP/69uC3M7/mOOz232QT+ox4iCyJGEFP4oBHd+GVvXBwX35nqp7qeIbV6L6tdZub3ueJ+gBIKgC6S5gOQFxDoGr+Bv2nzqbknd7ph/EmXzO0o+kZdc/wqvQkAOUffVMzKtYgx5Vob1/+HAfCdzHSiXHenX35/2JTr3KZ9Ruj2lYiMhLIFoNyMq9hFroeYMTE0bSLbhb4l3YlFPa6hMd2jk8dmrDgdQCnC4/+ANFlYTB6ATlx2GDGXP1rvL+SnWHw+cJes5/rRWt4H2pw9GklD4uSMpwasIQiaYR92gIyFX5S8dtRZt/nCAH48VXW3hRE/HKOsGquj8EM85Q9cfeAV4XwNGAlmIFIwPYrfLKuxV476RRetzcdeAsRSZhiHizCKEIOHn3EMOWy5X4uIJnXX6sFiBFLaBm/THOQAkVJK9j6TKwiSDTBWpwHkSPQJX7U959uAkoaTUuug6oQCBz1Zlxm0OJSIoIw04M+7zCGuYiznCfHww9AN6Ir+HXA7lfn2oBSJ2FOOh8SzINfmcAyITq8JX/sOMPx6A9LeYtVfwgCBZhdu25OB9/XmWWNPUEPD5dUuJ68wd1AqD2+w1PI9KxE9BW5t3z/igdYGWiL7L+wPv9jgVY8f0ZcbCKCuLAHN+c5wa69Zpr0J9t2KnpAGzyiAIPiFalJ8/xXrrA6Y+/8NoDnWCPNwFJzf5DpVkHte8hx76P+HU1+HEytEeSEIzAsu5r6wPJGu6oLz8VrKofXLce+ywIHhNa/Dmw8LrptWXZ4NKZm4pr/QQ7Qk8ehMrPtAF7PQCD309QgRgRZMKgAbFREAfBBXNalbHA9cEHMo4IgIUuPjjBWEUFEQpYTkhVO43eRiynJw9Jjj8TOUIlJExK+0wA4gWgQvcFBHAc7P4/u78/Ff4CC5ATB3P3oUwFClYgcALcxzp/B9Ez4DUV8RjBbsCBrMH4dLNwIDaCGhA6o3pXksdBvYBsktrXDgNJKAFy1Z+ZGIy5NXgXoBT8a3ZgVSPIUAMV6DjLxhsV8wX4n4ibbONObHNyCr8Z4FinNFjg8ziiF5zSV8A99u7Zdf5OisvVaAAAG3VJREFU/kIPAJLWX3hUIFD6o7MD4WkHIMXBk4IftSrPNBJVk0OoC7ice8HGS8XBKDoz/YFBLaQi392lGpCMJfhD9xVkx5Xbj73P9V4m1j0v73x9FjDDPlYvATkgFAVWcdNvJBamliOjAwRV0EpeRymAe717kMYRyy/j5FwFBX0fP7Dyx8gq8wn2ZXi8GfGYR+lFcGJSxa3Y84WgzBHetlU4cvKY44Ps4iP9fsgsPGEhQTAcHqwwGCj61SoPexKwasXFqtxq8qhD9SixoBBYcJEDNzmIoi3J7QkoJActVHocTVpPBCDhElAvMDK1PT/Sq3DwB/ygmyB9GNhYDH4so4Foy48kkPtZfZEv1PQTxYpyX0EI3Bu+/5krcN8fgwVdwWu2JNVNWAk+PcOOPMNdGFyAZ5Aj6gicgzNfwuHZg0HrLxBWfjSRl88fVCo/apX/IBrIvf65ZxtEoK9Bec4KZIPLe76osQns46NwW0pUPCPAyMc4A/KXOwZzFLGbAqD5xhhbgBcWfoJBAlarcCSQgdQJ+Movnih4gjZQTw51rz588y/ZgxVUEAQ8soCfX8OR26JwujCLGFAMsOjnwGrlPuQw9D/PPv8BYVR7pG/eeFtQpsLzR2KFI8SwKj9KlX++HeLOPuSBKrKeHBi7L4b+Kx184+ptAp4Trcscv69oARVYzWgaK01H1X0K3zNSmARKtxXYHvwJuT+8gLGGWgpHcWOmBeljFB2Ckg6wiAYOqfxEK3GMCAj6kIiTWdCBCXhkjUKMgJcLk271N9uLSbtvvK0S69OXAvoA5z94VsFubbmZvx4QAnXgBnJxENyQjy38wef81uPhxMpPJIQzr5ckuUTKe0wZyN57iFTWga8GvCwlh5UqvYgmaNV9XSxEVWs40kkosFwA70RgNOu8mLZfR6wDiwRa35y7j08NksqPQhcfkRBK/J8R75Iz+9C8gJpqzwiIeZII3QnYOkJWbVEI5jNuA+o2BwK82ifwnpSgHwaC+GNAdmW2VXfC+vPu6wR6lBj84C9WfvivZyUhZMJlJhjSukDlFJ3g4AvGJfC1iEpQJ/CaEd7G9wds7p71+odruKrHip/C7RdsxeVjzIxhoNkFGOW/+sk/YVAGtltfzZAIfzix8gcHhZCXpcGN2u69qWqD9OlRFAy7x2fQBhHUiETB+DocqvArYt98f+AEAXApsEmEcNLC0t2uPHCqPQIXwHYDfI4/9+8LMpchqr5HK39MJSrBXwnutNqjovjHFdq+fcHLp7YLR4mGgduW5hFpAXUoL4cTTuW5HJSkB5PC0S7A+8c+837DyoM1J9iv/po/o3BunlDqPjOSO/YbLFd+FGy9sxKFeT8b+nLNPrkAyD53FtT27yUS32yqUaEGTMBiASGcZ0FmK8nWxbvjC1q6WQC4VdWdAcBY8eFoAzIrC0b7Wt8wlPcIdE1FhUWeKU1Igv8Q/0dl4k/NnYSxdlDon8diUDeuQB4c8XVzcahRgyyZmNC+LAgeCfSVALde8/t1DCYawNoePGT83wlOpFUdOZKwxn89OsMEf0X8CxJCBN/dwKbFwkSMgx0ACJJDJD4iC1JEYh6XcEqVHpx4+J4I4UiAl26r5x64sttvSlAn3LBuQCz6edU8C+J5epBrC4YP52EFDgHrCw1B0eU9bOaTgh3wmYvQV3Oqqcf53XnVNXUBELX1xtSgFrirlII5d3HFulxBCNEfZx0h7K2f34XwdHpuYQcguN189Ow/nPXclaUcqMH5leCXjKOjbv3F0a7i2ZaRHmBe5zwnhA9S736ZC8AH8LHkg/T5znYgmES1dtuzGo92qwHIquiWX+4KgVLd8utv9Ml1BQNhEJW/FOgweiTguCUoQHkEwYhjfQIgm8eAzPKzHqAG5xGiiPyxeGRRaYetUpDVpHVC1T9bHGyaknb/TQTnuG7rDYwYCUT7/cMjtILzA+Go/FPw581F/mWeTkDuBsBCAK8ki+A29nMzPn4Rzjv6QV7xWW4fzQFUxb9jQQ1qc28kMi4mDl1NBr4usIsz5ltZqNm7AeJXfuTHd7nioLEyPBISU+8/tP1AC4Il/n+YGmjg2NiBRdl6yCw//zG5ph7bqaBuz8B4VMU/TqSsNPbwCeZA1cdxyG9SgKzRZPL+GXFOiH1/SFZ9wX8M3zUgvH8a4rMBjZj/h1W9MrwTiN6MlsCKiI4gycBzgV/xUaQGjGDHwHiYi0VIzeEAasCpNuL76AC7BIEl7i4AIxnAfoMxk35eJbZ68wWEUChs8IPz/EEE9BkUoNA4RCWSLJkY1h0Y/dG9bVCtUVPe7QRhtStXG4nOECDfUxc4Uw/Ik8JkA9o9+a83IrfHH11EdFUWc4phNgVFWkPsIHBnCvCCYBSgqEN9qtoXuwHhByYoJJA7BxIkkRwpDGgAHo+vQ3ZGOwCFJCJKUAx4MBpFZWvReeLgtBBkDDQu2OJxXa7SE/P4ZiUPHABjY1DsFIhPAaygWewiXK72hHjow/k8gCL6gKES8qcDZ7A+EhYlWCPGCX1wXIwzkQEKt8cP6iqkC0FEhFj/ZYtvXCtwuBLcDT5wXN+9H6ZEIkTwV/x/s78fXFX3siWHEKrC3tw7EFZ31Ll7ttknQyEMGgAqCaVe1bGk8r8nFWCQQR0h7CY0dsU/mIeIuA1AGCo02Q0YVXxub36sG1Qgfo0CBBUXxap+ECFEycQVyViBEBFPt14TK9rZHB9EwMG7DPXOv0OVHkdtx7OSCXfb3av4CFZGTwQBwT7/hKPHE4PzpJ4L4+FM9r1n8B+B+9R9I4Fu9brYUZgCunZWNxdQgIs8mASBQ4F8hJpEiaf4GPihk8FdAxin/kybjZjTj+mAQy6ihZ9whDvHAWB6BKrBXQr+5SBfqPaINwiz12UIwoTmbPACZY/fshBBBKNlW8ZCHwH/cVKSOZMm4Mxk4OwE9JeB+EFkn1IzcPQoiSB4vGgNeJSoik1A7m0TCmE/HrggB+/1M12C1Z18ACGoIeH1pH2IhAqFWgBq+kDFEWAvA3X8tpW0cnSD5WAOriOHhnYraF1eLTkS8P/QsHUBdtMPnOrMaANJE9AZiaKWII5Ue/8PTHn/UcCSTgIF2xN4zdmAQYIAKeBFl6FiO0aKfq5jcImHfPwTxcEdRmD3LcFoAva1Hdjm9UgGggI9YOoPkOBYLsT8HlG3nucMDGkOOJ8CkNOELdSO7D5qqAeJYBb2GpABgRi2gxLITgrOQ9C937HgB+0i7MeRx3gfPWCXLtgbLJAu/gCFBPzRX8eADJqCvA3FViC/BlOQC4LZyrBq8BdQAOUKoKjqR7v7EFfVFMojPgEoSlJesNIePyLHwW9NRgq7E6HvUN8A0yj0wyWDHRZ3J2A1jHdMyu3hCGwSDwdRir7h9VP7AKLgPoMCgKziOFLtrUm8aIFHlgxYfz8WBYUU55iAXauo+evJaIK/NTgRJM9sUcZRzcCnMdNKMJc7usnAyrpxHYkTRHK+n1HxS01LheAHqRWwKIDqLvQC0+PupHZgBawfVGsiniTVHwZHRqbUI/D4Cd+ftgyLAR1ehkIiqaKFw7MJEwUIuK5zsu4svoFYCFKgBJZACBuppOId2RDkPZas8H9kULcA9a0KTCQDGtpnzT+RMJiOGseHl4BQ1C29AWUXIIf/OIwwqoNEK3SCuA7FRiBrE9B4/PcrGJ1OQNj83F4Xbol/TgVHfMiIZLAdcaVkgh8sLrd+liNQH/FqsNTfj15m1J0X+ffZuq/gTY7QnvIfJz6UzBJLs83ItQpt3RfZz5iuGfNPajpngUm0R8DoA5jDlzsOTAwZjzsC3Jjxg7H914PjlcskGdghgx9HG4OOQH34uwQyzz61/0qiYNQjXxECuWYbGM/DrjtPH/Mw/K+gBLLSA+cEfPr4MroArzcDuybbr8Zc72i2UnzeHnTgzD4Ug78SzIvCoARVOQxaFFR3TzWnkkHUVFShEuqKxZnKz4p4YYcf8ZhYhuu8wFgSHcuuwCJagI4bgchJQK/qe9c/RT6nGcg6KGREJpb+MI0EY/b0jcsni3AJBeCQNsBOFVYoApcM2Aom4VFgIRdHpeIG8D3YaxBD+qCiQ+rBOSVnci8hzkAG1t/pgHA4uwDzmu8xFKkkkIqCfkIRs204r/hiDgutoAAcowBMZ9+KS0CcXVBOHCvJw2jMQSJyeoeExF2DuTuRcuWAo9sefyUQ6/oBaIjPtiRH1KvQKvygAHb171d+vc4GRMDPoxN/kL5pwlVh1mBQ1quQJAJ5j0TgOAis+h8d3mnC8xTKE34+8sDNjyVXE6nFMN+H39TQDmocHScENvN74LoGScGU4f7g6IG3n3C3qnG6JBS+Z5tHOOzRYQx+u7MZmAl0OSsRLAS/VIKfRAWU92+12aaVPksGDBWQuCMvgNy2M2Mt8EwqbjosZAec5xLEAmXmcFTHiOWARWglpNpjdEtBQRxJJU5VL5/7F1X86XntXgUK4q+KggsUoIIK8oA+kgy4+zLaACqQGTVOX6MBWdehL6BxHn+tlyBMDGAqufd7WOX5WTJwKYDfXJJP2GXDPk7Tj5Ed7BOG7DMFaBRAJgI/+H2Ngeb2SKb0zkoGlQBHkefDr7xMA5HZeJPtKIzyApI9gmnPgf1c3mulfhe0gFekDCdNFnrOwi4Gs6eTACNjB+Uegcgojog4V25P8bctRYY6RL8AJklE9ACFAGZdBEahd4d4CmghFhbzcwaXYH5qTlS6DY+KfNH5Avzjo2JJ0poDkSCMxLn73H/eB+ifvgvyIFCWAji7BWC8hd0qj0FziMdrS70BlVbgamIgcmotGZDNPwm0L9l5iHv7WRoAFx57ScFS2r2iwot8oKu8l+TOCOg2mZ2nFdjTgOFQENzKkJ8OjEnsE8f6AzyXwT6MNF3RDRnuj0Lwo6wTlBMDIyqaz6G+RiLJMg/KUrQV/rh9uH0tWduwoxmky0kSMQ+rnXxZsGadgnxfgk1pCnsIsGYltvfdzTOBIclIsN8MLAGcz5gBwj94AE8DuC9Molip/JGwB57nRyJiyD3pyk6q5ij+3TzRLohcqyqCEQBTepF15+WVmW8SEr5jMUUkx3oMIsrH3ndwAQganKzyMpOJNxMQooGBYwcByw7axIhgPRGEr6GSGJhkAELoQ1YRg+dPeD5IIRDIqq5PA2Jh0Rq0YcS8XBi0ghGRFpCtWTdum5+yLOsQf2EuYY8AfnbQZDgCjHxBSKwTGpt8QCIDVH3/4H5OwEvldhliINwAFLsEyyIfGKV+vm3eEehVqKTdNxtDiPoLHCRiuwTJxCECxMDqDjTvZ63KaPKvRgV2i/F3ohm88V8LN8hgJcXD5pVGIPPNn9EBqSQC0I4AMxBUcQNCkarkFgSn/oCs9GCVep4eUG5BRAOcQOCWlGSc3If0IFqRfURQGRrKewPKEJ9sLnIowKCcw+f48N6UHjqYtgInaCCkBbPSj8VEkCr2g8U43wY1xX/BNkwreQrzg+oaJghOCGTU8RBxuIp6VFOGoEXgEsBLIgV6gBgxoLSI5CgiYNT+GBHsU01GthrceiMUtv9KgAYktgVNeGrBbtiOQVi9x8WjiAW7UNUnm4Vet7WtsFgDCDYEwQ/EVL1PnQf/xCDLTowTh4c4HPRDoQaiwhKIAae4B7xgCBydI/CDPOrevK0FR4p6w3VfoXgQiB3T1N8Y1PCD0X19JqcHGfzB5WkQE4p/kdeXBcEVUXEIFqSij82lMyrWq/7c+LFHA7z5/dwOHHg8s/Y8C2CmhbmALtare+4UWLfb25BmXABKABTniC8gRAP2yvDAiUAsElnrxFzITQa/sAFecAOY7zPV/8jMQHSbWAiUPGkQNABhw85xrSCv+mMSzFR8+7mjw01A8f4F8S/td4jnDHYxpT8/OEyV3gz2+GTfdAeAszswfJNGlQhEIjB0Bls0BKn4Iw7WKu9f1gmSagmvqleEwJwnZwjO7npz1HdCJ1hS/mlBcRXyF3i/M7NxqJFoeH27z7nnJaBmpUZKHsTbGUc1ALEoIGsGYl9ixS50gjAT/VhB8IzvGTrBVfWEz1MzAkRFTtecW731VdjNQPukVdhdn0Y8d/a7WYH6i/TBPBzUFwAlHwtGHOQISrgb1AMUgDETTA3+THAdeRJhg59V/Ektofa9I8wxVICkC7QQSAd2O3cftzPzdMK6aA4iZI4ILfYRbb9RgqICt2AxVnYZ4kkBvHOBxT/zN9ybHx/f5Ql2fkGCX6ANm6F8WCfqAS+Eq5AGcHJd2IFHagTMHAAj+mWBnDXuc81CjhsAi5dL2K8QCYI1aJ/PJtSSxEFXASv7C2I3ZB9/a0j/7nDn/j1pHsz9Jr8fNpxPBUAUUYD4wz5GBlmyAiORjtAIGDFwzSUwqiNZ1d1tPiB7/Q9VeI9KeJU16/knkEeQJEALjY4rkp74fCZiMDSA/PgvT/aT2gYgp5E/P29AKBQAo6TRth5T4VesQFb0i4K7RA2MZpgyFXCEQHCOixuYMPgy2L7+45ezSSKt2oUkURlpXkEMOLSiXPuDQZjk63N5bmzOSxQdLHX7AhwUEA0BAeQPJIQzkAuFlOK/GtyLdiGDKEBdllQ7YouxV2Xdwza9So4Kp5Z0yAgUhTlJgFzSFrznIHYIwKcCu2/L3LsCg6UI1b1/CA+ApIV5/32HqOIjdQusE4azip5Wc1b0q/QGIAlaWEJbXP3r/L+AEipw/+BtkQVY9fIM2i/ZhgVEgJO6DZ1ksVtlYdoQAPhVO0oKmYBmnAYco4DRCRB3TwCziptaE0auER9/VzRqKNOEYINOQg2m1l9GpGNQAhh1v6UmxNQh2M4+LmlUzll0OTjYQOaGlZAEMCrdhmBphaMBwBADrSQQc3//He8KgFETT7p6BHnjj2X9EXsDjrgBS6ihoAmcSQVYmE4JgYWFpp1waAQRoqDzxDhU+HxSnZHz/9JEY6Y5MJA+cwoWrt99+U3Mc/9g/NQTFaigAEtwB1yBzwzucZSX7RZEILhR1d5GDCsBLVUdIQvsldZfEJt5i/MHx2hGJZFkVVyK242iFeh58oBUFqIQbkfp2DV2X0CkAYgv1sU+P+I/HmBu8nErugdRnUWhfp+A/ddlbEH3uQlBsNobUEMHasK1HOYn8BEEvCUaiuigXRIKj+sGOPA4KAWz9/s7WxcgB4+a6/fI2osEwv4yOENAiPf+wQhbc/5f0gGisWuQaRFmGoIqguARWsBQgTTocDLMT5OJUQnhqdCEig+/EShKSEgTVV0MBMnz04BcshPnLk/+OaV0/dwKzB4QUt1NB6uTDfGOP+cNm9mEsBAFiM7AQh9AKVEU75vy68jeOxrUC4mDEuYO0oLqoSdHaEF2eXYYSm0V+oEOwpLmYFOF3Z4CmAeBTIGueiIw2xoKPzDBJVBXQ5g5O8/twwA+QguIjJt3+g0NQEcDfUXgO5gsqlTBLkQLdl86K3CWneitQ8sg/5oWAUJP2C3V3RoEyji5n4b9lB4t9pz2CA+cAFn1Z9I/uzYsU/ELtEBOCHYQQqGcFejV+yeuRJX31zsKV5IGjway9z6PLDxKwNEPsBuOEiqw57jGgOtZ1Y++T50AuMFl7hPIbhskiOwsATtRoc7rS7dXrpcgrMCGJca6ELJo+Y0be0BW5ZKGcFz4y8W9BduwcDnK9iO5fagsKpp9ANnvDPxeP8THNyIVFo1AMas8Qk5v2Ytm0LCCYAXqn+wQsPTBh/5Bcnne14Os3uCQt28vsK1WUESJFviBgAW//3u9PLxusXchcCR2WsNzv/ImvgZzzkUByDUAIrjTvmSHAowpJBQE4SUlxMxnARlQbIqkArVAJ6pBBvELCCKlkyCDAP45BYfEPfcUpfMch3Vn4bheYK4E66BxAxHSVd5INgEPgU/NBCDfNQ8Ho1CoINAPQAW/QT8OCIZlNFCB84XhoDChFByHGjx35v9BLgyhmojqHYb5QYXnuAecvua0hZe6BV9f7v4ibvgvamrmAc1TmaEir0LQ9h97eYAYVoM/nWA60i8Q3Ifezha9BqaaL3zvqd6IAuwwLSCCuCLuJWch4h30giPtyiAphKEBcCu9BV5wwzkMxID8rhMwdwMhcSFgrBT3RUTQboAUg3+p+Qe1IGarOioVnazmefV3lHpwA0AcLWCahUiXwePHWJsP+GH1gnp/we5KfOhJAbsj0H/BIEb04TbrTPsAyb2LLu93KwfCvn5PLAwrOXAa72eEQRo1CNdw5IprsAZ3hApy9zlcITG2vpCihsRSYxNS+J4vdBZ6B52eqRcQ/QXmSjAWSfa/5GA5qEg4iJFtm624AqXLrSA2gx8p1Mdqcghv41S0lSp/xAYs9gakQc4Ie2RTUYwYgt748mV+FU1Xgp14eW3XYZ6cdqGTNHwHICTwEeTPl0jEZwIgP9gDEaogeg5IHWCF+1eoAhvEKPB/EAeTRsM/pSAP5wjWEUMM1/NJRhwJbpJSgK7S7zF3EOsI5jBQBK9DV80Z8Y0COzvmWzJXgDl40KEC6cqvqgi4OB5cpgLFYK/1CvDiItXqC6/S87wfAUfPtxqfGNzlYaOjlf1IsHPPvffHgDAoEeEST4ZLZUd/RSo91/BjXY5ggWgQ4In3fyj4mUqPrInHOCLKO3wUwRsfyXpt1nEIRLrqcWeTuk7bigsbid1zD4iDRQtnIdQsyIXnFCn1I9D7ADgxEhOvR5AJosoUbu1FkJyYCi9OhQERoIx+4AX/YqUXQhtYEwKN4Cy1HntLMmtaAQpqfrT/UCoLSxeswjA5UWPPi0mjajUWxMTdVusNvt/ChMdmILK5IRMFu90BMEzFYHdg2GAgeYVHMMJIBTA7EFTx/5fpgTFXz9w/en0ZjD8kCDoKPNGwlB01BmoWQbh+AxR689mBponGJOr9OwmMu3dtJ/ylW1Tik4ElUPmR9RqII+pVhD9ychABMQ51gOIZg+/G+5mGIzLB1JJC5WhzYjhJ7IWmLDpA8jzsAafUPkB2WnFBF4iSxkq1ty7f25rv/+EQLOxs2oUdTSA9HIR9swdBlCcFe9owPC3XWDDC0ISVzsEVbSCF/sWdA5Fu4HJqankp2SeQCYYrImNalfmhpVxYrGkUS4LeSUjg8dD7+D7w/ybIfy7vlB9/HJ978zr7/45Qgajzj+4EjIK/ULHPRAOlKr/aG0AFcqCyu0GcW45Igh6JMJmhA49/U+cEssHNJhtXDC1MOya3j/sAiAGcrEtqtgjBD6wEzSDc7D8o6C8rIqAZyPk+NQoNLAZ1hR64Yl1FBY648smUYKnSg1Xwk/0DyRyArByMUobyByhCcPnOaPyoegREFS4jNfYAw+IHCjdC1J2WDZBke/OyN85J24WiXwDYPoJyYuCD238ulvuzwt6KgHf0shWKsqCFFGjB/w8HU8eeTED9wAAAAABJRU5ErkJggg==";let TV=0;const gh=s=>{if(!s.environmentBRDFTexture){const e=s.useDelayedTextureLoading;s.useDelayedTextureLoading=!1;const t=s._blockEntityCollection;s._blockEntityCollection=!1;const i=$.CreateFromBase64String(EV,"EnvironmentBRDFTexture"+TV++,s,!0,!1,$.BILINEAR_SAMPLINGMODE);s._blockEntityCollection=t;const r=s.getEngine().getLoadedTexturesCache(),n=r.indexOf(i.getInternalTexture());n!==-1&&r.splice(n,1),i.isRGBD=!0,i.wrapU=$.CLAMP_ADDRESSMODE,i.wrapV=$.CLAMP_ADDRESSMODE,s.environmentBRDFTexture=i,s.useDelayedTextureLoading=e,Eg.ExpandRGBDTexture(i);const a=s.getEngine().onContextRestoredObservable.add(()=>{i.isRGBD=!0;const o=s.onBeforeRenderObservable.add(()=>{i.isReady()&&(s.onBeforeRenderObservable.remove(o),Eg.ExpandRGBDTexture(i))})});s.onDisposeObservable.add(()=>{s.getEngine().onContextRestoredObservable.remove(a)})}return s.environmentBRDFTexture};class bV extends Oi{constructor(){super(...arguments),this.BRDF_V_HEIGHT_CORRELATED=!1,this.MS_BRDF_ENERGY_CONSERVATION=!1,this.SPHERICAL_HARMONICS=!1,this.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=!1,this.MIX_IBL_RADIANCE_WITH_IRRADIANCE=!0,this.LEGACY_SPECULAR_ENERGY_CONSERVATION=!1,this.BASE_DIFFUSE_MODEL=0,this.DIELECTRIC_SPECULAR_MODEL=0,this.CONDUCTOR_SPECULAR_MODEL=0}}class et extends Er{_markAllSubMeshesAsMiscDirty(){this._internalMarkAllSubMeshesAsMiscDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRBRDF",90,new bV,t),this._useEnergyConservation=et.DEFAULT_USE_ENERGY_CONSERVATION,this.useEnergyConservation=et.DEFAULT_USE_ENERGY_CONSERVATION,this._useSmithVisibilityHeightCorrelated=et.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this.useSmithVisibilityHeightCorrelated=et.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this._useSphericalHarmonics=et.DEFAULT_USE_SPHERICAL_HARMONICS,this.useSphericalHarmonics=et.DEFAULT_USE_SPHERICAL_HARMONICS,this._useSpecularGlossinessInputEnergyConservation=et.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this.useSpecularGlossinessInputEnergyConservation=et.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this._mixIblRadianceWithIrradiance=et.DEFAULT_MIX_IBL_RADIANCE_WITH_IRRADIANCE,this.mixIblRadianceWithIrradiance=et.DEFAULT_MIX_IBL_RADIANCE_WITH_IRRADIANCE,this._useLegacySpecularEnergyConservation=et.DEFAULT_USE_LEGACY_SPECULAR_ENERGY_CONSERVATION,this.useLegacySpecularEnergyConservation=et.DEFAULT_USE_LEGACY_SPECULAR_ENERGY_CONSERVATION,this._baseDiffuseModel=et.DEFAULT_DIFFUSE_MODEL,this.baseDiffuseModel=et.DEFAULT_DIFFUSE_MODEL,this._dielectricSpecularModel=et.DEFAULT_DIELECTRIC_SPECULAR_MODEL,this.dielectricSpecularModel=et.DEFAULT_DIELECTRIC_SPECULAR_MODEL,this._conductorSpecularModel=et.DEFAULT_CONDUCTOR_SPECULAR_MODEL,this.conductorSpecularModel=et.DEFAULT_CONDUCTOR_SPECULAR_MODEL,this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16],this._enable(!0)}prepareDefines(e){e.BRDF_V_HEIGHT_CORRELATED=this._useSmithVisibilityHeightCorrelated,e.MS_BRDF_ENERGY_CONSERVATION=this._useEnergyConservation&&this._useSmithVisibilityHeightCorrelated,e.SPHERICAL_HARMONICS=this._useSphericalHarmonics,e.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=this._useSpecularGlossinessInputEnergyConservation,e.MIX_IBL_RADIANCE_WITH_IRRADIANCE=this._mixIblRadianceWithIrradiance,e.LEGACY_SPECULAR_ENERGY_CONSERVATION=this._useLegacySpecularEnergyConservation,e.BASE_DIFFUSE_MODEL=this._baseDiffuseModel,e.DIELECTRIC_SPECULAR_MODEL=this._dielectricSpecularModel,e.CONDUCTOR_SPECULAR_MODEL=this._conductorSpecularModel}getClassName(){return"PBRBRDFConfiguration"}}et.DEFAULT_USE_ENERGY_CONSERVATION=!0;et.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED=!0;et.DEFAULT_USE_SPHERICAL_HARMONICS=!0;et.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION=!0;et.DEFAULT_MIX_IBL_RADIANCE_WITH_IRRADIANCE=!0;et.DEFAULT_USE_LEGACY_SPECULAR_ENERGY_CONSERVATION=!0;et.DEFAULT_DIFFUSE_MODEL=0;et.DEFAULT_DIELECTRIC_SPECULAR_MODEL=0;et.DEFAULT_CONDUCTOR_SPECULAR_MODEL=0;_([R(),W("_markAllSubMeshesAsMiscDirty")],et.prototype,"useEnergyConservation",void 0);_([R(),W("_markAllSubMeshesAsMiscDirty")],et.prototype,"useSmithVisibilityHeightCorrelated",void 0);_([R(),W("_markAllSubMeshesAsMiscDirty")],et.prototype,"useSphericalHarmonics",void 0);_([R(),W("_markAllSubMeshesAsMiscDirty")],et.prototype,"useSpecularGlossinessInputEnergyConservation",void 0);_([R(),W("_markAllSubMeshesAsMiscDirty")],et.prototype,"mixIblRadianceWithIrradiance",void 0);_([R(),W("_markAllSubMeshesAsMiscDirty")],et.prototype,"useLegacySpecularEnergyConservation",void 0);_([R("baseDiffuseModel"),W("_markAllSubMeshesAsMiscDirty")],et.prototype,"baseDiffuseModel",void 0);_([R("dielectricSpecularModel"),W("_markAllSubMeshesAsMiscDirty")],et.prototype,"dielectricSpecularModel",void 0);_([R("conductorSpecularModel"),W("_markAllSubMeshesAsMiscDirty")],et.prototype,"conductorSpecularModel",void 0);class CV extends Oi{constructor(){super(...arguments),this.CLEARCOAT=!1,this.CLEARCOAT_DEFAULTIOR=!1,this.CLEARCOAT_TEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this.CLEARCOAT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,this.CLEARCOAT_BUMP=!1,this.CLEARCOAT_BUMPDIRECTUV=0,this.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.CLEARCOAT_REMAP_F0=!1,this.CLEARCOAT_TINT=!1,this.CLEARCOAT_TINT_TEXTURE=!1,this.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TINT_GAMMATEXTURE=!1}}class hi extends Er{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRClearCoat",100,new CV,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.roughness=0,this._indexOfRefraction=hi._DefaultIndexOfRefraction,this.indexOfRefraction=hi._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._textureRoughness=null,this.textureRoughness=null,this._remapF0OnInterfaceChange=!0,this.remapF0OnInterfaceChange=!0,this._bumpTexture=null,this.bumpTexture=null,this._isTintEnabled=!1,this.isTintEnabled=!1,this.tintColor=q.White(),this.tintColorAtDistance=1,this.tintThickness=1,this._tintTexture=null,this.tintTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){if(!this._isEnabled)return!0;const r=this._material._disableBumpMap;return!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&K.ClearCoatTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&K.ClearCoatTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking()||i.getCaps().standardDerivatives&&this._bumpTexture&&K.ClearCoatBumpTextureEnabled&&!r&&!this._bumpTexture.isReady()||this._isTintEnabled&&this._tintTexture&&K.ClearCoatTintTextureEnabled&&!this._tintTexture.isReadyOrNotBlocking()))}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.CLEARCOAT=!0,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.CLEARCOAT_REMAP_F0=this._remapF0OnInterfaceChange,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&K.ClearCoatTextureEnabled?Nt(this._texture,e,"CLEARCOAT_TEXTURE"):e.CLEARCOAT_TEXTURE=!1,this._textureRoughness&&K.ClearCoatTextureEnabled?Nt(this._textureRoughness,e,"CLEARCOAT_TEXTURE_ROUGHNESS"):e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this._bumpTexture&&K.ClearCoatBumpTextureEnabled?Nt(this._bumpTexture,e,"CLEARCOAT_BUMP"):e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_DEFAULTIOR=this._indexOfRefraction===hi._DefaultIndexOfRefraction,this._isTintEnabled?(e.CLEARCOAT_TINT=!0,this._tintTexture&&K.ClearCoatTintTextureEnabled?(Nt(this._tintTexture,e,"CLEARCOAT_TINT_TEXTURE"),e.CLEARCOAT_TINT_GAMMATEXTURE=this._tintTexture.gammaSpace):e.CLEARCOAT_TINT_TEXTURE=!1):(e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1))):(e.CLEARCOAT=!1,e.CLEARCOAT_TEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.CLEARCOAT_DEFAULTIOR=!1,e.CLEARCOAT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,e.CLEARCOAT_BUMPDIRECTUV=0,e.CLEARCOAT_REMAP_F0=!1,e.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TINT_GAMMATEXTURE=!1)}bindForSubMesh(e,t,i,r){var u,h,d,f;if(!this._isEnabled)return;const n=r.materialDefines,a=this._material.isFrozen,o=this._material._disableBumpMap,l=this._material._invertNormalMapX,c=this._material._invertNormalMapY;if(!e.useUbo||!a||!e.isSync){(this._texture||this._textureRoughness)&&K.ClearCoatTextureEnabled&&(e.updateFloat4("vClearCoatInfos",((u=this._texture)==null?void 0:u.coordinatesIndex)??0,((h=this._texture)==null?void 0:h.level)??0,((d=this._textureRoughness)==null?void 0:d.coordinatesIndex)??0,((f=this._textureRoughness)==null?void 0:f.level)??0),this._texture&&Dt(this._texture,e,"clearCoat"),this._textureRoughness&&!n.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&Dt(this._textureRoughness,e,"clearCoatRoughness")),this._bumpTexture&&i.getCaps().standardDerivatives&&K.ClearCoatTextureEnabled&&!o&&(e.updateFloat2("vClearCoatBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level),Dt(this._bumpTexture,e,"clearCoatBump"),t._mirroredCameraPosition?e.updateFloat2("vClearCoatTangentSpaceParams",l?1:-1,c?1:-1):e.updateFloat2("vClearCoatTangentSpaceParams",l?-1:1,c?-1:1)),this._tintTexture&&K.ClearCoatTintTextureEnabled&&(e.updateFloat2("vClearCoatTintInfos",this._tintTexture.coordinatesIndex,this._tintTexture.level),Dt(this._tintTexture,e,"clearCoatTint")),e.updateFloat2("vClearCoatParams",this.intensity,this.roughness);const m=1-this._indexOfRefraction,g=1+this._indexOfRefraction,v=Math.pow(-m/g,2),E=1/this._indexOfRefraction;e.updateFloat4("vClearCoatRefractionParams",v,E,m,g),this._isTintEnabled&&(e.updateFloat4("vClearCoatTintParams",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintThickness)),e.updateFloat("clearCoatColorAtDistance",Math.max(1e-5,this.tintColorAtDistance)))}t.texturesEnabled&&(this._texture&&K.ClearCoatTextureEnabled&&e.setTexture("clearCoatSampler",this._texture),this._textureRoughness&&!n.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&K.ClearCoatTextureEnabled&&e.setTexture("clearCoatRoughnessSampler",this._textureRoughness),this._bumpTexture&&i.getCaps().standardDerivatives&&K.ClearCoatBumpTextureEnabled&&!o&&e.setTexture("clearCoatBumpSampler",this._bumpTexture),this._isTintEnabled&&this._tintTexture&&K.ClearCoatTintTextureEnabled&&e.setTexture("clearCoatTintSampler",this._tintTexture))}hasTexture(e){return this._texture===e||this._textureRoughness===e||this._bumpTexture===e||this._tintTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness),this._bumpTexture&&e.push(this._bumpTexture),this._tintTexture&&e.push(this._tintTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._tintTexture&&this._tintTexture.animations&&this._tintTexture.animations.length>0&&e.push(this._tintTexture)}dispose(e){var t,i,r,n;e&&((t=this._texture)==null||t.dispose(),(i=this._textureRoughness)==null||i.dispose(),(r=this._bumpTexture)==null||r.dispose(),(n=this._tintTexture)==null||n.dispose())}getClassName(){return"PBRClearCoatConfiguration"}addFallbacks(e,t,i){return e.CLEARCOAT_BUMP&&t.addFallback(i++,"CLEARCOAT_BUMP"),e.CLEARCOAT_TINT&&t.addFallback(i++,"CLEARCOAT_TINT"),e.CLEARCOAT&&t.addFallback(i++,"CLEARCOAT"),i}getSamplers(e){e.push("clearCoatSampler","clearCoatRoughnessSampler","clearCoatBumpSampler","clearCoatTintSampler")}getUniforms(){return{ubo:[{name:"vClearCoatParams",size:2,type:"vec2"},{name:"vClearCoatRefractionParams",size:4,type:"vec4"},{name:"vClearCoatInfos",size:4,type:"vec4"},{name:"clearCoatMatrix",size:16,type:"mat4"},{name:"clearCoatRoughnessMatrix",size:16,type:"mat4"},{name:"vClearCoatBumpInfos",size:2,type:"vec2"},{name:"vClearCoatTangentSpaceParams",size:2,type:"vec2"},{name:"clearCoatBumpMatrix",size:16,type:"mat4"},{name:"vClearCoatTintParams",size:4,type:"vec4"},{name:"clearCoatColorAtDistance",size:1,type:"float"},{name:"vClearCoatTintInfos",size:2,type:"vec2"},{name:"clearCoatTintMatrix",size:16,type:"mat4"}]}}}hi._DefaultIndexOfRefraction=1.5;_([R(),W("_markAllSubMeshesAsTexturesDirty")],hi.prototype,"isEnabled",void 0);_([R()],hi.prototype,"intensity",void 0);_([R()],hi.prototype,"roughness",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],hi.prototype,"indexOfRefraction",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],hi.prototype,"texture",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],hi.prototype,"useRoughnessFromMainTexture",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],hi.prototype,"textureRoughness",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],hi.prototype,"remapF0OnInterfaceChange",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],hi.prototype,"bumpTexture",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],hi.prototype,"isTintEnabled",void 0);_([Xt()],hi.prototype,"tintColor",void 0);_([R()],hi.prototype,"tintColorAtDistance",void 0);_([R()],hi.prototype,"tintThickness",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],hi.prototype,"tintTexture",void 0);class yV extends Oi{constructor(){super(...arguments),this.IRIDESCENCE=!1,this.IRIDESCENCE_TEXTURE=!1,this.IRIDESCENCE_TEXTUREDIRECTUV=0,this.IRIDESCENCE_THICKNESS_TEXTURE=!1,this.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0}}class Ui extends Er{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRIridescence",110,new yV,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.minimumThickness=Ui._DefaultMinimumThickness,this.maximumThickness=Ui._DefaultMaximumThickness,this.indexOfRefraction=Ui._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._thicknessTexture=null,this.thicknessTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&K.IridescenceTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._thicknessTexture&&K.IridescenceTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())):!0}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.IRIDESCENCE=!0,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&K.IridescenceTextureEnabled?Nt(this._texture,e,"IRIDESCENCE_TEXTURE"):e.IRIDESCENCE_TEXTURE=!1,this._thicknessTexture&&K.IridescenceTextureEnabled?Nt(this._thicknessTexture,e,"IRIDESCENCE_THICKNESS_TEXTURE"):e.IRIDESCENCE_THICKNESS_TEXTURE=!1)):(e.IRIDESCENCE=!1,e.IRIDESCENCE_TEXTURE=!1,e.IRIDESCENCE_THICKNESS_TEXTURE=!1,e.IRIDESCENCE_TEXTUREDIRECTUV=0,e.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0)}bindForSubMesh(e,t){var r,n,a,o;if(!this._isEnabled)return;const i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&((this._texture||this._thicknessTexture)&&K.IridescenceTextureEnabled&&(e.updateFloat4("vIridescenceInfos",((r=this._texture)==null?void 0:r.coordinatesIndex)??0,((n=this._texture)==null?void 0:n.level)??0,((a=this._thicknessTexture)==null?void 0:a.coordinatesIndex)??0,((o=this._thicknessTexture)==null?void 0:o.level)??0),this._texture&&Dt(this._texture,e,"iridescence"),this._thicknessTexture&&Dt(this._thicknessTexture,e,"iridescenceThickness")),e.updateFloat4("vIridescenceParams",this.intensity,this.indexOfRefraction,this.minimumThickness,this.maximumThickness)),t.texturesEnabled&&(this._texture&&K.IridescenceTextureEnabled&&e.setTexture("iridescenceSampler",this._texture),this._thicknessTexture&&K.IridescenceTextureEnabled&&e.setTexture("iridescenceThicknessSampler",this._thicknessTexture))}hasTexture(e){return this._texture===e||this._thicknessTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._thicknessTexture&&e.push(this._thicknessTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture)}dispose(e){var t,i;e&&((t=this._texture)==null||t.dispose(),(i=this._thicknessTexture)==null||i.dispose())}getClassName(){return"PBRIridescenceConfiguration"}addFallbacks(e,t,i){return e.IRIDESCENCE&&t.addFallback(i++,"IRIDESCENCE"),i}getSamplers(e){e.push("iridescenceSampler","iridescenceThicknessSampler")}getUniforms(){return{ubo:[{name:"vIridescenceParams",size:4,type:"vec4"},{name:"vIridescenceInfos",size:4,type:"vec4"},{name:"iridescenceMatrix",size:16,type:"mat4"},{name:"iridescenceThicknessMatrix",size:16,type:"mat4"}]}}}Ui._DefaultMinimumThickness=100;Ui._DefaultMaximumThickness=400;Ui._DefaultIndexOfRefraction=1.3;_([R(),W("_markAllSubMeshesAsTexturesDirty")],Ui.prototype,"isEnabled",void 0);_([R()],Ui.prototype,"intensity",void 0);_([R()],Ui.prototype,"minimumThickness",void 0);_([R()],Ui.prototype,"maximumThickness",void 0);_([R()],Ui.prototype,"indexOfRefraction",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],Ui.prototype,"texture",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],Ui.prototype,"thicknessTexture",void 0);class IV extends Oi{constructor(){super(...arguments),this.ANISOTROPIC=!1,this.ANISOTROPIC_TEXTURE=!1,this.ANISOTROPIC_TEXTUREDIRECTUV=0,this.ANISOTROPIC_LEGACY=!1,this.MAINUV1=!1}}class qo extends Er{set angle(e){this.direction.x=Math.cos(e),this.direction.y=Math.sin(e)}get angle(){return Math.atan2(this.direction.y,this.direction.x)}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markAllSubMeshesAsMiscDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsMiscDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRAnisotropic",110,new IV,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.direction=new X(1,0),this._texture=null,this.texture=null,this._legacy=!1,this.legacy=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16]}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&this._texture&&K.AnisotropicTextureEnabled&&!this._texture.isReadyOrNotBlocking()):!0}prepareDefinesBeforeAttributes(e,t,i){this._isEnabled?(e.ANISOTROPIC=this._isEnabled,this._isEnabled&&!i.isVerticesDataPresent(M.TangentKind)&&(e._needUVs=!0,e.MAINUV1=!0),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&K.AnisotropicTextureEnabled?Nt(this._texture,e,"ANISOTROPIC_TEXTURE"):e.ANISOTROPIC_TEXTURE=!1),e._areMiscDirty&&(e.ANISOTROPIC_LEGACY=this._legacy)):(e.ANISOTROPIC=!1,e.ANISOTROPIC_TEXTURE=!1,e.ANISOTROPIC_TEXTUREDIRECTUV=0,e.ANISOTROPIC_LEGACY=!1)}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&(this._texture&&K.AnisotropicTextureEnabled&&(e.updateFloat2("vAnisotropyInfos",this._texture.coordinatesIndex,this._texture.level),Dt(this._texture,e,"anisotropy")),e.updateFloat3("vAnisotropy",this.direction.x,this.direction.y,this.intensity)),t.texturesEnabled&&this._texture&&K.AnisotropicTextureEnabled&&e.setTexture("anisotropySampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){e&&this._texture&&this._texture.dispose()}getClassName(){return"PBRAnisotropicConfiguration"}addFallbacks(e,t,i){return e.ANISOTROPIC&&t.addFallback(i++,"ANISOTROPIC"),i}getSamplers(e){e.push("anisotropySampler")}getUniforms(){return{ubo:[{name:"vAnisotropy",size:3,type:"vec3"},{name:"vAnisotropyInfos",size:2,type:"vec2"},{name:"anisotropyMatrix",size:16,type:"mat4"}]}}parse(e,t,i){super.parse(e,t,i),e.legacy===void 0&&(this.legacy=!0)}}_([R(),W("_markAllSubMeshesAsTexturesDirty")],qo.prototype,"isEnabled",void 0);_([R()],qo.prototype,"intensity",void 0);_([ID()],qo.prototype,"direction",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],qo.prototype,"texture",void 0);_([R(),W("_markAllSubMeshesAsMiscDirty")],qo.prototype,"legacy",void 0);class RV extends Oi{constructor(){super(...arguments),this.SHEEN=!1,this.SHEEN_TEXTURE=!1,this.SHEEN_GAMMATEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS=!1,this.SHEEN_TEXTUREDIRECTUV=0,this.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0,this.SHEEN_LINKWITHALBEDO=!1,this.SHEEN_ROUGHNESS=!1,this.SHEEN_ALBEDOSCALING=!1,this.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1}}class qs extends Er{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"Sheen",120,new RV,t),this._isEnabled=!1,this.isEnabled=!1,this._linkSheenWithAlbedo=!1,this.linkSheenWithAlbedo=!1,this.intensity=1,this.color=q.White(),this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._roughness=null,this.roughness=null,this._textureRoughness=null,this.textureRoughness=null,this._albedoScaling=!1,this.albedoScaling=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&K.SheenTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&K.SheenTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking())):!0}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.SHEEN=!0,e.SHEEN_LINKWITHALBEDO=this._linkSheenWithAlbedo,e.SHEEN_ROUGHNESS=this._roughness!==null,e.SHEEN_ALBEDOSCALING=this._albedoScaling,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&K.SheenTextureEnabled?(Nt(this._texture,e,"SHEEN_TEXTURE"),e.SHEEN_GAMMATEXTURE=this._texture.gammaSpace):e.SHEEN_TEXTURE=!1,this._textureRoughness&&K.SheenTextureEnabled?Nt(this._textureRoughness,e,"SHEEN_TEXTURE_ROUGHNESS"):e.SHEEN_TEXTURE_ROUGHNESS=!1)):(e.SHEEN=!1,e.SHEEN_TEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS=!1,e.SHEEN_LINKWITHALBEDO=!1,e.SHEEN_ROUGHNESS=!1,e.SHEEN_ALBEDOSCALING=!1,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.SHEEN_GAMMATEXTURE=!1,e.SHEEN_TEXTUREDIRECTUV=0,e.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0)}bindForSubMesh(e,t,i,r){var o,l,c,u;if(!this._isEnabled)return;const n=r.materialDefines,a=this._material.isFrozen;(!e.useUbo||!a||!e.isSync)&&((this._texture||this._textureRoughness)&&K.SheenTextureEnabled&&(e.updateFloat4("vSheenInfos",((o=this._texture)==null?void 0:o.coordinatesIndex)??0,((l=this._texture)==null?void 0:l.level)??0,((c=this._textureRoughness)==null?void 0:c.coordinatesIndex)??0,((u=this._textureRoughness)==null?void 0:u.level)??0),this._texture&&Dt(this._texture,e,"sheen"),this._textureRoughness&&!n.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&Dt(this._textureRoughness,e,"sheenRoughness")),e.updateFloat4("vSheenColor",this.color.r,this.color.g,this.color.b,this.intensity),this._roughness!==null&&e.updateFloat("vSheenRoughness",this._roughness)),t.texturesEnabled&&(this._texture&&K.SheenTextureEnabled&&e.setTexture("sheenSampler",this._texture),this._textureRoughness&&!n.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&K.SheenTextureEnabled&&e.setTexture("sheenRoughnessSampler",this._textureRoughness))}hasTexture(e){return this._texture===e||this._textureRoughness===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness)}dispose(e){var t,i;e&&((t=this._texture)==null||t.dispose(),(i=this._textureRoughness)==null||i.dispose())}getClassName(){return"PBRSheenConfiguration"}addFallbacks(e,t,i){return e.SHEEN&&t.addFallback(i++,"SHEEN"),i}getSamplers(e){e.push("sheenSampler","sheenRoughnessSampler")}getUniforms(){return{ubo:[{name:"vSheenColor",size:4,type:"vec4"},{name:"vSheenRoughness",size:1,type:"float"},{name:"vSheenInfos",size:4,type:"vec4"},{name:"sheenMatrix",size:16,type:"mat4"},{name:"sheenRoughnessMatrix",size:16,type:"mat4"}]}}}_([R(),W("_markAllSubMeshesAsTexturesDirty")],qs.prototype,"isEnabled",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],qs.prototype,"linkSheenWithAlbedo",void 0);_([R()],qs.prototype,"intensity",void 0);_([Xt()],qs.prototype,"color",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],qs.prototype,"texture",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],qs.prototype,"useRoughnessFromMainTexture",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],qs.prototype,"roughness",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],qs.prototype,"textureRoughness",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],qs.prototype,"albedoScaling",void 0);class AV extends Oi{constructor(){super(...arguments),this.SUBSURFACE=!1,this.SS_REFRACTION=!1,this.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,this.SS_TRANSLUCENCY=!1,this.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,this.SS_SCATTERING=!1,this.SS_DISPERSION=!1,this.SS_THICKNESSANDMASK_TEXTURE=!1,this.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,this.SS_HAS_THICKNESS=!1,this.SS_REFRACTIONINTENSITY_TEXTURE=!1,this.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,this.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,this.SS_TRANSLUCENCYCOLOR_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYCOLOR_TEXTURE_GAMMA=!1,this.SS_REFRACTIONMAP_3D=!1,this.SS_REFRACTIONMAP_OPPOSITEZ=!1,this.SS_LODINREFRACTIONALPHA=!1,this.SS_GAMMAREFRACTION=!1,this.SS_RGBDREFRACTION=!1,this.SS_LINEARSPECULARREFRACTION=!1,this.SS_LINKREFRACTIONTOTRANSPARENCY=!1,this.SS_ALBEDOFORREFRACTIONTINT=!1,this.SS_ALBEDOFORTRANSLUCENCYTINT=!1,this.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.SS_USE_THICKNESS_AS_DEPTH=!1,this.SS_USE_GLTF_TEXTURES=!1,this.SS_APPLY_ALBEDO_AFTER_SUBSURFACE=!1,this.SS_TRANSLUCENCY_LEGACY=!1}}class rt extends Er{get scatteringDiffusionProfile(){return this._scene.subSurfaceConfiguration?this._scene.subSurfaceConfiguration.ssDiffusionProfileColors[this._scatteringDiffusionProfileIndex]:null}set scatteringDiffusionProfile(e){this._scene.enableSubSurfaceForPrePass()&&e&&(this._scatteringDiffusionProfileIndex=this._scene.subSurfaceConfiguration.addDiffusionProfile(e))}get volumeIndexOfRefraction(){return this._volumeIndexOfRefraction>=1?this._volumeIndexOfRefraction:this._indexOfRefraction}set volumeIndexOfRefraction(e){e>=1?this._volumeIndexOfRefraction=e:this._volumeIndexOfRefraction=-1}get legacyTransluceny(){return this.legacyTranslucency}set legacyTransluceny(e){this.legacyTranslucency=e}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markScenePrePassDirty(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty(),this._internalMarkScenePrePassDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRSubSurface",130,new AV,t),this._isRefractionEnabled=!1,this.isRefractionEnabled=!1,this._isTranslucencyEnabled=!1,this.isTranslucencyEnabled=!1,this._isDispersionEnabled=!1,this.isDispersionEnabled=!1,this._isScatteringEnabled=!1,this.isScatteringEnabled=!1,this._scatteringDiffusionProfileIndex=0,this.refractionIntensity=1,this.translucencyIntensity=1,this.useAlbedoToTintRefraction=!1,this.useAlbedoToTintTranslucency=!1,this._thicknessTexture=null,this.thicknessTexture=null,this._refractionTexture=null,this.refractionTexture=null,this._indexOfRefraction=1.5,this.indexOfRefraction=1.5,this._volumeIndexOfRefraction=-1,this._invertRefractionY=!1,this.invertRefractionY=!1,this._linkRefractionWithTransparency=!1,this.linkRefractionWithTransparency=!1,this.minimumThickness=0,this.maximumThickness=1,this.useThicknessAsDepth=!1,this.tintColor=q.White(),this.tintColorAtDistance=1,this.dispersion=0,this.diffusionDistance=q.White(),this._useMaskFromThicknessTexture=!1,this.useMaskFromThicknessTexture=!1,this._refractionIntensityTexture=null,this.refractionIntensityTexture=null,this._translucencyIntensityTexture=null,this.translucencyIntensityTexture=null,this.translucencyColor=null,this._translucencyColorTexture=null,this.translucencyColorTexture=null,this._useGltfStyleTextures=!0,this.useGltfStyleTextures=!0,this.applyAlbedoAfterSubSurface=rt.DEFAULT_APPLY_ALBEDO_AFTERSUBSURFACE,this.legacyTranslucency=rt.DEFAULT_LEGACY_TRANSLUCENCY,this._scene=e.getScene(),this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkScenePrePassDirty=e._dirtyCallbacks[32]}isReadyForSubMesh(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._thicknessTexture&&K.ThicknessTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking()||this._refractionIntensityTexture&&K.RefractionIntensityTextureEnabled&&!this._refractionIntensityTexture.isReadyOrNotBlocking()||this._translucencyColorTexture&&K.TranslucencyColorTextureEnabled&&!this._translucencyColorTexture.isReadyOrNotBlocking()||this._translucencyIntensityTexture&&K.TranslucencyIntensityTextureEnabled&&!this._translucencyIntensityTexture.isReadyOrNotBlocking())return!1;const i=this._getRefractionTexture(t);if(i&&K.RefractionTextureEnabled&&!i.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled){e.SUBSURFACE=!1,e.SS_DISPERSION=!1,e.SS_TRANSLUCENCY=!1,e.SS_SCATTERING=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,e.SS_HAS_THICKNESS=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,e.SS_REFRACTIONMAP_3D=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,e.SS_TRANSLUCENCYCOLOR_TEXTUREDIRECTUV=0,e.SS_TRANSLUCENCYCOLOR_TEXTURE_GAMMA=!1,e.SS_APPLY_ALBEDO_AFTER_SUBSURFACE=!1;return}if(e._areTexturesDirty){if(e.SUBSURFACE=!0,e.SS_DISPERSION=this._isDispersionEnabled,e.SS_TRANSLUCENCY=this._isTranslucencyEnabled,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_TRANSLUCENCY_LEGACY=this.legacyTranslucency,e.SS_SCATTERING=this._isScatteringEnabled,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_HAS_THICKNESS=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_REFRACTIONMAP_3D=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,e.SS_APPLY_ALBEDO_AFTER_SUBSURFACE=this.applyAlbedoAfterSubSurface,e._areTexturesDirty&&t.texturesEnabled&&(this._thicknessTexture&&K.ThicknessTextureEnabled&&Nt(this._thicknessTexture,e,"SS_THICKNESSANDMASK_TEXTURE"),this._refractionIntensityTexture&&K.RefractionIntensityTextureEnabled&&Nt(this._refractionIntensityTexture,e,"SS_REFRACTIONINTENSITY_TEXTURE"),this._translucencyIntensityTexture&&K.TranslucencyIntensityTextureEnabled&&Nt(this._translucencyIntensityTexture,e,"SS_TRANSLUCENCYINTENSITY_TEXTURE"),this._translucencyColorTexture&&K.TranslucencyColorTextureEnabled&&(Nt(this._translucencyColorTexture,e,"SS_TRANSLUCENCYCOLOR_TEXTURE"),e.SS_TRANSLUCENCYCOLOR_TEXTURE_GAMMA=this._translucencyColorTexture.gammaSpace)),e.SS_HAS_THICKNESS=this.maximumThickness-this.minimumThickness!==0,e.SS_USE_GLTF_TEXTURES=this._useGltfStyleTextures,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=this._useMaskFromThicknessTexture&&!this._refractionIntensityTexture,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=this._useMaskFromThicknessTexture&&!this._translucencyIntensityTexture,this._isRefractionEnabled&&t.texturesEnabled){const i=this._getRefractionTexture(t);i&&K.RefractionTextureEnabled&&(e.SS_REFRACTION=!0,e.SS_REFRACTIONMAP_3D=i.isCube,e.SS_GAMMAREFRACTION=i.gammaSpace,e.SS_RGBDREFRACTION=i.isRGBD,e.SS_LINEARSPECULARREFRACTION=i.linearSpecularLOD,e.SS_REFRACTIONMAP_OPPOSITEZ=this._scene.useRightHandedSystem&&i.isCube?!i.invertZ:i.invertZ,e.SS_LODINREFRACTIONALPHA=i.lodLevelInAlpha,e.SS_LINKREFRACTIONTOTRANSPARENCY=this._linkRefractionWithTransparency,e.SS_ALBEDOFORREFRACTIONTINT=this.useAlbedoToTintRefraction,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=i.isCube&&i.boundingBoxSize,e.SS_USE_THICKNESS_AS_DEPTH=this.useThicknessAsDepth)}this._isTranslucencyEnabled&&(e.SS_ALBEDOFORTRANSLUCENCYTINT=this.useAlbedoToTintTranslucency)}}hardBindForSubMesh(e,t,i,r){if(!(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled))if(this.maximumThickness===0&&this.minimumThickness===0)e.updateFloat2("vThicknessParam",0,0);else{r.getRenderingMesh().getWorldMatrix().decompose(G.Vector3[0]);const n=Math.max(Math.abs(G.Vector3[0].x),Math.abs(G.Vector3[0].y),Math.abs(G.Vector3[0].z));e.updateFloat2("vThicknessParam",this.minimumThickness*n,(this.maximumThickness-this.minimumThickness)*n)}}bindForSubMesh(e,t,i,r){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;const n=r.materialDefines,a=this._material.isFrozen,o=this._material.realTimeFiltering,l=n.LODBASEDMICROSFURACE,c=this._getRefractionTexture(t);if(!e.useUbo||!a||!e.isSync){if(this._thicknessTexture&&K.ThicknessTextureEnabled&&(e.updateFloat2("vThicknessInfos",this._thicknessTexture.coordinatesIndex,this._thicknessTexture.level),Dt(this._thicknessTexture,e,"thickness")),this._refractionIntensityTexture&&K.RefractionIntensityTextureEnabled&&n.SS_REFRACTIONINTENSITY_TEXTURE&&(e.updateFloat2("vRefractionIntensityInfos",this._refractionIntensityTexture.coordinatesIndex,this._refractionIntensityTexture.level),Dt(this._refractionIntensityTexture,e,"refractionIntensity")),this._translucencyColorTexture&&K.TranslucencyColorTextureEnabled&&n.SS_TRANSLUCENCYCOLOR_TEXTURE&&(e.updateFloat2("vTranslucencyColorInfos",this._translucencyColorTexture.coordinatesIndex,this._translucencyColorTexture.level),Dt(this._translucencyColorTexture,e,"translucencyColor")),this._translucencyIntensityTexture&&K.TranslucencyIntensityTextureEnabled&&n.SS_TRANSLUCENCYINTENSITY_TEXTURE&&(e.updateFloat2("vTranslucencyIntensityInfos",this._translucencyIntensityTexture.coordinatesIndex,this._translucencyIntensityTexture.level),Dt(this._translucencyIntensityTexture,e,"translucencyIntensity")),c&&K.RefractionTextureEnabled){e.updateMatrix("refractionMatrix",c.getRefractionTextureMatrix());let u=1;c.isCube||c.depth&&(u=c.depth);const h=c.getSize().width,d=this.volumeIndexOfRefraction;if(e.updateFloat4("vRefractionInfos",c.level,1/d,u,this._invertRefractionY?-1:1),e.updateFloat4("vRefractionMicrosurfaceInfos",h,c.lodGenerationScale,c.lodGenerationOffset,1/this.indexOfRefraction),o&&e.updateFloat2("vRefractionFilteringInfo",h,Math.log2(h)),c.boundingBoxSize){const f=c;e.updateVector3("vRefractionPosition",f.boundingBoxPosition),e.updateVector3("vRefractionSize",f.boundingBoxSize)}}this._isScatteringEnabled&&e.updateFloat("scatteringDiffusionProfile",this._scatteringDiffusionProfileIndex),e.updateColor3("vDiffusionDistance",this.diffusionDistance),e.updateFloat4("vTintColor",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintColorAtDistance)),e.updateColor4("vTranslucencyColor",this.translucencyColor??this.tintColor,0),e.updateFloat3("vSubSurfaceIntensity",this.refractionIntensity,this.translucencyIntensity,0),e.updateFloat("dispersion",this.dispersion)}t.texturesEnabled&&(this._thicknessTexture&&K.ThicknessTextureEnabled&&e.setTexture("thicknessSampler",this._thicknessTexture),this._refractionIntensityTexture&&K.RefractionIntensityTextureEnabled&&n.SS_REFRACTIONINTENSITY_TEXTURE&&e.setTexture("refractionIntensitySampler",this._refractionIntensityTexture),this._translucencyIntensityTexture&&K.TranslucencyIntensityTextureEnabled&&n.SS_TRANSLUCENCYINTENSITY_TEXTURE&&e.setTexture("translucencyIntensitySampler",this._translucencyIntensityTexture),this._translucencyColorTexture&&K.TranslucencyColorTextureEnabled&&n.SS_TRANSLUCENCYCOLOR_TEXTURE&&e.setTexture("translucencyColorSampler",this._translucencyColorTexture),c&&K.RefractionTextureEnabled&&(l?e.setTexture("refractionSampler",c):(e.setTexture("refractionSampler",c._lodTextureMid||c),e.setTexture("refractionSamplerLow",c._lodTextureLow||c),e.setTexture("refractionSamplerHigh",c._lodTextureHigh||c))))}_getRefractionTexture(e){return this._refractionTexture?this._refractionTexture:this._isRefractionEnabled?e.environmentTexture:null}get disableAlphaBlending(){return this._isRefractionEnabled&&this._linkRefractionWithTransparency}fillRenderTargetTextures(e){K.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&e.push(this._refractionTexture)}hasTexture(e){return this._thicknessTexture===e||this._refractionTexture===e||this._refractionIntensityTexture===e||this._translucencyIntensityTexture===e||this._translucencyColorTexture===e}hasRenderTargetTextures(){return!!(K.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)}getActiveTextures(e){this._thicknessTexture&&e.push(this._thicknessTexture),this._refractionTexture&&e.push(this._refractionTexture),this._refractionIntensityTexture&&e.push(this._refractionIntensityTexture),this._translucencyColorTexture&&e.push(this._translucencyColorTexture),this._translucencyIntensityTexture&&e.push(this._translucencyIntensityTexture)}getAnimatables(e){this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),this._refractionIntensityTexture&&this._refractionIntensityTexture.animations&&this._refractionIntensityTexture.animations.length>0&&e.push(this._refractionIntensityTexture),this._translucencyColorTexture&&this._translucencyColorTexture.animations&&this._translucencyColorTexture.animations.length>0&&e.push(this._translucencyColorTexture),this._translucencyIntensityTexture&&this._translucencyIntensityTexture.animations&&this._translucencyIntensityTexture.animations.length>0&&e.push(this._translucencyIntensityTexture)}dispose(e){e&&(this._thicknessTexture&&this._thicknessTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose(),this._refractionIntensityTexture&&this._refractionIntensityTexture.dispose(),this._translucencyColorTexture&&this._translucencyColorTexture.dispose(),this._translucencyIntensityTexture&&this._translucencyIntensityTexture.dispose())}getClassName(){return"PBRSubSurfaceConfiguration"}addFallbacks(e,t,i){return e.SS_SCATTERING&&t.addFallback(i++,"SS_SCATTERING"),e.SS_TRANSLUCENCY&&t.addFallback(i++,"SS_TRANSLUCENCY"),i}getSamplers(e){e.push("thicknessSampler","refractionIntensitySampler","translucencyIntensitySampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh","translucencyColorSampler")}getUniforms(){return{ubo:[{name:"vRefractionMicrosurfaceInfos",size:4,type:"vec4"},{name:"vRefractionFilteringInfo",size:2,type:"vec2"},{name:"vTranslucencyIntensityInfos",size:2,type:"vec2"},{name:"vRefractionInfos",size:4,type:"vec4"},{name:"refractionMatrix",size:16,type:"mat4"},{name:"vThicknessInfos",size:2,type:"vec2"},{name:"vRefractionIntensityInfos",size:2,type:"vec2"},{name:"thicknessMatrix",size:16,type:"mat4"},{name:"refractionIntensityMatrix",size:16,type:"mat4"},{name:"translucencyIntensityMatrix",size:16,type:"mat4"},{name:"vThicknessParam",size:2,type:"vec2"},{name:"vDiffusionDistance",size:3,type:"vec3"},{name:"vTintColor",size:4,type:"vec4"},{name:"vSubSurfaceIntensity",size:3,type:"vec3"},{name:"vRefractionPosition",size:3,type:"vec3"},{name:"vRefractionSize",size:3,type:"vec3"},{name:"scatteringDiffusionProfile",size:1,type:"float"},{name:"dispersion",size:1,type:"float"},{name:"vTranslucencyColor",size:4,type:"vec4"},{name:"vTranslucencyColorInfos",size:2,type:"vec2"},{name:"translucencyColorMatrix",size:16,type:"mat4"}]}}}rt.DEFAULT_APPLY_ALBEDO_AFTERSUBSURFACE=!1;rt.DEFAULT_LEGACY_TRANSLUCENCY=!1;_([R(),W("_markAllSubMeshesAsTexturesDirty")],rt.prototype,"isRefractionEnabled",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],rt.prototype,"isTranslucencyEnabled",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],rt.prototype,"isDispersionEnabled",void 0);_([R(),W("_markScenePrePassDirty")],rt.prototype,"isScatteringEnabled",void 0);_([R()],rt.prototype,"_scatteringDiffusionProfileIndex",void 0);_([R()],rt.prototype,"refractionIntensity",void 0);_([R()],rt.prototype,"translucencyIntensity",void 0);_([R()],rt.prototype,"useAlbedoToTintRefraction",void 0);_([R()],rt.prototype,"useAlbedoToTintTranslucency",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],rt.prototype,"thicknessTexture",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],rt.prototype,"refractionTexture",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],rt.prototype,"indexOfRefraction",void 0);_([R()],rt.prototype,"_volumeIndexOfRefraction",void 0);_([W("_markAllSubMeshesAsTexturesDirty")],rt.prototype,"volumeIndexOfRefraction",null);_([R(),W("_markAllSubMeshesAsTexturesDirty")],rt.prototype,"invertRefractionY",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],rt.prototype,"linkRefractionWithTransparency",void 0);_([R()],rt.prototype,"minimumThickness",void 0);_([R()],rt.prototype,"maximumThickness",void 0);_([R()],rt.prototype,"useThicknessAsDepth",void 0);_([Xt()],rt.prototype,"tintColor",void 0);_([R()],rt.prototype,"tintColorAtDistance",void 0);_([R()],rt.prototype,"dispersion",void 0);_([Xt()],rt.prototype,"diffusionDistance",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],rt.prototype,"useMaskFromThicknessTexture",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],rt.prototype,"refractionIntensityTexture",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],rt.prototype,"translucencyIntensityTexture",void 0);_([Xt()],rt.prototype,"translucencyColor",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],rt.prototype,"translucencyColorTexture",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],rt.prototype,"useGltfStyleTextures",void 0);_([R()],rt.prototype,"applyAlbedoAfterSubSurface",void 0);_([R()],rt.prototype,"legacyTranslucency",void 0);const Ka={effect:null,subMesh:null};class PV extends qm(Oi){}class Gv extends Ou(PV){constructor(e){super(e),this.PBR=!0,this.NUM_SAMPLES="0",this.REALTIME_FILTERING=!1,this.IBL_CDF_FILTERING=!1,this.ALBEDO=!1,this.GAMMAALBEDO=!1,this.ALBEDODIRECTUV=0,this.VERTEXCOLOR=!1,this.BASE_WEIGHT=!1,this.BASE_WEIGHTDIRECTUV=0,this.BASE_DIFFUSE_ROUGHNESS=!1,this.BASE_DIFFUSE_ROUGHNESSDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.AMBIENTINGRAYSCALE=!1,this.OPACITY=!1,this.VERTEXALPHA=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHABLEND=!1,this.ALPHAFROMALBEDO=!1,this.ALPHATESTVALUE="0.5",this.SPECULAROVERALPHA=!1,this.RADIANCEOVERALPHA=!1,this.ALPHAFRESNEL=!1,this.LINEARALPHAFRESNEL=!1,this.PREMULTIPLYALPHA=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.GAMMAEMISSIVE=!1,this.REFLECTIVITY=!1,this.REFLECTIVITY_GAMMA=!1,this.REFLECTIVITYDIRECTUV=0,this.SPECULARTERM=!1,this.MICROSURFACEFROMREFLECTIVITYMAP=!1,this.MICROSURFACEAUTOMATIC=!1,this.LODBASEDMICROSFURACE=!1,this.MICROSURFACEMAP=!1,this.MICROSURFACEMAPDIRECTUV=0,this.METALLICWORKFLOW=!1,this.ROUGHNESSSTOREINMETALMAPALPHA=!1,this.ROUGHNESSSTOREINMETALMAPGREEN=!1,this.METALLNESSSTOREINMETALMAPBLUE=!1,this.AOSTOREINMETALMAPRED=!1,this.METALLIC_REFLECTANCE=!1,this.METALLIC_REFLECTANCE_GAMMA=!1,this.METALLIC_REFLECTANCEDIRECTUV=0,this.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=!1,this.REFLECTANCE=!1,this.REFLECTANCE_GAMMA=!1,this.REFLECTANCEDIRECTUV=0,this.ENVIRONMENTBRDF=!1,this.ENVIRONMENTBRDF_RGBD=!1,this.NORMAL=!1,this.TANGENT=!1,this.BUMP=!1,this.BUMPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.PARALLAX=!1,this.PARALLAX_RHS=!1,this.PARALLAXOCCLUSION=!1,this.NORMALXYSCALE=!0,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.USELIGHTMAPASSHADOWMAP=!1,this.GAMMALIGHTMAP=!1,this.RGBDLIGHTMAP=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.USESPHERICALFROMREFLECTIONMAP=!1,this.USEIRRADIANCEMAP=!1,this.USE_IRRADIANCE_DOMINANT_DIRECTION=!1,this.USESPHERICALINVERTEX=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.LINEARSPECULARREFLECTION=!1,this.RADIANCEOCCLUSION=!1,this.HORIZONOCCLUSION=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.PREPASS=!1,this.PREPASS_COLOR=!1,this.PREPASS_COLOR_INDEX=-1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO=!1,this.PREPASS_ALBEDO_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=!1,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.PREPASS_NORMALIZED_VIEW_DEPTH=!1,this.PREPASS_NORMALIZED_VIEW_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=!1,this.PREPASS_WORLD_NORMAL=!1,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=!1,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_VELOCITY_LINEAR=!1,this.PREPASS_VELOCITY_LINEAR_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.NONUNIFORMSCALING=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_POSITION=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.MORPHTARGETS_UV2=!1,this.MORPHTARGETS_COLOR=!1,this.MORPHTARGETTEXTURE_HASPOSITIONS=!1,this.MORPHTARGETTEXTURE_HASNORMALS=!1,this.MORPHTARGETTEXTURE_HASTANGENTS=!1,this.MORPHTARGETTEXTURE_HASUVS=!1,this.MORPHTARGETTEXTURE_HASUV2S=!1,this.MORPHTARGETTEXTURE_HASCOLORS=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.USEPHYSICALLIGHTFALLOFF=!1,this.USEGLTFLIGHTFALLOFF=!1,this.TWOSIDEDLIGHTING=!1,this.MIRRORED=!1,this.SHADOWFLOAT=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.LOGARITHMICDEPTH=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.AREALIGHTSUPPORTED=!0,this.FORCENORMALFORWARD=!1,this.SPECULARAA=!1,this.UNLIT=!1,this.DECAL_AFTER_DETAIL=!1,this.DEBUGMODE=0,this.USE_VERTEX_PULLING=!1,this.CLUSTLIGHT_SLICES=0,this.CLUSTLIGHT_BATCH=0,this.rebuild()}reset(){super.reset(),this.ALPHATESTVALUE="0.5",this.PBR=!0,this.NORMALXYSCALE=!0}}class OV extends Nu(Zl){}class Ve extends OV{get realTimeFiltering(){return this._realTimeFiltering}set realTimeFiltering(e){this._realTimeFiltering=e,this.markAsDirty(1)}get realTimeFilteringQuality(){return this._realTimeFilteringQuality}set realTimeFilteringQuality(e){this._realTimeFilteringQuality=e,this.markAsDirty(1)}get canRenderToMRT(){return!0}constructor(e,t,i=!1){super(e,t,void 0,i||Ve.ForceGLSL),this._directIntensity=1,this._emissiveIntensity=1,this._environmentIntensity=1,this._specularIntensity=1,this._lightingInfos=new Ee(this._directIntensity,this._emissiveIntensity,this._environmentIntensity,this._specularIntensity),this._disableBumpMap=!1,this._albedoTexture=null,this._baseWeightTexture=null,this._baseDiffuseRoughnessTexture=null,this._ambientTexture=null,this._ambientTextureStrength=1,this._ambientTextureImpactOnAnalyticalLights=Ve.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._reflectivityTexture=null,this._metallicTexture=null,this._metallic=null,this._roughness=null,this._metallicF0Factor=1,this._metallicReflectanceColor=q.White(),this._useOnlyMetallicFromMetallicReflectanceTexture=!1,this._metallicReflectanceTexture=null,this._reflectanceTexture=null,this._microSurfaceTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._ambientColor=new q(0,0,0),this._albedoColor=new q(1,1,1),this._baseWeight=1,this._baseDiffuseRoughness=null,this._reflectivityColor=new q(1,1,1),this._reflectionColor=new q(1,1,1),this._emissiveColor=new q(0,0,0),this._microSurface=.9,this._useLightmapAsShadowmap=!1,this._useHorizonOcclusion=!0,this._useRadianceOcclusion=!0,this._useAlphaFromAlbedoTexture=!1,this._useSpecularOverAlpha=!0,this._useMicroSurfaceFromReflectivityMapAlpha=!1,this._useRoughnessFromMetallicTextureAlpha=!0,this._useRoughnessFromMetallicTextureGreen=!1,this._useMetallnessFromMetallicTextureBlue=!1,this._useAmbientOcclusionFromMetallicTextureRed=!1,this._useAmbientInGrayScale=!1,this._useAutoMicroSurfaceFromReflectivityMap=!1,this._lightFalloff=Ve.LIGHTFALLOFF_PHYSICAL,this._useRadianceOverAlpha=!0,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this._parallaxScaleBias=.05,this._disableLighting=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._alphaCutOff=.4,this._useAlphaFresnel=!1,this._useLinearAlphaFresnel=!1,this._environmentBRDFTexture=null,this._forceIrradianceInFragment=!1,this._realTimeFiltering=!1,this._realTimeFilteringQuality=8,this._forceNormalForward=!1,this._enableSpecularAntiAliasing=!1,this._renderTargets=new Xn(16),this._globalAmbientColor=new q(0,0,0),this._unlit=!1,this._applyDecalMapAfterDetailMap=!1,this._debugMode=0,this._shadersLoaded=!1,this._breakShaderLoadedCheck=!1,this.debugMode=0,this.debugLimit=-1,this.debugFactor=1,this._cacheHasRenderTargetTextures=!1,this.brdf=new et(this),this.clearCoat=new hi(this),this.iridescence=new Ui(this),this.anisotropy=new qo(this),this.sheen=new qs(this),this.subSurface=new rt(this),this.detailMap=new RD(this),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),K.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets),this._environmentBRDFTexture=gh(this.getScene()),this.prePassConfiguration=new Zc}get hasRenderTargetTextures(){return K.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures}get isPrePassCapable(){return!this.disableDepthWrite}getClassName(){return"PBRBaseMaterial"}get _disableAlphaBlending(){var e;return this._transparencyMode===Ve.PBRMATERIAL_OPAQUE||this._transparencyMode===Ve.PBRMATERIAL_ALPHATEST||((e=this.subSurface)==null?void 0:e.disableAlphaBlending)}needAlphaBlending(){return this._hasTransparencyMode?this._transparencyModeIsBlend:this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromAlbedoTexture()}needAlphaTesting(){var e;return this._hasTransparencyMode?this._transparencyModeIsTest:(e=this.subSurface)!=null&&e.disableAlphaBlending?!1:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===Ve.PBRMATERIAL_ALPHATEST)}_shouldUseAlphaFromAlbedoTexture(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture&&this._transparencyMode!==Ve.PBRMATERIAL_OPAQUE}_hasAlphaChannel(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha||this._opacityTexture!=null}getAlphaTestTexture(){return this._albedoTexture}isReadyForSubMesh(e,t,i){var d;this._uniformBufferLayoutBuilt||this.buildUniformLayout();const r=t._drawWrapper;if(r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(4,this._eventInfo),t.materialDefines=new Gv(this._eventInfo.defineNames));const n=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const a=this.getScene(),o=a.getEngine();if(n._areTexturesDirty&&(this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,a.texturesEnabled)){if(this._albedoTexture&&K.DiffuseTextureEnabled&&!this._albedoTexture.isReadyOrNotBlocking()||this._baseWeightTexture&&K.BaseWeightTextureEnabled&&!this._baseWeightTexture.isReadyOrNotBlocking()||this._baseDiffuseRoughnessTexture&&K.BaseDiffuseRoughnessTextureEnabled&&!this._baseDiffuseRoughnessTexture.isReadyOrNotBlocking()||this._ambientTexture&&K.AmbientTextureEnabled&&!this._ambientTexture.isReadyOrNotBlocking()||this._opacityTexture&&K.OpacityTextureEnabled&&!this._opacityTexture.isReadyOrNotBlocking())return!1;const f=this._getReflectionTexture();if(f&&K.ReflectionTextureEnabled){if(!f.isReadyOrNotBlocking())return!1;if(f.irradianceTexture){if(!f.irradianceTexture.isReadyOrNotBlocking())return!1}else if(!f.sphericalPolynomial&&((d=f.getInternalTexture())!=null&&d._sphericalPolynomialPromise))return!1}if(this._lightmapTexture&&K.LightmapTextureEnabled&&!this._lightmapTexture.isReadyOrNotBlocking()||this._emissiveTexture&&K.EmissiveTextureEnabled&&!this._emissiveTexture.isReadyOrNotBlocking())return!1;if(K.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking())return!1}else if(this._reflectivityTexture&&!this._reflectivityTexture.isReadyOrNotBlocking())return!1;if(this._metallicReflectanceTexture&&!this._metallicReflectanceTexture.isReadyOrNotBlocking()||this._reflectanceTexture&&!this._reflectanceTexture.isReadyOrNotBlocking()||this._microSurfaceTexture&&!this._microSurfaceTexture.isReadyOrNotBlocking())return!1}if(o.getCaps().standardDerivatives&&this._bumpTexture&&K.BumpTextureEnabled&&!this._disableBumpMap&&!this._bumpTexture.isReady()||this._environmentBRDFTexture&&K.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady())return!1}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=n,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh||n._areImageProcessingDirty&&this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady())return!1;if(n.AREALIGHTUSED||n.CLUSTLIGHT_BATCH){for(let f=0;f<e.lightSources.length;f++)if(!e.lightSources[f]._isReady())return!1}!o.getCaps().standardDerivatives&&!e.isVerticesDataPresent(M.NormalKind)&&(e.createNormals(!0),N.Warn("PBRMaterial: Normals have been created for the mesh: "+e.name));const l=t.effect,c=n._areLightsDisposed;let u=this._prepareEffect(e,t.getRenderingMesh(),n,this.onCompiled,this.onError,i,null),h=!1;if(u)if(this._onEffectCreatedObservable&&(Ka.effect=u,Ka.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Ka)),this.allowShaderHotSwapping&&l&&!u.isReady()){if(u=l,n.markAsUnprocessed(),h=this.isFrozen,c)return n._areLightsDisposed=!0,!1}else a.resetCachedMaterial(),t.setEffect(u,n,this._materialContext);return!t.effect||!t.effect.isReady()?!1:(n._renderId=a.getRenderId(),r._wasPreviouslyReady=!h,r._wasPreviouslyUsingInstances=!!i,this._checkScenePerformancePriority(),!0)}isMetallicWorkflow(){return!!(this._metallic!=null||this._roughness!=null||this._metallicTexture)}_prepareEffect(e,t,i,r=null,n=null,a=null,o=null){if(this._prepareDefines(e,t,i,a,o),!i.isDirty)return null;i.markAsProcessed();const c=this.getScene().getEngine(),u=new Ma;let h=0;i.USESPHERICALINVERTEX&&u.addFallback(h++,"USESPHERICALINVERTEX"),i.FOG&&u.addFallback(h,"FOG"),i.SPECULARAA&&u.addFallback(h,"SPECULARAA"),i.POINTSIZE&&u.addFallback(h,"POINTSIZE"),i.LOGARITHMICDEPTH&&u.addFallback(h,"LOGARITHMICDEPTH"),i.PARALLAX&&u.addFallback(h,"PARALLAX"),i.PARALLAX_RHS&&u.addFallback(h,"PARALLAX_RHS"),i.PARALLAXOCCLUSION&&u.addFallback(h++,"PARALLAXOCCLUSION"),i.ENVIRONMENTBRDF&&u.addFallback(h++,"ENVIRONMENTBRDF"),i.TANGENT&&u.addFallback(h++,"TANGENT"),i.BUMP&&u.addFallback(h++,"BUMP"),h=Gm(i,u,this._maxSimultaneousLights,h++),i.SPECULARTERM&&u.addFallback(h++,"SPECULARTERM"),i.USESPHERICALFROMREFLECTIONMAP&&u.addFallback(h++,"USESPHERICALFROMREFLECTIONMAP"),i.USEIRRADIANCEMAP&&u.addFallback(h++,"USEIRRADIANCEMAP"),i.LIGHTMAP&&u.addFallback(h++,"LIGHTMAP"),i.NORMAL&&u.addFallback(h++,"NORMAL"),i.AMBIENT&&u.addFallback(h++,"AMBIENT"),i.EMISSIVE&&u.addFallback(h++,"EMISSIVE"),i.VERTEXCOLOR&&u.addFallback(h++,"VERTEXCOLOR"),i.MORPHTARGETS&&u.addFallback(h++,"MORPHTARGETS"),i.MULTIVIEW&&u.addFallback(0,"MULTIVIEW");const d=[M.PositionKind];i.NORMAL&&d.push(M.NormalKind),i.TANGENT&&d.push(M.TangentKind);for(let I=1;I<=6;++I)i["UV"+I]&&d.push(`uv${I===1?"":I}`);i.VERTEXCOLOR&&d.push(M.ColorKind),zm(d,e,i,u),Ru(d,i),uI(d,e,i),hI(d,e,i);let f="pbr";const m=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","baseWeight","baseDiffuseRoughness","vReflectivityColor","vMetallicReflectanceFactors","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vBaseWeightInfos","vBaseDiffuseRoughnessInfos","vAmbientInfos","vOpacityInfos","vEmissiveInfos","vReflectivityInfos","vMetallicReflectanceInfos","vReflectanceInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","mBones","albedoMatrix","baseWeightMatrix","baseDiffuseRoughnessMatrix","ambientMatrix","opacityMatrix","emissiveMatrix","reflectivityMatrix","normalMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","metallicReflectanceMatrix","reflectanceMatrix","vLightingIntensity","logarithmicDepthConstant","vTangentSpaceParams","boneTextureWidth","vDebugMode","morphTargetTextureInfo","morphTargetTextureIndices","cameraInfo"],g=["albedoSampler","baseWeightSampler","baseDiffuseRoughnessSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","microSurfaceSampler","environmentBrdfSampler","boneSampler","metallicReflectanceSampler","reflectanceSampler","morphTargets","oitDepthSampler","oitFrontColorSampler","areaLightsLTC1Sampler","areaLightsLTC2Sampler"];Wm(m,g,!0);const v=["Material","Scene","Mesh"],E={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:i.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=u,this._eventInfo.fallbackRank=h,this._eventInfo.defines=i,this._eventInfo.uniforms=m,this._eventInfo.attributes=d,this._eventInfo.samplers=g,this._eventInfo.uniformBuffersNames=v,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=E,this._callbackPluginEventGeneric(128,this._eventInfo),Ei.AddUniformsAndSamplers(m,g),Zc.AddUniforms(m),Na(m),bi&&(bi.PrepareUniforms(m,i),bi.PrepareSamplers(g,i)),Au({uniformsNames:m,uniformBuffersNames:v,samplers:g,defines:i,maxSimultaneousLights:this._maxSimultaneousLights});const T={};this.customShaderNameResolve&&(f=this.customShaderNameResolve(f,m,v,g,i,d,T));const C=i.toString(),A=c.createEffect(f,{attributes:d,uniformsNames:m,uniformBuffersNames:v,samplers:g,defines:C,fallbacks:u,onCompiled:r,onError:n,indexParameters:E,processFinalCode:T.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:i.PREPASS,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{this.shaderLanguage===1?await Promise.all([U(()=>Promise.resolve().then(()=>bA),void 0),U(()=>Promise.resolve().then(()=>yA),void 0)]):await Promise.all([U(()=>Promise.resolve().then(()=>RA),void 0),U(()=>Promise.resolve().then(()=>PA),void 0)]),this._shadersLoaded=!0}},c);return this._eventInfo.customCode=void 0,A}_prepareDefines(e,t,i,r=null,n=null){const a=t.hasThinInstances,o=this.getScene(),l=o.getEngine();jl(o,e,i,!0,this._maxSimultaneousLights,this._disableLighting),i._needNormals=!0,bu(o,i);const c=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(jm(o,i,this.canRenderToMRT&&!c),dI(o,i,c),Ei.PrepareDefines(l.currentRenderPassId,e,i),i.METALLICWORKFLOW=this.isMetallicWorkflow(),i._areTexturesDirty){i._needUVs=!1;for(let u=1;u<=6;++u)i["MAINUV"+u]=!1;if(o.texturesEnabled){i.ALBEDODIRECTUV=0,i.BASE_WEIGHTDIRECTUV=0,i.BASE_DIFFUSE_ROUGHNESSDIRECTUV=0,i.AMBIENTDIRECTUV=0,i.OPACITYDIRECTUV=0,i.EMISSIVEDIRECTUV=0,i.REFLECTIVITYDIRECTUV=0,i.MICROSURFACEMAPDIRECTUV=0,i.METALLIC_REFLECTANCEDIRECTUV=0,i.REFLECTANCEDIRECTUV=0,i.BUMPDIRECTUV=0,i.LIGHTMAPDIRECTUV=0,l.getCaps().textureLOD&&(i.LODBASEDMICROSFURACE=!0),this._albedoTexture&&K.DiffuseTextureEnabled?(Nt(this._albedoTexture,i,"ALBEDO"),i.GAMMAALBEDO=this._albedoTexture.gammaSpace):i.ALBEDO=!1,this._baseWeightTexture&&K.BaseWeightTextureEnabled?Nt(this._baseWeightTexture,i,"BASE_WEIGHT"):i.BASE_WEIGHT=!1,this._baseDiffuseRoughnessTexture&&K.BaseDiffuseRoughnessTextureEnabled?Nt(this._baseDiffuseRoughnessTexture,i,"BASE_DIFFUSE_ROUGHNESS"):i.BASE_DIFFUSE_ROUGHNESS=!1,this._ambientTexture&&K.AmbientTextureEnabled?(Nt(this._ambientTexture,i,"AMBIENT"),i.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale):i.AMBIENT=!1,this._opacityTexture&&K.OpacityTextureEnabled?(Nt(this._opacityTexture,i,"OPACITY"),i.OPACITYRGB=this._opacityTexture.getAlphaFromRGB):i.OPACITY=!1;const u=this._getReflectionTexture(),h=this._forceIrradianceInFragment||this.realTimeFiltering||this._twoSidedLighting||l.getCaps().maxVaryingVectors<=8||this._baseDiffuseRoughnessTexture!=null;km(o,u,i,this.realTimeFiltering,this.realTimeFilteringQuality,!h),this._lightmapTexture&&K.LightmapTextureEnabled?(Nt(this._lightmapTexture,i,"LIGHTMAP"),i.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,i.GAMMALIGHTMAP=this._lightmapTexture.gammaSpace,i.RGBDLIGHTMAP=this._lightmapTexture.isRGBD):i.LIGHTMAP=!1,this._emissiveTexture&&K.EmissiveTextureEnabled?(Nt(this._emissiveTexture,i,"EMISSIVE"),i.GAMMAEMISSIVE=this._emissiveTexture.gammaSpace):i.EMISSIVE=!1,K.SpecularTextureEnabled?(this._metallicTexture?(Nt(this._metallicTexture,i,"REFLECTIVITY"),i.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha,i.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen,i.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue,i.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed,i.REFLECTIVITY_GAMMA=!1):this._reflectivityTexture?(Nt(this._reflectivityTexture,i,"REFLECTIVITY"),i.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha,i.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap,i.REFLECTIVITY_GAMMA=this._reflectivityTexture.gammaSpace):i.REFLECTIVITY=!1,this._metallicReflectanceTexture||this._reflectanceTexture?(i.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=this._useOnlyMetallicFromMetallicReflectanceTexture,this._metallicReflectanceTexture?(Nt(this._metallicReflectanceTexture,i,"METALLIC_REFLECTANCE"),i.METALLIC_REFLECTANCE_GAMMA=this._metallicReflectanceTexture.gammaSpace):i.METALLIC_REFLECTANCE=!1,this._reflectanceTexture&&(!this._metallicReflectanceTexture||this._metallicReflectanceTexture&&this._useOnlyMetallicFromMetallicReflectanceTexture)?(Nt(this._reflectanceTexture,i,"REFLECTANCE"),i.REFLECTANCE_GAMMA=this._reflectanceTexture.gammaSpace):i.REFLECTANCE=!1):(i.METALLIC_REFLECTANCE=!1,i.REFLECTANCE=!1),this._microSurfaceTexture?Nt(this._microSurfaceTexture,i,"MICROSURFACEMAP"):i.MICROSURFACEMAP=!1):(i.REFLECTIVITY=!1,i.MICROSURFACEMAP=!1),l.getCaps().standardDerivatives&&this._bumpTexture&&K.BumpTextureEnabled&&!this._disableBumpMap?(Nt(this._bumpTexture,i,"BUMP"),this._useParallax&&this._albedoTexture&&K.DiffuseTextureEnabled?(i.PARALLAX=!0,i.PARALLAX_RHS=o.useRightHandedSystem,i.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):i.PARALLAX=!1,i.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):(i.BUMP=!1,i.PARALLAX=!1,i.PARALLAX_RHS=!1,i.PARALLAXOCCLUSION=!1,i.OBJECTSPACE_NORMALMAP=!1),this._environmentBRDFTexture&&K.ReflectionTextureEnabled?(i.ENVIRONMENTBRDF=!0,i.ENVIRONMENTBRDF_RGBD=this._environmentBRDFTexture.isRGBD):(i.ENVIRONMENTBRDF=!1,i.ENVIRONMENTBRDF_RGBD=!1),this._shouldUseAlphaFromAlbedoTexture()?i.ALPHAFROMALBEDO=!0:i.ALPHAFROMALBEDO=!1}i.SPECULAROVERALPHA=this._useSpecularOverAlpha,this._lightFalloff===Ve.LIGHTFALLOFF_STANDARD?(i.USEPHYSICALLIGHTFALLOFF=!1,i.USEGLTFLIGHTFALLOFF=!1):this._lightFalloff===Ve.LIGHTFALLOFF_GLTF?(i.USEPHYSICALLIGHTFALLOFF=!1,i.USEGLTFLIGHTFALLOFF=!0):(i.USEPHYSICALLIGHTFALLOFF=!0,i.USEGLTFLIGHTFALLOFF=!1),i.RADIANCEOVERALPHA=this._useRadianceOverAlpha,!this.backFaceCulling&&this._twoSidedLighting?i.TWOSIDEDLIGHTING=!0:i.TWOSIDEDLIGHTING=!1,i.MIRRORED=!!o._mirroredCameraPosition,i.SPECULARAA=l.getCaps().standardDerivatives&&this._enableSpecularAntiAliasing}(i._areTexturesDirty||i._areMiscDirty)&&(i.ALPHATESTVALUE=`${this._alphaCutOff}${this._alphaCutOff%1===0?".":""}`,i.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,i.ALPHABLEND=this.needAlphaBlendingForMesh(e),i.ALPHAFRESNEL=this._useAlphaFresnel||this._useLinearAlphaFresnel,i.LINEARALPHAFRESNEL=this._useLinearAlphaFresnel),i._areImageProcessingDirty&&this._imageProcessingConfiguration&&this._imageProcessingConfiguration.prepareDefines(i),i.FORCENORMALFORWARD=this._forceNormalForward,i.RADIANCEOCCLUSION=this._useRadianceOcclusion,i.HORIZONOCCLUSION=this._useHorizonOcclusion,i._areMiscDirty&&(Cu(e,o,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this.needAlphaTestingForMesh(e),i,this._applyDecalMapAfterDetailMap,this._useVertexPulling,t,this._setVertexOutputInvariant),i.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!e.isVerticesDataPresent(M.NormalKind),i.DEBUGMODE=this._debugMode),yu(o,l,this,i,!!r,n,a),this._eventInfo.defines=i,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),Iu(e,i,!0,!0,!0,this._transparencyMode!==Ve.PBRMATERIAL_OPAQUE),this._callbackPluginEventPrepareDefines(this._eventInfo)}forceCompilation(e,t,i){const r={clipPlane:!1,useInstances:!1,...i};this._uniformBufferLayoutBuilt||this.buildUniformLayout(),this._callbackPluginEventGeneric(4,this._eventInfo),(()=>{if(this._breakShaderLoadedCheck)return;const a=new Gv(this._eventInfo.defineNames),o=this._prepareEffect(e,e,a,void 0,void 0,r.useInstances,r.clipPlane);this._onEffectCreatedObservable&&(Ka.effect=o,Ka.subMesh=null,this._onEffectCreatedObservable.notifyObservers(Ka)),o.isReady()?t&&t(this):o.onCompileObservable.add(()=>{t&&t(this)})})()}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("vAlbedoInfos",2),e.addUniform("vBaseWeightInfos",2),e.addUniform("vBaseDiffuseRoughnessInfos",2),e.addUniform("vAmbientInfos",4),e.addUniform("vOpacityInfos",2),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vReflectivityInfos",3),e.addUniform("vMicroSurfaceSamplerInfos",2),e.addUniform("vBumpInfos",3),e.addUniform("albedoMatrix",16),e.addUniform("baseWeightMatrix",16),e.addUniform("baseDiffuseRoughnessMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("reflectivityMatrix",16),e.addUniform("microSurfaceSamplerMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("vAlbedoColor",4),e.addUniform("baseWeight",1),e.addUniform("baseDiffuseRoughness",1),e.addUniform("vLightingIntensity",4),e.addUniform("pointSize",1),e.addUniform("vReflectivityColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vAmbientColor",3),e.addUniform("vDebugMode",2),e.addUniform("vMetallicReflectanceFactors",4),e.addUniform("vMetallicReflectanceInfos",2),e.addUniform("metallicReflectanceMatrix",16),e.addUniform("vReflectanceInfos",2),e.addUniform("reflectanceMatrix",16),e.addUniform("cameraInfo",4),Hm(e,!0,!0,!0,!0,!0),super.buildUniformLayout()}bindForSubMesh(e,t,i){var d,f,m;const r=this.getScene(),n=i.materialDefines;if(!n)return;const a=i.effect;if(!a)return;this._activeEffect=a,t.getMeshUniformBuffer().bindToEffect(a,"Mesh"),t.transferToEffect(e);const o=r.getEngine();this._uniformBuffer.bindToEffect(a,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,r,t,e,this.isFrozen),Ei.Bind(o.currentRenderPassId,this._activeEffect,t,e,this);const l=r.activeCamera;l?this._uniformBuffer.updateFloat4("cameraInfo",l.minZ,l.maxZ,0,0):this._uniformBuffer.updateFloat4("cameraInfo",0,0,0,0),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),n.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const c=this._mustRebind(r,a,i,t.visibility);Bo(t,this._activeEffect,this.prePassConfiguration);let u=null;const h=this._uniformBuffer;if(c){if(this.bindViewProjection(a),u=this._getReflectionTexture(),!h.useUbo||!this.isFrozen||!h.isSync||i._drawWrapper._forceRebindOnNextCall){if(r.texturesEnabled&&(this._albedoTexture&&K.DiffuseTextureEnabled&&(h.updateFloat2("vAlbedoInfos",this._albedoTexture.coordinatesIndex,this._albedoTexture.level),Dt(this._albedoTexture,h,"albedo")),this._baseWeightTexture&&K.BaseWeightTextureEnabled&&(h.updateFloat2("vBaseWeightInfos",this._baseWeightTexture.coordinatesIndex,this._baseWeightTexture.level),Dt(this._baseWeightTexture,h,"baseWeight")),this._baseDiffuseRoughnessTexture&&K.BaseDiffuseRoughnessTextureEnabled&&(h.updateFloat2("vBaseDiffuseRoughnessInfos",this._baseDiffuseRoughnessTexture.coordinatesIndex,this._baseDiffuseRoughnessTexture.level),Dt(this._baseDiffuseRoughnessTexture,h,"baseDiffuseRoughness")),this._ambientTexture&&K.AmbientTextureEnabled&&(h.updateFloat4("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength,this._ambientTextureImpactOnAnalyticalLights),Dt(this._ambientTexture,h,"ambient")),this._opacityTexture&&K.OpacityTextureEnabled&&(h.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),Dt(this._opacityTexture,h,"opacity")),this._emissiveTexture&&K.EmissiveTextureEnabled&&(h.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),Dt(this._emissiveTexture,h,"emissive")),this._lightmapTexture&&K.LightmapTextureEnabled&&(h.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),Dt(this._lightmapTexture,h,"lightmap")),K.SpecularTextureEnabled&&(this._metallicTexture?(h.updateFloat3("vReflectivityInfos",this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength),Dt(this._metallicTexture,h,"reflectivity")):this._reflectivityTexture&&(h.updateFloat3("vReflectivityInfos",this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1),Dt(this._reflectivityTexture,h,"reflectivity")),this._metallicReflectanceTexture&&(h.updateFloat2("vMetallicReflectanceInfos",this._metallicReflectanceTexture.coordinatesIndex,this._metallicReflectanceTexture.level),Dt(this._metallicReflectanceTexture,h,"metallicReflectance")),this._reflectanceTexture&&n.REFLECTANCE&&(h.updateFloat2("vReflectanceInfos",this._reflectanceTexture.coordinatesIndex,this._reflectanceTexture.level),Dt(this._reflectanceTexture,h,"reflectance")),this._microSurfaceTexture&&(h.updateFloat2("vMicroSurfaceSamplerInfos",this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level),Dt(this._microSurfaceTexture,h,"microSurfaceSampler"))),this._bumpTexture&&o.getCaps().standardDerivatives&&K.BumpTextureEnabled&&!this._disableBumpMap&&(h.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias),Dt(this._bumpTexture,h,"bump"),r._mirroredCameraPosition?h.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):h.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),$m(r,n,h,this._reflectionColor,u,this.realTimeFiltering,!0,!0,!0,!0,!0)),this.pointsCloud&&h.updateFloat("pointSize",this.pointSize),n.METALLICWORKFLOW){st.Color4[0].r=this._metallic===void 0||this._metallic===null?1:this._metallic,st.Color4[0].g=this._roughness===void 0||this._roughness===null?1:this._roughness;const g=((d=this.subSurface)==null?void 0:d._indexOfRefraction)??1.5,v=1;st.Color4[0].b=g;const E=Math.pow((g-v)/(g+v),2);st.Color4[0].a=E,h.updateDirectColor4("vReflectivityColor",st.Color4[0]),h.updateColor4("vMetallicReflectanceFactors",this._metallicReflectanceColor,this._metallicF0Factor)}else h.updateColor4("vReflectivityColor",this._reflectivityColor,this._microSurface);h.updateColor3("vEmissiveColor",K.EmissiveTextureEnabled?this._emissiveColor:q.BlackReadOnly),!n.SS_REFRACTION&&((f=this.subSurface)!=null&&f._linkRefractionWithTransparency)?h.updateColor4("vAlbedoColor",this._albedoColor,1):h.updateColor4("vAlbedoColor",this._albedoColor,this.alpha),h.updateFloat("baseWeight",this._baseWeight),h.updateFloat("baseDiffuseRoughness",this._baseDiffuseRoughness||0),this._lightingInfos.x=this._directIntensity,this._lightingInfos.y=this._emissiveIntensity,this._lightingInfos.z=this._environmentIntensity*r.environmentIntensity,this._lightingInfos.w=this._specularIntensity,h.updateVector4("vLightingIntensity",this._lightingInfos),r.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor),h.updateColor3("vAmbientColor",this._globalAmbientColor),h.updateFloat2("vDebugMode",this.debugLimit,this.debugFactor)}r.texturesEnabled&&(this._albedoTexture&&K.DiffuseTextureEnabled&&h.setTexture("albedoSampler",this._albedoTexture),this._baseWeightTexture&&K.BaseWeightTextureEnabled&&h.setTexture("baseWeightSampler",this._baseWeightTexture),this._baseDiffuseRoughnessTexture&&K.BaseDiffuseRoughnessTextureEnabled&&h.setTexture("baseDiffuseRoughnessSampler",this._baseDiffuseRoughnessTexture),this._ambientTexture&&K.AmbientTextureEnabled&&h.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&K.OpacityTextureEnabled&&h.setTexture("opacitySampler",this._opacityTexture),Xm(r,n,h,u,this.realTimeFiltering),n.ENVIRONMENTBRDF&&h.setTexture("environmentBrdfSampler",this._environmentBRDFTexture),this._emissiveTexture&&K.EmissiveTextureEnabled&&h.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&K.LightmapTextureEnabled&&h.setTexture("lightmapSampler",this._lightmapTexture),K.SpecularTextureEnabled&&(this._metallicTexture?h.setTexture("reflectivitySampler",this._metallicTexture):this._reflectivityTexture&&h.setTexture("reflectivitySampler",this._reflectivityTexture),this._metallicReflectanceTexture&&h.setTexture("metallicReflectanceSampler",this._metallicReflectanceTexture),this._reflectanceTexture&&n.REFLECTANCE&&h.setTexture("reflectanceSampler",this._reflectanceTexture),this._microSurfaceTexture&&h.setTexture("microSurfaceSampler",this._microSurfaceTexture)),this._bumpTexture&&o.getCaps().standardDerivatives&&K.BumpTextureEnabled&&!this._disableBumpMap&&h.setTexture("bumpSampler",this._bumpTexture)),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(a),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),jn(this._activeEffect,this,r),this.bindEyePosition(a)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(c||!this.isFrozen)&&(r.lightsEnabled&&!this._disableLighting&&ql(r,t,this._activeEffect,n,this._maxSimultaneousLights),(r.fogEnabled&&t.applyFog&&r.fogMode!==le.FOGMODE_NONE||u||this.subSurface.refractionTexture||t.receiveShadows||n.PREPASS||n.CLUSTLIGHT_BATCH)&&this.bindView(a),Pu(r,t,this._activeEffect,!0),n.NUM_MORPH_INFLUENCERS&&Da(t,this._activeEffect),n.BAKED_VERTEX_ANIMATION_TEXTURE&&((m=t.bakedVertexAnimationManager)==null||m.bind(a,n.INSTANCES)),this._imageProcessingConfiguration.bind(this._activeEffect),Vo(n,this._activeEffect,r)),this._afterBind(t,this._activeEffect,i),h.update()}getAnimatables(){const e=super.getAnimatables();return this._albedoTexture&&this._albedoTexture.animations&&this._albedoTexture.animations.length>0&&e.push(this._albedoTexture),this._baseWeightTexture&&this._baseWeightTexture.animations&&this._baseWeightTexture.animations.length>0&&e.push(this._baseWeightTexture),this._baseDiffuseRoughnessTexture&&this._baseDiffuseRoughnessTexture.animations&&this._baseDiffuseRoughnessTexture.animations.length>0&&e.push(this._baseDiffuseRoughnessTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._metallicTexture&&this._metallicTexture.animations&&this._metallicTexture.animations.length>0?e.push(this._metallicTexture):this._reflectivityTexture&&this._reflectivityTexture.animations&&this._reflectivityTexture.animations.length>0&&e.push(this._reflectivityTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._metallicReflectanceTexture&&this._metallicReflectanceTexture.animations&&this._metallicReflectanceTexture.animations.length>0&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&this._reflectanceTexture.animations&&this._reflectanceTexture.animations.length>0&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&this._microSurfaceTexture.animations&&this._microSurfaceTexture.animations.length>0&&e.push(this._microSurfaceTexture),e}_getReflectionTexture(){return this._reflectionTexture?this._reflectionTexture:this.getScene().environmentTexture}getActiveTextures(){const e=super.getActiveTextures();return this._albedoTexture&&e.push(this._albedoTexture),this._baseWeightTexture&&e.push(this._baseWeightTexture),this._baseDiffuseRoughnessTexture&&e.push(this._baseDiffuseRoughnessTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._reflectivityTexture&&e.push(this._reflectivityTexture),this._metallicTexture&&e.push(this._metallicTexture),this._metallicReflectanceTexture&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&e.push(this._microSurfaceTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),e}hasTexture(e){return!!(super.hasTexture(e)||this._albedoTexture===e||this._baseWeightTexture===e||this._baseDiffuseRoughnessTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._reflectivityTexture===e||this._metallicTexture===e||this._metallicReflectanceTexture===e||this._reflectanceTexture===e||this._microSurfaceTexture===e||this._bumpTexture===e||this._lightmapTexture===e)}setPrePassRenderer(){var t;if(!((t=this.subSurface)!=null&&t.isScatteringEnabled))return!1;const e=this.getScene().enableSubSurfaceForPrePass();return e&&(e.enabled=!0),!0}dispose(e,t){var i,r,n,a,o,l,c,u,h,d,f,m,g,v;this._breakShaderLoadedCheck=!0,t&&(this._environmentBRDFTexture&&this.getScene().environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose(),(i=this._albedoTexture)==null||i.dispose(),(r=this._baseWeightTexture)==null||r.dispose(),(n=this._baseDiffuseRoughnessTexture)==null||n.dispose(),(a=this._ambientTexture)==null||a.dispose(),(o=this._opacityTexture)==null||o.dispose(),(l=this._reflectionTexture)==null||l.dispose(),(c=this._emissiveTexture)==null||c.dispose(),(u=this._metallicTexture)==null||u.dispose(),(h=this._reflectivityTexture)==null||h.dispose(),(d=this._bumpTexture)==null||d.dispose(),(f=this._lightmapTexture)==null||f.dispose(),(m=this._metallicReflectanceTexture)==null||m.dispose(),(g=this._reflectanceTexture)==null||g.dispose(),(v=this._microSurfaceTexture)==null||v.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}}Ve.PBRMATERIAL_OPAQUE=Le.MATERIAL_OPAQUE;Ve.PBRMATERIAL_ALPHATEST=Le.MATERIAL_ALPHATEST;Ve.PBRMATERIAL_ALPHABLEND=Le.MATERIAL_ALPHABLEND;Ve.PBRMATERIAL_ALPHATESTANDBLEND=Le.MATERIAL_ALPHATESTANDBLEND;Ve.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=0;Ve.LIGHTFALLOFF_PHYSICAL=0;Ve.LIGHTFALLOFF_GLTF=1;Ve.LIGHTFALLOFF_STANDARD=2;Ve.ForceGLSL=!1;_([W("_markAllSubMeshesAsMiscDirty")],Ve.prototype,"debugMode",void 0);class he extends Ve{get refractionTexture(){return this.subSurface.refractionTexture}set refractionTexture(e){this.subSurface.refractionTexture=e,e?this.subSurface.isRefractionEnabled=!0:this.subSurface.linkRefractionWithTransparency||(this.subSurface.isRefractionEnabled=!1)}get indexOfRefraction(){return this.subSurface.indexOfRefraction}set indexOfRefraction(e){this.subSurface.indexOfRefraction=e}get invertRefractionY(){return this.subSurface.invertRefractionY}set invertRefractionY(e){this.subSurface.invertRefractionY=e}get linkRefractionWithTransparency(){return this.subSurface.linkRefractionWithTransparency}set linkRefractionWithTransparency(e){this.subSurface.linkRefractionWithTransparency=e,e&&(this.subSurface.isRefractionEnabled=!0)}get usePhysicalLightFalloff(){return this._lightFalloff===Ve.LIGHTFALLOFF_PHYSICAL}set usePhysicalLightFalloff(e){e!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=Ve.LIGHTFALLOFF_PHYSICAL:this._lightFalloff=Ve.LIGHTFALLOFF_STANDARD)}get useGLTFLightFalloff(){return this._lightFalloff===Ve.LIGHTFALLOFF_GLTF}set useGLTFLightFalloff(e){e!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=Ve.LIGHTFALLOFF_GLTF:this._lightFalloff=Ve.LIGHTFALLOFF_STANDARD)}constructor(e,t,i=!1){super(e,t,i),this.directIntensity=1,this.emissiveIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.disableBumpMap=!1,this.ambientTextureStrength=1,this.ambientTextureImpactOnAnalyticalLights=he.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this.metallicF0Factor=1,this.metallicReflectanceColor=q.White(),this.useOnlyMetallicFromMetallicReflectanceTexture=!1,this.ambientColor=new q(0,0,0),this.albedoColor=new q(1,1,1),this.baseWeight=1,this.reflectivityColor=new q(1,1,1),this.reflectionColor=new q(1,1,1),this.emissiveColor=new q(0,0,0),this.microSurface=1,this.useLightmapAsShadowmap=!1,this.useAlphaFromAlbedoTexture=!1,this.forceAlphaTest=!1,this.alphaCutOff=.4,this.useSpecularOverAlpha=!0,this.useMicroSurfaceFromReflectivityMapAlpha=!1,this.useRoughnessFromMetallicTextureAlpha=!0,this.useRoughnessFromMetallicTextureGreen=!1,this.useMetallnessFromMetallicTextureBlue=!1,this.useAmbientOcclusionFromMetallicTextureRed=!1,this.useAmbientInGrayScale=!1,this.useAutoMicroSurfaceFromReflectivityMap=!1,this.useRadianceOverAlpha=!0,this.useObjectSpaceNormalMap=!1,this.useParallax=!1,this.useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this.disableLighting=!1,this.forceIrradianceInFragment=!1,this.maxSimultaneousLights=4,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.twoSidedLighting=!1,this.useAlphaFresnel=!1,this.useLinearAlphaFresnel=!1,this.environmentBRDFTexture=null,this.forceNormalForward=!1,this.enableSpecularAntiAliasing=!1,this.useHorizonOcclusion=!0,this.useRadianceOcclusion=!0,this.unlit=!1,this.applyDecalMapAfterDetailMap=!1,this._environmentBRDFTexture=gh(this.getScene())}getClassName(){return"PBRMaterial"}clone(e,t=!0,i=""){const r=me.Clone(()=>new he(e,this.getScene()),this,{cloneTexturesOnlyOnce:t});return r.id=e,r.name=e,this.stencil.copyTo(r.stencil),this._clonePlugins(r,i),r}serialize(){const e=super.serialize();return e.customType="BABYLON.PBRMaterial",e}static Parse(e,t,i){const r=me.Parse(()=>new he(e.name,t),e,t,i);return e.stencil&&r.stencil.parse(e.stencil,t,i),Le._ParsePlugins(e,r,t,i),e.clearCoat&&r.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&r.anisotropy.parse(e.anisotropy,t,i),e.brdf&&r.brdf.parse(e.brdf,t,i),e.sheen&&r.sheen.parse(e.sheen,t,i),e.subSurface&&r.subSurface.parse(e.subSurface,t,i),e.iridescence&&r.iridescence.parse(e.iridescence,t,i),r}}he.PBRMATERIAL_OPAQUE=Ve.PBRMATERIAL_OPAQUE;he.PBRMATERIAL_ALPHATEST=Ve.PBRMATERIAL_ALPHATEST;he.PBRMATERIAL_ALPHABLEND=Ve.PBRMATERIAL_ALPHABLEND;he.PBRMATERIAL_ALPHATESTANDBLEND=Ve.PBRMATERIAL_ALPHATESTANDBLEND;he.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=Ve.DEFAULT_AO_ON_ANALYTICAL_LIGHTS;_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"directIntensity",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"emissiveIntensity",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"environmentIntensity",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"specularIntensity",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"disableBumpMap",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"albedoTexture",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"baseWeightTexture",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"baseDiffuseRoughnessTexture",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"ambientTexture",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"ambientTextureStrength",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"ambientTextureImpactOnAnalyticalLights",void 0);_([We(),W("_markAllSubMeshesAsTexturesAndMiscDirty")],he.prototype,"opacityTexture",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"reflectionTexture",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"emissiveTexture",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"reflectivityTexture",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"metallicTexture",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"metallic",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"roughness",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"metallicF0Factor",void 0);_([Xt(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"metallicReflectanceColor",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"useOnlyMetallicFromMetallicReflectanceTexture",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"metallicReflectanceTexture",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"reflectanceTexture",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"microSurfaceTexture",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"bumpTexture",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty",null)],he.prototype,"lightmapTexture",void 0);_([Xt("ambient"),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"ambientColor",void 0);_([Xt("albedo"),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"albedoColor",void 0);_([R("baseWeight"),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"baseWeight",void 0);_([R("baseDiffuseRoughness"),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"baseDiffuseRoughness",void 0);_([Xt("reflectivity"),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"reflectivityColor",void 0);_([Xt("reflection"),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"reflectionColor",void 0);_([Xt("emissive"),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"emissiveColor",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"microSurface",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"useLightmapAsShadowmap",void 0);_([R(),W("_markAllSubMeshesAsTexturesAndMiscDirty")],he.prototype,"useAlphaFromAlbedoTexture",void 0);_([R(),W("_markAllSubMeshesAsTexturesAndMiscDirty")],he.prototype,"forceAlphaTest",void 0);_([R(),W("_markAllSubMeshesAsTexturesAndMiscDirty")],he.prototype,"alphaCutOff",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"useSpecularOverAlpha",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"useRoughnessFromMetallicTextureAlpha",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"useRoughnessFromMetallicTextureGreen",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"useMetallnessFromMetallicTextureBlue",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"useAmbientInGrayScale",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0);_([R()],he.prototype,"usePhysicalLightFalloff",null);_([R()],he.prototype,"useGLTFLightFalloff",null);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"useRadianceOverAlpha",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"useObjectSpaceNormalMap",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"useParallax",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"useParallaxOcclusion",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"parallaxScaleBias",void 0);_([R(),W("_markAllSubMeshesAsLightsDirty")],he.prototype,"disableLighting",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"forceIrradianceInFragment",void 0);_([R(),W("_markAllSubMeshesAsLightsDirty")],he.prototype,"maxSimultaneousLights",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"invertNormalMapX",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"invertNormalMapY",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"twoSidedLighting",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"useAlphaFresnel",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"useLinearAlphaFresnel",void 0);_([W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"environmentBRDFTexture",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"forceNormalForward",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"enableSpecularAntiAliasing",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"useHorizonOcclusion",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],he.prototype,"useRadianceOcclusion",void 0);_([R(),W("_markAllSubMeshesAsMiscDirty")],he.prototype,"unlit",void 0);_([R(),W("_markAllSubMeshesAsMiscDirty")],he.prototype,"applyDecalMapAfterDetailMap",void 0);y("BABYLON.PBRMaterial",he);class wl extends xr{constructor(e,t,i){super(e,x.Zero(),t),this._xrSessionManager=i,this._firstFrame=!1,this._referenceQuaternion=Z.Identity(),this._referencedPosition=new x,this._trackingState=0,this.onXRCameraInitializedObservable=new k,this.onBeforeCameraTeleport=new k,this.onAfterCameraTeleport=new k,this.onTrackingStateChanged=new k,this.compensateOnFirstFrame=!0,this.minZ=.1,this.rotationQuaternion=new Z,this.cameraRigMode=dt.RIG_MODE_CUSTOM,this.updateUpVectorFromRotation=!0,this._updateNumberOfRigCameras(1),this.freezeProjectionMatrix(),this._deferOnly=!0,this._xrSessionManager.onXRSessionInit.add(()=>{this._referencedPosition.copyFromFloats(0,0,0),this._referenceQuaternion.copyFromFloats(0,0,0,1),this._firstFrame=this.compensateOnFirstFrame,this._xrSessionManager.onWorldScaleFactorChangedObservable.add(()=>{this._xrSessionManager.currentFrame&&this._updateDepthNearFar()})}),this._xrSessionManager.onXRFrameObservable.add(()=>{this._firstFrame&&this._updateFromXRSession(),this.onXRCameraInitializedObservable.hasObservers()&&(this.onXRCameraInitializedObservable.notifyObservers(this),this.onXRCameraInitializedObservable.clear()),this._deferredUpdated&&(this.position.copyFrom(this._deferredPositionUpdate),this.rotationQuaternion.copyFrom(this._deferredRotationQuaternionUpdate)),this._updateReferenceSpace(),this._updateFromXRSession()},void 0,!0)}get trackingState(){return this._trackingState}_setTrackingState(e){this._trackingState!==e&&(this._trackingState=e,this.onTrackingStateChanged.notifyObservers(e))}get realWorldHeight(){const e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.baseReferenceSpace);return e&&e.transform?e.transform.position.y*this._xrSessionManager.worldScalingFactor:0}_updateForDualEyeDebugging(){this._updateNumberOfRigCameras(2),this.rigCameras[0].viewport=new Hn(0,0,.5,1),this.rigCameras[0].outputRenderTarget=null,this.rigCameras[1].viewport=new Hn(.5,0,.5,1),this.rigCameras[1].outputRenderTarget=null}setTransformationFromNonVRCamera(e=this.getScene().activeCamera,t=!0){if(!e||e===this)return;e.computeWorldMatrix().decompose(void 0,this.rotationQuaternion,this.position),this.position.y=0,Z.FromEulerAnglesToRef(0,this.rotationQuaternion.toEulerAngles().y,0,this.rotationQuaternion),this._firstFrame=!0,t&&this._xrSessionManager.resetReferenceSpace()}getClassName(){return"WebXRCamera"}setTarget(e){const t=G.Vector3[1];e.subtractToRef(this.position,t),t.y=0,t.normalize();const i=Math.atan2(t.x,t.z)+(this._scene.useRightHandedSystem?Math.PI:0);this.rotationQuaternion.toEulerAnglesToRef(t),Z.FromEulerAnglesToRef(t.x,i,t.z,this.rotationQuaternion)}dispose(){super.dispose(),this._lastXRViewerPose=void 0,this.onTrackingStateChanged.clear()}_updateDepthNearFar(){const e=(this.maxZ||1e4)*this._xrSessionManager.worldScalingFactor,t={depthFar:e,depthNear:this.minZ};this._xrSessionManager.updateRenderState(t),this._cache.minZ=this.minZ,this._cache.maxZ=e}_updateFromXRSession(){var i;const e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.referenceSpace);if(this._lastXRViewerPose=e||void 0,!e){this._setTrackingState(0);return}const t=e.emulatedPosition?1:2;if(this._setTrackingState(t),(this.minZ!==this._cache.minZ||this.maxZ!==this._cache.maxZ)&&this._updateDepthNearFar(),e.transform){const r=e.transform.orientation;if(e.transform.orientation.x===void 0)return;const n=e.transform.position;this._referencedPosition.set(n.x,n.y,n.z).scaleInPlace(this._xrSessionManager.worldScalingFactor),this._referenceQuaternion.set(r.x,r.y,r.z,r.w),this._scene.useRightHandedSystem||(this._referencedPosition.z*=-1,this._referenceQuaternion.z*=-1,this._referenceQuaternion.w*=-1),this._firstFrame?(this._firstFrame=!1,this.position.y+=this._referencedPosition.y,this._referenceQuaternion.copyFromFloats(0,0,0,1)):(this.rotationQuaternion.copyFrom(this._referenceQuaternion),this.position.copyFrom(this._referencedPosition))}this.rigCameras.length!==e.views.length&&this._updateNumberOfRigCameras(e.views.length);for(let r=0;r<e.views.length;r++){const n=e.views[r],a=this.rigCameras[r];!a.isLeftCamera&&!a.isRightCamera&&(n.eye==="right"?a._isRightCamera=!0:n.eye==="left"&&(a._isLeftCamera=!0));const o=this.getScene().customRenderTargets;for(let d=0;d<o.length;d++){const f=o[d];a.customRenderTargets.indexOf(f)===-1&&a.customRenderTargets.push(f)}const l=n.transform.position,c=n.transform.orientation;a.parent=this.parent,a.position.set(l.x,l.y,l.z).scaleInPlace(this._xrSessionManager.worldScalingFactor),a.rotationQuaternion.set(c.x,c.y,c.z,c.w),this._scene.useRightHandedSystem||(a.position.z*=-1,a.rotationQuaternion.z*=-1,a.rotationQuaternion.w*=-1),z.FromFloat32ArrayToRefScaled(n.projectionMatrix,0,1,a._projectionMatrix),this._scene.useRightHandedSystem||a._projectionMatrix.toggleProjectionMatrixHandInPlace();const u=Math.atan2(1,n.projectionMatrix[5])*2;a.fov=u,r===0&&(this.fov=u,this._projectionMatrix.copyFrom(a._projectionMatrix));const h=this._xrSessionManager.getRenderTargetTextureForView(n);this._renderingMultiview=((i=h==null?void 0:h._texture)==null?void 0:i.isMultiview)||!1,this._renderingMultiview?r==0&&(this._xrSessionManager.trySetViewportForView(this.viewport,n),this.outputRenderTarget=h):(this._xrSessionManager.trySetViewportForView(a.viewport,n),a.outputRenderTarget=h||this._xrSessionManager.getRenderTargetTextureForView(n)),a.layerMask=this.layerMask}}_updateNumberOfRigCameras(e=1){for(;this.rigCameras.length<e;){const t=new Lo("XR-RigCamera: "+this.rigCameras.length,x.Zero(),this.getScene());t.minZ=.1,t.rotationQuaternion=new Z,t.updateUpVectorFromRotation=!0,t.isRigCamera=!0,t.rigParent=this,t.freezeProjectionMatrix(),this.rigCameras.push(t)}for(;this.rigCameras.length>e;){const t=this.rigCameras.pop();t&&t.dispose()}}_updateReferenceSpace(){if(!this.position.equals(this._referencedPosition)||!this.rotationQuaternion.equals(this._referenceQuaternion)){const e=G.Matrix[0],t=G.Matrix[1],i=G.Matrix[2];z.ComposeToRef(wl._ScaleReadOnly,this._referenceQuaternion,this._referencedPosition,e),z.ComposeToRef(wl._ScaleReadOnly,this.rotationQuaternion,this.position,t),e.invert().multiplyToRef(t,i),i.invert(),this._scene.useRightHandedSystem||i.toggleModelMatrixHandInPlace(),i.decompose(void 0,this._referenceQuaternion,this._referencedPosition);const r=new XRRigidTransform({x:this._referencedPosition.x/this._xrSessionManager.worldScalingFactor,y:this._referencedPosition.y/this._xrSessionManager.worldScalingFactor,z:this._referencedPosition.z/this._xrSessionManager.worldScalingFactor,w:1},{x:this._referenceQuaternion.x,y:this._referenceQuaternion.y,z:this._referenceQuaternion.z,w:this._referenceQuaternion.w});this._xrSessionManager.referenceSpace=this._xrSessionManager.referenceSpace.getOffsetReferenceSpace(r)}}}wl._ScaleReadOnly=x.One();class R_{constructor(e){this._scene=e,this._nonVRCamera=null,this._attachedToElement=!1,this._spectatorCamera=null,this._originalSceneAutoClear=!0,this._supported=!1,this._spectatorMode=!1,this._lastTimestamp=0,this.onInitialXRPoseSetObservable=new k,this.onStateChangedObservable=new k,this.state=3,this.sessionManager=new Ku(e),this.camera=new wl("webxr",e,this.sessionManager),this.featuresManager=new At(this.sessionManager),e.onDisposeObservable.addOnce(()=>{this.dispose()})}static async CreateAsync(e){const t=new R_(e);return await t.sessionManager.initializeAsync().then(()=>(t._supported=!0,t)).catch(i=>{throw t._setState(3),t.dispose(),i})}dispose(){var e;this.exitXRAsync(),this.camera.dispose(),this.onStateChangedObservable.clear(),this.onInitialXRPoseSetObservable.clear(),this.sessionManager.dispose(),(e=this._spectatorCamera)==null||e.dispose(),this._nonVRCamera&&(this._scene.activeCamera=this._nonVRCamera)}async enterXRAsync(e,t,i=this.sessionManager.getWebXRRenderTarget(),r={}){var n,a,o,l;if(!this._supported)throw"WebXR not supported in this browser or environment";this._setState(0),t!=="viewer"&&t!=="local"&&(r.optionalFeatures=r.optionalFeatures||[],r.optionalFeatures.push(t)),r=await this.featuresManager._extendXRSessionInitObject(r),e==="immersive-ar"&&t!=="unbounded"&&N.Warn("We recommend using 'unbounded' reference space type when using 'immersive-ar' session mode");try{await this.sessionManager.initializeSessionAsync(e,r),await this.sessionManager.setReferenceSpaceTypeAsync(t);const c={depthFar:this.camera.maxZ||1e4,depthNear:this.camera.minZ};if(!this.featuresManager.getEnabledFeature(Ne.LAYERS)){const u=await i.initializeXRLayerAsync(this.sessionManager.session);c.baseLayer=u}return this.sessionManager.updateRenderState(c),this.sessionManager.runXRRenderLoop(),this._originalSceneAutoClear=this._scene.autoClear,this._nonVRCamera=this._scene.activeCamera,this._attachedToElement=!!((a=(n=this._nonVRCamera)==null?void 0:n.inputs)!=null&&a.attachedToElement),(o=this._nonVRCamera)==null||o.detachControl(),this._scene.activeCamera=this.camera,e!=="immersive-ar"?this._nonXRToXRCamera():(this._scene.autoClear=!1,this.camera.compensateOnFirstFrame=!1,this.camera.position.set(0,0,0),this.camera.rotationQuaternion.set(0,0,0,1),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)),(l=te.audioEngine)==null||l._resumeAudioContextOnStateChange(),this.sessionManager.onXRSessionEnded.addOnce(()=>{this.state!==1&&this._setState(1);for(const u of this.camera.rigCameras)u.outputRenderTarget=null;this._scene.autoClear=this._originalSceneAutoClear,this._scene.activeCamera=this._nonVRCamera,this._attachedToElement&&this._nonVRCamera&&this._nonVRCamera.attachControl(!!this._nonVRCamera.inputs.noPreventDefault),e!=="immersive-ar"&&this.camera.compensateOnFirstFrame&&(this._nonVRCamera.setPosition?this._nonVRCamera.setPosition(this.camera.position):this._nonVRCamera.position.copyFrom(this.camera.position)),this._setState(3)}),this.sessionManager.onXRFrameObservable.addOnce(()=>{this._setState(2)}),this.sessionManager}catch(c){throw N.Log(c),N.Log(c.message),this._setState(3),c}}async exitXRAsync(){if(this.state===2)return this._setState(1),await this.sessionManager.exitXRAsync()}enableSpectatorMode(e){this._spectatorMode||(this._spectatorMode=!0,this._switchSpectatorMode(e))}disableSpecatatorMode(){this._spectatorMode&&(this._spectatorMode=!1,this._switchSpectatorMode())}_switchSpectatorMode(e){const i=1/(e!=null&&e.fps?e.fps:1e3)*1e3,r=e!=null&&e.preferredCameraIndex?e==null?void 0:e.preferredCameraIndex:0,n=()=>{this._spectatorCamera&&this.sessionManager.currentTimestamp-this._lastTimestamp>=i&&(this._lastTimestamp=this.sessionManager.currentTimestamp,this._spectatorCamera.position.copyFrom(this.camera.rigCameras[r].globalPosition),this._spectatorCamera.rotationQuaternion.copyFrom(this.camera.rigCameras[r].absoluteRotation))};if(this._spectatorMode){if(r>=this.camera.rigCameras.length)throw new Error("the preferred camera index is beyond the length of rig camera array.");const a=()=>{this.state===2?(this._spectatorCamera=new zo("webxr-spectator",x.Zero(),this._scene),this._spectatorCamera.rotationQuaternion=new Z,this._scene.activeCameras=[this.camera,this._spectatorCamera],this.sessionManager.onXRFrameObservable.add(n),this._scene.onAfterRenderCameraObservable.add(o=>{o===this.camera&&(this._scene.getEngine().framebufferDimensionsObject=null)})):this.state===1&&(this.sessionManager.onXRFrameObservable.removeCallback(n),this._scene.activeCameras=null)};this.onStateChangedObservable.add(a),a()}else this.sessionManager.onXRFrameObservable.removeCallback(n),this._scene.activeCameras=[this.camera]}_nonXRToXRCamera(){this.camera.setTransformationFromNonVRCamera(this._nonVRCamera),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)}_setState(e){this.state!==e&&(this.state=e,this.onStateChangedObservable.notifyObservers(this.state))}}class vr{constructor(e,t,i=-1,r=[]){this.id=e,this.type=t,this._buttonIndex=i,this._axesIndices=r,this._axes={x:0,y:0},this._changes={},this._currentValue=0,this._hasChanges=!1,this._pressed=!1,this._touched=!1,this.onAxisValueChangedObservable=new k,this.onButtonStateChangedObservable=new k}get axes(){return this._axes}get changes(){return this._changes}get hasChanges(){return this._hasChanges}get pressed(){return this._pressed}get touched(){return this._touched}get value(){return this._currentValue}dispose(){this.onAxisValueChangedObservable.clear(),this.onButtonStateChangedObservable.clear()}isAxes(){return this._axesIndices.length!==0}isButton(){return this._buttonIndex!==-1}update(e){let t=!1,i=!1;if(this._hasChanges=!1,this._changes={},this.isButton()){const r=e.buttons[this._buttonIndex];if(!r)return;this._currentValue!==r.value&&(this.changes.value={current:r.value,previous:this._currentValue},t=!0,this._currentValue=r.value),this._touched!==r.touched&&(this.changes.touched={current:r.touched,previous:this._touched},t=!0,this._touched=r.touched),this._pressed!==r.pressed&&(this.changes.pressed={current:r.pressed,previous:this._pressed},t=!0,this._pressed=r.pressed)}this.isAxes()&&(this._axes.x!==e.axes[this._axesIndices[0]]&&(this.changes.axes={current:{x:e.axes[this._axesIndices[0]],y:this._axes.y},previous:{x:this._axes.x,y:this._axes.y}},this._axes.x=e.axes[this._axesIndices[0]],i=!0),this._axes.y!==e.axes[this._axesIndices[1]]&&(this.changes.axes?this.changes.axes.current.y=e.axes[this._axesIndices[1]]:this.changes.axes={current:{x:this._axes.x,y:e.axes[this._axesIndices[1]]},previous:{x:this._axes.x,y:this._axes.y}},this._axes.y=e.axes[this._axesIndices[1]],i=!0)),t&&(this._hasChanges=!0,this.onButtonStateChangedObservable.notifyObservers(this)),i&&(this._hasChanges=!0,this.onAxisValueChangedObservable.notifyObservers(this._axes))}}vr.BUTTON_TYPE="button";vr.SQUEEZE_TYPE="squeeze";vr.THUMBSTICK_TYPE="thumbstick";vr.TOUCHPAD_TYPE="touchpad";vr.TRIGGER_TYPE="trigger";class Ua{constructor(e,t,i,r,n=!1,a){if(this.scene=e,this.layout=t,this.gamepadObject=i,this.handedness=r,this._doNotLoadControllerMesh=n,this._controllerCache=a,this._initComponent=o=>{if(!o)return;const l=this.layout.components[o],c=l.type,u=l.gamepadIndices.button,h=[];l.gamepadIndices.xAxis!==void 0&&l.gamepadIndices.yAxis!==void 0&&h.push(l.gamepadIndices.xAxis,l.gamepadIndices.yAxis),this.components[o]=new vr(o,c,u,h)},this._modelReady=!1,this.components={},this.disableAnimation=!1,this.onModelLoadedObservable=new k,t.components){const o=Object.keys(t.components);for(const l of o)this._initComponent(l)}}dispose(){const e=this.getComponentIds();for(const t of e)this.getComponent(t).dispose();if(this.rootMesh){const t=this.rootMesh.getChildren(void 0,!0);for(const i of t)i.setEnabled(!1);this.rootMesh.dispose(!!this._controllerCache,!this._controllerCache)}this.onModelLoadedObservable.clear()}getAllComponentsOfType(e){return this.getComponentIds().map(t=>this.components[t]).filter(t=>t.type===e)}getComponent(e){return this.components[e]}getComponentIds(){return Object.keys(this.components)}getComponentOfType(e){return this.getAllComponentsOfType(e)[0]||null}getMainComponent(){return this.getComponent(this.layout.selectComponentId)}async loadModel(){const e=!this._getModelLoadingConstraints();let t=this._getGenericFilenameAndPath();return e?N.Warn("Falling back to generic models"):t=this._getFilenameAndPath(),await new Promise((i,r)=>{const n=a=>{e?this._getGenericParentMesh(a):this._setRootMesh(a),this._processLoadedModel(a),this._modelReady=!0,this.onModelLoadedObservable.notifyObservers(this),i(!0)};if(this._controllerCache){const a=this._controllerCache.filter(o=>o.filename===t.filename&&o.path===t.path);if(a[0]){for(const o of a[0].meshes)o.setEnabled(!0);n(a[0].meshes);return}}Nl.ImportMesh("",t.path,t.filename,this.scene,a=>{this._controllerCache&&this._controllerCache.push({...t,meshes:a}),n(a)},null,(a,o)=>{N.Log(o),N.Warn(`Failed to retrieve controller model of type ${this.profileId} from the remote server: ${t.path}${t.filename}`),r(o)})})}updateFromXRFrame(e){for(const t of this.getComponentIds())this.getComponent(t).update(this.gamepadObject);this.updateModel(e)}get handness(){return this.handedness}async pulse(e,t,i=0){return this.gamepadObject.hapticActuators&&this.gamepadObject.hapticActuators[i]?await this.gamepadObject.hapticActuators[i].pulse(e,t):!1}_getChildByName(e,t){return e.getChildren(i=>i.name===t,!1)[0]}_getImmediateChildByName(e,t){return e.getChildren(i=>i.name==t,!0)[0]}_lerpTransform(e,t,i){if(!e.minMesh||!e.maxMesh||!e.valueMesh||!e.minMesh.rotationQuaternion||!e.maxMesh.rotationQuaternion||!e.valueMesh.rotationQuaternion)return;const r=i?t*.5+.5:t;Z.SlerpToRef(e.minMesh.rotationQuaternion,e.maxMesh.rotationQuaternion,r,e.valueMesh.rotationQuaternion),x.LerpToRef(e.minMesh.position,e.maxMesh.position,r,e.valueMesh.position)}updateModel(e){this._modelReady&&this._updateModel(e)}_getGenericFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getGenericParentMesh(e){this.rootMesh=new Oe(this.profileId+" "+this.handedness,this.scene);for(const t of e)t.parent||(t.isPickable=!1,t.setParent(this.rootMesh));this.rootMesh.rotationQuaternion=Z.FromEulerAngles(0,Math.PI,0)}}class Bl extends Ua{constructor(e,t,i){super(e,NV[i],t,i),this.profileId=Bl.ProfileId}_getFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){}_setRootMesh(e){this.rootMesh=new Oe(this.profileId+" "+this.handedness,this.scene);for(const t of e)t.isPickable=!1,t.parent||t.setParent(this.rootMesh);this.rootMesh.rotationQuaternion=Z.FromEulerAngles(0,Math.PI,0)}_updateModel(){}}Bl.ProfileId="generic-trigger";const NV={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-none",assetPath:"none.glb"}};class DV extends Ua{constructor(e,t,i,r,n){super(e,i.layouts[t.handedness||"none"],t.gamepad,t.handedness,void 0,n),this._repositoryUrl=r,this.controllerCache=n,this._buttonMeshMapping={},this._touchDots={},this.profileId=i.profileId}dispose(){if(super.dispose(),!this.controllerCache){const e=Object.keys(this._touchDots);for(const t of e)this._touchDots[t].dispose()}}_getFilenameAndPath(){return{filename:this.layout.assetPath,path:`${this._repositoryUrl}/profiles/${this.profileId}/`}}_getModelLoadingConstraints(){const e=Nl.IsPluginForExtensionAvailable(".glb");return e||N.Warn("glTF / glb loader was not registered, using generic controller instead"),e}_processLoadedModel(e){const t=this.getComponentIds();for(const i of t){const r=this.layout.components[i];this._buttonMeshMapping[i]={mainMesh:this._getChildByName(this.rootMesh,r.rootNodeName),states:{}};const n=Object.keys(r.visualResponses);for(const a of n){const o=r.visualResponses[a];if(o.valueNodeProperty==="transform")this._buttonMeshMapping[i].states[a]={valueMesh:this._getChildByName(this.rootMesh,o.valueNodeName),minMesh:this._getChildByName(this.rootMesh,o.minNodeName),maxMesh:this._getChildByName(this.rootMesh,o.maxNodeName)};else{const l=r.type===vr.TOUCHPAD_TYPE&&r.touchPointNodeName?r.touchPointNodeName:o.valueNodeName;if(this._buttonMeshMapping[i].states[a]={valueMesh:this._getChildByName(this.rootMesh,l)},r.type===vr.TOUCHPAD_TYPE&&!this._touchDots[a]){const c=Sn(a+"dot",{diameter:.0015,segments:8},this.scene);c.material=new Lr(a+"mat",this.scene),c.material.diffuseColor=q.Red(),c.parent=this._buttonMeshMapping[i].states[a].valueMesh||null,c.isVisible=!1,this._touchDots[a]=c}}}}}_setRootMesh(e){this.rootMesh=new Oe(this.profileId+"-"+this.handedness,this.scene),this.rootMesh.isPickable=!1;let t;for(let i=0;i<e.length;i++){const r=e[i];r.isPickable=!1,r.parent||(t=r)}t&&t.setParent(this.rootMesh),this.scene.useRightHandedSystem||this.rootMesh.rotate(Ms.Y,Math.PI,1)}_updateModel(e){if(this.disableAnimation)return;const t=this.getComponentIds();for(const i of t){const r=this.getComponent(i);if(!r.hasChanges)continue;const n=this._buttonMeshMapping[i],a=this.layout.components[i],o=Object.keys(a.visualResponses);for(const l of o){const c=a.visualResponses[l];let u=r.value;if(c.componentProperty==="xAxis"?u=r.axes.x:c.componentProperty==="yAxis"&&(u=r.axes.y),c.valueNodeProperty==="transform")this._lerpTransform(n.states[l],u,c.componentProperty!=="button");else{const h=n.states[l].valueMesh;h&&(h.isVisible=r.touched||r.pressed),this._touchDots[l]&&(this._touchDots[l].isVisible=r.touched||r.pressed)}}}}}const Jh=[];class ti{static ClearProfilesCache(){this._ProfilesList=null,this._ProfileLoadingPromises={}}static DefaultFallbacks(){this.RegisterFallbacksForProfileId("google-daydream",["generic-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive-focus",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("magicleap-one",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("windows-mixed-reality",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("microsoft-mixed-reality",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-go",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("oculus-touch-v2",["oculus-touch","generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-touch",["generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-gearvr",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-odyssey",["generic-touchpad"]),this.RegisterFallbacksForProfileId("valve-index",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("generic-hand-select",["generic-trigger"]),this.RegisterFallbacksForProfileId("oculus-hand",["generic-trigger"])}static FindFallbackWithProfileId(e){const t=this._Fallbacks[e]||[];return t.unshift(e),t}static async GetMotionControllerWithXRInput(e,t,i){const r=[];if(i&&r.push(i),r.push(...e.profiles||[]),r.length&&!r[0]&&r.pop(),e.gamepad&&e.gamepad.id)switch(e.gamepad.id){case(e.gamepad.id.match(/oculus touch/gi)?e.gamepad.id:void 0):r.push("oculus-touch-v2");break}const n=r.indexOf("windows-mixed-reality");if(n!==-1&&r.splice(n,0,"microsoft-mixed-reality"),r.length||r.push("generic-trigger"),this.UseOnlineRepository){const a=this.PrioritizeOnlineRepository?this._LoadProfileFromRepositoryAsync:this._LoadProfilesFromAvailableControllersAsync,o=this.PrioritizeOnlineRepository?this._LoadProfilesFromAvailableControllersAsync:this._LoadProfileFromRepositoryAsync;return a.call(this,r,e,t).catch(()=>o.call(this,r,e,t))}else return await this._LoadProfilesFromAvailableControllersAsync(r,e,t)}static RegisterController(e,t){this._AvailableControllers[e]=t}static RegisterFallbacksForProfileId(e,t){this._Fallbacks[e]?this._Fallbacks[e].push(...t):this._Fallbacks[e]=t}static async UpdateProfilesList(){const e=await j.LoadFileAsync(this.BaseRepositoryUrl+"/profiles/profilesList.json",!1);return this._ProfilesList=JSON.parse(e),await this._ProfilesList}static ClearControllerCache(){for(const e of Jh)for(const t of e.meshes)t.dispose(!1,!0);Jh.length=0}static async _LoadProfileFromRepositoryAsync(e,t,i){return await Promise.resolve().then(async()=>this._ProfilesList?await this._ProfilesList:await this.UpdateProfilesList()).then(r=>{for(let n=0;n<e.length;++n)if(e[n]&&r[e[n]])return e[n];throw new Error(`neither controller ${e[0]} nor all fallbacks were found in the repository,`)}).then(async r=>(this._ProfileLoadingPromises[r]||(this._ProfileLoadingPromises[r]=j.LoadFileAsync(`${this.BaseRepositoryUrl}/profiles/${r}/profile.json`,!1).then(n=>JSON.parse(n))),await this._ProfileLoadingPromises[r])).then(r=>new DV(i,t,r,this.BaseRepositoryUrl,this.DisableControllerCache?void 0:Jh))}static async _LoadProfilesFromAvailableControllersAsync(e,t,i){for(let r=0;r<e.length;++r){if(!e[r])continue;const n=this.FindFallbackWithProfileId(e[r]);for(let a=0;a<n.length;++a){const o=this._AvailableControllers[n[a]];if(o)return o(t,i)}}throw new Error("no controller requested was found in the available controllers list")}}ti._AvailableControllers={};ti._Fallbacks={};ti._ProfileLoadingPromises={};ti.BaseRepositoryUrl="https://immersive-web.github.io/webxr-input-profiles/packages/viewer/dist";ti.PrioritizeOnlineRepository=!0;ti.UseOnlineRepository=!0;ti.DisableControllerCache=!0;ti.RegisterController(Bl.ProfileId,(s,e)=>new Bl(e,s.gamepad,s.handedness));ti.DefaultFallbacks();let MV=0;class FV{constructor(e,t,i={}){this._scene=e,this.inputSource=t,this._options=i,this._tmpVector=new x,this._disposed=!1,this.onDisposeObservable=new k,this.onMeshLoadedObservable=new k,this.onMotionControllerInitObservable=new k,this._uniqueId=`controller-${MV++}-${t.targetRayMode}-${t.handedness}`,this.pointer=new Oe(`${this._uniqueId}-pointer`,e),this.pointer.rotationQuaternion=new Z,this.inputSource.gripSpace&&(this.grip=new Oe(`${this._uniqueId}-grip`,this._scene),this.grip.rotationQuaternion=new Z),this._tmpVector.set(0,0,this._scene.useRightHandedSystem?-1:1),this.inputSource.gamepad&&this.inputSource.targetRayMode==="tracked-pointer"&&ti.GetMotionControllerWithXRInput(t,e,this._options.forceControllerProfile).then(r=>{this.motionController=r,this.onMotionControllerInitObservable.notifyObservers(r),!this._options.doNotLoadControllerMesh&&!this.motionController._doNotLoadControllerMesh&&this.motionController.loadModel().then(n=>{var a;if(n&&this.motionController&&this.motionController.rootMesh){if(this._options.renderingGroupId){this.motionController.rootMesh.renderingGroupId=this._options.renderingGroupId;const o=this.motionController.rootMesh.getChildMeshes(!1);for(const l of o)l.renderingGroupId=this._options.renderingGroupId}this.onMeshLoadedObservable.notifyObservers(this.motionController.rootMesh),this.motionController.rootMesh.parent=this.grip||this.pointer,this.motionController.disableAnimation=!!this._options.disableMotionControllerAnimation}this._disposed&&((a=this.motionController)==null||a.dispose())})},()=>{j.Warn("Could not find a matching motion controller for the registered input source")})}get uniqueId(){return this._uniqueId}dispose(){this.grip&&this.grip.dispose(!0),this.motionController&&this.motionController.dispose(),this.pointer.dispose(!0),this.onMotionControllerInitObservable.clear(),this.onMeshLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._disposed=!0}getWorldPointerRayToRef(e,t=!1){const i=t&&this.grip?this.grip:this.pointer;x.TransformNormalToRef(this._tmpVector,i.getWorldMatrix(),e.direction),e.direction.normalize(),e.origin.copyFrom(i.absolutePosition),e.length=1e3}updateFromXRFrame(e,t,i,r){const n=e.getPose(this.inputSource.targetRaySpace,t);if(this._lastXRPose=n,n){const a=n.transform.position;this.pointer.position.set(a.x,a.y,a.z).scaleInPlace(r.worldScalingFactor);const o=n.transform.orientation;this.pointer.rotationQuaternion.set(o.x,o.y,o.z,o.w),this._scene.useRightHandedSystem||(this.pointer.position.z*=-1,this.pointer.rotationQuaternion.z*=-1,this.pointer.rotationQuaternion.w*=-1),this.pointer.parent=i.parent,this.pointer.scaling.setAll(r.worldScalingFactor)}if(this.inputSource.gripSpace&&this.grip){const a=e.getPose(this.inputSource.gripSpace,t);if(a){const o=a.transform.position,l=a.transform.orientation;this.grip.position.set(o.x,o.y,o.z).scaleInPlace(r.worldScalingFactor),this.grip.rotationQuaternion.set(l.x,l.y,l.z,l.w),this._scene.useRightHandedSystem||(this.grip.position.z*=-1,this.grip.rotationQuaternion.z*=-1,this.grip.rotationQuaternion.w*=-1)}this.grip.parent=i.parent,this.grip.scaling.setAll(r.worldScalingFactor)}this.motionController&&this.motionController.updateFromXRFrame(e)}}class LV{constructor(e,t,i={}){if(this.xrSessionManager=e,this.xrCamera=t,this._options=i,this.controllers=[],this.onControllerAddedObservable=new k,this.onControllerRemovedObservable=new k,this._onInputSourcesChange=r=>{this._addAndRemoveControllers(r.added,r.removed)},this._sessionEndedObserver=this.xrSessionManager.onXRSessionEnded.add(()=>{this._addAndRemoveControllers([],this.controllers.map(r=>r.inputSource))}),this._sessionInitObserver=this.xrSessionManager.onXRSessionInit.add(r=>{r.addEventListener("inputsourceschange",this._onInputSourcesChange)}),this._frameObserver=this.xrSessionManager.onXRFrameObservable.add(r=>{for(const n of this.controllers)n.updateFromXRFrame(r,this.xrSessionManager.referenceSpace,this.xrCamera,this.xrSessionManager)}),this._options.customControllersRepositoryURL&&(ti.BaseRepositoryUrl=this._options.customControllersRepositoryURL),ti.UseOnlineRepository=!this._options.disableOnlineControllerRepository,ti.UseOnlineRepository)try{ti.UpdateProfilesList().catch(()=>{ti.UseOnlineRepository=!1})}catch{ti.UseOnlineRepository=!1}}_addAndRemoveControllers(e,t){const i=this.controllers.map(a=>a.inputSource);for(const a of e)if(i.indexOf(a)===-1){const o=new FV(this.xrSessionManager.scene,a,{...this._options.controllerOptions||{},forceControllerProfile:this._options.forceInputProfile,doNotLoadControllerMesh:this._options.doNotLoadControllerMeshes,disableMotionControllerAnimation:this._options.disableControllerAnimation});this.controllers.push(o),this.onControllerAddedObservable.notifyObservers(o)}const r=[],n=[];for(const a of this.controllers)t.indexOf(a.inputSource)===-1?r.push(a):n.push(a);this.controllers=r;for(const a of n)this.onControllerRemovedObservable.notifyObservers(a),a.dispose()}dispose(){for(const e of this.controllers)e.dispose();this.xrSessionManager.onXRFrameObservable.remove(this._frameObserver),this.xrSessionManager.onXRSessionInit.remove(this._sessionInitObserver),this.xrSessionManager.onXRSessionEnded.remove(this._sessionEndedObserver),this.onControllerAddedObservable.clear(),this.onControllerRemovedObservable.clear(),ti.ClearControllerCache()}}class pi{get xrNativeFeatureName(){return this._xrNativeFeatureName}set xrNativeFeatureName(e){var t;!this._xrSessionManager.isNative&&e&&this._xrSessionManager.inXRSession&&((t=this._xrSessionManager.enabledFeatures)==null?void 0:t.indexOf(e))===-1&&N.Warn(`The feature ${e} needs to be enabled before starting the XR session. Note - It is still possible it is not supported.`),this._xrNativeFeatureName=e}constructor(e){this._xrSessionManager=e,this._attached=!1,this._removeOnDetach=[],this.isDisposed=!1,this.disableAutoAttach=!1,this._xrNativeFeatureName="",this.onFeatureAttachObservable=new k,this.onFeatureDetachObservable=new k}get attached(){return this._attached}attach(e){if(this.isDisposed)return!1;if(e)this.attached&&this.detach();else if(this.attached)return!1;if(!this._xrSessionManager.enabledFeatures)N.Warn("session.enabledFeatures is not available on this device. It is possible that this feature is not supported.");else if(!this._xrSessionManager.isNative&&this.xrNativeFeatureName&&this._xrSessionManager.enabledFeatures.indexOf(this.xrNativeFeatureName)===-1)return!1;return this._attached=!0,this._addNewAttachObserver(this._xrSessionManager.onXRFrameObservable,t=>this._onXRFrame(t)),this.onFeatureAttachObservable.notifyObservers(this),!0}detach(){if(!this._attached)return this.disableAutoAttach=!0,!1;this._attached=!1;for(const e of this._removeOnDetach)e.observable.remove(e.observer);return this.onFeatureDetachObservable.notifyObservers(this),!0}dispose(){this.detach(),this.isDisposed=!0,this.onFeatureAttachObservable.clear(),this.onFeatureDetachObservable.clear()}isCompatible(){return!0}_addNewAttachObserver(e,t,i){this._removeOnDetach.push({observable:e,observer:e.add(t,void 0,i)})}}class Hs extends pi{constructor(e,t){super(e),this._options=t,this._attachController=i=>{if(this._controllers[i.uniqueId])return;const{laserPointer:r,selectionMesh:n}=this._generateNewMeshPair(this._options.forceGripIfAvailable&&i.grip?i.grip:i.pointer);switch(this._controllers[i.uniqueId]={xrController:i,laserPointer:r,selectionMesh:n,meshUnderPointer:null,pick:null,tmpRay:new xe(new x,new x),disabledByNearInteraction:!1,id:Hs._IdCounter++},this._attachedController?!this._options.enablePointerSelectionOnAllControllers&&this._options.preferredHandedness&&i.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=i.uniqueId):this._options.enablePointerSelectionOnAllControllers||(this._attachedController=i.uniqueId),i.inputSource.targetRayMode){case"tracked-pointer":return this._attachTrackedPointerRayMode(i);case"gaze":return this._attachGazeMode(i);case"screen":case"transient-pointer":return this._attachScreenRayMode(i)}},this._controllers={},this._tmpVectorForPickCompare=new x,this.disablePointerLighting=!0,this.disableSelectionMeshLighting=!0,this.displayLaserPointer=!0,this.displaySelectionMesh=!0,this.laserPointerPickedColor=new q(.9,.9,.9),this.laserPointerDefaultColor=new q(.7,.7,.7),this.selectionMeshDefaultColor=new q(.8,.8,.8),this.selectionMeshPickedColor=new q(.3,.3,1),this._identityMatrix=z.Identity(),this._screenCoordinatesRef=x.Zero(),this._viewportRef=new Hn(0,0,0,0),this._scene=this._xrSessionManager.scene,this._options.lookAndPickMode===void 0&&(this._scene.getEngine()._badDesktopOS||this._scene.getEngine()._badOS)&&(this._options.lookAndPickMode=!0),this._options.lookAndPickMode&&(this._options.enablePointerSelectionOnAllControllers=!0,this.displayLaserPointer=!1)}attach(){if(!super.attach())return!1;for(const e of this._options.xrInput.controllers)this._attachController(e);if(this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController,!0),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)},!0),this._scene.constantlyUpdateMeshUnderPointer=!0,this._options.gazeCamera){const e=this._options.gazeCamera,{laserPointer:t,selectionMesh:i}=this._generateNewMeshPair(e);this._controllers.camera={webXRCamera:e,laserPointer:t,selectionMesh:i,meshUnderPointer:null,pick:null,tmpRay:new xe(new x,new x),disabledByNearInteraction:!1,id:Hs._IdCounter++},this._attachGazeMode()}return!0}detach(){if(!super.detach())return!1;const e=Object.keys(this._controllers);for(const t of e)this._detachController(t);return!0}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}_getPointerSelectionDisabledByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].disabledByNearInteraction;return!0}_setPointerSelectionDisabledByPointerId(e,t){const i=Object.keys(this._controllers);for(let r=0;r<i.length;++r)if(this._controllers[i[r]].id===e){this._controllers[i[r]].disabledByNearInteraction=t;return}}_onXRFrame(e){var i;const t=Object.keys(this._controllers);for(const r of t){const n=this._controllers[r];if(this._options.lookAndPickMode&&((i=n.xrController)==null?void 0:i.inputSource.targetRayMode)!=="transient-pointer")continue;if(!this._options.enablePointerSelectionOnAllControllers&&r!==this._attachedController||n.disabledByNearInteraction){n.selectionMesh.isVisible=!1,n.laserPointer.isVisible=!1,n.pick=null;continue}n.laserPointer.isVisible=this.displayLaserPointer;let a;if(n.xrController)a=this._options.forceGripIfAvailable&&n.xrController.grip?n.xrController.grip.position:n.xrController.pointer.position,n.xrController.getWorldPointerRayToRef(n.tmpRay,this._options.forceGripIfAvailable);else if(n.webXRCamera)a=n.webXRCamera.position,n.webXRCamera.getForwardRayToRef(n.tmpRay);else continue;if(this._options.maxPointerDistance&&(n.tmpRay.length=this._options.maxPointerDistance),!this._options.disableScenePointerVectorUpdate&&a){const u=this._xrSessionManager.scene,h=this._options.xrInput.xrCamera;h&&(h.viewport.toGlobalToRef(u.getEngine().getRenderWidth()/h.rigCameras.length,u.getEngine().getRenderHeight(),this._viewportRef),x.ProjectToRef(a,this._identityMatrix,h.getTransformationMatrix(),this._viewportRef,this._screenCoordinatesRef),typeof this._screenCoordinatesRef.x=="number"&&typeof this._screenCoordinatesRef.y=="number"&&!isNaN(this._screenCoordinatesRef.x)&&!isNaN(this._screenCoordinatesRef.y)&&this._screenCoordinatesRef.x!==1/0&&this._screenCoordinatesRef.y!==1/0&&(u.pointerX=this._screenCoordinatesRef.x,u.pointerY=this._screenCoordinatesRef.y,n.screenCoordinates={x:this._screenCoordinatesRef.x,y:this._screenCoordinatesRef.y}))}let o=null;this._utilityLayerScene&&(o=this._utilityLayerScene.pickWithRay(n.tmpRay,this._utilityLayerScene.pointerMovePredicate||this.raySelectionPredicate));const l=this._scene.pickWithRay(n.tmpRay,this._scene.pointerMovePredicate||this.raySelectionPredicate);!o||!o.hit?n.pick=l:!l||!l.hit||o.distance<l.distance?n.pick=o:n.pick=l,n.pick&&n.xrController&&(n.pick.aimTransform=n.xrController.pointer,n.pick.gripTransform=n.xrController.grip||null,n.pick.originMesh=n.xrController.pointer,n.tmpRay.length=n.pick.distance);const c=n.pick;if(c&&c.pickedPoint&&c.hit){this._updatePointerDistance(n.laserPointer,c.distance),n.selectionMesh.position.copyFrom(c.pickedPoint),n.selectionMesh.scaling.x=Math.sqrt(c.distance),n.selectionMesh.scaling.y=Math.sqrt(c.distance),n.selectionMesh.scaling.z=Math.sqrt(c.distance);const u=this._convertNormalToDirectionOfRay(c.getNormal(!0),n.tmpRay),h=.001;if(n.selectionMesh.position.copyFrom(c.pickedPoint),u){const d=x.Cross(Ms.Y,u),f=x.Cross(u,d);x.RotationFromAxisToRef(f,u,d,n.selectionMesh.rotation),n.selectionMesh.position.addInPlace(u.scale(h))}n.selectionMesh.isVisible=this.displaySelectionMesh,n.meshUnderPointer=c.pickedMesh}else n.selectionMesh.isVisible=!1,this._updatePointerDistance(n.laserPointer,1),n.meshUnderPointer=null}}get _utilityLayerScene(){return this._options.customUtilityLayerScene||Lt.DefaultUtilityLayer.utilityLayerScene}_attachGazeMode(e){const t=this._controllers[e&&e.uniqueId||"camera"],i=this._options.timeToSelect||3e3,r=this._options.useUtilityLayer?this._utilityLayerScene:this._scene;let n=new Li;const a=Pl("selection",{diameter:.0035*15,thickness:.0025*6,tessellation:20},r);a.isVisible=!1,a.isPickable=!1,a.parent=t.selectionMesh;let o=0,l=!1;const c={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{if(t.pick){if(this._augmentPointerInit(c,t.id,t.screenCoordinates),t.laserPointer.material.alpha=0,a.isVisible=!1,t.pick.hit)if(this._pickingMoved(n,t.pick))l&&(this._options.disablePointerUpOnTouchOut||this._scene.simulatePointerUp(t.pick,c)),l=!1,o=0;else if(o>i/10&&(a.isVisible=!0),o+=this._scene.getEngine().getDeltaTime(),o>=i)this._scene.simulatePointerDown(t.pick,c),l=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,c),a.isVisible=!1;else{const u=1-o/i;a.scaling.set(u,u,u)}else l=!1,o=0;this._scene.simulatePointerMove(t.pick,c),n=t.pick}}),this._options.renderingGroupId!==void 0&&(a.renderingGroupId=this._options.renderingGroupId),e&&e.onDisposeObservable.addOnce(()=>{t.pick&&!this._options.disablePointerUpOnTouchOut&&l&&(this._scene.simulatePointerUp(t.pick,c),t.finalPointerUpTriggered=!0),a.dispose()})}_attachScreenRayMode(e){const t=this._controllers[e.uniqueId];let i=!1;const r={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{this._augmentPointerInit(r,t.id,t.screenCoordinates),!(!t.pick||this._options.disablePointerUpOnTouchOut&&i)&&(i?this._scene.simulatePointerMove(t.pick,r):(this._scene.simulatePointerDown(t.pick,r),t.pointerDownTriggered=!0,i=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,r)))}),e.onDisposeObservable.addOnce(()=>{this._augmentPointerInit(r,t.id,t.screenCoordinates),this._xrSessionManager.runInXRFrame(()=>{t.pick&&!t.finalPointerUpTriggered&&i&&!this._options.disablePointerUpOnTouchOut&&(this._scene.simulatePointerUp(t.pick,r),t.finalPointerUpTriggered=!0)})})}_attachTrackedPointerRayMode(e){const t=this._controllers[e.uniqueId];if(this._options.forceGazeMode)return this._attachGazeMode(e);const i={pointerId:t.id,pointerType:"xr"};if(t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{t.laserPointer.material.disableLighting=this.disablePointerLighting,t.selectionMesh.material.disableLighting=this.disableSelectionMeshLighting,t.pick&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),this._scene.simulatePointerMove(t.pick,i))}),e.inputSource.gamepad){const r=n=>{this._options.overrideButtonId&&(t.selectionComponent=n.getComponent(this._options.overrideButtonId)),t.selectionComponent||(t.selectionComponent=n.getMainComponent()),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add(a=>{if(a.changes.pressed){const o=a.changes.pressed.current;if(t.pick)(this._options.enablePointerSelectionOnAllControllers||e.uniqueId===this._attachedController)&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),o?(this._scene.simulatePointerDown(t.pick,i),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor):(this._scene.simulatePointerUp(t.pick,i),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor));else if(o&&!this._options.enablePointerSelectionOnAllControllers&&!this._options.disableSwitchOnClick){const l=this._controllers[this._attachedController];l&&l.pointerDownTriggered&&!l.finalPointerUpTriggered&&(this._augmentPointerInit(i,l.id,l.screenCoordinates),this._scene.simulatePointerUp(new Li,{pointerId:l.id,pointerType:"xr"}),l.finalPointerUpTriggered=!0),this._attachedController=e.uniqueId}}})};e.motionController?r(e.motionController):e.onMotionControllerInitObservable.add(r)}else{const r=a=>{this._xrSessionManager.onXRFrameObservable.addOnce(()=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),t.xrController&&a.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerDown(t.pick,i),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor)})},n=a=>{this._xrSessionManager.onXRFrameObservable.addOnce(()=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),t.xrController&&a.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerUp(t.pick,i),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor)})};t.eventListeners={selectend:n,selectstart:r},this._xrSessionManager.session.addEventListener("selectstart",r),this._xrSessionManager.session.addEventListener("selectend",n)}}_convertNormalToDirectionOfRay(e,t){return e&&Math.acos(x.Dot(e,t.direction))<Math.PI/2&&e.scaleInPlace(-1),e}_detachController(e){const t=this._controllers[e];if(t){if(t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners){const i=Object.keys(t.eventListeners);for(const r of i){const n=t.eventListeners&&t.eventListeners[r];n&&this._xrSessionManager.session.removeEventListener(r,n)}}if(!t.finalPointerUpTriggered&&t.pointerDownTriggered){const i={pointerId:t.id,pointerType:"xr"};this._xrSessionManager.runInXRFrame(()=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),this._scene.simulatePointerUp(t.pick||new Li,i),t.finalPointerUpTriggered=!0})}this._xrSessionManager.scene.onBeforeRenderObservable.addOnce(()=>{try{if(t.selectionMesh.dispose(),t.laserPointer.dispose(),delete this._controllers[e],this._attachedController===e){const i=Object.keys(this._controllers);i.length?this._attachedController=i[0]:this._attachedController=""}}catch{j.Warn("controller already detached.")}})}}_generateNewMeshPair(e){const t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Lt.DefaultUtilityLayer.utilityLayerScene:this._scene,i=this._options.customLasterPointerMeshGenerator?this._options.customLasterPointerMeshGenerator():fI("laserPointer",{height:1,diameterTop:2e-4,diameterBottom:.004,tessellation:20,subdivisions:1},t);i.parent=e;const r=new Lr("laserPointerMat",t);r.emissiveColor=this.laserPointerDefaultColor,r.alpha=.7,i.material=r,i.rotation.x=Math.PI/2,this._updatePointerDistance(i,1),i.isPickable=!1,i.isVisible=!1;const n=this._options.customSelectionMeshGenerator?this._options.customSelectionMeshGenerator():Pl("gazeTracker",{diameter:.0035*3,thickness:.0025*3,tessellation:20},t);n.bakeCurrentTransformIntoVertices(),n.isPickable=!1,n.isVisible=!1;const a=new Lr("targetMat",t);return a.specularColor=q.Black(),a.emissiveColor=this.selectionMeshDefaultColor,a.backFaceCulling=!1,n.material=a,this._options.renderingGroupId!==void 0&&(i.renderingGroupId=this._options.renderingGroupId,n.renderingGroupId=this._options.renderingGroupId),{laserPointer:i,selectionMesh:n}}_pickingMoved(e,t){var n;if(!e.hit||!t.hit||!e.pickedMesh||!e.pickedPoint||!t.pickedMesh||!t.pickedPoint||e.pickedMesh!==t.pickedMesh)return!0;(n=e.pickedPoint)==null||n.subtractToRef(t.pickedPoint,this._tmpVectorForPickCompare),this._tmpVectorForPickCompare.set(Math.abs(this._tmpVectorForPickCompare.x),Math.abs(this._tmpVectorForPickCompare.y),Math.abs(this._tmpVectorForPickCompare.z));const i=(this._options.gazeModePointerMovedFactor||1)*.01*t.distance;return this._tmpVectorForPickCompare.length()>i}_updatePointerDistance(e,t=100){e.scaling.y=t,this._scene.useRightHandedSystem&&(t*=-1),e.position.z=t/2+.05}_augmentPointerInit(e,t,i){e.pointerId=t,e.pointerType="xr",i&&(e.screenX=i.x,e.screenY=i.y)}get lasterPointerDefaultColor(){return this.laserPointerDefaultColor}}Hs._IdCounter=200;Hs.Name=Ne.POINTER_SELECTION;Hs.Version=1;At.AddWebXRFeature(Hs.Name,(s,e)=>()=>new Hs(s,e),Hs.Version,!0);var p;(function(s){s[s.Float=1]="Float",s[s.Int=2]="Int",s[s.Vector2=4]="Vector2",s[s.Vector3=8]="Vector3",s[s.Vector4=16]="Vector4",s[s.Color3=32]="Color3",s[s.Color4=64]="Color4",s[s.Matrix=128]="Matrix",s[s.Object=256]="Object",s[s.AutoDetect=1024]="AutoDetect",s[s.BasedOnInput=2048]="BasedOnInput",s[s.All=4095]="All"})(p||(p={}));var P;(function(s){s[s.Vertex=1]="Vertex",s[s.Fragment=2]="Fragment",s[s.Neutral=4]="Neutral",s[s.VertexAndFragment=3]="VertexAndFragment"})(P||(P={}));class zv{constructor(){this.supportUniformBuffers=!1,this.attributes=[],this.uniforms=[],this.constants=[],this.samplers=[],this.functions={},this.extensions={},this.prePassOutput={},this.counters={},this._terminalBlocks=new Set,this._attributeDeclaration="",this._uniformDeclaration="",this._constantDeclaration="",this._samplerDeclaration="",this._varyingTransfer="",this._injectAtEnd="",this._injectAtTop="",this._customEntryHeader="",this._repeatableContentAnchorIndex=0,this._builtCompilationString="",this.compilationString=""}get shaderLanguage(){return this.sharedData.nodeMaterial.shaderLanguage}get fSuffix(){return this.shaderLanguage===1?"f":""}async getProcessedShaderAsync(e){if(!this._builtCompilationString)return N.Error("getProcessedShaderAsync: Shader not built yet."),"";const t=this.sharedData.nodeMaterial.getScene().getEngine(),i={defines:e.split(`
`),indexParameters:void 0,isFragment:this.target===P.Fragment,shouldUseHighPrecisionShader:t._shouldUseHighPrecisionShader,processor:t._getShaderProcessor(this.shaderLanguage),supportsUniformBuffers:t.supportsUniformBuffers,shadersRepository:S.GetShadersRepository(this.shaderLanguage),includesShadersStore:S.GetIncludesShadersStore(this.shaderLanguage),version:(t.version*100).toString(),platformName:t.shaderPlatformName,processingContext:null,isNDCHalfZRange:t.isNDCHalfZRange,useReverseDepthBuffer:t.useReverseDepthBuffer};return!t.isWebGPU&&t.version>1&&(i.processor=new AD),await new Promise(r=>{hd(this._builtCompilationString,i,(n,a)=>{r(n)},t)})}finalize(e){const t=e.sharedData.emitComments,i=this.target===P.Fragment;let r=`
${t?`//Entry point
`:""}`;this._customEntryHeader?r+=this._customEntryHeader:this.shaderLanguage===1?i?r+=`@fragment
fn main(input: FragmentInputs) -> FragmentOutputs {
${this.sharedData.varyingInitializationsFragment}`:r+=`@vertex
fn main(input: VertexInputs) -> FragmentInputs{
`:r+=`void main(void) {
`,this.compilationString=r+this.compilationString,this._constantDeclaration&&(this.compilationString=`
${t?`//Constants
`:""}${this._constantDeclaration}
${this.compilationString}`);let n="";for(const a in this.functions)n+=this.functions[a]+`
`;if(this.compilationString=`
${n}
${this.compilationString}`,!i&&this._varyingTransfer&&(this.compilationString=`${this.compilationString}
${this._varyingTransfer}`),this._injectAtEnd&&(this.compilationString=`${this.compilationString}
${this._injectAtEnd}`),this.compilationString=`${this.compilationString}
}`,this.sharedData.varyingDeclaration&&(this.compilationString=`
${t?`//Varyings
`:""}${i?this.sharedData.varyingDeclarationFragment:this.sharedData.varyingDeclaration}
${this.compilationString}`),this._samplerDeclaration&&(this.compilationString=`
${t?`//Samplers
`:""}${this._samplerDeclaration}
${this.compilationString}`),this._uniformDeclaration&&(this.compilationString=`
${t?`//Uniforms
`:""}${this._uniformDeclaration}
${this.compilationString}`),this._attributeDeclaration&&!i&&(this.compilationString=`
${t?`//Attributes
`:""}${this._attributeDeclaration}
${this.compilationString}`),this.shaderLanguage!==1){this.compilationString=`precision highp float;
`+this.compilationString,this.compilationString=`#if defined(WEBGL2) || defined(WEBGPU)
precision highp sampler2DArray;
#endif
`+this.compilationString,i&&(this.compilationString=`#if defined(PREPASS)\r
#extension GL_EXT_draw_buffers : require\r
layout(location = 0) out highp vec4 glFragData[SCENE_MRT_COUNT];\r
highp vec4 gl_FragColor;\r
#endif\r
`+this.compilationString);for(const a in this.extensions){const o=this.extensions[a];this.compilationString=`
${o}
${this.compilationString}`}}this._injectAtTop&&(this.compilationString=`${this._injectAtTop}
${this.compilationString}`),this._builtCompilationString=this.compilationString}get _repeatableContentAnchor(){return`###___ANCHOR${this._repeatableContentAnchorIndex++}___###`}_getFreeVariableName(e){return e=this.sharedData.formatConfig.formatVariablename(e),this.sharedData.variableNames[e]===void 0?(this.sharedData.variableNames[e]=0,e==="output"||e==="texture"?e+this.sharedData.variableNames[e]:e):(this.sharedData.variableNames[e]++,e+this.sharedData.variableNames[e])}_getFreeDefineName(e){return this.sharedData.defineNames[e]===void 0?this.sharedData.defineNames[e]=0:this.sharedData.defineNames[e]++,e+this.sharedData.defineNames[e]}_excludeVariableName(e){this.sharedData.variableNames[e]=0}_emit2DSampler(e,t="",i=!1,r,n,a){if(this.samplers.indexOf(e)<0||i){if(t&&(this._samplerDeclaration+=`#if ${t}
`),this.shaderLanguage===1){const o=n?"u":"f";this._samplerDeclaration+=`var ${e+"Sampler"}: sampler;
`,this._samplerDeclaration+=`var ${e}: texture_2d<${o}32>;
`}else{const o=n?"u":"",l=a??"";this._samplerDeclaration+=`uniform ${l} ${o}sampler2D ${e}; ${r||""}
`}t&&(this._samplerDeclaration+=`#endif
`),i||this.samplers.push(e)}}_emitCubeSampler(e,t="",i=!1){(this.samplers.indexOf(e)<0||i)&&(t&&(this._samplerDeclaration+=`#if ${t}
`),this.shaderLanguage===1?(this._samplerDeclaration+=`var ${e+"Sampler"}: sampler;
`,this._samplerDeclaration+=`var ${e}: texture_cube<f32>;
`):this._samplerDeclaration+=`uniform samplerCube ${e};
`,t&&(this._samplerDeclaration+=`#endif
`),i||this.samplers.push(e))}_emit2DArraySampler(e){this.samplers.indexOf(e)<0&&(this.shaderLanguage===1?(this._samplerDeclaration+=`var ${e+"Sampler"}: sampler;
`,this._samplerDeclaration+=`var ${e}: texture_2d_array<f32>;
`):this._samplerDeclaration+=`uniform sampler2DArray ${e};
`,this.samplers.push(e))}_getGLType(e){switch(e){case p.Float:return"float";case p.Int:return"int";case p.Vector2:return"vec2";case p.Color3:case p.Vector3:return"vec3";case p.Color4:case p.Vector4:return"vec4";case p.Matrix:return"mat4"}return""}_getShaderType(e){const t=this.shaderLanguage===1;switch(e){case p.Float:return t?"f32":"float";case p.Int:return t?"i32":"int";case p.Vector2:return t?"vec2f":"vec2";case p.Color3:case p.Vector3:return t?"vec3f":"vec3";case p.Color4:case p.Vector4:return t?"vec4f":"vec4";case p.Matrix:return t?"mat4x4f":"mat4"}return""}_emitExtension(e,t,i=""){this.extensions[e]||(i&&(t=`#if ${i}
${t}
#endif`),this.extensions[e]=t)}_emitFunction(e,t,i){this.functions[e]||(this.sharedData.emitComments&&(t=i+`
`+t),this.functions[e]=t)}_emitCodeFromInclude(e,t,i){const r=S.GetIncludesShadersStore(this.shaderLanguage);if(i&&i.repeatKey)return`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]
`;let n=r[e]+`
`;if(this.sharedData.emitComments&&(n=t+`
`+n),!i)return n;if(i.replaceStrings)for(let a=0;a<i.replaceStrings.length;a++){const o=i.replaceStrings[a];n=n.replace(o.search,o.replace)}return n}_emitFunctionFromInclude(e,t,i,r=""){const n=e+r;if(this.functions[n])return;const a=S.GetIncludesShadersStore(this.shaderLanguage);if(!i||!i.removeAttributes&&!i.removeUniforms&&!i.removeVaryings&&!i.removeIfDef&&!i.replaceStrings){i&&i.repeatKey?this.functions[n]=`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]
`:this.functions[n]=`#include<${e}>${i!=null&&i.substitutionVars?"("+(i==null?void 0:i.substitutionVars)+")":""}
`,this.sharedData.emitComments&&(this.functions[n]=t+`
`+this.functions[n]);return}if(this.functions[n]=a[e],this.sharedData.emitComments&&(this.functions[n]=t+`
`+this.functions[n]),i.removeIfDef&&(this.functions[n]=this.functions[n].replace(/^\s*?#ifdef.+$/gm,""),this.functions[n]=this.functions[n].replace(/^\s*?#endif.*$/gm,""),this.functions[n]=this.functions[n].replace(/^\s*?#else.*$/gm,""),this.functions[n]=this.functions[n].replace(/^\s*?#elif.*$/gm,"")),i.removeAttributes&&(this.functions[n]=this.functions[n].replace(/\s*?attribute .+?;/g,`
`)),i.removeUniforms&&(this.functions[n]=this.functions[n].replace(/\s*?uniform .*?;/g,`
`)),i.removeVaryings&&(this.functions[n]=this.functions[n].replace(/\s*?(varying|in) .+?;/g,`
`)),i.replaceStrings)for(let o=0;o<i.replaceStrings.length;o++){const l=i.replaceStrings[o];this.functions[n]=this.functions[n].replace(l.search,l.replace)}}_registerTempVariable(e){return this.sharedData.temps.indexOf(e)!==-1?!1:(this.sharedData.temps.push(e),!0)}_emitDefineStart(e,t=!1){let i="";return e&&(e.startsWith("defined(")?i=`#if ${e}
`:i=`${t?"#ifndef":"#ifdef"} ${e}
`),i}_emitDefineEnd(e){return e?`#endif
`:""}_emitVaryingFromString(e,t,i="",r=!1){if(this.sharedData.varyings.indexOf(e)!==-1)return!1;this.sharedData.varyings.push(e);const n=this._getShaderType(t),a=(o=!1)=>{let l=this._emitDefineStart(i,r);if(this.shaderLanguage===1)switch(n){case"i32":case"f32":case"vec2f":case"vec3f":case"vec4f":l+=`varying ${e}: ${n};
`,o&&(l+=`var<private> ${e}: ${n};
`,this.sharedData.varyingInitializationsFragment+=this._emitDefineStart(i,r)+`${e} = fragmentInputs.${e};
`+this._emitDefineEnd(i));break;case"mat4x4f":l+=`varying ${e}_r0: vec4f;
`,l+=`varying ${e}_r1: vec4f;
`,l+=`varying ${e}_r2: vec4f;
`,l+=`varying ${e}_r3: vec4f;
`,o&&(l+=`var<private> ${e}: mat4x4f;
`,this.sharedData.varyingInitializationsFragment+=this._emitDefineStart(i,r)+`${e} = mat4x4f(fragmentInputs.${e}_r0, fragmentInputs.${e}_r1, fragmentInputs.${e}_r2, fragmentInputs.${e}_r3);
`+this._emitDefineEnd(i));break;default:l+=`varying ${e}: ${n};
`;break}else l+=`varying ${n} ${e};
`;return l+=this._emitDefineEnd(i),l};if(this.shaderLanguage===1)this.sharedData.varyingDeclaration+=a(!1),this.sharedData.varyingDeclarationFragment+=a(!0);else{const o=a();this.sharedData.varyingDeclaration+=o,this.sharedData.varyingDeclarationFragment+=o}return!0}_getVaryingName(e){return this.shaderLanguage===1?(this.target!==P.Fragment?"vertexOutputs.":"fragmentInputs.")+e:e}_emitUniformFromString(e,t,i="",r=!1){if(this.uniforms.indexOf(e)!==-1)return;this.uniforms.push(e),i&&(i.startsWith("defined(")?this._uniformDeclaration+=`#if ${i}
`:this._uniformDeclaration+=`${r?"#ifndef":"#ifdef"} ${i}
`),this.sharedData.formatConfig.getUniformAnnotation&&(this._uniformDeclaration+=this.sharedData.formatConfig.getUniformAnnotation(e));const n=this._getShaderType(t);this.shaderLanguage===1?this._uniformDeclaration+=`uniform ${e}: ${n};
`:this._uniformDeclaration+=`uniform ${n} ${e};
`,i&&(this._uniformDeclaration+=`#endif
`)}_generateTernary(e,t,i){return this.shaderLanguage===1?`select(${t}, ${e}, ${i})`:`(${i}) ? ${e} : ${t}`}_emitFloat(e){return e.toString()===e.toFixed(0)?`${e}.0`:e.toString()}_declareOutput(e,t){return this._declareLocalVar(e.associatedVariableName,e.type,t)}_declareLocalVar(e,t,i,r){return this.shaderLanguage===1?`${i?"const":"var"+(r?"<private>":"")} ${e}: ${this._getShaderType(t)}`:`${i?"const ":""}${this._getShaderType(t)} ${e}`}_samplerCubeFunc(){return this.shaderLanguage===1?"textureSample":"textureCube"}_samplerFunc(){return this.shaderLanguage===1?"textureSample":"texture2D"}_samplerLODFunc(){return this.shaderLanguage===1?"textureSampleLevel":"texture2DLodEXT"}_toLinearSpace(e){return this.shaderLanguage===1?e.type===p.Color3||e.type===p.Vector3?`toLinearSpaceVec3(${e.associatedVariableName})`:`toLinearSpace(${e.associatedVariableName})`:`toLinearSpace(${e.associatedVariableName})`}_generateTextureSample(e,t){return this.shaderLanguage===1?`${this._samplerFunc()}(${t},${t+"Sampler"}, ${e})`:`${this._samplerFunc()}(${t}, ${e})`}_generateTextureSampleLOD(e,t,i){return this.shaderLanguage===1?`${this._samplerLODFunc()}(${t},${t+"Sampler"}, ${e}, ${i})`:`${this._samplerLODFunc()}(${t}, ${e}, ${i})`}_generateTextureSampleCube(e,t){return this.shaderLanguage===1?`${this._samplerCubeFunc()}(${t},${t+"Sampler"}, ${e})`:`${this._samplerCubeFunc()}(${t}, ${e})`}_generateTextureSampleCubeLOD(e,t,i){return this.shaderLanguage===1?`${this._samplerCubeFunc()}(${t},${t+"Sampler"}, ${e}, ${i})`:`${this._samplerCubeFunc()}(${t}, ${e}, ${i})`}_convertVariableDeclarationToWGSL(e,t,i){return i.replace(new RegExp(`(${e})\\s+(\\w+)`,"g"),`var $2: ${t}`)}_convertVariableConstructorsToWGSL(e,t,i){return i.replace(new RegExp(`(${e})\\(`,"g"),` ${t}(`)}_convertOutParametersToWGSL(e){return e.replace(new RegExp("out\\s+var\\s+(\\w+)\\s*:\\s*(\\w+)","g"),"$1: ptr<function, $2>")}_convertTernaryOperandsToWGSL(e){return e.replace(new RegExp("\\[(.*?)\\?(.*?):(.*)\\]","g"),(t,i,r,n)=>`select(${n}, ${r}, ${i})`)}_convertModOperatorsToWGSL(e){return e.replace(new RegExp("mod\\((.+?),\\s*(.+?)\\)","g"),(t,i,r)=>`((${i})%(${r}))`)}_convertConstToWGSL(e){return e.replace(new RegExp("const var","g"),"const")}_convertInnerFunctionsToWGSL(e){return e.replace(new RegExp("inversesqrt","g"),"inverseSqrt")}_convertFunctionsToWGSL(e){const t=/var\s+(\w+)\s*:\s*(\w+)\((.*)\)/g;let i;for(;(i=t.exec(e))!==null;){const r=i[1],n=i[2],o=i[3].replace(/var\s/g,"");e=e.replace(i[0],`fn ${r}(${o}) -> ${n}`)}return e}_babylonSLtoWGSL(e){return e=this._convertVariableDeclarationToWGSL("void","voidnull",e),e=this._convertVariableDeclarationToWGSL("bool","bool",e),e=this._convertVariableDeclarationToWGSL("int","i32",e),e=this._convertVariableDeclarationToWGSL("uint","u32",e),e=this._convertVariableDeclarationToWGSL("float","f32",e),e=this._convertVariableDeclarationToWGSL("vec2","vec2f",e),e=this._convertVariableDeclarationToWGSL("vec3","vec3f",e),e=this._convertVariableDeclarationToWGSL("vec4","vec4f",e),e=this._convertVariableDeclarationToWGSL("mat2","mat2x2f",e),e=this._convertVariableDeclarationToWGSL("mat3","mat3x3f",e),e=this._convertVariableDeclarationToWGSL("mat4","mat4x4f",e),e=this._convertVariableConstructorsToWGSL("float","f32",e),e=this._convertVariableConstructorsToWGSL("vec2","vec2f",e),e=this._convertVariableConstructorsToWGSL("vec3","vec3f",e),e=this._convertVariableConstructorsToWGSL("vec4","vec4f",e),e=this._convertVariableConstructorsToWGSL("mat2","mat2x2f",e),e=this._convertVariableConstructorsToWGSL("mat3","mat3x3f",e),e=this._convertVariableConstructorsToWGSL("mat4","mat4x4f",e),e=this._convertTernaryOperandsToWGSL(e),e=this._convertModOperatorsToWGSL(e),e=this._convertConstToWGSL(e),e=this._convertInnerFunctionsToWGSL(e),e=this._convertOutParametersToWGSL(e),e=e.replace(/\[\*\]/g,"*"),e=this._convertFunctionsToWGSL(e),e=e.replace(/\s->\svoidnull/g,""),e=e.replace(/dFdx/g,"dpdx"),e=e.replace(/dFdy/g,"dpdy"),e}_convertTernaryOperandsToGLSL(e){return e.replace(new RegExp("\\[(.+?)\\?(.+?):(.+)\\]","g"),(t,i,r,n)=>`${i} ? ${r} : ${n}`)}_babylonSLtoGLSL(e){return e=e.replace(/\[\*\]/g,""),e=this._convertTernaryOperandsToGLSL(e),e}}class wV{constructor(){this.temps=[],this.varyings=[],this.varyingDeclaration="",this.varyingDeclarationFragment="",this.varyingInitializationsFragment="",this.inputBlocks=[],this.textureBlocks=[],this.bindableBlocks=[],this.forcedBindableBlocks=[],this.blocksWithFallbacks=[],this.blocksWithDefines=[],this.repeatableContentBlocks=[],this.dynamicUniformBlocks=[],this.blockingBlocks=[],this.animatedInputs=[],this.formatConfig={getUniformAnnotation:null,formatVariablename:e=>e.replace(/[^a-zA-Z_]+/g,"")},this.variableNames={},this.defineNames={},this.hints={needWorldViewMatrix:!1,needWorldViewProjectionMatrix:!1,needAlphaBlending:!1,needAlphaTesting:!1},this.checks={emitVertex:!1,emitFragment:!1,notConnectedNonOptionalInputs:new Array,customErrors:new Array},this.allowEmptyVertexProgram=!1,this.variableNames.position=0,this.variableNames.normal=0,this.variableNames.tangent=0,this.variableNames.uv=0,this.variableNames.uv2=0,this.variableNames.uv3=0,this.variableNames.uv4=0,this.variableNames.uv5=0,this.variableNames.uv6=0,this.variableNames.color=0,this.variableNames.matricesIndices=0,this.variableNames.matricesWeights=0,this.variableNames.matricesIndicesExtra=0,this.variableNames.matricesWeightsExtra=0,this.variableNames.diffuseBase=0,this.variableNames.specularBase=0,this.variableNames.worldPos=0,this.variableNames.shadow=0,this.variableNames.view=0,this.variableNames.vTBN=0,this.defineNames.MAINUV0=0,this.defineNames.MAINUV1=0,this.defineNames.MAINUV2=0,this.defineNames.MAINUV3=0,this.defineNames.MAINUV4=0,this.defineNames.MAINUV5=0,this.defineNames.MAINUV6=0,this.defineNames.MAINUV7=0}raiseBuildError(e){this.checks.customErrors.indexOf(e)!==-1&&this.checks.customErrors.push(e)}emitErrors(){let e="";!this.checks.emitVertex&&!this.allowEmptyVertexProgram&&(e+=`NodeMaterial does not have a vertex output. You need to at least add a block that generates a position value.
`),this.checks.emitFragment||(e+=`NodeMaterial does not have a fragment output. You need to at least add a block that generates a color value.
`);for(const t of this.checks.notConnectedNonOptionalInputs)e+=`input ${t.name} from block ${t.ownerBlock.name}[${t.ownerBlock.getClassName()}] is not connected and is not optional.
`;for(const t of this.checks.customErrors)e+=t+`
`;return e?(e=`Node material build failed: 
`+e,N.Error(e),this.nodeMaterial.onBuildErrorObservable.notifyObservers(e),!1):!0}}var Wv;(function(s){s[s.Compatible=0]="Compatible",s[s.TypeIncompatible=1]="TypeIncompatible",s[s.TargetIncompatible=2]="TargetIncompatible",s[s.HierarchyIssue=3]="HierarchyIssue"})(Wv||(Wv={}));var Hv;(function(s){s[s.Input=0]="Input",s[s.Output=1]="Output"})(Hv||(Hv={}));class Ao{static AreEquivalentTypes(e,t){switch(e){case p.Vector3:{if(t===p.Color3)return!0;break}case p.Vector4:{if(t===p.Color4)return!0;break}case p.Color3:{if(t===p.Vector3)return!0;break}case p.Color4:{if(t===p.Vector4)return!0;break}}return!1}get isInactive(){return this._isInactive}get _connectedPoint(){return this._connectedPointBackingField}set _connectedPoint(e){var t;this._connectedPointBackingField!==e&&((t=this._connectedPointTypeChangedObserver)==null||t.remove(),this._updateTypeDependentState(()=>this._connectedPointBackingField=e),this._connectedPointBackingField&&(this._connectedPointTypeChangedObserver=this._connectedPointBackingField.onTypeChangedObservable.add(()=>{this._notifyTypeChanged()})))}get _typeConnectionSource(){return this._typeConnectionSourceBackingField}set _typeConnectionSource(e){var t;this._typeConnectionSourceBackingField!==e&&((t=this._typeConnectionSourceTypeChangedObserver)==null||t.remove(),this._updateTypeDependentState(()=>this._typeConnectionSourceBackingField=e),this._typeConnectionSourceBackingField&&(this._typeConnectionSourceTypeChangedObserver=this._typeConnectionSourceBackingField.onTypeChangedObservable.add(()=>{this._notifyTypeChanged()})))}get _defaultConnectionPointType(){return this._defaultConnectionPointTypeBackingField}set _defaultConnectionPointType(e){this._updateTypeDependentState(()=>this._defaultConnectionPointTypeBackingField=e)}get _linkedConnectionSource(){return this._linkedConnectionSourceBackingField}set _linkedConnectionSource(e){var t;this._linkedConnectionSourceBackingField!==e&&((t=this._linkedConnectionSourceTypeChangedObserver)==null||t.remove(),this._updateTypeDependentState(()=>this._linkedConnectionSourceBackingField=e),this._isMainLinkSource=!1,this._linkedConnectionSourceBackingField&&(this._linkedConnectionSourceTypeChangedObserver=this._linkedConnectionSourceBackingField.onTypeChangedObservable.add(()=>{this._notifyTypeChanged()})))}get direction(){return this._direction}get declarationVariableName(){return this._ownerBlock.isInput?this._ownerBlock.declarationVariableName:(!this._enforceAssociatedVariableName||!this._associatedVariableName)&&this._connectedPoint?this._connectedPoint.declarationVariableName:this._associatedVariableName}get associatedVariableName(){return this._ownerBlock.isInput?this._ownerBlock.associatedVariableName:(!this._enforceAssociatedVariableName||!this._associatedVariableName)&&this._connectedPoint?this._connectedPoint.associatedVariableName:this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get innerType(){return this._linkedConnectionSource&&!this._isMainLinkSource&&this._linkedConnectionSource.isConnected?this.type:this._type}get type(){if(this._type===p.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource){if(this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.connectedPoint._redirectedSource&&this._linkedConnectionSource.connectedPoint._redirectedSource.isConnected?this._linkedConnectionSource.connectedPoint._redirectedSource.type:this._linkedConnectionSource.type;if(this._linkedConnectionSource._defaultConnectionPointType)return this._linkedConnectionSource._defaultConnectionPointType}if(this._defaultConnectionPointType)return this._defaultConnectionPointType}if(this._type===p.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._updateTypeDependentState(()=>this._type=e)}get target(){return!this._prioritizeVertex||!this._ownerBlock?this._target:this._target!==P.VertexAndFragment?this._target:this._ownerBlock.target===P.Fragment?P.Fragment:P.Vertex}set target(e){this._target=e}get isConnected(){return this.connectedPoint!==null||this.hasEndpoints}get isConnectedToInputBlock(){return this.connectedPoint!==null&&this.connectedPoint.ownerBlock.isInput}get connectInputBlock(){return this.isConnectedToInputBlock?this.connectedPoint.ownerBlock:null}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return this._endpoints.length===0?[]:this._endpoints.map(e=>e.ownerBlock)}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get isDirectlyConnectedToVertexOutput(){if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===P.Vertex||(e.ownerBlock.target===P.Neutral||e.ownerBlock.target===P.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isDirectlyConnectedToVertexOutput))return!0;return!1}get isConnectedInVertexShader(){if(this.target===P.Vertex)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===P.Vertex||e.target===P.Vertex||(e.ownerBlock.target===P.Neutral||e.ownerBlock.target===P.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isConnectedInVertexShader))return!0;return!1}get isConnectedInFragmentShader(){if(this.target===P.Fragment)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===P.Fragment||(e.ownerBlock.target===P.Neutral||e.ownerBlock.target===P.VertexAndFragment)&&e.ownerBlock.isConnectedInFragmentShader())return!0;return!1}createCustomInputBlock(){return null}constructor(e,t,i){this._isInactive=!1,this._preventBubbleUp=!1,this._connectedPointBackingField=null,this._endpoints=new Array,this._redirectedSource=null,this._typeConnectionSourceBackingField=null,this._defaultConnectionPointTypeBackingField=null,this._isMainLinkSource=!1,this._linkedConnectionSourceBackingField=null,this._acceptedConnectionPointType=null,this._type=p.Float,this._enforceAssociatedVariableName=!1,this._forPostBuild=!1,this.needDualDirectionValidation=!1,this.acceptedConnectionPointTypes=[],this.excludedConnectionPointTypes=[],this.onConnectionObservable=new k,this.onDisconnectionObservable=new k,this.onTypeChangedObservable=new k,this._isTypeChangeObservableNotifying=!1,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this._prioritizeVertex=!1,this._target=P.VertexAndFragment,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeMaterialConnectionPoint"}canConnectTo(e){return this.checkCompatibilityState(e)===0}checkCompatibilityState(e){const t=this._ownerBlock,i=e.ownerBlock;if(t.target===P.Fragment){if(i.target===P.Vertex)return 2;for(const a of i.outputs)if(a.ownerBlock.target!=P.Neutral&&a.isConnectedInVertexShader)return 2}if(this.type!==e.type&&e.innerType!==p.AutoDetect)return Ao.AreEquivalentTypes(this.type,e.type)||e.acceptedConnectionPointTypes&&e.acceptedConnectionPointTypes.indexOf(this.type)!==-1||e._acceptedConnectionPointType&&Ao.AreEquivalentTypes(e._acceptedConnectionPointType.type,this.type)?0:1;if(e.excludedConnectionPointTypes&&e.excludedConnectionPointTypes.indexOf(this.type)!==-1)return 1;let r=i,n=t;return this.direction===0&&(r=t,n=i),r.isAnAncestorOf(n)?3:0}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw`Cannot connect these two connectors. source: "${this.ownerBlock.name}".${this.name}, target: "${e.ownerBlock.name}".${e.name}`;return this._endpoints.push(e),e._connectedPoint=this,this._enforceAssociatedVariableName=!1,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){const t=this._endpoints.indexOf(e);return t===-1?this:(this._endpoints.splice(t,1),e._connectedPoint=null,this._enforceAssociatedVariableName=!1,e._enforceAssociatedVariableName=!1,this.onDisconnectionObservable.notifyObservers(e),e.onDisconnectionObservable.notifyObservers(this),this)}addExcludedConnectionPointFromAllowedTypes(e){let t=1;for(;t<p.All;)e&t||this.excludedConnectionPointTypes.push(t),t=t<<1}serialize(e=!0){const t={};return t.name=this.name,this.displayName&&(t.displayName=this.displayName),e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear(),this.onDisconnectionObservable.clear(),this.onTypeChangedObservable.clear(),this._connectedPoint=null,this._typeConnectionSource=null,this._linkedConnectionSource=null}_updateTypeDependentState(e){const t=this.type;e(),this.type!==t&&this._notifyTypeChanged()}_notifyTypeChanged(){this._isTypeChangeObservableNotifying||(this._isTypeChangeObservableNotifying=!0,this.onTypeChangedObservable.notifyObservers(this.type),this._isTypeChangeObservableNotifying=!1)}}class ie{get _isFinalOutputAndActive(){return this._isFinalOutput}get _hasPrecedence(){return!1}get name(){return this._name}get codeIsReady(){return this._codeIsReady}set name(e){this.validateBlockName(e)&&(this._name=e)}get isUnique(){return this._isUnique}get isFinalMerger(){return this._isFinalMerger}get isInput(){return this._isInput}get isTeleportOut(){return this._isTeleportOut}get isTeleportIn(){return this._isTeleportIn}get isLoop(){return this._isLoop}get buildId(){return this._buildId}set buildId(e){this._buildId=e}get target(){return this._target}set target(e){this._target&e||(this._target=e)}get inputs(){return this._inputs}get outputs(){return this._outputs}getInputByName(e){const t=this._inputs.filter(i=>i.name===e);return t.length?t[0]:null}getOutputByName(e){const t=this._outputs.filter(i=>i.name===e);return t.length?t[0]:null}constructor(e,t=P.Vertex,i=!1,r=!1){switch(this._isFinalMerger=!1,this._isInput=!1,this._isLoop=!1,this._isTeleportOut=!1,this._isTeleportIn=!1,this._name="",this._isUnique=!1,this._codeIsReady=!0,this._isFinalOutput=!1,this.onCodeIsReadyObservable=new k,this.inputsAreExclusive=!1,this._codeVariableName="",this._inputs=new Array,this._outputs=new Array,this.comments="",this.visibleInInspector=!1,this.visibleOnFrame=!1,this._target=t,this._originalTargetIsNeutral=t===P.Neutral,this._isFinalMerger=i,this._isFinalOutput=r,this.getClassName()){case"InputBlock":this._isInput=!0;break;case"NodeMaterialTeleportOutBlock":this._isTeleportOut=!0;break;case"NodeMaterialTeleportInBlock":this._isTeleportIn=!0;break;case"LoopBlock":this._isLoop=!0;break}this._name=e,this.uniqueId=bn.UniqueId}_setInitialTarget(e){this._target=e,this._originalTargetIsNeutral=e===P.Neutral}initialize(e){}bind(e,t,i,r){}_writeVariable(e){return e.connectedPoint?`${e.associatedVariableName}`:"0."}_writeFloat(e){let t=e.toString();return t.indexOf(".")===-1&&(t+=".0"),`${t}`}getClassName(){return"NodeMaterialBlock"}isConnectedInFragmentShader(){return this.outputs.some(e=>e.isConnectedInFragmentShader)}registerInput(e,t,i=!1,r,n){return n=n??new Ao(e,this,0),n.type=t,n.isOptional=i,r&&(n.target=r),this._inputs.push(n),this}registerOutput(e,t,i,r){return r=r??new Ao(e,this,1),r.type=t,i&&(r.target=i),this._outputs.push(r),this}getFirstAvailableInput(e=null){for(const t of this._inputs)if(!t.connectedPoint&&(!e||e.type===t.type||t.type===p.AutoDetect||t.acceptedConnectionPointTypes.indexOf(e.type)!==-1))return t;return null}getFirstAvailableOutput(e=null){for(const t of this._outputs)if(!e||!e.target||e.target===P.Neutral||e.target&t.target)return t;return null}getSiblingOutput(e){const t=this._outputs.indexOf(e);return t===-1||t>=this._outputs.length?null:this._outputs[t+1]}isAnAncestorOf(e){for(const t of this._outputs)if(t.hasEndpoints){for(const i of t.endpoints)if(i.ownerBlock===e||i.ownerBlock.isAnAncestorOf(e))return!0}return!1}connectTo(e,t){if(this._outputs.length===0)return;let i=t&&t.output?this.getOutputByName(t.output):this.getFirstAvailableOutput(e),r=!0;for(;r;){const n=t&&t.input?e.getInputByName(t.input):e.getFirstAvailableInput(i);if(i&&n&&i.canConnectTo(n))i.connectTo(n),r=!1;else if(i)i=this.getSiblingOutput(i);else throw"Unable to find a compatible match"}return this}_buildBlock(e){}_postBuildBlock(e){}updateUniformsAndSamples(e,t,i,r){}provideFallbacks(e,t){}initializeDefines(e){}prepareDefines(e,t,i,r=!1,n){}autoConfigure(e,t=()=>!0){}replaceRepeatableContent(e,t,i){}get willBeGeneratedIntoVertexShaderFromFragmentShader(){return this.isInput||this.isFinalMerger||this._outputs.some(e=>e.isDirectlyConnectedToVertexOutput)||this.target===P.Vertex?!1:!!((this.target===P.VertexAndFragment||this.target===P.Neutral)&&this._outputs.some(e=>e.isConnectedInVertexShader))}isReady(e,t,i,r=!1){return!0}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:(this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[e]._isMainLinkSource=!0),this._inputs[t]._linkedConnectionSource=this._inputs[e]}_processBuild(e,t,i,r){var o;e.build(t,r);const n=t._vertexState!=null,a=e._buildTarget===P.Vertex&&e.target!==P.VertexAndFragment;if(!(e.isTeleportOut&&((o=e.entryPoint)!=null&&o.isConnectedToUniform))&&n&&(!(e.target&e._buildTarget)||!(e.target&i.target)||this.target!==P.VertexAndFragment&&a)&&(!e.isInput&&t.target!==e._buildTarget||e.isInput&&e.isAttribute&&!e._noContextSwitch)){const l=i.connectedPoint;if(t._vertexState._emitVaryingFromString("v_"+l.declarationVariableName,l.type)){const u=t.shaderLanguage===1?"vertexOutputs.":"";t.shaderLanguage===1&&l.type===p.Matrix?(t._vertexState.compilationString+=`${u}${"v_"+l.declarationVariableName}_r0 = ${l.associatedVariableName}[0];
`,t._vertexState.compilationString+=`${u}${"v_"+l.declarationVariableName}_r1 = ${l.associatedVariableName}[1];
`,t._vertexState.compilationString+=`${u}${"v_"+l.declarationVariableName}_r2 = ${l.associatedVariableName}[2];
`,t._vertexState.compilationString+=`${u}${"v_"+l.declarationVariableName}_r3 = ${l.associatedVariableName}[3];
`):t._vertexState.compilationString+=`${u}${"v_"+l.declarationVariableName} = ${l.associatedVariableName};
`}const c=t.shaderLanguage===1&&l.type!==p.Matrix?"fragmentInputs.":"";i.associatedVariableName=c+"v_"+l.declarationVariableName,i._enforceAssociatedVariableName=!0}}validateBlockName(e){const t=["position","normal","tangent","particle_positionw","uv","uv2","uv3","uv4","uv5","uv6","position2d","particle_uv","postprocess_uv","matricesIndices","matricesWeights","world0","world1","world2","world3","particle_color","particle_texturemask"];for(const i of t)if(e===i)return!1;return!0}_customBuildStep(e,t){}build(e,t){if(this._buildId===e.sharedData.buildId)return!0;if(!this.isInput)for(const i of this._outputs)i.associatedVariableName||(i.associatedVariableName=e._getFreeVariableName(i.name));for(const i of this._inputs){if(!i.connectedPoint){i.isOptional||e.sharedData.checks.notConnectedNonOptionalInputs.push(i);continue}if(this.target!==P.Neutral&&(!(i.target&this.target)||!(i.target&e.target)))continue;const r=i.connectedPoint.ownerBlock;r&&r!==this&&this._processBuild(r,e,i,t)}if(this._customBuildStep(e,t),this._buildId===e.sharedData.buildId)return!0;if(e.sharedData.verbose&&N.Log(`${e.target===P.Vertex?"Vertex shader":"Fragment shader"}: Building ${this.name} [${this.getClassName()}]`),this.isFinalMerger)switch(e.target){case P.Vertex:e.sharedData.checks.emitVertex=!0;break;case P.Fragment:e.sharedData.checks.emitFragment=!0;break}!this.isInput&&e.sharedData.emitComments&&(e.compilationString+=`
//${this.name}
`),this._buildBlock(e),this._buildId=e.sharedData.buildId,this._buildTarget=e.target;for(const i of this._outputs)if(!i._forPostBuild&&i.target&e.target)for(const r of i.endpoints){const n=r.ownerBlock;n&&(n.target&e.target&&t.indexOf(n)!==-1||e._terminalBlocks.has(n))&&this._processBuild(n,e,r,t)}this._postBuildBlock(e);for(const i of this._outputs)if(i._forPostBuild&&i.target&e.target)for(const r of i.endpoints){const n=r.ownerBlock;n&&n.target&e.target&&t.indexOf(n)!==-1&&this._processBuild(n,e,r,t)}return!1}_inputRename(e){return e}_outputRename(e){return e}_dumpPropertiesCode(){const e=this._codeVariableName;return`${e}.visibleInInspector = ${this.visibleInInspector};
${e}.visibleOnFrame = ${this.visibleOnFrame};
${e}.target = ${this.target};
`}_dumpCode(e,t){t.push(this);const i=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=i||`${this.getClassName()}_${this.uniqueId}`,e.indexOf(this._codeVariableName)!==-1){let n=0;do n++,this._codeVariableName=i+n;while(e.indexOf(this._codeVariableName)!==-1)}e.push(this._codeVariableName);let r=`
// ${this.getClassName()}
`;this.comments&&(r+=`// ${this.comments}
`),r+=`var ${this._codeVariableName} = new BABYLON.${this.getClassName()}("${this.name}");
`,r+=this._dumpPropertiesCode();for(const n of this.inputs){if(!n.isConnected)continue;const o=n.connectedPoint.ownerBlock;t.indexOf(o)===-1&&(r+=o._dumpCode(e,t))}for(const n of this.outputs)if(n.hasEndpoints)for(const a of n.endpoints){const o=a.ownerBlock;o&&t.indexOf(o)===-1&&(r+=o._dumpCode(e,t))}return r}_dumpCodeForOutputConnections(e){let t="";if(e.indexOf(this)!==-1)return t;e.push(this);for(const i of this.inputs){if(!i.isConnected)continue;const r=i.connectedPoint,n=r.ownerBlock;t+=n._dumpCodeForOutputConnections(e),t+=`${n._codeVariableName}.${n._outputRename(r.name)}.connectTo(${this._codeVariableName}.${this._inputRename(i.name)});
`}return t}clone(e,t=""){const i=this.serialize(),r=ki(i.customType);if(r){const n=new r;return n._deserialize(i,e,t),n}return null}serialize(){const e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.comments=this.comments,e.visibleInInspector=this.visibleInInspector,e.visibleOnFrame=this.visibleOnFrame,e.target=this.target,e.inputs=[],e.outputs=[];for(const t of this.inputs)e.inputs.push(t.serialize());for(const t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e,t,i,r){this.name=e.name,this.comments=e.comments,this.visibleInInspector=!!e.visibleInInspector,this.visibleOnFrame=!!e.visibleOnFrame,this._target=e.target??this.target,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){const t=e.inputs,i=e.outputs;if(t)for(let r=0;r<t.length;r++){const n=t[r];n.displayName&&(this.inputs[r].displayName=n.displayName),n.isExposedOnFrame&&(this.inputs[r].isExposedOnFrame=n.isExposedOnFrame,this.inputs[r].exposedPortPosition=n.exposedPortPosition)}if(i)for(let r=0;r<i.length;r++){const n=i[r];n.displayName&&(this.outputs[r].displayName=n.displayName),n.isExposedOnFrame&&(this.outputs[r].isExposedOnFrame=n.isExposedOnFrame,this.outputs[r].exposedPortPosition=n.exposedPortPosition)}}dispose(){this.onCodeIsReadyObservable.clear();for(const e of this.inputs)e.dispose();for(const e of this.outputs)e.dispose()}}var Os;(function(s){s[s.NoColorSpace=0]="NoColorSpace",s[s.Gamma=1]="Gamma",s[s.Linear=2]="Linear"})(Os||(Os={}));class Mn extends ie{constructor(e){super(e,P.Fragment,!0,!0),this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this.useLogarithmicDepth=!1,this.registerInput("rgba",p.Color4,!0),this.registerInput("rgb",p.Color3,!0),this.registerInput("a",p.Float,!0),this.registerInput("glow",p.Color3,!0),this.rgb.acceptedConnectionPointTypes.push(p.Vector3),this.rgb.acceptedConnectionPointTypes.push(p.Float),this.additionalColor.acceptedConnectionPointTypes.push(p.Vector3),this.additionalColor.acceptedConnectionPointTypes.push(p.Float)}get colorSpace(){return this.convertToGammaSpace?Os.Gamma:this.convertToLinearSpace?Os.Linear:Os.NoColorSpace}set colorSpace(e){this.convertToGammaSpace=e===Os.Gamma,this.convertToLinearSpace=e===Os.Linear}getClassName(){return"FragmentOutputBlock"}initialize(e){e._excludeVariableName("logarithmicDepthConstant"),e._excludeVariableName("vFragmentDepth")}get rgba(){return this._inputs[0]}get rgb(){return this._inputs[1]}get a(){return this._inputs[2]}get additionalColor(){return this._inputs[3]}get glow(){return this._inputs[3]}_getOutputString(e){return e.shaderLanguage===1?"fragmentOutputsColor":"gl_FragColor"}prepareDefines(e,t){e.setValue(this._linearDefineName,this.convertToLinearSpace,!0),e.setValue(this._gammaDefineName,this.convertToGammaSpace,!0),e.setValue(this._additionalColorDefineName,this.additionalColor.connectedPoint&&t._useAdditionalColor,!0)}bind(e,t,i){(this.useLogarithmicDepth||t.useLogarithmicDepth)&&i&&Vo(void 0,e,i.getScene())}_buildBlock(e){super._buildBlock(e);const t=this.rgba,i=this.rgb,r=this.a,n=this.additionalColor,a=e.shaderLanguage===1;e.sharedData.hints.needAlphaBlending=t.isConnected||r.isConnected,e.sharedData.blocksWithDefines.push(this),(this.useLogarithmicDepth||e.sharedData.nodeMaterial.useLogarithmicDepth)&&(e._emitUniformFromString("logarithmicDepthConstant",p.Float),e._emitVaryingFromString("vFragmentDepth",p.Float),e.sharedData.bindableBlocks.push(this)),n.connectedPoint&&(e._excludeVariableName("useAdditionalColor"),e._emitUniformFromString("useAdditionalColor",p.Float),this._additionalColorDefineName=e._getFreeDefineName("USEADDITIONALCOLOR")),this._linearDefineName=e._getFreeDefineName("CONVERTTOLINEAR"),this._gammaDefineName=e._getFreeDefineName("CONVERTTOGAMMA");const o=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",o);const l=this._getOutputString(e);e.shaderLanguage===1&&(e.compilationString+=`var ${l} : vec4<f32>;\r
`);const c=e._getShaderType(p.Vector4);if(n.connectedPoint){let u="1.0";r.connectedPoint&&(u=r.associatedVariableName),e.compilationString+=`#ifdef ${this._additionalColorDefineName}
`,n.connectedPoint.type===p.Float?e.compilationString+=`${l}  = ${c}(${n.associatedVariableName}, ${n.associatedVariableName}, ${n.associatedVariableName}, ${u});
`:e.compilationString+=`${l}  = ${c}(${n.associatedVariableName}, ${u});
`,e.compilationString+=`#else
`}if(t.connectedPoint)r.isConnected?e.compilationString+=`${l} = ${c}(${t.associatedVariableName}.rgb, ${r.associatedVariableName});
`:e.compilationString+=`${l}  = ${t.associatedVariableName};
`;else if(i.connectedPoint){let u="1.0";r.connectedPoint&&(u=r.associatedVariableName),i.connectedPoint.type===p.Float?e.compilationString+=`${l}  = ${c}(${i.associatedVariableName}, ${i.associatedVariableName}, ${i.associatedVariableName}, ${u});
`:e.compilationString+=`${l}  = ${c}(${i.associatedVariableName}, ${u});
`}else e.sharedData.checks.notConnectedNonOptionalInputs.push(t);if(n.connectedPoint&&(e.compilationString+=`#endif
`),e.compilationString+=`#ifdef ${this._linearDefineName}
`,e.compilationString+=`${l}  = toLinearSpace(${l});
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef ${this._gammaDefineName}
`,e.compilationString+=`${l}  = toGammaSpace(${l});
`,e.compilationString+=`#endif
`,e.shaderLanguage===1&&(e.compilationString+=`#if !defined(PREPASS)\r
`,e.compilationString+=`fragmentOutputs.color = ${l};\r
`,e.compilationString+=`#endif\r
`),this.useLogarithmicDepth||e.sharedData.nodeMaterial.useLogarithmicDepth){const u=a?"input.vFragmentDepth":"vFragmentDepth",h=a?"uniforms.":"",d=a?"fragmentOutputs.fragDepth":"gl_FragDepthEXT";e.compilationString+=`${d} = log2(${u}) * ${h}logarithmicDepthConstant * 0.5;
`}return e.compilationString+=`#if defined(PREPASS)\r
`,e.compilationString+=`${a?"fragmentOutputs.fragData0":"gl_FragData[0]"} = ${l};\r
`,e.compilationString+=`#endif\r
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};
`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};
`,e+=`${this._codeVariableName}.useLogarithmicDepth = ${this.useLogarithmicDepth};
`,e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.useLogarithmicDepth=this.useLogarithmicDepth,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this.useLogarithmicDepth=e.useLogarithmicDepth??!1}}_([O("Use logarithmic depth",0,"PROPERTIES",{embedded:!0})],Mn.prototype,"useLogarithmicDepth",void 0);_([O("Color space",5,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"No color space",value:Os.NoColorSpace},{label:"Gamma",value:Os.Gamma},{label:"Linear",value:Os.Linear}]})],Mn.prototype,"colorSpace",null);y("BABYLON.FragmentOutputBlock",Mn);var mi;(function(s){s[s.Material=0]="Material",s[s.PostProcess=1]="PostProcess",s[s.Particle=2]="Particle",s[s.ProceduralTexture=3]="ProceduralTexture",s[s.GaussianSplatting=4]="GaussianSplatting",s[s.SFE=5]="SFE"})(mi||(mi={}));var ve;(function(s){s[s.World=1]="World",s[s.View=2]="View",s[s.Projection=3]="Projection",s[s.ViewProjection=4]="ViewProjection",s[s.WorldView=5]="WorldView",s[s.WorldViewProjection=6]="WorldViewProjection",s[s.CameraPosition=7]="CameraPosition",s[s.FogColor=8]="FogColor",s[s.DeltaTime=9]="DeltaTime",s[s.CameraParameters=10]="CameraParameters",s[s.MaterialAlpha=11]="MaterialAlpha",s[s.ProjectionInverse=12]="ProjectionInverse"})(ve||(ve={}));var sn;(function(s){s[s.None=0]="None",s[s.Time=1]="Time",s[s.RealTime=2]="RealTime",s[s.MouseInfo=3]="MouseInfo"})(sn||(sn={}));const BV={position2d:"position",particle_uv:"vUV",particle_color:"vColor",particle_texturemask:"textureMask",particle_positionw:"vPositionW",postprocess_uv:"vUV"},ed={particle_uv:!0,particle_color:!0,particle_texturemask:!0,particle_positionw:!0,postprocess_uv:!0},$v={particle_texturemask:!0},Xv={normal:"NORMAL",tangent:"TANGENT",uv:"UV1",uv2:"UV2",uv3:"UV3",uv4:"UV4",uv5:"UV5",uv6:"UV6",uv7:"UV7",uv8:"UV8"};class ge extends ie{get type(){if(this._type===p.AutoDetect){if(this.isUniform&&this.value!=null){if(!isNaN(this.value))return this._type=p.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=p.Vector2,this._type;case"Vector3":return this._type=p.Vector3,this._type;case"Vector4":return this._type=p.Vector4,this._type;case"Color3":return this._type=p.Color3,this._type;case"Color4":return this._type=p.Color4,this._type;case"Matrix":return this._type=p.Matrix,this._type}}if(this.isAttribute)switch(this.name){case"splatIndex":return this._type=p.Float,this._type;case"position":case"normal":case"particle_positionw":case"splatPosition":return this._type=p.Vector3,this._type;case"uv":case"uv2":case"uv3":case"uv4":case"uv5":case"uv6":case"position2d":case"particle_uv":case"splatScale":case"postprocess_uv":return this._type=p.Vector2,this._type;case"matricesIndices":case"matricesWeights":case"matricesIndicesExtra":case"matricesWeightsExtra":case"world0":case"world1":case"world2":case"world3":case"tangent":return this._type=p.Vector4,this._type;case"color":case"instanceColor":case"particle_color":case"particle_texturemask":case"splatColor":return this._type=p.Color4,this._type}if(this.isSystemValue)switch(this._systemValue){case ve.World:case ve.WorldView:case ve.WorldViewProjection:case ve.View:case ve.ViewProjection:case ve.Projection:case ve.ProjectionInverse:return this._type=p.Matrix,this._type;case ve.CameraPosition:return this._type=p.Vector3,this._type;case ve.FogColor:return this._type=p.Color3,this._type;case ve.DeltaTime:case ve.MaterialAlpha:return this._type=p.Float,this._type;case ve.CameraParameters:return this._type=p.Vector4,this._type}}return this._type}constructor(e,t=P.Vertex,i=p.AutoDetect){super(e,t,!1),this._mode=3,this._animationType=sn.None,this._prefix="",this.min=0,this.max=0,this.isBoolean=!1,this.matrixMode=0,this._systemValue=null,this.isConstant=!1,this.groupInInspector="",this.onValueChangedObservable=new k,this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._type=i,this.setDefaultValue(),this.registerOutput("output",i)}validateBlockName(e){return this.isAttribute?!0:super.validateBlockName(e)}get output(){return this._outputs[0]}setAsAttribute(e){return this._mode=1,e&&(this.name=e),this}setAsSystemValue(e){return this.systemValue=e,this}get value(){return this._storedValue}set value(e){this.type===p.Float&&(this.isBoolean?e=e?1:0:this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e))),this._storedValue=e,this._mode=0,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this._valueCallback}set valueCallback(e){this._valueCallback=e,this._mode=0}get declarationVariableName(){return this._associatedVariableName}get associatedVariableName(){return this._prefix+this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get animationType(){return this._animationType}set animationType(e){this._animationType=e}get isUndefined(){return this._mode===3}get isUniform(){return this._mode===0}set isUniform(e){this._mode=e?0:3,this.associatedVariableName=""}get isAttribute(){return this._mode===1}set isAttribute(e){this._mode=e?1:3,this.associatedVariableName=""}get isVarying(){return this._mode===2}set isVarying(e){this._mode=e?2:3,this.associatedVariableName=""}get isSystemValue(){return this._systemValue!=null}get systemValue(){return this._systemValue}set systemValue(e){this._mode=0,this.associatedVariableName="",this._systemValue=e}getClassName(){return"InputBlock"}animate(e){switch(this._animationType){case sn.Time:{this.type===p.Float&&(this.value+=e.getAnimationRatio()*.01);break}case sn.RealTime:{this.type===p.Float&&(this.value=(Qr.Now-e.getEngine().startTime)/1e3);break}case sn.MouseInfo:{if(this.type===p.Vector4){const t=e._inputManager._originMouseEvent;if(t){const i=t.offsetX,r=t.offsetY,n=t.buttons&1?1:0,a=t.buttons&2?1:0;this.value=new Ee(i,r,n,a)}else this.value=new Ee(0,0,0,0)}break}}}_emitDefine(e,t=!1){return`${t?"#ifndef":"#ifdef"} ${e}
`}initialize(){this.associatedVariableName=""}setDefaultValue(){switch(this.type){case p.Float:this.value=0;break;case p.Vector2:this.value=X.Zero();break;case p.Vector3:this.value=x.Zero();break;case p.Vector4:this.value=Ee.Zero();break;case p.Color3:this.value=q.White();break;case p.Color4:this.value=new Te(1,1,1,1);break;case p.Matrix:this.value=z.Identity();break}}_emitConstant(e){switch(this.type){case p.Float:return`${e._emitFloat(this.value)}`;case p.Vector2:return`vec2(${this.value.x}, ${this.value.y})`;case p.Vector3:return`vec3(${this.value.x}, ${this.value.y}, ${this.value.z})`;case p.Vector4:return`vec4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;case p.Color3:return st.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&st.Color3[0].toGammaSpaceToRef(st.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&st.Color3[0].toLinearSpaceToRef(st.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec3(${st.Color3[0].r}, ${st.Color3[0].g}, ${st.Color3[0].b})`;case p.Color4:return st.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&st.Color4[0].toGammaSpaceToRef(st.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&st.Color4[0].toLinearSpaceToRef(st.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec4(${st.Color4[0].r}, ${st.Color4[0].g}, ${st.Color4[0].b}, ${st.Color4[0].a})`}return""}get _noContextSwitch(){return ed[this.name]}_emit(e){if(this.isUniform){if(this._associatedVariableName||(this._associatedVariableName=e._getFreeVariableName("u_"+this.name)),this.isConstant){if(e.constants.indexOf(this.associatedVariableName)!==-1)return;e.constants.push(this.associatedVariableName),e._constantDeclaration+=e._declareOutput(this.output,!0)+` = ${this._emitConstant(e)};
`;return}if(e.uniforms.indexOf(this.associatedVariableName)!==-1)return;e._emitUniformFromString(this._associatedVariableName,this.type),e.shaderLanguage===1&&(this._prefix="uniforms.");const t=e.sharedData.hints;if(this._systemValue!==null&&this._systemValue!==void 0)switch(this._systemValue){case ve.WorldView:t.needWorldViewMatrix=!0;break;case ve.WorldViewProjection:t.needWorldViewProjectionMatrix=!0;break}else this._animationType!==sn.None&&e.sharedData.animatedInputs.push(this);return}if(this.isAttribute){if(this.associatedVariableName=BV[this.name]??this.name,this.target===P.Vertex&&e._vertexState){ed[this.name]?$v[this.name]?(e._emitUniformFromString(this.declarationVariableName,this.type),e.shaderLanguage===1&&(this._prefix="vertexInputs.")):e._emitVaryingFromString(this.declarationVariableName,this.type):this._emit(e._vertexState);return}const t=e.attributes.indexOf(this.declarationVariableName)!==-1;if(t||e.attributes.push(this.declarationVariableName),ed[this.name])$v[this.name]?(t||e._emitUniformFromString(this.declarationVariableName,this.type),e.shaderLanguage===1&&(this._prefix="uniforms.")):(t||e._emitVaryingFromString(this.declarationVariableName,this.type),e.shaderLanguage===1&&(this._prefix="fragmentInputs."));else if(e.shaderLanguage===1){if(!t){const i=Xv[this.name];i?(e._attributeDeclaration+=this._emitDefine(i),e._attributeDeclaration+=`attribute ${this.declarationVariableName}: ${e._getShaderType(this.type)};
`,e._attributeDeclaration+=`#else
`,e._attributeDeclaration+=`var<private> ${this.declarationVariableName}: ${e._getShaderType(this.type)} = ${e._getShaderType(this.type)}(0.);
`,e._attributeDeclaration+=`#endif
`):e._attributeDeclaration+=`attribute ${this.declarationVariableName}: ${e._getShaderType(this.type)};
`}this._prefix="vertexInputs."}else if(!t){const i=Xv[this.name];i?(e._attributeDeclaration+=this._emitDefine(i),e._attributeDeclaration+=`attribute ${e._getShaderType(this.type)} ${this.declarationVariableName};
`,e._attributeDeclaration+=`#else
`,e._attributeDeclaration+=`${e._getShaderType(this.type)} ${this.declarationVariableName} = ${e._getShaderType(this.type)}(0.);
`,e._attributeDeclaration+=`#endif
`):e._attributeDeclaration+=`attribute ${e._getShaderType(this.type)} ${this.declarationVariableName};
`}}}_transmitWorld(e,t,i,r){if(!this._systemValue)return;const n=this._associatedVariableName;switch(this._systemValue){case ve.World:e.setMatrix(n,t);break;case ve.WorldView:e.setMatrix(n,i);break;case ve.WorldViewProjection:e.setMatrix(n,r);break}}_transmit(e,t,i){if(this.isAttribute)return;const r=this._associatedVariableName;if(this._systemValue){switch(this._systemValue){case ve.World:case ve.WorldView:case ve.WorldViewProjection:return;case ve.View:e.setMatrix(r,t.getViewMatrix());break;case ve.Projection:e.setMatrix(r,t.getProjectionMatrix());break;case ve.ProjectionInverse:{t.getProjectionMatrix().invertToRef(G.Matrix[0]),e.setMatrix(r,G.Matrix[0]);break}case ve.ViewProjection:e.setMatrix(r,t.getTransformMatrix());break;case ve.CameraPosition:t.bindEyePosition(e,r,!0);break;case ve.FogColor:e.setColor3(r,t.fogColor);break;case ve.DeltaTime:e.setFloat(r,t.deltaTime/1e3);break;case ve.CameraParameters:t.activeCamera&&e.setFloat4(r,t.getEngine().hasOriginBottomLeft?-1:1,t.activeCamera.minZ,t.activeCamera.maxZ,1/t.activeCamera.maxZ);break;case ve.MaterialAlpha:e.setFloat(r,i.alpha);break}return}const n=this._valueCallback?this._valueCallback():this._storedValue;if(n!==null)switch(this.type){case p.Float:e.setFloat(r,n);break;case p.Int:e.setInt(r,n);break;case p.Color3:st.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&st.Color3[0].toGammaSpaceToRef(st.Color3[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&st.Color3[0].toLinearSpaceToRef(st.Color3[0],t.getEngine().useExactSrgbConversions),e.setColor3(r,st.Color3[0]);break;case p.Color4:st.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&st.Color4[0].toGammaSpaceToRef(st.Color4[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&st.Color4[0].toLinearSpaceToRef(st.Color4[0],t.getEngine().useExactSrgbConversions),e.setDirectColor4(r,st.Color4[0]);break;case p.Vector2:e.setVector2(r,n);break;case p.Vector3:e.setVector3(r,n);break;case p.Vector4:e.setVector4(r,n);break;case p.Matrix:e.setMatrix(r,n);break}}_buildBlock(e){super._buildBlock(e),(this.isUniform||this.isSystemValue)&&e.sharedData.inputBlocks.push(this),this._emit(e)}_dumpPropertiesCode(){const e=this._codeVariableName;if(this.isAttribute)return super._dumpPropertiesCode()+`${e}.setAsAttribute("${this.name}");
`;if(this.isSystemValue)return super._dumpPropertiesCode()+`${e}.setAsSystemValue(BABYLON.NodeMaterialSystemValues.${ve[this._systemValue]});
`;if(this.isUniform){const t=[];let i="";switch(this.type){case p.Float:i=`${this.value}`;break;case p.Vector2:i=`new BABYLON.Vector2(${this.value.x}, ${this.value.y})`;break;case p.Vector3:i=`new BABYLON.Vector3(${this.value.x}, ${this.value.y}, ${this.value.z})`;break;case p.Vector4:i=`new BABYLON.Vector4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;break;case p.Color3:i=`new BABYLON.Color3(${this.value.r}, ${this.value.g}, ${this.value.b})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case p.Color4:i=`new BABYLON.Color4(${this.value.r}, ${this.value.g}, ${this.value.b}, ${this.value.a})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case p.Matrix:i=`BABYLON.Matrix.FromArray([${this.value.m.join(", ")}])`;break}return t.push(`${e}.value = ${i}`),this.type===p.Float&&t.push(`${e}.min = ${this.min}`,`${e}.max = ${this.max}`,`${e}.isBoolean = ${this.isBoolean}`,`${e}.matrixMode = ${this.matrixMode}`,`${e}.animationType = BABYLON.AnimatedInputBlockTypes.${sn[this.animationType]}`),t.push(`${e}.isConstant = ${this.isConstant}`),t.push(""),super._dumpPropertiesCode()+t.join(`;
`)}return super._dumpPropertiesCode()}dispose(){this.onValueChangedObservable.clear(),super.dispose()}serialize(){const e=super.serialize();return e.type=this.type,e.mode=this._mode,e.systemValue=this._systemValue,e.animationType=this._animationType,e.min=this.min,e.max=this.max,e.isBoolean=this.isBoolean,e.matrixMode=this.matrixMode,e.isConstant=this.isConstant,e.groupInInspector=this.groupInInspector,e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this._storedValue!=null&&this._mode===0&&(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e}_deserialize(e,t,i){if(this._mode=e.mode,super._deserialize(e,t,i),this._type=e.type,this._systemValue=e.systemValue||e.wellKnownValue,this._animationType=e.animationType,this.min=e.min||0,this.max=e.max||0,this.isBoolean=!!e.isBoolean,this.matrixMode=e.matrixMode||0,this.isConstant=!!e.isConstant,this.groupInInspector=e.groupInInspector||"",this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.name==="tangent"&&e.mode===1&&e.type===p.Vector3&&(this._type=p.Vector4),!!e.valueType)if(e.valueType==="number")this._storedValue=e.value;else{const r=ki(e.valueType);r&&(this._storedValue=r.FromArray(e.value))}}}y("BABYLON.InputBlock",ge);class GR extends ie{get associatedVariableName(){return this._varName}constructor(e){super(e,P.Fragment),this.registerOutput("xy",p.Vector2,P.Fragment),this.registerOutput("x",p.Float,P.Fragment),this.registerOutput("y",p.Float,P.Fragment)}getClassName(){return"ScreenSizeBlock"}get xy(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}bind(e){const t=this._scene.getEngine();e.setFloat2(this._varName,t.getRenderWidth(),t.getRenderHeight())}writeOutputs(e,t){let i="";for(const r of this._outputs)r.hasEndpoints&&(i+=`${e._declareOutput(r)} = ${t}.${r.name};
`);return i}_buildBlock(e){if(super._buildBlock(e),this._scene=e.sharedData.scene,e.target===P.Vertex)return e.sharedData.raiseBuildError("ScreenSizeBlock must only be used in a fragment shader"),this;e.sharedData.bindableBlocks.push(this),this._varName=e._getFreeVariableName("screenSize"),e._emitUniformFromString(this._varName,p.Vector2);const t=e.shaderLanguage===1?"uniforms.":"";return e.compilationString+=this.writeOutputs(e,t+this._varName),this}}y("BABYLON.ScreenSizeBlock",GR);const ru="USE_SFE_FRAMEWORK";class VV extends Mn{constructor(e){super(e)}getClassName(){return"SmartFilterFragmentOutputBlock"}initialize(e){super.initialize(e),e.sharedData.nodeMaterial.mode!==mi.SFE&&e.sharedData.raiseBuildError("SmartFilterFragmentOutputBlock should not be used outside of SFE mode."),e.sharedData.nodeMaterial.shaderLanguage!==0&&e.sharedData.raiseBuildError("WebGPU is not supported in SmartFilters mode."),e.sharedData.formatConfig.getUniformAnnotation||(e.sharedData.formatConfig.getUniformAnnotation=t=>{for(const i of e.sharedData.nodeMaterial.attachedBlocks){if(i instanceof ge&&i.isUniform&&i.associatedVariableName===t)return this._generateInputBlockAnnotation(i);if(i instanceof GR&&i.associatedVariableName===t)return this._generateScreenSizeBlockAnnotation()}return""}),e.sharedData.formatConfig.formatVariablename=t=>{let i=t;return i.length>1&&i[1]==="_"&&(i=i.substring(2)),i.replace(/[^a-zA-Z]+/g,"")}}_generateInputBlockAnnotation(e){const t=e.valueCallback?e.valueCallback():e.value;return`// { "default": ${JSON.stringify(t)} }
`}_generateScreenSizeBlockAnnotation(){return`// { "autoBind": "outputResolution" }
`}_getMainUvName(e){const t=e.sharedData.nodeMaterial.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="postprocess_uv");return!t||!t.isAnAncestorOf(this)?"":t.associatedVariableName}_getOutputString(){return"outColor"}_buildBlock(e){super._buildBlock(e);const t=this._getOutputString();return e._customEntryHeader+=`#ifdef ${ru}
`,e._customEntryHeader+=`vec4 nmeMain(vec2 ${this._getMainUvName(e)}) { // main
`,e._customEntryHeader+=`#else
`,e._customEntryHeader+=`void main(void) {
`,e._customEntryHeader+=`#endif
`,e._customEntryHeader+=`vec4 ${t} = vec4(0.0);
`,e.compilationString+=`
#ifndef ${ru}
`,e.compilationString+=`gl_FragColor = ${t};
`,e.compilationString+=`#else
`,e.compilationString+=`return ${t};
`,e.compilationString+=`#endif
`,this}}y("BABYLON.SmartFilterFragmentOutputBlock",VV);class su extends ie{get transformAsDirection(){return this.complementW===0}set transformAsDirection(e){this.complementW=e?0:1}constructor(e){super(e,P.Neutral),this.complementW=1,this.complementZ=0,this.target=P.Vertex,this.registerInput("vector",p.AutoDetect),this.registerInput("transform",p.Matrix),this.registerOutput("output",p.Vector4),this.registerOutput("xyz",p.Vector3),this._inputs[0].onConnectionObservable.add(t=>{if(t.ownerBlock.isInput){const i=t.ownerBlock;(i.name==="normal"||i.name==="tangent")&&(this.complementW=0)}})}getClassName(){return"TransformBlock"}get vector(){return this._inputs[0]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}get transform(){return this._inputs[1]}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=this.transform,r=e._getShaderType(p.Vector4),n=e._getShaderType(p.Vector3);if(t.connectedPoint){if(this.complementW===0||this.transformAsDirection){const a=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",a),e.sharedData.blocksWithDefines.push(this);const o=e._getFreeVariableName(`${i.associatedVariableName}_NUS`);switch(e.shaderLanguage===1?e.compilationString+=`var ${o}: mat3x3f = mat3x3f(${i.associatedVariableName}[0].xyz, ${i.associatedVariableName}[1].xyz, ${i.associatedVariableName}[2].xyz);
`:e.compilationString+=`mat3 ${o} = mat3(${i.associatedVariableName});
`,e.compilationString+=`#ifdef NONUNIFORMSCALING
`,e.compilationString+=`${o} = transposeMat3(inverseMat3(${o}));
`,e.compilationString+=`#endif
`,t.connectedPoint.type){case p.Vector2:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${o} * ${n}(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}), ${this._writeFloat(this.complementW)});
`;break;case p.Vector3:case p.Color3:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${o} * ${t.associatedVariableName}, ${this._writeFloat(this.complementW)});
`;break;default:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${o} * ${t.associatedVariableName}.xyz, ${this._writeFloat(this.complementW)});
`;break}}else{const a=i.associatedVariableName;switch(t.connectedPoint.type){case p.Vector2:e.compilationString+=e._declareOutput(this.output)+` = ${a} * ${r}(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}, ${this._writeFloat(this.complementW)});
`;break;case p.Vector3:case p.Color3:e.compilationString+=e._declareOutput(this.output)+` = ${a} * ${r}(${t.associatedVariableName}, ${this._writeFloat(this.complementW)});
`;break;default:e.compilationString+=e._declareOutput(this.output)+` = ${a} * ${t.associatedVariableName};
`;break}}this.xyz.hasEndpoints&&(e.compilationString+=e._declareOutput(this.xyz)+` = ${this.output.associatedVariableName}.xyz;
`)}return this}prepareDefines(e,t,i){i&&i.nonUniformScaling&&e.setValue("NONUNIFORMSCALING",!0)}serialize(){const e=super.serialize();return e.complementZ=this.complementZ,e.complementW=this.complementW,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.complementZ=e.complementZ!==void 0?e.complementZ:0,this.complementW=e.complementW!==void 0?e.complementW:1}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.complementZ = ${this.complementZ};
`;return e+=`${this._codeVariableName}.complementW = ${this.complementW};
`,e}}_([O("Transform as direction",0,void 0,{embedded:!0})],su.prototype,"transformAsDirection",null);y("BABYLON.TransformBlock",su);class zc extends ie{constructor(e){super(e,P.Vertex,!0),this.registerInput("vector",p.Vector4)}getClassName(){return"VertexOutputBlock"}get vector(){return this._inputs[0]}_isLogarithmicDepthEnabled(e,t){if(t)return!0;for(const i of e)if(i.useLogarithmicDepth)return!0;return!1}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=e.shaderLanguage===1;if(e.shaderLanguage===1?e.compilationString+=`vertexOutputs.position = ${t.associatedVariableName};
`:e.compilationString+=`gl_Position = ${t.associatedVariableName};
`,this._isLogarithmicDepthEnabled(e.sharedData.fragmentOutputNodes,e.sharedData.nodeMaterial.useLogarithmicDepth)){e._emitUniformFromString("logarithmicDepthConstant",p.Float),e._emitVaryingFromString("vFragmentDepth",p.Float);const r=i?"vertexOutputs.vFragmentDepth":"vFragmentDepth",n=i?"uniforms.":"",a=i?"vertexOutputs.position":"gl_Position";e.compilationString+=`${r} = 1.0 + ${a}.w;
`,e.compilationString+=`${a}.z = log2(max(0.000001, ${r})) * ${n}logarithmicDepthConstant;
`}return this}}y("BABYLON.VertexOutputBlock",zc);class A_ extends ie{get samplerName(){return this._samplerName}get texture(){return this._texture}set texture(e){this._texture=e}constructor(e){super(e,P.VertexAndFragment),this._samplerName="textureSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",p.AutoDetect,!1,P.VertexAndFragment),this.registerOutput("rgba",p.Color4,P.Neutral),this.registerOutput("rgb",p.Color3,P.Neutral),this.registerOutput("r",p.Float,P.Neutral),this.registerOutput("g",p.Float,P.Neutral),this.registerOutput("b",p.Float,P.Neutral),this.registerOutput("a",p.Float,P.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(p.Vector2|p.Vector3|p.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"CurrentScreenBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName(this.samplerName)}get target(){return!this.uv.isConnected||this.uv.sourceBlock.isInput?P.VertexAndFragment:P.Fragment}prepareDefines(e){e.setValue(this._linearDefineName,this.convertToGammaSpace,!0),e.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_getMainUvName(e){return"vMain"+this.uv.associatedVariableName}_injectVertexCode(e){const t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,p.Vector2)),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;
`,!!this._outputs.some(i=>i.isConnectedInVertexShader)){this._writeTextureRead(e,!0);for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name,!0)}}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===P.Fragment)return;const n=e.shaderLanguage===0?`texture2D(${this.samplerName},`:`textureSampleLevel(${this.samplerName}, ${this.samplerName+"Sampler"},`,a=e.shaderLanguage===0?"":", 0";e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,p.Vector4)} = ${n} ${i.associatedVariableName}${a});
`;return}const r=e.shaderLanguage===0?`texture2D(${this.samplerName},`:`textureSample(${this.samplerName}, ${this.samplerName+"Sampler"},`;if(this.uv.ownerBlock.target===P.Fragment){e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,p.Vector4)} = ${r} ${i.associatedVariableName});
`;return}e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,p.Vector4)} = ${r} ${this._mainUVName});
`}_writeOutput(e,t,i,r=!1){if(r){if(e.target===P.Fragment)return;e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`;return}if(this.uv.ownerBlock.target===P.Fragment){e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`;return}e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`,e.compilationString+=`#ifdef ${this._linearDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef ${this._gammaDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`}_emitUvAndSampler(e){e._emitVaryingFromString(this._mainUVName,p.Vector2),e._emit2DSampler(this.samplerName)}_buildBlock(e){if(super._buildBlock(e),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.blockingBlocks.indexOf(this)<0&&e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.indexOf(this)<0&&e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.indexOf(this)<0&&e.sharedData.blocksWithDefines.push(this),this._mainUVName=this._getMainUvName(e),this._emitUvAndSampler(e),e.target!==P.Fragment){this._injectVertexCode(e);return}if(!this._outputs.some(i=>i.isConnectedInFragmentShader))return;this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),this._writeTextureRead(e);for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name);return this}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=$.Parse(e.texture,t,i))}}y("BABYLON.CurrentScreenBlock",A_);class zR extends ie{constructor(e){super(e,P.Fragment),this._samplerName="diffuseSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",p.AutoDetect,!1,P.VertexAndFragment),this.registerOutput("rgba",p.Color4,P.Neutral),this.registerOutput("rgb",p.Color3,P.Neutral),this.registerOutput("r",p.Float,P.Neutral),this.registerOutput("g",p.Float,P.Neutral),this.registerOutput("b",p.Float,P.Neutral),this.registerOutput("a",p.Float,P.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(p.Vector2|p.Vector3|p.Vector4)}getClassName(){return"ParticleTextureBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName("diffuseSampler")}autoConfigure(e,t=()=>!0){if(!this.uv.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="particle_uv"&&t(r));i||(i=new ge("uv"),i.setAsAttribute("particle_uv")),i.output.connectTo(this.uv)}}prepareDefines(e){e.setValue(this._linearDefineName,this.convertToGammaSpace,!0),e.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_writeOutput(e,t,i){e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`,e.compilationString+=`#ifdef ${this._linearDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef ${this._gammaDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`}_buildBlock(e){if(super._buildBlock(e),e.target===P.Vertex)return;this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e._emit2DSampler(this._samplerName),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,p.Vector4)} = ${e._generateTextureSample(this.uv.associatedVariableName,this._samplerName)};
`;for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name);return this}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=$.Parse(e.texture,t,i))}}y("BABYLON.ParticleTextureBlock",zR);class WR extends ie{constructor(e){super(e,P.Fragment),this._isUnique=!0,this.registerInput("color",p.Color4,!1,P.Fragment),this.registerOutput("rampColor",p.Color4,P.Fragment)}getClassName(){return"ParticleRampGradientBlock"}get color(){return this._inputs[0]}get rampColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("remapRanges"),e._excludeVariableName("rampSampler"),e._excludeVariableName("baseColor"),e._excludeVariableName("alpha"),e._excludeVariableName("remappedColorIndex"),e._excludeVariableName("rampColor")}_buildBlock(e){if(super._buildBlock(e),e.target===P.Vertex)return;e._emit2DSampler("rampSampler","RAMPGRADIENT"),e._emitVaryingFromString("remapRanges",p.Vector4,"RAMPGRADIENT");const t=e.shaderLanguage===0?"":"fragmentInputs.";return e.compilationString+=`
            #ifdef RAMPGRADIENT
                ${e._declareLocalVar("baseColor",p.Vector4)} = ${this.color.associatedVariableName};
                ${e._declareLocalVar("alpha",p.Float)} = ${this.color.associatedVariableName}.a;

                ${e._declareLocalVar("remappedColorIndex",p.Float)} = clamp((alpha - ${t}remapRanges.x) / ${t}remapRanges.y, 0.0, 1.0);

                ${e._declareLocalVar("rampColor",p.Vector4)} = ${e._generateTextureSample("vec2(1.0 - remappedColorIndex, 0.)","rampSampler")};

                // Remapped alpha
                ${e._declareOutput(this.rampColor)} = vec4${e.fSuffix}(baseColor.rgb * rampColor.rgb, clamp((alpha * rampColor.a - ${t}remapRanges.z) / ${t}remapRanges.w, 0.0, 1.0));
            #else
                ${e._declareOutput(this.rampColor)} = ${this.color.associatedVariableName};
            #endif
        `,this}}y("BABYLON.ParticleRampGradientBlock",WR);class HR extends ie{constructor(e){super(e,P.Fragment),this._isUnique=!0,this.registerInput("color",p.Color4,!1,P.Fragment),this.registerInput("alphaTexture",p.Float,!1,P.Fragment),this.registerInput("alphaColor",p.Float,!1,P.Fragment),this.registerOutput("blendColor",p.Color4,P.Fragment)}getClassName(){return"ParticleBlendMultiplyBlock"}get color(){return this._inputs[0]}get alphaTexture(){return this._inputs[1]}get alphaColor(){return this._inputs[2]}get blendColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("sourceAlpha")}_buildBlock(e){if(super._buildBlock(e),e.target!==P.Vertex)return e.compilationString+=`
            #ifdef BLENDMULTIPLYMODE
                ${e._declareOutput(this.blendColor)};
                ${e._declareLocalVar("sourceAlpha",p.Float)}  = ${this.alphaColor.associatedVariableName} * ${this.alphaTexture.associatedVariableName};
                ${this.blendColor.associatedVariableName} = vec4${e.fSuffix}(${this.color.associatedVariableName}.rgb * sourceAlpha + vec3(1.0) * (1.0 - sourceAlpha), ${this.color.associatedVariableName}.a);
            #else
                ${e._declareOutput(this.blendColor)} = ${this.color.associatedVariableName};
            #endif
        `,this}}y("BABYLON.ParticleBlendMultiplyBlock",HR);class Wc extends ie{constructor(e){super(e,P.Neutral),this.xSwizzle="x",this.ySwizzle="y",this.zSwizzle="z",this.wSwizzle="w",this.registerInput("xyzw ",p.Vector4,!0),this.registerInput("xyz ",p.Vector3,!0),this.registerInput("xy ",p.Vector2,!0),this.registerInput("zw ",p.Vector2,!0),this.registerInput("x",p.Float,!0),this.registerInput("y",p.Float,!0),this.registerInput("z",p.Float,!0),this.registerInput("w",p.Float,!0),this.registerOutput("xyzw",p.Vector4),this.registerOutput("xyz",p.Vector3),this.registerOutput("xy",p.Vector2),this.registerOutput("zw",p.Vector2)}getClassName(){return"VectorMergerBlock"}get xyzwIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get x(){return this._inputs[4]}get y(){return this._inputs[5]}get z(){return this._inputs[6]}get w(){return this._inputs[7]}get xyzw(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xy(){return this.xyOut}get xyz(){return this.xyzOut}_inputRename(e){return e==="xyzw "?"xyzwIn":e==="xyz "?"xyzIn":e==="xy "?"xyIn":e==="zw "?"zwIn":e}_buildSwizzle(e){return"."+(this.xSwizzle+this.ySwizzle+this.zSwizzle+this.wSwizzle).substring(0,e)}_buildBlock(e){super._buildBlock(e);const t=this.x,i=this.y,r=this.z,n=this.w,a=this.xyIn,o=this.zwIn,l=this.xyzIn,c=this.xyzwIn,u=this._outputs[0],h=this._outputs[1],d=this._outputs[2],f=this._outputs[3],m=e._getShaderType(p.Vector4),g=e._getShaderType(p.Vector3),v=e._getShaderType(p.Vector2);return c.isConnected?(u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${c.associatedVariableName}${this._buildSwizzle(4)};
`),h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${c.associatedVariableName}${this._buildSwizzle(3)};
`),d.hasEndpoints&&(e.compilationString+=e._declareOutput(d)+` = ${c.associatedVariableName}${this._buildSwizzle(2)};
`)):l.isConnected?(u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${m}(${l.associatedVariableName}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(4)};
`),h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${l.associatedVariableName}${this._buildSwizzle(3)};
`),d.hasEndpoints&&(e.compilationString+=e._declareOutput(d)+` = ${l.associatedVariableName}${this._buildSwizzle(2)};
`)):a.isConnected?(u.hasEndpoints&&(o.isConnected?e.compilationString+=e._declareOutput(u)+` = ${m}(${a.associatedVariableName}, ${o.associatedVariableName})${this._buildSwizzle(4)};
`:e.compilationString+=e._declareOutput(u)+` = ${m}(${a.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(4)};
`),h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${g}(${a.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};
`),d.hasEndpoints&&(e.compilationString+=e._declareOutput(d)+` = ${a.associatedVariableName}${this._buildSwizzle(2)};
`),f.hasEndpoints&&(o.isConnected?e.compilationString+=e._declareOutput(f)+` = ${o.associatedVariableName}${this._buildSwizzle(2)};
`:e.compilationString+=e._declareOutput(f)+` = ${v}(${r.isConnected?this._writeVariable(r):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(2)};
`)):(u.hasEndpoints&&(o.isConnected?e.compilationString+=e._declareOutput(u)+` = ${m}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${o.associatedVariableName})${this._buildSwizzle(4)};
`:e.compilationString+=e._declareOutput(u)+` = ${m}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(4)};
`),h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${g}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};
`),d.hasEndpoints&&(e.compilationString+=e._declareOutput(d)+` = ${v}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"})${this._buildSwizzle(2)};
`),f.hasEndpoints&&(o.isConnected?e.compilationString+=e._declareOutput(f)+` = ${o.associatedVariableName}${this._buildSwizzle(2)};
`:e.compilationString+=e._declareOutput(f)+` = ${v}(${r.isConnected?this._writeVariable(r):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(2)};
`)),this}serialize(){const e=super.serialize();return e.xSwizzle=this.xSwizzle,e.ySwizzle=this.ySwizzle,e.zSwizzle=this.zSwizzle,e.wSwizzle=this.wSwizzle,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.xSwizzle=e.xSwizzle??"x",this.ySwizzle=e.ySwizzle??"y",this.zSwizzle=e.zSwizzle??"z",this.wSwizzle=e.wSwizzle??"w"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.xSwizzle = "${this.xSwizzle}";
`,e+=`${this._codeVariableName}.ySwizzle = "${this.ySwizzle}";
`,e+=`${this._codeVariableName}.zSwizzle = "${this.zSwizzle}";
`,e+=`${this._codeVariableName}.wSwizzle = "${this.wSwizzle}";
`,e}}y("BABYLON.VectorMergerBlock",Wc);class Sh extends ie{constructor(e){super(e,P.Neutral),this.sourceRange=new X(-1,1),this.targetRange=new X(0,1),this.registerInput("input",p.AutoDetect),this.registerInput("sourceMin",p.Float,!0),this.registerInput("sourceMax",p.Float,!0),this.registerInput("targetMin",p.Float,!0),this.registerInput("targetMax",p.Float,!0),this.registerOutput("output",p.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"RemapBlock"}get input(){return this._inputs[0]}get sourceMin(){return this._inputs[1]}get sourceMax(){return this._inputs[2]}get targetMin(){return this._inputs[3]}get targetMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.sourceMin.isConnected?this.sourceMin.associatedVariableName:this._writeFloat(this.sourceRange.x),r=this.sourceMax.isConnected?this.sourceMax.associatedVariableName:this._writeFloat(this.sourceRange.y),n=this.targetMin.isConnected?this.targetMin.associatedVariableName:this._writeFloat(this.targetRange.x),a=this.targetMax.isConnected?this.targetMax.associatedVariableName:this._writeFloat(this.targetRange.y);return e.compilationString+=e._declareOutput(t)+` = ${n} + (${this._inputs[0].associatedVariableName} - ${i}) * (${a} - ${n}) / (${r} - ${i});
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.sourceRange = new BABYLON.Vector2(${this.sourceRange.x}, ${this.sourceRange.y});
`;return e+=`${this._codeVariableName}.targetRange = new BABYLON.Vector2(${this.targetRange.x}, ${this.targetRange.y});
`,e}serialize(){const e=super.serialize();return e.sourceRange=this.sourceRange.asArray(),e.targetRange=this.targetRange.asArray(),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.sourceRange=X.FromArray(e.sourceRange),this.targetRange=X.FromArray(e.targetRange)}}_([O("From",3)],Sh.prototype,"sourceRange",void 0);_([O("To",3)],Sh.prototype,"targetRange",void 0);y("BABYLON.RemapBlock",Sh);class vh extends ie{constructor(e){super(e,P.Neutral),this.registerInput("left",p.AutoDetect),this.registerInput("right",p.AutoDetect),this.registerOutput("output",p.BasedOnInput),this.output._typeConnectionSource=this.left,this._linkConnectionTypes(0,1,!0),this.left.acceptedConnectionPointTypes.push(p.Float),this.right.acceptedConnectionPointTypes.push(p.Float),this._connectionObservers=[this.left.onTypeChangedObservable.add(()=>this._updateInputOutputTypes()),this.right.onTypeChangedObservable.add(()=>this._updateInputOutputTypes())]}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_updateInputOutputTypes(){if(this.output._typeConnectionSource=this.left,this.left.isConnected&&this.right.isConnected?(this.left.type===p.Int||this.left.type===p.Float&&this.right.type!==p.Int)&&(this.output._typeConnectionSource=this.right):this.left.isConnected!==this.right.isConnected&&(this.output._typeConnectionSource=this.left.isConnected?this.left:this.right),this.left.isConnected||this.right.isConnected)for(const[e,t]of[[this.left,this.right],[this.right,this.left]])e.acceptedConnectionPointTypes=[p.Int,p.Float],t.isConnected&&(e.acceptedConnectionPointTypes.push(t.type),(t.type===p.Int||t.type===p.Float)&&e.acceptedConnectionPointTypes.push(p.Vector2,p.Vector3,p.Vector4,p.Color3,p.Color4,p.Matrix))}dispose(){super.dispose();for(const e of this._connectionObservers)e.remove();this._connectionObservers.length=0}}class bd extends vh{constructor(e){super(e)}getClassName(){return"MultiplyBlock"}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} * ${this.right.associatedVariableName};
`,this}}y("BABYLON.MultiplyBlock",bd);class $R extends ie{constructor(e){super(e,P.Neutral),this.registerInput("rgba",p.Color4,!0),this.registerInput("rgb ",p.Color3,!0),this.registerOutput("rgb",p.Color3),this.registerOutput("r",p.Float),this.registerOutput("g",p.Float),this.registerOutput("b",p.Float),this.registerOutput("a",p.Float),this.inputsAreExclusive=!0}getClassName(){return"ColorSplitterBlock"}get rgba(){return this._inputs[0]}get rgbIn(){return this._inputs[1]}get rgbOut(){return this._outputs[0]}get r(){return this._outputs[1]}get g(){return this._outputs[2]}get b(){return this._outputs[3]}get a(){return this._outputs[4]}_inputRename(e){return e==="rgb "?"rgbIn":e}_outputRename(e){return e==="rgb"?"rgbOut":e}_buildBlock(e){super._buildBlock(e);const t=this.rgba.isConnected?this.rgba:this.rgbIn;if(!t.isConnected)return;const i=this._outputs[0],r=this._outputs[1],n=this._outputs[2],a=this._outputs[3],o=this._outputs[4];return i.hasEndpoints&&(e.compilationString+=e._declareOutput(i)+` = ${t.associatedVariableName}.rgb;
`),r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = ${t.associatedVariableName}.r;
`),n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = ${t.associatedVariableName}.g;
`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${t.associatedVariableName}.b;
`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${t.associatedVariableName}.a;
`),this}}y("BABYLON.ColorSplitterBlock",$R);class UV{constructor(e){this.name=se.NAME_PROCEDURALTEXTURE,this.scene=e}register(){this.scene._beforeClearStage.registerStep(se.STEP_BEFORECLEAR_PROCEDURALTEXTURE,this,this._beforeClear)}rebuild(){}dispose(){}_beforeClear(){if(this.scene.proceduralTexturesEnabled){j.StartPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0);for(let e=0;e<this.scene.proceduralTextures.length;e++){const t=this.scene.proceduralTextures[e];t._shouldRender()&&t.render()}j.EndPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0)}}}class sr extends ${get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i,r,n=null,a=!0,o=!1,l=0){super(null,r,!a),this.isEnabled=!0,this.autoClear=!0,this.onGeneratedObservable=new k,this.onBeforeGenerationObservable=new k,this.nodeMaterialSource=null,this.defines="",this._textures={},this._currentRefreshId=-1,this._frameId=-1,this._refreshRate=1,this._vertexBuffers={},this._uniforms=new Array,this._samplers=new Array,this._floats={},this._ints={},this._floatsArrays={},this._colors3={},this._colors4={},this._vectors2={},this._vectors3={},this._vectors4={},this._matrices={},this._fallbackTextureUsed=!1,this._cachedDefines=null,this._contentUpdateId=-1,this._rtWrapper=null,n!==null&&!(n instanceof $)?(this._options=n,this._fallbackTexture=n.fallbackTexture??null):(this._options={},this._fallbackTexture=n),this._shaderLanguage=this._options.shaderLanguage??0,r=this.getScene()||De.LastCreatedScene;let c=r._getComponent(se.NAME_PROCEDURALTEXTURE);c||(c=new UV(r),r._addComponent(c)),r.proceduralTextures.push(this),this._fullEngine=r.getEngine(),this.name=e,this.isRenderTarget=!0,this._size=t,this._textureType=l,this._generateMipMaps=a,this._drawWrapper=new gn(this._fullEngine),this.setFragment(i);const u=this._createRtWrapper(o,t,a,l);this._texture=u.texture;const h=[];h.push(1,1),h.push(-1,1),h.push(-1,-1),h.push(1,-1),this._vertexBuffers[M.PositionKind]=new M(this._fullEngine,h,M.PositionKind,!1,!1,2),this._createIndexBuffer()}_createRtWrapper(e,t,i,r){return e?(this._rtWrapper=this._fullEngine.createRenderTargetCubeTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:r,...this._options}),this.setFloat("face",0)):(this._rtWrapper=this._fullEngine.createRenderTargetTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:r,...this._options}),this._rtWrapper.is3D&&(this.setFloat("layer",0),this.setInt("layerNum",0))),this._rtWrapper}getEffect(){return this._drawWrapper.effect}_setEffect(e){this._drawWrapper.effect=e}getContent(){return this._contentData&&this._frameId===this._contentUpdateId?this._contentData:(this._contentData?this._contentData.then(e=>{this._contentData=this.readPixels(0,0,e),this._contentUpdateId=this._frameId}):(this._contentData=this.readPixels(0,0),this._contentUpdateId=this._frameId),this._contentData)}_createIndexBuffer(){const e=this._fullEngine,t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t)}_rebuild(){const e=this._vertexBuffers[M.PositionKind];e&&e._rebuild(),this._createIndexBuffer(),this.refreshRate===Zi.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=Zi.REFRESHRATE_RENDER_ONCE)}reset(){var e;(e=this._drawWrapper.effect)==null||e.dispose(),this._drawWrapper.effect=null,this._cachedDefines=null}_getDefines(){return this.defines}executeWhenReady(e){if(this.isReady()){e(this);return}const t=this.getEffect();t&&t.executeWhenCompiled(()=>{e(this)})}isReady(){const e=this._fullEngine;if(this.nodeMaterialSource)return this._drawWrapper.effect.isReady();if(!this._fragment)return!1;if(this._fallbackTextureUsed)return!0;if(!this._texture)return!1;const t=this._getDefines();if(this._drawWrapper.effect&&t===this._cachedDefines&&this._drawWrapper.effect.isReady())return!0;const i={vertex:"procedural",fragmentElement:this._fragment.fragmentElement,fragmentSource:this._fragment.fragmentSource,fragment:typeof this._fragment=="string"?this._fragment:void 0};return this._cachedDefines!==t&&(this._cachedDefines=t,this._drawWrapper.effect=e.createEffect(i,[M.PositionKind],this._uniforms,this._samplers,t,void 0,void 0,()=>{var r;(r=this._rtWrapper)==null||r.dispose(),this._rtWrapper=this._texture=null,this._fallbackTexture&&(this._texture=this._fallbackTexture._texture,this._texture&&this._texture.incrementReferences()),this._fallbackTextureUsed=!0},void 0,this._shaderLanguage,async()=>{this._options.extraInitializationsAsync?this.shaderLanguage===1?await Promise.all([U(()=>Promise.resolve().then(()=>CT),void 0),this._options.extraInitializationsAsync()]):await Promise.all([U(()=>Promise.resolve().then(()=>yT),void 0),this._options.extraInitializationsAsync()]):this.shaderLanguage===1?await U(()=>Promise.resolve().then(()=>CT),void 0):await U(()=>Promise.resolve().then(()=>yT),void 0)})),this._drawWrapper.effect.isReady()}resetRefreshCounter(){this._currentRefreshId=-1}setFragment(e){this._fragment=e}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}_shouldRender(){return!this.isEnabled||!this.isReady()||!this._texture?(this._texture&&(this._texture.isReady=!1),!1):this._fallbackTextureUsed?!1:this._currentRefreshId===-1?(this._currentRefreshId=1,this._frameId++,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,this._frameId++,!0):(this._currentRefreshId++,!1)}getRenderSize(){return this._size}resize(e,t){if(this._fallbackTextureUsed||!this._rtWrapper||!this._texture)return;const i=this._texture.isCube;this._rtWrapper.dispose();const r=this._createRtWrapper(i,e,t,this._textureType);this._texture=r.texture,this._size=e,this._generateMipMaps=t}_checkUniform(e){this._uniforms.indexOf(e)===-1&&this._uniforms.push(e)}setTexture(e,t){return this._samplers.indexOf(e)===-1&&this._samplers.push(e),this._textures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}render(e){var n,a,o,l;const t=this.getScene();if(!t)return;const i=this._fullEngine;if(i.enableEffect(this._drawWrapper),this.onBeforeGenerationObservable.notifyObservers(this),i.setState(!1),!this.nodeMaterialSource){for(const c in this._textures)this._drawWrapper.effect.setTexture(c,this._textures[c]);for(const c in this._ints)this._drawWrapper.effect.setInt(c,this._ints[c]);for(const c in this._floats)this._drawWrapper.effect.setFloat(c,this._floats[c]);for(const c in this._floatsArrays)this._drawWrapper.effect.setArray(c,this._floatsArrays[c]);for(const c in this._colors3)this._drawWrapper.effect.setColor3(c,this._colors3[c]);for(const c in this._colors4){const u=this._colors4[c];this._drawWrapper.effect.setFloat4(c,u.r,u.g,u.b,u.a)}for(const c in this._vectors2)this._drawWrapper.effect.setVector2(c,this._vectors2[c]);for(const c in this._vectors3)this._drawWrapper.effect.setVector3(c,this._vectors3[c]);for(const c in this._vectors4)this._drawWrapper.effect.setVector4(c,this._vectors4[c]);for(const c in this._matrices)this._drawWrapper.effect.setMatrix(c,this._matrices[c])}if(!this._texture||!this._rtWrapper)return;(n=i._debugPushGroup)==null||n.call(i,`procedural texture generation for ${this.name}`,1);const r=i.currentViewport;if(this.isCube)for(let c=0;c<6;c++)i.bindFramebuffer(this._rtWrapper,c,void 0,void 0,!0),i.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._drawWrapper.effect.setFloat("face",c),this.autoClear&&i.clear(t.clearColor,!0,!1,!1),i.drawElementsType(Le.TriangleFillMode,0,6),i.unBindFramebuffer(this._rtWrapper,!0);else{let c=1;this._rtWrapper.is3D?c=this._rtWrapper.depth:this._rtWrapper.is2DArray&&(c=this._rtWrapper.layers);for(let u=0;u<c;u++){if(i.bindFramebuffer(this._rtWrapper,0,void 0,void 0,!0,0,u),i.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._rtWrapper.is3D||this._rtWrapper.is2DArray){(a=this._drawWrapper.effect)==null||a.setFloat("layer",c!==1?u/(c-1):0),(o=this._drawWrapper.effect)==null||o.setInt("layerNum",u);for(const h in this._textures)this._drawWrapper.effect.setTexture(h,this._textures[h])}this.autoClear&&i.clear(t.clearColor,!0,!1,!1),i.drawElementsType(Le.TriangleFillMode,0,6),i.unBindFramebuffer(this._rtWrapper,!this._generateMipMaps)}}r&&i.setViewport(r),this.isCube&&i.generateMipMapsForCubemap(this._texture,!0),(l=i._debugPopGroup)==null||l.call(i,1),this.onGenerated&&this.onGenerated(),this.onGeneratedObservable.notifyObservers(this)}clone(){const e=this.getSize(),t=new sr(this.name,e.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t}dispose(){const e=this.getScene();if(!e)return;const t=e.proceduralTextures.indexOf(this);t>=0&&e.proceduralTextures.splice(t,1);const i=this._vertexBuffers[M.PositionKind];i&&(i.dispose(),this._vertexBuffers[M.PositionKind]=null),this._indexBuffer&&this._fullEngine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),this.onGeneratedObservable.clear(),this.onBeforeGenerationObservable.clear(),super.dispose()}}_([R()],sr.prototype,"isEnabled",void 0);_([R()],sr.prototype,"autoClear",void 0);_([R()],sr.prototype,"_generateMipMaps",void 0);_([R()],sr.prototype,"_size",void 0);_([R()],sr.prototype,"refreshRate",null);y("BABYLON.ProceduralTexture",sr);var Xe;(function(s){s[s.Cos=0]="Cos",s[s.Sin=1]="Sin",s[s.Abs=2]="Abs",s[s.Exp=3]="Exp",s[s.Exp2=4]="Exp2",s[s.Round=5]="Round",s[s.Floor=6]="Floor",s[s.Ceiling=7]="Ceiling",s[s.Sqrt=8]="Sqrt",s[s.Log=9]="Log",s[s.Tan=10]="Tan",s[s.ArcTan=11]="ArcTan",s[s.ArcCos=12]="ArcCos",s[s.ArcSin=13]="ArcSin",s[s.Fract=14]="Fract",s[s.Sign=15]="Sign",s[s.Radians=16]="Radians",s[s.Degrees=17]="Degrees",s[s.Set=18]="Set"})(Xe||(Xe={}));class P_ extends ie{constructor(e){super(e,P.Neutral),this.operation=Xe.Cos,this.registerInput("input",p.AutoDetect),this.registerOutput("output",p.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"TrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];let i="";switch(this.operation){case Xe.Cos:{i="cos";break}case Xe.Sin:{i="sin";break}case Xe.Abs:{i="abs";break}case Xe.Exp:{i="exp";break}case Xe.Exp2:{i="exp2";break}case Xe.Round:{i="round";break}case Xe.Floor:{i="floor";break}case Xe.Ceiling:{i="ceil";break}case Xe.Sqrt:{i="sqrt";break}case Xe.Log:{i="log";break}case Xe.Tan:{i="tan";break}case Xe.ArcTan:{i="atan";break}case Xe.ArcCos:{i="acos";break}case Xe.ArcSin:{i="asin";break}case Xe.Fract:{i="fract";break}case Xe.Sign:{i="sign";break}case Xe.Radians:{i="radians";break}case Xe.Degrees:{i="degrees";break}case Xe.Set:{i="";break}}return e.compilationString+=e._declareOutput(t)+` = ${i}(${this.input.associatedVariableName});
`,this}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.TrigonometryBlockOperations.${Xe[this.operation]};
`}}_([O("Operation",5,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Cos",value:Xe.Cos},{label:"Sin",value:Xe.Sin},{label:"Abs",value:Xe.Abs},{label:"Exp",value:Xe.Exp},{label:"Exp2",value:Xe.Exp2},{label:"Round",value:Xe.Round},{label:"Floor",value:Xe.Floor},{label:"Ceiling",value:Xe.Ceiling},{label:"Sqrt",value:Xe.Sqrt},{label:"Log",value:Xe.Log},{label:"Tan",value:Xe.Tan},{label:"ArcTan",value:Xe.ArcTan},{label:"ArcCos",value:Xe.ArcCos},{label:"ArcSin",value:Xe.ArcSin},{label:"Fract",value:Xe.Fract},{label:"Sign",value:Xe.Sign},{label:"Radians",value:Xe.Radians},{label:"Degrees",value:Xe.Degrees},{label:"Set",value:Xe.Set}]})],P_.prototype,"operation",void 0);y("BABYLON.TrigonometryBlock",P_);const td={effect:null,subMesh:null};class kV extends qm(Oi){}class hl extends Ou(kV){constructor(){super(),this.NORMAL=!1,this.TANGENT=!1,this.VERTEXCOLOR_NME=!1,this.PREPASS=!1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_WORLD_NORMAL=!1,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=!1,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=!1,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_POSITION=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.MORPHTARGETS_UV2=!1,this.MORPHTARGETS_COLOR=!1,this.MORPHTARGETTEXTURE_HASPOSITIONS=!1,this.MORPHTARGETTEXTURE_HASNORMALS=!1,this.MORPHTARGETTEXTURE_HASTANGENTS=!1,this.MORPHTARGETTEXTURE_HASUVS=!1,this.MORPHTARGETTEXTURE_HASUV2S=!1,this.MORPHTARGETTEXTURE_HASCOLORS=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.BUMPDIRECTUV=0,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.AREALIGHTSUPPORTED=!0,this.AREALIGHTNOROUGHTNESS=!0,this.rebuild()}setValue(e,t,i=!1){this[e]===void 0&&this._keys.push(e),i&&this[e]!==t&&this.markAsUnprocessed(),this[e]=t}}class GV extends Nu(Zl){}class it extends GV{static _BlockIsTextureBlock(e){return e.getClassName()==="TextureBlock"||e.getClassName()==="ReflectionTextureBaseBlock"||e.getClassName()==="ReflectionTextureBlock"||e.getClassName()==="ReflectionBlock"||e.getClassName()==="RefractionBlock"||e.getClassName()==="CurrentScreenBlock"||e.getClassName()==="SmartFilterTextureBlock"||e.getClassName()==="ParticleTextureBlock"||e.getClassName()==="ImageSourceBlock"||e.getClassName()==="TriPlanarBlock"||e.getClassName()==="BiPlanarBlock"||e.getClassName()==="PrePassTextureBlock"}get buildIsInProgress(){return this._buildIsInProgress}set _glowModeEnabled(e){this._useAdditionalColor=e}_getGlobalNodeMaterialEditor(){if(typeof NODEEDITOR<"u")return NODEEDITOR;if(typeof BABYLON<"u"&&typeof BABYLON.NodeEditor<"u")return BABYLON}get shaderLanguage(){var e;return((e=this._options)==null?void 0:e.shaderLanguage)||it.DefaultShaderLanguage}set shaderLanguage(e){this._options.shaderLanguage=e}get options(){return this._options}set options(e){this._options=e}get mode(){return this._mode}set mode(e){this._mode=e}get buildId(){return this._buildId}set buildId(e){this._buildId=e}constructor(e,t,i={}){if(super(e,t||De.LastCreatedScene),this._buildId=it._BuildIdGenerator++,this._buildWasSuccessful=!1,this._cachedWorldViewMatrix=new z,this._cachedWorldViewProjectionMatrix=new z,this._optimizers=new Array,this._animationFrame=-1,this._buildIsInProgress=!1,this.BJSNODEMATERIALEDITOR=this._getGlobalNodeMaterialEditor(),this._useAdditionalColor=!1,this.editorData=null,this.ignoreAlpha=!1,this.maxSimultaneousLights=4,this.onBuildObservable=new k,this.onBuildErrorObservable=new k,this._vertexOutputNodes=new Array,this._fragmentOutputNodes=new Array,this.attachedBlocks=[],this._mode=mi.Material,this.forceAlphaBlending=!1,!it.UseNativeShaderLanguageOfEngine&&i&&i.shaderLanguage===1&&!this.getScene().getEngine().isWebGPU)throw new Error("WebGPU shader language is only supported with WebGPU engine");this._options={emitComments:!1,shaderLanguage:it.DefaultShaderLanguage,...i},it.UseNativeShaderLanguageOfEngine&&(this._options.shaderLanguage=this.getScene().getEngine().isWebGPU?1:0),this._attachImageProcessingConfiguration(null)}getClassName(){return"NodeMaterial"}getBlockByName(e){let t=null;for(const i of this.attachedBlocks)if(i.name===e)if(!t)t=i;else return j.Warn("More than one block was found with the name `"+e+"`"),t;return t}getBlockByPredicate(e){for(const t of this.attachedBlocks)if(e(t))return t;return null}getInputBlockByPredicate(e){for(const t of this.attachedBlocks)if(t.isInput&&e(t))return t;return null}getInputBlocks(){const e=[];for(const t of this.attachedBlocks)t.isInput&&e.push(t);return e}registerOptimizer(e){if(!(this._optimizers.indexOf(e)>-1))return this._optimizers.push(e),this}unregisterOptimizer(e){const t=this._optimizers.indexOf(e);if(t!==-1)return this._optimizers.splice(t,1),this}addOutputNode(e){if(e.target===null)throw"This node is not meant to be an output node. You may want to explicitly set its target value.";return e.target&P.Vertex&&this._addVertexOutputNode(e),e.target&P.Fragment&&this._addFragmentOutputNode(e),this}removeOutputNode(e){return e.target===null?this:(e.target&P.Vertex&&this._removeVertexOutputNode(e),e.target&P.Fragment&&this._removeFragmentOutputNode(e),this)}_addVertexOutputNode(e){if(this._vertexOutputNodes.indexOf(e)===-1)return e.target=P.Vertex,this._vertexOutputNodes.push(e),this}_removeVertexOutputNode(e){const t=this._vertexOutputNodes.indexOf(e);if(t!==-1)return this._vertexOutputNodes.splice(t,1),this}_addFragmentOutputNode(e){if(this._fragmentOutputNodes.indexOf(e)===-1)return e.target=P.Fragment,this._fragmentOutputNodes.push(e),this}_removeFragmentOutputNode(e){const t=this._fragmentOutputNodes.indexOf(e);if(t!==-1)return this._fragmentOutputNodes.splice(t,1),this}get _supportGlowLayer(){return this._fragmentOutputNodes.length===0?!1:!!this._fragmentOutputNodes.some(e=>e.additionalColor&&e.additionalColor.isConnected)}needAlphaBlending(){return this.ignoreAlpha?!1:this.forceAlphaBlending||this.alpha<1||this._sharedData&&this._sharedData.hints.needAlphaBlending}needAlphaTesting(){return this._sharedData&&this._sharedData.hints.needAlphaTesting}_processInitializeOnLink(e,t,i,r=!0){(e.target===P.VertexAndFragment||t.target===P.Fragment&&e.target===P.Vertex&&e._preparationId!==this._buildId)&&i.push(e),this._initializeBlock(e,t,i,r)}_attachBlock(e){if(this.attachedBlocks.indexOf(e)===-1){if(e.isUnique){const t=e.getClassName();for(const i of this.attachedBlocks)if(i.getClassName()===t){this._sharedData.raiseBuildError(`Cannot have multiple blocks of type ${t} in the same NodeMaterial`);return}}this.attachedBlocks.push(e)}}_initializeBlock(e,t,i,r=!0){e.initialize(t),r&&e.autoConfigure(this),e._preparationId=this._buildId,this._attachBlock(e);for(const n of e.inputs){n.associatedVariableName="";const a=n.connectedPoint;if(a&&!a._preventBubbleUp){const o=a.ownerBlock;o!==e&&this._processInitializeOnLink(o,t,i,r)}}if(e.isLoop){const n=e;if(n.loopID.hasEndpoints)for(const a of n.loopID.endpoints){const o=a.ownerBlock;o.outputs.length===0&&(t._terminalBlocks.add(o),this._processInitializeOnLink(o,t,i,r))}}else if(e.isTeleportOut){const n=e;n.entryPoint&&this._processInitializeOnLink(n.entryPoint,t,i,r)}for(const n of e.outputs)n.associatedVariableName=""}_resetDualBlocks(e,t){e.target===P.VertexAndFragment&&(e.buildId=t);for(const i of e.inputs){const r=i.connectedPoint;if(r&&!r._preventBubbleUp){const n=r.ownerBlock;n!==e&&this._resetDualBlocks(n,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._resetDualBlocks(i.entryPoint,t)}else if(e.isLoop){const i=e;if(i.loopID.hasEndpoints)for(const r of i.loopID.endpoints){const n=r.ownerBlock;n.outputs.length===0&&this._resetDualBlocks(n,t)}}}removeBlock(e){const t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e.isFinalMerger&&this.removeOutputNode(e)}build(e=!1,t=!0,i=!1){if(this._buildIsInProgress){N.Warn("Build is already in progress, You can use NodeMaterial.onBuildObservable to determine when the build is completed.");return}this._buildIsInProgress=!0,!this._vertexCompilationState&&!i&&(i=!0),this._buildWasSuccessful=!1;const r=this.getScene().getEngine(),n=this._mode===mi.Particle||this._mode===mi.SFE;if(this._vertexOutputNodes.length===0&&!n){this.onBuildErrorObservable.notifyObservers("You must define at least one vertexOutputNode"),this._buildIsInProgress=!1;return}if(this._fragmentOutputNodes.length===0){this.onBuildErrorObservable.notifyObservers("You must define at least one fragmentOutputNode"),this._buildIsInProgress=!1;return}this._vertexCompilationState=new zv,this._vertexCompilationState.supportUniformBuffers=r.supportsUniformBuffers,this._vertexCompilationState.target=P.Vertex,this._fragmentCompilationState=new zv,this._fragmentCompilationState.supportUniformBuffers=r.supportsUniformBuffers,this._fragmentCompilationState.target=P.Fragment;const a=this._fragmentOutputNodes.filter(h=>h._isFinalOutputAndActive).length>1;let o=this._fragmentOutputNodes;a&&(o=this._fragmentOutputNodes.filter(h=>!h._isFinalOutputAndActive),o.push(this._fragmentOutputNodes.filter(h=>h._isFinalOutputAndActive&&h._hasPrecedence)[0])),this._sharedData=new wV,this._sharedData.nodeMaterial=this,this._sharedData.fragmentOutputNodes=o,this._vertexCompilationState.sharedData=this._sharedData,this._fragmentCompilationState.sharedData=this._sharedData,this._sharedData.buildId=this._buildId,this._sharedData.emitComments=this._options.emitComments,this._sharedData.verbose=e,this._sharedData.scene=this.getScene(),this._sharedData.allowEmptyVertexProgram=n;const l=[],c=[];for(const h of this._vertexOutputNodes)l.push(h),this._initializeBlock(h,this._vertexCompilationState,c,i);for(const h of o)c.push(h),this._initializeBlock(h,this._fragmentCompilationState,l,i);let u=0;for(const h of this.attachedBlocks)h.codeIsReady||(u++,h.onCodeIsReadyObservable.addOnce(()=>{u--,u===0&&this._finishBuildProcess(e,t,l,c)}));u===0&&this._finishBuildProcess(e,t,l,c)}_finishBuildProcess(e=!1,t=!0,i,r){this.optimize();for(const l of i)l.build(this._vertexCompilationState,i);this._fragmentCompilationState.uniforms=this._vertexCompilationState.uniforms.slice(0),this._fragmentCompilationState._uniformDeclaration=this._vertexCompilationState._uniformDeclaration,this._fragmentCompilationState._constantDeclaration=this._vertexCompilationState._constantDeclaration,this._fragmentCompilationState._vertexState=this._vertexCompilationState;for(const l of r)this._resetDualBlocks(l,this._buildId-1);for(const l of r)l.build(this._fragmentCompilationState,r);this._vertexCompilationState.finalize(this._vertexCompilationState),this._fragmentCompilationState.finalize(this._fragmentCompilationState),t&&(this._buildId=it._BuildIdGenerator++),e&&(N.Log("Vertex shader:"),N.Log(this._vertexCompilationState.compilationString),N.Log("Fragment shader:"),N.Log(this._fragmentCompilationState.compilationString));const n=this._sharedData.emitErrors();this._buildIsInProgress=!1,n&&(this._buildWasSuccessful=!0,this.onBuildObservable.notifyObservers(this));const a=this.getScene().meshes;for(const l of a)if(l.subMeshes)for(const c of l.subMeshes){if(c.getMaterial()!==this||!c.materialDefines)continue;const u=c.materialDefines;u.markAllAsDirty(),u.reset()}this.prePassTextureInputs.length&&this.getScene().enablePrePassRenderer();const o=this.getScene().prePassRenderer;o&&o.markAsDirty()}optimize(){for(const e of this._optimizers)e.optimize(this._vertexOutputNodes,this._fragmentOutputNodes)}_prepareDefinesForAttributes(e,t){const i=t.NORMAL,r=t.TANGENT,n=t.VERTEXCOLOR_NME;t.NORMAL=e.isVerticesDataPresent(M.NormalKind),t.TANGENT=e.isVerticesDataPresent(M.TangentKind);const a=e.useVertexColors&&e.isVerticesDataPresent(M.ColorKind);t.VERTEXCOLOR_NME=a;let o=!1;for(let c=1;c<=6;++c){const u=t["UV"+c];t["UV"+c]=e.isVerticesDataPresent(`uv${c===1?"":c}`),o=o||t["UV"+c]!==u}const l=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;jm(this.getScene(),t,!l),Ei.PrepareDefines(this.getScene().getEngine().currentRenderPassId,e,t),(i!==t.NORMAL||r!==t.TANGENT||n!==t.VERTEXCOLOR_NME||o)&&t.markAsAttributesDirty()}get isPrePassCapable(){return!0}get prePassTextureOutputs(){const e=this.getBlockByPredicate(i=>i.getClassName()==="PrePassOutputBlock"),t=[4];return!e||this.prePassTextureInputs.length||(e.viewDepth.isConnected&&t.push(5),e.screenDepth.isConnected&&t.push(10),e.viewNormal.isConnected&&t.push(6),e.worldNormal.isConnected&&t.push(8),e.worldPosition.isConnected&&t.push(1),e.localPosition.isConnected&&t.push(9),e.reflectivity.isConnected&&t.push(3),e.velocity.isConnected&&t.push(2),e.velocityLinear.isConnected&&t.push(11)),t}get prePassTextureInputs(){const e=this.getAllTextureBlocks().filter(i=>i.getClassName()==="PrePassTextureBlock"),t=[];for(const i of e)i.position.isConnected&&!t.includes(1)&&t.push(1),i.localPosition.isConnected&&!t.includes(9)&&t.push(9),i.depth.isConnected&&!t.includes(5)&&t.push(5),i.screenDepth.isConnected&&!t.includes(10)&&t.push(10),i.normal.isConnected&&!t.includes(6)&&t.push(6),i.worldNormal.isConnected&&!t.includes(8)&&t.push(8);return t}setPrePassRenderer(e){const t=this.prePassTextureInputs.concat(this.prePassTextureOutputs);if(e&&t.length>1){let i=e.getEffectConfiguration("nodeMaterial");i||(i=e.addEffectConfiguration({enabled:!0,needsImageProcessing:!1,name:"nodeMaterial",texturesRequired:[]}));for(const r of t)i.texturesRequired.includes(r)||i.texturesRequired.push(r);i.enabled=!0}return t.length>1}createPostProcess(e,t=1,i=1,r,n,a=0,o=5){return this.mode!==mi.PostProcess&&this.mode!==mi.SFE?(N.Log("Incompatible material mode"),null):this._createEffectForPostProcess(null,e,t,i,r,n,a,o)}createEffectForPostProcess(e){this._createEffectForPostProcess(e)}_createEffectForPostProcess(e,t,i=1,r=1,n,a,o=0,l=5){let c=this.name+this._buildId;const u=new hl;let h=this._buildId;this._processDefines(u);const d=this._sharedData.checks.emitVertex?this._vertexCompilationState._builtCompilationString:void 0;return jr.RegisterShader(c,this._fragmentCompilationState._builtCompilationString,d,this.shaderLanguage),e?e.updateEffect(u.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,c,c):e=new Se(this.name+"PostProcess",c,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,i,t,r,n,a,u.toString(),o,d?c:"postprocess",{maxSimultaneousLights:this.maxSimultaneousLights},!1,l,this.shaderLanguage),e.nodeMaterialSource=this,e.onApplyObservable.add(f=>{h!==this._buildId&&(delete jr.ShadersStore[c+"VertexShader"],delete jr.ShadersStore[c+"PixelShader"],c=this.name+this._buildId,u.markAllAsDirty(),h=this._buildId),this._processDefines(u)&&(jr.RegisterShader(c,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),pg.SetImmediate(()=>e.updateEffect(u.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,c,c))),this._checkInternals(f)}),e}createProceduralTexture(e,t){if(this.mode!==mi.ProceduralTexture)return N.Log("Incompatible material mode"),null;let i=this.name+this._buildId;const r=new sr(i,e,null,t),n=new hl,a=this._processDefines(n);jr.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage);let o=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[M.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString(),a==null?void 0:a.fallbacks,void 0,void 0,void 0,this.shaderLanguage);r.nodeMaterialSource=this,r._setEffect(o);let l=this._buildId;const c=()=>{l!==this._buildId&&(delete jr.ShadersStore[i+"VertexShader"],delete jr.ShadersStore[i+"PixelShader"],i=this.name+this._buildId,n.markAllAsDirty(),l=this._buildId);const u=this._processDefines(n);u&&(jr.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage),pg.SetImmediate(()=>{o=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[M.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString(),u==null?void 0:u.fallbacks,void 0),r._setEffect(o)})),this._checkInternals(o)};return r.onBeforeGenerationObservable.add(()=>{c()}),this.onBuildObservable.add(()=>{c()}),r}_createEffectForParticles(e,t,i,r,n,a,o=""){let l=this.name+this._buildId+"_"+t;a||(a=new hl);let c=this._buildId;const u=[];let h=o;if(!n){const d=this._processDefines(a);jr.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,void 0,this.shaderLanguage),e.fillDefines(u,t,!1),h=u.join(`
`),n=this.getScene().getEngine().createEffectForParticles(l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,a.toString()+`
`+h,d==null?void 0:d.fallbacks,i,r,e,this.shaderLanguage),e.setCustomEffect(n,t)}n.onBindObservable.add(d=>{c!==this._buildId&&(delete jr.ShadersStore[l+"PixelShader"],l=this.name+this._buildId+"_"+t,a.markAllAsDirty(),c=this._buildId),u.length=0,e.fillDefines(u,t,!1);const f=u.join(`
`);f!==h&&(a.markAllAsDirty(),h=f);const m=this._processDefines(a);if(m){jr.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,void 0,this.shaderLanguage),d=this.getScene().getEngine().createEffectForParticles(l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,a.toString()+`
`+h,m==null?void 0:m.fallbacks,i,r,e),e.setCustomEffect(d,t),this._createEffectForParticles(e,t,i,r,d,a,o);return}this._checkInternals(d)})}_checkInternals(e){if(this._sharedData.animatedInputs){const t=this.getScene(),i=t.getFrameId();if(this._animationFrame!==i){for(const r of this._sharedData.animatedInputs)r.animate(t);this._animationFrame=i}}for(const t of this._sharedData.bindableBlocks)t.bind(e,this);for(const t of this._sharedData.inputBlocks)t._transmit(e,this.getScene(),this)}createEffectForParticles(e,t,i){if(this.mode!==mi.Particle){N.Log("Incompatible material mode");return}this._createEffectForParticles(e,Nn.BLENDMODE_ONEONE,t,i),this._createEffectForParticles(e,Nn.BLENDMODE_MULTIPLY,t,i)}createAsShadowDepthWrapper(e){if(this.mode!==mi.Material){N.Log("Incompatible material mode");return}e.shadowDepthWrapper=new BABYLON.ShadowDepthWrapper(this,this.getScene())}_processDefines(e,t,i=!1,r){let n=null;const a=this.getScene();PD(a,e)&&e.markAsMiscDirty();for(const o of this._sharedData.blocksWithDefines)o.initializeDefines(e);for(const o of this._sharedData.blocksWithDefines)o.prepareDefines(e,this,t,i,r);if(e.isDirty){const o=e._areLightsDisposed;e.markAsProcessed(),this._vertexCompilationState.compilationString=this._vertexCompilationState._builtCompilationString,this._fragmentCompilationState.compilationString=this._fragmentCompilationState._builtCompilationString;for(const d of this._sharedData.repeatableContentBlocks)d.replaceRepeatableContent(this._vertexCompilationState,e,t);const l=[];for(const d of this._sharedData.dynamicUniformBlocks)d.updateUniformsAndSamples(this._vertexCompilationState,this,e,l);const c=this._vertexCompilationState.uniforms;for(const d of this._fragmentCompilationState.uniforms)c.indexOf(d)===-1&&c.push(d);const u=this._vertexCompilationState.samplers;for(const d of this._fragmentCompilationState.samplers)u.indexOf(d)===-1&&u.push(d);const h=new Ma;for(const d of this._sharedData.blocksWithFallbacks)d.provideFallbacks(h,t);n={lightDisposed:o,uniformBuffers:l,mergedUniforms:c,mergedSamplers:u,fallbacks:h}}return n}isReadyForSubMesh(e,t,i=!1){if(!this._buildWasSuccessful)return!1;const r=this.getScene();if(this._sharedData.animatedInputs){const c=r.getFrameId();if(this._animationFrame!==c){for(const u of this._sharedData.animatedInputs)u.animate(r);this._animationFrame=c}}const n=t._drawWrapper;if(n.effect&&this.isFrozen&&n._wasPreviouslyReady&&n._wasPreviouslyUsingInstances===i)return!0;(!t.materialDefines||typeof t.materialDefines=="string")&&(t.materialDefines=new hl);const a=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const o=r.getEngine();if(this._prepareDefinesForAttributes(e,a),this._sharedData.blockingBlocks.some(c=>!c.isReady(e,this,a,i)))return!1;const l=this._processDefines(a,e,i,t);if(l){const c=t.effect,u=a.toString();let h=o.createEffect({vertex:"nodeMaterial"+this._buildId,fragment:"nodeMaterial"+this._buildId,vertexSource:this._vertexCompilationState.compilationString,fragmentSource:this._fragmentCompilationState.compilationString},{attributes:this._vertexCompilationState.attributes,uniformsNames:l.mergedUniforms,uniformBuffersNames:l.uniformBuffers,samplers:l.mergedSamplers,defines:u,fallbacks:l.fallbacks,onCompiled:this.onCompiled,onError:this.onError,multiTarget:a.PREPASS,indexParameters:{maxSimultaneousLights:this.maxSimultaneousLights,maxSimultaneousMorphTargets:a.NUM_MORPH_INFLUENCERS},shaderLanguage:this.shaderLanguage},o);if(h)if(this._onEffectCreatedObservable&&(td.effect=h,td.subMesh=t,this._onEffectCreatedObservable.notifyObservers(td)),this.allowShaderHotSwapping&&c&&!h.isReady()){if(h=c,a.markAsUnprocessed(),l.lightDisposed)return a._areLightsDisposed=!0,!1}else r.resetCachedMaterial(),t.setEffect(h,a,this._materialContext)}if(a.AREALIGHTUSED){for(let c=0;c<e.lightSources.length;c++)if(!e.lightSources[c]._isReady())return!1}return!t.effect||!t.effect.isReady()?!1:(a._renderId=r.getRenderId(),n._wasPreviouslyReady=!0,n._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),!0)}get compiledShaders(){return this._buildWasSuccessful||this.build(),`// Vertex shader
${this._vertexCompilationState.compilationString}

// Fragment shader
${this._fragmentCompilationState.compilationString}`}async _getProcessedFragmentAsync(){this._buildWasSuccessful||this.build();const e=new hl;this._processDefines(e);let t=e.toString();return this.mode===mi.SFE&&(t+=`#define ${ru}
`),await this._fragmentCompilationState.getProcessedShaderAsync(t)}bindOnlyWorldMatrix(e){const t=this.getScene();if(!this._activeEffect)return;const i=this._sharedData.hints;i.needWorldViewMatrix&&e.multiplyToRef(t.getViewMatrix(),this._cachedWorldViewMatrix),i.needWorldViewProjectionMatrix&&e.multiplyToRef(t.getTransformMatrix(),this._cachedWorldViewProjectionMatrix);for(const r of this._sharedData.inputBlocks)r._transmitWorld(this._activeEffect,e,this._cachedWorldViewMatrix,this._cachedWorldViewProjectionMatrix)}bindForSubMesh(e,t,i){const r=this.getScene(),n=i.effect;if(!n)return;this._activeEffect=n,this.bindOnlyWorldMatrix(e);const a=this._mustRebind(r,n,i,t.visibility),o=this._sharedData;if(a){for(const l of o.bindableBlocks)l.bind(n,this,t,i);for(const l of o.forcedBindableBlocks)l.bind(n,this,t,i);for(const l of o.inputBlocks)l._transmit(n,r,this)}else if(!this.isFrozen)for(const l of o.forcedBindableBlocks)l.bind(n,this,t,i);this._afterBind(t,this._activeEffect,i)}getActiveTextures(){const e=super.getActiveTextures();return this._sharedData&&e.push(...this._sharedData.textureBlocks.filter(t=>t.texture).map(t=>t.texture)),e}getTextureBlocks(){return this._sharedData?this._sharedData.textureBlocks:[]}getAllTextureBlocks(){const e=[];for(const t of this.attachedBlocks)it._BlockIsTextureBlock(t)&&e.push(t);return e}hasTexture(e){if(super.hasTexture(e))return!0;if(!this._sharedData)return!1;for(const t of this._sharedData.textureBlocks)if(t.texture===e)return!0;return!1}dispose(e,t,i){if(t)for(const r of this.getTextureBlocks().filter(n=>n.texture).map(n=>n.texture))r.dispose();for(const r of this.attachedBlocks)r.dispose();this.attachedBlocks.length=0,this._sharedData=null,this._vertexCompilationState=null,this._fragmentCompilationState=null,this.onBuildObservable.clear(),this.onBuildErrorObservable.clear(),this._imageProcessingObserver&&(this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingObserver=null),super.dispose(e,t,i)}_createNodeEditor(e){const t={nodeMaterial:this,...e};this.BJSNODEMATERIALEDITOR.NodeEditor.Show(t)}async edit(e){return await new Promise(t=>{if(this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),typeof this.BJSNODEMATERIALEDITOR>"u"){const i=e&&e.editorURL?e.editorURL:it.EditorURL;j.LoadBabylonScript(i,()=>{this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),this._createNodeEditor(e==null?void 0:e.nodeEditorConfig),t()})}else this._createNodeEditor(e==null?void 0:e.nodeEditorConfig),t()})}clear(){this._vertexOutputNodes.length=0,this._fragmentOutputNodes.length=0,this.attachedBlocks.length=0,this._buildIsInProgress=!1}setToDefault(){this.clear(),this.editorData=null;const e=new ge("Position");e.setAsAttribute("position");const t=new ge("World");t.setAsSystemValue(ve.World);const i=new su("WorldPos");e.connectTo(i),t.connectTo(i);const r=new ge("ViewProjection");r.setAsSystemValue(ve.ViewProjection);const n=new su("WorldPos * ViewProjectionTransform");i.connectTo(n),r.connectTo(n);const a=new zc("VertexOutput");n.connectTo(a);const o=new ge("color");o.value=new Te(.8,.8,.8,1);const l=new Mn("FragmentOutput");o.connectTo(l),this.addOutputNode(a),this.addOutputNode(l),this._mode=mi.Material}setToDefaultPostProcess(){this.clear(),this.editorData=null;const e=new ge("Position");e.setAsAttribute("position2d");const t=new ge("Constant1");t.isConstant=!0,t.value=1;const i=new Wc("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const r=new zc("VertexOutput");i.connectTo(r);const n=new ge("Scale");n.visibleInInspector=!0,n.value=new X(1,1);const a=new Sh("uv0");e.connectTo(a);const o=new bd("UV scale");a.connectTo(o),n.connectTo(o);const l=new A_("CurrentScreen");o.connectTo(l);const c=j.GetAssetUrl("https://assets.babylonjs.com/core/nme/currentScreenPostProcess.png");l.texture=new $(c,this.getScene());const u=new Mn("FragmentOutput");l.connectTo(u,{output:"rgba"}),this.addOutputNode(r),this.addOutputNode(u),this._mode=mi.PostProcess}setToDefaultProceduralTexture(){this.clear(),this.editorData=null;const e=new ge("Position");e.setAsAttribute("position2d");const t=new ge("Constant1");t.isConstant=!0,t.value=1;const i=new Wc("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const r=new zc("VertexOutput");i.connectTo(r);const n=new ge("Time");n.value=0,n.min=0,n.max=0,n.isBoolean=!1,n.matrixMode=0,n.animationType=sn.Time,n.isConstant=!1;const a=new ge("Color3");a.value=new q(1,1,1),a.isConstant=!1;const o=new Mn("FragmentOutput"),l=new Wc("VectorMerger");l.visibleInInspector=!1;const c=new P_("Cos");c.operation=Xe.Cos,e.connectTo(l),n.output.connectTo(c.input),c.output.connectTo(l.z),l.xyzOut.connectTo(o.rgb),this.addOutputNode(r),this.addOutputNode(o),this._mode=mi.ProceduralTexture}setToDefaultParticle(){this.clear(),this.editorData=null;const e=new ge("uv");e.setAsAttribute("particle_uv");const t=new zR("ParticleTexture");e.connectTo(t);const i=new ge("Color");i.setAsAttribute("particle_color");const r=new bd("Texture * Color");t.connectTo(r),i.connectTo(r);const n=new WR("ParticleRampGradient");r.connectTo(n);const a=new $R("ColorSplitter");i.connectTo(a);const o=new HR("ParticleBlendMultiply");n.connectTo(o),t.connectTo(o,{output:"a"}),a.connectTo(o,{output:"a"});const l=new Mn("FragmentOutput");o.connectTo(l),this.addOutputNode(l),this._mode=mi.Particle}async loadAsync(e,t=""){return await it.ParseFromFileAsync("",e,this.getScene(),t,!0,this)}_gatherBlocks(e,t){if(t.indexOf(e)===-1){t.push(e);for(const i of e.inputs){const r=i.connectedPoint;if(r){const n=r.ownerBlock;n!==e&&this._gatherBlocks(n,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._gatherBlocks(i.entryPoint,t)}}}generateCode(){let e=[];const t=[],i=["const","var","let"];for(const a of this._vertexOutputNodes)this._gatherBlocks(a,t);const r=[];for(const a of this._fragmentOutputNodes)this._gatherBlocks(a,r);let n=`var nodeMaterial = new BABYLON.NodeMaterial("${this.name||"node material"}");
`;n+=`nodeMaterial.mode = BABYLON.NodeMaterialModes.${mi[this.mode]};
`;for(const a of t)a.isInput&&e.indexOf(a)===-1&&(n+=a._dumpCode(i,e));for(const a of r)a.isInput&&e.indexOf(a)===-1&&(n+=a._dumpCode(i,e));e=[],n+=`
// Connections
`;for(const a of this._vertexOutputNodes)n+=a._dumpCodeForOutputConnections(e);for(const a of this._fragmentOutputNodes)n+=a._dumpCodeForOutputConnections(e);n+=`
// Output nodes
`;for(const a of this._vertexOutputNodes)n+=`nodeMaterial.addOutputNode(${a._codeVariableName});
`;for(const a of this._fragmentOutputNodes)n+=`nodeMaterial.addOutputNode(${a._codeVariableName});
`;return n+=`nodeMaterial.build();
`,n}serialize(e){const t=e?{}:me.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];if(e)i=e;else{t.customType="BABYLON.NodeMaterial",t.outputNodes=[];for(const r of this._vertexOutputNodes)this._gatherBlocks(r,i),t.outputNodes.push(r.uniqueId);for(const r of this._fragmentOutputNodes)this._gatherBlocks(r,i),t.outputNodes.indexOf(r.uniqueId)===-1&&t.outputNodes.push(r.uniqueId)}t.blocks=[];for(const r of i)t.blocks.push(r.serialize());if(!e)for(const r of this.attachedBlocks)i.indexOf(r)===-1&&t.blocks.push(r.serialize());return t.uniqueId=this.uniqueId,t}_restoreConnections(e,t,i){for(const r of e.outputs)for(const n of t.blocks){const a=i[n.id];if(a){for(const o of n.inputs)if(i[o.targetBlockId]===e&&o.targetConnectionName===r.name){const l=a.getInputByName(o.inputName);if(!l||l.isConnected)continue;r.connectTo(l,!0),this._restoreConnections(a,t,i);continue}}}}parseSerializedObject(e,t="",i=!1,r){i||this.clear();const n={};for(const a of e.blocks){const o=ki(a.customType);if(o){const l=new o;l._deserialize(a,this.getScene(),t,r),n[a.id]=l,this.attachedBlocks.push(l)}}for(const a of this.attachedBlocks)if(a.isTeleportOut){const o=a,l=o._tempEntryPointUniqueId;l&&n[l].attachToEndpoint(o)}for(let a=0;a<e.blocks.length;a++){const o=e.blocks[a],l=n[o.id];l&&(l.inputs.length&&!i||this._restoreConnections(l,e,n))}if(e.outputNodes)for(const a of e.outputNodes)this.addOutputNode(n[a]);if(e.locations||e.editorData&&e.editorData.locations){const a=e.locations||e.editorData.locations;for(const l of a)n[l.blockId]&&(l.blockId=n[l.blockId].uniqueId);i&&this.editorData&&this.editorData.locations&&a.concat(this.editorData.locations),e.locations?this.editorData={locations:a}:(this.editorData=e.editorData,this.editorData.locations=a);const o={};for(const l in n)o[l]=n[l].uniqueId;this.editorData.map=o}Le.ParseAlphaMode(e,this),i||(this._mode=e.mode??mi.Material)}loadFromSerialization(e,t="",i=!1){me.ParseProperties(e,this,this.getScene(),t),this.parseSerializedObject(e,t,i)}clone(e,t=!1){const i=this.serialize(),r=me.Clone(()=>new it(e,this.getScene(),this.options),this);return r.id=e,r.name=e,r.parseSerializedObject(i),r._buildId=this._buildId,r.build(!1,!t),r}whenTexturesReadyAsync(){const e=[],t=this.getActiveTextures();for(const i of t){const r=i.getInternalTexture();r&&!r.isReady&&e.push(new Promise((n,a)=>{r.onLoadedObservable.addOnce(()=>{n()}),r.onErrorObservable.addOnce(o=>{a(o)})}))}return Promise.all(e)}static Parse(e,t,i="",r=0){const n=me.Parse(()=>new it(e.name,t,{shaderLanguage:r}),e,t,i);return n.parseSerializedObject(e,i),n.build(),n}static async ParseFromFileAsync(e,t,i,r="",n=!1,a,o,l){const c=a??new it(e,i,l),u=await i._loadFileAsync(t),h=JSON.parse(u);return c.parseSerializedObject(h,r,void 0,o),n||c.build(),c}static ParseFromSnippetAsync(e,t=De.LastCreatedScene,i="",r,n=!1,a=!1,o,l){return e==="_BLANK"?Promise.resolve(it.CreateDefault("blank",t)):new Promise((c,u)=>{const h=new dn;h.addEventListener("readystatechange",()=>{if(h.readyState==4)if(h.status==200){const d=JSON.parse(JSON.parse(h.responseText).jsonPayload),f=JSON.parse(d.nodeMaterial);r||(r=me.Parse(()=>new it(e,t,l),f,t,i),r.uniqueId=t.getUniqueId()),r.parseSerializedObject(f,void 0,void 0,o),r.snippetId=e,r.sideOrientation=null;try{n||r.build()}catch(m){u(m)}a?r.whenTexturesReadyAsync().then(()=>{c(r)}).catch(m=>{u(m)}):c(r)}else u("Unable to load the snippet "+e)}),h.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),h.send()})}static CreateDefault(e,t){const i=new it(e,t);return i.setToDefault(),i.build(),i}}it._BuildIdGenerator=0;it.EditorURL=`${j._DefaultCdnUrl}/v${te.Version}/nodeEditor/babylon.nodeEditor.js`;it.SnippetUrl="https://snippet.babylonjs.com";it.IgnoreTexturesAtLoadTime=!1;it.AllowSerializationOfRenderTargetTextures=!1;it.DefaultShaderLanguage=0;it.UseNativeShaderLanguageOfEngine=!1;_([R()],it.prototype,"ignoreAlpha",void 0);_([R()],it.prototype,"maxSimultaneousLights",void 0);_([R("mode")],it.prototype,"_mode",void 0);_([R("comment")],it.prototype,"comment",void 0);_([R()],it.prototype,"forceAlphaBlending",void 0);y("BABYLON.NodeMaterial",it);Yn.prototype._projectOnTrianglesToRef=function(s,e,t,i,r,n){const a=G.Vector3[0],o=G.Vector3[1];let l=1/0;for(let c=this.indexStart;c<this.indexStart+this.indexCount-(3-i);c+=i){const u=t[c],h=t[c+1],d=t[c+2];if(r&&d===4294967295){c+=2;continue}const f=e[u],m=e[h],g=e[d];if(!f||!m||!g)continue;const v=x.ProjectOnTriangleToRef(s,f,m,g,o);v<l&&(a.copyFrom(o),l=v)}return n.copyFrom(a),l};Yn.prototype._projectOnUnIndexedTrianglesToRef=function(s,e,t,i){const r=G.Vector3[0],n=G.Vector3[1];let a=1/0;for(let o=this.verticesStart;o<this.verticesStart+this.verticesCount;o+=3){const l=e[o],c=e[o+1],u=e[o+2],h=x.ProjectOnTriangleToRef(s,l,c,u,n);h<a&&(r.copyFrom(n),a=h)}return i.copyFrom(r),a};Yn.prototype.projectToRef=function(s,e,t,i){const r=this.getMaterial();if(!r)return-1;let n=3,a=!1;switch(r.fillMode){case 3:case 5:case 6:case 8:return-1;case 7:n=1,a=!0;break}return r.fillMode===4?-1:!t.length&&this._mesh._unIndexed?this._projectOnUnIndexedTrianglesToRef(s,e,t,i):this._projectOnTrianglesToRef(s,e,t,n,a,i)};var dr;(function(s){s[s.DEHYDRATED=0]="DEHYDRATED",s[s.HOVER=1]="HOVER",s[s.TOUCH=2]="TOUCH"})(dr||(dr={}));var Yv;(function(s){s[s.DISABLED=0]="DISABLED",s[s.CENTERED_ON_CONTROLLER=1]="CENTERED_ON_CONTROLLER",s[s.CENTERED_IN_FRONT=2]="CENTERED_IN_FRONT"})(Yv||(Yv={}));const Ja=[new x,new x,new x,new x];class $s extends pi{constructor(e,t){super(e),this._options=t,this._tmpRay=new xe(new x,new x),this._attachController=i=>{if(this._controllers[i.uniqueId])return;const{touchCollisionMesh:r,touchCollisionMeshFunction:n,hydrateCollisionMeshFunction:a}=this._generateNewTouchPointMesh(),o=this._generateVisualCue();switch(this._controllers[i.uniqueId]={xrController:i,meshUnderPointer:null,nearInteractionTargetMesh:null,pick:null,stalePick:null,touchCollisionMesh:r,touchCollisionMeshFunction:n,hydrateCollisionMeshFunction:a,currentAnimationState:dr.DEHYDRATED,grabRay:new xe(new x,new x),hoverInteraction:!1,nearInteraction:!1,grabInteraction:!1,downTriggered:!1,id:$s._IdCounter++,pickedPointVisualCue:o},this._controllers[i.uniqueId]._worldScaleObserver=this._controllers[i.uniqueId]._worldScaleObserver||this._xrSessionManager.onWorldScaleFactorChangedObservable.add(l=>{if(l.newScaleFactor!==l.previousScaleFactor){this._controllers[i.uniqueId].touchCollisionMesh.dispose(),this._controllers[i.uniqueId].pickedPointVisualCue.dispose();const{touchCollisionMesh:c,touchCollisionMeshFunction:u,hydrateCollisionMeshFunction:h}=this._generateNewTouchPointMesh();this._controllers[i.uniqueId].touchCollisionMesh=c,this._controllers[i.uniqueId].touchCollisionMeshFunction=u,this._controllers[i.uniqueId].hydrateCollisionMeshFunction=h,this._controllers[i.uniqueId].pickedPointVisualCue=this._generateVisualCue()}}),this._attachedController?!this._options.enableNearInteractionOnAllControllers&&this._options.preferredHandedness&&i.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=i.uniqueId):this._options.enableNearInteractionOnAllControllers||(this._attachedController=i.uniqueId),i.inputSource.targetRayMode){case"tracked-pointer":return this._attachNearInteractionMode(i);case"gaze":return null;case"screen":return null}},this._controllers={},this._farInteractionFeature=null,this.selectionMeshDefaultColor=new q(.8,.8,.8),this.selectionMeshPickedColor=new q(.3,.3,1),this.alwaysHideSelectionMesh=!1,this._hoverRadius=.1,this._pickRadius=.02,this._controllerPickRadius=.03,this._nearGrabLengthScale=5,this._scene=this._xrSessionManager.scene,this._options.nearInteractionControllerMode===void 0&&(this._options.nearInteractionControllerMode=2),this._options.farInteractionFeature&&(this._farInteractionFeature=this._options.farInteractionFeature)}attach(){if(!super.attach())return!1;for(const e of this._options.xrInput.controllers)this._attachController(e);return this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),this._scene.constantlyUpdateMeshUnderPointer=!0,!0}detach(){if(!super.detach())return!1;const e=Object.keys(this._controllers);for(const t of e)this._detachController(t);return!0}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}setFarInteractionFeature(e){this._farInteractionFeature=e}_nearPickPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearPickable}_nearGrabPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearGrabbable}_nearInteractionPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&(e.isNearPickable||e.isNearGrabbable)}_controllerAvailablePredicate(e,t){let i=e;for(;i;){if(i.reservedDataStore&&i.reservedDataStore.nearInteraction&&i.reservedDataStore.nearInteraction.excludedControllerId===t)return!1;i=i.parent}return!0}_handleTransitionAnimation(e,t){var i;if(!(e.currentAnimationState===t||this._options.nearInteractionControllerMode!==2||(i=e.xrController)!=null&&i.inputSource.hand)){if(t>e.currentAnimationState)switch(e.currentAnimationState){case dr.DEHYDRATED:if(e.hydrateCollisionMeshFunction(!0),t===dr.HOVER)break;case dr.HOVER:if(e.touchCollisionMeshFunction(!0),t===dr.TOUCH)break}else switch(e.currentAnimationState){case dr.TOUCH:if(e.touchCollisionMeshFunction(!1),t===dr.HOVER)break;case dr.HOVER:if(e.hydrateCollisionMeshFunction(!1),t===dr.DEHYDRATED)break}e.currentAnimationState=t}}_processTouchPoint(e,t,i){var n;const r=this._controllers[e];r.grabRay.origin.copyFrom(t),i.toEulerAnglesToRef(G.Vector3[0]),r.grabRay.direction.copyFrom(G.Vector3[0]),this._options.nearInteractionControllerMode===2&&!((n=r.xrController)!=null&&n.inputSource.hand)&&(r.xrController.getWorldPointerRayToRef(this._tmpRay),r.grabRay.origin.addInPlace(this._tmpRay.direction.scale(.05))),r.grabRay.length=this._nearGrabLengthScale*this._hoverRadius*this._xrSessionManager.worldScalingFactor,r.touchCollisionMesh.position.copyFrom(r.grabRay.origin).scaleInPlace(this._xrSessionManager.worldScalingFactor)}_onXRFrame(e){var i;const t=Object.keys(this._controllers);for(const r of t){const n=this._controllers[r],a=(i=n.xrController)==null?void 0:i.inputSource.hand;if(!this._options.enableNearInteractionOnAllControllers&&r!==this._attachedController||!n.xrController||!a&&(!this._options.nearInteractionControllerMode||!n.xrController.inputSource.gamepad)){n.pick=null;return}if(n.hoverInteraction=!1,n.nearInteraction=!1,n.xrController){if(a){const u=a.get("index-finger-tip");if(u){const h=e.getJointPose(u,this._xrSessionManager.referenceSpace);if(h&&h.transform){const d=this._scene.useRightHandedSystem?1:-1;G.Vector3[0].set(h.transform.position.x,h.transform.position.y,h.transform.position.z*d),G.Quaternion[0].set(h.transform.orientation.x,h.transform.orientation.y,h.transform.orientation.z*d,h.transform.orientation.w*d),this._processTouchPoint(r,G.Vector3[0],G.Quaternion[0])}}}else if(n.xrController.inputSource.gamepad&&this._options.nearInteractionControllerMode!==0){let u=n.xrController.pointer;n.xrController.grip&&this._options.nearInteractionControllerMode===1&&(u=n.xrController.grip),this._processTouchPoint(r,u.position,u.rotationQuaternion)}}else return;const o=(u,h)=>{let d=null;return!h||!h.hit?d=u:!u||!u.hit||h.distance<u.distance?d=h:d=u,d},l=u=>{let h=new Li,d=!1;const f=u&&u.pickedPoint&&u.hit;return u!=null&&u.pickedPoint&&(d=u.pickedPoint.x===0&&u.pickedPoint.y===0&&u.pickedPoint.z===0),f&&!d&&(h=u),h};if(!n.grabInteraction){let u=null,h=null;this._options.useUtilityLayer&&this._utilityLayerScene&&(h=this._pickWithSphere(n,this._hoverRadius*this._xrSessionManager.worldScalingFactor,this._utilityLayerScene,m=>this._nearInteractionPredicate(m)));const d=this._pickWithSphere(n,this._hoverRadius*this._xrSessionManager.worldScalingFactor,this._scene,m=>this._nearInteractionPredicate(m)),f=o(d,h);if(f&&f.hit&&(u=l(f),u.hit&&(n.hoverInteraction=!0)),n.hoverInteraction){let m=null;const g=(a?this._pickRadius:this._controllerPickRadius)*this._xrSessionManager.worldScalingFactor;this._options.useUtilityLayer&&this._utilityLayerScene&&(m=this._pickWithSphere(n,g,this._utilityLayerScene,C=>this._nearPickPredicate(C)));const v=this._pickWithSphere(n,g,this._scene,C=>this._nearPickPredicate(C)),E=o(v,m),T=l(E);T.hit&&(u=T,n.nearInteraction=!0)}n.stalePick=n.pick,n.pick=u,n.pick&&n.pick.pickedPoint&&n.pick.hit?(n.meshUnderPointer=n.pick.pickedMesh,n.pickedPointVisualCue.position.copyFrom(n.pick.pickedPoint),n.pickedPointVisualCue.isVisible=!this.alwaysHideSelectionMesh,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(n.id,!0)):(n.meshUnderPointer=null,n.pickedPointVisualCue.isVisible=!1,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(n.id,!1))}let c=dr.DEHYDRATED;n.grabInteraction||n.nearInteraction?c=dr.TOUCH:n.hoverInteraction&&(c=dr.HOVER),this._handleTransitionAnimation(n,c)}}get _utilityLayerScene(){return this._options.customUtilityLayerScene||Lt.DefaultUtilityLayer.utilityLayerScene}_generateVisualCue(){const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Lt.DefaultUtilityLayer.utilityLayerScene:this._scene,t=Sn("nearInteraction",{diameter:.0035*3*this._xrSessionManager.worldScalingFactor},e);t.bakeCurrentTransformIntoVertices(),t.isPickable=!1,t.isVisible=!1,t.rotationQuaternion=Z.Identity();const i=new Lr("targetMat",e);return i.specularColor=q.Black(),i.emissiveColor=this.selectionMeshDefaultColor,i.backFaceCulling=!1,t.material=i,t}_isControllerReadyForNearInteraction(e){return this._farInteractionFeature?this._farInteractionFeature._getPointerSelectionDisabledByPointerId(e):!0}_attachNearInteractionMode(e){const t=this._controllers[e.uniqueId],i={pointerId:t.id,pointerType:"xr-near"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{!this._options.enableNearInteractionOnAllControllers&&e.uniqueId!==this._attachedController||!t.xrController||!t.xrController.inputSource.hand&&(!this._options.nearInteractionControllerMode||!t.xrController.inputSource.gamepad)||(t.pick&&(t.pick.ray=t.grabRay),t.pick&&this._isControllerReadyForNearInteraction(t.id)&&this._scene.simulatePointerMove(t.pick,i),t.nearInteraction&&t.pick&&t.pick.hit?t.nearInteractionTargetMesh||(this._scene.simulatePointerDown(t.pick,i),t.nearInteractionTargetMesh=t.meshUnderPointer,t.downTriggered=!0):t.nearInteractionTargetMesh&&t.stalePick&&(this._scene.simulatePointerUp(t.stalePick,i),t.downTriggered=!1,t.nearInteractionTargetMesh=null))});const r=n=>{this._options.enableNearInteractionOnAllControllers||e.uniqueId===this._attachedController&&this._isControllerReadyForNearInteraction(t.id)?(t.pick&&(t.pick.ray=t.grabRay),n&&t.pick&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)?(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i),t.downTriggered=!0):!n&&t.pick&&t.grabInteraction&&(this._scene.simulatePointerUp(t.pick,i),t.downTriggered=!1,t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!this.alwaysHideSelectionMesh)):n&&!this._options.enableNearInteractionOnAllControllers&&!this._options.disableSwitchOnClick&&(this._attachedController=e.uniqueId)};if(e.inputSource.gamepad){const n=a=>{t.squeezeComponent=a.getComponent("grasp"),t.squeezeComponent?t.onSqueezeButtonChangedObserver=t.squeezeComponent.onButtonStateChangedObservable.add(o=>{if(o.changes.pressed){const l=o.changes.pressed.current;r(l)}}):(t.selectionComponent=a.getMainComponent(),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add(o=>{if(o.changes.pressed){const l=o.changes.pressed.current;r(l)}}))};e.motionController?n(e.motionController):e.onMotionControllerInitObservable.add(n)}else{const n=o=>{t.xrController&&o.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)&&(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i),t.downTriggered=!0)},a=o=>{t.xrController&&o.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&(this._scene.simulatePointerUp(t.pick,i),t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!this.alwaysHideSelectionMesh,t.downTriggered=!1)};t.eventListeners={selectend:a,selectstart:n},this._xrSessionManager.session.addEventListener("selectstart",n),this._xrSessionManager.session.addEventListener("selectend",a)}}_detachController(e){const t=this._controllers[e];if(t){if(t.squeezeComponent&&t.onSqueezeButtonChangedObserver&&t.squeezeComponent.onButtonStateChangedObservable.remove(t.onSqueezeButtonChangedObserver),t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners){const i=Object.keys(t.eventListeners);for(const r of i){const n=t.eventListeners&&t.eventListeners[r];n&&this._xrSessionManager.session.removeEventListener(r,n)}}if(t.touchCollisionMesh.dispose(),t.pickedPointVisualCue.dispose(),this._xrSessionManager.runInXRFrame(()=>{if(!t.downTriggered)return;const i={pointerId:t.id,pointerType:"xr-near"};this._scene.simulatePointerUp(new Li,i)}),t._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(t._worldScaleObserver),delete this._controllers[e],this._attachedController===e){const i=Object.keys(this._controllers);i.length?this._attachedController=i[0]:this._attachedController=""}}}_generateNewTouchPointMesh(){const e=this._xrSessionManager.worldScalingFactor,t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Lt.DefaultUtilityLayer.utilityLayerScene:this._scene,i=Sn("PickSphere",{diameter:1*e},t);if(i.isVisible=!1,this._options.motionControllerOrbMaterial)i.material=this._options.motionControllerOrbMaterial;else{let D;this._options.motionControllerTouchMaterialSnippetUrl?D=it.ParseFromFileAsync("motionControllerTouchMaterial",this._options.motionControllerTouchMaterialSnippetUrl,t):D=it.ParseFromSnippetAsync("8RUNKL#3",t),D.then(w=>{i.material=w}).catch(w=>{N.Warn(`Error creating touch material in WebXRNearInteraction: ${w}`)})}const r=new la;r.setEasingMode(Yc.EASINGMODE_EASEINOUT);const n=new x(this._controllerPickRadius,this._controllerPickRadius,this._controllerPickRadius).scaleInPlace(e),a=this._controllerPickRadius*(4/3),o=new x(a,a,a).scaleInPlace(e),l=this._controllerPickRadius*(7/6),c=new x(l,l,l).scaleInPlace(e),u=this._controllerPickRadius*(4/5),h=new x(u,u,u).scaleInPlace(e),d=this._controllerPickRadius*(3/2),f=new x(d,d,d).scaleInPlace(e),m=[{frame:0,value:n},{frame:10,value:f},{frame:18,value:o}],g=[{frame:0,value:o},{frame:10,value:h},{frame:18,value:n}],v=[{frame:0,value:x.ZeroReadOnly},{frame:12,value:c},{frame:15,value:n}],E=[{frame:0,value:n},{frame:10,value:x.ZeroReadOnly},{frame:15,value:x.ZeroReadOnly}],T=new pe("touch","scaling",60,pe.ANIMATIONTYPE_VECTOR3,pe.ANIMATIONLOOPMODE_CONSTANT),C=new pe("release","scaling",60,pe.ANIMATIONTYPE_VECTOR3,pe.ANIMATIONLOOPMODE_CONSTANT),A=new pe("hydrate","scaling",60,pe.ANIMATIONTYPE_VECTOR3,pe.ANIMATIONLOOPMODE_CONSTANT),I=new pe("dehydrate","scaling",60,pe.ANIMATIONTYPE_VECTOR3,pe.ANIMATIONLOOPMODE_CONSTANT);return T.setEasingFunction(r),C.setEasingFunction(r),A.setEasingFunction(r),I.setEasingFunction(r),T.setKeys(m),C.setKeys(g),A.setKeys(v),I.setKeys(E),{touchCollisionMesh:i,touchCollisionMeshFunction:D=>{const w=D?T:C;t.beginDirectAnimation(i,[w],0,18,!1,1)},hydrateCollisionMeshFunction:D=>{const w=D?A:I;D&&(i.isVisible=!0),t.beginDirectAnimation(i,[w],0,15,!1,1,()=>{D||(i.isVisible=!1)})}}}_pickWithSphere(e,t,i,r){const n=new Li;if(n.distance=1/0,e.touchCollisionMesh&&e.xrController){const a=e.touchCollisionMesh.position,o=mg.CreateFromCenterAndRadius(a,t);for(let l=0;l<i.meshes.length;l++){const c=i.meshes[l];if(!r(c)||!this._controllerAvailablePredicate(c,e.xrController.uniqueId))continue;const u=$s.PickMeshWithSphere(c,o);u&&u.hit&&u.distance<n.distance&&(n.hit=u.hit,n.pickedMesh=c,n.pickedPoint=u.pickedPoint,n.aimTransform=e.xrController.pointer,n.gripTransform=e.xrController.grip||null,n.originMesh=e.touchCollisionMesh,n.distance=u.distance,n.bu=u.bu,n.bv=u.bv,n.faceId=u.faceId,n.subMeshId=u.subMeshId)}}return n}static PickMeshWithSphere(e,t,i=!1){const r=e.subMeshes,n=new Li,a=e.getBoundingInfo();if(!e._generatePointsArray()||!e.subMeshes||!a||!i&&!mg.Intersects(a.boundingSphere,t))return n;const o=Ja[0],l=Ja[1];Ja[2].setAll(0),Ja[3].setAll(0);const c=new xe(Ja[2],Ja[3],1);let u=1/0,h,d,f,m;const g=G.Vector3[2],v=G.Matrix[0];v.copyFrom(e.getWorldMatrix()),v.invert(),x.TransformCoordinatesToRef(t.center,v,g);for(let E=0;E<r.length;E++)r[E].projectToRef(g,e._positions,e.getIndices(),l),x.TransformCoordinatesToRef(l,e.getWorldMatrix(),l),h=x.Distance(l,t.center),f=x.DistanceSquared(l,e.getAbsolutePosition()),d=x.DistanceSquared(t.center,e.getAbsolutePosition()),d!==-1&&f!==-1&&f>d&&(h=0,l.copyFrom(t.center)),h!==-1&&h<u&&(u=h,xe.CreateFromToToRef(t.center,l,c),c.length=u*2,m=c.intersectsMesh(e),o.copyFrom(l));return u<t.radius&&(n.hit=!0,n.distance=u,n.pickedMesh=e,n.pickedPoint=o.clone(),m&&m.bu!==null&&m.bv!==null&&(n.faceId=m.faceId,n.subMeshId=m.subMeshId,n.bu=m.bu,n.bv=m.bv)),n}}$s._IdCounter=200;$s.Name=Ne.NEAR_INTERACTION;$s.Version=1;At.AddWebXRFeature($s.Name,(s,e)=>()=>new $s(s,e),$s.Version,!0);class zV{constructor(e,t,i){this.element=e,this.sessionMode=t,this.referenceSpaceType=i}update(e){}}class O_{constructor(e,t){if(this._scene=e,this.options=t,this._activeButton=null,this._buttons=[],this.activeButtonChangedObservable=new k,this._onSessionGranted=r=>{this._helper&&this._enterXRWithButtonIndexAsync(0)},this.overlay=document.createElement("div"),this.overlay.classList.add("xr-button-overlay"),!t.ignoreSessionGrantedEvent&&navigator.xr&&navigator.xr.addEventListener("sessiongranted",this._onSessionGranted),typeof window<"u"&&window.location&&window.location.protocol==="http:"&&window.location.hostname!=="localhost")throw j.Warn("WebXR can only be served over HTTPS"),new Error("WebXR can only be served over HTTPS");if(t.customButtons)this._buttons=t.customButtons;else{this.overlay.style.cssText="z-index:11;position: absolute; right: 20px;bottom: 50px;";const r=t.sessionMode||"immersive-vr",n=t.referenceSpaceType||"local-floor";let o=".babylonVRicon { color: #868686; border-color: #868686; border-style: solid; margin-left: 10px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+(typeof SVGSVGElement>"u"?"https://cdn.babylonjs.com/Assets/vrButton.png":"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";o+='.babylonVRicon.vrdisplaypresenting { background-image: none;} .vrdisplaypresenting::after { content: "EXIT"} .xr-error::after { content: "ERROR"}';const l=document.createElement("style");l.appendChild(document.createTextNode(o)),document.getElementsByTagName("head")[0].appendChild(l);const c=document.createElement("button");c.className="babylonVRicon",c.title=`${r} - ${n}`,this._buttons.push(new zV(c,r,n)),this._buttons[this._buttons.length-1].update=function(u){this.element.style.display=u===null||u===this?"":"none",c.className="babylonVRicon"+(u===this?" vrdisplaypresenting":"")},this._updateButtons(null)}const i=e.getEngine().getInputElement();i&&i.parentNode&&(i.parentNode.appendChild(this.overlay),e.onDisposeObservable.addOnce(()=>{this.dispose()}))}async setHelperAsync(e,t){this._helper=e,this._renderTarget=t;const i=this._buttons.map(async n=>await e.sessionManager.isSessionSupportedAsync(n.sessionMode));e.onStateChangedObservable.add(n=>{n==3&&this._updateButtons(null)});const r=await Promise.all(i);for(let n=0;n<r.length;n++)r[n]?(this.overlay.appendChild(this._buttons[n].element),this._buttons[n].element.onclick=this._enterXRWithButtonIndexAsync.bind(this,n)):j.Warn(`Session mode "${this._buttons[n].sessionMode}" not supported in browser`)}static async CreateAsync(e,t,i){const r=new O_(e,i);return await r.setHelperAsync(t,i.renderTarget||void 0),r}async _enterXRWithButtonIndexAsync(e=0){if(this._helper.state==2)await this._helper.exitXRAsync(),this._updateButtons(null);else if(this._helper.state==3)try{await this._helper.enterXRAsync(this._buttons[e].sessionMode,this._buttons[e].referenceSpaceType,this._renderTarget,{optionalFeatures:this.options.optionalFeatures,requiredFeatures:this.options.requiredFeatures}),this._updateButtons(this._buttons[e])}catch(t){this._updateButtons(null);const i=this._buttons[e].element,r=i.title;i.title="Error entering XR session : "+r,i.classList.add("xr-error"),this.options.onError&&this.options.onError(t)}}dispose(){const e=this._scene.getEngine().getInputElement();e&&e.parentNode&&e.parentNode.contains(this.overlay)&&e.parentNode.removeChild(this.overlay),this.activeButtonChangedObservable.clear(),navigator.xr.removeEventListener("sessiongranted",this._onSessionGranted)}_updateButtons(e){this._activeButton=e;for(const t of this._buttons)t.update(this._activeButton);this.activeButtonChangedObservable.notifyObservers(this._activeButton)}}var jv;(function(s){s.WRIST="wrist",s.THUMB="thumb",s.INDEX="index",s.MIDDLE="middle",s.RING="ring",s.LITTLE="little"})(jv||(jv={}));var qv;(function(s){s.WRIST="wrist",s.THUMB_METACARPAL="thumb-metacarpal",s.THUMB_PHALANX_PROXIMAL="thumb-phalanx-proximal",s.THUMB_PHALANX_DISTAL="thumb-phalanx-distal",s.THUMB_TIP="thumb-tip",s.INDEX_FINGER_METACARPAL="index-finger-metacarpal",s.INDEX_FINGER_PHALANX_PROXIMAL="index-finger-phalanx-proximal",s.INDEX_FINGER_PHALANX_INTERMEDIATE="index-finger-phalanx-intermediate",s.INDEX_FINGER_PHALANX_DISTAL="index-finger-phalanx-distal",s.INDEX_FINGER_TIP="index-finger-tip",s.MIDDLE_FINGER_METACARPAL="middle-finger-metacarpal",s.MIDDLE_FINGER_PHALANX_PROXIMAL="middle-finger-phalanx-proximal",s.MIDDLE_FINGER_PHALANX_INTERMEDIATE="middle-finger-phalanx-intermediate",s.MIDDLE_FINGER_PHALANX_DISTAL="middle-finger-phalanx-distal",s.MIDDLE_FINGER_TIP="middle-finger-tip",s.RING_FINGER_METACARPAL="ring-finger-metacarpal",s.RING_FINGER_PHALANX_PROXIMAL="ring-finger-phalanx-proximal",s.RING_FINGER_PHALANX_INTERMEDIATE="ring-finger-phalanx-intermediate",s.RING_FINGER_PHALANX_DISTAL="ring-finger-phalanx-distal",s.RING_FINGER_TIP="ring-finger-tip",s.PINKY_FINGER_METACARPAL="pinky-finger-metacarpal",s.PINKY_FINGER_PHALANX_PROXIMAL="pinky-finger-phalanx-proximal",s.PINKY_FINGER_PHALANX_INTERMEDIATE="pinky-finger-phalanx-intermediate",s.PINKY_FINGER_PHALANX_DISTAL="pinky-finger-phalanx-distal",s.PINKY_FINGER_TIP="pinky-finger-tip"})(qv||(qv={}));const qr=["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"],WV={wrist:["wrist"],thumb:["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],index:["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],middle:["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],ring:["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],little:["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]};class HV{get handMesh(){return this._handMesh}getHandPartMeshes(e){return WV[e].map(t=>this._jointMeshes[qr.indexOf(t)])}getJointMesh(e){return this._jointMeshes[qr.indexOf(e)]}constructor(e,t,i,r,n=!1,a=!1,o=1){var l;this.xrController=e,this._jointMeshes=t,this._handMesh=i,this.rigMapping=r,this._leftHandedMeshes=n,this._jointsInvisible=a,this._jointScaleFactor=o,this.onHandMeshSetObservable=new k,this._jointTransforms=new Array(qr.length),this._jointTransformMatrices=new Float32Array(qr.length*16),this._tempJointMatrix=new z,this._jointRadii=new Float32Array(qr.length),this._handMeshRoot=null,this._scene=t[0].getScene();for(let c=0;c<this._jointTransforms.length;c++)this._jointTransforms[c]=new Es(qr[c],this._scene),this._jointTransforms[c].rotationQuaternion=new Z,t[c].rotationQuaternion?t[c].rotationQuaternion=new Z:(l=t[c].rotationQuaternion)==null||l.set(0,0,0,1);i&&this.setHandMesh(i,r),this.xrController.motionController&&this.xrController.motionController.rootMesh&&this.xrController.motionController.rootMesh.dispose(!1,!0),this.xrController.onMotionControllerInitObservable.add(c=>{c._doNotLoadControllerMesh=!0})}setHandMesh(e,t,i){for(this._handMesh=e,this._handMeshRoot=this._handMesh;this._handMeshRoot.parent;)this._handMeshRoot=this._handMeshRoot.parent;e.alwaysSelectAsActiveMesh=!0;const r=e.getChildMeshes();for(const n of r)n.alwaysSelectAsActiveMesh=!0;if(this._handMesh.skeleton){const n=this._handMesh.skeleton;for(let a=0;a<qr.length;a++){const o=qr[a],l=n.getBoneIndexByName(t?t[o]:o);l!==-1&&n.bones[l].linkTransformNode(this._jointTransforms[a])}}this.onHandMeshSetObservable.notifyObservers(this)}updateFromXRFrame(e,t,i){const r=this.xrController.inputSource.hand;if(!r)return;const n=r,a=qr.map(l=>n[l]||r.get(l));let o=!1;if(e.fillPoses&&e.fillJointRadii)o=e.fillPoses(a,t,this._jointTransformMatrices)&&e.fillJointRadii(a,this._jointRadii);else if(e.getJointPose){o=!0;for(let l=0;l<a.length;l++){const c=e.getJointPose(a[l],t);if(c)this._jointTransformMatrices.set(c.transform.matrix,l*16),this._jointRadii[l]=c.radius||.008;else{o=!1;break}}}if(o){for(let l=0;l<qr.length;l++){const c=this._jointTransforms[l];z.FromArrayToRef(this._jointTransformMatrices,l*16,this._tempJointMatrix),this._tempJointMatrix.decompose(void 0,c.rotationQuaternion,c.position);const u=this._jointRadii[l]*this._jointScaleFactor,h=this._jointMeshes[l];h.isVisible=!this._handMesh&&!this._jointsInvisible,h.position.copyFrom(c.position),h.rotationQuaternion.copyFrom(c.rotationQuaternion),h.scaling.setAll(u),h.parent=i.parent,this._scene.useRightHandedSystem||(h.position.z*=-1,h.rotationQuaternion.z*=-1,h.rotationQuaternion.w*=-1,this._leftHandedMeshes&&this._handMesh&&(c.position.z*=-1,c.rotationQuaternion.z*=-1,c.rotationQuaternion.w*=-1))}this._handMesh&&(this._handMesh.isVisible=!0,this._handMeshRoot&&(this._handMeshRoot.parent=i.parent)),this.xrController.pointer.parent=i.parent}}dispose(e=!1){var t;this._handMesh&&(e?((t=this._handMesh.skeleton)==null||t.dispose(),this._handMesh.dispose(!1,!0)):this._handMesh.isVisible=!1);for(const i of this._jointTransforms)i.dispose();this._jointTransforms.length=0,this.onHandMeshSetObservable.clear()}}class Fe extends pi{static _GenerateTrackedJointMeshes(e,t=_g("jointParent",Fe._ICOSPHERE_PARAMS)){const i={};return["left","right"].map(r=>{var a,o,l,c;const n=[];t.isVisible=!!((a=e.jointMeshes)!=null&&a.keepOriginalVisible);for(let u=0;u<qr.length;++u){let h=t.createInstance(`${r}-handJoint-${u}`);if((o=e.jointMeshes)!=null&&o.onHandJointMeshGenerated){const d=e.jointMeshes.onHandJointMeshGenerated(h,u,r);d&&d!==h&&(h.dispose(),h=d)}if(h.isPickable=!1,(l=e.jointMeshes)!=null&&l.enablePhysics){const d=((c=e.jointMeshes)==null?void 0:c.physicsProps)||{};h.scaling.setAll(.02);const f=d.impostorType!==void 0?d.impostorType:ue.SphereImpostor;h.physicsImpostor=new ue(h,f,{mass:0,...d})}h.rotationQuaternion=new Z,h.isVisible=!1,n.push(h)}i[r]=n}),{left:i.left,right:i.right}}static async _GenerateDefaultHandMeshesAsync(e,t,i){return await new Promise(async r=>{var g,v,E,T,C,A,I;const n={};(v=(g=Fe._RightHandGLB)==null?void 0:g.meshes[1])!=null&&v.isDisposed()&&(Fe._RightHandGLB=null),(T=(E=Fe._LeftHandGLB)==null?void 0:E.meshes[1])!=null&&T.isDisposed()&&(Fe._LeftHandGLB=null);const a=!!(Fe._RightHandGLB&&Fe._LeftHandGLB),o=j.GetAssetUrl(Fe.DEFAULT_HAND_MODEL_BASE_URL),l=await Promise.all([Fe._RightHandGLB||Nl.ImportMeshAsync("",o,Fe.DEFAULT_HAND_MODEL_RIGHT_FILENAME,e),Fe._LeftHandGLB||Nl.ImportMeshAsync("",o,Fe.DEFAULT_HAND_MODEL_LEFT_FILENAME,e)]);Fe._RightHandGLB=l[0],Fe._LeftHandGLB=l[1];const c=j.GetAssetUrl(Fe.DEFAULT_HAND_MODEL_SHADER_URL),u=await it.ParseFromFileAsync("handShader",c,e,void 0,!0);u.needDepthPrePass=!0,u.transparencyMode=Le.MATERIAL_ALPHABLEND,u.alphaMode=2,u.build(!1);const h={base:q.FromInts(116,63,203),fresnel:q.FromInts(149,102,229),fingerColor:q.FromInts(177,130,255),tipFresnel:q.FromInts(220,200,255),...(C=i==null?void 0:i.handMeshes)==null?void 0:C.customColors},d={base:u.getBlockByName("baseColor"),fresnel:u.getBlockByName("fresnelColor"),fingerColor:u.getBlockByName("fingerColor"),tipFresnel:u.getBlockByName("tipFresnelColor")};d.base.value=h.base,d.fresnel.value=h.fresnel,d.fingerColor.value=h.fingerColor,d.tipFresnel.value=h.tipFresnel;const f=(A=t._getBaseLayerWrapper())==null?void 0:A.isMultiview,m=["left","right"];for(const F of m){const V=F=="left"?Fe._LeftHandGLB:Fe._RightHandGLB;if(!V)throw new Error("Could not load hand model");const D=V.meshes[1];D._internalAbstractMeshDataInfo._computeBonesUsingShaders=!0,!f&&!((I=i==null?void 0:i.handMeshes)!=null&&I.disableHandShader)&&(D.material=u.clone(`${F}HandShaderClone`,!0)),D.isVisible=!1,n[F]=D,!a&&!e.useRightHandedSystem&&V.meshes[1].rotate(Ms.Y,Math.PI)}u.dispose(),r({left:n.left,right:n.right})})}static _GenerateDefaultHandMeshRigMapping(e){const t=e=="right"?"R":"L";return{wrist:`wrist_${t}`,"thumb-metacarpal":`thumb_metacarpal_${t}`,"thumb-phalanx-proximal":`thumb_proxPhalanx_${t}`,"thumb-phalanx-distal":`thumb_distPhalanx_${t}`,"thumb-tip":`thumb_tip_${t}`,"index-finger-metacarpal":`index_metacarpal_${t}`,"index-finger-phalanx-proximal":`index_proxPhalanx_${t}`,"index-finger-phalanx-intermediate":`index_intPhalanx_${t}`,"index-finger-phalanx-distal":`index_distPhalanx_${t}`,"index-finger-tip":`index_tip_${t}`,"middle-finger-metacarpal":`middle_metacarpal_${t}`,"middle-finger-phalanx-proximal":`middle_proxPhalanx_${t}`,"middle-finger-phalanx-intermediate":`middle_intPhalanx_${t}`,"middle-finger-phalanx-distal":`middle_distPhalanx_${t}`,"middle-finger-tip":`middle_tip_${t}`,"ring-finger-metacarpal":`ring_metacarpal_${t}`,"ring-finger-phalanx-proximal":`ring_proxPhalanx_${t}`,"ring-finger-phalanx-intermediate":`ring_intPhalanx_${t}`,"ring-finger-phalanx-distal":`ring_distPhalanx_${t}`,"ring-finger-tip":`ring_tip_${t}`,"pinky-finger-metacarpal":`little_metacarpal_${t}`,"pinky-finger-phalanx-proximal":`little_proxPhalanx_${t}`,"pinky-finger-phalanx-intermediate":`little_intPhalanx_${t}`,"pinky-finger-phalanx-distal":`little_distPhalanx_${t}`,"pinky-finger-tip":`little_tip_${t}`}}isCompatible(){return typeof XRHand<"u"}getHandByControllerId(e){return this._attachedHands[e]}getHandByHandedness(e){return e=="none"?null:this._trackingHands[e]}constructor(e,t){super(e),this.options=t,this._attachedHands={},this._trackingHands={left:null,right:null},this._handResources={jointMeshes:null,handMeshes:null,rigMappings:null},this._worldScaleObserver=null,this.onHandAddedObservable=new k,this.onHandRemovedObservable=new k,this._attachHand=n=>{var l,c,u;if(!n.inputSource.hand||n.inputSource.handedness=="none"||!this._handResources.jointMeshes)return;const a=n.inputSource.handedness,o=new HV(n,this._handResources.jointMeshes[a],this._handResources.handMeshes&&this._handResources.handMeshes[a],this._handResources.rigMappings&&this._handResources.rigMappings[a],(l=this.options.handMeshes)==null?void 0:l.meshesUseLeftHandedCoordinates,(c=this.options.jointMeshes)==null?void 0:c.invisible,(u=this.options.jointMeshes)==null?void 0:u.scaleFactor);this._attachedHands[n.uniqueId]=o,this._trackingHands[a]=o,this.onHandAddedObservable.notifyObservers(o)},this._detachHand=n=>{this._detachHandById(n.uniqueId)},this.xrNativeFeatureName="hand-tracking";const r=t.jointMeshes;if(r&&(typeof r.disableDefaultHandMesh<"u"&&(t.handMeshes=t.handMeshes||{},t.handMeshes.disableDefaultMeshes=r.disableDefaultHandMesh),typeof r.handMeshes<"u"&&(t.handMeshes=t.handMeshes||{},t.handMeshes.customMeshes=r.handMeshes),typeof r.leftHandedSystemMeshes<"u"&&(t.handMeshes=t.handMeshes||{},t.handMeshes.meshesUseLeftHandedCoordinates=r.leftHandedSystemMeshes),typeof r.rigMapping<"u")){t.handMeshes=t.handMeshes||{};const n={},a={},o=[[r.rigMapping.left,n],[r.rigMapping.right,a]];for(const l of o){const c=l[0],u=l[1];for(let h=0;h<c.length;h++){const d=c[h];u[qr[h]]=d}}t.handMeshes.customRigMappings={left:n,right:a}}}attach(){var e,t,i,r,n;if(!super.attach())return!1;this._handResources.jointMeshes||(this._originalMesh=this._originalMesh||((e=this.options.jointMeshes)==null?void 0:e.sourceMesh)||_g("jointParent",Fe._ICOSPHERE_PARAMS),this._originalMesh.isVisible=!1,this._handResources.jointMeshes=Fe._GenerateTrackedJointMeshes(this.options,this._originalMesh)),this._handResources.handMeshes=((t=this.options.handMeshes)==null?void 0:t.customMeshes)||null,this._handResources.rigMappings=((i=this.options.handMeshes)==null?void 0:i.customRigMappings)||null,!((r=this.options.handMeshes)!=null&&r.customMeshes)&&!((n=this.options.handMeshes)!=null&&n.disableDefaultMeshes)&&(Fe._GenerateDefaultHandMeshesAsync(De.LastCreatedScene,this._xrSessionManager,this.options).then(a=>{var o,l;this._handResources.handMeshes=a,this._handResources.rigMappings={left:Fe._GenerateDefaultHandMeshRigMapping("left"),right:Fe._GenerateDefaultHandMeshRigMapping("right")},(o=this._trackingHands.left)==null||o.setHandMesh(this._handResources.handMeshes.left,this._handResources.rigMappings.left,this._xrSessionManager),(l=this._trackingHands.right)==null||l.setHandMesh(this._handResources.handMeshes.right,this._handResources.rigMappings.right,this._xrSessionManager),this._handResources.handMeshes.left.scaling.setAll(this._xrSessionManager.worldScalingFactor),this._handResources.handMeshes.right.scaling.setAll(this._xrSessionManager.worldScalingFactor)}),this._worldScaleObserver=this._xrSessionManager.onWorldScaleFactorChangedObservable.add(a=>{this._handResources.handMeshes&&(this._handResources.handMeshes.left.scaling.scaleInPlace(a.newScaleFactor/a.previousScaleFactor),this._handResources.handMeshes.right.scaling.scaleInPlace(a.newScaleFactor/a.previousScaleFactor))}));for(const a of this.options.xrInput.controllers)this._attachHand(a);return this._addNewAttachObserver(this.options.xrInput.onControllerAddedObservable,this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerRemovedObservable,this._detachHand),!0}_onXRFrame(e){var t,i;(t=this._trackingHands.left)==null||t.updateFromXRFrame(e,this._xrSessionManager.referenceSpace,this.options.xrInput.xrCamera),(i=this._trackingHands.right)==null||i.updateFromXRFrame(e,this._xrSessionManager.referenceSpace,this.options.xrInput.xrCamera)}_detachHandById(e,t){var r;const i=this.getHandByControllerId(e);if(i){const n=i.xrController.inputSource.handedness=="left"?"left":"right";((r=this._trackingHands[n])==null?void 0:r.xrController.uniqueId)===e&&(this._trackingHands[n]=null),this.onHandRemovedObservable.notifyObservers(i),i.dispose(t),delete this._attachedHands[e]}}detach(){var t,i,r;if(!super.detach())return!1;const e=Object.keys(this._attachedHands);for(const n of e)this._detachHandById(n,(t=this.options.handMeshes)==null?void 0:t.disposeOnSessionEnd);if((i=this.options.handMeshes)!=null&&i.disposeOnSessionEnd){if(this._handResources.jointMeshes){for(const n of this._handResources.jointMeshes.left)n.dispose();for(const n of this._handResources.jointMeshes.right)n.dispose();this._handResources.jointMeshes=null}if(this._handResources.handMeshes&&(this._handResources.handMeshes.left.dispose(),this._handResources.handMeshes.right.dispose(),this._handResources.handMeshes=null),Fe._RightHandGLB)for(const n of Fe._RightHandGLB.meshes)n.dispose();if(Fe._LeftHandGLB)for(const n of Fe._LeftHandGLB.meshes)n.dispose();Fe._RightHandGLB=null,Fe._LeftHandGLB=null,(r=this._originalMesh)==null||r.dispose(),this._originalMesh=void 0}return this._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(this._worldScaleObserver),!0}dispose(){var e;if(super.dispose(),this.onHandAddedObservable.clear(),this.onHandRemovedObservable.clear(),this._handResources.handMeshes&&!((e=this.options.handMeshes)!=null&&e.customMeshes)){if(this._handResources.handMeshes.left.dispose(),this._handResources.handMeshes.right.dispose(),Fe._RightHandGLB)for(const t of Fe._RightHandGLB.meshes)t.dispose();if(Fe._LeftHandGLB)for(const t of Fe._LeftHandGLB.meshes)t.dispose();Fe._RightHandGLB=null,Fe._LeftHandGLB=null}if(this._handResources.jointMeshes){for(const t of this._handResources.jointMeshes.left)t.dispose();for(const t of this._handResources.jointMeshes.right)t.dispose()}}}Fe.Name=Ne.HAND_TRACKING;Fe.Version=1;Fe.DEFAULT_HAND_MODEL_BASE_URL="https://assets.babylonjs.com/core/HandMeshes/";Fe.DEFAULT_HAND_MODEL_RIGHT_FILENAME="r_hand_rhs.glb";Fe.DEFAULT_HAND_MODEL_LEFT_FILENAME="l_hand_rhs.glb";Fe.DEFAULT_HAND_MODEL_SHADER_URL="https://assets.babylonjs.com/core/HandMeshes/handsShader.json";Fe._ICOSPHERE_PARAMS={radius:.5,flat:!1,subdivisions:2};Fe._RightHandGLB=null;Fe._LeftHandGLB=null;At.AddWebXRFeature(Fe.Name,(s,e)=>()=>new Fe(s,e),Fe.Version,!1);class co extends pi{get rotationEnabled(){return this._rotationEnabled}set rotationEnabled(e){if(this._rotationEnabled=e,this._options.teleportationTargetMesh){const t=this._options.teleportationTargetMesh.getChildMeshes(!1,i=>i.name==="rotationCone");t[0]&&t[0].setEnabled(e)}}get teleportationTargetMesh(){return this._options.teleportationTargetMesh||null}constructor(e,t){super(e),this._options=t,this._controllers={},this._snappedToPoint=!1,this._cachedColor4White=new Te(1,1,1,1),this._tmpRay=new xe(new x,new x),this._tmpVector=new x,this._tmpQuaternion=new Z,this._worldScaleObserver=null,this.skipNextTeleportation=!1,this.backwardsMovementEnabled=!0,this.backwardsTeleportationDistance=.7,this.parabolicCheckRadius=5,this.parabolicRayEnabled=!0,this.straightRayEnabled=!0,this.rotationAngle=Math.PI/8,this.onTargetMeshPositionUpdatedObservable=new k,this.teleportationEnabled=!0,this._rotationEnabled=!0,this.onBeforeCameraTeleportRotation=new k,this.onAfterCameraTeleportRotation=new k,this._attachController=i=>{if(this._controllers[i.uniqueId]||this._options.forceHandedness&&i.inputSource.handedness!==this._options.forceHandedness)return;this._controllers[i.uniqueId]={xrController:i,teleportationState:{forward:!1,backwards:!1,rotating:!1,currentRotation:0,baseRotation:0,blocked:!1,initialHit:!1,mainComponentUsed:!1}};const r=this._controllers[i.uniqueId];if(r.xrController.inputSource.targetRayMode==="tracked-pointer"&&r.xrController.inputSource.gamepad){const n=()=>{if(i.motionController){const a=i.motionController.getComponentOfType(vr.THUMBSTICK_TYPE)||i.motionController.getComponentOfType(vr.TOUCHPAD_TYPE);if(!a||this._options.useMainComponentOnly){const o=i.motionController.getMainComponent();if(!o)return;r.teleportationState.mainComponentUsed=!0,r.teleportationComponent=o,r.onButtonChangedObserver=o.onButtonStateChangedObservable.add(()=>{if(!this.teleportationEnabled)return;const l=()=>{r.teleportationState.forward=!0,r.teleportationState.initialHit=!1,this._currentTeleportationControllerId=r.xrController.uniqueId,r.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,r.teleportationState.currentRotation=0;const c=this._options.timeToTeleport||3e3;Rc({timeout:c,contextObservable:this._xrSessionManager.onXRFrameObservable,breakCondition:()=>!o.pressed,onEnded:()=>{this._currentTeleportationControllerId===r.xrController.uniqueId&&r.teleportationState.forward&&this._teleportForward(i.uniqueId)}})};o.changes.pressed&&(o.changes.pressed.current?this._options.timeToTeleportStart?Rc({timeout:this._options.timeToTeleportStart,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{o.pressed&&l()}}):l():(r.teleportationState.forward=!1,this._currentTeleportationControllerId=""))})}else r.teleportationComponent=a,r.onAxisChangedObserver=a.onAxisValueChangedObservable.add(o=>{if(o.y<=.7&&r.teleportationState.backwards&&(r.teleportationState.backwards=!1),o.y>.7&&!r.teleportationState.forward&&this.backwardsMovementEnabled&&!this.snapPointsOnly&&!r.teleportationState.backwards){r.teleportationState.backwards=!0,this._tmpQuaternion.copyFrom(this._options.xrInput.xrCamera.rotationQuaternion),this._tmpQuaternion.toEulerAnglesToRef(this._tmpVector),this._tmpVector.x=0,this._tmpVector.z=0,Z.FromEulerVectorToRef(this._tmpVector,this._tmpQuaternion),this._tmpVector.set(0,0,this.backwardsTeleportationDistance*(this._xrSessionManager.scene.useRightHandedSystem?1:-1)),this._tmpVector.rotateByQuaternionToRef(this._tmpQuaternion,this._tmpVector),this._tmpVector.addInPlace(this._options.xrInput.xrCamera.position),this._tmpRay.origin.copyFrom(this._tmpVector),this._tmpRay.length=this._options.xrInput.xrCamera.realWorldHeight+.1,this._tmpRay.direction.set(0,-1,0);const l=this._xrSessionManager.scene.pickWithRay(this._tmpRay,c=>this._floorMeshes.indexOf(c)!==-1);l&&l.pickedPoint&&(this._options.xrInput.xrCamera.position.x=l.pickedPoint.x,this._options.xrInput.xrCamera.position.z=l.pickedPoint.z)}if(o.y<-.7&&!this._currentTeleportationControllerId&&!r.teleportationState.rotating&&this.teleportationEnabled&&(r.teleportationState.forward=!0,this._currentTeleportationControllerId=r.xrController.uniqueId,r.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y),o.x){if(r.teleportationState.forward)this._currentTeleportationControllerId===r.xrController.uniqueId&&(this.rotationEnabled?setTimeout(()=>{r.teleportationState.currentRotation=Math.atan2(o.x,o.y*(this._xrSessionManager.scene.useRightHandedSystem?1:-1))}):r.teleportationState.currentRotation=0);else if(!r.teleportationState.rotating&&Math.abs(o.x)>.7){r.teleportationState.rotating=!0;const l=this.rotationAngle*(o.x>0?1:-1)*(this._xrSessionManager.scene.useRightHandedSystem?-1:1);this.onBeforeCameraTeleportRotation.notifyObservers(l),Z.FromEulerAngles(0,l,0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion),this.onAfterCameraTeleportRotation.notifyObservers(this._options.xrInput.xrCamera.rotationQuaternion)}}else r.teleportationState.rotating=!1;o.x===0&&o.y===0&&(r.teleportationState.blocked&&(r.teleportationState.blocked=!1,this._setTargetMeshVisibility(!1)),r.teleportationState.forward&&this._teleportForward(i.uniqueId))})}};i.motionController?n():i.onMotionControllerInitObservable.addOnce(()=>{n()})}else{r.teleportationState.mainComponentUsed=!0;let n=!1;const a=()=>{this._currentTeleportationControllerId=r.xrController.uniqueId,r.teleportationState.forward=!0,r.teleportationState.initialHit=!1,r.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,r.teleportationState.currentRotation=0;const o=this._options.timeToTeleport||3e3;Rc({timeout:o,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{this._currentTeleportationControllerId===r.xrController.uniqueId&&r.teleportationState.forward&&this._teleportForward(i.uniqueId)}})};this._xrSessionManager.scene.onPointerObservable.add(o=>{o.type===ze.POINTERDOWN?(n=!1,this._options.timeToTeleportStart?Rc({timeout:this._options.timeToTeleportStart,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{this._currentTeleportationControllerId===r.xrController.uniqueId&&a()},breakCondition:()=>n?(n=!1,!0):!1}):a()):o.type===ze.POINTERUP&&(n=!0,r.teleportationState.forward=!1,this._currentTeleportationControllerId="")})}},this._colorArray=Array(24).fill(this._cachedColor4White),this._options.teleportationTargetMesh||this._createDefaultTargetMesh(),this._floorMeshes=this._options.floorMeshes||[],this._snapToPositions=this._options.snapPositions||[],this._blockedRayColor=this._options.blockedRayColor||new Te(1,0,0,.75),this._setTargetMeshVisibility(!1),this.onBeforeCameraTeleport=t.xrInput.xrCamera.onBeforeCameraTeleport,this.onAfterCameraTeleport=t.xrInput.xrCamera.onAfterCameraTeleport,this.parabolicCheckRadius*=this._xrSessionManager.worldScalingFactor,this._worldScaleObserver=e.onWorldScaleFactorChangedObservable.add(i=>{var r;this.parabolicCheckRadius=this.parabolicCheckRadius/i.previousScaleFactor*i.newScaleFactor,(r=this._options.teleportationTargetMesh)==null||r.scaling.scaleInPlace(i.newScaleFactor/i.previousScaleFactor)})}get snapPointsOnly(){return!!this._options.snapPointsOnly}set snapPointsOnly(e){this._options.snapPointsOnly=e}addFloorMesh(e){this._floorMeshes.push(e)}addBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[],this._options.pickBlockerMeshes.push(e)}addSnapPoint(e){this._snapToPositions.push(e)}attach(){if(!super.attach())return!1;this._currentTeleportationControllerId="";for(const e of this._options.xrInput.controllers)this._attachController(e);return this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),!0}detach(){if(!super.detach())return!1;const e=Object.keys(this._controllers);for(const t of e)this._detachController(t);return this._setTargetMeshVisibility(!1),this._currentTeleportationControllerId="",this._controllers={},!0}dispose(){super.dispose(),this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.dispose(!1,!0),this._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(this._worldScaleObserver),this.onTargetMeshPositionUpdatedObservable.clear(),this.onTargetMeshPositionUpdatedObservable.clear(),this.onBeforeCameraTeleportRotation.clear(),this.onAfterCameraTeleportRotation.clear(),this.onBeforeCameraTeleport.clear(),this.onAfterCameraTeleport.clear()}removeFloorMesh(e){const t=this._floorMeshes.indexOf(e);t!==-1&&this._floorMeshes.splice(t,1)}removeBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[];const t=this._options.pickBlockerMeshes.indexOf(e);t!==-1&&this._options.pickBlockerMeshes.splice(t,1)}removeFloorMeshByName(e){const t=this._xrSessionManager.scene.getMeshByName(e);t&&this.removeFloorMesh(t)}removeSnapPoint(e){let t=this._snapToPositions.indexOf(e);if(t===-1){for(let i=0;i<this._snapToPositions.length;++i)if(this._snapToPositions[i].equals(e)){t=i;break}}return t!==-1?(this._snapToPositions.splice(t,1),!0):!1}setSelectionFeature(e){this._selectionFeature=e}_onXRFrame(e){const t=this._xrSessionManager.currentFrame,i=this._xrSessionManager.scene;if(!this.attach||!t)return;const r=this._options.teleportationTargetMesh;if(this._currentTeleportationControllerId){if(!r)return;r.rotationQuaternion=r.rotationQuaternion||new Z;const n=this._controllers[this._currentTeleportationControllerId];if(n&&n.teleportationState.forward){Z.RotationYawPitchRollToRef(n.teleportationState.currentRotation+n.teleportationState.baseRotation,0,0,r.rotationQuaternion);let a=!1;const o=n.xrController.inputSource.targetRayMode!=="transient-pointer";if(n.xrController.getWorldPointerRayToRef(this._tmpRay),this.straightRayEnabled){const l=i.pickWithRay(this._tmpRay,u=>{if(this._options.blockerMeshesPredicate&&this._options.blockerMeshesPredicate(u)||this._options.blockAllPickableMeshes&&u.isPickable||this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(u)!==-1)return!0;const h=this._floorMeshes.indexOf(u);return h===-1?!1:this._floorMeshes[h].absolutePosition.y<this._options.xrInput.xrCamera.globalPosition.y}),c=l&&l.pickedMesh&&this._floorMeshes.indexOf(l.pickedMesh)!==-1;if(l&&l.pickedMesh&&!c){if(n.teleportationState.mainComponentUsed&&!n.teleportationState.initialHit){n.teleportationState.forward=!1;return}n.teleportationState.blocked=!0,this._setTargetMeshVisibility(!1,!1,o),this._showParabolicPath(l);return}else l&&l.pickedPoint&&(n.teleportationState.initialHit=!0,n.teleportationState.blocked=!1,a=!0,this._setTargetMeshPosition(l),this._setTargetMeshVisibility(!0,!1,o),this._showParabolicPath(l))}if(this.parabolicRayEnabled&&!a){const l=n.xrController.pointer.rotationQuaternion.toEulerAngles().x,c=1+(Math.PI/2-Math.abs(l)),u=this.parabolicCheckRadius*c;this._tmpRay.origin.addToRef(this._tmpRay.direction.scale(u*2),this._tmpVector),this._tmpVector.y=this._tmpRay.origin.y,this._tmpRay.origin.addInPlace(this._tmpRay.direction.scale(u)),this._tmpVector.subtractToRef(this._tmpRay.origin,this._tmpRay.direction),this._tmpRay.direction.normalize();const h=i.pickWithRay(this._tmpRay,f=>this._options.blockerMeshesPredicate&&this._options.blockerMeshesPredicate(f)||this._options.blockAllPickableMeshes&&f.isPickable||this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(f)!==-1?!0:this._floorMeshes.indexOf(f)!==-1),d=h&&h.pickedMesh&&this._floorMeshes.indexOf(h.pickedMesh)!==-1;if(h&&h.pickedMesh&&!d){if(n.teleportationState.mainComponentUsed&&!n.teleportationState.initialHit){n.teleportationState.forward=!1;return}n.teleportationState.blocked=!0,this._setTargetMeshVisibility(!1,!1,o),this._showParabolicPath(h);return}else h&&h.pickedPoint&&(n.teleportationState.initialHit=!0,n.teleportationState.blocked=!1,a=!0,this._setTargetMeshPosition(h),this._setTargetMeshVisibility(!0,!1,o),this._showParabolicPath(h))}this._setTargetMeshVisibility(a,!1,o)}else this._setTargetMeshVisibility(!1,!1,!0)}else this._disposeBezierCurve(),this._setTargetMeshVisibility(!1,!1,!0)}_createDefaultTargetMesh(){this._options.defaultTargetMeshOptions=this._options.defaultTargetMeshOptions||{};const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Lt.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,t=Qy("teleportationTarget",{width:2,height:2,subdivisions:2},e);if(t.isPickable=!1,this._options.defaultTargetMeshOptions.teleportationCircleMaterial)t.material=this._options.defaultTargetMeshOptions.teleportationCircleMaterial;else{const a=new Ky("teleportationPlaneDynamicTexture",512,e,!0);a.hasAlpha=!0;const o=a.getContext(),l=512/2,c=512/2,u=200;o.beginPath(),o.arc(l,c,u,0,2*Math.PI,!1),o.fillStyle=this._options.defaultTargetMeshOptions.teleportationFillColor||"#444444",o.fill(),o.lineWidth=10,o.strokeStyle=this._options.defaultTargetMeshOptions.teleportationBorderColor||"#FFFFFF",o.stroke(),o.closePath(),a.update();const h=new Lr("teleportationPlaneMaterial",e);h.diffuseTexture=a,t.material=h}const i=Pl("torusTeleportation",{diameter:.75,thickness:.1,tessellation:20},e);if(i.isPickable=!1,i.parent=t,!this._options.defaultTargetMeshOptions.disableAnimation){const n=new pe("animationInnerCircle","position.y",30,pe.ANIMATIONTYPE_FLOAT,pe.ANIMATIONLOOPMODE_CYCLE),a=[];a.push({frame:0,value:0}),a.push({frame:30,value:.4}),a.push({frame:60,value:0}),n.setKeys(a);const o=new en;o.setEasingMode(Yc.EASINGMODE_EASEINOUT),n.setEasingFunction(o),i.animations=[],i.animations.push(n),e.beginAnimation(i,0,60,!0)}const r=fI("rotationCone",{diameterTop:0,tessellation:4},e);if(r.isPickable=!1,r.scaling.set(.5,.12,.2),r.rotate(Ms.X,Math.PI/2),r.position.z=.6,r.parent=i,this._options.defaultTargetMeshOptions.torusArrowMaterial)i.material=this._options.defaultTargetMeshOptions.torusArrowMaterial,r.material=this._options.defaultTargetMeshOptions.torusArrowMaterial;else{const n=new Lr("torusConsMat",e);n.disableLighting=!!this._options.defaultTargetMeshOptions.disableLighting,n.disableLighting?n.emissiveColor=new q(.3,.3,1):n.diffuseColor=new q(.3,.3,1),n.alpha=.9,i.material=n,r.material=n,this._teleportationRingMaterial=n}this._options.renderingGroupId!==void 0&&(t.renderingGroupId=this._options.renderingGroupId,i.renderingGroupId=this._options.renderingGroupId,r.renderingGroupId=this._options.renderingGroupId),this._options.teleportationTargetMesh=t,this._options.teleportationTargetMesh.scaling.setAll(this._xrSessionManager.worldScalingFactor),this._setTargetMeshVisibility(!1)}_detachController(e){const t=this._controllers[e];t&&(t.teleportationComponent&&(t.onAxisChangedObserver&&t.teleportationComponent.onAxisValueChangedObservable.remove(t.onAxisChangedObserver),t.onButtonChangedObserver&&t.teleportationComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver)),delete this._controllers[e])}_findClosestSnapPointWithRadius(e,t=this._options.snapToPositionRadius||.8){let i=null,r=Number.MAX_VALUE;if(this._snapToPositions.length){const n=t*t;for(const a of this._snapToPositions){const o=x.DistanceSquared(a,e);o<=n&&o<r&&(r=o,i=a)}}return i}_setTargetMeshPosition(e){const t=e.pickedPoint;if(!this._options.teleportationTargetMesh||!t)return;const i=this._findClosestSnapPointWithRadius(t);this._snappedToPoint=!!i,this.snapPointsOnly&&!this._snappedToPoint&&this._teleportationRingMaterial?this._teleportationRingMaterial.diffuseColor.set(1,.3,.3):this.snapPointsOnly&&this._snappedToPoint&&this._teleportationRingMaterial&&this._teleportationRingMaterial.diffuseColor.set(.3,.3,1),this._options.teleportationTargetMesh.position.copyFrom(i||t),this._options.teleportationTargetMesh.position.y+=.01,this.onTargetMeshPositionUpdatedObservable.notifyObservers(e)}_setTargetMeshVisibility(e,t,i){if(!this._options.teleportationTargetMesh||this._options.teleportationTargetMesh.isVisible===e&&!t)return;this._options.teleportationTargetMesh.isVisible=e;const r=this._options.teleportationTargetMesh.getChildren(void 0,!1);for(const n of r)n.isVisible=e;e?this._selectionFeature&&i&&this._selectionFeature.detach():(this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null),this._selectionFeature&&i&&this._selectionFeature.attach())}_disposeBezierCurve(){this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null)}_showParabolicPath(e){if(!e.pickedPoint||!this._currentTeleportationControllerId)return;const t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Lt.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,i=this._controllers[this._currentTeleportationControllerId],r=pI.CreateQuadraticBezier(i.xrController.pointer.absolutePosition,e.ray.origin,e.pickedPoint,25),n=i.teleportationState.blocked?this._blockedRayColor:void 0,a=this._colorArray.fill(n||this._cachedColor4White),o=r.getPoints();o.shift(),o.shift(),this._options.generateRayPathMesh?this._quadraticBezierCurve=this._options.generateRayPathMesh(r.getPoints(),e):this._quadraticBezierCurve=mI("teleportation path line",{points:o,instance:this._quadraticBezierCurve,updatable:!0,colors:a},t),this._quadraticBezierCurve.isPickable=!1,this._options.renderingGroupId!==void 0&&(this._quadraticBezierCurve.renderingGroupId=this._options.renderingGroupId)}_teleportForward(e){const t=this._controllers[e];if(!(!t||!t.teleportationState.forward||!this.teleportationEnabled)&&(t.teleportationState.forward=!1,this._currentTeleportationControllerId="",!(this.snapPointsOnly&&!this._snappedToPoint))){if(this.skipNextTeleportation){this.skipNextTeleportation=!1;return}if(this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.isVisible){const i=this._options.xrInput.xrCamera.realWorldHeight;this.onBeforeCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position),this._options.xrInput.xrCamera.position.copyFrom(this._options.teleportationTargetMesh.position),this._options.xrInput.xrCamera.position.y+=i,Z.FromEulerAngles(0,t.teleportationState.currentRotation-(this._xrSessionManager.scene.useRightHandedSystem?Math.PI:0),0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion),this.onAfterCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position)}}}}co.Name=Ne.TELEPORTATION;co.Version=1;At.AddWebXRFeature(co.Name,(s,e)=>()=>new co(s,e),co.Version,!0);class N_{constructor(){}static async CreateAsync(e,t={}){const i=new N_;if(e.onDisposeObservable.addOnce(()=>{i.dispose()}),!t.disableDefaultUI){const r={renderTarget:i.renderTarget,...t.uiOptions||{}};t.optionalFeatures&&(typeof t.optionalFeatures=="boolean"?r.optionalFeatures=["hit-test","anchors","plane-detection","hand-tracking"]:r.optionalFeatures=t.optionalFeatures),i.enterExitUI=new O_(e,r)}try{const r=await R_.CreateAsync(e);if(i.baseExperience=r,t.ignoreNativeCameraTransformation&&(i.baseExperience.camera.compensateOnFirstFrame=!1),i.input=new LV(r.sessionManager,r.camera,{controllerOptions:{renderingGroupId:t.renderingGroupId},...t.inputOptions||{}}),!t.disablePointerSelection){const n={...t.pointerSelectionOptions,xrInput:i.input,renderingGroupId:t.renderingGroupId};i.pointerSelection=i.baseExperience.featuresManager.enableFeature(Hs.Name,t.useStablePlugins?"stable":"latest",n),t.disableTeleportation||(i.teleportation=i.baseExperience.featuresManager.enableFeature(co.Name,t.useStablePlugins?"stable":"latest",{floorMeshes:t.floorMeshes,xrInput:i.input,renderingGroupId:t.renderingGroupId,...t.teleportationOptions}),i.teleportation.setSelectionFeature(i.pointerSelection))}return t.disableNearInteraction||(i.nearInteraction=i.baseExperience.featuresManager.enableFeature($s.Name,t.useStablePlugins?"stable":"latest",{xrInput:i.input,farInteractionFeature:i.pointerSelection,renderingGroupId:t.renderingGroupId,useUtilityLayer:!0,enableNearInteractionOnAllControllers:!0,...t.nearInteractionOptions})),t.disableHandTracking||i.baseExperience.featuresManager.enableFeature(Fe.Name,t.useStablePlugins?"stable":"latest",{xrInput:i.input,...t.handSupportOptions},void 0,!1),i.renderTarget=i.baseExperience.sessionManager.getWebXRRenderTarget(t.outputCanvasOptions),t.disableDefaultUI||await i.enterExitUI.setHelperAsync(i.baseExperience,i.renderTarget),i}catch(r){return N.Error("Error initializing XR"),N.Error(r),i}}dispose(){this.baseExperience&&this.baseExperience.dispose(),this.input&&this.input.dispose(),this.enterExitUI&&this.enterExitUI.dispose(),this.renderTarget&&this.renderTarget.dispose()}}le.prototype.createDefaultLight=function(s=!1){if(s&&this.lights)for(let e=0;e<this.lights.length;e++)this.lights[e].dispose();this.lights.length===0&&new Lm("default light",x.Up(),this)};le.prototype.createDefaultCamera=function(s=!1,e=!1,t=!1){if(e&&this.activeCamera&&(this.activeCamera.dispose(),this.activeCamera=null),!this.activeCamera){const i=this.getWorldExtends(l=>l.isVisible&&l.isEnabled()),r=i.max.subtract(i.min),n=i.min.add(r.scale(.5));let a,o=r.length()*1.5;if(isFinite(o)||(o=1,n.copyFromFloats(0,0,0)),s){const l=new wo("default camera",-(Math.PI/2),Math.PI/2,o,n,this);l.lowerRadiusLimit=o*.01,l.wheelPrecision=100/o,a=l}else{const l=new xr("default camera",new x(n.x,n.y,-o),this);l.setTarget(n),a=l}a.minZ=o*.01,a.maxZ=o*1e3,a.speed=o*.2,this.activeCamera=a,t&&a.attachControl()}};le.prototype.createDefaultCameraOrLight=function(s=!1,e=!1,t=!1){this.createDefaultLight(e),this.createDefaultCamera(s,e,t)};le.prototype.createDefaultSkybox=function(s,e=!1,t=1e3,i=0,r=!0){if(!s)return N.Warn("Can not create default skybox without environment texture."),null;r&&s&&(this.environmentTexture=s);const n=cI("hdrSkyBox",{size:t},this);if(e){const a=new he("skyBox",this);a.backFaceCulling=!1,a.reflectionTexture=s.clone(),a.reflectionTexture&&(a.reflectionTexture.coordinatesMode=$.SKYBOX_MODE),a.microSurface=1-i,a.disableLighting=!0,a.twoSidedLighting=!0,n.material=a}else{const a=new Lr("skyBox",this);a.backFaceCulling=!1,a.reflectionTexture=s.clone(),a.reflectionTexture&&(a.reflectionTexture.coordinatesMode=$.SKYBOX_MODE),a.disableLighting=!0,n.material=a}return n.isPickable=!1,n.infiniteDistance=!0,n.ignoreCameraMaxZ=!0,n};le.prototype.createDefaultEnvironment=function(s){return Ra?new Ra(s,this):null};le.prototype.createDefaultVRExperience=function(s={}){return new Eo(this,s)};le.prototype.createDefaultXRExperienceAsync=async function(s={}){return await N_.CreateAsync(this,s)};function Zv(s){for(;s.firstChild;)s.removeChild(s.firstChild);s.srcObject=null,s.src="",s.removeAttribute("src")}class xn extends ${get onUserActionRequestedObservable(){return this._onUserActionRequestedObservable||(this._onUserActionRequestedObservable=new k),this._onUserActionRequestedObservable}_processError(e){this._errorFound=!0,this._onError?this._onError(e==null?void 0:e.message):N.Error(e==null?void 0:e.message)}_handlePlay(){this._errorFound=!1,this.video.play().catch(e=>{if((e==null?void 0:e.name)==="NotAllowedError"){if(this._onUserActionRequestedObservable&&this._onUserActionRequestedObservable.hasObservers()){this._onUserActionRequestedObservable.notifyObservers(this);return}else if(!this.video.muted){N.Warn("Unable to autoplay a video with sound. Trying again with muted turned true"),this.video.muted=!0,this._errorFound=!1,this.video.play().catch(t=>{this._processError(t)});return}}this._processError(e)})}constructor(e,t,i,r=!1,n=!1,a=$.TRILINEAR_SAMPLINGMODE,o={},l,c=5){super(null,i,!r,n),this._externalTexture=null,this._onUserActionRequestedObservable=null,this._stillImageCaptured=!1,this._displayingPosterTexture=!1,this._frameId=-1,this._currentSrc=null,this._errorFound=!1,this.isVideo=!0,this._resizeInternalTexture=()=>{this._texture!=null&&this._texture.dispose(),!this._getEngine().needPOTTextures||j.IsExponentOfTwo(this.video.videoWidth)&&j.IsExponentOfTwo(this.video.videoHeight)?(this.wrapU=$.WRAP_ADDRESSMODE,this.wrapV=$.WRAP_ADDRESSMODE):(this.wrapU=$.CLAMP_ADDRESSMODE,this.wrapV=$.CLAMP_ADDRESSMODE,this._generateMipMaps=!1),this._texture=this._getEngine().createDynamicTexture(this.video.videoWidth,this.video.videoHeight,this._generateMipMaps,this.samplingMode),this._texture.format=this._format??5,this._frameId=-1,this._updateInternalTexture()},this._createInternalTexture=()=>{if(this._texture!=null)if(this._displayingPosterTexture)this._displayingPosterTexture=!1;else return;if(this.video.addEventListener("resize",this._resizeInternalTexture),this._resizeInternalTexture(),!this.video.autoplay&&!this._settings.poster&&!this._settings.independentVideoSource){const f=this.video.onplaying,m=this.video.muted;this.video.muted=!0,this.video.onplaying=()=>{this.video.muted=m,this.video.onplaying=f,this._updateInternalTexture(),this._errorFound||this.video.pause(),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this)},this._handlePlay()}else this._updateInternalTexture(),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this)},this._reset=()=>{this._texture!=null&&(this._displayingPosterTexture||(this._texture.dispose(),this._texture=null))},this._updateInternalTexture=()=>{if(this._texture==null||this.video.readyState<this.video.HAVE_CURRENT_DATA||this._displayingPosterTexture)return;const f=this.getScene().getFrameId();this._frameId!==f&&(this._frameId=f,this._getEngine().updateVideoTexture(this._texture,this._externalTexture?this._externalTexture:this.video,this._invertY))},this._settings={autoPlay:!0,loop:!0,autoUpdateTexture:!0,...o},this._onError=l,this._generateMipMaps=r,this._initialSamplingMode=a,this.autoUpdateTexture=this._settings.autoUpdateTexture,this._currentSrc=t,this.name=e||this._getName(t),this.video=this._getVideo(t);const u=this._engine,h=u==null?void 0:u.createExternalTexture;h&&(this._externalTexture=h.call(u,this.video)),this._settings.independentVideoSource||(this._settings.poster&&(this.video.poster=this._settings.poster),this._settings.autoPlay!==void 0&&(this.video.autoplay=this._settings.autoPlay),this._settings.loop!==void 0&&(this.video.loop=this._settings.loop),this._settings.muted!==void 0&&(this.video.muted=this._settings.muted),this.video.setAttribute("playsinline",""),this.video.addEventListener("paused",this._updateInternalTexture),this.video.addEventListener("seeked",this._updateInternalTexture),this.video.addEventListener("loadeddata",this._updateInternalTexture),this.video.addEventListener("emptied",this._reset),this._settings.autoPlay&&this._handlePlay()),this._createInternalTextureOnEvent=this._settings.poster&&!this._settings.autoPlay?"play":"canplay",this.video.addEventListener(this._createInternalTextureOnEvent,this._createInternalTexture),this._format=c;const d=this.video.readyState>=this.video.HAVE_CURRENT_DATA;this._settings.poster&&(!this._settings.autoPlay||!d)?(this._texture=this._getEngine().createTexture(this._settings.poster,!1,!this.invertY,i),this._displayingPosterTexture=!0):d&&this._createInternalTexture()}getClassName(){return"VideoTexture"}_getName(e){return e instanceof HTMLVideoElement?e.currentSrc:typeof e=="object"?e.toString():e}_getVideo(e){if(e.isNative)return e;if(e instanceof HTMLVideoElement)return j.SetCorsBehavior(e.currentSrc,e),e;const t=document.createElement("video");if(typeof e=="string")j.SetCorsBehavior(e,t),t.src=e;else{j.SetCorsBehavior(e[0],t);for(const i of e){const r=document.createElement("source");r.src=i,t.appendChild(r)}}return this.onDisposeObservable.addOnce(()=>{Zv(t)}),t}_rebuild(){this.update()}update(){this.autoUpdateTexture&&this.updateTexture(!0)}updateTexture(e){e&&(this.video.paused&&this._stillImageCaptured||(this._stillImageCaptured=!0,this._updateInternalTexture()))}get externalTexture(){return this._externalTexture}updateURL(e){this.video.src=e,this._currentSrc=e}clone(){return new xn(this.name,this._currentSrc,this.getScene(),this._generateMipMaps,this.invertY,this.samplingMode,this._settings)}dispose(){var e;super.dispose(),this._currentSrc=null,this._onUserActionRequestedObservable&&(this._onUserActionRequestedObservable.clear(),this._onUserActionRequestedObservable=null),this.video.removeEventListener(this._createInternalTextureOnEvent,this._createInternalTexture),this._settings.independentVideoSource||(this.video.removeEventListener("paused",this._updateInternalTexture),this.video.removeEventListener("seeked",this._updateInternalTexture),this.video.removeEventListener("loadeddata",this._updateInternalTexture),this.video.removeEventListener("emptied",this._reset),this.video.removeEventListener("resize",this._resizeInternalTexture),this.video.pause()),(e=this._externalTexture)==null||e.dispose()}static CreateFromStreamAsync(e,t,i,r=!0){const n=e.getEngine().createVideoElement(i);return e.getEngine()._badOS&&(document.body.appendChild(n),n.style.transform="scale(0.0001, 0.0001)",n.style.opacity="0",n.style.position="fixed",n.style.bottom="0px",n.style.right="0px"),n.setAttribute("autoplay",""),n.setAttribute("muted","true"),n.setAttribute("playsinline",""),n.muted=!0,n.isNative||(typeof n.srcObject=="object"?n.srcObject=t:n.src=window.URL&&window.URL.createObjectURL(t)),new Promise(a=>{const o=()=>{const l=new xn("video",n,e,!0,r,void 0,void 0,void 0,4);e.getEngine()._badOS&&l.onDisposeObservable.addOnce(()=>{n.remove()}),l.onDisposeObservable.addOnce(()=>{Zv(n)}),a(l),n.removeEventListener("playing",o)};n.addEventListener("playing",o),n.play()})}static async CreateFromWebCamAsync(e,t,i=!1,r=!0){if(navigator.mediaDevices){const n=await navigator.mediaDevices.getUserMedia({video:t,audio:i}),a=await this.CreateFromStreamAsync(e,n,t,r);return a.onDisposeObservable.addOnce(()=>{const o=n.getTracks();for(const l of o)l.stop()}),a}return Promise.reject("No support for userMedia on this device")}static CreateFromWebCam(e,t,i,r=!1,n=!0){this.CreateFromWebCamAsync(e,i,r,n).then(function(a){t&&t(a)}).catch(function(a){N.Error(a.name)})}}_([R("settings")],xn.prototype,"_settings",void 0);_([R("src")],xn.prototype,"_currentSrc",void 0);_([R()],xn.prototype,"isVideo",void 0);$._CreateVideoTexture=(s,e,t,i=!1,r=!1,n=$.TRILINEAR_SAMPLINGMODE,a={},o,l=5)=>new xn(s,e,t,i,r,n,a,o,l);y("BABYLON.VideoTexture",xn);class D_ extends qi{get videoTexture(){return this._texture}get videoMode(){return this.textureMode}set videoMode(e){this.textureMode=e}_initTexture(e,t,i){const r={loop:i.loop,autoPlay:i.autoPlay,autoUpdateTexture:!0,poster:i.poster},n=new xn((this.name||"videoDome")+"_texture",e,t,i.generateMipMaps,this._useDirectMapping,$.TRILINEAR_SAMPLINGMODE,r);return i.clickToPlay&&(this._pointerObserver=t.onPointerObservable.add(a=>{var o;((o=a.pickInfo)==null?void 0:o.pickedMesh)===this.mesh&&this._texture.video.play()},ze.POINTERDOWN)),this._textureObserver=n.onLoadObservable.add(()=>{this.onLoadObservable.notifyObservers()}),n}dispose(e,t=!1){this._texture.onLoadObservable.remove(this._textureObserver),this._scene.onPointerObservable.remove(this._pointerObserver),super.dispose(e,t)}}D_.MODE_MONOSCOPIC=qi.MODE_MONOSCOPIC;D_.MODE_TOPBOTTOM=qi.MODE_TOPBOTTOM;D_.MODE_SIDEBYSIDE=qi.MODE_SIDEBYSIDE;class kr{get _shouldRender(){return this._thinEffectLayer._shouldRender}set _shouldRender(e){this._thinEffectLayer._shouldRender=e}get _emissiveTextureAndColor(){return this._thinEffectLayer._emissiveTextureAndColor}set _emissiveTextureAndColor(e){this._thinEffectLayer._emissiveTextureAndColor=e}get _effectIntensity(){return this._thinEffectLayer._effectIntensity}set _effectIntensity(e){this._thinEffectLayer._effectIntensity=e}static get ForceGLSL(){return Vn.ForceGLSL}static set ForceGLSL(e){Vn.ForceGLSL=e}get name(){return this._thinEffectLayer.name}set name(e){this._thinEffectLayer.name=e}get neutralColor(){return this._thinEffectLayer.neutralColor}set neutralColor(e){this._thinEffectLayer.neutralColor=e}get isEnabled(){return this._thinEffectLayer.isEnabled}set isEnabled(e){this._thinEffectLayer.isEnabled=e}get camera(){return this._thinEffectLayer.camera}get renderingGroupId(){return this._thinEffectLayer.renderingGroupId}set renderingGroupId(e){this._thinEffectLayer.renderingGroupId=e}get disableBoundingBoxesFromEffectLayer(){return this._thinEffectLayer.disableBoundingBoxesFromEffectLayer}set disableBoundingBoxesFromEffectLayer(e){this._thinEffectLayer.disableBoundingBoxesFromEffectLayer=e}get mainTexture(){return this._mainTexture}get _shaderLanguage(){return this._thinEffectLayer.shaderLanguage}get shaderLanguage(){return this._thinEffectLayer.shaderLanguage}setMaterialForRendering(e,t){this._thinEffectLayer.setMaterialForRendering(e,t)}getEffectIntensity(e){return this._thinEffectLayer.getEffectIntensity(e)}setEffectIntensity(e,t){this._thinEffectLayer.setEffectIntensity(e,t)}constructor(e,t,i=!1,r){this._mainTextureCreatedSize={width:0,height:0},this._maxSize=0,this._mainTextureDesiredSize={width:0,height:0},this._postProcesses=[],this._textures=[],this.uniqueId=bn.UniqueId,this.onDisposeObservable=new k,this.onBeforeRenderMainTextureObservable=new k,this.onBeforeComposeObservable=new k,this.onBeforeRenderMeshToEffect=new k,this.onAfterRenderMeshToEffect=new k,this.onAfterComposeObservable=new k,this.onSizeChangedObservable=new k,this._internalThinEffectLayer=!r,r||(r=new Vn(e,t,i,!1,this._importShadersAsync.bind(this)),r.getEffectName=this.getEffectName.bind(this),r.isReady=this.isReady.bind(this),r._createMergeEffect=this._createMergeEffect.bind(this),r._createTextureAndPostProcesses=this._createTextureAndPostProcesses.bind(this),r._internalCompose=this._internalRender.bind(this),r._setEmissiveTextureAndColor=this._setEmissiveTextureAndColor.bind(this),r._numInternalDraws=this._numInternalDraws.bind(this),r._addCustomEffectDefines=this._addCustomEffectDefines.bind(this),r.hasMesh=this.hasMesh.bind(this),r.shouldRender=this.shouldRender.bind(this),r._shouldRenderMesh=this._shouldRenderMesh.bind(this),r._canRenderMesh=this._canRenderMesh.bind(this),r._useMeshMaterial=this._useMeshMaterial.bind(this)),this._thinEffectLayer=r,this.name=e,this._scene=t||De.LastCreatedScene,kr._SceneComponentInitialization(this._scene),this._engine=this._scene.getEngine(),this._maxSize=this._engine.getCaps().maxTextureSize,this._scene.addEffectLayer(this),this._thinEffectLayer.onDisposeObservable.add(()=>{this.onDisposeObservable.notifyObservers(this)}),this._thinEffectLayer.onBeforeRenderLayerObservable.add(()=>{this.onBeforeRenderMainTextureObservable.notifyObservers(this)}),this._thinEffectLayer.onBeforeComposeObservable.add(()=>{this.onBeforeComposeObservable.notifyObservers(this)}),this._thinEffectLayer.onBeforeRenderMeshToEffect.add(n=>{this.onBeforeRenderMeshToEffect.notifyObservers(n)}),this._thinEffectLayer.onAfterRenderMeshToEffect.add(n=>{this.onAfterRenderMeshToEffect.notifyObservers(n)}),this._thinEffectLayer.onAfterComposeObservable.add(()=>{this.onAfterComposeObservable.notifyObservers(this)})}get _shadersLoaded(){return this._thinEffectLayer._shadersLoaded}set _shadersLoaded(e){this._thinEffectLayer._shadersLoaded=e}_numInternalDraws(){return this._internalThinEffectLayer?1:this._thinEffectLayer._numInternalDraws()}_init(e){this._effectLayerOptions={mainTextureRatio:.5,alphaBlendingMode:2,camera:null,renderingGroupId:-1,mainTextureType:0,generateStencilBuffer:!1,...e},this._setMainTextureSize(),this._thinEffectLayer._init(e),this._createMainTexture(),this._createTextureAndPostProcesses()}_setMainTextureSize(){this._effectLayerOptions.mainTextureFixedSize?(this._mainTextureDesiredSize.width=this._effectLayerOptions.mainTextureFixedSize,this._mainTextureDesiredSize.height=this._effectLayerOptions.mainTextureFixedSize):(this._mainTextureDesiredSize.width=this._engine.getRenderWidth()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.height=this._engine.getRenderHeight()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.width=this._engine.needPOTTextures?$n(this._mainTextureDesiredSize.width,this._maxSize):this._mainTextureDesiredSize.width,this._mainTextureDesiredSize.height=this._engine.needPOTTextures?$n(this._mainTextureDesiredSize.height,this._maxSize):this._mainTextureDesiredSize.height),this._mainTextureDesiredSize.width=Math.floor(this._mainTextureDesiredSize.width),this._mainTextureDesiredSize.height=Math.floor(this._mainTextureDesiredSize.height)}_createMainTexture(){this._mainTexture=new Zi("EffectLayerMainRTT",{width:this._mainTextureDesiredSize.width,height:this._mainTextureDesiredSize.height},this._scene,{type:this._effectLayerOptions.mainTextureType,samplingMode:$.TRILINEAR_SAMPLINGMODE,generateStencilBuffer:this._effectLayerOptions.generateStencilBuffer,existingObjectRenderer:this._thinEffectLayer.objectRenderer}),this._mainTexture.activeCamera=this._effectLayerOptions.camera,this._mainTexture.wrapU=$.CLAMP_ADDRESSMODE,this._mainTexture.wrapV=$.CLAMP_ADDRESSMODE,this._mainTexture.anisotropicFilteringLevel=1,this._mainTexture.updateSamplingMode($.BILINEAR_SAMPLINGMODE),this._mainTexture.renderParticles=!1,this._mainTexture.renderList=null,this._mainTexture.ignoreCameraViewport=!0,this._mainTexture.onClearObservable.add(e=>{e.clear(this.neutralColor,!0,!0,!0)})}_addCustomEffectDefines(e){}_isReady(e,t,i){return this._internalThinEffectLayer?this._thinEffectLayer._internalIsSubMeshReady(e,t,i):this._thinEffectLayer._isSubMeshReady(e,t,i)}async _importShadersAsync(){}_arePostProcessAndMergeReady(){return this._internalThinEffectLayer?this._thinEffectLayer._internalIsLayerReady():this._thinEffectLayer.isLayerReady()}isLayerReady(){return this._arePostProcessAndMergeReady()&&this._mainTexture.isReady()}render(){this._thinEffectLayer.compose()&&(this._setMainTextureSize(),(this._mainTextureCreatedSize.width!==this._mainTextureDesiredSize.width||this._mainTextureCreatedSize.height!==this._mainTextureDesiredSize.height)&&this._mainTextureDesiredSize.width!==0&&this._mainTextureDesiredSize.height!==0&&(this.onSizeChangedObservable.notifyObservers(this),this._disposeTextureAndPostProcesses(),this._createMainTexture(),this._createTextureAndPostProcesses(),this._mainTextureCreatedSize.width=this._mainTextureDesiredSize.width,this._mainTextureCreatedSize.height=this._mainTextureDesiredSize.height))}hasMesh(e){return this._internalThinEffectLayer?this._thinEffectLayer._internalHasMesh(e):this._thinEffectLayer.hasMesh(e)}shouldRender(){return this._internalThinEffectLayer?this._thinEffectLayer._internalShouldRender():this._thinEffectLayer.shouldRender()}_shouldRenderMesh(e){return this._internalThinEffectLayer?!0:this._thinEffectLayer._shouldRenderMesh(e)}_canRenderMesh(e,t){return this._internalThinEffectLayer?this._thinEffectLayer._internalCanRenderMesh(e,t):this._thinEffectLayer._canRenderMesh(e,t)}_shouldRenderEmissiveTextureForMesh(){return!0}_useMeshMaterial(e){return this._internalThinEffectLayer?!1:this._thinEffectLayer._useMeshMaterial(e)}_rebuild(){this._thinEffectLayer._rebuild()}_disposeTextureAndPostProcesses(){this._mainTexture.dispose();for(let e=0;e<this._postProcesses.length;e++)this._postProcesses[e]&&this._postProcesses[e].dispose();this._postProcesses=[];for(let e=0;e<this._textures.length;e++)this._textures[e]&&this._textures[e].dispose();this._textures=[]}dispose(){this._thinEffectLayer.dispose(),this._disposeTextureAndPostProcesses(),this._scene.removeEffectLayer(this),this.onDisposeObservable.clear(),this.onBeforeRenderMainTextureObservable.clear(),this.onBeforeComposeObservable.clear(),this.onBeforeRenderMeshToEffect.clear(),this.onAfterRenderMeshToEffect.clear(),this.onAfterComposeObservable.clear(),this.onSizeChangedObservable.clear()}getClassName(){return"EffectLayer"}static Parse(e,t,i){return j.Instantiate(e.customType).Parse(e,t,i)}}kr._SceneComponentInitialization=s=>{throw Ys("EffectLayerSceneComponent")};_([R()],kr.prototype,"name",null);_([OD()],kr.prototype,"neutralColor",null);_([R()],kr.prototype,"isEnabled",null);_([ND()],kr.prototype,"camera",null);_([R()],kr.prototype,"renderingGroupId",null);_([R()],kr.prototype,"disableBoundingBoxesFromEffectLayer",null);ko(se.NAME_EFFECTLAYER,(s,e,t,i)=>{if(s.effectLayers){t.effectLayers||(t.effectLayers=[]);for(let r=0;r<s.effectLayers.length;r++){const n=kr.Parse(s.effectLayers[r],e,i);t.effectLayers.push(n)}}});class $V{constructor(e){this.name=se.NAME_EFFECTLAYER,this._renderEffects=!1,this._needStencil=!1,this._previousStencilState=!1,this.scene=e||De.LastCreatedScene,this.scene&&(this._engine=this.scene.getEngine())}register(){this.scene._isReadyForMeshStage.registerStep(se.STEP_ISREADYFORMESH_EFFECTLAYER,this,this._isReadyForMesh),this.scene._cameraDrawRenderTargetStage.registerStep(se.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER,this,this._renderMainTexture),this.scene._beforeCameraDrawStage.registerStep(se.STEP_BEFORECAMERADRAW_EFFECTLAYER,this,this._setStencil),this.scene._afterRenderingGroupDrawStage.registerStep(se.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW,this,this._drawRenderingGroup),this.scene._afterCameraDrawStage.registerStep(se.STEP_AFTERCAMERADRAW_EFFECTLAYER,this,this._setStencilBack),this.scene._afterCameraDrawStage.registerStep(se.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW,this,this._drawCamera)}rebuild(){const e=this.scene.effectLayers;for(const t of e)t._rebuild()}serialize(e){e.effectLayers=[];const t=this.scene.effectLayers;for(const i of t)i.serialize&&e.effectLayers.push(i.serialize())}addFromContainer(e){if(e.effectLayers)for(const t of e.effectLayers)this.scene.addEffectLayer(t)}removeFromContainer(e,t){if(e.effectLayers)for(const i of e.effectLayers)this.scene.removeEffectLayer(i),t&&i.dispose()}dispose(){const e=this.scene.effectLayers;for(;e.length;)e[0].dispose()}_isReadyForMesh(e,t){const i=this._engine.currentRenderPassId,r=this.scene.effectLayers;for(const n of r){if(!n.hasMesh(e))continue;const a=n._mainTexture;this._engine.currentRenderPassId=a.renderPassId;for(const o of e.subMeshes)if(!n.isReady(o,t))return this._engine.currentRenderPassId=i,!1}return this._engine.currentRenderPassId=i,!0}_renderMainTexture(e){this._renderEffects=!1,this._needStencil=!1;let t=!1;const i=this.scene.effectLayers;if(i&&i.length>0){this._previousStencilState=this._engine.getStencilBuffer();for(const r of i)if(r.shouldRender()&&(!r.camera||r.camera.cameraRigMode===dt.RIG_MODE_NONE&&e===r.camera||r.camera.cameraRigMode!==dt.RIG_MODE_NONE&&r.camera._rigCameras.indexOf(e)>-1)){this._renderEffects=!0,this._needStencil=this._needStencil||r.needStencil();const n=r._mainTexture;n._shouldRender()&&(this.scene.incrementRenderId(),n.render(!1,!1),t=!0)}this.scene.incrementRenderId()}return t}_setStencil(){this._needStencil&&this._engine.setStencilBuffer(!0)}_setStencilBack(){this._needStencil&&this._engine.setStencilBuffer(this._previousStencilState)}_draw(e){if(this._renderEffects){this._engine.setDepthBuffer(!1);const t=this.scene.effectLayers;for(let i=0;i<t.length;i++){const r=t[i];r.renderingGroupId===e&&r.shouldRender()&&r.render()}this._engine.setDepthBuffer(!0)}}_drawCamera(){this._renderEffects&&this._draw(-1)}_drawRenderingGroup(e){!this.scene._isInIntermediateRendering()&&this._renderEffects&&this._draw(e)}}kr._SceneComponentInitialization=s=>{let e=s._getComponent(se.NAME_EFFECTLAYER);e||(e=new $V(s),s._addComponent(e))};le.prototype.getGlowLayerByName=function(s){var e;for(let t=0;t<((e=this.effectLayers)==null?void 0:e.length);t++)if(this.effectLayers[t].name===s&&this.effectLayers[t].getEffectName()===es.EffectName)return this.effectLayers[t];return null};class es extends kr{static get EffectName(){return ya.EffectName}set blurKernelSize(e){this._thinEffectLayer.blurKernelSize=e}get blurKernelSize(){return this._thinEffectLayer.blurKernelSize}set intensity(e){this._thinEffectLayer.intensity=e}get intensity(){return this._thinEffectLayer.intensity}get customEmissiveColorSelector(){return this._thinEffectLayer.customEmissiveColorSelector}set customEmissiveColorSelector(e){this._thinEffectLayer.customEmissiveColorSelector=e}get customEmissiveTextureSelector(){return this._thinEffectLayer.customEmissiveTextureSelector}set customEmissiveTextureSelector(e){this._thinEffectLayer.customEmissiveTextureSelector=e}constructor(e,t,i){super(e,t,!1,new ya(e,t,i)),this._options={mainTextureRatio:es.DefaultTextureRatio,blurKernelSize:32,mainTextureFixedSize:void 0,camera:null,mainTextureSamples:1,renderingGroupId:-1,ldrMerge:!1,alphaBlendingMode:1,mainTextureType:0,generateStencilBuffer:!1,...i},this._init(this._options)}getEffectName(){return es.EffectName}_createMergeEffect(){return this._thinEffectLayer._createMergeEffect()}_createTextureAndPostProcesses(){this._thinEffectLayer._renderPassId=this._mainTexture.renderPassId;let e=this._mainTextureDesiredSize.width,t=this._mainTextureDesiredSize.height;e=this._engine.needPOTTextures?$n(e,this._maxSize):e,t=this._engine.needPOTTextures?$n(t,this._maxSize):t;let i=0;this._engine.getCaps().textureHalfFloatRender?i=2:i=0,this._blurTexture1=new Zi("GlowLayerBlurRTT",{width:e,height:t},this._scene,!1,!0,i),this._blurTexture1.wrapU=$.CLAMP_ADDRESSMODE,this._blurTexture1.wrapV=$.CLAMP_ADDRESSMODE,this._blurTexture1.updateSamplingMode($.BILINEAR_SAMPLINGMODE),this._blurTexture1.renderParticles=!1,this._blurTexture1.ignoreCameraViewport=!0;const r=Math.floor(e/2),n=Math.floor(t/2);this._blurTexture2=new Zi("GlowLayerBlurRTT2",{width:r,height:n},this._scene,!1,!0,i),this._blurTexture2.wrapU=$.CLAMP_ADDRESSMODE,this._blurTexture2.wrapV=$.CLAMP_ADDRESSMODE,this._blurTexture2.updateSamplingMode($.BILINEAR_SAMPLINGMODE),this._blurTexture2.renderParticles=!1,this._blurTexture2.ignoreCameraViewport=!0,this._textures=[this._blurTexture1,this._blurTexture2],this._thinEffectLayer.bindTexturesForCompose=u=>{u.setTexture("textureSampler",this._blurTexture1),u.setTexture("textureSampler2",this._blurTexture2),u.setFloat("offset",this.intensity)},this._thinEffectLayer._createTextureAndPostProcesses();const a=this._thinEffectLayer._postProcesses[0];this._horizontalBlurPostprocess1=new nr("GlowLayerHBP1",a.direction,a.kernel,{samplingMode:$.BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),width:e,height:t,textureType:i,effectWrapper:a}),this._horizontalBlurPostprocess1.width=e,this._horizontalBlurPostprocess1.height=t,this._horizontalBlurPostprocess1.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess1.onApplyObservable.add(u=>{u.setTexture("textureSampler",this._mainTexture)});const o=this._thinEffectLayer._postProcesses[1];this._verticalBlurPostprocess1=new nr("GlowLayerVBP1",o.direction,o.kernel,{samplingMode:$.BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),width:e,height:t,textureType:i,effectWrapper:o});const l=this._thinEffectLayer._postProcesses[2];this._horizontalBlurPostprocess2=new nr("GlowLayerHBP2",l.direction,l.kernel,{samplingMode:$.BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),width:r,height:n,textureType:i,effectWrapper:l}),this._horizontalBlurPostprocess2.width=r,this._horizontalBlurPostprocess2.height=n,this._horizontalBlurPostprocess2.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess2.onApplyObservable.add(u=>{u.setTexture("textureSampler",this._blurTexture1)});const c=this._thinEffectLayer._postProcesses[3];this._verticalBlurPostprocess2=new nr("GlowLayerVBP2",c.direction,c.kernel,{samplingMode:$.BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),width:r,height:n,textureType:i,effectWrapper:c}),this._postProcesses=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1,this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._postProcesses1=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1],this._postProcesses2=[this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._mainTexture.samples=this._options.mainTextureSamples,this._mainTexture.onAfterUnbindObservable.add(()=>{const u=this._blurTexture1.renderTarget;if(u){this._scene.postProcessManager.directRender(this._postProcesses1,u,!0);const h=this._blurTexture2.renderTarget;h&&this._scene.postProcessManager.directRender(this._postProcesses2,h,!0),this._engine.unBindFramebuffer(h??u,!0)}}),this._postProcesses.map(u=>{u.autoClear=!1})}isReady(e,t){return this._thinEffectLayer.isReady(e,t)}needStencil(){return!1}_canRenderMesh(e,t){return this._thinEffectLayer._canRenderMesh(e,t)}_internalRender(e){this._thinEffectLayer._internalCompose(e)}_setEmissiveTextureAndColor(e,t,i){this._thinEffectLayer._setEmissiveTextureAndColor(e,t,i)}_shouldRenderMesh(e){return this._thinEffectLayer._shouldRenderMesh(e)}_addCustomEffectDefines(e){this._thinEffectLayer._addCustomEffectDefines(e)}addExcludedMesh(e){this._thinEffectLayer.addExcludedMesh(e)}removeExcludedMesh(e){this._thinEffectLayer.removeExcludedMesh(e)}addIncludedOnlyMesh(e){this._thinEffectLayer.addIncludedOnlyMesh(e)}removeIncludedOnlyMesh(e){this._thinEffectLayer.removeIncludedOnlyMesh(e)}hasMesh(e){return this._thinEffectLayer.hasMesh(e)}_useMeshMaterial(e){return this._thinEffectLayer._useMeshMaterial(e)}referenceMeshToUseItsOwnMaterial(e){this._thinEffectLayer.referenceMeshToUseItsOwnMaterial(e)}unReferenceMeshFromUsingItsOwnMaterial(e){this._thinEffectLayer.unReferenceMeshFromUsingItsOwnMaterial(e,this._mainTexture.renderPassId)}_disposeMesh(e){this._thinEffectLayer._disposeMesh(e)}getClassName(){return"GlowLayer"}serialize(){const e=me.Serialize(this);e.customType="BABYLON.GlowLayer";let t;e.includedMeshes=[];const i=this._thinEffectLayer._includedOnlyMeshes;if(i.length)for(t=0;t<i.length;t++){const n=this._scene.getMeshByUniqueId(i[t]);n&&e.includedMeshes.push(n.id)}e.excludedMeshes=[];const r=this._thinEffectLayer._excludedMeshes;if(r.length)for(t=0;t<r.length;t++){const n=this._scene.getMeshByUniqueId(r[t]);n&&e.excludedMeshes.push(n.id)}return e}static Parse(e,t,i){const r=me.Parse(()=>new es(e.name,t,e.options),e,t,i);let n;for(n=0;n<e.excludedMeshes.length;n++){const a=t.getMeshById(e.excludedMeshes[n]);a&&r.addExcludedMesh(a)}for(n=0;n<e.includedMeshes.length;n++){const a=t.getMeshById(e.includedMeshes[n]);a&&r.addIncludedOnlyMesh(a)}return r}}es.DefaultBlurKernelSize=32;es.DefaultTextureRatio=.5;_([R()],es.prototype,"blurKernelSize",null);_([R()],es.prototype,"intensity",null);_([R("options")],es.prototype,"_options",void 0);y("BABYLON.GlowLayer",es);le.prototype.getHighlightLayerByName=function(s){var e;for(let t=0;t<((e=this.effectLayers)==null?void 0:e.length);t++)if(this.effectLayers[t].name===s&&this.effectLayers[t].getEffectName()===Ts.EffectName)return this.effectLayers[t];return null};class Qv extends Se{constructor(e,t,i,r,n=null,a=$.BILINEAR_SAMPLINGMODE,o,l){const c={uniforms:ms.Uniforms,size:typeof r=="number"?r:void 0,camera:n,samplingMode:a,engine:o,reusable:l,...r};super(e,ms.FragmentUrl,{effectWrapper:typeof r=="number"||!r.effectWrapper?new ms(e,o,t,i,c):void 0,...c}),this.direction=t,this.kernel=i,this.onApplyObservable.add(()=>{this._effectWrapper.textureWidth=this.width,this._effectWrapper.textureHeight=this.height})}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(U(()=>Promise.resolve().then(()=>Eh),void 0))):t.push(U(()=>Promise.resolve().then(()=>xh),void 0)),super._gatherImports(e,t)}}class Ts extends kr{static get NeutralColor(){return Nr.NeutralColor}static set NeutralColor(e){Nr.NeutralColor=e}get innerGlow(){return this._thinEffectLayer.innerGlow}set innerGlow(e){this._thinEffectLayer.innerGlow=e}get outerGlow(){return this._thinEffectLayer.outerGlow}set outerGlow(e){this._thinEffectLayer.outerGlow=e}set blurHorizontalSize(e){this._thinEffectLayer.blurHorizontalSize=e}set blurVerticalSize(e){this._thinEffectLayer.blurVerticalSize=e}get blurHorizontalSize(){return this._thinEffectLayer.blurHorizontalSize}get blurVerticalSize(){return this._thinEffectLayer.blurVerticalSize}constructor(e,t,i){super(e,t,i!==void 0?!!i.forceGLSL:!1,new Nr(e,t,i)),this.onBeforeBlurObservable=new k,this.onAfterBlurObservable=new k,this._engine.isStencilEnable||N.Warn("Rendering the Highlight Layer requires the stencil to be active on the canvas. var engine = new Engine(canvas, antialias, { stencil: true }"),this._options={mainTextureRatio:.5,blurTextureSizeRatio:.5,mainTextureFixedSize:0,blurHorizontalSize:1,blurVerticalSize:1,alphaBlendingMode:2,camera:null,renderingGroupId:-1,mainTextureType:0,forceGLSL:!1,isStroke:!1,...i},this._init(this._options),this._shouldRender=!1}getEffectName(){return Ts.EffectName}_numInternalDraws(){return 2}_createMergeEffect(){return this._thinEffectLayer._createMergeEffect()}_createTextureAndPostProcesses(){let e=this._mainTextureDesiredSize.width*this._options.blurTextureSizeRatio,t=this._mainTextureDesiredSize.height*this._options.blurTextureSizeRatio;e=this._engine.needPOTTextures?$n(e,this._maxSize):e,t=this._engine.needPOTTextures?$n(t,this._maxSize):t;let i=0;this._engine.getCaps().textureHalfFloatRender?i=2:i=0,this._blurTexture=new Zi("HighlightLayerBlurRTT",{width:e,height:t},this._scene,!1,!0,i),this._blurTexture.wrapU=$.CLAMP_ADDRESSMODE,this._blurTexture.wrapV=$.CLAMP_ADDRESSMODE,this._blurTexture.anisotropicFilteringLevel=16,this._blurTexture.updateSamplingMode($.TRILINEAR_SAMPLINGMODE),this._blurTexture.renderParticles=!1,this._blurTexture.ignoreCameraViewport=!0,this._textures=[this._blurTexture],this._thinEffectLayer.bindTexturesForCompose=r=>{r.setTexture("textureSampler",this._blurTexture)},this._thinEffectLayer._createTextureAndPostProcesses(),this._options.alphaBlendingMode===2?(this._downSamplePostprocess=new Uo("HighlightLayerPPP",{size:this._options.blurTextureSizeRatio,samplingMode:$.BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),effectWrapper:this._thinEffectLayer._postProcesses[0]}),this._downSamplePostprocess.externalTextureSamplerBinding=!0,this._downSamplePostprocess.onApplyObservable.add(r=>{r.setTexture("textureSampler",this._mainTexture)}),this._horizontalBlurPostprocess=new Qv("HighlightLayerHBP",new X(1,0),this._options.blurHorizontalSize,{samplingMode:$.BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),effectWrapper:this._thinEffectLayer._postProcesses[1]}),this._horizontalBlurPostprocess.onApplyObservable.add(r=>{r.setFloat2("screenSize",e,t)}),this._verticalBlurPostprocess=new Qv("HighlightLayerVBP",new X(0,1),this._options.blurVerticalSize,{samplingMode:$.BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),effectWrapper:this._thinEffectLayer._postProcesses[2]}),this._verticalBlurPostprocess.onApplyObservable.add(r=>{r.setFloat2("screenSize",e,t)}),this._postProcesses=[this._downSamplePostprocess,this._horizontalBlurPostprocess,this._verticalBlurPostprocess]):(this._horizontalBlurPostprocess=new nr("HighlightLayerHBP",new X(1,0),this._options.blurHorizontalSize/2,{size:{width:e,height:t},samplingMode:$.BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),textureType:i,effectWrapper:this._thinEffectLayer._postProcesses[0]}),this._horizontalBlurPostprocess.width=e,this._horizontalBlurPostprocess.height=t,this._horizontalBlurPostprocess.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess.onApplyObservable.add(r=>{r.setTexture("textureSampler",this._mainTexture)}),this._verticalBlurPostprocess=new nr("HighlightLayerVBP",new X(0,1),this._options.blurVerticalSize/2,{size:{width:e,height:t},samplingMode:$.BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),textureType:i}),this._postProcesses=[this._horizontalBlurPostprocess,this._verticalBlurPostprocess]),this._mainTexture.onAfterUnbindObservable.add(()=>{this.onBeforeBlurObservable.notifyObservers(this);const r=this._blurTexture.renderTarget;r&&(this._scene.postProcessManager.directRender(this._postProcesses,r,!0),this._engine.unBindFramebuffer(r,!0)),this.onAfterBlurObservable.notifyObservers(this)}),this._postProcesses.map(r=>{r.autoClear=!1})}needStencil(){return this._thinEffectLayer.needStencil()}isReady(e,t){return this._thinEffectLayer.isReady(e,t)}_internalRender(e,t){this._thinEffectLayer._internalCompose(e,t)}shouldRender(){return this._thinEffectLayer.shouldRender()}_shouldRenderMesh(e){return this._thinEffectLayer._shouldRenderMesh(e)}_canRenderMesh(e,t){return this._thinEffectLayer._canRenderMesh(e,t)}_addCustomEffectDefines(e){this._thinEffectLayer._addCustomEffectDefines(e)}_setEmissiveTextureAndColor(e,t,i){this._thinEffectLayer._setEmissiveTextureAndColor(e,t,i)}addExcludedMesh(e){this._thinEffectLayer.addExcludedMesh(e)}removeExcludedMesh(e){this._thinEffectLayer.removeExcludedMesh(e)}hasMesh(e){return this._thinEffectLayer.hasMesh(e)}addMesh(e,t,i=!1){this._thinEffectLayer.addMesh(e,t,i)}removeMesh(e){this._thinEffectLayer.removeMesh(e)}removeAllMeshes(){this._thinEffectLayer.removeAllMeshes()}_disposeMesh(e){this._thinEffectLayer._disposeMesh(e)}getClassName(){return"HighlightLayer"}serialize(){const e=me.Serialize(this);e.customType="BABYLON.HighlightLayer",e.meshes=[];const t=this._thinEffectLayer._meshes;if(t)for(const r in t){const n=t[r];n&&e.meshes.push({glowEmissiveOnly:n.glowEmissiveOnly,color:n.color.asArray(),meshId:n.mesh.id})}e.excludedMeshes=[];const i=this._thinEffectLayer._excludedMeshes;if(i)for(const r in i){const n=i[r];n&&e.excludedMeshes.push(n.mesh.id)}return e}static Parse(e,t,i){const r=me.Parse(()=>new Ts(e.name,t,e.options),e,t,i);let n;for(n=0;n<e.excludedMeshes.length;n++){const a=t.getMeshById(e.excludedMeshes[n]);a&&r.addExcludedMesh(a)}for(n=0;n<e.meshes.length;n++){const a=e.meshes[n],o=t.getMeshById(a.meshId);o&&r.addMesh(o,q.FromArray(a.color),a.glowEmissiveOnly)}return r}}Ts.EffectName="HighlightLayer";_([R()],Ts.prototype,"innerGlow",null);_([R()],Ts.prototype,"outerGlow",null);_([R()],Ts.prototype,"blurHorizontalSize",null);_([R()],Ts.prototype,"blurVerticalSize",null);_([R("options")],Ts.prototype,"_options",void 0);y("BABYLON.HighlightLayer",Ts);const Cd="glowMapGenerationPixelShader",XR=`#if defined(DIFFUSE_ISLINEAR) || defined(EMISSIVE_ISLINEAR)
#include<helperFunctions>
#endif
#ifdef DIFFUSE
varying vec2 vUVDiffuse;uniform sampler2D diffuseSampler;
#endif
#ifdef OPACITY
varying vec2 vUVOpacity;uniform sampler2D opacitySampler;uniform float opacityIntensity;
#endif
#ifdef EMISSIVE
varying vec2 vUVEmissive;uniform sampler2D emissiveSampler;
#endif
#ifdef VERTEXALPHA
varying vec4 vColor;
#endif
uniform vec4 glowColor;uniform float glowIntensity;
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#include<clipPlaneFragment>
vec4 finalColor=glowColor;
#ifdef DIFFUSE
vec4 albedoTexture=texture2D(diffuseSampler,vUVDiffuse);
#ifdef DIFFUSE_ISLINEAR
albedoTexture=toGammaSpace(albedoTexture);
#endif
#ifdef GLOW
finalColor.a*=albedoTexture.a;
#endif
#ifdef HIGHLIGHT
finalColor.a=albedoTexture.a;
#endif
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vUVOpacity);
#ifdef OPACITYRGB
finalColor.a*=getLuminance(opacityMap.rgb);
#else
finalColor.a*=opacityMap.a;
#endif
finalColor.a*=opacityIntensity;
#endif
#ifdef VERTEXALPHA
finalColor.a*=vColor.a;
#endif
#ifdef ALPHATEST
if (finalColor.a<ALPHATESTVALUE)
discard;
#endif
#ifdef EMISSIVE
vec4 emissive=texture2D(emissiveSampler,vUVEmissive);
#ifdef EMISSIVE_ISLINEAR
emissive=toGammaSpace(emissive);
#endif
gl_FragColor=emissive*finalColor*glowIntensity;
#else
gl_FragColor=finalColor*glowIntensity;
#endif
#ifdef HIGHLIGHT
gl_FragColor.a=glowColor.a;
#endif
}`;S.ShadersStore[Cd]||(S.ShadersStore[Cd]=XR);const XV={name:Cd,shader:XR},YV=Object.freeze(Object.defineProperty({__proto__:null,glowMapGenerationPixelShader:XV},Symbol.toStringTag,{value:"Module"})),yd="glowMapGenerationVertexShader",YR=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform mat4 viewProjection;varying vec4 vPosition;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#ifdef DIFFUSE
varying vec2 vUVDiffuse;uniform mat4 diffuseMatrix;
#endif
#ifdef OPACITY
varying vec2 vUVOpacity;uniform mat4 opacityMatrix;
#endif
#ifdef EMISSIVE
varying vec2 vUVEmissive;uniform mat4 emissiveMatrix;
#endif
#ifdef VERTEXALPHA
attribute vec4 color;varying vec4 vColor;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#ifdef UV2
vec2 uv2Updated=uv2;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef CUBEMAP
vPosition=worldPos;gl_Position=viewProjection*finalWorld*vec4(position,1.0);
#else
vPosition=viewProjection*worldPos;gl_Position=vPosition;
#endif
#ifdef DIFFUSE
#ifdef DIFFUSEUV1
vUVDiffuse=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef DIFFUSEUV2
vUVDiffuse=vec2(diffuseMatrix*vec4(uv2Updated,1.0,0.0));
#endif
#endif
#ifdef OPACITY
#ifdef OPACITYUV1
vUVOpacity=vec2(opacityMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef OPACITYUV2
vUVOpacity=vec2(opacityMatrix*vec4(uv2Updated,1.0,0.0));
#endif
#endif
#ifdef EMISSIVE
#ifdef EMISSIVEUV1
vUVEmissive=vec2(emissiveMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef EMISSIVEUV2
vUVEmissive=vec2(emissiveMatrix*vec4(uv2Updated,1.0,0.0));
#endif
#endif
#ifdef VERTEXALPHA
vColor=color;
#endif
#include<clipPlaneVertex>
}`;S.ShadersStore[yd]||(S.ShadersStore[yd]=YR);const jV={name:yd,shader:YR},qV=Object.freeze(Object.defineProperty({__proto__:null,glowMapGenerationVertexShader:jV},Symbol.toStringTag,{value:"Module"})),Id="glowMapGenerationPixelShader",jR=`#if defined(DIFFUSE_ISLINEAR) || defined(EMISSIVE_ISLINEAR)
#include<helperFunctions>
#endif
#ifdef DIFFUSE
varying vUVDiffuse: vec2f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;
#endif
#ifdef OPACITY
varying vUVOpacity: vec2f;var opacitySamplerSampler: sampler;var opacitySampler: texture_2d<f32>;uniform opacityIntensity: f32;
#endif
#ifdef EMISSIVE
varying vUVEmissive: vec2f;var emissiveSamplerSampler: sampler;var emissiveSampler: texture_2d<f32>;
#endif
#ifdef VERTEXALPHA
varying vColor: vec4f;
#endif
uniform glowColor: vec4f;uniform glowIntensity: f32;
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#include<clipPlaneFragment>
var finalColor: vec4f=uniforms.glowColor;
#ifdef DIFFUSE
var albedoTexture: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,fragmentInputs.vUVDiffuse);
#ifdef DIFFUSE_ISLINEAR
albedoTexture=toGammaSpace(albedoTexture);
#endif
#ifdef GLOW
finalColor=vec4f(finalColor.rgb,finalColor.a*albedoTexture.a);
#endif
#ifdef HIGHLIGHT
finalColor=vec4f(finalColor.rgb,albedoTexture.a);
#endif
#endif
#ifdef OPACITY
var opacityMap: vec4f=textureSample(opacitySampler,opacitySamplerSampler,fragmentInputs.vUVOpacity);
#ifdef OPACITYRGB
finalColor=vec4f(finalColor.rgb,finalColor.a*getLuminance(opacityMap.rgb));
#else
finalColor=vec4f(finalColor.rgb,finalColor.a*opacityMap.a);
#endif
finalColor=vec4f(finalColor.rgb,finalColor.a*uniforms.opacityIntensity);
#endif
#ifdef VERTEXALPHA
finalColor=vec4f(finalColor.rgb,finalColor.a*fragmentInputs.vColor.a);
#endif
#ifdef ALPHATEST
if (finalColor.a<ALPHATESTVALUE) {discard;}
#endif
#ifdef EMISSIVE
var emissive: vec4f=textureSample(emissiveSampler,emissiveSamplerSampler,fragmentInputs.vUVEmissive);
#ifdef EMISSIVE_ISLINEAR
emissive=toGammaSpace(emissive);
#endif
fragmentOutputs.color=emissive*finalColor*uniforms.glowIntensity;
#else
fragmentOutputs.color=finalColor*uniforms.glowIntensity;
#endif
#ifdef HIGHLIGHT
fragmentOutputs.color=vec4f(fragmentOutputs.color.rgb,uniforms.glowColor.a);
#endif
}
`;S.ShadersStoreWGSL[Id]||(S.ShadersStoreWGSL[Id]=jR);const ZV={name:Id,shader:jR},QV=Object.freeze(Object.defineProperty({__proto__:null,glowMapGenerationPixelShaderWGSL:ZV},Symbol.toStringTag,{value:"Module"})),Rd="glowMapGenerationVertexShader",qR=`attribute position: vec3f;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform viewProjection: mat4x4f;varying vPosition: vec4f;
#ifdef UV1
attribute uv: vec2f;
#endif
#ifdef UV2
attribute uv2: vec2f;
#endif
#ifdef DIFFUSE
varying vUVDiffuse: vec2f;uniform diffuseMatrix: mat4x4f;
#endif
#ifdef OPACITY
varying vUVOpacity: vec2f;uniform opacityMatrix: mat4x4f;
#endif
#ifdef EMISSIVE
varying vUVEmissive: vec2f;uniform emissiveMatrix: mat4x4f;
#endif
#ifdef VERTEXALPHA
attribute color: vec4f;varying vColor: vec4f;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;
#ifdef UV1
var uvUpdated: vec2f=input.uv;
#endif
#ifdef UV2
var uv2Updated: vec2f=input.uv2;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);
#ifdef CUBEMAP
vertexOutputs.vPosition=worldPos;vertexOutputs.position=uniforms.viewProjection*finalWorld* vec4f(input.position,1.0);
#else
vertexOutputs.vPosition=uniforms.viewProjection*worldPos;vertexOutputs.position=vertexOutputs.vPosition;
#endif
#ifdef DIFFUSE
#ifdef DIFFUSEUV1
vertexOutputs.vUVDiffuse= (uniforms.diffuseMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#endif
#ifdef DIFFUSEUV2
vertexOutputs.vUVDiffuse= (uniforms.diffuseMatrix* vec4f(uv2Updated,1.0,0.0)).xy;
#endif
#endif
#ifdef OPACITY
#ifdef OPACITYUV1
vertexOutputs.vUVOpacity= (uniforms.opacityMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#endif
#ifdef OPACITYUV2
vertexOutputs.vUVOpacity= (uniforms.opacityMatrix* vec4f(uv2Updated,1.0,0.0)).xy;
#endif
#endif
#ifdef EMISSIVE
#ifdef EMISSIVEUV1
vertexOutputs.vUVEmissive= (uniforms.emissiveMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#endif
#ifdef EMISSIVEUV2
vertexOutputs.vUVEmissive= (uniforms.emissiveMatrix* vec4f(uv2Updated,1.0,0.0)).xy;
#endif
#endif
#ifdef VERTEXALPHA
vertexOutputs.vColor=vertexInputs.color;
#endif
#include<clipPlaneVertex>
}`;S.ShadersStoreWGSL[Rd]||(S.ShadersStoreWGSL[Rd]=qR);const KV={name:Rd,shader:qR},JV=Object.freeze(Object.defineProperty({__proto__:null,glowMapGenerationVertexShaderWGSL:KV},Symbol.toStringTag,{value:"Module"})),Ad="glowMapMergePixelShader",ZR=`varying vec2 vUV;uniform sampler2D textureSampler;
#ifdef EMISSIVE
uniform sampler2D textureSampler2;
#endif
uniform float offset;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec4 baseColor=texture2D(textureSampler,vUV);
#ifdef EMISSIVE
baseColor+=texture2D(textureSampler2,vUV);baseColor*=offset;
#else
baseColor.a=abs(offset-baseColor.a);
#ifdef STROKE
float alpha=smoothstep(.0,.1,baseColor.a);baseColor.a=alpha;baseColor.rgb=baseColor.rgb*alpha;
#endif
#endif
#if LDR
baseColor=clamp(baseColor,0.,1.0);
#endif
gl_FragColor=baseColor;
#define CUSTOM_FRAGMENT_MAIN_END
}`;S.ShadersStore[Ad]||(S.ShadersStore[Ad]=ZR);const e3={name:Ad,shader:ZR},QR=Object.freeze(Object.defineProperty({__proto__:null,glowMapMergePixelShader:e3},Symbol.toStringTag,{value:"Module"})),Pd="glowMapMergeVertexShader",KR=`attribute vec2 position;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=position*madd+madd;gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;S.ShadersStore[Pd]||(S.ShadersStore[Pd]=KR);const t3={name:Pd,shader:KR},JR=Object.freeze(Object.defineProperty({__proto__:null,glowMapMergeVertexShader:t3},Symbol.toStringTag,{value:"Module"})),Od="glowBlurPostProcessPixelShader",eA=`varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform vec2 direction;uniform float blurWidth;float getLuminance(vec3 color)
{return dot(color,vec3(0.2126,0.7152,0.0722));}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{float weights[7];weights[0]=0.05;weights[1]=0.1;weights[2]=0.2;weights[3]=0.3;weights[4]=0.2;weights[5]=0.1;weights[6]=0.05;vec2 texelSize=vec2(1.0/screenSize.x,1.0/screenSize.y);vec2 texelStep=texelSize*direction*blurWidth;vec2 start=vUV-3.0*texelStep;vec4 baseColor=vec4(0.,0.,0.,0.);vec2 texelOffset=vec2(0.,0.);for (int i=0; i<7; i++)
{vec4 texel=texture2D(textureSampler,start+texelOffset);baseColor.a+=texel.a*weights[i];float luminance=getLuminance(baseColor.rgb);float luminanceTexel=getLuminance(texel.rgb);float choice=step(luminanceTexel,luminance);baseColor.rgb=choice*baseColor.rgb+(1.0-choice)*texel.rgb;texelOffset+=texelStep;}
gl_FragColor=baseColor;}`;S.ShadersStore[Od]||(S.ShadersStore[Od]=eA);const i3={name:Od,shader:eA},xh=Object.freeze(Object.defineProperty({__proto__:null,glowBlurPostProcessPixelShader:i3},Symbol.toStringTag,{value:"Module"})),Nd="glowMapMergePixelShader",tA=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;
#ifdef EMISSIVE
var textureSampler2Sampler: sampler;var textureSampler2: texture_2d<f32>;
#endif
uniform offset: f32;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
var baseColor: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);
#ifdef EMISSIVE
baseColor+=textureSample(textureSampler2,textureSampler2Sampler,input.vUV);baseColor*=uniforms.offset;
#else
baseColor=vec4f(baseColor.rgb,abs(uniforms.offset-baseColor.a));
#ifdef STROKE
var alpha: f32=smoothstep(.0,.1,baseColor.a);baseColor=vec4f(baseColor.rgb*alpha,alpha);
#endif
#endif
#if LDR
baseColor=clamp(baseColor,vec4f(0.),vec4f(1.0));
#endif
fragmentOutputs.color=baseColor;
#define CUSTOM_FRAGMENT_MAIN_END
}
`;S.ShadersStoreWGSL[Nd]||(S.ShadersStoreWGSL[Nd]=tA);const r3={name:Nd,shader:tA},iA=Object.freeze(Object.defineProperty({__proto__:null,glowMapMergePixelShaderWGSL:r3},Symbol.toStringTag,{value:"Module"})),Dd="glowMapMergeVertexShader",rA=`attribute position: vec2f;varying vUV: vec2f;
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {const madd: vec2f= vec2f(0.5,0.5);
#define CUSTOM_VERTEX_MAIN_BEGIN
vertexOutputs.vUV=input.position*madd+madd;vertexOutputs.position= vec4f(input.position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;S.ShadersStoreWGSL[Dd]||(S.ShadersStoreWGSL[Dd]=rA);const s3={name:Dd,shader:rA},sA=Object.freeze(Object.defineProperty({__proto__:null,glowMapMergeVertexShaderWGSL:s3},Symbol.toStringTag,{value:"Module"})),Md="glowBlurPostProcessPixelShader",nA=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform screenSize: vec2f;uniform direction: vec2f;uniform blurWidth: f32;fn getLuminance(color: vec3f)->f32
{return dot(color, vec3f(0.2126,0.7152,0.0722));}
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var weights: array<f32 ,7>;weights[0]=0.05;weights[1]=0.1;weights[2]=0.2;weights[3]=0.3;weights[4]=0.2;weights[5]=0.1;weights[6]=0.05;var texelSize: vec2f= vec2f(1.0/uniforms.screenSize.x,1.0/uniforms.screenSize.y);var texelStep: vec2f=texelSize*uniforms.direction*uniforms.blurWidth;var start: vec2f=input.vUV-3.0*texelStep;var baseColor: vec4f= vec4f(0.,0.,0.,0.);var texelOffset: vec2f= vec2f(0.,0.);for (var i: i32=0; i<7; i++)
{var texel: vec4f=textureSample(textureSampler,textureSamplerSampler,start+texelOffset);baseColor=vec4f(baseColor.rgb,baseColor.a+texel.a*weights[i]);var luminance: f32=getLuminance(baseColor.rgb);var luminanceTexel: f32=getLuminance(texel.rgb);var choice: f32=step(luminanceTexel,luminance);baseColor=vec4f(choice*baseColor.rgb+(1.0-choice)*texel.rgb,baseColor.a);texelOffset+=texelStep;}
fragmentOutputs.color=baseColor;}`;S.ShadersStoreWGSL[Md]||(S.ShadersStoreWGSL[Md]=nA);const n3={name:Md,shader:nA},Eh=Object.freeze(Object.defineProperty({__proto__:null,glowBlurPostProcessPixelShaderWGSL:n3},Symbol.toStringTag,{value:"Module"})),Kv="layerPixelShader",a3=`varying vec2 vUV;uniform sampler2D textureSampler;uniform vec4 color;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec4 baseColor=texture2D(textureSampler,vUV);
#if defined(CONVERT_TO_GAMMA)
baseColor.rgb=toGammaSpace(baseColor.rgb);
#elif defined(CONVERT_TO_LINEAR)
baseColor.rgb=toLinearSpace(baseColor.rgb);
#endif
#ifdef ALPHATEST
if (baseColor.a<0.4)
discard;
#endif
gl_FragColor=baseColor*color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;S.ShadersStore[Kv]||(S.ShadersStore[Kv]=a3);const Jv="layerVertexShader",o3=`attribute vec2 position;uniform vec2 scale;uniform vec2 offset;uniform mat4 textureMatrix;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec2 shiftedPosition=position*scale+offset;vUV=vec2(textureMatrix*vec4(shiftedPosition*madd+madd,1.0,0.0));gl_Position=vec4(shiftedPosition,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;S.ShadersStore[Jv]||(S.ShadersStore[Jv]=o3);const ex="layerPixelShader",l3=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform color: vec4f;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
var baseColor: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);
#if defined(CONVERT_TO_GAMMA)
baseColor=toGammaSpace(baseColor);
#elif defined(CONVERT_TO_LINEAR)
baseColor=toLinearSpaceVec4(baseColor);
#endif
#ifdef ALPHATEST
if (baseColor.a<0.4) {discard;}
#endif
fragmentOutputs.color=baseColor*uniforms.color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;S.ShadersStoreWGSL[ex]||(S.ShadersStoreWGSL[ex]=l3);const tx="layerVertexShader",c3=`attribute position: vec2f;uniform scale: vec2f;uniform offset: vec2f;uniform textureMatrix: mat4x4f;varying vUV: vec2f;const madd: vec2f= vec2f(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
var shiftedPosition: vec2f=input.position*uniforms.scale+uniforms.offset;vertexOutputs.vUV=(uniforms.textureMatrix* vec4f(shiftedPosition*madd+madd,1.0,0.0)).xy;vertexOutputs.position= vec4f(shiftedPosition,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;S.ShadersStoreWGSL[tx]||(S.ShadersStoreWGSL[tx]=c3);class M_{static AddFlare(e,t,i,r,n){return new M_(e,t,i,r,n)}constructor(e,t,i,r,n){this.size=e,this.position=t,this.alphaMode=6,this.color=i||new q(1,1,1),this.texture=r?new $(r,n.getScene(),!0):null,this._system=n;const a=n.scene.getEngine();n._onShadersLoaded.addOnce(()=>{this._drawWrapper=new gn(a),this._drawWrapper.effect=a.createEffect("lensFlare",[M.PositionKind],["color","viewportMatrix"],["textureSampler"],"",void 0,void 0,void 0,void 0,n.shaderLanguage)}),n.lensFlares.push(this)}dispose(){this.texture&&this.texture.dispose();const e=this._system.lensFlares.indexOf(this);this._system.lensFlares.splice(e,1)}}class Un{get scene(){return this._scene}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i){this.name=e,this.lensFlares=[],this.borderLimit=300,this.viewportBorder=0,this.layerMask=268435455,this._shaderLanguage=0,this._vertexBuffers={},this._isEnabled=!0,this._onShadersLoaded=new k(void 0,!0),this._shadersLoaded=!1,this._scene=i||De.LastCreatedScene,Un._SceneComponentInitialization(this._scene),this._emitter=t,this.id=e,i.lensFlareSystems.push(this),this.meshesSelectionPredicate=a=>i.activeCamera&&a.material&&a.isVisible&&a.isEnabled()&&a.isBlocker&&(a.layerMask&i.activeCamera.layerMask)!=0;const r=i.getEngine(),n=[];n.push(1,1),n.push(-1,1),n.push(-1,-1),n.push(1,-1),this._vertexBuffers[M.PositionKind]=new M(r,n,M.PositionKind,!1,!1,2),this._createIndexBuffer(),this._initShaderSourceAsync()}async _initShaderSourceAsync(){this._scene.getEngine().isWebGPU&&!Un.ForceGLSL?(this._shaderLanguage=1,await Promise.all([U(()=>Promise.resolve().then(()=>_3),void 0),U(()=>Promise.resolve().then(()=>S3),void 0)])):await Promise.all([U(()=>Promise.resolve().then(()=>d3),void 0),U(()=>Promise.resolve().then(()=>p3),void 0)]),this._shadersLoaded=!0,this._onShadersLoaded.notifyObservers()}_createIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled=e}getScene(){return this._scene}getEmitter(){return this._emitter}setEmitter(e){this._emitter=e}getEmitterPosition(){return this._emitter.getAbsolutePosition?this._emitter.getAbsolutePosition():this._emitter.position}computeEffectivePosition(e){let t=this.getEmitterPosition();t=x.Project(t,z.Identity(),this._scene.getTransformMatrix(),e),this._positionX=t.x,this._positionY=t.y,t=x.TransformCoordinates(this.getEmitterPosition(),this._scene.getViewMatrix()),this.viewportBorder>0&&(e.x-=this.viewportBorder,e.y-=this.viewportBorder,e.width+=this.viewportBorder*2,e.height+=this.viewportBorder*2,t.x+=this.viewportBorder,t.y+=this.viewportBorder,this._positionX+=this.viewportBorder,this._positionY+=this.viewportBorder);const i=this._scene.useRightHandedSystem;return t.z>0&&!i||t.z<0&&i?(this._positionX>e.x&&this._positionX<e.x+e.width&&this._positionY>e.y&&this._positionY<e.y+e.height,!0):!1}_isVisible(){if(!this._isEnabled||!this._scene.activeCamera)return!1;const t=this.getEmitterPosition().subtract(this._scene.activeCamera.globalPosition),i=t.length();t.normalize();const r=new xe(this._scene.activeCamera.globalPosition,t),n=this._scene.pickWithRay(r,this.meshesSelectionPredicate,!0);return!n||!n.hit||n.distance>i}render(){if(!this._scene.activeCamera||!this._shadersLoaded)return!1;const e=this._scene.getEngine(),i=this._scene.activeCamera.viewport.toGlobal(e.getRenderWidth(!0),e.getRenderHeight(!0));if(!this.computeEffectivePosition(i)||!this._isVisible())return!1;let r,n;this._positionX<this.borderLimit+i.x?r=this.borderLimit+i.x-this._positionX:this._positionX>i.x+i.width-this.borderLimit?r=this._positionX-i.x-i.width+this.borderLimit:r=0,this._positionY<this.borderLimit+i.y?n=this.borderLimit+i.y-this._positionY:this._positionY>i.y+i.height-this.borderLimit?n=this._positionY-i.y-i.height+this.borderLimit:n=0;let a=r>n?r:n;a-=this.viewportBorder,a>this.borderLimit&&(a=this.borderLimit);let o=1-ls(a/this.borderLimit,0,1);if(o<0)return!1;o>1&&(o=1),this.viewportBorder>0&&(i.x+=this.viewportBorder,i.y+=this.viewportBorder,i.width-=this.viewportBorder*2,i.height-=this.viewportBorder*2,this._positionX-=this.viewportBorder,this._positionY-=this.viewportBorder);const l=i.x+i.width/2,c=i.y+i.height/2,u=l-this._positionX,h=c-this._positionY;e.setState(!1),e.setDepthBuffer(!1);for(let d=0;d<this.lensFlares.length;d++){const f=this.lensFlares[d];if(!f._drawWrapper.effect.isReady()||f.texture&&!f.texture.isReady())continue;e.enableEffect(f._drawWrapper),e.bindBuffers(this._vertexBuffers,this._indexBuffer,f._drawWrapper.effect),e.setAlphaMode(f.alphaMode);const m=l-u*f.position,g=c-h*f.position,v=f.size,E=f.size*e.getAspectRatio(this._scene.activeCamera,!0),T=2*((m-i.x)/i.width)-1,C=1-2*((g-i.y)/i.height),A=z.FromValues(v/2,0,0,0,0,E/2,0,0,0,0,1,0,T,C,0,1);f._drawWrapper.effect.setMatrix("viewportMatrix",A),f._drawWrapper.effect.setTexture("textureSampler",f.texture),f._drawWrapper.effect.setFloat4("color",f.color.r*o,f.color.g*o,f.color.b*o,1),e.drawElementsType(Le.TriangleFillMode,0,6)}return e.setDepthBuffer(!0),e.setAlphaMode(0),!0}rebuild(){var e;this._createIndexBuffer();for(const t in this._vertexBuffers)(e=this._vertexBuffers[t])==null||e._rebuild()}dispose(){this._onShadersLoaded.clear();const e=this._vertexBuffers[M.PositionKind];for(e&&(e.dispose(),this._vertexBuffers[M.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);this.lensFlares.length;)this.lensFlares[0].dispose();const t=this._scene.lensFlareSystems.indexOf(this);this._scene.lensFlareSystems.splice(t,1)}static Parse(e,t,i){const r=t.getLastEntryById(e.emitterId),n=e.name||"lensFlareSystem#"+e.emitterId,a=new Un(n,r,t);a.id=e.id||n,a.borderLimit=e.borderLimit;for(let o=0;o<e.flares.length;o++){const l=e.flares[o];M_.AddFlare(l.size,l.position,q.FromArray(l.color),l.textureName?i+l.textureName:"",a)}return a}serialize(){const e={};e.id=this.id,e.name=this.name,e.emitterId=this.getEmitter().id,e.borderLimit=this.borderLimit,e.flares=[];for(let t=0;t<this.lensFlares.length;t++){const i=this.lensFlares[t];e.flares.push({size:i.size,position:i.position,color:i.color.asArray(),textureName:j.GetFilename(i.texture?i.texture.name:"")})}return e}}Un.ForceGLSL=!1;Un._SceneComponentInitialization=s=>{throw Ys("LensFlareSystemSceneComponent")};ko(se.NAME_LENSFLARESYSTEM,(s,e,t,i)=>{if(s.lensFlareSystems!==void 0&&s.lensFlareSystems!==null){t.lensFlareSystems||(t.lensFlareSystems=[]);for(let r=0,n=s.lensFlareSystems.length;r<n;r++){const a=s.lensFlareSystems[r],o=Un.Parse(a,e,i);t.lensFlareSystems.push(o)}}});le.prototype.getLensFlareSystemByName=function(s){for(let e=0;e<this.lensFlareSystems.length;e++)if(this.lensFlareSystems[e].name===s)return this.lensFlareSystems[e];return null};le.prototype.getLensFlareSystemById=function(s){for(let e=0;e<this.lensFlareSystems.length;e++)if(this.lensFlareSystems[e].id===s)return this.lensFlareSystems[e];return null};le.prototype.getLensFlareSystemByID=function(s){return this.getLensFlareSystemById(s)};le.prototype.removeLensFlareSystem=function(s){const e=this.lensFlareSystems.indexOf(s);return e!==-1&&this.lensFlareSystems.splice(e,1),e};le.prototype.addLensFlareSystem=function(s){this.lensFlareSystems.push(s)};class u3{constructor(e){this.name=se.NAME_LENSFLARESYSTEM,this.scene=e}register(){this.scene._afterCameraDrawStage.registerStep(se.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM,this,this._draw)}rebuild(){for(let e=0;e<this.scene.lensFlareSystems.length;e++)this.scene.lensFlareSystems[e].rebuild()}addFromContainer(e){if(e.lensFlareSystems)for(const t of e.lensFlareSystems)this.scene.addLensFlareSystem(t)}removeFromContainer(e,t){if(e.lensFlareSystems)for(const i of e.lensFlareSystems)this.scene.removeLensFlareSystem(i),t&&i.dispose()}serialize(e){e.lensFlareSystems=[];const t=this.scene.lensFlareSystems;for(const i of t)e.lensFlareSystems.push(i.serialize())}dispose(){const e=this.scene.lensFlareSystems;for(;e.length;)e[0].dispose()}_draw(e){if(this.scene.lensFlaresEnabled){const t=this.scene.lensFlareSystems;j.StartPerformanceCounter("Lens flares",t.length>0);for(const i of t)e.layerMask&i.layerMask&&i.render();j.EndPerformanceCounter("Lens flares",t.length>0)}}}Un._SceneComponentInitialization=s=>{let e=s._getComponent(se.NAME_LENSFLARESYSTEM);e||(e=new u3(s),s._addComponent(e))};const Fd="lensFlarePixelShader",aA=`varying vec2 vUV;uniform sampler2D textureSampler;uniform vec4 color;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec4 baseColor=texture2D(textureSampler,vUV);gl_FragColor=baseColor*color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;S.ShadersStore[Fd]||(S.ShadersStore[Fd]=aA);const h3={name:Fd,shader:aA},d3=Object.freeze(Object.defineProperty({__proto__:null,lensFlarePixelShader:h3},Symbol.toStringTag,{value:"Module"})),Ld="lensFlareVertexShader",oA=`attribute vec2 position;uniform mat4 viewportMatrix;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=position*madd+madd;gl_Position=viewportMatrix*vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;S.ShadersStore[Ld]||(S.ShadersStore[Ld]=oA);const f3={name:Ld,shader:oA},p3=Object.freeze(Object.defineProperty({__proto__:null,lensFlareVertexShader:f3},Symbol.toStringTag,{value:"Module"})),wd="lensFlarePixelShader",lA=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform color: vec4f;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
var baseColor: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);fragmentOutputs.color=baseColor*uniforms.color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;S.ShadersStoreWGSL[wd]||(S.ShadersStoreWGSL[wd]=lA);const m3={name:wd,shader:lA},_3=Object.freeze(Object.defineProperty({__proto__:null,lensFlarePixelShaderWGSL:m3},Symbol.toStringTag,{value:"Module"})),Bd="lensFlareVertexShader",cA=`attribute position: vec2f;uniform viewportMatrix: mat4x4f;varying vUV: vec2f;const madd: vec2f= vec2f(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
vertexOutputs.vUV=input.position*madd+madd;vertexOutputs.position=uniforms.viewportMatrix* vec4f(input.position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;S.ShadersStoreWGSL[Bd]||(S.ShadersStoreWGSL[Bd]=cA);const g3={name:Bd,shader:cA},S3=Object.freeze(Object.defineProperty({__proto__:null,lensFlareVertexShaderWGSL:g3},Symbol.toStringTag,{value:"Module"}));ko(se.NAME_SHADOWGENERATOR,(s,e)=>{if(s.shadowGenerators!==void 0&&s.shadowGenerators!==null)for(let t=0,i=s.shadowGenerators.length;t<i;t++){const r=s.shadowGenerators[t];r.className===gg.CLASSNAME?gg.Parse(r,e):Ar.Parse(r,e)}});class v3{constructor(e){this.name=se.NAME_SHADOWGENERATOR,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(se.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this._gatherRenderTargets)}rebuild(){}serialize(e){e.shadowGenerators=[];const t=this.scene.lights;for(const i of t){if(i.doNotSerialize)continue;const r=i.getShadowGenerators();if(r){const n=r.values();for(let a=n.next();a.done!==!0;a=n.next()){const o=a.value;o.doNotSerialize||e.shadowGenerators.push(o.serialize())}}}}addFromContainer(e){}removeFromContainer(e,t){}dispose(){}_gatherRenderTargets(e){const t=this.scene;if(this.scene.shadowsEnabled)for(let i=0;i<t.lights.length;i++){const r=t.lights[i],n=r.getShadowGenerators();if(r.isEnabled()&&r.shadowEnabled&&n){const a=n.values();for(let o=a.next();o.done!==!0;o=a.next()){const c=o.value.getShadowMap();t.textures.indexOf(c)!==-1&&e.push(c)}}}}}Ar._SceneComponentInitialization=s=>{let e=s._getComponent(se.NAME_SHADOWGENERATOR);e||(e=new v3(s),s._addComponent(e))};async function x3(){const s=new Uint16Array(16384),e=new Uint16Array(64*64*4),t=await j.LoadFileAsync(j.GetAssetUrl("https://assets.babylonjs.com/core/areaLights/areaLightsLTC.bin")),i=new Uint16Array(t),r=i.length/8;for(let n=0;n<r;n++)s[n*4]=i[n*8],s[n*4+1]=i[n*8+1],s[n*4+2]=i[n*8+2],s[n*4+3]=i[n*8+3],e[n*4]=i[n*8+4],e[n*4+1]=i[n*8+5],e[n*4+2]=i[n*8+6],e[n*4+3]=i[n*8+7];return[s,e]}function E3(s){const e=s.useDelayedTextureLoading;s.useDelayedTextureLoading=!1;const t=s._blockEntityCollection;s._blockEntityCollection=!1,s._ltcTextures={LTC1:gi.CreateRGBATexture(null,64,64,s.getEngine(),!1,!1,2,2,0,!1,!0),LTC2:gi.CreateRGBATexture(null,64,64,s.getEngine(),!1,!1,2,2,0,!1,!0)},s._blockEntityCollection=t,s._ltcTextures.LTC1.wrapU=$.CLAMP_ADDRESSMODE,s._ltcTextures.LTC1.wrapV=$.CLAMP_ADDRESSMODE,s._ltcTextures.LTC2.wrapU=$.CLAMP_ADDRESSMODE,s._ltcTextures.LTC2.wrapV=$.CLAMP_ADDRESSMODE,s.useDelayedTextureLoading=e,x3().then(i=>{var r,n;s._ltcTextures&&(((r=s._ltcTextures)==null?void 0:r.LTC1).update(i[0]),((n=s._ltcTextures)==null?void 0:n.LTC2).update(i[1]),s.onDisposeObservable.addOnce(()=>{var l,c;(l=s._ltcTextures)==null||l.LTC1.dispose(),(c=s._ltcTextures)==null||c.LTC2.dispose()}))}).catch(i=>{N.Error(`Area Light fail to get LTC textures data. Error: ${i}`)})}class T3 extends Xs{constructor(e,t,i){super(e,i),this.position=t,this._scene._ltcTextures||E3(this._scene)}transferTexturesToEffect(e){return this._scene._ltcTextures&&(e.setTexture("areaLightsLTC1Sampler",this._scene._ltcTextures.LTC1),e.setTexture("areaLightsLTC2Sampler",this._scene._ltcTextures.LTC2)),this}prepareLightSpecificDefines(e,t){e["AREALIGHT"+t]=!0,e.AREALIGHTUSED=!0}_isReady(){return this._scene._ltcTextures?this._scene._ltcTextures.LTC1.isReady()&&this._scene._ltcTextures.LTC2.isReady():!1}}fi.AddNodeConstructor("Light_Type_4",(s,e)=>()=>new Th(s,x.Zero(),1,1,e));class Th extends T3{get width(){return this._width.x}set width(e){this._width.x=e}get height(){return this._height.y}set height(e){this._height.y=e}constructor(e,t,i,r,n){super(e,t,n),this._width=new x(i,0,0),this._height=new x(0,r,0),this._pointTransformedPosition=x.Zero(),this._pointTransformedWidth=x.Zero(),this._pointTransformedHeight=x.Zero()}getClassName(){return"RectAreaLight"}getTypeID(){return Xs.LIGHTTYPEID_RECT_AREALIGHT}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightWidth",4),this._uniformBuffer.addUniform("vLightHeight",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}_computeTransformedInformation(){return this.parent&&this.parent.getWorldMatrix?(x.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this._pointTransformedPosition),x.TransformNormalToRef(this._width,this.parent.getWorldMatrix(),this._pointTransformedWidth),x.TransformNormalToRef(this._height,this.parent.getWorldMatrix(),this._pointTransformedHeight),!0):!1}transferToEffect(e,t){return this._computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this._pointTransformedPosition.x-this._scene.floatingOriginOffset.x,this._pointTransformedPosition.y-this._scene.floatingOriginOffset.y,this._pointTransformedPosition.z-this._scene.floatingOriginOffset.z,0,t),this._uniformBuffer.updateFloat4("vLightWidth",this._pointTransformedWidth.x/2,this._pointTransformedWidth.y/2,this._pointTransformedWidth.z/2,0,t),this._uniformBuffer.updateFloat4("vLightHeight",this._pointTransformedHeight.x/2,this._pointTransformedHeight.y/2,this._pointTransformedHeight.z/2,0,t)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x-this._scene.floatingOriginOffset.x,this.position.y-this._scene.floatingOriginOffset.y,this.position.z-this._scene.floatingOriginOffset.z,0,t),this._uniformBuffer.updateFloat4("vLightWidth",this._width.x/2,this._width.y/2,this._width.z/2,0,t),this._uniformBuffer.updateFloat4("vLightHeight",this._height.x/2,this._height.y/2,this._height.z/2,0,t)),this}transferToNodeMaterialEffect(e,t){return this._computeTransformedInformation()?e.setFloat3(t,this._pointTransformedPosition.x-this._scene.floatingOriginOffset.x,this._pointTransformedPosition.y-this._scene.floatingOriginOffset.y,this._pointTransformedPosition.z-this._scene.floatingOriginOffset.z):e.setFloat3(t,this.position.x-this._scene.floatingOriginOffset.x,this.position.y-this._scene.floatingOriginOffset.y,this.position.z-this._scene.floatingOriginOffset.z),this}}_([R()],Th.prototype,"width",null);_([R()],Th.prototype,"height",null);y("BABYLON.RectAreaLight",Th);Oe.prototype.thinInstanceAdd=function(s,e=!0){if(!this.getScene().getEngine().getCaps().instancedArrays)return N.Error("Thin Instances are not supported on this device as Instanced Array extension not supported"),-1;this._thinInstanceUpdateBufferSize("matrix",Array.isArray(s)?s.length:1);const t=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(s))for(let i=0;i<s.length;++i)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,s[i],i===s.length-1&&e);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,s,e);return t};Oe.prototype.thinInstanceAddSelf=function(s=!0){return this.thinInstanceAdd(z.IdentityReadOnly,s)};Oe.prototype.thinInstanceRegisterAttribute=function(s,e){s===M.ColorKind&&(s=M.ColorInstanceKind),this.removeVerticesData(s),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[s]=e,this._userThinInstanceBuffersStorage.sizes[s]=e*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[s]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[s]),this._userThinInstanceBuffersStorage.vertexBuffers[s]=new M(this.getEngine(),this._userThinInstanceBuffersStorage.data[s],s,!0,!1,e,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[s])};Oe.prototype.thinInstanceSetMatrixAt=function(s,e,t=!0){if(!this._thinInstanceDataStorage.matrixData||s>=this._thinInstanceDataStorage.instancesCount)return!1;const i=this._thinInstanceDataStorage.matrixData;return e.copyToArray(i,s*16),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[s]=e),t&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0};Oe.prototype.thinInstanceSetAttributeAt=function(s,e,t,i=!0){return s===M.ColorKind&&(s=M.ColorInstanceKind),!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.data[s]||e>=this._thinInstanceDataStorage.instancesCount?!1:(this._thinInstanceUpdateBufferSize(s,0),this._userThinInstanceBuffersStorage.data[s].set(t,e*this._userThinInstanceBuffersStorage.strides[s]),i&&this.thinInstanceBufferUpdated(s),!0)};Object.defineProperty(Oe.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(s){var i;const e=this._thinInstanceDataStorage.matrixData??((i=this.source)==null?void 0:i._thinInstanceDataStorage.matrixData),t=e?e.length/16:0;s<=t&&(this._thinInstanceDataStorage.instancesCount=s)},enumerable:!0,configurable:!0});Oe.prototype._thinInstanceCreateMatrixBuffer=function(s,e,t=!0){const i=new gr(this.getEngine(),e,!t,16,!1,!0);for(let r=0;r<4;r++)this.setVerticesBuffer(i.createVertexBuffer(s+r,r*4,4));return i};Oe.prototype.thinInstanceSetBuffer=function(s,e,t=0,i=!0){var r,n,a;t=t||16,s==="matrix"?((r=this._thinInstanceDataStorage.matrixBuffer)==null||r.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=e?e.length:32*t,this._thinInstanceDataStorage.matrixData=e,this._thinInstanceDataStorage.worldMatrices=null,e!==null?(this._thinInstanceDataStorage.instancesCount=e.length/t,this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",e,i),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)):(this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo())):s==="previousMatrix"?((n=this._thinInstanceDataStorage.previousMatrixBuffer)==null||n.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null,this._thinInstanceDataStorage.previousMatrixData=e,e!==null&&(this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",e,i))):(s===M.ColorKind&&(s=M.ColorInstanceKind),e===null?(a=this._userThinInstanceBuffersStorage)!=null&&a.data[s]&&(this.removeVerticesData(s),delete this._userThinInstanceBuffersStorage.data[s],delete this._userThinInstanceBuffersStorage.strides[s],delete this._userThinInstanceBuffersStorage.sizes[s],delete this._userThinInstanceBuffersStorage.vertexBuffers[s]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[s]=e,this._userThinInstanceBuffersStorage.strides[s]=t,this._userThinInstanceBuffersStorage.sizes[s]=e.length,this._userThinInstanceBuffersStorage.vertexBuffers[s]=new M(this.getEngine(),e,s,!i,!1,t,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[s])))};Oe.prototype.thinInstanceBufferUpdated=function(s){var e,t,i;s==="matrix"?(this.thinInstanceAllowAutomaticStaticBufferRecreation&&this._thinInstanceDataStorage.matrixBuffer&&!this._thinInstanceDataStorage.matrixBuffer.isUpdatable()&&this._thinInstanceRecreateBuffer(s),(e=this._thinInstanceDataStorage.matrixBuffer)==null||e.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount)):s==="previousMatrix"?(this.thinInstanceAllowAutomaticStaticBufferRecreation&&this._thinInstanceDataStorage.previousMatrixBuffer&&!this._thinInstanceDataStorage.previousMatrixBuffer.isUpdatable()&&this._thinInstanceRecreateBuffer(s),(t=this._thinInstanceDataStorage.previousMatrixBuffer)==null||t.updateDirectly(this._thinInstanceDataStorage.previousMatrixData,0,this._thinInstanceDataStorage.instancesCount)):(s===M.ColorKind&&(s=M.ColorInstanceKind),(i=this._userThinInstanceBuffersStorage)!=null&&i.vertexBuffers[s]&&(this.thinInstanceAllowAutomaticStaticBufferRecreation&&!this._userThinInstanceBuffersStorage.vertexBuffers[s].isUpdatable()&&this._thinInstanceRecreateBuffer(s),this._userThinInstanceBuffersStorage.vertexBuffers[s].updateDirectly(this._userThinInstanceBuffersStorage.data[s],0)))};Oe.prototype.thinInstancePartialBufferUpdate=function(s,e,t){var i;s==="matrix"?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(e,t):(s===M.ColorKind&&(s=M.ColorInstanceKind),(i=this._userThinInstanceBuffersStorage)!=null&&i.vertexBuffers[s]&&this._userThinInstanceBuffersStorage.vertexBuffers[s].updateDirectly(e,t))};Oe.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return[];const s=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=[];for(let e=0;e<this._thinInstanceDataStorage.instancesCount;++e)this._thinInstanceDataStorage.worldMatrices[e]=z.FromArray(s,e*16)}return this._thinInstanceDataStorage.worldMatrices};Oe.prototype.thinInstanceRefreshBoundingInfo=function(s=!1,e=!1,t=!1){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return;const i=this._thinInstanceDataStorage.boundingVectors;if(s||!this.rawBoundingInfo){i.length=0,this.refreshBoundingInfo(e,t);const a=this.getBoundingInfo();this.rawBoundingInfo=new DD(a.minimum,a.maximum)}const r=this.getBoundingInfo(),n=this._thinInstanceDataStorage.matrixData;if(i.length===0)for(let a=0;a<r.boundingBox.vectors.length;++a)i.push(r.boundingBox.vectors[a].clone());G.Vector3[0].setAll(Number.POSITIVE_INFINITY),G.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(let a=0;a<this._thinInstanceDataStorage.instancesCount;++a){z.FromArrayToRef(n,a*16,G.Matrix[0]);for(let o=0;o<i.length;++o)x.TransformCoordinatesToRef(i[o],G.Matrix[0],G.Vector3[2]),G.Vector3[0].minimizeInPlace(G.Vector3[2]),G.Vector3[1].maximizeInPlace(G.Vector3[2])}r.reConstruct(G.Vector3[0],G.Vector3[1]),this._updateBoundingInfo()};Oe.prototype._thinInstanceRecreateBuffer=function(s,e=!0){var t,i,r;s==="matrix"?((t=this._thinInstanceDataStorage.matrixBuffer)==null||t.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",this._thinInstanceDataStorage.matrixData,e)):s==="previousMatrix"?this._scene.needsPreviousWorldMatrices&&((i=this._thinInstanceDataStorage.previousMatrixBuffer)==null||i.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.previousMatrixData??this._thinInstanceDataStorage.matrixData,e)):(s===M.ColorKind&&(s=M.ColorInstanceKind),(r=this._userThinInstanceBuffersStorage.vertexBuffers[s])==null||r.dispose(),this._userThinInstanceBuffersStorage.vertexBuffers[s]=new M(this.getEngine(),this._userThinInstanceBuffersStorage.data[s],s,!e,!1,this._userThinInstanceBuffersStorage.strides[s],!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[s]))};Oe.prototype._thinInstanceUpdateBufferSize=function(s,e=1){var l,c,u;s===M.ColorKind&&(s=M.ColorInstanceKind);const t=s==="matrix";if(!t&&(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.strides[s]))return;const i=t?16:this._userThinInstanceBuffersStorage.strides[s],r=t?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[s];let n=t?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[s];const a=(this._thinInstanceDataStorage.instancesCount+e)*i;let o=r;for(;o<a;)o*=2;if(!n||r!=o){if(!n)n=new Float32Array(o);else{const h=new Float32Array(o);h.set(n,0),n=h}t?((l=this._thinInstanceDataStorage.matrixBuffer)==null||l.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",n,!1),this._thinInstanceDataStorage.matrixData=n,this._thinInstanceDataStorage.matrixBufferSize=o,this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&((c=this._thinInstanceDataStorage.previousMatrixBuffer)==null||c.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",n,!1))):((u=this._userThinInstanceBuffersStorage.vertexBuffers[s])==null||u.dispose(),this._userThinInstanceBuffersStorage.data[s]=n,this._userThinInstanceBuffersStorage.sizes[s]=o,this._userThinInstanceBuffersStorage.vertexBuffers[s]=new M(this.getEngine(),n,s,!0,!1,i,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[s]))}};Oe.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}})};Oe.prototype._disposeThinInstanceSpecificData=function(){var s,e;(s=this._thinInstanceDataStorage)!=null&&s.matrixBuffer&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null),(e=this._thinInstanceDataStorage)!=null&&e.previousMatrixBuffer&&(this._thinInstanceDataStorage.previousMatrixBuffer.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null)};fi.AddNodeConstructor("Light_Type_5",(s,e)=>()=>new Kr(s,[],e));const ix=16;class Kr extends Xs{static _GetEngineBatchSize(e){const t=e._caps;return t.texelFetch?e.isWebGPU?32:e.version>1?!t.colorBufferFloat||!t.blendFloat?0:t.shaderFloatPrecision:0:0}static IsLightSupported(e){return Kr._GetEngineBatchSize(e.getEngine())===0||e.shadowEnabled&&e._scene.shadowsEnabled&&e.getShadowGenerators()||e.falloffType!==Xs.FALLOFF_DEFAULT?!1:e.getTypeID()===ro.LIGHTTYPEID_POINTLIGHT?!0:e.getTypeID()===ro.LIGHTTYPEID_SPOTLIGHT?!e.projectionTexture&&!e.iesProfileTexture:!1}get isSupported(){return this._batchSize>0}get lights(){return this._lights}get horizontalTiles(){return this._horizontalTiles}set horizontalTiles(e){this._horizontalTiles!==e&&(this._horizontalTiles=e,this._tileMaskBatches=-1)}get verticalTiles(){return this._verticalTiles}set verticalTiles(e){this._verticalTiles!==e&&(this._verticalTiles=e,this._tileMaskBatches=-1)}get depthSlices(){return this._depthSlices}set depthSlices(e){this._depthSlices!==e&&(this._depthSlices=e,this._sliceRanges=new Float32Array(e*2),this._uniformBuffer.dispose(),this._uniformBuffer=new hn(this.getEngine(),void 0,void 0,this.name),this._buildUniformLayout())}get maxRange(){return this._maxRange}set maxRange(e){this._maxRange!==e&&(this._maxRange=e,this._minInverseSquaredRange=1/(e*e))}constructor(e,t=[],i){super(e,i),this._lights=[],this._camera=null,this._sortedLights=[],this._lightDataRenderId=-1,this._tileMaskBatches=-1,this._horizontalTiles=64,this._verticalTiles=64,this._sliceScale=0,this._sliceBias=0,this._depthSlices=ix,this._maxRange=16383,this._minInverseSquaredRange=1/(this._maxRange*this._maxRange);const r=this.getEngine();this._batchSize=Kr._GetEngineBatchSize(r);const n={vertex:"lightProxy",fragment:"lightProxy"};if(this._proxyMaterial=new Ta("ProxyMaterial",this._scene,n,{attributes:["position"],uniforms:["view","projection","tileMaskResolution"],samplers:["lightDataTexture"],uniformBuffers:["Scene"],storageBuffers:["tileMaskBuffer"],defines:[`CLUSTLIGHT_BATCH ${this._batchSize}`],shaderLanguage:r.isWebGPU?1:0,extraInitializationsAsync:async()=>{r.isWebGPU?await Promise.all([U(()=>Promise.resolve().then(()=>N3),void 0),U(()=>Promise.resolve().then(()=>P3),void 0)]):await Promise.all([U(()=>Promise.resolve().then(()=>R3),void 0),U(()=>Promise.resolve().then(()=>y3),void 0)])}}),this._proxyMaterial.transparencyMode=Ta.MATERIAL_ALPHABLEND,this._proxyMaterial.alphaMode=1,this._proxyMesh=Ym("ProxyMesh",{size:2}),this._scene.removeMesh(this._proxyMesh),this._proxyMesh.material=this._proxyMaterial,this._updateBatches(),this._sliceRanges=new Float32Array(this._depthSlices*2),this._batchSize>0){Kr._SceneComponentInitialization(this._scene);for(const a of t)this.addLight(a)}}getClassName(){return"ClusteredLightContainer"}getTypeID(){return ro.LIGHTTYPEID_CLUSTERED_CONTAINER}_updateBatches(e=null){var o,l,c;this._camera=e,this._proxyMesh.isVisible=this._sortedLights.length>0;const t=Math.max(Math.ceil(this._sortedLights.length/this._batchSize),1);if(this._tileMaskBatches>=t)return this._proxyMesh.thinInstanceCount=this._sortedLights.length,this._tileMaskTexture;const i=this.getEngine(),r=t*this._batchSize;this._lightDataBuffer=new Float32Array(20*r),(o=this._lightDataTexture)==null||o.dispose(),this._lightDataTexture=new gi(this._lightDataBuffer,5,r,5,this._scene,!1,!1,1,1),this._lightDataTexture.name="LightDataTexture_clustered_"+this.name,this._proxyMaterial.setTexture("lightDataTexture",this._lightDataTexture),(l=this._tileMaskTexture)==null||l.dispose();const n={width:this._horizontalTiles,height:this._verticalTiles};i.isWebGPU||(n.height*=t),this._tileMaskTexture=new Zi("TileMaskTexture",n,this._scene,{type:i.isWebGPU?0:1,format:6,generateDepthBuffer:!1}),this._tileMaskTexture.renderParticles=!1,this._tileMaskTexture.renderSprites=!1,this._tileMaskTexture.noPrePassRenderer=!0,this._tileMaskTexture.renderList=[this._proxyMesh];let a=null;if(this._tileMaskTexture.onBeforeBindObservable.add(()=>{a=i._currentRenderTarget,this._updateLightData()}),this._tileMaskTexture.onAfterUnbindObservable.add(()=>{i._currentRenderTarget!==a&&(a?i.bindFramebuffer(a):i.restoreDefaultFramebuffer())}),this._tileMaskTexture.onClearObservable.add(()=>{var u;i.isWebGPU?(u=this._tileMaskBuffer)==null||u.clear():i.clear({r:0,g:0,b:0,a:1},!0,!1)}),i.isWebGPU){(c=this._tileMaskBuffer)==null||c.dispose();const u=this._horizontalTiles*this._verticalTiles*t*4;this._tileMaskBuffer=new ZI(i,u),this._proxyMaterial.setStorageBuffer("tileMaskBuffer",this._tileMaskBuffer)}return this._proxyMaterial.setVector3("tileMaskResolution",new x(this._horizontalTiles,this.verticalTiles,t)),this._proxyMesh.thinInstanceSetBuffer("matrix",new Float32Array(r*16)),this._proxyMesh.thinInstanceCount=this._sortedLights.length,this._tileMaskBatches=t,this._tileMaskTexture}_getSliceIndex(e,t){return t<e.minZ?-1:Math.floor(Math.log(t)*this._sliceScale+this._sliceBias)}_updateLightData(){const e=this._camera||this._scene.activeCamera,t=this._scene.getRenderId();if(!e||this._lightDataRenderId===t)return;this._lightDataRenderId=t;const i=e.getViewMatrix();for(const l of this._sortedLights){const c=l.computeTransformedInformation()?l.transformedPosition:l.position,u=x.TransformCoordinatesToRef(c,i,G.Vector3[0]);l._currentViewDepth=u.z}this._sortedLights.sort((l,c)=>l._currentViewDepth-c._currentViewDepth);const r=Math.log(e.maxZ/e.minZ);this._sliceScale=this._depthSlices/r,this._sliceBias=-(this._depthSlices*Math.log(e.minZ))/r,this._sliceRanges.fill(0);let n=-1;const a=this._lightDataBuffer;for(let l=0;l<this._sortedLights.length;l+=1){const c=this._sortedLights[l],u=l*20,h=c.computeTransformedInformation(),d=c.getScaledIntensity(),f=h?c.transformedPosition:c.position,m=c.diffuse.scaleToRef(d,st.Color3[0]),g=c.specular.scaleToRef(d,st.Color3[1]),v=Math.min(c.range,this.maxRange),E=Math.max(c._inverseSquaredRange,this._minInverseSquaredRange);if(a[u+0]=f.x-this._scene.floatingOriginOffset.x,a[u+1]=f.y-this._scene.floatingOriginOffset.y,a[u+2]=f.z-this._scene.floatingOriginOffset.z,a[u+3]=0,a[u+4]=m.r,a[u+5]=m.g,a[u+6]=m.b,a[u+7]=v,a[u+8]=g.r,a[u+9]=g.g,a[u+10]=g.b,a[u+11]=c.radius,a[u+12]=0,a[u+13]=0,a[u+14]=0,a[u+15]=-1,a[u+16]=v,a[u+17]=E,a[u+18]=0,a[u+19]=0,c.getTypeID()===ro.LIGHTTYPEID_SPOTLIGHT){const A=c,I=x.NormalizeToRef(h?A.transformedDirection:A.direction,G.Vector3[0]);a[u+3]=A.exponent,a[u+12]=I.x,a[u+13]=I.y,a[u+14]=I.z,a[u+15]=A._cosHalfAngle,a[u+18]=A._lightAngleScale,a[u+19]=A._lightAngleOffset}const T=this._getSliceIndex(e,c._currentViewDepth-v),C=this._getSliceIndex(e,c._currentViewDepth+v);for(let A=T;A<=C;A+=1)A<0||A>=this._depthSlices||(A>n&&(this._sliceRanges[A*2]=l,n=A),this._sliceRanges[A*2+1]=l)}const o=this.getEngine();o.isWebGPU&&o.flushFramebuffer(),this._lightDataTexture.update(this._lightDataBuffer)}dispose(e,t){var i;for(const r of this._lights)r.dispose(e,t);this._lightDataTexture.dispose(),this._tileMaskTexture.dispose(),(i=this._tileMaskBuffer)==null||i.dispose(),this._proxyMesh.dispose(e,t),super.dispose(e,t)}addLight(e){if(!Kr.IsLightSupported(e)){N.Warn("Attempting to add a light to cluster that does not support clustering");return}this._scene.removeLight(e),this._lights.push(e),this._sortedLights.push(e),this._proxyMesh.isVisible=!0,this._proxyMesh.thinInstanceCount=this._sortedLights.length}removeLight(e){const t=this._sortedLights,i=t.indexOf(e);i!==-1&&(t.splice(i,1),this._proxyMesh.thinInstanceCount=t.length,t.length===0&&(this._proxyMesh.isVisible=!1));const r=this._lights.indexOf(e);return r!==-1&&(this._lights.splice(r,1),this._scene.addLight(e)),r}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vSliceData",2),this._uniformBuffer.addUniform("vSliceRanges",2,this._depthSlices??ix),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){const i=this.getEngine(),r=this._horizontalTiles/i.getRenderWidth(),n=this._verticalTiles/i.getRenderHeight();return this._uniformBuffer.updateFloat4("vLightData",r,n,this._verticalTiles,this._tileMaskBatches,t),this._uniformBuffer.updateFloat2("vSliceData",this._sliceScale,this._sliceBias,t),this._uniformBuffer.updateFloatArray("vSliceRanges",this._sliceRanges,t),this}transferTexturesToEffect(e,t){const i=this.getEngine();return e.setTexture("lightDataTexture"+t,this._lightDataTexture),i.isWebGPU?i.setStorageBuffer("tileMaskBuffer"+t,this._tileMaskBuffer):e.setTexture("tileMaskTexture"+t,this._tileMaskTexture),this}transferToNodeMaterialEffect(e){return this}prepareLightSpecificDefines(e,t){e["CLUSTLIGHT"+t]=!0,e.CLUSTLIGHT_BATCH=this._batchSize,e.CLUSTLIGHT_SLICES=this._depthSlices}_isReady(){return this._updateBatches(),this._proxyMesh.isReady(!0,!0)}}Kr._SceneComponentInitialization=()=>{throw Ys("ClusteredLightingSceneComponent")};_([R()],Kr.prototype,"horizontalTiles",null);_([R()],Kr.prototype,"verticalTiles",null);_([R()],Kr.prototype,"maxRange",null);y("BABYLON.ClusteredLightContainer",Kr);class b3{constructor(e){this.name=se.NAME_CLUSTEREDLIGHTING,this._gatherActiveCameraRenderTargets=t=>{for(const i of this.scene.lights)i.getTypeID()===ro.LIGHTTYPEID_CLUSTERED_CONTAINER&&i.isSupported&&t.push(i._updateBatches())},this.scene=e}dispose(){}rebuild(){}register(){this.scene._gatherActiveCameraRenderTargetsStage.registerStep(se.STEP_GATHERACTIVECAMERARENDERTARGETS_CLUSTEREDLIGHTING,this,this._gatherActiveCameraRenderTargets)}}Kr._SceneComponentInitialization=s=>{s._getComponent(se.NAME_CLUSTEREDLIGHTING)||s._addComponent(new b3(s))};const Vd="lightProxyPixelShader",uA=`flat varying vec2 vLimits;flat varying highp uint vMask;void main(void) {if (gl_FragCoord.y<vLimits.x || gl_FragCoord.y>vLimits.y) {discard;}
gl_FragColor=vec4(vMask,0,0,1);}
`;S.ShadersStore[Vd]||(S.ShadersStore[Vd]=uA);const C3={name:Vd,shader:uA},y3=Object.freeze(Object.defineProperty({__proto__:null,lightProxyPixelShader:C3},Symbol.toStringTag,{value:"Module"})),Ud="lightProxyVertexShader",hA=`attribute vec3 position;flat varying vec2 vLimits;flat varying highp uint vMask;
#include<__decl__sceneVertex>
uniform sampler2D lightDataTexture;uniform vec3 tileMaskResolution;
#include<clusteredLightingFunctions>
void main(void) {ClusteredLight light=getClusteredLight(lightDataTexture,gl_InstanceID);float range=light.vLightFalloff.x;vec4 viewPosition=view*vec4(light.vLightData.xyz,1);vec4 viewPositionSq=viewPosition*viewPosition;vec2 distSq=viewPositionSq.xy+viewPositionSq.z;vec2 sinSq=(range*range)/distSq;vec2 cosSq=max(1.0-sinSq,0.01);vec2 sinCos=position.xy*sqrt(sinSq*cosSq);vec2 rotatedX=mat2(cosSq.x,-sinCos.x,sinCos.x,cosSq.x)*viewPosition.xz;vec2 rotatedY=mat2(cosSq.y,-sinCos.y,sinCos.y,cosSq.y)*viewPosition.yz;vec4 projX=projection*vec4(rotatedX.x,0,rotatedX.y,1);vec4 projY=projection*vec4(0,rotatedY.x,rotatedY.y,1);vec2 projPosition=vec2(projX.x/max(projX.w,0.01),projY.y/max(projY.w,0.01));projPosition=mix(position.xy,projPosition,greaterThan(cosSq,vec2(0.01)));vec2 halfTileRes=tileMaskResolution.xy/2.0;vec2 tilePosition=(projPosition+1.0)*halfTileRes;tilePosition=mix(floor(tilePosition)-0.01,ceil(tilePosition)+0.01,greaterThan(position.xy,vec2(0)));float offset=float(gl_InstanceID/CLUSTLIGHT_BATCH)*tileMaskResolution.y;tilePosition.y=(tilePosition.y+offset)/tileMaskResolution.z;gl_Position=vec4(tilePosition/halfTileRes-1.0,0,1);vLimits=vec2(offset,offset+tileMaskResolution.y);vMask=1u<<(gl_InstanceID % CLUSTLIGHT_BATCH);}
`;S.ShadersStore[Ud]||(S.ShadersStore[Ud]=hA);const I3={name:Ud,shader:hA},R3=Object.freeze(Object.defineProperty({__proto__:null,lightProxyVertexShader:I3},Symbol.toStringTag,{value:"Module"})),kd="lightProxyPixelShader",dA=`flat varying vOffset: u32;flat varying vMask: u32;uniform tileMaskResolution: vec3f;var<storage,read_write> tileMaskBuffer: array<atomic<u32>>;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {let maskResolution=vec2u(uniforms.tileMaskResolution.yz);let tilePosition=vec2u(fragmentInputs.position.xy);let tileIndex=(tilePosition.x*maskResolution.x+tilePosition.y)*maskResolution.y+fragmentInputs.vOffset;atomicOr(&tileMaskBuffer[tileIndex],fragmentInputs.vMask);}
`;S.ShadersStoreWGSL[kd]||(S.ShadersStoreWGSL[kd]=dA);const A3={name:kd,shader:dA},P3=Object.freeze(Object.defineProperty({__proto__:null,lightProxyPixelShaderWGSL:A3},Symbol.toStringTag,{value:"Module"})),Gd="lightProxyVertexShader",fA=`attribute position: vec3f;flat varying vOffset: u32;flat varying vMask: u32;
#include<sceneUboDeclaration>
var lightDataTexture: texture_2d<f32>;uniform tileMaskResolution: vec3f;uniform halfTileRes: vec2f;
#include<clusteredLightingFunctions>
@vertex
fn main(input: VertexInputs)->FragmentInputs {let light=getClusteredLight(lightDataTexture,vertexInputs.instanceIndex);let range=light.vLightFalloff.x;let viewPosition=scene.view*vec4f(light.vLightData.xyz,1);let viewPositionSq=viewPosition*viewPosition;let distSq=viewPositionSq.xy+viewPositionSq.z;let sinSq=(range*range)/distSq;let cosSq=max(1.0-sinSq,vec2f(0.01));let sinCos=vertexInputs.position.xy*sqrt(sinSq*cosSq);let rotatedX=mat2x2f(cosSq.x,-sinCos.x,sinCos.x,cosSq.x)*viewPosition.xz;let rotatedY=mat2x2f(cosSq.y,-sinCos.y,sinCos.y,cosSq.y)*viewPosition.yz;let projX=scene.projection*vec4f(rotatedX.x,0,rotatedX.y,1);let projY=scene.projection*vec4f(0,rotatedY.x,rotatedY.y,1);var projPosition=vec2f(projX.x/max(projX.w,0.01),projY.y/max(projY.w,0.01));projPosition=select(vertexInputs.position.xy,projPosition,cosSq>vec2(0.01));let halfTileRes=uniforms.tileMaskResolution.xy/2.0;var tilePosition=(projPosition+1.0)*halfTileRes;tilePosition=select(floor(tilePosition)-0.01,ceil(tilePosition)+0.01,vertexInputs.position.xy>vec2f(0));vertexOutputs.position=vec4f(tilePosition/halfTileRes-1.0,0,1);vertexOutputs.vOffset=vertexInputs.instanceIndex/CLUSTLIGHT_BATCH;vertexOutputs.vMask=1u<<(vertexInputs.instanceIndex % CLUSTLIGHT_BATCH);}
`;S.ShadersStoreWGSL[Gd]||(S.ShadersStoreWGSL[Gd]=fA);const O3={name:Gd,shader:fA},N3=Object.freeze(Object.defineProperty({__proto__:null,lightProxyVertexShaderWGSL:O3},Symbol.toStringTag,{value:"Module"}));class Fn{constructor(e,t="",i="black"){this._renderingCanvas=e,this._loadingText=t,this._loadingDivBackgroundColor=i,this._loadingDivToRenderingCanvasMap=new Map,this._resizeLoadingUI=()=>{this._isLoading&&this._loadingDivToRenderingCanvasMap.forEach(([r,n],a)=>{const o=r.getBoundingClientRect();if(this._isCanvasLayoutChanged(n,o)){const l=window.getComputedStyle(r).position;a.style.position=l==="fixed"?"fixed":"absolute",a.style.left=o.left+window.scrollX+"px",a.style.top=o.top+window.scrollY+"px",a.style.width=o.width+"px",a.style.height=o.height+"px",this._loadingDivToRenderingCanvasMap.set(a,[r,o])}})}}displayLoadingUI(){if(this._isLoading)return;this._isLoading=!0,this._engine=De.Instances.find(c=>c.getRenderingCanvas()===this._renderingCanvas);const e=document.createElement("div");e.id="babylonjsLoadingDiv",e.style.opacity="0",e.style.transition="opacity 1.5s ease",e.style.pointerEvents="none",e.style.display="grid",e.style.gridTemplateRows="100%",e.style.gridTemplateColumns="100%",e.style.justifyItems="center",e.style.alignItems="center",this._loadingTextDiv=document.createElement("div"),this._loadingTextDiv.style.position="absolute",this._loadingTextDiv.style.left="0",this._loadingTextDiv.style.top="50%",this._loadingTextDiv.style.marginTop="80px",this._loadingTextDiv.style.width="100%",this._loadingTextDiv.style.height="20px",this._loadingTextDiv.style.fontFamily="Arial",this._loadingTextDiv.style.fontSize="14px",this._loadingTextDiv.style.color="white",this._loadingTextDiv.style.textAlign="center",this._loadingTextDiv.style.zIndex="1",this._loadingTextDiv.innerHTML="Loading",e.appendChild(this._loadingTextDiv),this._loadingTextDiv.innerHTML=this._loadingText,this._style=document.createElement("style");const t=`@-webkit-keyframes spin1 {                            0% { -webkit-transform: rotate(0deg);}
                            100% { -webkit-transform: rotate(360deg);}
                        }                        @keyframes spin1 {                            0% { transform: rotate(0deg);}
                            100% { transform: rotate(360deg);}
                        }`;this._style.innerHTML=t,document.getElementsByTagName("head")[0].appendChild(this._style);const i=!!window.SVGSVGElement,r=new Image;Fn.DefaultLogoUrl?r.src=Fn.DefaultLogoUrl:r.src=i?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAuMTcgMjA4LjA0Ij48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2ZmZjt9LmNscy0ye2ZpbGw6I2UwNjg0Yjt9LmNscy0ze2ZpbGw6I2JiNDY0Yjt9LmNscy00e2ZpbGw6I2UwZGVkODt9LmNscy01e2ZpbGw6I2Q1ZDJjYTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPkJhYnlsb25Mb2dvPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iUGFnZV9FbGVtZW50cyIgZGF0YS1uYW1lPSJQYWdlIEVsZW1lbnRzIj48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik05MC4wOSwwLDAsNTJWMTU2bDkwLjA5LDUyLDkwLjA4LTUyVjUyWiIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtMiIgcG9pbnRzPSIxODAuMTcgNTIuMDEgMTUxLjk3IDM1LjczIDEyNC44NSA1MS4zOSAxNTMuMDUgNjcuNjcgMTgwLjE3IDUyLjAxIi8+PHBvbHlnb24gY2xhc3M9ImNscy0yIiBwb2ludHM9IjI3LjEyIDY3LjY3IDExNy4yMSAxNS42NiA5MC4wOCAwIDAgNTIuMDEgMjcuMTIgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTIiIHBvaW50cz0iNjEuODkgMTIwLjMgOTAuMDggMTM2LjU4IDExOC4yOCAxMjAuMyA5MC4wOCAxMDQuMDIgNjEuODkgMTIwLjMiLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDE1My4wNSAxNDAuMzcgOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyAwIDUyLjAxIDAgMTU2LjAzIDkwLjA4IDIwOC4wNCAxODAuMTcgMTU2LjAzIDE4MC4xNyA1Mi4wMSAxNTMuMDUgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iOTAuMDggNzEuNDYgNjEuODkgODcuNzQgNjEuODkgMTIwLjMgOTAuMDggMTA0LjAyIDExOC4yOCAxMjAuMyAxMTguMjggODcuNzQgOTAuMDggNzEuNDYiLz48cG9seWdvbiBjbGFzcz0iY2xzLTQiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDExOC4yOCA4Ny43NCAxMTguMjggMTIwLjMgOTAuMDggMTM2LjU4IDkwLjA4IDE3Ni43MiAxNTMuMDUgMTQwLjM3IDE1My4wNSA2Ny42NyIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtNSIgcG9pbnRzPSIyNy4xMiA2Ny42NyA2MS44OSA4Ny43NCA2MS44OSAxMjAuMyA5MC4wOCAxMzYuNTggOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyIvPjwvZz48L2c+PC9zdmc+":"https://cdn.babylonjs.com/Assets/babylonLogo.png",r.style.width="150px",r.style.gridColumn="1",r.style.gridRow="1",r.style.top="50%",r.style.left="50%",r.style.transform="translate(-50%, -50%)",r.style.position="absolute";const n=document.createElement("div");n.style.width="300px",n.style.gridColumn="1",n.style.gridRow="1",n.style.top="50%",n.style.left="50%",n.style.transform="translate(-50%, -50%)",n.style.position="absolute";const a=new Image;if(Fn.DefaultSpinnerUrl?a.src=Fn.DefaultSpinnerUrl:a.src=i?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzOTIgMzkyIj48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2UwNjg0Yjt9LmNscy0ye2ZpbGw6bm9uZTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPlNwaW5uZXJJY29uPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iU3Bpbm5lciI+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNNDAuMjEsMTI2LjQzYzMuNy03LjMxLDcuNjctMTQuNDQsMTItMjEuMzJsMy4zNi01LjEsMy41Mi01YzEuMjMtMS42MywyLjQxLTMuMjksMy42NS00LjkxczIuNTMtMy4yMSwzLjgyLTQuNzlBMTg1LjIsMTg1LjIsMCwwLDEsODMuNCw2Ny40M2EyMDgsMjA4LDAsMCwxLDE5LTE1LjY2YzMuMzUtMi40MSw2Ljc0LTQuNzgsMTAuMjUtN3M3LjExLTQuMjgsMTAuNzUtNi4zMmM3LjI5LTQsMTQuNzMtOCwyMi41My0xMS40OSwzLjktMS43Miw3Ljg4LTMuMywxMi00LjY0YTEwNC4yMiwxMDQuMjIsMCwwLDEsMTIuNDQtMy4yMyw2Mi40NCw2Mi40NCwwLDAsMSwxMi43OC0xLjM5QTI1LjkyLDI1LjkyLDAsMCwxLDE5NiwyMS40NGE2LjU1LDYuNTUsMCwwLDEsMi4wNSw5LDYuNjYsNi42NiwwLDAsMS0xLjY0LDEuNzhsLS40MS4yOWEyMi4wNywyMi4wNywwLDAsMS01Ljc4LDMsMzAuNDIsMzAuNDIsMCwwLDEtNS42NywxLjYyLDM3LjgyLDM3LjgyLDAsMCwxLTUuNjkuNzFjLTEsMC0xLjkuMTgtMi44NS4yNmwtMi44NS4yNHEtNS43Mi41MS0xMS40OCwxLjFjLTMuODQuNC03LjcxLjgyLTExLjU4LDEuNGExMTIuMzQsMTEyLjM0LDAsMCwwLTIyLjk0LDUuNjFjLTMuNzIsMS4zNS03LjM0LDMtMTAuOTQsNC42NHMtNy4xNCwzLjUxLTEwLjYsNS41MUExNTEuNiwxNTEuNiwwLDAsMCw2OC41Niw4N0M2Ny4yMyw4OC40OCw2Niw5MCw2NC42NCw5MS41NnMtMi41MSwzLjE1LTMuNzUsNC43M2wtMy41NCw0LjljLTEuMTMsMS42Ni0yLjIzLDMuMzUtMy4zMyw1YTEyNywxMjcsMCwwLDAtMTAuOTMsMjEuNDksMS41OCwxLjU4LDAsMSwxLTMtMS4xNVM0MC4xOSwxMjYuNDcsNDAuMjEsMTI2LjQzWiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgd2lkdGg9IjM5MiIgaGVpZ2h0PSIzOTIiLz48L2c+PC9nPjwvc3ZnPg==":"https://cdn.babylonjs.com/Assets/loadingIcon.png",a.style.animation="spin1 0.75s infinite linear",a.style.transformOrigin="50% 50%",!i){const c={w:16,h:18.5},u={w:30,h:30};r.style.width=`${c.w}vh`,r.style.height=`${c.h}vh`,r.style.left=`calc(50% - ${c.w/2}vh)`,r.style.top=`calc(50% - ${c.h/2}vh)`,a.style.width=`${u.w}vh`,a.style.height=`${u.h}vh`,a.style.left=`calc(50% - ${u.w/2}vh)`,a.style.top=`calc(50% - ${u.h/2}vh)`}n.appendChild(a),e.appendChild(r),e.appendChild(n),e.style.backgroundColor=this._loadingDivBackgroundColor,e.style.opacity="1";const o=[],l=this._engine.views;if(l!=null&&l.length)for(const c of l)c.enabled&&o.push(c.target);else o.push(this._renderingCanvas);for(let c=0;c<o.length;c++){const u=o[c],h=e.cloneNode(!0);h.id+=`-${c}`,this._loadingDivToRenderingCanvasMap.set(h,[u,null])}this._resizeLoadingUI(),this._resizeObserver=this._engine.onResizeObservable.add(()=>{this._resizeLoadingUI()}),this._loadingDivToRenderingCanvasMap.forEach((c,u)=>{document.body.appendChild(u)})}hideLoadingUI(){if(!this._isLoading)return;let e=0;const t=i=>{const r=i.target;this._loadingDivToRenderingCanvasMap.has(r)&&(e++,r.remove(),e===this._loadingDivToRenderingCanvasMap.size&&(this._loadingTextDiv&&(this._loadingTextDiv.remove(),this._loadingTextDiv=null),this._style&&(this._style.remove(),this._style=null),window.removeEventListener("transitionend",t),this._engine.onResizeObservable.remove(this._resizeObserver),this._loadingDivToRenderingCanvasMap.clear(),this._engine=null,this._isLoading=!1))};this._loadingDivToRenderingCanvasMap.forEach((i,r)=>{r.style.opacity="0"}),window.addEventListener("transitionend",t)}set loadingUIText(e){this._loadingText=e,this._loadingTextDiv&&this._loadingDivToRenderingCanvasMap.forEach((t,i)=>{i.children[0].innerHTML=this._loadingText})}get loadingUIText(){return this._loadingText}get loadingUIBackgroundColor(){return this._loadingDivBackgroundColor}set loadingUIBackgroundColor(e){this._loadingDivBackgroundColor=e,this._isLoading&&this._loadingDivToRenderingCanvasMap.forEach((t,i)=>{i.style.backgroundColor=this._loadingDivBackgroundColor})}_isCanvasLayoutChanged(e,t){return!e||e.left!==t.left||e.top!==t.top||e.right!==t.right||e.bottom!==t.bottom||e.width!==t.width||e.height!==t.height||e.x!==t.x||e.y!==t.y}}Fn.DefaultLogoUrl="";Fn.DefaultSpinnerUrl="";te.DefaultLoadingScreenFactory=s=>new Fn(s);class pA{constructor(e,t={}){this._lodGenerationOffset=0,this._lodGenerationScale=.8,this.quality=4096,this.hdrScale=1,this._engine=e,this.hdrScale=t.hdrScale||this.hdrScale,this.quality=t.quality||this.quality}_createRenderTarget(e){let t=0;this._engine.getCaps().textureHalfFloatRender?t=2:this._engine.getCaps().textureFloatRender&&(t=1);const i=this._engine.createRenderTargetCubeTexture(e,{format:5,type:t,createMipMaps:!0,generateMipMaps:!1,generateDepthBuffer:!1,generateStencilBuffer:!1,samplingMode:1,label:"HDR_Radiance_Filtering_Target"});return this._engine.updateTextureWrappingMode(i.texture,0,0,0),this._engine.updateTextureSamplingMode(3,i.texture,!0),i}_prefilterInternal(e){const t=e.getSize().width,i=Ol(t)+1,r=this._effectWrapper.effect,n=this._createRenderTarget(t);this._effectRenderer.saveStates(),this._effectRenderer.setViewport();const a=e.getInternalTexture();a&&this._engine.updateTextureSamplingMode(3,a,!0),this._effectRenderer.applyEffectWrapper(this._effectWrapper);const o=[[new x(0,0,-1),new x(0,-1,0),new x(1,0,0)],[new x(0,0,1),new x(0,-1,0),new x(-1,0,0)],[new x(1,0,0),new x(0,0,1),new x(0,1,0)],[new x(1,0,0),new x(0,0,-1),new x(0,-1,0)],[new x(1,0,0),new x(0,-1,0),new x(0,0,1)],[new x(-1,0,0),new x(0,-1,0),new x(0,0,-1)]];r.setFloat("hdrScale",this.hdrScale),r.setFloat2("vFilteringInfo",e.getSize().width,i),r.setTexture("inputTexture",e);for(let u=0;u<6;u++){r.setVector3("up",o[u][0]),r.setVector3("right",o[u][1]),r.setVector3("front",o[u][2]);for(let h=0;h<i;h++){this._engine.bindFramebuffer(n,u,void 0,void 0,!0,h),this._effectRenderer.applyEffectWrapper(this._effectWrapper);let d=Math.pow(2,(h-this._lodGenerationOffset)/this._lodGenerationScale)/t;h===0&&(d=0),r.setFloat("alphaG",d),this._effectRenderer.draw()}}this._effectRenderer.restoreStates(),this._engine.restoreDefaultFramebuffer(),this._engine._releaseTexture(e._texture);const l=n.texture.type,c=n.texture.format;return n._swapAndDie(e._texture),e._texture.type=l,e._texture.format=c,e.gammaSpace=!1,e.lodGenerationOffset=this._lodGenerationOffset,e.lodGenerationScale=this._lodGenerationScale,e._prefiltered=!0,e}_createEffect(e,t){const i=[];e.gammaSpace&&i.push("#define GAMMA_INPUT"),i.push("#define NUM_SAMPLES "+this.quality+"u");const r=this._engine.isWebGPU;return new gt({engine:this._engine,name:"hdrFiltering",vertexShader:"hdrFiltering",fragmentShader:"hdrFiltering",samplerNames:["inputTexture"],uniformNames:["vSampleDirections","vWeights","up","right","front","vFilteringInfo","hdrScale","alphaG"],useShaderStore:!0,defines:i,onCompiled:t,shaderLanguage:r?1:0,extraInitializationsAsync:async()=>{r?await Promise.all([U(()=>Promise.resolve().then(()=>AG),void 0),U(()=>Promise.resolve().then(()=>OG),void 0)]):await Promise.all([U(()=>Promise.resolve().then(()=>CG),void 0),U(()=>Promise.resolve().then(()=>IG),void 0)])}})}isReady(e){return e.isReady()&&this._effectWrapper.effect.isReady()}async prefilter(e){if(!this._engine._features.allowTexturePrefiltering)throw new Error("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead.");this._effectRenderer=new go(this._engine),this._effectWrapper=this._createEffect(e),await this._effectWrapper.effect.whenCompiledAsync(),this._prefilterInternal(e),this._effectRenderer.dispose(),this._effectWrapper.dispose()}}class Aa{get isSupported(){const e=De.LastCreatedEngine;return e?e.getCaps().texelFetch:!1}get iblSource(){return this._iblSource}set iblSource(e){this._iblSource!==e&&(this._disposeTextures(),this._iblSource=e,e&&(e.isCube?e.isReadyOrNotBlocking()?this._recreateAssetsFromNewIbl():e.onLoadObservable.addOnce(this._recreateAssetsFromNewIbl.bind(this,e)):e.isReadyOrNotBlocking()?this._recreateAssetsFromNewIbl():e.onLoadObservable.addOnce(this._recreateAssetsFromNewIbl.bind(this,e))))}_recreateAssetsFromNewIbl(){this._debugPass&&this._debugPass.dispose(),this._createTextures(),this._debugPass&&this._createDebugPass()}getIcdfTexture(){return this._icdfPT?this._icdfPT:this._dummyTexture}setDebugDisplayParams(e,t,i,r){this._debugSizeParams.set(e,t,i,r)}get debugPassName(){return this._debugPassName}getDebugPassPP(){return this._debugPass||this._createDebugPass(),this._debugPass}constructor(e){if(this._cachedDominantDirection=null,this.debugEnabled=!1,this._debugSizeParams=new Ee(0,0,1,1),this._debugPassName="CDF Debug",this.onGeneratedObservable=new k,e?Aa._IsScene(e)?this._scene=e:this._engine=e:this._scene=De.LastCreatedScene,this._scene&&(this._engine=this._scene.getEngine()),!this.isSupported){N.Warn("CDF renderer is not supported by the current engine.");return}const t=new Uint16Array([0,0,0,255]);this._dummyTexture=new gi(t,1,1,ft.TEXTUREFORMAT_RGBA,e,!1,!1,void 0,2),this._scene&&Aa._SceneComponentInitialization(this._scene)}_createTextures(){const e=this._iblSource?{width:this._iblSource.getSize().width,height:this._iblSource.getSize().height}:{width:1,height:1};this._iblSource||(this._iblSource=gi.CreateRTexture(new Uint8Array([255]),1,1,this._engine,!1,!1,1,0),this._iblSource.name="Placeholder IBL Source"),this._iblSource.isCube&&(e.width*=4,e.height*=2,e.width=1<<Math.floor(Math.log2(e.width)),e.height=1<<Math.floor(Math.log2(e.height)));const t=this._engine.isWebGPU,i={generateDepthBuffer:!1,generateMipMaps:!1,format:6,type:1,samplingMode:1,shaderLanguage:t?1:0,gammaSpace:!1,extraInitializationsAsync:async()=>{t?await Promise.all([U(()=>Promise.resolve().then(()=>Ej),void 0),U(()=>Promise.resolve().then(()=>yj),void 0),U(()=>Promise.resolve().then(()=>Bj),void 0)]):await Promise.all([U(()=>Promise.resolve().then(()=>bj),void 0),U(()=>Promise.resolve().then(()=>Rj),void 0),U(()=>Promise.resolve().then(()=>Uj),void 0)])}},r={generateDepthBuffer:!1,generateMipMaps:!1,format:5,type:2,samplingMode:1,shaderLanguage:t?1:0,gammaSpace:!1,extraInitializationsAsync:async()=>{t?await Promise.all([U(()=>Promise.resolve().then(()=>Pj),void 0),U(()=>Promise.resolve().then(()=>Gj),void 0)]):await Promise.all([U(()=>Promise.resolve().then(()=>Nj),void 0),U(()=>Promise.resolve().then(()=>Wj),void 0)])}};this._cdfyPT=new sr("cdfyTexture",{width:e.width,height:e.height+1},"iblCdfy",this._scene,i,!1,!1),this._cdfyPT.autoClear=!1,this._cdfyPT.setTexture("iblSource",this._iblSource),this._cdfyPT.setInt("iblHeight",e.height),this._cdfyPT.wrapV=0,this._cdfyPT.refreshRate=0,this._iblSource.isCube&&(this._cdfyPT.defines=`#define IBL_USE_CUBE_MAP
`),this._cdfxPT=new sr("cdfxTexture",{width:e.width+1,height:1},"iblCdfx",this._scene,i,!1,!1),this._cdfxPT.autoClear=!1,this._cdfxPT.setTexture("cdfy",this._cdfyPT),this._cdfxPT.refreshRate=0,this._cdfxPT.wrapU=0,this._scaledLuminancePT=new sr("iblScaledLuminance",{width:e.width,height:e.height},"iblScaledLuminance",this._scene,{...i,samplingMode:3,generateMipMaps:!0},!0,!1),this._scaledLuminancePT.autoClear=!1,this._scaledLuminancePT.setTexture("iblSource",this._iblSource),this._scaledLuminancePT.setInt("iblHeight",e.height),this._scaledLuminancePT.setInt("iblWidth",e.width),this._scaledLuminancePT.refreshRate=0,this._iblSource.isCube&&(this._scaledLuminancePT.defines=`#define IBL_USE_CUBE_MAP
`),this._icdfPT=new sr("icdfTexture",{width:e.width,height:e.height},"iblIcdf",this._scene,r,!1,!1),this._icdfPT.autoClear=!1,this._icdfPT.setTexture("cdfy",this._cdfyPT),this._icdfPT.setTexture("cdfx",this._cdfxPT),this._icdfPT.setTexture("iblSource",this._iblSource),this._icdfPT.setTexture("scaledLuminanceSampler",this._scaledLuminancePT),this._icdfPT.refreshRate=0,this._icdfPT.wrapV=0,this._icdfPT.wrapU=0,this._iblSource.isCube&&(this._icdfPT.defines=`#define IBL_USE_CUBE_MAP
`),this._icdfPT.onGeneratedObservable.addOnce(()=>{this.onGeneratedObservable.notifyObservers()}),this._dominantDirectionPT=new sr("iblDominantDirection",{width:1,height:1},"iblDominantDirection",this._scene,r,!1,!1),this._dominantDirectionPT.autoClear=!1,this._dominantDirectionPT.setTexture("icdfSampler",this._icdfPT),this._dominantDirectionPT.refreshRate=0,this._dominantDirectionPT.defines=`#define NUM_SAMPLES 32u
`}_disposeTextures(){var e,t,i,r,n;(e=this._cdfyPT)==null||e.dispose(),(t=this._cdfxPT)==null||t.dispose(),(i=this._icdfPT)==null||i.dispose(),(r=this._scaledLuminancePT)==null||r.dispose(),(n=this._dominantDirectionPT)==null||n.dispose()}_createDebugPass(){var r,n,a;this._debugPass&&this._debugPass.dispose();const e=this._engine.isWebGPU,t={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),samplingMode:$.BILINEAR_SAMPLINGMODE,engine:this._engine,textureType:0,uniforms:["sizeParams"],samplers:["cdfy","icdf","cdfx","iblSource"],defines:(r=this._iblSource)!=null&&r.isCube?`#define IBL_USE_CUBE_MAP
`:"",shaderLanguage:e?1:0,extraInitializations:(o,l)=>{o?l.push(U(()=>Promise.resolve().then(()=>Mj),void 0)):l.push(U(()=>Promise.resolve().then(()=>Lj),void 0))}};this._debugPass=new Se(this._debugPassName,"iblCdfDebug",t);const i=this._debugPass.getEffect();i&&(i.defines=(n=this._iblSource)!=null&&n.isCube?`#define IBL_USE_CUBE_MAP
`:""),(a=this._iblSource)!=null&&a.isCube&&this._debugPass.updateEffect(`#define IBL_USE_CUBE_MAP
`),this._debugPass.onApplyObservable.add(o=>{o.setTexture("cdfy",this._cdfyPT),o.setTexture("icdf",this._icdfPT),o.setTexture("cdfx",this._cdfxPT),o.setTexture("iblSource",this._iblSource),o.setFloat4("sizeParams",this._debugSizeParams.x,this._debugSizeParams.y,this._debugSizeParams.z,this._debugSizeParams.w)})}isReady(){return this._iblSource&&this._iblSource.name!=="Placeholder IBL Source"&&this._iblSource.isReady()&&this._cdfyPT&&this._cdfyPT.isReady()&&this._icdfPT&&this._icdfPT.isReady()&&this._cdfxPT&&this._cdfxPT.isReady()&&this._scaledLuminancePT&&this._scaledLuminancePT.isReady()}renderWhenReady(){return this._cachedDominantDirection=null,new Promise((t,i)=>{Wn(()=>!!this._icdfPT,()=>t(void 0),()=>i(new Error("Waiting for _icdfPT creation failed")))}).then(()=>{this._icdfPT.onGeneratedObservable.addOnce(()=>{this.onGeneratedObservable.notifyObservers()});const t=[],i=[this._cdfyPT,this._cdfxPT,this._scaledLuminancePT,this._icdfPT];for(const r of i)t.push(new Promise(n=>{r.isReady()?n():r.getEffect().executeWhenCompiled(()=>{n()})}));return Promise.all(t).then(()=>{for(const r of i)r.render()})})}findDominantDirection(){return this._cachedDominantDirection?Promise.resolve(this._cachedDominantDirection):new Promise(e=>{this._dominantDirectionPT.onGeneratedObservable.addOnce(()=>{const t=new Float32Array(4);this._dominantDirectionPT.readPixels(0,0,t,!0).then(()=>{const i=new x(t[0],t[1],t[2]);this._cachedDominantDirection=i,e(i)})}),this.isReady()?this._dominantDirectionPT.isReady()?this._dominantDirectionPT.render():this._dominantDirectionPT.getEffect().executeWhenCompiled(()=>{this._dominantDirectionPT.render()}):this.onGeneratedObservable.addOnce(()=>{this._dominantDirectionPT.isReady()?this._dominantDirectionPT.render():this._dominantDirectionPT.getEffect().executeWhenCompiled(()=>{this._dominantDirectionPT.render()})})})}dispose(){this._disposeTextures(),this._dummyTexture.dispose(),this._debugPass&&this._debugPass.dispose(),this.onGeneratedObservable.clear()}static _IsScene(e){return e.getClassName()==="Scene"}}Aa._SceneComponentInitialization=s=>{throw Ys("IblCdfGeneratorSceneComponentSceneComponent")};class D3{constructor(e,t={}){this.quality=4096,this.hdrScale=1,this.useCdf=!1,this._engine=e,this.hdrScale=t.hdrScale||this.hdrScale,this.quality=t.quality||this.quality,this.useCdf=t.useCdf||this.useCdf}_createRenderTarget(e){let t=0;this._engine.getCaps().textureHalfFloatRender?t=2:this._engine.getCaps().textureFloatRender&&(t=1);const i=this._engine.createRenderTargetCubeTexture(e,{format:5,type:t,createMipMaps:!1,generateMipMaps:!1,generateDepthBuffer:!1,generateStencilBuffer:!1,samplingMode:2,label:"HDR_Irradiance_Filtering_Target"});return this._engine.updateTextureWrappingMode(i.texture,0,0,0),i}_prefilterInternal(e){const t=e.getSize().width,i=Ol(t),r=this._effectWrapper.effect,n=Math.max(32,1<<Ol(t>>3)),a=this._createRenderTarget(n);this._effectRenderer.saveStates(),this._effectRenderer.setViewport(),this._effectRenderer.applyEffectWrapper(this._effectWrapper);const o=[[new x(0,0,-1),new x(0,-1,0),new x(1,0,0)],[new x(0,0,1),new x(0,-1,0),new x(-1,0,0)],[new x(1,0,0),new x(0,0,1),new x(0,1,0)],[new x(1,0,0),new x(0,0,-1),new x(0,-1,0)],[new x(1,0,0),new x(0,-1,0),new x(0,0,1)],[new x(-1,0,0),new x(0,-1,0),new x(0,0,-1)]];r.setFloat("hdrScale",this.hdrScale),r.setFloat2("vFilteringInfo",e.getSize().width,i),r.setTexture("inputTexture",e),this._cdfGenerator&&r.setTexture("icdfTexture",this._cdfGenerator.getIcdfTexture());for(let c=0;c<6;c++)r.setVector3("up",o[c][0]),r.setVector3("right",o[c][1]),r.setVector3("front",o[c][2]),this._engine.bindFramebuffer(a,c,void 0,void 0,!0),this._effectRenderer.applyEffectWrapper(this._effectWrapper),this._effectRenderer.draw();this._effectRenderer.restoreStates(),this._engine.restoreDefaultFramebuffer(),r.setTexture("inputTexture",null),r.setTexture("icdfTexture",null);const l=new ps(e.getScene(),a.texture);return l.name=e.name+"_irradiance",l.displayName=e.name+"_irradiance",l.gammaSpace=!1,l}_createEffect(e,t){const i=[];e.gammaSpace&&i.push("#define GAMMA_INPUT"),i.push("#define NUM_SAMPLES "+this.quality+"u");const r=this._engine.isWebGPU,n=["inputTexture"];return this._cdfGenerator&&(n.push("icdfTexture"),i.push("#define IBL_CDF_FILTERING")),new gt({engine:this._engine,name:"HDRIrradianceFiltering",vertexShader:"hdrIrradianceFiltering",fragmentShader:"hdrIrradianceFiltering",samplerNames:n,uniformNames:["vSampleDirections","vWeights","up","right","front","vFilteringInfo","hdrScale"],useShaderStore:!0,defines:i,onCompiled:t,shaderLanguage:r?1:0,extraInitializationsAsync:async()=>{r?await Promise.all([U(()=>Promise.resolve().then(()=>wG),void 0),U(()=>Promise.resolve().then(()=>VG),void 0)]):await Promise.all([U(()=>Promise.resolve().then(()=>DG),void 0),U(()=>Promise.resolve().then(()=>FG),void 0)])}})}isReady(e){return e.isReady()&&this._effectWrapper.effect.isReady()}async prefilter(e){var i;if(!this._engine._features.allowTexturePrefiltering)throw new Error("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead.");this.useCdf&&(this._cdfGenerator=new Aa(this._engine),this._cdfGenerator.iblSource=e,await this._cdfGenerator.renderWhenReady()),this._effectRenderer=new go(this._engine),this._effectWrapper=this._createEffect(e),await this._effectWrapper.effect.whenCompiledAsync();const t=this._prefilterInternal(e);return this.useCdf&&await this._cdfGenerator.findDominantDirection().then(r=>{t._dominantDirection=r}),this._effectRenderer.dispose(),this._effectWrapper.dispose(),(i=this._cdfGenerator)==null||i.dispose(),t}}class lc extends ps{set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(z.RotationY(this._rotationY))}get rotationY(){return this._rotationY}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}constructor(e,t,i,r=!1,n=!0,a=!1,o=!1,l=null,c=null,u=!1,h=!1,d=!1){var f;super(t),this._generateHarmonics=!0,this._onError=null,this._isBlocking=!0,this._rotationY=0,this.boundingBoxPosition=x.Zero(),this.onLoadObservable=new k,e&&(this._coordinatesMode=$.CUBIC_MODE,this.name=e,this.url=e,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=z.Identity(),this._prefilterOnLoad=o,this._prefilterIrradianceOnLoad=h,this._prefilterUsingCdf=d,this._onLoad=()=>{this.onLoadObservable.notifyObservers(this),l&&l()},this._onError=c,this.gammaSpace=a,this._noMipmap=r,this._size=i,this._supersample=u||d,this._generateHarmonics=n,this._texture=this._getFromCache(e,this._noMipmap,void 0,void 0,void 0,this.isCube),this._texture?this._texture.isReady?j.SetImmediate(()=>this._onLoad()):this._texture.onLoadedObservable.add(this._onLoad):(f=this.getScene())!=null&&f.useDelayedTextureLoading?this.delayLoadState=4:this._loadTexture())}getClassName(){return"EnvCubeTexture"}_loadTexture(){const e=this._getEngine(),t=e.getCaps();let i=0;t.textureFloat&&t.textureFloatLinearFiltering?i=1:t.textureHalfFloat&&t.textureHalfFloatLinearFiltering&&(i=2);const r=async n=>{this.lodGenerationOffset=0,this.lodGenerationScale=.8;const a=await this._getCubeMapTextureDataAsync(n,this._size,this._supersample);if(this._generateHarmonics){const u=cM.ConvertCubeMapToSphericalPolynomial(a);this.sphericalPolynomial=u}const o=[];let l=null,c=null;for(let u=0;u<6;u++){i===2?c=new Uint16Array(this._size*this._size*3):i===0&&(l=new Uint8Array(this._size*this._size*3));const h=a[lc._FacesMapping[u]];if(this.gammaSpace||c||l){for(let d=0;d<this._size*this._size;d++)if(this.gammaSpace&&(h[d*3+0]=Math.pow(h[d*3+0],Bc),h[d*3+1]=Math.pow(h[d*3+1],Bc),h[d*3+2]=Math.pow(h[d*3+2],Bc)),c&&(c[d*3+0]=rn(h[d*3+0]),c[d*3+1]=rn(h[d*3+1]),c[d*3+2]=rn(h[d*3+2])),l){let f=Math.max(h[d*3+0]*255,0),m=Math.max(h[d*3+1]*255,0),g=Math.max(h[d*3+2]*255,0);const v=Math.max(Math.max(f,m),g);if(v>255){const E=255/v;f*=E,m*=E,g*=E}l[d*3+0]=f,l[d*3+1]=m,l[d*3+2]=g}}c?o.push(c):l?o.push(l):o.push(h)}return o};if(e._features.allowTexturePrefiltering&&(this._prefilterOnLoad||this._prefilterIrradianceOnLoad)){const n=this._onLoad,a=new pA(e);this._onLoad=()=>{let o=Promise.resolve(null),l=Promise.resolve();this._prefilterIrradianceOnLoad&&(o=new D3(e,{useCdf:this._prefilterUsingCdf}).prefilter(this)),this._prefilterOnLoad&&(l=a.prefilter(this)),Promise.all([o,l]).then(c=>{const u=c[0];if(this._prefilterIrradianceOnLoad&&u){this.irradianceTexture=u;const h=this.getScene();h&&h.markAllMaterialsAsDirty(1)}n&&n()})}}this._texture=e.createRawCubeTextureFromUrl(this.url,this.getScene(),this._size,4,i,this._noMipmap,r,null,this._onLoad,this._onError)}delayLoad(){this.delayLoadState===4&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||this._loadTexture())}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){var t;this._textureMatrix=e,e.updateFlag!==this._textureMatrix.updateFlag&&e.isIdentity()!==this._textureMatrix.isIdentity()&&((t=this.getScene())==null||t.markAllMaterialsAsDirty(1,i=>i.getActiveTextures().indexOf(this)!==-1))}dispose(){this.onLoadObservable.clear(),super.dispose()}serialize(){if(!this.name)return null;const e={};return e.name=this.name,e.hasAlpha=this.hasAlpha,e.isCube=!0,e.level=this.level,e.size=this._size,e.coordinatesMode=this.coordinatesMode,e.useInGammaSpace=this.gammaSpace,e.generateHarmonics=this._generateHarmonics,e.noMipmap=this._noMipmap,e.isBlocking=this._isBlocking,e.rotationY=this._rotationY,e}clone(){const e=this._instantiateClone();return e.level=this.level,e.wrapU=this.wrapU,e.wrapV=this.wrapV,e.coordinatesIndex=this.coordinatesIndex,e.coordinatesMode=this.coordinatesMode,e}static _Parse(e,t){t.name=e.name,t.hasAlpha=e.hasAlpha,t.level=e.level,t.coordinatesMode=e.coordinatesMode,t.isBlocking=e.isBlocking,e.boundingBoxPosition&&(t.boundingBoxPosition=x.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(t.boundingBoxSize=x.FromArray(e.boundingBoxSize)),e.rotationY&&(t.rotationY=e.rotationY)}}lc._FacesMapping=["right","left","up","down","front","back"];class Vl extends lc{constructor(e,t,i,r=!1,n=!0,a=!1,o=!1,l=null,c=null,u=!1,h=!1,d=!1){super(e,t,i,r,n,a,o,l,c,u,h,d)}getClassName(){return"HDRCubeTexture"}async _getCubeMapTextureDataAsync(e,t,i){return pM(e,t,i)}_instantiateClone(){return new Vl(this.url,this.getScene()||this._getEngine(),this._size,this._noMipmap,this._generateHarmonics,this.gammaSpace)}serialize(){const e=super.serialize();return e?(e.customType="BABYLON.HDRCubeTexture",e):null}static Parse(e,t,i){if(!e.name||e.isRenderTarget)return null;const r=new Vl(i+e.name,t,e.size,e.noMipmap,e.generateHarmonics,e.useInGammaSpace);return this._Parse(e,r),r}}y("BABYLON.HDRCubeTexture",Vl);class uo{get influence(){return this._influence}set influence(e){if(this._influence===e)return;const t=this._influence;this._influence=e,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(t===0||e===0)}get animationPropertiesOverride(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}constructor(e,t=0,i=null){this.name=e,this.animations=[],this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uv2s=null,this._colors=null,this._uniqueId=0,this.onInfluenceChanged=new k,this._onDataLayoutChanged=new k,this._animationPropertiesOverride=null,this.id=e,this._scene=i||De.LastCreatedScene,this.influence=t,this._scene&&(this._uniqueId=this._scene.getUniqueId())}get uniqueId(){return this._uniqueId}get hasPositions(){return!!this._positions}get hasNormals(){return!!this._normals}get hasTangents(){return!!this._tangents}get hasUVs(){return!!this._uvs}get hasUV2s(){return!!this._uv2s}get hasColors(){return!!this._colors}get vertexCount(){return this._positions?this._positions.length/3:this._normals?this._normals.length/3:this._tangents?this._tangents.length/3:this._uvs?this._uvs.length/2:this._uv2s?this._uv2s.length/2:this._colors?this._colors.length/4:0}setPositions(e){const t=this.hasPositions;this._positions=e,t!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)}getPositions(){return this._positions}setNormals(e){const t=this.hasNormals;this._normals=e,t!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)}getNormals(){return this._normals}setTangents(e){const t=this.hasTangents;this._tangents=e,t!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)}getTangents(){return this._tangents}setUVs(e){const t=this.hasUVs;this._uvs=e,t!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)}getUVs(){return this._uvs}setUV2s(e){const t=this.hasUV2s;this._uv2s=e,t!==this.hasUV2s&&this._onDataLayoutChanged.notifyObservers(void 0)}getUV2s(){return this._uv2s}setColors(e){const t=this.hasColors;this._colors=e,t!==this.hasColors&&this._onDataLayoutChanged.notifyObservers(void 0)}getColors(){return this._colors}clone(){const e=me.Clone(()=>new uo(this.name,this.influence,this._scene),this);return e._positions=this._positions,e._normals=this._normals,e._tangents=this._tangents,e._uvs=this._uvs,e._uv2s=this._uv2s,e._colors=this._colors,e}serialize(){const e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),this.id!=null&&(e.id=this.id),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(e.uvs=Array.prototype.slice.call(this.getUVs())),this.hasUV2s&&(e.uv2s=Array.prototype.slice.call(this.getUV2s())),this.hasColors&&(e.colors=Array.prototype.slice.call(this.getColors())),me.AppendSerializedAnimations(this,e),e}getClassName(){return"MorphTarget"}static Parse(e,t){const i=new uo(e.name,e.influence);if(i.setPositions(e.positions),e.id!=null&&(i.id=e.id),e.normals&&i.setNormals(e.normals),e.tangents&&i.setTangents(e.tangents),e.uvs&&i.setUVs(e.uvs),e.uv2s&&i.setUV2s(e.uv2s),e.colors&&i.setColors(e.colors),e.animations){for(let r=0;r<e.animations.length;r++){const n=e.animations[r],a=ki("BABYLON.Animation");a&&i.animations.push(a.Parse(n))}e.autoAnimate&&t&&t.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}return i}static FromMesh(e,t,i){t||(t=e.name);const r=new uo(t,i,e.getScene());return r.setPositions(e.getVerticesData(M.PositionKind)),e.isVerticesDataPresent(M.NormalKind)&&r.setNormals(e.getVerticesData(M.NormalKind)),e.isVerticesDataPresent(M.TangentKind)&&r.setTangents(e.getVerticesData(M.TangentKind)),e.isVerticesDataPresent(M.UVKind)&&r.setUVs(e.getVerticesData(M.UVKind)),e.isVerticesDataPresent(M.UV2Kind)&&r.setUV2s(e.getVerticesData(M.UV2Kind)),e.isVerticesDataPresent(M.ColorKind)&&r.setColors(e.getVerticesData(M.ColorKind)),r}}_([R()],uo.prototype,"id",void 0);class F_ extends ${get depth(){return this._depth}constructor(e,t,i,r,n,a,o=!0,l=!1,c=$.TRILINEAR_SAMPLINGMODE,u=0,h){super(null,a,!o,l),this.format=n,this._texture=a.getEngine().createRawTexture2DArray(e,t,i,r,n,o,l,c,null,u,h),this._depth=r,this.is2DArray=!0}update(e){this._texture&&this._getEngine().updateRawTexture2DArray(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}static CreateRGBATexture(e,t,i,r,n,a=!0,o=!1,l=3,c=0){return new F_(e,t,i,r,5,n,a,o,l,c)}}class Zr{set areUpdatesFrozen(e){e?this._blockCounter++:(this._blockCounter--,this._blockCounter<=0&&(this._blockCounter=0,this._syncActiveTargets(this._forceUpdateWhenUnfrozen),this._forceUpdateWhenUnfrozen=!1))}get areUpdatesFrozen(){return this._blockCounter>0}constructor(e=null){if(this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new Xn(16),this._supportsPositions=!1,this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._supportsUV2s=!1,this._supportsColors=!1,this._vertexCount=0,this._uniqueId=0,this._tempInfluences=new Array,this._canUseTextureForTargets=!1,this._blockCounter=0,this._mustSynchronize=!0,this._forceUpdateWhenUnfrozen=!1,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._parentContainer=null,this.optimizeInfluencers=!0,this.enablePositionMorphing=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this.enableUV2Morphing=!0,this.enableColorMorphing=!0,this._numMaxInfluencers=0,this._useTextureToStoreTargets=!0,this.metadata=null,e||(e=De.LastCreatedScene),this._scene=e,this._scene){this._scene.addMorphTargetManager(this),this._uniqueId=this._scene.getUniqueId();const t=this._scene.getEngine().getCaps();this._canUseTextureForTargets=t.canUseGLVertexID&&t.textureFloat&&t.maxVertexTextureImageUnits>0&&t.texture2DArrayMaxLayerCount>1}}get numMaxInfluencers(){return Zr.ConstantTargetCountForTextureMode>0&&this.isUsingTextureForTargets?Zr.ConstantTargetCountForTextureMode:this._numMaxInfluencers}set numMaxInfluencers(e){this._numMaxInfluencers!==e&&(this._numMaxInfluencers=e,this._mustSynchronize=!0,this._syncActiveTargets())}get uniqueId(){return this._uniqueId}get vertexCount(){return this._vertexCount}get supportsPositions(){return this._supportsPositions&&this.enablePositionMorphing}get supportsNormals(){return this._supportsNormals&&this.enableNormalMorphing}get supportsTangents(){return this._supportsTangents&&this.enableTangentMorphing}get supportsUVs(){return this._supportsUVs&&this.enableUVMorphing}get supportsUV2s(){return this._supportsUV2s&&this.enableUV2Morphing}get supportsColors(){return this._supportsColors&&this.enableColorMorphing}get hasPositions(){return this._supportsPositions}get hasNormals(){return this._supportsNormals}get hasTangents(){return this._supportsTangents}get hasUVs(){return this._supportsUVs}get hasUV2s(){return this._supportsUV2s}get hasColors(){return this._supportsColors}get numTargets(){return this._targets.length}get numInfluencers(){return this._activeTargets.length}get influences(){return this._influences}get useTextureToStoreTargets(){return this._useTextureToStoreTargets}set useTextureToStoreTargets(e){this._useTextureToStoreTargets!==e&&(this._useTextureToStoreTargets=e,this._mustSynchronize=!0,this._syncActiveTargets())}get isUsingTextureForTargets(){var e;return Zr.EnableTextureStorage&&this.useTextureToStoreTargets&&this._canUseTextureForTargets&&!((e=this._scene)!=null&&e.getEngine().getCaps().disableMorphTargetTexture)}getActiveTarget(e){return this._activeTargets.data[e]}getTarget(e){return this._targets[e]}getTargetByName(e){for(const t of this._targets)if(t.name===e)return t;return null}addTarget(e){this._targets.push(e),this._targetInfluenceChangedObservers.push(e.onInfluenceChanged.add(t=>{this.areUpdatesFrozen&&t&&(this._forceUpdateWhenUnfrozen=!0),this._syncActiveTargets(t)})),this._targetDataLayoutChangedObservers.push(e._onDataLayoutChanged.add(()=>{this._mustSynchronize=!0,this._syncActiveTargets()})),this._mustSynchronize=!0,this._syncActiveTargets()}removeTarget(e){const t=this._targets.indexOf(e);t>=0&&(this._targets.splice(t,1),e.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(t,1)[0]),e._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(t,1)[0]),this._mustSynchronize=!0,this._syncActiveTargets()),this._scene&&this._scene.stopAnimation(e)}_bind(e){e.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),e.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),e.setTexture("morphTargets",this._targetStoreTexture),e.setFloat("morphTargetCount",this.numInfluencers)}clone(){const e=new Zr(this._scene);e.areUpdatesFrozen=!0;for(const t of this._targets)e.addTarget(t.clone());return e.areUpdatesFrozen=!1,e.enablePositionMorphing=this.enablePositionMorphing,e.enableNormalMorphing=this.enableNormalMorphing,e.enableTangentMorphing=this.enableTangentMorphing,e.enableUVMorphing=this.enableUVMorphing,e.enableUV2Morphing=this.enableUV2Morphing,e.enableColorMorphing=this.enableColorMorphing,e.metadata=this.metadata,e}serialize(){const e={};e.id=this.uniqueId,e.targets=[];for(const t of this._targets)e.targets.push(t.serialize());return this.metadata&&(e.metadata=this.metadata),e}_syncActiveTargets(e=!1){if(this.areUpdatesFrozen)return;const t=!!this._targetStoreTexture,i=this.isUsingTextureForTargets;(this._mustSynchronize||t!==i)&&(this._mustSynchronize=!1,this.synchronize());let r=0;this._activeTargets.reset(),(!this._morphTargetTextureIndices||this._morphTargetTextureIndices.length!==this._targets.length)&&(this._morphTargetTextureIndices=new Float32Array(this._targets.length));let n=-1;for(const a of this._targets)if(n++,!(a.influence===0&&this.optimizeInfluencers)){if(this._activeTargets.length>=Zr.MaxActiveMorphTargetsInVertexAttributeMode&&!this.isUsingTextureForTargets)break;this._activeTargets.push(a),this._morphTargetTextureIndices[r]=n,this._tempInfluences[r++]=a.influence}this._morphTargetTextureIndices.length!==r&&(this._morphTargetTextureIndices=this._morphTargetTextureIndices.slice(0,r)),(!this._influences||this._influences.length!==r)&&(this._influences=new Float32Array(r));for(let a=0;a<r;a++)this._influences[a]=this._tempInfluences[a];if(e&&this._scene)for(const a of this._scene.meshes)a.morphTargetManager===this&&(i?a._markSubMeshesAsAttributesDirty():a._syncGeometryWithMorphTargetManager())}synchronize(){var t;if(!this._scene||this.areUpdatesFrozen)return;const e=this._scene.getEngine();this._supportsPositions=!0,this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._supportsUV2s=!0,this._supportsColors=!0,this._vertexCount=0,(t=this._targetStoreTexture)==null||t.dispose(),this._targetStoreTexture=null,this.isUsingTextureForTargets&&this._targets.length>e.getCaps().texture2DArrayMaxLayerCount&&(this.useTextureToStoreTargets=!1);for(const i of this._targets){this._supportsPositions=this._supportsPositions&&i.hasPositions,this._supportsNormals=this._supportsNormals&&i.hasNormals,this._supportsTangents=this._supportsTangents&&i.hasTangents,this._supportsUVs=this._supportsUVs&&i.hasUVs,this._supportsUV2s=this._supportsUV2s&&i.hasUV2s,this._supportsColors=this._supportsColors&&i.hasColors;const r=i.vertexCount;if(this._vertexCount===0)this._vertexCount=r;else if(this._vertexCount!==r){N.Error(`Incompatible target. Targets must all have the same vertices count. Current vertex count: ${this._vertexCount}, vertex count for target "${i.name}": ${r}`);return}}if(this.isUsingTextureForTargets){this._textureVertexStride=0,this._supportsPositions&&this._textureVertexStride++,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._supportsUV2s&&this._textureVertexStride++,this._supportsColors&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride||1,this._textureHeight=1;const i=e.getCaps().maxTextureSize;this._textureWidth>i&&(this._textureHeight=Math.ceil(this._textureWidth/i),this._textureWidth=i);const r=this._targets.length,n=new Float32Array(r*this._textureWidth*this._textureHeight*4);let a=0;for(let o=0;o<r;o++){const l=this._targets[o],c=l.getPositions(),u=l.getNormals(),h=l.getUVs(),d=l.getTangents(),f=l.getUV2s(),m=l.getColors();a=o*this._textureWidth*this._textureHeight*4;for(let g=0;g<this._vertexCount;g++)this._supportsPositions&&c&&(n[a]=c[g*3],n[a+1]=c[g*3+1],n[a+2]=c[g*3+2],a+=4),this._supportsNormals&&u&&(n[a]=u[g*3],n[a+1]=u[g*3+1],n[a+2]=u[g*3+2],a+=4),this._supportsUVs&&h&&(n[a]=h[g*2],n[a+1]=h[g*2+1],a+=4),this._supportsTangents&&d&&(n[a]=d[g*3],n[a+1]=d[g*3+1],n[a+2]=d[g*3+2],a+=4),this._supportsUV2s&&f&&(n[a]=f[g*2],n[a+1]=f[g*2+1],a+=4),this._supportsColors&&m&&(n[a]=m[g*4],n[a+1]=m[g*4+1],n[a+2]=m[g*4+2],n[a+3]=m[g*4+3],a+=4)}this._targetStoreTexture=F_.CreateRGBATexture(n,this._textureWidth,this._textureHeight,r,this._scene,!1,!1,1,1),this._targetStoreTexture.name=`Morph texture_${this.uniqueId}`}for(const i of this._scene.meshes)i.morphTargetManager===this&&i._syncGeometryWithMorphTargetManager()}dispose(){if(this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null,this.metadata=null,this._scene){if(this._scene.removeMorphTargetManager(this),this._parentContainer){const e=this._parentContainer.morphTargetManagers.indexOf(this);e>-1&&this._parentContainer.morphTargetManagers.splice(e,1),this._parentContainer=null}for(const e of this._targets)this._scene.stopAnimation(e)}}static Parse(e,t){const i=new Zr(t);for(const r of e.targets)i.addTarget(uo.Parse(r,t));return e.metadata&&(i.metadata=e.metadata),i}}Zr.EnableTextureStorage=!0;Zr.MaxActiveMorphTargetsInVertexAttributeMode=8;Zr.ConstantTargetCountForTextureMode=0;class M3{constructor(){this._hasHit=!1,this._hitNormal=x.Zero(),this._hitPoint=x.Zero(),this._triangleIndex=-1}get hitPoint(){return this._hitPoint}get hitNormal(){return this._hitNormal}get hasHit(){return this._hasHit}get triangleIndex(){return this._triangleIndex}setHitData(e,t,i){this._hasHit=!0,this._hitNormal.set(e.x,e.y,e.z),this._hitPoint.set(t.x,t.y,t.z),this._triangleIndex=i??-1}reset(){this._hasHit=!1,this._hitNormal.setAll(0),this._hitPoint.setAll(0),this._triangleIndex=-1,this.body=void 0,this.bodyIndex=void 0,this.shape=void 0}}class bh extends M3{constructor(){super(...arguments),this._hitDistance=0,this._rayFromWorld=x.Zero(),this._rayToWorld=x.Zero()}get hitDistance(){return this._hitDistance}get hitNormalWorld(){return this._hitNormal}get hitPointWorld(){return this._hitPoint}get rayFromWorld(){return this._rayFromWorld}get rayToWorld(){return this._rayToWorld}setHitDistance(e){this._hitDistance=e}calculateHitDistance(){this._hitDistance=x.Distance(this._rayFromWorld,this._hitPoint)}reset(e=x.Zero(),t=x.Zero()){super.reset(),this._rayFromWorld.copyFrom(e),this._rayToWorld.copyFrom(t),this._hitDistance=0}}let mA=class _A{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw Ys("CannonJSPlugin")}constructor(e,t=_A.DefaultPluginFactory()){if(this._physicsPlugin=t,this._impostors=[],this._joints=[],this._subTimeStep=0,this._uniqueIdCounter=0,!this._physicsPlugin.isSupported())throw new Error("Physics Engine "+this._physicsPlugin.name+" cannot be found. Please make sure it is included.");e=e||new x(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){for(const e of this._impostors)e.dispose();this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}addImpostor(e){this._impostors.push(e),e.uniqueId=this._uniqueIdCounter++,e.parent||this._physicsPlugin.generatePhysicsBody(e)}removeImpostor(e){const t=this._impostors.indexOf(e);t>-1&&this._impostors.splice(t,1).length&&this.getPhysicsPlugin().removePhysicsBody(e)}addJoint(e,t,i){const r={mainImpostor:e,connectedImpostor:t,joint:i};i.physicsPlugin=this._physicsPlugin,this._joints.push(r),this._physicsPlugin.generateJoint(r)}removeJoint(e,t,i){const r=this._joints.filter(function(n){return n.connectedImpostor===t&&n.joint===i&&n.mainImpostor===e});r.length&&this._physicsPlugin.removeJoint(r[0])}_step(e){for(const t of this._impostors)t.isBodyInitRequired()&&this._physicsPlugin.generatePhysicsBody(t);e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._impostors)}getPhysicsPlugin(){return this._physicsPlugin}getImpostors(){return this._impostors}getImpostorForPhysicsObject(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].object===e)return this._impostors[t];return null}getImpostorWithPhysicsBody(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].physicsBody===e)return this._impostors[t];return null}raycast(e,t){return this._physicsPlugin.raycast(e,t)}raycastToRef(e,t,i){return this._physicsPlugin.raycastToRef(e,t,i)}};class zd{constructor(e=!0,t=10,i=CANNON){if(this._useDeltaForWorldStep=e,this.name="CannonJSPlugin",this._physicsMaterials=[],this._fixedTimeStep=1/60,this._physicsBodiesToRemoveAfterStep=new Array,this._firstFrame=!0,this._tmpQuaternion=new Z,this._minus90X=new Z(-.7071067811865475,0,0,.7071067811865475),this._plus90X=new Z(.7071067811865475,0,0,.7071067811865475),this._tmpPosition=x.Zero(),this._tmpDeltaPosition=x.Zero(),this._tmpUnityRotation=new Z,this.BJSCANNON=i,!this.isSupported()){N.Error("CannonJS is not available. Please make sure you included the js file.");return}this._extendNamespace(),this.world=new this.BJSCANNON.World,this.world.broadphase=new this.BJSCANNON.NaiveBroadphase,this.world.solver.iterations=t,this._cannonRaycastResult=new this.BJSCANNON.RaycastResult,this._raycastResult=new bh}getPluginVersion(){return 1}setGravity(e){const t=e;this.world.gravity.set(t.x,t.y,t.z)}setTimeStep(e){this._fixedTimeStep=e}getTimeStep(){return this._fixedTimeStep}executeStep(e,t){if(this._firstFrame){this._firstFrame=!1;for(const i of t)i.type==ue.HeightmapImpostor||i.type===ue.PlaneImpostor||i.beforeStep()}this.world.step(this._useDeltaForWorldStep?e:this._fixedTimeStep),this._removeMarkedPhysicsBodiesFromWorld()}_removeMarkedPhysicsBodiesFromWorld(){if(this._physicsBodiesToRemoveAfterStep.length>0){for(const e of this._physicsBodiesToRemoveAfterStep)typeof this.world.removeBody=="function"?this.world.removeBody(e):this.world.remove(e);this._physicsBodiesToRemoveAfterStep.length=0}}applyImpulse(e,t,i){const r=new this.BJSCANNON.Vec3(i.x,i.y,i.z),n=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyImpulse(n,r)}applyForce(e,t,i){const r=new this.BJSCANNON.Vec3(i.x,i.y,i.z),n=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyForce(n,r)}generatePhysicsBody(e){if(this._removeMarkedPhysicsBodiesFromWorld(),e.parent){e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());return}if(e.isBodyInitRequired()){const t=this._createShape(e);if(!t){N.Warn("It was not possible to create a physics body for this object.");return}const i=e.physicsBody;i&&this.removePhysicsBody(e);const r=this._addMaterial("mat-"+e.uniqueId,e.getParam("friction"),e.getParam("restitution")),n={mass:e.getParam("mass"),material:r},a=e.getParam("nativeOptions");for(const o in a)Object.prototype.hasOwnProperty.call(a,o)&&(n[o]=a[o]);if(e.physicsBody=new this.BJSCANNON.Body(n),e.physicsBody.addEventListener("collide",e.onCollide),this.world.addEventListener("preStep",e.beforeStep),this.world.addEventListener("postStep",e.afterStep),e.physicsBody.addShape(t),typeof this.world.addBody=="function"?this.world.addBody(e.physicsBody):this.world.add(e.physicsBody),i){const o=["force","torque","velocity","angularVelocity"];for(const l of o){const c=i[l];e.physicsBody[l].set(c.x,c.y,c.z)}}this._processChildMeshes(e)}this._updatePhysicsBodyTransformation(e)}_processChildMeshes(e){const t=e.object.getChildMeshes?e.object.getChildMeshes(!0):[],i=e.object.rotationQuaternion;if(i?i.conjugateToRef(this._tmpQuaternion):this._tmpQuaternion.set(0,0,0,1),t.length){const r=a=>{if(!a.rotationQuaternion)return;const o=a.getPhysicsImpostor();if(o&&o.parent!==e&&a.parent){const u=a.getAbsolutePosition().subtract(a.parent.getAbsolutePosition()),h=a.rotationQuaternion.multiply(this._tmpQuaternion);o.physicsBody&&(this.removePhysicsBody(o),o.physicsBody=null),o.parent=e,o.resetUpdateFlags(),e.physicsBody.addShape(this._createShape(o),new this.BJSCANNON.Vec3(u.x,u.y,u.z),new this.BJSCANNON.Quaternion(h.x,h.y,h.z,h.w)),e.physicsBody.mass+=o.getParam("mass")}const l=a.getChildMeshes(!0).filter(c=>!!c.physicsImpostor);for(const c of l)r(c)},n=t.filter(a=>!!a.physicsImpostor);for(const a of n)r(a)}}removePhysicsBody(e){e.physicsBody.removeEventListener("collide",e.onCollide),this.world.removeEventListener("preStep",e.beforeStep),this.world.removeEventListener("postStep",e.afterStep),this._physicsBodiesToRemoveAfterStep.indexOf(e.physicsBody)===-1&&this._physicsBodiesToRemoveAfterStep.push(e.physicsBody)}generateJoint(e){const t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;let r;const n=e.joint.jointData,a={pivotA:n.mainPivot?new this.BJSCANNON.Vec3().set(n.mainPivot.x,n.mainPivot.y,n.mainPivot.z):null,pivotB:n.connectedPivot?new this.BJSCANNON.Vec3().set(n.connectedPivot.x,n.connectedPivot.y,n.connectedPivot.z):null,axisA:n.mainAxis?new this.BJSCANNON.Vec3().set(n.mainAxis.x,n.mainAxis.y,n.mainAxis.z):null,axisB:n.connectedAxis?new this.BJSCANNON.Vec3().set(n.connectedAxis.x,n.connectedAxis.y,n.connectedAxis.z):null,maxForce:n.nativeParams.maxForce,collideConnected:!!n.collision};switch(e.joint.type){case xt.HingeJoint:case xt.Hinge2Joint:r=new this.BJSCANNON.HingeConstraint(t,i,a);break;case xt.DistanceJoint:r=new this.BJSCANNON.DistanceConstraint(t,i,n.maxDistance||2);break;case xt.SpringJoint:{const o=n;r=new this.BJSCANNON.Spring(t,i,{restLength:o.length,stiffness:o.stiffness,damping:o.damping,localAnchorA:a.pivotA,localAnchorB:a.pivotB});break}case xt.LockJoint:r=new this.BJSCANNON.LockConstraint(t,i,a);break;case xt.PointToPointJoint:case xt.BallAndSocketJoint:default:r=new this.BJSCANNON.PointToPointConstraint(t,a.pivotA,i,a.pivotB,a.maxForce);break}r.collideConnected=!!n.collision,e.joint.physicsJoint=r,e.joint.type!==xt.SpringJoint?this.world.addConstraint(r):(e.joint.jointData.forceApplicationCallback=e.joint.jointData.forceApplicationCallback||function(){r.applyForce()},e.mainImpostor.registerAfterPhysicsStep(e.joint.jointData.forceApplicationCallback))}removeJoint(e){e.joint.type!==xt.SpringJoint?this.world.removeConstraint(e.joint.physicsJoint):e.mainImpostor.unregisterAfterPhysicsStep(e.joint.jointData.forceApplicationCallback)}_addMaterial(e,t,i){let r,n;for(r=0;r<this._physicsMaterials.length;r++)if(n=this._physicsMaterials[r],n.friction===t&&n.restitution===i)return n;const a=new this.BJSCANNON.Material(e);return a.friction=t,a.restitution=i,this._physicsMaterials.push(a),a}_checkWithEpsilon(e){return e<Ai?Ai:e}_createShape(e){const t=e.object;let i;const r=e.getObjectExtents();switch(e.type){case ue.SphereImpostor:{const n=r.x,a=r.y,o=r.z;i=new this.BJSCANNON.Sphere(Math.max(this._checkWithEpsilon(n),this._checkWithEpsilon(a),this._checkWithEpsilon(o))/2);break}case ue.CylinderImpostor:{let n=e.getParam("nativeOptions");n||(n={});const a=n.radiusTop!==void 0?n.radiusTop:this._checkWithEpsilon(r.x)/2,o=n.radiusBottom!==void 0?n.radiusBottom:this._checkWithEpsilon(r.x)/2,l=n.height!==void 0?n.height:this._checkWithEpsilon(r.y),c=n.numSegments!==void 0?n.numSegments:16;i=new this.BJSCANNON.Cylinder(a,o,l,c);const u=new this.BJSCANNON.Quaternion;u.setFromAxisAngle(new this.BJSCANNON.Vec3(1,0,0),-Math.PI/2);const h=new this.BJSCANNON.Vec3(0,0,0);i.transformAllPoints(h,u);break}case ue.BoxImpostor:{const n=r.scale(.5);i=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(this._checkWithEpsilon(n.x),this._checkWithEpsilon(n.y),this._checkWithEpsilon(n.z)));break}case ue.PlaneImpostor:N.Warn("Attention, PlaneImposter might not behave as you expect. Consider using BoxImposter instead"),i=new this.BJSCANNON.Plane;break;case ue.MeshImpostor:{const n=t.getVerticesData?t.getVerticesData(M.PositionKind):[],a=t.getIndices?t.getIndices():[];if(!n){N.Warn("Tried to create a MeshImpostor for an object without vertices. This will fail.");return}const o=t.position.clone(),l=t.rotation&&t.rotation.clone(),c=t.rotationQuaternion&&t.rotationQuaternion.clone();t.position.copyFromFloats(0,0,0),t.rotation&&t.rotation.copyFromFloats(0,0,0),t.rotationQuaternion&&t.rotationQuaternion.copyFrom(e.getParentsRotation()),t.rotationQuaternion&&t.parent&&t.rotationQuaternion.conjugateInPlace();const u=t.computeWorldMatrix(!0),h=[];let d;for(d=0;d<n.length;d+=3)x.TransformCoordinates(x.FromArray(n,d),u).toArray(h,d);N.Warn("MeshImpostor only collides against spheres."),i=new this.BJSCANNON.Trimesh(h,a),t.position.copyFrom(o),l&&t.rotation&&t.rotation.copyFrom(l),c&&t.rotationQuaternion&&t.rotationQuaternion.copyFrom(c);break}case ue.HeightmapImpostor:{const n=t.position.clone(),a=t.rotation&&t.rotation.clone(),o=t.rotationQuaternion&&t.rotationQuaternion.clone();t.position.copyFromFloats(0,0,0),t.rotation&&t.rotation.copyFromFloats(0,0,0),t.rotationQuaternion&&t.rotationQuaternion.copyFrom(e.getParentsRotation()),t.rotationQuaternion&&t.parent&&t.rotationQuaternion.conjugateInPlace(),t.rotationQuaternion&&t.rotationQuaternion.multiplyInPlace(this._minus90X),i=this._createHeightmap(t),t.position.copyFrom(n),a&&t.rotation&&t.rotation.copyFrom(a),o&&t.rotationQuaternion&&t.rotationQuaternion.copyFrom(o),t.computeWorldMatrix(!0);break}case ue.ParticleImpostor:i=new this.BJSCANNON.Particle;break;case ue.NoImpostor:i=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(0,0,0));break}return i}_createHeightmap(e,t){let i=e.getVerticesData(M.PositionKind);const r=e.computeWorldMatrix(!0),n=[];let a;for(a=0;a<i.length;a+=3)x.TransformCoordinates(x.FromArray(i,a),r).toArray(n,a);i=n;const o=new Array,l=t||~~(Math.sqrt(i.length/3)-1),c=e.getBoundingInfo(),u=Math.min(c.boundingBox.extendSizeWorld.x,c.boundingBox.extendSizeWorld.y),h=c.boundingBox.extendSizeWorld.z,d=u*2/l;for(let m=0;m<i.length;m=m+3){const g=Math.round(i[m+0]/d+l/2),v=Math.round((i[m+1]/d-l/2)*-1),E=-i[m+2]+h;o[g]||(o[g]=[]),o[g][v]||(o[g][v]=E),o[g][v]=Math.max(E,o[g][v])}for(let m=0;m<=l;++m){if(!o[m]){let g=1;for(;!o[(m+g)%l];)g++;o[m]=o[(m+g)%l].slice()}for(let g=0;g<=l;++g)if(!o[m][g]){let v=1,E;for(;E===void 0;)E=o[m][(g+v++)%l];o[m][g]=E}}const f=new this.BJSCANNON.Heightfield(o,{elementSize:d});return f.minY=h,f}_updatePhysicsBodyTransformation(e){const t=e.object;if(t.computeWorldMatrix&&t.computeWorldMatrix(!0),!t.getBoundingInfo())return;const i=e.getObjectCenter();this._tmpDeltaPosition.copyFrom(t.getAbsolutePivotPoint().subtract(i)),this._tmpDeltaPosition.divideInPlace(e.object.scaling),this._tmpPosition.copyFrom(i);let r=t.rotationQuaternion;if(r){if((e.type===ue.PlaneImpostor||e.type===ue.HeightmapImpostor)&&(r=r.multiply(this._minus90X),e.setDeltaRotation(this._plus90X)),e.type===ue.HeightmapImpostor){const n=t;let a=n.getBoundingInfo();const o=n.rotationQuaternion;n.rotationQuaternion=this._tmpUnityRotation,n.computeWorldMatrix(!0);const l=i.clone();let c=n.getPivotMatrix();c?c=c.clone():c=z.Identity();const u=z.Translation(a.boundingBox.extendSizeWorld.x,0,-a.boundingBox.extendSizeWorld.z);n.setPreTransformMatrix(u),n.computeWorldMatrix(!0),a=n.getBoundingInfo();const h=a.boundingBox.centerWorld.subtract(i).subtract(n.position).negate();this._tmpPosition.copyFromFloats(h.x,h.y-a.boundingBox.extendSizeWorld.y,h.z),this._tmpDeltaPosition.copyFrom(a.boundingBox.centerWorld.subtract(l)),this._tmpDeltaPosition.y+=a.boundingBox.extendSizeWorld.y,n.rotationQuaternion=o,n.setPreTransformMatrix(c),n.computeWorldMatrix(!0)}else e.type===ue.MeshImpostor&&this._tmpDeltaPosition.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpDeltaPosition),e.physicsBody.position.set(this._tmpPosition.x,this._tmpPosition.y,this._tmpPosition.z),e.physicsBody.quaternion.set(r.x,r.y,r.z,r.w)}}setTransformationFromPhysicsBody(e){if(e.object.position.set(e.physicsBody.position.x,e.physicsBody.position.y,e.physicsBody.position.z),e.object.rotationQuaternion){const t=e.physicsBody.quaternion;e.object.rotationQuaternion.set(t.x,t.y,t.z,t.w)}}setPhysicsBodyTransformation(e,t,i){e.physicsBody.position.set(t.x,t.y,t.z),e.physicsBody.quaternion.set(i.x,i.y,i.z,i.w)}isSupported(){return this.BJSCANNON!==void 0}setLinearVelocity(e,t){e.physicsBody.velocity.set(t.x,t.y,t.z)}setAngularVelocity(e,t){e.physicsBody.angularVelocity.set(t.x,t.y,t.z)}getLinearVelocity(e){const t=e.physicsBody.velocity;return t?new x(t.x,t.y,t.z):null}getAngularVelocity(e){const t=e.physicsBody.angularVelocity;return t?new x(t.x,t.y,t.z):null}setBodyMass(e,t){e.physicsBody.mass=t,e.physicsBody.updateMassProperties()}getBodyMass(e){return e.physicsBody.mass}getBodyFriction(e){return e.physicsBody.material.friction}setBodyFriction(e,t){e.physicsBody.material.friction=t}getBodyRestitution(e){return e.physicsBody.material.restitution}setBodyRestitution(e,t){e.physicsBody.material.restitution=t}sleepBody(e){e.physicsBody.sleep()}wakeUpBody(e){e.physicsBody.wakeUp()}updateDistanceJoint(e,t){e.physicsJoint.distance=t}setMotor(e,t,i,r){r||(e.physicsJoint.enableMotor(),e.physicsJoint.setMotorSpeed(t),i&&this.setLimit(e,i))}setLimit(e,t,i){e.physicsJoint.motorEquation.maxForce=i,e.physicsJoint.motorEquation.minForce=t===void 0?-t:t}syncMeshWithImpostor(e,t){const i=t.physicsBody;e.position.x=i.position.x,e.position.y=i.position.y,e.position.z=i.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=i.quaternion.x,e.rotationQuaternion.y=i.quaternion.y,e.rotationQuaternion.z=i.quaternion.z,e.rotationQuaternion.w=i.quaternion.w)}getRadius(e){return e.physicsBody.shapes[0].boundingSphereRadius}getBoxSizeToRef(e,t){const i=e.physicsBody.shapes[0];t.x=i.halfExtents.x*2,t.y=i.halfExtents.y*2,t.z=i.halfExtents.z*2}dispose(){}_extendNamespace(){const e=new this.BJSCANNON.Vec3,t=this.BJSCANNON;this.BJSCANNON.World.prototype.step=function(i,r,n){if(n=n||10,r=r||0,r===0)this.internalStep(i),this.time+=i;else{let a=Math.floor((this.time+r)/i)-Math.floor(this.time/i);a=Math.min(a,n)||1;const o=performance.now();for(let d=0;d!==a&&(this.internalStep(i),!(performance.now()-o>i*1e3));d++);this.time+=r;const c=this.time%i/i,u=e,h=this.bodies;for(let d=0;d!==h.length;d++){const f=h[d];f.type!==t.Body.STATIC&&f.sleepState!==t.Body.SLEEPING?(f.position.vsub(f.previousPosition,u),u.scale(c,u),f.position.vadd(u,f.interpolatedPosition)):(f.interpolatedPosition.set(f.position.x,f.position.y,f.position.z),f.interpolatedQuaternion.set(f.quaternion.x,f.quaternion.y,f.quaternion.z,f.quaternion.w))}}}}raycast(e,t){return this._raycastResult.reset(e,t),this.raycastToRef(e,t,this._raycastResult),this._raycastResult}raycastToRef(e,t,i){this._cannonRaycastResult.reset(),this.world.raycastClosest(e,t,{},this._cannonRaycastResult),i.reset(e,t),this._cannonRaycastResult.hasHit&&(i.setHitData({x:this._cannonRaycastResult.hitNormalWorld.x,y:this._cannonRaycastResult.hitNormalWorld.y,z:this._cannonRaycastResult.hitNormalWorld.z},{x:this._cannonRaycastResult.hitPointWorld.x,y:this._cannonRaycastResult.hitPointWorld.y,z:this._cannonRaycastResult.hitPointWorld.z}),i.setHitDistance(this._cannonRaycastResult.distance))}}mA.DefaultPluginFactory=()=>new zd;class rx{constructor(e=!0,t,i=OIMO){this._useDeltaForWorldStep=e,this.name="OimoJSPlugin",this._fixedTimeStep=1/60,this._tmpImpostorsArray=[],this._tmpPositionVector=x.Zero(),this.BJSOIMO=i,this.world=new this.BJSOIMO.World({iterations:t}),this.world.clear(),this._raycastResult=new bh}getPluginVersion(){return 1}setGravity(e){this.world.gravity.set(e.x,e.y,e.z)}setTimeStep(e){this.world.timeStep=e}getTimeStep(){return this.world.timeStep}executeStep(e,t){for(const r of t)r.beforeStep();this.world.timeStep=this._useDeltaForWorldStep?e:this._fixedTimeStep,this.world.step();for(const r of t)r.afterStep(),this._tmpImpostorsArray[r.uniqueId]=r;let i=this.world.contacts;for(;i!==null;){if(i.touching&&!i.body1.sleeping&&!i.body2.sleeping){i=i.next;continue}const r=this._tmpImpostorsArray[+i.body1.name],n=this._tmpImpostorsArray[+i.body2.name];if(!r||!n){i=i.next;continue}r.onCollide({body:n.physicsBody,point:null,distance:0,impulse:0,normal:null}),n.onCollide({body:r.physicsBody,point:null,distance:0,impulse:0,normal:null}),i=i.next}}applyImpulse(e,t,i){const r=e.physicsBody.mass;e.physicsBody.applyImpulse(i.scale(this.world.invScale),t.scale(this.world.invScale*r))}applyForce(e,t,i){N.Warn("Oimo doesn't support applying force. Using impulse instead."),this.applyImpulse(e,t,i)}generatePhysicsBody(e){if(e.parent){e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());return}if(e.isBodyInitRequired()){const t={name:e.uniqueId,config:[e.getParam("mass")||.001,e.getParam("friction"),e.getParam("restitution")],size:[],type:[],pos:[],posShape:[],rot:[],rotShape:[],move:e.getParam("mass")!==0,density:e.getParam("mass"),friction:e.getParam("friction"),restitution:e.getParam("restitution"),world:this.world},i=[e];(o=>{if(!o.getChildMeshes)return;const l=o.getChildMeshes();for(const c of l)c.physicsImpostor&&i.push(c.physicsImpostor)})(e.object);const n=o=>Math.max(o,Ai),a=new Z;for(const o of i){if(!o.object.rotationQuaternion)continue;const l=o.object.rotationQuaternion;a.copyFrom(l),o.object.rotationQuaternion.set(0,0,0,1),o.object.computeWorldMatrix(!0);const c=a.toEulerAngles(),u=o.getObjectExtents(),h=57.29577951308232;if(o===e){const d=e.getObjectCenter();e.object.getAbsolutePivotPoint().subtractToRef(d,this._tmpPositionVector),this._tmpPositionVector.divideInPlace(e.object.scaling),t.pos.push(d.x),t.pos.push(d.y),t.pos.push(d.z),t.posShape.push(0,0,0),t.rotShape.push(0,0,0)}else{const d=o.object.position.clone();t.posShape.push(d.x),t.posShape.push(d.y),t.posShape.push(d.z),t.rotShape.push(c.x*h,c.y*h,c.z*h)}switch(o.object.rotationQuaternion.copyFrom(a),o.type){case ue.ParticleImpostor:N.Warn("No Particle support in OIMO.js. using SphereImpostor instead");case ue.SphereImpostor:{const d=u.x,f=u.y,m=u.z,g=Math.max(n(d),n(f),n(m))/2;t.type.push("sphere"),t.size.push(g),t.size.push(g),t.size.push(g);break}case ue.CylinderImpostor:{const d=n(u.x)/2,f=n(u.y);t.type.push("cylinder"),t.size.push(d),t.size.push(f),t.size.push(f);break}case ue.PlaneImpostor:case ue.BoxImpostor:default:{const d=n(u.x),f=n(u.y),m=n(u.z);t.type.push("box"),t.size.push(d),t.size.push(f),t.size.push(m);break}}o.object.rotationQuaternion=l}e.physicsBody=this.world.add(t),e.physicsBody.resetQuaternion(a),e.physicsBody.updatePosition(0)}else this._tmpPositionVector.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpPositionVector)}removePhysicsBody(e){this.world.removeRigidBody(e.physicsBody)}generateJoint(e){const t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;const r=e.joint.jointData,n=r.nativeParams||{};let a;const o={body1:t,body2:i,axe1:n.axe1||(r.mainAxis?r.mainAxis.asArray():null),axe2:n.axe2||(r.connectedAxis?r.connectedAxis.asArray():null),pos1:n.pos1||(r.mainPivot?r.mainPivot.asArray():null),pos2:n.pos2||(r.connectedPivot?r.connectedPivot.asArray():null),min:n.min,max:n.max,collision:n.collision||r.collision,spring:n.spring,world:this.world};switch(e.joint.type){case xt.BallAndSocketJoint:a="jointBall";break;case xt.SpringJoint:{N.Warn("OIMO.js doesn't support Spring Constraint. Simulating using DistanceJoint instead");const l=r;o.min=l.length||o.min,o.max=Math.max(o.min,o.max)}case xt.DistanceJoint:a="jointDistance",o.max=r.maxDistance;break;case xt.PrismaticJoint:a="jointPrisme";break;case xt.SliderJoint:a="jointSlide";break;case xt.WheelJoint:a="jointWheel";break;case xt.HingeJoint:default:a="jointHinge";break}o.type=a,e.joint.physicsJoint=this.world.add(o)}removeJoint(e){try{this.world.removeJoint(e.joint.physicsJoint)}catch(t){N.Warn(t)}}isSupported(){return this.BJSOIMO!==void 0}setTransformationFromPhysicsBody(e){if(!e.physicsBody.sleeping){if(e.physicsBody.shapes.next){let t=e.physicsBody.shapes;for(;t.next;)t=t.next;e.object.position.set(t.position.x,t.position.y,t.position.z)}else{const t=e.physicsBody.getPosition();e.object.position.set(t.x,t.y,t.z)}if(e.object.rotationQuaternion){const t=e.physicsBody.getQuaternion();e.object.rotationQuaternion.set(t.x,t.y,t.z,t.w)}}}setPhysicsBodyTransformation(e,t,i){const r=e.physicsBody;e.physicsBody.shapes.next||(r.position.set(t.x,t.y,t.z),r.orientation.set(i.x,i.y,i.z,i.w),r.syncShapes(),r.awake())}setLinearVelocity(e,t){e.physicsBody.linearVelocity.set(t.x,t.y,t.z)}setAngularVelocity(e,t){e.physicsBody.angularVelocity.set(t.x,t.y,t.z)}getLinearVelocity(e){const t=e.physicsBody.linearVelocity;return t?new x(t.x,t.y,t.z):null}getAngularVelocity(e){const t=e.physicsBody.angularVelocity;return t?new x(t.x,t.y,t.z):null}setBodyMass(e,t){const i=t===0;e.physicsBody.shapes.density=i?1:t,e.physicsBody.setupMass(i?2:1)}getBodyMass(e){return e.physicsBody.shapes.density}getBodyFriction(e){return e.physicsBody.shapes.friction}setBodyFriction(e,t){e.physicsBody.shapes.friction=t}getBodyRestitution(e){return e.physicsBody.shapes.restitution}setBodyRestitution(e,t){e.physicsBody.shapes.restitution=t}sleepBody(e){e.physicsBody.sleep()}wakeUpBody(e){e.physicsBody.awake()}updateDistanceJoint(e,t,i){e.physicsJoint.limitMotor.upperLimit=t,i!==void 0&&(e.physicsJoint.limitMotor.lowerLimit=i)}setMotor(e,t,i,r){i!==void 0?N.Warn("OimoJS plugin currently has unexpected behavior when using setMotor with force parameter"):i=1e6,t*=-1;const n=r?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;n&&n.setMotor(t,i)}setLimit(e,t,i,r){const n=r?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;n&&n.setLimit(t,i===void 0?-t:i)}syncMeshWithImpostor(e,t){const i=t.physicsBody;e.position.x=i.position.x,e.position.y=i.position.y,e.position.z=i.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=i.orientation.x,e.rotationQuaternion.y=i.orientation.y,e.rotationQuaternion.z=i.orientation.z,e.rotationQuaternion.w=i.orientation.w)}getRadius(e){return e.physicsBody.shapes.radius}getBoxSizeToRef(e,t){const i=e.physicsBody.shapes;t.x=i.halfWidth*2,t.y=i.halfHeight*2,t.z=i.halfDepth*2}dispose(){this.world.clear()}raycast(e,t){return N.Warn("raycast is not currently supported by the Oimo physics plugin"),this._raycastResult.reset(e,t),this._raycastResult}raycastToRef(e,t,i){N.Warn("raycast is not currently supported by the Oimo physics plugin"),i.reset(e,t)}}class Ls{constructor(e=!0,t=Ammo,i=null){if(this._useDeltaForWorldStep=e,this.bjsAMMO={},this.name="AmmoJSPlugin",this._timeStep=1/60,this._fixedTimeStep=1/60,this._maxSteps=5,this._tmpQuaternion=new Z,this._tmpContactCallbackResult=!1,this._tmpContactPoint=new x,this._tmpContactNormal=new x,this._tmpVec3=new x,this._tmpMatrix=new z,typeof t=="function"){N.Error("AmmoJS is not ready. Please make sure you await Ammo() before using the plugin.");return}else this.bjsAMMO=t;if(!this.isSupported()){N.Error("AmmoJS is not available. Please make sure you included the js file.");return}this._collisionConfiguration=new this.bjsAMMO.btSoftBodyRigidBodyCollisionConfiguration,this._dispatcher=new this.bjsAMMO.btCollisionDispatcher(this._collisionConfiguration),this._overlappingPairCache=i||new this.bjsAMMO.btDbvtBroadphase,this._solver=new this.bjsAMMO.btSequentialImpulseConstraintSolver,this._softBodySolver=new this.bjsAMMO.btDefaultSoftBodySolver,this.world=new this.bjsAMMO.btSoftRigidDynamicsWorld(this._dispatcher,this._overlappingPairCache,this._solver,this._collisionConfiguration,this._softBodySolver),this._tmpAmmoConcreteContactResultCallback=new this.bjsAMMO.ConcreteContactResultCallback,this._tmpAmmoConcreteContactResultCallback.addSingleResult=r=>{r=this.bjsAMMO.wrapPointer(r,this.bjsAMMO.btManifoldPoint);const n=r.getPositionWorldOnA(),a=r.m_normalWorldOnB;this._tmpContactPoint.x=n.x(),this._tmpContactPoint.y=n.y(),this._tmpContactPoint.z=n.z(),this._tmpContactNormal.x=a.x(),this._tmpContactNormal.y=a.y(),this._tmpContactNormal.z=a.z(),this._tmpContactImpulse=r.getAppliedImpulse(),this._tmpContactDistance=r.getDistance(),this._tmpContactCallbackResult=!0},this._raycastResult=new bh,this._tmpAmmoTransform=new this.bjsAMMO.btTransform,this._tmpAmmoTransform.setIdentity(),this._tmpAmmoQuaternion=new this.bjsAMMO.btQuaternion(0,0,0,1),this._tmpAmmoVectorA=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorB=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorC=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorD=new this.bjsAMMO.btVector3(0,0,0)}getPluginVersion(){return 1}setGravity(e){this._tmpAmmoVectorA.setValue(e.x,e.y,e.z),this.world.setGravity(this._tmpAmmoVectorA),this.world.getWorldInfo().set_m_gravity(this._tmpAmmoVectorA)}setTimeStep(e){this._timeStep=e}setFixedTimeStep(e){this._fixedTimeStep=e}setMaxSteps(e){this._maxSteps=e}getTimeStep(){return this._timeStep}_isImpostorInContact(e){return this._tmpContactCallbackResult=!1,this.world.contactTest(e.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult}_isImpostorPairInContact(e,t){return this._tmpContactCallbackResult=!1,this.world.contactPairTest(e.physicsBody,t.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult}_stepSimulation(e=1/60,t=10,i=1/60){if(t==0)this.world.stepSimulation(e,0);else for(;t>0&&e>0;)e-i<i?(this.world.stepSimulation(e,0),e=0):(e-=i,this.world.stepSimulation(i,0)),t--}executeStep(e,t){for(const i of t)i.soft||i.beforeStep();this._stepSimulation(this._useDeltaForWorldStep?e:this._timeStep,this._maxSteps,this._fixedTimeStep);for(const i of t)if(i.soft?this._afterSoftStep(i):i.afterStep(),i._onPhysicsCollideCallbacks.length>0&&this._isImpostorInContact(i))for(const r of i._onPhysicsCollideCallbacks)for(const n of r.otherImpostors)(i.physicsBody.isActive()||n.physicsBody.isActive())&&this._isImpostorPairInContact(i,n)&&(i.onCollide({body:n.physicsBody,point:this._tmpContactPoint,distance:this._tmpContactDistance,impulse:this._tmpContactImpulse,normal:this._tmpContactNormal}),n.onCollide({body:i.physicsBody,point:this._tmpContactPoint,distance:this._tmpContactDistance,impulse:this._tmpContactImpulse,normal:this._tmpContactNormal}))}_afterSoftStep(e){e.type===ue.RopeImpostor?this._ropeStep(e):this._softbodyOrClothStep(e)}_ropeStep(e){const t=e.physicsBody.get_m_nodes(),i=t.size();let r,n,a,o,l;const c=[];for(let d=0;d<i;d++)r=t.at(d),n=r.get_m_x(),a=n.x(),o=n.y(),l=n.z(),c.push(new x(a,o,l));const u=e.object,h=e.getParam("shape");e._isFromLine?e.object=mI("lines",{points:c,instance:u}):e.object=MD("ext",{shape:h,path:c,instance:u})}_softbodyOrClothStep(e){const t=e.type===ue.ClothImpostor?1:-1,i=e.object;let r=i.getVerticesData(M.PositionKind);r||(r=[]);let n=i.getVerticesData(M.NormalKind);n||(n=[]);const a=r.length/3,o=e.physicsBody.get_m_nodes();let l,c,u,h,d,f,m,g;for(let E=0;E<a;E++){l=o.at(E),c=l.get_m_x(),u=c.x(),h=c.y(),d=c.z()*t;const T=l.get_m_n();f=T.x(),m=T.y(),g=T.z()*t,r[3*E]=u,r[3*E+1]=h,r[3*E+2]=d,n[3*E]=f,n[3*E+1]=m,n[3*E+2]=g}const v=new li;v.positions=r,v.normals=n,v.uvs=i.getVerticesData(M.UVKind),v.colors=i.getVerticesData(M.ColorKind),i&&i.getIndices&&(v.indices=i.getIndices()),v.applyToMesh(i)}applyImpulse(e,t,i){if(e.soft)N.Warn("Cannot be applied to a soft body");else{e.physicsBody.activate();const r=this._tmpAmmoVectorA,n=this._tmpAmmoVectorB;e.object&&e.object.getWorldMatrix&&i.subtractInPlace(e.object.getWorldMatrix().getTranslation()),r.setValue(i.x,i.y,i.z),n.setValue(t.x,t.y,t.z),e.physicsBody.applyImpulse(n,r)}}applyForce(e,t,i){if(e.soft)N.Warn("Cannot be applied to a soft body");else{e.physicsBody.activate();const r=this._tmpAmmoVectorA,n=this._tmpAmmoVectorB;if(e.object&&e.object.getWorldMatrix){const a=e.object.getWorldMatrix().getTranslation();r.setValue(i.x-a.x,i.y-a.y,i.z-a.z)}else r.setValue(i.x,i.y,i.z);n.setValue(t.x,t.y,t.z),e.physicsBody.applyForce(n,r)}}generatePhysicsBody(e){if(e._pluginData.toDispose=[],e.parent){e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());return}if(e.isBodyInitRequired()){const t=this._createShape(e),i=e.getParam("mass");if(e._pluginData.mass=i,e.soft)t.get_m_cfg().set_collisions(17),t.get_m_cfg().set_kDP(e.getParam("damping")),this.bjsAMMO.castObject(t,this.bjsAMMO.btCollisionObject).getCollisionShape().setMargin(e.getParam("margin")),t.setActivationState(Ls._DISABLE_DEACTIVATION_FLAG),this.world.addSoftBody(t,1,-1),e.physicsBody=t,e._pluginData.toDispose.push(t),this.setBodyPressure(e,0),e.type===ue.SoftbodyImpostor&&this.setBodyPressure(e,e.getParam("pressure")),this.setBodyStiffness(e,e.getParam("stiffness")),this.setBodyVelocityIterations(e,e.getParam("velocityIterations")),this.setBodyPositionIterations(e,e.getParam("positionIterations"));else{const r=new this.bjsAMMO.btVector3(0,0,0),n=new this.bjsAMMO.btTransform;e.object.computeWorldMatrix(!0),n.setIdentity(),i!==0&&t.calculateLocalInertia(i,r),this._tmpAmmoVectorA.setValue(e.object.position.x,e.object.position.y,e.object.position.z),this._tmpAmmoQuaternion.setValue(e.object.rotationQuaternion.x,e.object.rotationQuaternion.y,e.object.rotationQuaternion.z,e.object.rotationQuaternion.w),n.setOrigin(this._tmpAmmoVectorA),n.setRotation(this._tmpAmmoQuaternion);const a=new this.bjsAMMO.btDefaultMotionState(n),o=new this.bjsAMMO.btRigidBodyConstructionInfo(i,a,t,r),l=new this.bjsAMMO.btRigidBody(o);if(i===0&&(l.setCollisionFlags(l.getCollisionFlags()|Ls._KINEMATIC_FLAG),l.setActivationState(Ls._DISABLE_DEACTIVATION_FLAG)),e.type==ue.NoImpostor&&!t.getChildShape&&l.setCollisionFlags(l.getCollisionFlags()|Ls._DISABLE_COLLISION_FLAG),e.type!==ue.MeshImpostor&&e.type!==ue.NoImpostor){const h=e.object.getBoundingInfo();this._tmpVec3.copyFrom(e.object.getAbsolutePosition()),this._tmpVec3.subtractInPlace(h.boundingBox.centerWorld),this._tmpVec3.x/=e.object.scaling.x,this._tmpVec3.y/=e.object.scaling.y,this._tmpVec3.z/=e.object.scaling.z,e.setDeltaPosition(this._tmpVec3)}const c=e.getParam("group"),u=e.getParam("mask");c&&u?this.world.addRigidBody(l,c,u):this.world.addRigidBody(l),e.physicsBody=l,e._pluginData.toDispose=e._pluginData.toDispose.concat([l,o,a,n,r,t])}this.setBodyRestitution(e,e.getParam("restitution")),this.setBodyFriction(e,e.getParam("friction"))}}removePhysicsBody(e){if(this.world&&(e.soft?this.world.removeSoftBody(e.physicsBody):this.world.removeRigidBody(e.physicsBody),e._pluginData)){for(const t of e._pluginData.toDispose)this.bjsAMMO.destroy(t);e._pluginData.toDispose=[]}}generateJoint(e){const t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i||e.joint.physicsJoint)return;const r=e.joint.jointData;r.mainPivot||(r.mainPivot=new x(0,0,0)),r.connectedPivot||(r.connectedPivot=new x(0,0,0));let n;switch(e.joint.type){case xt.DistanceJoint:{const a=r.maxDistance;a&&(r.mainPivot=new x(0,-a/2,0),r.connectedPivot=new x(0,a/2,0));const o=this._tmpAmmoVectorA;o.setValue(r.mainPivot.x,r.mainPivot.y,r.mainPivot.z);const l=this._tmpAmmoVectorB;l.setValue(r.connectedPivot.x,r.connectedPivot.y,r.connectedPivot.z),n=new this.bjsAMMO.btPoint2PointConstraint(t,i,o,l);break}case xt.HingeJoint:{r.mainAxis||(r.mainAxis=new x(0,0,0)),r.connectedAxis||(r.connectedAxis=new x(0,0,0));const a=this._tmpAmmoVectorA;a.setValue(r.mainPivot.x,r.mainPivot.y,r.mainPivot.z);const o=this._tmpAmmoVectorB;o.setValue(r.connectedPivot.x,r.connectedPivot.y,r.connectedPivot.z);const l=this._tmpAmmoVectorC;l.setValue(r.mainAxis.x,r.mainAxis.y,r.mainAxis.z);const c=this._tmpAmmoVectorD;c.setValue(r.connectedAxis.x,r.connectedAxis.y,r.connectedAxis.z),n=new this.bjsAMMO.btHingeConstraint(t,i,a,o,l,c);break}case xt.BallAndSocketJoint:{const a=this._tmpAmmoVectorA;a.setValue(r.mainPivot.x,r.mainPivot.y,r.mainPivot.z);const o=this._tmpAmmoVectorB;o.setValue(r.connectedPivot.x,r.connectedPivot.y,r.connectedPivot.z),n=new this.bjsAMMO.btPoint2PointConstraint(t,i,a,o);break}default:{N.Warn("JointType not currently supported by the Ammo plugin, falling back to PhysicsJoint.BallAndSocketJoint");const a=this._tmpAmmoVectorA;a.setValue(r.mainPivot.x,r.mainPivot.y,r.mainPivot.z);const o=this._tmpAmmoVectorB;o.setValue(r.connectedPivot.x,r.connectedPivot.y,r.connectedPivot.z),n=new this.bjsAMMO.btPoint2PointConstraint(t,i,a,o);break}}this.world.addConstraint(n,!e.joint.jointData.collision),e.joint.physicsJoint=n}removeJoint(e){this.world&&this.world.removeConstraint(e.joint.physicsJoint),this.bjsAMMO.destroy(e.joint.physicsJoint)}_addMeshVerts(e,t,i){let r=0;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){let n=i.getIndices();n||(n=[]);let a=i.getVerticesData(M.PositionKind);a||(a=[]);let o;if(t&&t!==i){let u;t.rotationQuaternion?u=t.rotationQuaternion:t.rotation?u=Z.FromEulerAngles(t.rotation.x,t.rotation.y,t.rotation.z):u=Z.Identity(),z.Compose(x.One(),u,t.position).invertToRef(this._tmpMatrix),o=i.computeWorldMatrix(!1).multiply(this._tmpMatrix)}else z.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,this._tmpMatrix),o=this._tmpMatrix;const l=n.length/3;for(let u=0;u<l;u++){const h=[];for(let d=0;d<3;d++){let f=new x(a[n[u*3+d]*3+0],a[n[u*3+d]*3+1],a[n[u*3+d]*3+2]);f=x.TransformCoordinates(f,o);let m;d==0?m=this._tmpAmmoVectorA:d==1?m=this._tmpAmmoVectorB:m=this._tmpAmmoVectorC,m.setValue(f.x,f.y,f.z),h.push(m)}e.addTriangle(h[0],h[1],h[2]),r++}const c=i.getChildMeshes();for(const u of c)r+=this._addMeshVerts(e,t,u)}return r}_softVertexData(e){const t=e.object;if(t&&t.getIndices&&t.getWorldMatrix&&t.getChildMeshes){t.getIndices();let i=t.getVerticesData(M.PositionKind);i||(i=[]);let r=t.getVerticesData(M.NormalKind);r||(r=[]),t.computeWorldMatrix(!1);const n=[],a=[];for(let l=0;l<i.length;l+=3){let c=new x(i[l],i[l+1],i[l+2]),u=new x(r[l],r[l+1],r[l+2]);c=x.TransformCoordinates(c,t.getWorldMatrix()),u=x.TransformNormal(u,t.getWorldMatrix()),n.push(c.x,c.y,c.z),a.push(u.x,u.y,u.z)}const o=new li;return o.positions=n,o.normals=a,o.uvs=t.getVerticesData(M.UVKind),o.colors=t.getVerticesData(M.ColorKind),t&&t.getIndices&&(o.indices=t.getIndices()),o.applyToMesh(t),t.position=x.Zero(),t.rotationQuaternion=null,t.rotation=x.Zero(),t.computeWorldMatrix(!0),o}return li.ExtractFromMesh(t)}_createSoftbody(e){const t=e.object;if(t&&t.getIndices){let i=t.getIndices();i||(i=[]);const r=this._softVertexData(e),n=r.positions,a=r.normals;if(n===null||a===null)return new this.bjsAMMO.btCompoundShape;{const o=[],l=[];for(let m=0;m<n.length;m+=3){const g=new x(n[m],n[m+1],n[m+2]),v=new x(a[m],a[m+1],a[m+2]);o.push(g.x,g.y,-g.z),l.push(v.x,v.y,-v.z)}const c=new this.bjsAMMO.btSoftBodyHelpers().CreateFromTriMesh(this.world.getWorldInfo(),o,t.getIndices(),i.length/3,!0),u=n.length/3,h=c.get_m_nodes();let d,f;for(let m=0;m<u;m++)d=h.at(m),f=d.get_m_n(),f.setX(l[3*m]),f.setY(l[3*m+1]),f.setZ(l[3*m+2]);return c}}}_createCloth(e){const t=e.object;if(t&&t.getIndices){t.getIndices();const i=this._softVertexData(e),r=i.positions,n=i.normals;if(r===null||n===null)return new this.bjsAMMO.btCompoundShape;{const a=r.length,o=Math.sqrt(a/3);e.segments=o;const l=o-1;return this._tmpAmmoVectorA.setValue(r[0],r[1],r[2]),this._tmpAmmoVectorB.setValue(r[3*l],r[3*l+1],r[3*l+2]),this._tmpAmmoVectorD.setValue(r[a-3],r[a-2],r[a-1]),this._tmpAmmoVectorC.setValue(r[a-3-3*l],r[a-2-3*l],r[a-1-3*l]),new this.bjsAMMO.btSoftBodyHelpers().CreatePatch(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,this._tmpAmmoVectorC,this._tmpAmmoVectorD,o,o,e.getParam("fixedPoints"),!0)}}}_createRope(e){let t,i;const r=this._softVertexData(e),n=r.positions,a=r.normals;if(n===null||a===null)return new this.bjsAMMO.btCompoundShape;r.applyToMesh(e.object,!0),e._isFromLine=!0;const o=a.map(d=>d*d),l=(d,f)=>d+f;if(o.reduce(l)===0)t=n.length,i=t/3-1,this._tmpAmmoVectorA.setValue(n[0],n[1],n[2]),this._tmpAmmoVectorB.setValue(n[t-3],n[t-2],n[t-1]);else{e._isFromLine=!1;const d=e.getParam("path");if(e.getParam("shape")===null)return N.Warn("No shape available for extruded mesh"),new this.bjsAMMO.btCompoundShape;t=d.length,i=t-1,this._tmpAmmoVectorA.setValue(d[0].x,d[0].y,d[0].z),this._tmpAmmoVectorB.setValue(d[t-1].x,d[t-1].y,d[t-1].z)}e.segments=i;let u=e.getParam("fixedPoints");u=u>3?3:u;const h=new this.bjsAMMO.btSoftBodyHelpers().CreateRope(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,i-1,u);return h.get_m_cfg().set_collisions(17),h}_createCustom(e){let t=null;return this.onCreateCustomShape&&(t=this.onCreateCustomShape(e)),t==null&&(t=new this.bjsAMMO.btCompoundShape),t}_addHullVerts(e,t,i){let r=0;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){let n=i.getIndices();n||(n=[]);let a=i.getVerticesData(M.PositionKind);a||(a=[]),i.computeWorldMatrix(!1);const o=n.length/3;for(let c=0;c<o;c++){const u=[];for(let h=0;h<3;h++){let d=new x(a[n[c*3+h]*3+0],a[n[c*3+h]*3+1],a[n[c*3+h]*3+2]);z.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,this._tmpMatrix),d=x.TransformCoordinates(d,this._tmpMatrix);let f;h==0?f=this._tmpAmmoVectorA:h==1?f=this._tmpAmmoVectorB:f=this._tmpAmmoVectorC,f.setValue(d.x,d.y,d.z),u.push(f)}e.addPoint(u[0],!0),e.addPoint(u[1],!0),e.addPoint(u[2],!0),r++}const l=i.getChildMeshes();for(const c of l)r+=this._addHullVerts(e,t,c)}return r}_createShape(e,t=!1){const i=e.object;let r;const n=e.getObjectExtents();if(!t){const a=e.object.getChildMeshes?e.object.getChildMeshes(!0):[];r=new this.bjsAMMO.btCompoundShape;let o=0;for(const l of a){const c=l.getPhysicsImpostor();if(c){if(c.type==ue.MeshImpostor)throw"A child MeshImpostor is not supported. Only primitive impostors are supported as children (eg. box or sphere)";const u=this._createShape(c),h=l.parent.getWorldMatrix().clone(),d=new x;h.decompose(d),this._tmpAmmoTransform.getOrigin().setValue(l.position.x*d.x,l.position.y*d.y,l.position.z*d.z),this._tmpAmmoQuaternion.setValue(l.rotationQuaternion.x,l.rotationQuaternion.y,l.rotationQuaternion.z,l.rotationQuaternion.w),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),r.addChildShape(this._tmpAmmoTransform,u),c.dispose(),o++}}if(o>0){if(e.type!=ue.NoImpostor){const l=this._createShape(e,!0);l&&(this._tmpAmmoTransform.getOrigin().setValue(0,0,0),this._tmpAmmoQuaternion.setValue(0,0,0,1),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),r.addChildShape(this._tmpAmmoTransform,l))}return r}else this.bjsAMMO.destroy(r),r=null}switch(e.type){case ue.SphereImpostor:if(fn(n.x,n.y,1e-4)&&fn(n.x,n.z,1e-4))r=new this.bjsAMMO.btSphereShape(n.x/2);else{this._tmpAmmoVectorA.setValue(0,0,0);const a=[this._tmpAmmoVectorA],o=[1];r=new this.bjsAMMO.btMultiSphereShape(a,o,1),this._tmpAmmoVectorA.setValue(n.x/2,n.y/2,n.z/2),r.setLocalScaling(this._tmpAmmoVectorA)}break;case ue.CapsuleImpostor:{const a=n.x/2;r=new this.bjsAMMO.btCapsuleShape(a,n.y-a*2)}break;case ue.CylinderImpostor:this._tmpAmmoVectorA.setValue(n.x/2,n.y/2,n.z/2),r=new this.bjsAMMO.btCylinderShape(this._tmpAmmoVectorA);break;case ue.PlaneImpostor:case ue.BoxImpostor:this._tmpAmmoVectorA.setValue(n.x/2,n.y/2,n.z/2),r=new this.bjsAMMO.btBoxShape(this._tmpAmmoVectorA);break;case ue.MeshImpostor:if(e.getParam("mass")==0){if(this.onCreateCustomMeshImpostor)r=this.onCreateCustomMeshImpostor(e);else{const a=new this.bjsAMMO.btTriangleMesh;e._pluginData.toDispose.push(a),this._addMeshVerts(a,i,i)==0?r=new this.bjsAMMO.btCompoundShape:r=new this.bjsAMMO.btBvhTriangleMeshShape(a)}break}case ue.ConvexHullImpostor:{if(this.onCreateCustomConvexHullImpostor)r=this.onCreateCustomConvexHullImpostor(e);else{const a=new this.bjsAMMO.btConvexHullShape;this._addHullVerts(a,i,i)==0?(e._pluginData.toDispose.push(a),r=new this.bjsAMMO.btCompoundShape):r=a}break}case ue.NoImpostor:r=new this.bjsAMMO.btSphereShape(n.x/2);break;case ue.CustomImpostor:r=this._createCustom(e);break;case ue.SoftbodyImpostor:r=this._createSoftbody(e);break;case ue.ClothImpostor:r=this._createCloth(e);break;case ue.RopeImpostor:r=this._createRope(e);break;default:N.Warn("The impostor type is not currently supported by the ammo plugin.");break}return r}setTransformationFromPhysicsBody(e){e.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),e.object.position.set(this._tmpAmmoTransform.getOrigin().x(),this._tmpAmmoTransform.getOrigin().y(),this._tmpAmmoTransform.getOrigin().z()),e.object.rotationQuaternion?e.object.rotationQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()):e.object.rotation&&(this._tmpQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()),this._tmpQuaternion.toEulerAnglesToRef(e.object.rotation))}setPhysicsBodyTransformation(e,t,i){const r=e.physicsBody.getWorldTransform();if(Math.abs(r.getOrigin().x()-t.x)>Ai||Math.abs(r.getOrigin().y()-t.y)>Ai||Math.abs(r.getOrigin().z()-t.z)>Ai||Math.abs(r.getRotation().x()-i.x)>Ai||Math.abs(r.getRotation().y()-i.y)>Ai||Math.abs(r.getRotation().z()-i.z)>Ai||Math.abs(r.getRotation().w()-i.w)>Ai)if(this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),r.setOrigin(this._tmpAmmoVectorA),this._tmpAmmoQuaternion.setValue(i.x,i.y,i.z,i.w),r.setRotation(this._tmpAmmoQuaternion),e.physicsBody.setWorldTransform(r),e.mass==0){const n=e.physicsBody.getMotionState();n&&n.setWorldTransform(r)}else e.physicsBody.activate()}isSupported(){return this.bjsAMMO!==void 0}setLinearVelocity(e,t){this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),e.soft?e.physicsBody.linearVelocity(this._tmpAmmoVectorA):e.physicsBody.setLinearVelocity(this._tmpAmmoVectorA)}setAngularVelocity(e,t){this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),e.soft?e.physicsBody.angularVelocity(this._tmpAmmoVectorA):e.physicsBody.setAngularVelocity(this._tmpAmmoVectorA)}getLinearVelocity(e){let t;if(e.soft?t=e.physicsBody.linearVelocity():t=e.physicsBody.getLinearVelocity(),!t)return null;const i=new x(t.x(),t.y(),t.z());return this.bjsAMMO.destroy(t),i}getAngularVelocity(e){let t;if(e.soft?t=e.physicsBody.angularVelocity():t=e.physicsBody.getAngularVelocity(),!t)return null;const i=new x(t.x(),t.y(),t.z());return this.bjsAMMO.destroy(t),i}setBodyMass(e,t){e.soft?e.physicsBody.setTotalMass(t,!1):e.physicsBody.setMassProps(t),e._pluginData.mass=t}getBodyMass(e){return e._pluginData.mass||0}getBodyFriction(e){return e._pluginData.friction||0}setBodyFriction(e,t){e.soft?e.physicsBody.get_m_cfg().set_kDF(t):e.physicsBody.setFriction(t),e._pluginData.friction=t}getBodyRestitution(e){return e._pluginData.restitution||0}setBodyRestitution(e,t){e.physicsBody.setRestitution(t),e._pluginData.restitution=t}getBodyPressure(e){return e.soft?e._pluginData.pressure||0:(N.Warn("Pressure is not a property of a rigid body"),0)}setBodyPressure(e,t){e.soft?e.type===ue.SoftbodyImpostor?(e.physicsBody.get_m_cfg().set_kPR(t),e._pluginData.pressure=t):(e.physicsBody.get_m_cfg().set_kPR(0),e._pluginData.pressure=0):N.Warn("Pressure can only be applied to a softbody")}getBodyStiffness(e){return e.soft?e._pluginData.stiffness||0:(N.Warn("Stiffness is not a property of a rigid body"),0)}setBodyStiffness(e,t){e.soft?(t=t<0?0:t,t=t>1?1:t,e.physicsBody.get_m_materials().at(0).set_m_kLST(t),e._pluginData.stiffness=t):N.Warn("Stiffness cannot be applied to a rigid body")}getBodyVelocityIterations(e){return e.soft?e._pluginData.velocityIterations||0:(N.Warn("Velocity iterations is not a property of a rigid body"),0)}setBodyVelocityIterations(e,t){e.soft?(t=t<0?0:t,e.physicsBody.get_m_cfg().set_viterations(t),e._pluginData.velocityIterations=t):N.Warn("Velocity iterations cannot be applied to a rigid body")}getBodyPositionIterations(e){return e.soft?e._pluginData.positionIterations||0:(N.Warn("Position iterations is not a property of a rigid body"),0)}setBodyPositionIterations(e,t){e.soft?(t=t<0?0:t,e.physicsBody.get_m_cfg().set_piterations(t),e._pluginData.positionIterations=t):N.Warn("Position iterations cannot be applied to a rigid body")}appendAnchor(e,t,i,r,n=1,a=!1){const o=e.segments,l=Math.round((o-1)*i),c=Math.round((o-1)*r),u=o-1-c,h=l+o*u;e.physicsBody.appendAnchor(h,t.physicsBody,a,n)}appendHook(e,t,i,r=1,n=!1){const a=Math.round(e.segments*i);e.physicsBody.appendAnchor(a,t.physicsBody,n,r)}sleepBody(e){e.physicsBody.forceActivationState(0)}wakeUpBody(e){e.physicsBody.activate()}updateDistanceJoint(){N.Warn("updateDistanceJoint is not currently supported by the Ammo physics plugin")}setMotor(e,t,i){e.physicsJoint.enableAngularMotor(!0,t,i)}setLimit(){N.Warn("setLimit is not currently supported by the Ammo physics plugin")}syncMeshWithImpostor(e,t){t.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),e.position.x=this._tmpAmmoTransform.getOrigin().x(),e.position.y=this._tmpAmmoTransform.getOrigin().y(),e.position.z=this._tmpAmmoTransform.getOrigin().z(),e.rotationQuaternion&&(e.rotationQuaternion.x=this._tmpAmmoTransform.getRotation().x(),e.rotationQuaternion.y=this._tmpAmmoTransform.getRotation().y(),e.rotationQuaternion.z=this._tmpAmmoTransform.getRotation().z(),e.rotationQuaternion.w=this._tmpAmmoTransform.getRotation().w())}getRadius(e){return e.getObjectExtents().x/2}getBoxSizeToRef(e,t){const i=e.getObjectExtents();t.x=i.x,t.y=i.y,t.z=i.z}dispose(){this.bjsAMMO.destroy(this.world),this.bjsAMMO.destroy(this._softBodySolver),this.bjsAMMO.destroy(this._solver),this.bjsAMMO.destroy(this._overlappingPairCache),this.bjsAMMO.destroy(this._dispatcher),this.bjsAMMO.destroy(this._collisionConfiguration),this.bjsAMMO.destroy(this._tmpAmmoVectorA),this.bjsAMMO.destroy(this._tmpAmmoVectorB),this.bjsAMMO.destroy(this._tmpAmmoVectorC),this.bjsAMMO.destroy(this._tmpAmmoVectorD),this.bjsAMMO.destroy(this._tmpAmmoTransform),this.bjsAMMO.destroy(this._tmpAmmoQuaternion),this.bjsAMMO.destroy(this._tmpAmmoConcreteContactResultCallback),this.world=null}raycast(e,t){return this.raycastToRef(e,t,this._raycastResult),this._raycastResult}raycastToRef(e,t,i){this._tmpAmmoVectorRCA=new this.bjsAMMO.btVector3(e.x,e.y,e.z),this._tmpAmmoVectorRCB=new this.bjsAMMO.btVector3(t.x,t.y,t.z);const r=new this.bjsAMMO.ClosestRayResultCallback(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB);this.world.rayTest(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB,r),i.reset(e,t),r.hasHit()&&(i.setHitData({x:r.get_m_hitNormalWorld().x(),y:r.get_m_hitNormalWorld().y(),z:r.get_m_hitNormalWorld().z()},{x:r.get_m_hitPointWorld().x(),y:r.get_m_hitPointWorld().y(),z:r.get_m_hitPointWorld().z()}),i.calculateHitDistance()),this.bjsAMMO.destroy(r),this.bjsAMMO.destroy(this._tmpAmmoVectorRCA),this.bjsAMMO.destroy(this._tmpAmmoVectorRCB)}}Ls._DISABLE_COLLISION_FLAG=4;Ls._KINEMATIC_FLAG=2;Ls._DISABLE_DEACTIVATION_FLAG=4;le.prototype.removeReflectionProbe=function(s){if(!this.reflectionProbes)return-1;const e=this.reflectionProbes.indexOf(s);return e!==-1&&this.reflectionProbes.splice(e,1),e};le.prototype.addReflectionProbe=function(s){this.reflectionProbes||(this.reflectionProbes=[]),this.reflectionProbes.push(s)};class cc{constructor(e,t,i,r=!0,n=!1,a=!1){if(this.name=e,this._viewMatrix=z.Identity(),this._target=x.Zero(),this._add=x.Zero(),this._invertYAxis=!1,this.position=x.Zero(),this.metadata=null,this._parentContainer=null,this._scene=i,i.getEngine().supportsUniformBuffers){this._sceneUBOs=[];for(let u=0;u<6;++u)this._sceneUBOs.push(i.createSceneUniformBuffer(`Scene for Reflection Probe (name "${e}") face #${u}`))}this._scene.reflectionProbes||(this._scene.reflectionProbes=[]),this._scene.reflectionProbes.push(this);let o=0;if(n){const u=this._scene.getEngine().getCaps();u.textureHalfFloatRender?o=2:u.textureFloatRender&&(o=1)}this._renderTargetTexture=new Zi(e,t,i,r,!0,o,!0),this._renderTargetTexture.gammaSpace=!a,this._renderTargetTexture.invertZ=i.useRightHandedSystem;const l=i.getEngine().useReverseDepthBuffer;this._renderTargetTexture.onBeforeRenderObservable.add(u=>{switch(this._sceneUBOs&&(i.setSceneUniformBuffer(this._sceneUBOs[u]),i.getSceneUniformBuffer().unbindEffect()),u){case 0:this._add.copyFromFloats(1,0,0);break;case 1:this._add.copyFromFloats(-1,0,0);break;case 2:this._add.copyFromFloats(0,this._invertYAxis?1:-1,0);break;case 3:this._add.copyFromFloats(0,this._invertYAxis?-1:1,0);break;case 4:this._add.copyFromFloats(0,0,i.useRightHandedSystem?-1:1);break;case 5:this._add.copyFromFloats(0,0,i.useRightHandedSystem?1:-1);break}this._attachedMesh&&this.position.copyFrom(this._attachedMesh.getAbsolutePosition()),this.position.addToRef(this._add,this._target);const h=i.useRightHandedSystem?z.LookAtRHToRef:z.LookAtLHToRef,d=i.useRightHandedSystem?z.PerspectiveFovRH:z.PerspectiveFovLH;h(this.position,this._target,x.Up(),this._viewMatrix),i.activeCamera&&(this._projectionMatrix=d(Math.PI/2,1,l?i.activeCamera.maxZ:i.activeCamera.minZ,l?i.activeCamera.minZ:i.activeCamera.maxZ,this._scene.getEngine().isNDCHalfZRange),i.setTransformMatrix(this._viewMatrix,this._projectionMatrix),i.activeCamera.isRigCamera&&!this._renderTargetTexture.activeCamera&&(this._renderTargetTexture.activeCamera=i.activeCamera.rigParent||null)),i._forcedViewPosition=this.position});let c;this._renderTargetTexture.onBeforeBindObservable.add(()=>{var u,h;this._currentSceneUBO=i.getSceneUniformBuffer(),(h=(u=i.getEngine())._debugPushGroup)==null||h.call(u,`reflection probe generation for ${e}`,1),c=this._scene.imageProcessingConfiguration.applyByPostProcess,a&&(i.imageProcessingConfiguration.applyByPostProcess=!0)}),this._renderTargetTexture.onAfterUnbindObservable.add(()=>{var u,h;i.imageProcessingConfiguration.applyByPostProcess=c,i._forcedViewPosition=null,this._sceneUBOs&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(!0),(h=(u=i.getEngine())._debugPopGroup)==null||h.call(u,1)})}get samples(){return this._renderTargetTexture.samples}set samples(e){this._renderTargetTexture.samples=e}get refreshRate(){return this._renderTargetTexture.refreshRate}set refreshRate(e){this._renderTargetTexture.refreshRate=e}getScene(){return this._scene}get cubeTexture(){return this._renderTargetTexture}get renderList(){return this._renderTargetTexture.renderList}set renderList(e){this._renderTargetTexture.renderList=e}attachToMesh(e){this._attachedMesh=e}setRenderingAutoClearDepthStencil(e,t){this._renderTargetTexture.setRenderingAutoClearDepthStencil(e,t)}dispose(){const e=this._scene.reflectionProbes.indexOf(this);if(e!==-1&&this._scene.reflectionProbes.splice(e,1),this._parentContainer){const t=this._parentContainer.reflectionProbes.indexOf(this);t>-1&&this._parentContainer.reflectionProbes.splice(t,1),this._parentContainer=null}if(this._renderTargetTexture&&(this._renderTargetTexture.dispose(),this._renderTargetTexture=null),this._sceneUBOs){for(const t of this._sceneUBOs)t.dispose();this._sceneUBOs=[]}}toString(e){let t="Name: "+this.name;return e&&(t+=", position: "+this.position.toString(),this._attachedMesh&&(t+=", attached mesh: "+this._attachedMesh.name)),t}getClassName(){return"ReflectionProbe"}serialize(){const e=me.Serialize(this,this._renderTargetTexture.serialize());return e.isReflectionProbe=!0,e.metadata=this.metadata,e}static Parse(e,t,i){let r=null;if(t.reflectionProbes)for(let n=0;n<t.reflectionProbes.length;n++){const a=t.reflectionProbes[n];if(a.name===e.name){r=a;break}}return r=me.Parse(()=>r||new cc(e.name,e.renderTargetSize,t,e._generateMipMaps),e,t,i),r.cubeTexture._waitingRenderList=e.renderList,e._attachedMesh&&r.attachToMesh(t.getMeshById(e._attachedMesh)),e.metadata&&(r.metadata=e.metadata),r}}_([Mm()],cc.prototype,"_attachedMesh",void 0);_([Cn()],cc.prototype,"position",void 0);class F3{get animationStarted(){return this._animationStarted}get fromIndex(){return this._fromIndex}get toIndex(){return this._toIndex}get loopAnimation(){return this._loopAnimation}get delay(){return Math.max(this._delay,1)}constructor(){this.width=1,this.height=1,this.angle=0,this.invertU=!1,this.invertV=!1,this.isVisible=!0,this._animationStarted=!1,this._loopAnimation=!1,this._fromIndex=0,this._toIndex=0,this._delay=0,this._direction=1,this._time=0,this._onBaseAnimationEnd=null,this.position={x:1,y:1,z:1},this.color={r:1,g:1,b:1,a:1}}playAnimation(e,t,i,r,n){this._fromIndex=e,this._toIndex=t,this._loopAnimation=i,this._delay=r||1,this._animationStarted=!0,this._onBaseAnimationEnd=n,e<t?this._direction=1:(this._direction=-1,this._toIndex=e,this._fromIndex=t),this.cellIndex=e,this._time=0}stopAnimation(){this._animationStarted=!1}_animate(e){this._animationStarted&&(this._time+=e,this._time>this._delay&&(this._time=this._time%this._delay,this.cellIndex+=this._direction,(this._direction>0&&this.cellIndex>this._toIndex||this._direction<0&&this.cellIndex<this._fromIndex)&&(this._loopAnimation?this.cellIndex=this._direction>0?this._fromIndex:this._toIndex:(this.cellIndex=this._toIndex,this._animationStarted=!1,this._onBaseAnimationEnd&&this._onBaseAnimationEnd()))))}}class L_ extends F3{get size(){return this.width}set size(e){this.width=e,this.height=e}get manager(){return this._manager}constructor(e,t){super(),this.name=e,this.animations=new Array,this.isPickable=!1,this.useAlphaForPicking=!1,this.onDisposeObservable=new k,this._onAnimationEnd=null,this._endAnimation=()=>{this._onAnimationEnd&&this._onAnimationEnd(),this.disposeWhenFinishedAnimating&&this.dispose()},this.color=new Te(1,1,1,1),this.position=x.Zero(),this._manager=t,this._manager.sprites.push(this),this.uniqueId=this._manager.scene.getUniqueId()}getClassName(){return"Sprite"}get fromIndex(){return this._fromIndex}set fromIndex(e){this.playAnimation(e,this._toIndex,this._loopAnimation,this._delay,this._onAnimationEnd)}get toIndex(){return this._toIndex}set toIndex(e){this.playAnimation(this._fromIndex,e,this._loopAnimation,this._delay,this._onAnimationEnd)}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){this.playAnimation(this._fromIndex,this._toIndex,e,this._delay,this._onAnimationEnd)}get delay(){return Math.max(this._delay,1)}set delay(e){this.playAnimation(this._fromIndex,this._toIndex,this._loopAnimation,e,this._onAnimationEnd)}playAnimation(e,t,i,r,n=null){this._onAnimationEnd=n,super.playAnimation(e,t,i,r,this._endAnimation)}dispose(){for(let e=0;e<this._manager.sprites.length;e++)this._manager.sprites[e]==this&&this._manager.sprites.splice(e,1);this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}serialize(){const e={};return e.name=this.name,e.position=this.position.asArray(),e.color=this.color.asArray(),e.width=this.width,e.height=this.height,e.angle=this.angle,e.cellIndex=this.cellIndex,e.cellRef=this.cellRef,e.invertU=this.invertU,e.invertV=this.invertV,e.disposeWhenFinishedAnimating=this.disposeWhenFinishedAnimating,e.isPickable=this.isPickable,e.isVisible=this.isVisible,e.useAlphaForPicking=this.useAlphaForPicking,e.animationStarted=this.animationStarted,e.fromIndex=this.fromIndex,e.toIndex=this.toIndex,e.loopAnimation=this.loopAnimation,e.delay=this.delay,e}static Parse(e,t){const i=new L_(e.name,t);return i.position=x.FromArray(e.position),i.color=Te.FromArray(e.color),i.width=e.width,i.height=e.height,i.angle=e.angle,i.cellIndex=e.cellIndex,i.cellRef=e.cellRef,i.invertU=e.invertU,i.invertV=e.invertV,i.disposeWhenFinishedAnimating=e.disposeWhenFinishedAnimating,i.isPickable=e.isPickable,i.isVisible=e.isVisible,i.useAlphaForPicking=e.useAlphaForPicking,i._fromIndex=e.fromIndex,i._toIndex=e.toIndex,i._loopAnimation=e.loopAnimation,i._delay=e.delay,e.animationStarted&&i.playAnimation(i.fromIndex,i.toIndex,i.loopAnimation,i.delay),i}}Object.defineProperty(le.prototype,"onNewSpriteManagerAddedObservable",{get:function(){if(!this.isDisposed&&!this._onNewSpriteManagerAddedObservable){const s=this._onNewSpriteManagerAddedObservable=new k;this.onDisposeObservable.addOnce(()=>s.clear())}return this._onNewSpriteManagerAddedObservable},enumerable:!0,configurable:!0});Object.defineProperty(le.prototype,"onSpriteManagerRemovedObservable",{get:function(){if(!this.isDisposed&&!this._onSpriteManagerRemovedObservable){const s=this._onSpriteManagerRemovedObservable=new k;this.onDisposeObservable.addOnce(()=>s.clear())}return this._onSpriteManagerRemovedObservable},enumerable:!0,configurable:!0});le.prototype._internalPickSprites=function(s,e,t,i){if(!Li)return null;let r=null;if(!i){if(!this.activeCamera)return null;i=this.activeCamera}if(this.spriteManagers&&this.spriteManagers.length>0)for(let n=0;n<this.spriteManagers.length;n++){const a=this.spriteManagers[n];if(!a.isPickable)continue;const o=a.intersects(s,i,e,t);if(!(!o||!o.hit)&&!(!t&&r!=null&&o.distance>=r.distance)&&(r=o,t))break}return r||new Li};le.prototype._internalMultiPickSprites=function(s,e,t){if(!Li)return null;let i=[];if(!t){if(!this.activeCamera)return null;t=this.activeCamera}if(this.spriteManagers&&this.spriteManagers.length>0)for(let r=0;r<this.spriteManagers.length;r++){const n=this.spriteManagers[r];if(!n.isPickable)continue;const a=n.multiIntersects(s,t,e);a!==null&&(i=i.concat(a))}return i};le.prototype.pickSprite=function(s,e,t,i,r){if(!this._tempSpritePickingRay)return null;zu(this,s,e,this._tempSpritePickingRay,r);const n=this._internalPickSprites(this._tempSpritePickingRay,t,i,r);return n&&(n.ray=YI(this,s,e,r)),n};le.prototype.pickSpriteWithRay=function(s,e,t,i){if(!this._tempSpritePickingRay)return null;if(!i){if(!this.activeCamera)return null;i=this.activeCamera}xe.TransformToRef(s,i.getViewMatrix(),this._tempSpritePickingRay);const r=this._internalPickSprites(this._tempSpritePickingRay,e,t,i);return r&&(r.ray=s),r};le.prototype.multiPickSprite=function(s,e,t,i){return zu(this,s,e,this._tempSpritePickingRay,i),this._internalMultiPickSprites(this._tempSpritePickingRay,t,i)};le.prototype.multiPickSpriteWithRay=function(s,e,t){if(!this._tempSpritePickingRay)return null;if(!t){if(!this.activeCamera)return null;t=this.activeCamera}return xe.TransformToRef(s,t.getViewMatrix(),this._tempSpritePickingRay),this._internalMultiPickSprites(this._tempSpritePickingRay,e,t)};le.prototype.setPointerOverSprite=function(s){this._pointerOverSprite!==s&&(this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(10,ys.CreateNewFromSprite(this._pointerOverSprite,this)),this._pointerOverSprite=s,this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(9,ys.CreateNewFromSprite(this._pointerOverSprite,this)))};le.prototype.getPointerOverSprite=function(){return this._pointerOverSprite};class L3{constructor(e){this.name=se.NAME_SPRITE,this.scene=e,this.scene.spriteManagers=[],this.scene._tempSpritePickingRay=xe?xe.Zero():null,this.scene.onBeforeSpritesRenderingObservable=new k,this.scene.onAfterSpritesRenderingObservable=new k,this._spritePredicate=t=>t.actionManager?t.isPickable&&t.actionManager.hasPointerTriggers:!1}register(){this.scene._pointerMoveStage.registerStep(se.STEP_POINTERMOVE_SPRITE,this,this._pointerMove),this.scene._pointerDownStage.registerStep(se.STEP_POINTERDOWN_SPRITE,this,this._pointerDown),this.scene._pointerUpStage.registerStep(se.STEP_POINTERUP_SPRITE,this,this._pointerUp)}rebuild(){}dispose(){this.scene.onBeforeSpritesRenderingObservable.clear(),this.scene.onAfterSpritesRenderingObservable.clear();const e=this.scene.spriteManagers;if(e)for(;e.length;)e[0].dispose()}_pickSpriteButKeepRay(e,t,i,r,n){const a=this.scene.pickSprite(t,i,this._spritePredicate,r,n);return a&&(a.ray=e?e.ray:null),a}_pointerMove(e,t,i,r,n){const a=this.scene;return r?a.setPointerOverSprite(null):(i=this._pickSpriteButKeepRay(i,e,t,!1,a.cameraToUseForPointers||void 0),i&&i.hit&&i.pickedSprite?(a.setPointerOverSprite(i.pickedSprite),!a.doNotHandleCursors&&n&&(a._pointerOverSprite&&a._pointerOverSprite.actionManager&&a._pointerOverSprite.actionManager.hoverCursor?n.style.cursor=a._pointerOverSprite.actionManager.hoverCursor:n.style.cursor=a.hoverCursor)):a.setPointerOverSprite(null)),i}_pointerDown(e,t,i,r){const n=this.scene;if(n._pickedDownSprite=null,n.spriteManagers&&n.spriteManagers.length>0&&(i=n.pickSprite(e,t,this._spritePredicate,!1,n.cameraToUseForPointers||void 0),i&&i.hit&&i.pickedSprite&&i.pickedSprite.actionManager)){switch(n._pickedDownSprite=i.pickedSprite,r.button){case 0:i.pickedSprite.actionManager.processTrigger(2,ys.CreateNewFromSprite(i.pickedSprite,n,r));break;case 1:i.pickedSprite.actionManager.processTrigger(4,ys.CreateNewFromSprite(i.pickedSprite,n,r));break;case 2:i.pickedSprite.actionManager.processTrigger(3,ys.CreateNewFromSprite(i.pickedSprite,n,r));break}i.pickedSprite.actionManager&&i.pickedSprite.actionManager.processTrigger(5,ys.CreateNewFromSprite(i.pickedSprite,n,r))}return i}_pointerUp(e,t,i,r,n){const a=this.scene;if(a.spriteManagers&&a.spriteManagers.length>0){const o=a.pickSprite(e,t,this._spritePredicate,!1,a.cameraToUseForPointers||void 0);o&&(o.hit&&o.pickedSprite&&o.pickedSprite.actionManager&&(o.pickedSprite.actionManager.processTrigger(7,ys.CreateNewFromSprite(o.pickedSprite,a,r)),o.pickedSprite.actionManager&&(this.scene._inputManager._isPointerSwiping()||o.pickedSprite.actionManager.processTrigger(1,ys.CreateNewFromSprite(o.pickedSprite,a,r)),n&&o.pickedSprite.actionManager.processTrigger(6,ys.CreateNewFromSprite(o.pickedSprite,a,r)))),a._pickedDownSprite&&a._pickedDownSprite.actionManager&&a._pickedDownSprite!==o.pickedSprite&&a._pickedDownSprite.actionManager.processTrigger(16,ys.CreateNewFromSprite(a._pickedDownSprite,a,r)))}return i}}class Ch{get fogEnabled(){return this._fogEnabled}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this._createEffects())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){var i;const t=!!((i=this._scene)!=null&&i.getEngine().getCaps().fragmentDepthSupported);e&&!t&&N.Warn("Logarithmic depth has been requested for a sprite renderer on a device that doesn't support it."),this._useLogarithmicDepth=e&&t,this._createEffects()}get capacity(){return this._capacity}get pixelPerfect(){return this._pixelPerfect}set pixelPerfect(e){this._pixelPerfect!==e&&(this._pixelPerfect=e,this._createEffects())}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i=.01,r=null,n){this.blendMode=2,this.autoResetAlpha=!0,this.disableDepthWrite=!1,this._fogEnabled=!0,this._pixelPerfect=!1,this._shaderLanguage=0,this._useVAO=!1,this._useInstancing=!1,this._vertexBuffers={},this._isDisposed=!1,this._shadersLoaded=!1,this._pixelPerfect=(n==null?void 0:n.pixelPerfect)??!1,this._capacity=t,this._epsilon=i,this._engine=e,this._useInstancing=e.getCaps().instancedArrays&&e._features.supportSpriteInstancing,this._useVAO=e.getCaps().vertexArrayObject&&!e.disableVertexArrayObjects,this._scene=r,this._useInstancing||this._buildIndexBuffer(),this._vertexBufferSize=this._useInstancing?16:18,this._vertexData=new Float32Array(t*this._vertexBufferSize*(this._useInstancing?1:4)),this._buffer=new gr(e,this._vertexData,!0,this._vertexBufferSize);const a=this._buffer.createVertexBuffer(M.PositionKind,0,4,this._vertexBufferSize,this._useInstancing),o=this._buffer.createVertexBuffer("options",4,2,this._vertexBufferSize,this._useInstancing);let l=6,c;if(this._useInstancing){const f=new Float32Array([this._epsilon,this._epsilon,1-this._epsilon,this._epsilon,this._epsilon,1-this._epsilon,1-this._epsilon,1-this._epsilon]);this._spriteBuffer=new gr(e,f,!1,2),c=this._spriteBuffer.createVertexBuffer("offsets",0,2)}else c=this._buffer.createVertexBuffer("offsets",l,2,this._vertexBufferSize,this._useInstancing),l+=2;const u=this._buffer.createVertexBuffer("inverts",l,2,this._vertexBufferSize,this._useInstancing),h=this._buffer.createVertexBuffer("cellInfo",l+2,4,this._vertexBufferSize,this._useInstancing),d=this._buffer.createVertexBuffer(M.ColorKind,l+6,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[M.PositionKind]=a,this._vertexBuffers.options=o,this._vertexBuffers.offsets=c,this._vertexBuffers.inverts=u,this._vertexBuffers.cellInfo=h,this._vertexBuffers[M.ColorKind]=d,this._initShaderSourceAsync()}async _initShaderSourceAsync(){this._engine.isWebGPU&&!Ch.ForceGLSL?(this._shaderLanguage=1,await Promise.all([U(()=>Promise.resolve().then(()=>v6),void 0),U(()=>Promise.resolve().then(()=>g6),void 0)])):await Promise.all([U(()=>Promise.resolve().then(()=>p6),void 0),U(()=>Promise.resolve().then(()=>d6),void 0)]),this._shadersLoaded=!0,this._createEffects()}_createEffects(){var t,i;if(this._isDisposed||!this._shadersLoaded)return;(t=this._drawWrapperBase)==null||t.dispose(),(i=this._drawWrapperDepth)==null||i.dispose(),this._drawWrapperBase=new gn(this._engine),this._drawWrapperDepth=new gn(this._engine,!1),this._drawWrapperBase.drawContext&&(this._drawWrapperBase.drawContext.useInstancing=this._useInstancing),this._drawWrapperDepth.drawContext&&(this._drawWrapperDepth.drawContext.useInstancing=this._useInstancing);let e="";this._pixelPerfect&&(e+=`#define PIXEL_PERFECT
`),this._scene&&this._scene.fogEnabled&&this._scene.fogMode!==0&&this._fogEnabled&&(e+=`#define FOG
`),this._useLogarithmicDepth&&(e+=`#define LOGARITHMICDEPTH
`),this._drawWrapperBase.effect=this._engine.createEffect("sprites",[M.PositionKind,"options","offsets","inverts","cellInfo",M.ColorKind],["view","projection","textureInfos","alphaTest","vFogInfos","vFogColor","logarithmicDepthConstant"],["diffuseSampler"],e,void 0,void 0,void 0,void 0,this._shaderLanguage),this._drawWrapperDepth.effect=this._drawWrapperBase.effect,this._drawWrapperBase.effect._refCount++,this._drawWrapperDepth.materialContext=this._drawWrapperBase.materialContext}render(e,t,i,r,n=null){if(!this._shadersLoaded||!this.texture||!this.texture.isReady()||!e.length)return;const a=this._drawWrapperBase,o=this._drawWrapperDepth,l=this.fogEnabled&&this._scene&&this._scene.fogEnabled&&this._scene.fogMode!==0,c=a.effect;if(!c.isReady())return;const u=this._engine,h=!!(this._scene&&this._scene.useRightHandedSystem),d=Math.min(this._capacity,e.length);let f=0,m=!0;for(let T=0;T<d;T++){const C=e[T];if(!C||!C.isVisible)continue;m=!1,C._animate(t);const A=this.texture.getBaseSize();this._appendSpriteVertex(f++,C,0,0,A,h,n),this._useInstancing||(this._appendSpriteVertex(f++,C,1,0,A,h,n),this._appendSpriteVertex(f++,C,1,1,A,h,n),this._appendSpriteVertex(f++,C,0,1,A,h,n))}if(m)return;this._buffer.update(this._vertexData);const g=!!u.depthCullingState.cull,v=u.depthCullingState.zOffset,E=u.depthCullingState.zOffsetUnits;if(u.setState(g,v,!1,!1,void 0,void 0,E),u.enableEffect(a),c.setTexture("diffuseSampler",this.texture),c.setMatrix("view",i),c.setMatrix("projection",r),l){const T=this._scene;c.setFloat4("vFogInfos",T.fogMode,T.fogStart,T.fogEnd,T.fogDensity),c.setColor3("vFogColor",T.fogColor)}this.useLogarithmicDepth&&this._scene&&Vo(a.defines,c,this._scene),this._useVAO?(this._vertexArrayObject||(this._vertexArrayObject=u.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,c)),u.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):u.bindBuffers(this._vertexBuffers,this._indexBuffer,c),u.depthCullingState.depthFunc=u.useReverseDepthBuffer?518:515,this.disableDepthWrite||(c.setBool("alphaTest",!0),u.setColorWrite(!1),u.enableEffect(o),this._useInstancing?u.drawArraysType(7,0,4,f):u.drawElementsType(0,0,f/4*6),u.enableEffect(a),u.setColorWrite(!0),c.setBool("alphaTest",!1)),u.setAlphaMode(this.blendMode),this._useInstancing?u.drawArraysType(7,0,4,f):u.drawElementsType(0,0,f/4*6),this.autoResetAlpha&&u.setAlphaMode(0),h&&this._scene.getEngine().setState(g,v,!1,!0,void 0,void 0,E),u.unbindInstanceAttributes()}_appendSpriteVertex(e,t,i,r,n,a,o){let l=e*this._vertexBufferSize;if(i===0?i=this._epsilon:i===1&&(i=1-this._epsilon),r===0?r=this._epsilon:r===1&&(r=1-this._epsilon),o)o(t,n);else{t.cellIndex||(t.cellIndex=0);const c=n.width/this.cellWidth,u=t.cellIndex/c>>0;t._xOffset=(t.cellIndex-u*c)*this.cellWidth/n.width,t._yOffset=u*this.cellHeight/n.height,t._xSize=this.cellWidth,t._ySize=this.cellHeight}this._vertexData[l]=t.position.x,this._vertexData[l+1]=t.position.y,this._vertexData[l+2]=t.position.z,this._vertexData[l+3]=t.angle,this._vertexData[l+4]=t.width,this._vertexData[l+5]=t.height,this._useInstancing?l-=2:(this._vertexData[l+6]=i,this._vertexData[l+7]=r),a?this._vertexData[l+8]=t.invertU?0:1:this._vertexData[l+8]=t.invertU?1:0,this._vertexData[l+9]=t.invertV?1:0,this._vertexData[l+10]=t._xOffset,this._vertexData[l+11]=t._yOffset,this._vertexData[l+12]=t._xSize/n.width,this._vertexData[l+13]=t._ySize/n.height,this._vertexData[l+14]=t.color.r,this._vertexData[l+15]=t.color.g,this._vertexData[l+16]=t.color.b,this._vertexData[l+17]=t.color.a}_buildIndexBuffer(){const e=[];let t=0;for(let i=0;i<this._capacity;i++)e.push(t),e.push(t+1),e.push(t+2),e.push(t),e.push(t+2),e.push(t+3),t+=4;this._indexBuffer=this._engine.createIndexBuffer(e)}rebuild(){var e;this._indexBuffer&&this._buildIndexBuffer(),this._useVAO&&(this._vertexArrayObject=void 0),this._buffer._rebuild();for(const t in this._vertexBuffers)this._vertexBuffers[t]._rebuild();(e=this._spriteBuffer)==null||e._rebuild()}dispose(){var e,t;this._buffer&&(this._buffer.dispose(),this._buffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this.texture&&(this.texture.dispose(),this.texture=null),(e=this._drawWrapperBase)==null||e.dispose(),(t=this._drawWrapperDepth)==null||t.dispose(),this._isDisposed=!0}}Ch.ForceGLSL=!1;class ln{set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get children(){return this.sprites}get scene(){return this._scene}get capacity(){return this._spriteRenderer.capacity}get texture(){return this._spriteRenderer.texture}set texture(e){e.wrapU=$.CLAMP_ADDRESSMODE,e.wrapV=$.CLAMP_ADDRESSMODE,this._spriteRenderer.texture=e,this._textureContent=null}get cellWidth(){return this._spriteRenderer.cellWidth}set cellWidth(e){this._spriteRenderer.cellWidth=e}get cellHeight(){return this._spriteRenderer.cellHeight}set cellHeight(e){this._spriteRenderer.cellHeight=e}get fogEnabled(){return this._spriteRenderer.fogEnabled}set fogEnabled(e){this._spriteRenderer.fogEnabled=e}get useLogarithmicDepth(){return this._spriteRenderer.useLogarithmicDepth}set useLogarithmicDepth(e){this._spriteRenderer.useLogarithmicDepth=e}get blendMode(){return this._spriteRenderer.blendMode}set blendMode(e){this._spriteRenderer.blendMode=e}get disableDepthWrite(){return this._disableDepthWrite}set disableDepthWrite(e){this._disableDepthWrite=e,this._spriteRenderer.disableDepthWrite=e}get pixelPerfect(){return this._spriteRenderer.pixelPerfect}set pixelPerfect(e){this._spriteRenderer.pixelPerfect=e,e&&this.texture.samplingMode!==3&&this.texture.updateSamplingMode(3)}get spriteRenderer(){return this._spriteRenderer}constructor(e,t,i,r,n,a=.01,o=$.TRILINEAR_SAMPLINGMODE,l=!1,c=null,u){var d;this.name=e,this.sprites=[],this.renderingGroupId=0,this.layerMask=268435455,this.isPickable=!1,this.metadata=null,this._wasDispatched=!1,this.onDisposeObservable=new k,this._disableDepthWrite=!1,this._packedAndReady=!1,this._customUpdate=(f,m)=>{f.cellRef||(f.cellIndex=0);const g=f.cellIndex;typeof g=="number"&&isFinite(g)&&Math.floor(g)===g&&(f.cellRef=this._spriteMap[f.cellIndex]),f._xOffset=this._cellData[f.cellRef].frame.x/m.width,f._yOffset=this._cellData[f.cellRef].frame.y/m.height,f._xSize=this._cellData[f.cellRef].frame.w,f._ySize=this._cellData[f.cellRef].frame.h},n||(n=De.LastCreatedScene),n._getComponent(se.NAME_SPRITE)||n._addComponent(new L3(n)),this._fromPacked=l,this._scene=n;const h=this._scene.getEngine();if(this._spriteRenderer=new Ch(h,i,a,n,u==null?void 0:u.spriteRendererOptions),r.width&&r.height)this.cellWidth=r.width,this.cellHeight=r.height;else if(r!==void 0)this.cellWidth=r,this.cellHeight=r;else{this._spriteRenderer=null;return}this._scene.spriteManagers&&this._scene.spriteManagers.push(this),this.uniqueId=this.scene.getUniqueId(),t&&(this.texture=new $(t,n,!0,!1,o)),this._fromPacked&&this._makePacked(t,c),(d=this._scene._onNewSpriteManagerAddedObservable)==null||d.notifyObservers(this)}getClassName(){return"SpriteManager"}_makePacked(e,t){if(t!==null)try{let i;if(typeof t=="string"?i=JSON.parse(t):i=t,i.frames.length){const n={};for(let a=0;a<i.frames.length;a++){const o=i.frames[a];if(typeof Object.keys(o)[0]!="string")throw new Error("Invalid JSON Format.  Check the frame values and make sure the name is the first parameter.");const l=o[Object.keys(o)[0]];n[l]=o}i.frames=n}const r=Reflect.ownKeys(i.frames);this._spriteMap=r,this._packedAndReady=!0,this._cellData=i.frames}catch{throw this._fromPacked=!1,this._packedAndReady=!1,new Error("Invalid JSON from string. Spritesheet managed with constant cell size.")}else{const i=/\./g;let r;do r=i.lastIndex,i.test(e);while(i.lastIndex>0);const n=e.substring(0,r-1)+".json",a=()=>{N.Error("JSON ERROR: Unable to load JSON file."),this._fromPacked=!1,this._packedAndReady=!1},o=l=>{try{const c=JSON.parse(l),u=Reflect.ownKeys(c.frames);this._spriteMap=u,this._packedAndReady=!0,this._cellData=c.frames}catch{throw this._fromPacked=!1,this._packedAndReady=!1,new Error("Invalid JSON format. Please check documentation for format specifications.")}};j.LoadFile(n,o,void 0,void 0,!1,a)}}_checkTextureAlpha(e,t,i,r,n){var f;if(!e.useAlphaForPicking||!((f=this.texture)!=null&&f.isReady()))return!0;const a=this.texture.getSize();this._textureContent||(this._textureContent=new Uint8Array(a.width*a.height*4),this.texture.readPixels(0,0,this._textureContent));const o=G.Vector3[0];o.copyFrom(t.direction),o.normalize(),o.scaleInPlace(i),o.addInPlace(t.origin);const l=(o.x-r.x)/(n.x-r.x),c=1-(o.y-r.y)/(n.y-r.y),u=e._xOffset*a.width+l*e._xSize|0,h=e._yOffset*a.height+c*e._ySize|0;return this._textureContent[(u+h*a.width)*4+3]>.5}intersects(e,t,i,r){const n=Math.min(this.capacity,this.sprites.length),a=x.Zero(),o=x.Zero();let l=Number.MAX_VALUE,c=null;const u=G.Vector3[0],h=G.Vector3[1],d=t.getViewMatrix();let f=e,m=e;for(let g=0;g<n;g++){const v=this.sprites[g];if(v){if(i){if(!i(v))continue}else if(!v.isPickable)continue;if(x.TransformCoordinatesToRef(v.position,d,h),v.angle?(z.TranslationToRef(-h.x,-h.y,0,G.Matrix[1]),z.TranslationToRef(h.x,h.y,0,G.Matrix[2]),z.RotationZToRef(-v.angle,G.Matrix[3]),G.Matrix[1].multiplyToRef(G.Matrix[3],G.Matrix[4]),G.Matrix[4].multiplyToRef(G.Matrix[2],G.Matrix[0]),f=e.clone(),x.TransformCoordinatesToRef(e.origin,G.Matrix[0],f.origin),x.TransformNormalToRef(e.direction,G.Matrix[0],f.direction)):f=e,a.copyFromFloats(h.x-v.width/2,h.y-v.height/2,h.z),o.copyFromFloats(h.x+v.width/2,h.y+v.height/2,h.z),f.intersectsBoxMinMax(a,o)){const E=x.Distance(h,f.origin);if(l>E){if(!this._checkTextureAlpha(v,f,E,a,o))continue;if(m=f,l=E,c=v,r)break}}}}if(c){const g=new Li;d.invertToRef(G.Matrix[0]),g.hit=!0,g.pickedSprite=c,g.distance=l;const v=G.Vector3[2];return v.copyFrom(m.direction),v.normalize(),v.scaleInPlace(l),m.origin.addToRef(v,u),g.pickedPoint=x.TransformCoordinates(u,G.Matrix[0]),g}return null}multiIntersects(e,t,i){const r=Math.min(this.capacity,this.sprites.length),n=x.Zero(),a=x.Zero();let o;const l=[],c=G.Vector3[0].copyFromFloats(0,0,0),u=G.Vector3[1].copyFromFloats(0,0,0),h=t.getViewMatrix();for(let d=0;d<r;d++){const f=this.sprites[d];if(f){if(i){if(!i(f))continue}else if(!f.isPickable)continue;if(x.TransformCoordinatesToRef(f.position,h,u),n.copyFromFloats(u.x-f.width/2,u.y-f.height/2,u.z),a.copyFromFloats(u.x+f.width/2,u.y+f.height/2,u.z),e.intersectsBoxMinMax(n,a)){if(o=x.Distance(u,e.origin),!this._checkTextureAlpha(f,e,o,n,a))continue;const m=new Li;l.push(m),h.invertToRef(G.Matrix[0]),m.hit=!0,m.pickedSprite=f,m.distance=o;const g=G.Vector3[2];g.copyFrom(e.direction),g.normalize(),g.scaleInPlace(o),e.origin.addToRef(g,c),m.pickedPoint=x.TransformCoordinates(c,G.Matrix[0])}}}return l}render(){if(this._fromPacked&&(!this._packedAndReady||!this._spriteMap||!this._cellData))return;const t=this._scene.getEngine().getDeltaTime();this._packedAndReady?this._spriteRenderer.render(this.sprites,t,this._scene.getViewMatrix(),this._scene.getProjectionMatrix(),this._customUpdate):this._spriteRenderer.render(this.sprites,t,this._scene.getViewMatrix(),this._scene.getProjectionMatrix())}rebuild(){var e;(e=this._spriteRenderer)==null||e.rebuild()}dispose(){var e;if(this._spriteRenderer&&(this._spriteRenderer.dispose(),this._spriteRenderer=null),this._textureContent=null,this._scene.spriteManagers){const t=this._scene.spriteManagers.indexOf(this);this._scene.spriteManagers.splice(t,1),(e=this._scene._onSpriteManagerRemovedObservable)==null||e.notifyObservers(this)}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null}serialize(e=!1){const t={};t.name=this.name,t.capacity=this.capacity,t.cellWidth=this.cellWidth,t.cellHeight=this.cellHeight,t.fogEnabled=this.fogEnabled,t.blendMode=this.blendMode,t.disableDepthWrite=this.disableDepthWrite,t.pixelPerfect=this.pixelPerfect,t.useLogarithmicDepth=this.useLogarithmicDepth,this.texture&&(e?t.texture=this.texture.serialize():(t.textureUrl=this.texture.name,t.invertY=this.texture._invertY)),t.sprites=[];for(const i of this.sprites)t.sprites.push(i.serialize());return t.metadata=this.metadata,t}static Parse(e,t,i){const r=new ln(e.name,"",e.capacity,{width:e.cellWidth,height:e.cellHeight},t);e.fogEnabled!==void 0&&(r.fogEnabled=e.fogEnabled),e.blendMode!==void 0&&(r.blendMode=e.blendMode),e.disableDepthWrite!==void 0&&(r.disableDepthWrite=e.disableDepthWrite),e.pixelPerfect!==void 0&&(r.pixelPerfect=e.pixelPerfect),e.useLogarithmicDepth!==void 0&&(r.useLogarithmicDepth=e.useLogarithmicDepth),e.metadata!==void 0&&(r.metadata=e.metadata),e.texture?r.texture=$.Parse(e.texture,t,i):e.textureName&&(r.texture=new $(i+e.textureUrl,t,!1,e.invertY!==void 0?e.invertY:!0));for(const n of e.sprites)L_.Parse(n,r);return r}static async ParseFromFileAsync(e,t,i,r=""){return await new Promise((n,a)=>{const o=new dn;o.addEventListener("readystatechange",()=>{if(o.readyState==4)if(o.status==200){const l=JSON.parse(o.responseText),c=ln.Parse(l,i||De.LastCreatedScene,r);e&&(c.name=e),n(c)}else a("Unable to load the sprite manager")}),o.open("GET",t),o.send()})}static ParseFromSnippetAsync(e,t,i=""){return e==="_BLANK"?Promise.resolve(new ln("Default sprite manager","//playground.babylonjs.com/textures/player.png",500,64,t)):new Promise((r,n)=>{const a=new dn;a.addEventListener("readystatechange",()=>{if(a.readyState==4)if(a.status==200){const o=JSON.parse(JSON.parse(a.responseText).jsonPayload),l=JSON.parse(o.spriteManager),c=ln.Parse(l,t||De.LastCreatedScene,i);c.snippetId=e,r(c)}else n("Unable to load the snippet "+e)}),a.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),a.send()})}}ln.SnippetUrl="https://snippet.babylonjs.com";ln.CreateFromSnippetAsync=ln.ParseFromSnippetAsync;class Hc{}Hc.LoaderInjectedPhysicsEngine=void 0;let io={},Ln={},ho={};const sx=(s,e,t,i)=>{if(!e.materials)return null;for(let r=0,n=e.materials.length;r<n;r++){const a=e.materials[r];if(s(a))return{parsedMaterial:a,material:Le.Parse(a,t,i)}}return null},w3=(s,e,t)=>{for(const i in e)if(s.name===e[i])return t.push(s.id),!0;return s.parentId!==void 0&&t.indexOf(s.parentId)!==-1?(t.push(s.id),!0):!1},ao=(s,e)=>s+" of "+(e?e.file+" from "+e.name+" version: "+e.version+", exporter version: "+e.exporter_version:"unknown"),gA=(s,e)=>{const t=e;if(e._waitingData.lods){if(e._waitingData.lods.ids&&e._waitingData.lods.ids.length>0){const i=e._waitingData.lods.ids,r=t.isEnabled(!1);if(e._waitingData.lods.distances){const n=e._waitingData.lods.distances;if(n.length>=i.length){const a=n.length>i.length?n[n.length-1]:0;t.setEnabled(!1);for(let o=0;o<i.length;o++){const l=i[o],c=s.getMeshById(l);c!=null&&t.addLODLevel(n[o],c)}a>0&&t.addLODLevel(a,null),r===!0&&t.setEnabled(!0)}else j.Warn("Invalid level of detail distances for "+e.name)}}e._waitingData.lods=null}},Ac=(s,e,t)=>{if(typeof s!="number"){const r=t.getLastEntryById(s);return r&&e!==void 0&&e!==null?r.instances[parseInt(e)]:r}const i=io[s];return i&&e!==void 0&&e!==null?i.instances[parseInt(e)]:i},nu=(s,e)=>typeof s!="number"?e.getLastMaterialById(s,!0):Ln[s],nx=(s,e,t,i,r=!1)=>{const n=new vM(s);let a="importScene has failed JSON parse";try{var o=typeof e=="object"?e:JSON.parse(e);a="";const l=tn.loggingLevel===3;let c,u;if(o.environmentTexture!==void 0&&o.environmentTexture!==null){const d=o.isPBR!==void 0?o.isPBR:!0;if(o.environmentTextureType&&o.environmentTextureType==="BABYLON.HDRCubeTexture"){const f=o.environmentTextureSize?o.environmentTextureSize:128,m=new Vl((o.environmentTexture.match(/https?:\/\//g)?"":t)+o.environmentTexture,s,f,!0,!d,void 0,o.environmentTexturePrefilterOnLoad);o.environmentTextureRotationY&&(m.rotationY=o.environmentTextureRotationY),s.environmentTexture=m}else if(typeof o.environmentTexture=="object"){const f=ii.Parse(o.environmentTexture,s,t);s.environmentTexture=f}else if(o.environmentTexture.endsWith(".env")){const f=new ii((o.environmentTexture.match(/https?:\/\//g)?"":t)+o.environmentTexture,s,o.environmentTextureForcedExtension);o.environmentTextureRotationY&&(f.rotationY=o.environmentTextureRotationY),s.environmentTexture=f}else{const f=ii.CreateFromPrefilteredData((o.environmentTexture.match(/https?:\/\//g)?"":t)+o.environmentTexture,s,o.environmentTextureForcedExtension);o.environmentTextureRotationY&&(f.rotationY=o.environmentTextureRotationY),s.environmentTexture=f}if(o.createDefaultSkybox===!0){const f=s.activeCamera!==void 0&&s.activeCamera!==null?(s.activeCamera.maxZ-s.activeCamera.minZ)/2:1e3,m=o.skyboxBlurLevel||0;s.createDefaultSkybox(s.environmentTexture,d,f,m)}n.environmentTexture=s.environmentTexture}if(o.environmentIntensity!==void 0&&o.environmentIntensity!==null&&(s.environmentIntensity=o.environmentIntensity),o.iblIntensity!==void 0&&o.iblIntensity!==null&&(s.iblIntensity=o.iblIntensity),o.lights!==void 0&&o.lights!==null)for(c=0,u=o.lights.length;c<u;c++){const d=o.lights[c],f=Xs.Parse(d,s);f&&(io[d.uniqueId]=f,n.lights.push(f),f._parentContainer=n,a+=c===0?`
	Lights:`:"",a+=`
		`+f.toString(l))}if(o.reflectionProbes!==void 0&&o.reflectionProbes!==null)for(c=0,u=o.reflectionProbes.length;c<u;c++){const d=o.reflectionProbes[c],f=cc.Parse(d,s,t);f&&(n.reflectionProbes.push(f),f._parentContainer=n,a+=c===0?`
	Reflection Probes:`:"",a+=`
		`+f.toString(l))}if(o.animations!==void 0&&o.animations!==null)for(c=0,u=o.animations.length;c<u;c++){const d=o.animations[c],f=ki("BABYLON.Animation");if(f){const m=f.Parse(d);s.animations.push(m),n.animations.push(m),a+=c===0?`
	Animations:`:"",a+=`
		`+m.toString(l)}}if(o.materials!==void 0&&o.materials!==null)for(c=0,u=o.materials.length;c<u;c++){const d=o.materials[c],f=Le.Parse(d,s,t);if(f){Ln[d.uniqueId||d.id]=f,n.materials.push(f),f._parentContainer=n,a+=c===0?`
	Materials:`:"",a+=`
		`+f.toString(l);const m=f.getActiveTextures();for(const g of m)n.textures.indexOf(g)==-1&&(n.textures.push(g),g._parentContainer=n)}}if(o.multiMaterials!==void 0&&o.multiMaterials!==null)for(c=0,u=o.multiMaterials.length;c<u;c++){const d=o.multiMaterials[c],f=Zm.ParseMultiMaterial(d,s);Ln[d.uniqueId||d.id]=f,n.multiMaterials.push(f),f._parentContainer=n,a+=c===0?`
	MultiMaterials:`:"",a+=`
		`+f.toString(l);const m=f.getActiveTextures();for(const g of m)n.textures.indexOf(g)==-1&&(n.textures.push(g),g._parentContainer=n)}if(o.morphTargetManagers!==void 0&&o.morphTargetManagers!==null)for(const d of o.morphTargetManagers){const f=Zr.Parse(d,s);ho[d.id]=f,n.morphTargetManagers.push(f),f._parentContainer=n}if(o.skeletons!==void 0&&o.skeletons!==null)for(c=0,u=o.skeletons.length;c<u;c++){const d=o.skeletons[c],f=Ll.Parse(d,s);n.skeletons.push(f),f._parentContainer=n,a+=c===0?`
	Skeletons:`:"",a+=`
		`+f.toString(l)}const h=o.geometries;if(h!=null){const d=new Array,f=h.vertexData;if(f!=null)for(c=0,u=f.length;c<u;c++){const m=f[c];d.push(_I.Parse(m,s,t))}for(const m of d)m&&(n.geometries.push(m),m._parentContainer=n)}if(o.transformNodes!==void 0&&o.transformNodes!==null)for(c=0,u=o.transformNodes.length;c<u;c++){const d=o.transformNodes[c],f=Es.Parse(d,s,t);io[d.uniqueId]=f,n.transformNodes.push(f),f._parentContainer=n}if(o.meshes!==void 0&&o.meshes!==null)for(c=0,u=o.meshes.length;c<u;c++){const d=o.meshes[c],f=Oe.Parse(d,s,t);if(io[d.uniqueId]=f,n.meshes.push(f),f._parentContainer=n,f.hasInstances)for(const m of f.instances)n.meshes.push(m),m._parentContainer=n;a+=c===0?`
	Meshes:`:"",a+=`
		`+f.toString(l)}if(o.cameras!==void 0&&o.cameras!==null)for(c=0,u=o.cameras.length;c<u;c++){const d=o.cameras[c],f=dt.Parse(d,s);io[d.uniqueId]=f,n.cameras.push(f),f._parentContainer=n,a+=c===0?`
	Cameras:`:"",a+=`
		`+f.toString(l)}if(o.postProcesses!==void 0&&o.postProcesses!==null)for(c=0,u=o.postProcesses.length;c<u;c++){const d=o.postProcesses[c],f=Se.Parse(d,s,t);f&&(n.postProcesses.push(f),f._parentContainer=n,a+=c===0?`
Postprocesses:`:"",a+=`
		`+f.toString())}if(o.animationGroups!==void 0&&o.animationGroups!==null&&o.animationGroups.length){const d=new Map;for(let f=0;f<s.meshes.length;f++)d.has(s.meshes[f].id)||d.set(s.meshes[f].id,s.meshes[f]);for(let f=0;f<s.transformNodes.length;f++)d.has(s.transformNodes[f].id)||d.set(s.transformNodes[f].id,s.transformNodes[f]);for(let f=0;f<s.lights.length;f++)d.has(s.lights[f].id)||d.set(s.lights[f].id,s.lights[f]);for(let f=0;f<s.cameras.length;f++)d.has(s.cameras[f].id)||d.set(s.cameras[f].id,s.cameras[f]);for(let f=0;f<s.skeletons.length;f++){const m=s.skeletons[f];for(let g=0;g<m.bones.length;g++)d.has(m.bones[g].id)||d.set(m.bones[g].id,m.bones[g])}for(c=0,u=o.animationGroups.length;c<u;c++){const f=o.animationGroups[c],m=Rs.Parse(f,s,d);n.animationGroups.push(m),m._parentContainer=n,a+=c===0?`
	AnimationGroups:`:"",a+=`
		`+m.toString(l)}}if(o.spriteManagers)for(let d=0,f=o.spriteManagers.length;d<f;d++){const m=o.spriteManagers[d],g=ln.Parse(m,s,t);a+=`
		SpriteManager `+g.name}for(c=0,u=s.cameras.length;c<u;c++){const d=s.cameras[c];d._waitingParentId!==null&&(d.parent=Ac(d._waitingParentId,d._waitingParentInstanceIndex,s),d._waitingParentId=null,d._waitingParentInstanceIndex=null)}for(c=0,u=s.lights.length;c<u;c++){const d=s.lights[c];d&&d._waitingParentId!==null&&(d.parent=Ac(d._waitingParentId,d._waitingParentInstanceIndex,s),d._waitingParentId=null,d._waitingParentInstanceIndex=null)}for(c=0,u=s.transformNodes.length;c<u;c++){const d=s.transformNodes[c];d._waitingParentId!==null&&(d.parent=Ac(d._waitingParentId,d._waitingParentInstanceIndex,s),d._waitingParentId=null,d._waitingParentInstanceIndex=null)}for(c=0,u=s.meshes.length;c<u;c++){const d=s.meshes[c];d._waitingParentId!==null&&(d.parent=Ac(d._waitingParentId,d._waitingParentInstanceIndex,s),d._waitingParentId=null,d._waitingParentInstanceIndex=null),d._waitingData.lods&&gA(s,d)}for(const d of s.multiMaterials){for(const f of d._waitingSubMaterialsUniqueIds)d.subMaterials.push(nu(f,s));d._waitingSubMaterialsUniqueIds=[]}for(const d of s.meshes)d._waitingMaterialId!==null&&(d.material=nu(d._waitingMaterialId,s),d._waitingMaterialId=null);for(const d of s.meshes)d._waitingMorphTargetManagerId!==null&&(d.morphTargetManager=ho[d._waitingMorphTargetManagerId],d._waitingMorphTargetManagerId=null);for(c=0,u=s.skeletons.length;c<u;c++){const d=s.skeletons[c];if(d._hasWaitingData){if(d.bones!=null){for(const f of d.bones)if(f._waitingTransformNodeId){const m=s.getLastEntryById(f._waitingTransformNodeId);m&&f.linkTransformNode(m),f._waitingTransformNodeId=null}}d._hasWaitingData=null}}for(c=0,u=s.meshes.length;c<u;c++){const d=s.meshes[c];d._waitingData.freezeWorldMatrix?(d.freezeWorldMatrix(),d._waitingData.freezeWorldMatrix=null):d.computeWorldMatrix(!0)}for(c=0,u=s.lights.length;c<u;c++){const d=s.lights[c];if(d._excludedMeshesIds.length>0){for(let f=0;f<d._excludedMeshesIds.length;f++){const m=s.getMeshById(d._excludedMeshesIds[f]);m&&d.excludedMeshes.push(m)}d._excludedMeshesIds=[]}if(d._includedOnlyMeshesIds.length>0){for(let f=0;f<d._includedOnlyMeshesIds.length;f++){const m=s.getMeshById(d._includedOnlyMeshesIds[f]);m&&d.includedOnlyMeshes.push(m)}d._includedOnlyMeshesIds=[]}}for(const d of s.geometries)d._loadedUniqueId="";for(lF(o,s,n,t),c=0,u=s.meshes.length;c<u;c++){const d=s.meshes[c];d._waitingData.actions&&(qe.Parse(d._waitingData.actions,d,s),d._waitingData.actions=null)}o.actions!==void 0&&o.actions!==null&&qe.Parse(o.actions,null,s)}catch(l){const c=ao("loadAssets",o?o.producer:"Unknown")+a;if(i)i(c,l);else throw N.Log(c),l}finally{io={},Ln={},ho={},r||n.removeAllFromScene(),a!==null&&tn.loggingLevel!==0&&N.Log(ao("loadAssets",o?o.producer:"Unknown")+(tn.loggingLevel!==1?a:""))}return n};FD({name:"babylon.js",extensions:".babylon",canDirectLoad:s=>s.indexOf("babylon")!==-1,importMesh:(s,e,t,i,r,n,a,o)=>{let l="importMesh has failed JSON parse";try{var c=JSON.parse(t);l="";const u=tn.loggingLevel===3;s?Array.isArray(s)||(s=[s]):s=null;const h=[],d=new Map,f=[];if(c.transformNodes!==void 0&&c.transformNodes!==null)for(let m=0,g=c.transformNodes.length;m<g;m++){const v=c.transformNodes[m],E=Es.Parse(v,e,i);f.push(E),d.set(E._waitingParsedUniqueId,E),E._waitingParsedUniqueId=null}if(c.meshes!==void 0&&c.meshes!==null){const m=[],g=[],v=[],E=[];for(let C=0,A=c.meshes.length;C<A;C++){const I=c.meshes[C];if(s===null||w3(I,s,h)){if(s!==null&&delete s[s.indexOf(I.name)],I.geometryId!==void 0&&I.geometryId!==null&&c.geometries!==void 0&&c.geometries!==null){let V=!1;const D=["boxes","spheres","cylinders","toruses","grounds","planes","torusKnots","vertexData"];for(const w of D){if(!c.geometries[w]||!Array.isArray(c.geometries[w]))continue;const B=c.geometries[w];for(const Q of B)if(Q.id===I.geometryId){switch(w){case"vertexData":_I.Parse(Q,e,i);break}V=!0;break}if(V)break}V===!1&&N.Warn("Geometry not found for mesh "+I.id)}if(I.materialUniqueId||I.materialId){const V=I.materialUniqueId?v:g;let D=V.indexOf(I.materialUniqueId||I.materialId)!==-1;if(D===!1&&c.multiMaterials!==void 0&&c.multiMaterials!==null){const w=(B,Q)=>{V.push(B);const J=sx(Q,c,e,i);J&&J.material&&(Ln[J.parsedMaterial.uniqueId||J.parsedMaterial.id]=J.material,l+=`
	Material `+J.material.toString(u))};for(let B=0,Q=c.multiMaterials.length;B<Q;B++){const J=c.multiMaterials[B];if(I.materialUniqueId&&J.uniqueId===I.materialUniqueId||J.id===I.materialId){if(J.materialsUniqueIds)for(const ne of J.materialsUniqueIds)w(ne,fe=>fe.uniqueId===ne);else for(const ne of J.materials)w(ne,fe=>fe.id===ne);V.push(J.uniqueId||J.id);const re=Zm.ParseMultiMaterial(J,e);Ln[J.uniqueId||J.id]=re,re&&(D=!0,l+=`
	Multi-Material `+re.toString(u));break}}}if(D===!1){V.push(I.materialUniqueId||I.materialId);const w=sx(B=>I.materialUniqueId&&B.uniqueId===I.materialUniqueId||B.id===I.materialId,c,e,i);!w||!w.material?N.Warn("Material not found for mesh "+I.id):(Ln[w.parsedMaterial.uniqueId||w.parsedMaterial.id]=w.material,l+=`
	Material `+w.material.toString(u))}}if(I.skeletonId!==null&&I.skeletonId!==void 0&&c.skeletonId!==-1&&c.skeletons!==void 0&&c.skeletons!==null&&!(m.indexOf(I.skeletonId)>-1))for(let D=0,w=c.skeletons.length;D<w;D++){const B=c.skeletons[D];if(B.id===I.skeletonId){const Q=Ll.Parse(B,e);a.push(Q),m.push(B.id),l+=`
	Skeleton `+Q.toString(u)}}if(I.morphTargetManagerId>-1&&c.morphTargetManagers!==void 0&&c.morphTargetManagers!==null&&!(E.indexOf(I.morphTargetManagerId)>-1))for(let D=0;D<c.morphTargetManagers.length;D++){const w=c.morphTargetManagers[D];if(w.id===I.morphTargetManagerId){const B=Zr.Parse(w,e);ho[w.id]=B,E.push(w.id),l+=`
Morph target manager`+B.toString()}}const F=Oe.Parse(I,e,i);r.push(F),d.set(F._waitingParsedUniqueId,F),F._waitingParsedUniqueId=null,l+=`
	Mesh `+F.toString(u)}}for(const C of e.multiMaterials){for(const A of C._waitingSubMaterialsUniqueIds)C.subMaterials.push(nu(A,e));C._waitingSubMaterialsUniqueIds=[]}for(const C of e.meshes)C._waitingMaterialId!==null&&(C.material=nu(C._waitingMaterialId,e),C._waitingMaterialId=null);for(const C of e.meshes)C._waitingMorphTargetManagerId!==null&&(C.morphTargetManager=ho[C._waitingMorphTargetManagerId],C._waitingMorphTargetManagerId=null);for(let C=0,A=e.transformNodes.length;C<A;C++){const I=e.transformNodes[C];if(I._waitingParentId!==null){let F=d.get(parseInt(I._waitingParentId))||null;F===null&&(F=e.getLastEntryById(I._waitingParentId));let V=F;I._waitingParentInstanceIndex&&(V=F.instances[parseInt(I._waitingParentInstanceIndex)],I._waitingParentInstanceIndex=null),I.parent=V,I._waitingParentId=null}}let T;for(let C=0,A=e.meshes.length;C<A;C++){if(T=e.meshes[C],T._waitingParentId){let I=d.get(parseInt(T._waitingParentId))||null;I===null&&(I=e.getLastEntryById(T._waitingParentId));let F=I;T._waitingParentInstanceIndex&&(F=I.instances[parseInt(T._waitingParentInstanceIndex)],T._waitingParentInstanceIndex=null),T.parent=F,T._waitingParentId=null}T._waitingData.lods&&gA(e,T)}for(const C of f)C.getChildMeshes(!1).length||C.dispose();for(let C=0,A=e.skeletons.length;C<A;C++){const I=e.skeletons[C];if(I._hasWaitingData){if(I.bones!=null){for(const F of I.bones)if(F._waitingTransformNodeId){const V=e.getLastEntryById(F._waitingTransformNodeId);V&&F.linkTransformNode(V),F._waitingTransformNodeId=null}}I._hasWaitingData=null}}for(let C=0,A=e.meshes.length;C<A;C++)T=e.meshes[C],T._waitingData.freezeWorldMatrix?(T.freezeWorldMatrix(),T._waitingData.freezeWorldMatrix=null):T.computeWorldMatrix(!0)}if(c.particleSystems!==void 0&&c.particleSystems!==null){const m=wI(se.NAME_PARTICLESYSTEM);if(m)for(let g=0,v=c.particleSystems.length;g<v;g++){const E=c.particleSystems[g];h.indexOf(E.emitterId)!==-1&&n.push(m(E,e,i))}}for(const m of e.geometries)m._loadedUniqueId="";return!0}catch(u){const h=ao("importMesh",c?c.producer:"Unknown")+l;if(o)o(h,u);else throw N.Log(h),u}finally{l!==null&&tn.loggingLevel!==0&&N.Log(ao("importMesh",c?c.producer:"Unknown")+(tn.loggingLevel!==1?l:"")),Ln={},ho={}}return!1},load:(s,e,t,i)=>{let r="importScene has failed JSON parse";try{var n=JSON.parse(e);switch(r="",n.useDelayedTextureLoading!==void 0&&n.useDelayedTextureLoading!==null&&(s.useDelayedTextureLoading=n.useDelayedTextureLoading&&!tn.ForceFullSceneLoadingForIncremental),n.autoClear!==void 0&&n.autoClear!==null&&(s.autoClear=n.autoClear),n.clearColor!==void 0&&n.clearColor!==null&&(s.clearColor=Te.FromArray(n.clearColor)),n.ambientColor!==void 0&&n.ambientColor!==null&&(s.ambientColor=q.FromArray(n.ambientColor)),n.gravity!==void 0&&n.gravity!==null&&(s.gravity=x.FromArray(n.gravity)),n.useRightHandedSystem!==void 0&&(s.useRightHandedSystem=!!n.useRightHandedSystem),n.fogMode!==void 0&&n.fogMode!==null&&(s.fogMode=n.fogMode),n.fogColor!==void 0&&n.fogColor!==null&&(s.fogColor=q.FromArray(n.fogColor)),n.fogStart!==void 0&&n.fogStart!==null&&(s.fogStart=n.fogStart),n.fogEnd!==void 0&&n.fogEnd!==null&&(s.fogEnd=n.fogEnd),n.fogDensity!==void 0&&n.fogDensity!==null&&(s.fogDensity=n.fogDensity),r+="	Fog mode for scene:  ",s.fogMode){case 0:r+=`none
`;break;case 1:r+=`exp
`;break;case 2:r+=`exp2
`;break;case 3:r+=`linear
`;break}if(n.physicsEnabled){let o;n.physicsEngine==="cannon"||n.physicsEngine===zd.name?o=new zd(void 0,void 0,Hc.LoaderInjectedPhysicsEngine):n.physicsEngine==="oimo"||n.physicsEngine===rx.name?o=new rx(void 0,Hc.LoaderInjectedPhysicsEngine):(n.physicsEngine==="ammo"||n.physicsEngine===Ls.name)&&(o=new Ls(void 0,Hc.LoaderInjectedPhysicsEngine,void 0)),r="	Physics engine "+(n.physicsEngine?n.physicsEngine:"oimo")+` enabled
`;const l=n.gravity?x.FromArray(n.gravity):n.physicsGravity?x.FromArray(n.physicsGravity):null;s.enablePhysics(l,o)}return n.metadata!==void 0&&n.metadata!==null&&(s.metadata=n.metadata),n.collisionsEnabled!==void 0&&n.collisionsEnabled!==null&&(s.collisionsEnabled=n.collisionsEnabled),nx(s,e,t,i,!0)?(n.autoAnimate&&s.beginAnimation(s,n.autoAnimateFrom,n.autoAnimateTo,n.autoAnimateLoop,n.autoAnimateSpeed||1),n.activeCameraID!==void 0&&n.activeCameraID!==null&&s.setActiveCameraById(n.activeCameraID),!0):!1}catch(a){const o=ao("importScene",n?n.producer:"Unknown")+r;if(i)i(o,a);else throw N.Log(o),a}finally{r!==null&&tn.loggingLevel!==0&&N.Log(ao("importScene",n?n.producer:"Unknown")+(tn.loggingLevel!==1?r:""))}return!1},loadAssetContainer:(s,e,t,i)=>nx(s,e,t,i)});const ax="backgroundUboDeclaration",B3=`uniform vPrimaryColor: vec4f;uniform vPrimaryColorShadow: vec4f;uniform vDiffuseInfos : vec2f;uniform diffuseMatrix : mat4x4f;uniform fFovMultiplier: f32;uniform pointSize: f32;uniform shadowLevel: f32;uniform alpha: f32;uniform vBackgroundCenter: vec3f;uniform vReflectionControl: vec4f;uniform projectedGroundInfos: vec2f;uniform vReflectionInfos : vec2f;uniform reflectionMatrix : mat4x4f;uniform vReflectionMicrosurfaceInfos : vec3f;
#include<sceneUboDeclaration>
`;S.IncludesShadersStoreWGSL[ax]||(S.IncludesShadersStoreWGSL[ax]=B3);const Wd="backgroundVertexShader",SA=`#include<backgroundUboDeclaration>
#include<helperFunctions>
attribute position: vec3f;
#ifdef NORMAL
attribute normal: vec3f;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
varying vPositionW: vec3f;
#ifdef NORMAL
varying vNormalW: vec3f;
#endif
#ifdef UV1
attribute uv: vec2f;
#endif
#ifdef UV2
attribute uv2: vec2f;
#endif
#ifdef MAINUV1
varying vMainUV1: vec2f;
#endif
#ifdef MAINUV2
varying vMainUV2: vec2f;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
varying vDiffuseUV: vec2f;
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<lightVxUboDeclaration>[0..maxSimultaneousLights]
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
#ifdef REFLECTIONMAP_SKYBOX
vertexOutputs.vPositionUVW=input.position;
#endif
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {vertexOutputs.position=scene.viewProjection*finalWorld* vec4f(input.position,1.0);} else {vertexOutputs.position=scene.viewProjectionR*finalWorld* vec4f(input.position,1.0);}
#else
vertexOutputs.position=scene.viewProjection*finalWorld* vec4f(input.position,1.0);
#endif
var worldPos: vec4f=finalWorld* vec4f(input.position,1.0);vertexOutputs.vPositionW= worldPos.xyz;
#ifdef NORMAL
var normalWorld: mat3x3f=mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vertexOutputs.vNormalW=normalize(normalWorld*input.normal);
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vertexOutputs.vDirectionW=normalize((finalWorld*vec4f(input.position,0.0)).xyz);
#ifdef EQUIRECTANGULAR_RELFECTION_FOV
var screenToWorld: mat3x3f=inverseMat3( mat3x3f(finalWorld*scene.viewProjection));var segment: vec3f=mix(vertexOutputs.vDirectionW,screenToWorld* vec3f(0.0,0.0,1.0),abs(fFovMultiplier-1.0));if (fFovMultiplier<=1.0) {vertexOutputs.vDirectionW=normalize(segment);} else {vertexOutputs.vDirectionW=normalize(vertexOutputs.vDirectionW+(vertexOutputs.vDirectionW-segment));}
#endif
#endif
#ifndef UV1
var uv: vec2f=vec2f(0.,0.);
#else
var uv=input.uv;
#endif
#ifndef UV2
var uv2: vec2f=vec2f(0.,0.);
#else
var uv2=input.uv2;
#endif
#ifdef MAINUV1
vertexOutputs.vMainUV1=uv;
#endif
#ifdef MAINUV2
vertexOutputs.vMainUV2=uv2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
if (uniforms.vDiffuseInfos.x==0.)
{vertexOutputs.vDiffuseUV= (uniforms.diffuseMatrix* vec4f(uv,1.0,0.0)).xy;}
else
{vertexOutputs.vDiffuseUV= (uniforms.diffuseMatrix* vec4f(uv2,1.0,0.0)).xy;}
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#ifdef VERTEXCOLOR
vertexOutputs.vColor=vertexInputs.color;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;S.ShadersStoreWGSL[Wd]||(S.ShadersStoreWGSL[Wd]=SA);const V3={name:Wd,shader:SA},U3=Object.freeze(Object.defineProperty({__proto__:null,backgroundVertexShaderWGSL:V3},Symbol.toStringTag,{value:"Module"})),ox="intersectionFunctions",k3=`fn diskIntersectWithBackFaceCulling(ro: vec3f,rd: vec3f,c: vec3f,r: f32)->f32 {var d: f32=rd.y;if(d>0.0) { return 1e6; }
var o: vec3f=ro-c;var t: f32=-o.y/d;var q: vec3f=o+rd*t;return select(1e6,t,(dot(q,q)<r*r));}
fn sphereIntersect(ro: vec3f,rd: vec3f,ce: vec3f,ra: f32)->vec2f {var oc: vec3f=ro-ce;var b: f32=dot(oc,rd);var c: f32=dot(oc,oc)-ra*ra;var h: f32=b*b-c;if(h<0.0) { return vec2f(-1.,-1.); }
h=sqrt(h);return vec2f(-b+h,-b-h);}
fn sphereIntersectFromOrigin(ro: vec3f,rd: vec3f,ra: f32)->vec2f {var b: f32=dot(ro,rd);var c: f32=dot(ro,ro)-ra*ra;var h: f32=b*b-c;if(h<0.0) { return vec2f(-1.,-1.); }
h=sqrt(h);return vec2f(-b+h,-b-h);}`;S.IncludesShadersStoreWGSL[ox]||(S.IncludesShadersStoreWGSL[ox]=k3);const Hd="backgroundPixelShader",vA=`#include<backgroundUboDeclaration>
#include<helperFunctions>
varying vPositionW: vec3f;
#ifdef MAINUV1
varying vMainUV1: vec2f;
#endif 
#ifdef MAINUV2 
varying vMainUV2: vec2f; 
#endif 
#ifdef NORMAL
varying vNormalW: vec3f;
#endif
#ifdef DIFFUSE
#if DIFFUSEDIRECTUV==1
#define vDiffuseUV vMainUV1
#elif DIFFUSEDIRECTUV==2
#define vDiffuseUV vMainUV2
#else
varying vDiffuseUV: vec2f;
#endif
var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_cube<f32>;
#ifdef TEXTURELODSUPPORT
#else
var reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_cube<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_cube<f32>;
#endif
#else
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_2d<f32>;
#ifdef TEXTURELODSUPPORT
#else
var reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_2d<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_2d<f32>;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#endif
#include<reflectionFunction>
#endif
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE;
#endif
#ifndef SHADOWONLY
#define SHADOWONLY;
#endif
#include<imageProcessingDeclaration>
#include<lightUboDeclaration>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<imageProcessingFunctions>
#include<logDepthDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<fogFragmentDeclaration>
#ifdef REFLECTIONFRESNEL
#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
fn fresnelSchlickEnvironmentGGX(VdotN: f32,reflectance0: vec3f,reflectance90: vec3f,smoothness: f32)->vec3f
{var weight: f32=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#ifdef PROJECTED_GROUND
#include<intersectionFunctions>
fn project(viewDirectionW: vec3f,eyePosition: vec3f)->vec3f {var radius: f32=uniforms.projectedGroundInfos.x;var height: f32=uniforms.projectedGroundInfos.y;var camDir: vec3f=-viewDirectionW;var skySphereDistance: f32=sphereIntersectFromOrigin(eyePosition,camDir,radius).x;var skySpherePositionW: vec3f=eyePosition+camDir*skySphereDistance;var p: vec3f=normalize(skySpherePositionW);var upEyePosition=vec3f(eyePosition.x,eyePosition.y-height,eyePosition.z);var sIntersection: f32=sphereIntersectFromOrigin(upEyePosition,p,radius).x;var h: vec3f= vec3f(0.0,-height,0.0);var dIntersection: f32=diskIntersectWithBackFaceCulling(upEyePosition,p,h,radius);p=(upEyePosition+min(sIntersection,dIntersection)*p);return p;}
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
var viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-input.vPositionW);
#ifdef NORMAL
var normalW: vec3f=normalize(fragmentInputs.vNormalW);
#else
var normalW: vec3f= vec3f(0.0,1.0,0.0);
#endif
var shadow: f32=1.;var globalShadow: f32=0.;var shadowLightCount: f32=0.;var aggShadow: f32=0.;var numLights: f32=0.;
#include<lightFragment>[0..maxSimultaneousLights]
#ifdef SHADOWINUSE
globalShadow/=shadowLightCount;
#else
globalShadow=1.0;
#endif
#ifndef BACKMAT_SHADOWONLY
var reflectionColor: vec4f= vec4f(1.,1.,1.,1.);
#ifdef REFLECTION
#ifdef PROJECTED_GROUND
var reflectionVector: vec3f=project(viewDirectionW,scene.vEyePosition.xyz);reflectionVector= (uniforms.reflectionMatrix*vec4f(reflectionVector,1.)).xyz;
#else
var reflectionVector: vec3f=computeReflectionCoords( vec4f(fragmentInputs.vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
var reflectionCoords: vec3f=reflectionVector;
#else
var reflectionCoords: vec2f=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
#ifdef REFLECTIONBLUR
var reflectionLOD: f32=uniforms.vReflectionInfos.y;
#ifdef TEXTURELODSUPPORT
reflectionLOD=reflectionLOD*log2(uniforms.vReflectionMicrosurfaceInfos.x)*uniforms.vReflectionMicrosurfaceInfos.y+uniforms.vReflectionMicrosurfaceInfos.z;reflectionColor=textureSampleLevel(reflectionSampler,reflectionSamplerSampler,reflectionCoords,reflectionLOD);
#else
var lodReflectionNormalized: f32=saturate(reflectionLOD);var lodReflectionNormalizedDoubled: f32=lodReflectionNormalized*2.0;var reflectionSpecularMid: vec4f=textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords);if(lodReflectionNormalizedDoubled<1.0){reflectionColor=mix(
textureSample(reflectionrHighSampler,reflectionrHighSamplerSampler,reflectionCoords),
reflectionSpecularMid,
lodReflectionNormalizedDoubled
);} else {reflectionColor=mix(
reflectionSpecularMid,
textureSample(reflectionLowSampler,reflectionLowSamplerSampler,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
#else
var reflectionSample: vec4f=textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords);reflectionColor=reflectionSample;
#endif
#ifdef RGBDREFLECTION
reflectionColor=vec4f(fromRGBD(reflectionColor).rgb,reflectionColor.a);
#endif
#ifdef GAMMAREFLECTION
reflectionColor=vec4f(toLinearSpaceVec3(reflectionColor.rgb),reflectionColor.a);
#endif
#ifdef REFLECTIONBGR
reflectionColor=vec4f(reflectionColor.bgr,reflectionColor.a);
#endif
reflectionColor=vec4f(reflectionColor.rgb*uniforms.vReflectionInfos.x,reflectionColor.a);
#endif
var diffuseColor: vec3f= vec3f(1.,1.,1.);var finalAlpha: f32=uniforms.alpha;
#ifdef DIFFUSE
var diffuseMap: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,input.vDiffuseUV);
#ifdef GAMMADIFFUSE
diffuseMap=vec4f(toLinearSpaceVec3(diffuseMap.rgb),diffuseMap.a);
#endif
diffuseMap=vec4f(diffuseMap.rgb *uniforms.vDiffuseInfos.y,diffuseMap.a);
#ifdef DIFFUSEHASALPHA
finalAlpha*=diffuseMap.a;
#endif
diffuseColor=diffuseMap.rgb;
#endif
#ifdef REFLECTIONFRESNEL
var colorBase: vec3f=diffuseColor;
#else
var colorBase: vec3f=reflectionColor.rgb*diffuseColor;
#endif
colorBase=max(colorBase,vec3f(0.0));
#ifdef USERGBCOLOR
var finalColor: vec3f=colorBase;
#else
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
var mainColor: vec3f=mix(uniforms.vPrimaryColorShadow.rgb,uniforms.vPrimaryColor.rgb,colorBase);
#else
var mainColor: vec3f=uniforms.vPrimaryColor.rgb;
#endif
var finalColor: vec3f=colorBase*mainColor;
#endif
#ifdef REFLECTIONFRESNEL
var reflectionAmount: vec3f=uniforms.vReflectionControl.xxx;var reflectionReflectance0: vec3f=uniforms.vReflectionControl.yyy;var reflectionReflectance90: vec3f=uniforms.vReflectionControl.zzz;var VdotN: f32=dot(normalize(scene.vEyePosition.xyz),normalW);var planarReflectionFresnel: vec3f=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);reflectionAmount*=planarReflectionFresnel;
#ifdef REFLECTIONFALLOFF
var reflectionDistanceFalloff: f32=1.0-saturate(length(vPositionW.xyz-uniforms.vBackgroundCenter)*uniforms.vReflectionControl.w);reflectionDistanceFalloff*=reflectionDistanceFalloff;reflectionAmount*=reflectionDistanceFalloff;
#endif
finalColor=mix(finalColor,reflectionColor.rgb,saturateVec3(reflectionAmount));
#endif
#ifdef OPACITYFRESNEL
var viewAngleToFloor: f32=dot(normalW,normalize(scene.vEyePosition.xyz-uniforms.vBackgroundCenter));const startAngle: f32=0.1;var fadeFactor: f32=saturate(viewAngleToFloor/startAngle);finalAlpha*=fadeFactor*fadeFactor;
#endif
#ifdef SHADOWINUSE
finalColor=mix(finalColor*uniforms.shadowLevel,finalColor,globalShadow);
#endif
var color: vec4f= vec4f(finalColor,finalAlpha);
#else
var color: vec4f= vec4f(uniforms.vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*uniforms.alpha);
#endif
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
#if !defined(SKIPFINALCOLORCLAMP)
color=vec4f(clamp(color.rgb,vec3f(0.),vec3f(30.0)),color.a);
#endif
#else
color=applyImageProcessing(color);
#endif
#ifdef PREMULTIPLYALPHA
color=vec4f(color.rgb *color.a,color.a);
#endif
#ifdef NOISE
color=vec4f(color.rgb+dither(fragmentInputs.vPositionW.xy,0.5),color.a);color=max(color,vec4f(0.0));
#endif
fragmentOutputs.color=color;
#define CUSTOM_FRAGMENT_MAIN_END
}
`;S.ShadersStoreWGSL[Hd]||(S.ShadersStoreWGSL[Hd]=vA);const G3={name:Hd,shader:vA},z3=Object.freeze(Object.defineProperty({__proto__:null,backgroundPixelShaderWGSL:G3},Symbol.toStringTag,{value:"Module"})),lx="backgroundVertexDeclaration",W3=`uniform mat4 view;uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
uniform float shadowLevel;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;uniform float fFovMultiplier;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
`;S.IncludesShadersStore[lx]||(S.IncludesShadersStore[lx]=W3);const cx="backgroundUboDeclaration",H3=`layout(std140,column_major) uniform;uniform Material
{uniform vec4 vPrimaryColor;uniform vec4 vPrimaryColorShadow;uniform vec2 vDiffuseInfos;uniform mat4 diffuseMatrix;uniform float fFovMultiplier;uniform float pointSize;uniform float shadowLevel;uniform float alpha;uniform vec3 vBackgroundCenter;uniform vec4 vReflectionControl;uniform vec2 projectedGroundInfos;uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;};
#include<sceneUboDeclaration>
`;S.IncludesShadersStore[cx]||(S.IncludesShadersStore[cx]=H3);const $d="backgroundVertexShader",xA=`precision highp float;
#include<__decl__backgroundVertex>
#include<helperFunctions>
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif
#ifdef MAINUV2
varying vec2 vMainUV2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
varying vec2 vDiffuseUV;
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=position;
#endif
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*finalWorld*vec4(position,1.0);} else {gl_Position=viewProjectionR*finalWorld*vec4(position,1.0);}
#else
gl_Position=viewProjection*finalWorld*vec4(position,1.0);
#endif
vec4 worldPos=finalWorld*vec4(position,1.0);vPositionW=vec3(worldPos);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normal);
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));
#ifdef EQUIRECTANGULAR_RELFECTION_FOV
mat3 screenToWorld=inverseMat3(mat3(finalWorld*viewProjection));vec3 segment=mix(vDirectionW,screenToWorld*vec3(0.0,0.0,1.0),abs(fFovMultiplier-1.0));if (fFovMultiplier<=1.0) {vDirectionW=normalize(segment);} else {vDirectionW=normalize(vDirectionW+(vDirectionW-segment));}
#endif
#endif
#ifndef UV1
vec2 uv=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uv;
#endif
#ifdef MAINUV2
vMainUV2=uv2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
if (vDiffuseInfos.x==0.)
{vDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));}
else
{vDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));}
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#ifdef VERTEXCOLOR
vColor=colorUpdated;
#endif
#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;S.ShadersStore[$d]||(S.ShadersStore[$d]=xA);const $3={name:$d,shader:xA},X3=Object.freeze(Object.defineProperty({__proto__:null,backgroundVertexShader:$3},Symbol.toStringTag,{value:"Module"})),ux="backgroundFragmentDeclaration",Y3=`uniform vec4 vEyePosition;uniform vec4 vPrimaryColor;
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
uniform vec4 vPrimaryColorShadow;
#endif
uniform float shadowLevel;uniform float alpha;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;
#endif
#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)
uniform vec3 vBackgroundCenter;
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 vReflectionControl;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)
uniform mat4 view;
#endif
#ifdef PROJECTED_GROUND
uniform vec2 projectedGroundInfos;
#endif
`;S.IncludesShadersStore[ux]||(S.IncludesShadersStore[ux]=Y3);const hx="intersectionFunctions",j3=`float diskIntersectWithBackFaceCulling(vec3 ro,vec3 rd,vec3 c,float r) {float d=rd.y;if(d>0.0) { return 1e6; }
vec3 o=ro-c;float t=-o.y/d;vec3 q=o+rd*t;return (dot(q,q)<r*r) ? t : 1e6;}
vec2 sphereIntersect(vec3 ro,vec3 rd,vec3 ce,float ra) {vec3 oc=ro-ce;float b=dot(oc,rd);float c=dot(oc,oc)-ra*ra;float h=b*b-c;if(h<0.0) { return vec2(-1.0,-1.0); }
h=sqrt(h);return vec2(-b+h,-b-h);}
vec2 sphereIntersectFromOrigin(vec3 ro,vec3 rd,float ra) {float b=dot(ro,rd);float c=dot(ro,ro)-ra*ra;float h=b*b-c;if(h<0.0) { return vec2(-1.0,-1.0); }
h=sqrt(h);return vec2(-b+h,-b-h);}`;S.IncludesShadersStore[hx]||(S.IncludesShadersStore[hx]=j3);const Xd="backgroundPixelShader",EA=`#ifdef TEXTURELODSUPPORT
#extension GL_EXT_shader_texture_lod : enable
#endif
precision highp float;
#include<__decl__backgroundFragment>
#include<helperFunctions>
varying vec3 vPositionW;
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif 
#ifdef MAINUV2 
varying vec2 vMainUV2; 
#endif 
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef DIFFUSE
#if DIFFUSEDIRECTUV==1
#define vDiffuseUV vMainUV1
#elif DIFFUSEDIRECTUV==2
#define vDiffuseUV vMainUV2
#else
varying vec2 vDiffuseUV;
#endif
uniform sampler2D diffuseSampler;
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef TEXTURELODSUPPORT
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef TEXTURELODSUPPORT
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE;
#endif
#ifndef SHADOWONLY
#define SHADOWONLY;
#endif
#include<imageProcessingDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<imageProcessingFunctions>
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<logDepthDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<fogFragmentDeclaration>
#ifdef REFLECTIONFRESNEL
#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
vec3 fresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#ifdef PROJECTED_GROUND
#include<intersectionFunctions>
vec3 project(vec3 viewDirectionW,vec3 eyePosition) {float radius=projectedGroundInfos.x;float height=projectedGroundInfos.y;vec3 camDir=-viewDirectionW;float skySphereDistance=sphereIntersectFromOrigin(eyePosition,camDir,radius).x;vec3 skySpherePositionW=eyePosition+camDir*skySphereDistance;vec3 p=normalize(skySpherePositionW);eyePosition.y-=height;float sIntersection=sphereIntersectFromOrigin(eyePosition,p,radius).x;vec3 h=vec3(0.0,-height,0.0);float dIntersection=diskIntersectWithBackFaceCulling(eyePosition,p,h,radius);p=(eyePosition+min(sIntersection,dIntersection)*p);return p;}
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=vec3(0.0,1.0,0.0);
#endif
float shadow=1.;float globalShadow=0.;float shadowLightCount=0.;float aggShadow=0.;float numLights=0.;
#include<lightFragment>[0..maxSimultaneousLights]
#ifdef SHADOWINUSE
globalShadow/=shadowLightCount;
#else
globalShadow=1.0;
#endif
#ifndef BACKMAT_SHADOWONLY
vec4 reflectionColor=vec4(1.,1.,1.,1.);
#ifdef REFLECTION
#ifdef PROJECTED_GROUND
vec3 reflectionVector=project(viewDirectionW,vEyePosition.xyz);reflectionVector=vec3(reflectionMatrix*vec4(reflectionVector,1.));
#else
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=reflectionVector;
#else
vec2 reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
#ifdef REFLECTIONBLUR
float reflectionLOD=vReflectionInfos.y;
#ifdef TEXTURELODSUPPORT
reflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;reflectionColor=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#else
float lodReflectionNormalized=saturate(reflectionLOD);float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;vec4 reflectionSpecularMid=sampleReflection(reflectionSampler,reflectionCoords);if(lodReflectionNormalizedDoubled<1.0){reflectionColor=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
reflectionSpecularMid,
lodReflectionNormalizedDoubled
);} else {reflectionColor=mix(
reflectionSpecularMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
#else
vec4 reflectionSample=sampleReflection(reflectionSampler,reflectionCoords);reflectionColor=reflectionSample;
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef GAMMAREFLECTION
reflectionColor.rgb=toLinearSpace(reflectionColor.rgb);
#endif
#ifdef REFLECTIONBGR
reflectionColor.rgb=reflectionColor.bgr;
#endif
reflectionColor.rgb*=vReflectionInfos.x;
#endif
vec3 diffuseColor=vec3(1.,1.,1.);float finalAlpha=alpha;
#ifdef DIFFUSE
vec4 diffuseMap=texture2D(diffuseSampler,vDiffuseUV);
#ifdef GAMMADIFFUSE
diffuseMap.rgb=toLinearSpace(diffuseMap.rgb);
#endif
diffuseMap.rgb*=vDiffuseInfos.y;
#ifdef DIFFUSEHASALPHA
finalAlpha*=diffuseMap.a;
#endif
diffuseColor=diffuseMap.rgb;
#endif
#ifdef REFLECTIONFRESNEL
vec3 colorBase=diffuseColor;
#else
vec3 colorBase=reflectionColor.rgb*diffuseColor;
#endif
colorBase=max(colorBase,0.0);
#ifdef USERGBCOLOR
vec3 finalColor=colorBase;
#else
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
vec3 mainColor=mix(vPrimaryColorShadow.rgb,vPrimaryColor.rgb,colorBase);
#else
vec3 mainColor=vPrimaryColor.rgb;
#endif
vec3 finalColor=colorBase*mainColor;
#endif
#ifdef REFLECTIONFRESNEL
vec3 reflectionAmount=vReflectionControl.xxx;vec3 reflectionReflectance0=vReflectionControl.yyy;vec3 reflectionReflectance90=vReflectionControl.zzz;float VdotN=dot(normalize(vEyePosition.xyz),normalW);vec3 planarReflectionFresnel=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);reflectionAmount*=planarReflectionFresnel;
#ifdef REFLECTIONFALLOFF
float reflectionDistanceFalloff=1.0-saturate(length(vPositionW.xyz-vBackgroundCenter)*vReflectionControl.w);reflectionDistanceFalloff*=reflectionDistanceFalloff;reflectionAmount*=reflectionDistanceFalloff;
#endif
finalColor=mix(finalColor,reflectionColor.rgb,saturate(reflectionAmount));
#endif
#ifdef OPACITYFRESNEL
float viewAngleToFloor=dot(normalW,normalize(vEyePosition.xyz-vBackgroundCenter));const float startAngle=0.1;float fadeFactor=saturate(viewAngleToFloor/startAngle);finalAlpha*=fadeFactor*fadeFactor;
#endif
#ifdef SHADOWINUSE
finalColor=mix(finalColor*shadowLevel,finalColor,globalShadow);
#endif
vec4 color=vec4(finalColor,finalAlpha);
#else
vec4 color=vec4(vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*alpha);
#endif
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
#if !defined(SKIPFINALCOLORCLAMP)
color.rgb=clamp(color.rgb,0.,30.0);
#endif
#else
color=applyImageProcessing(color);
#endif
#ifdef PREMULTIPLYALPHA
color.rgb*=color.a;
#endif
#ifdef NOISE
color.rgb+=dither(vPositionW.xy,0.5);color=max(color,0.0);
#endif
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}
`;S.ShadersStore[Xd]||(S.ShadersStore[Xd]=EA);const q3={name:Xd,shader:EA},Z3=Object.freeze(Object.defineProperty({__proto__:null,backgroundPixelShader:q3},Symbol.toStringTag,{value:"Module"}));class au{get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,te.MarkAllMaterialsAsDirty(20))}constructor(e={}){this._isEnabled=!0,this.bias=e.bias===void 0?0:e.bias,this.power=e.power===void 0?1:e.power,this.leftColor=e.leftColor||q.White(),this.rightColor=e.rightColor||q.Black(),e.isEnabled===!1&&(this.isEnabled=!1)}clone(){const e=new au;return Ea.DeepCopy(this,e),e}equals(e){return e&&this.bias===e.bias&&this.power===e.power&&this.leftColor.equals(e.leftColor)&&this.rightColor.equals(e.rightColor)&&this.isEnabled===e.isEnabled}serialize(){return{isEnabled:this.isEnabled,leftColor:this.leftColor.asArray(),rightColor:this.rightColor.asArray(),bias:this.bias,power:this.power}}static Parse(e){return new au({isEnabled:e.isEnabled,leftColor:q.FromArray(e.leftColor),rightColor:q.FromArray(e.rightColor),bias:e.bias,power:e.power||1})}}me._FresnelParametersParser=au.Parse;class Qi extends Ve{get doubleSided(){return this._twoSidedLighting}set doubleSided(e){this._twoSidedLighting!==e&&(this._twoSidedLighting=e,this.backFaceCulling=!e,this._markAllSubMeshesAsTexturesDirty())}constructor(e,t){super(e,t),this.maxSimultaneousLights=4,this.disableLighting=!1,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.emissiveColor=new q(0,0,0),this.occlusionStrength=1,this.useLightmapAsShadowmap=!1,this._useAlphaFromAlbedoTexture=!0,this._useAmbientInGrayScale=!0}getClassName(){return"PBRBaseSimpleMaterial"}}_([R(),W("_markAllSubMeshesAsLightsDirty")],Qi.prototype,"maxSimultaneousLights",void 0);_([R(),W("_markAllSubMeshesAsLightsDirty")],Qi.prototype,"disableLighting",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty","_reflectionTexture")],Qi.prototype,"environmentTexture",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],Qi.prototype,"invertNormalMapX",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],Qi.prototype,"invertNormalMapY",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty","_bumpTexture")],Qi.prototype,"normalTexture",void 0);_([Xt("emissive"),W("_markAllSubMeshesAsTexturesDirty")],Qi.prototype,"emissiveColor",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty")],Qi.prototype,"emissiveTexture",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty","_ambientTextureStrength")],Qi.prototype,"occlusionStrength",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty","_ambientTexture")],Qi.prototype,"occlusionTexture",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty","_alphaCutOff")],Qi.prototype,"alphaCutOff",void 0);_([R()],Qi.prototype,"doubleSided",null);_([We(),W("_markAllSubMeshesAsTexturesDirty",null)],Qi.prototype,"lightmapTexture",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],Qi.prototype,"useLightmapAsShadowmap",void 0);const eo={effect:null,subMesh:null};class fo{populateVectorFromLinkedProperties(e){const t=e.dimension[0];for(const i in this.linkedProperties){const r=this.linkedProperties[i],n=r.numComponents;if(t<n||r.targetUniformComponentOffset>t-n){n==1?N.Error(`Float property ${r.name} has an offset that is too large.`):N.Error(`Vector${n} property ${r.name} won't fit in Vector${t} or has an offset that is too large.`);return}typeof r.value=="number"?fo._tmpArray[r.targetUniformComponentOffset]=r.value:r.value.toArray(fo._tmpArray,r.targetUniformComponentOffset)}e.fromArray(fo._tmpArray)}constructor(e,t){this.linkedProperties={},this.name=e,this.numComponents=t}}fo._tmpArray=[0,0,0,0];class Wt{constructor(e,t,i,r,n=0){this.targetUniformComponentNum=4,this.targetUniformComponentOffset=0,this.name=e,this.targetUniformName=i,this.defaultValue=t,this.value=t,this.targetUniformComponentNum=r,this.targetUniformComponentOffset=n}get numComponents(){return typeof this.defaultValue=="number"?1:this.defaultValue.dimension[0]}}class Kt{get samplerName(){return this.samplerPrefix+"Sampler"}get samplerInfoName(){return"v"+this.samplerPrefix.charAt(0).toUpperCase()+this.samplerPrefix.slice(1)+"Infos"}get samplerMatrixName(){return this.samplerPrefix+"Matrix"}constructor(e,t,i){this.value=null,this.samplerPrefix="",this.textureDefine="",this.name=e,this.samplerPrefix=t,this.textureDefine=i}}class Q3 extends qm(Oi){}class dx extends Ou(Q3){constructor(e){super(e),this.NUM_SAMPLES="0",this.REALTIME_FILTERING=!1,this.IBL_CDF_FILTERING=!1,this.VERTEXCOLOR=!1,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.VERTEXALPHA=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHABLEND=!1,this.ALPHA_FROM_BASE_COLOR_TEXTURE=!1,this.ALPHATESTVALUE="0.5",this.PREMULTIPLYALPHA=!1,this.REFLECTIVITY_GAMMA=!1,this.REFLECTIVITYDIRECTUV=0,this.SPECULARTERM=!1,this.LODBASEDMICROSFURACE=!0,this.METALLICWORKFLOW=!0,this.ROUGHNESSSTOREINMETALMAPALPHA=!1,this.ROUGHNESSSTOREINMETALMAPGREEN=!1,this.METALLNESSSTOREINMETALMAPBLUE=!1,this.AOSTOREINMETALMAPRED=!1,this.SPECULAR_WEIGHT_IN_ALPHA=!1,this.SPECULAR_WEIGHT_FROM_SPECULAR_COLOR_TEXTURE=!1,this.SPECULAR_ROUGHNESS_ANISOTROPY_FROM_TANGENT_TEXTURE=!1,this.COAT_ROUGHNESS_ANISOTROPY_FROM_TANGENT_TEXTURE=!1,this.USE_GLTF_STYLE_ANISOTROPY=!1,this.THIN_FILM_THICKNESS_FROM_THIN_FILM_TEXTURE=!1,this.ENVIRONMENTBRDF=!1,this.ENVIRONMENTBRDF_RGBD=!1,this.NORMAL=!1,this.TANGENT=!1,this.OBJECTSPACE_NORMALMAP=!1,this.PARALLAX=!1,this.PARALLAX_RHS=!1,this.PARALLAXOCCLUSION=!1,this.NORMALXYSCALE=!0,this.ANISOTROPIC=!1,this.ANISOTROPIC_OPENPBR=!0,this.ANISOTROPIC_BASE=!1,this.ANISOTROPIC_COAT=!1,this.THIN_FILM=!1,this.IRIDESCENCE=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.USESPHERICALFROMREFLECTIONMAP=!1,this.USEIRRADIANCEMAP=!1,this.USE_IRRADIANCE_DOMINANT_DIRECTION=!1,this.USESPHERICALINVERTEX=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.RADIANCEOCCLUSION=!1,this.HORIZONOCCLUSION=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.PREPASS=!1,this.PREPASS_COLOR=!1,this.PREPASS_COLOR_INDEX=-1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO=!1,this.PREPASS_ALBEDO_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=!1,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.PREPASS_NORMALIZED_VIEW_DEPTH=!1,this.PREPASS_NORMALIZED_VIEW_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=!1,this.PREPASS_WORLD_NORMAL=!1,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=!1,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_VELOCITY_LINEAR=!1,this.PREPASS_VELOCITY_LINEAR_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.NONUNIFORMSCALING=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_POSITION=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.MORPHTARGETS_UV2=!1,this.MORPHTARGETS_COLOR=!1,this.MORPHTARGETTEXTURE_HASPOSITIONS=!1,this.MORPHTARGETTEXTURE_HASNORMALS=!1,this.MORPHTARGETTEXTURE_HASTANGENTS=!1,this.MORPHTARGETTEXTURE_HASUVS=!1,this.MORPHTARGETTEXTURE_HASUV2S=!1,this.MORPHTARGETTEXTURE_HASCOLORS=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.USEPHYSICALLIGHTFALLOFF=!1,this.USEGLTFLIGHTFALLOFF=!1,this.TWOSIDEDLIGHTING=!1,this.MIRRORED=!1,this.SHADOWFLOAT=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.LOGARITHMICDEPTH=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.AREALIGHTSUPPORTED=!0,this.FORCENORMALFORWARD=!1,this.SPECULARAA=!1,this.UNLIT=!1,this.DECAL_AFTER_DETAIL=!1,this.DEBUGMODE=0,this.CLUSTLIGHT_SLICES=0,this.CLUSTLIGHT_BATCH=0,this.BRDF_V_HEIGHT_CORRELATED=!0,this.MS_BRDF_ENERGY_CONSERVATION=!0,this.SPHERICAL_HARMONICS=!0,this.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=!0,this.MIX_IBL_RADIANCE_WITH_IRRADIANCE=!0,this.LEGACY_SPECULAR_ENERGY_CONSERVATION=!1,this.BASE_DIFFUSE_MODEL=0,this.DIELECTRIC_SPECULAR_MODEL=1,this.CONDUCTOR_SPECULAR_MODEL=1,this.rebuild()}reset(){super.reset(),this.ALPHATESTVALUE="0.5",this.NORMALXYSCALE=!0}}class K3 extends Nu(Zl){}class oe extends K3{get geometryTangentAngle(){return Math.atan2(this.geometryTangent.y,this.geometryTangent.x)}set geometryTangentAngle(e){this.geometryTangent=new X(Math.cos(e),Math.sin(e))}get geometryCoatTangentAngle(){return Math.atan2(this.geometryCoatTangent.y,this.geometryCoatTangent.x)}set geometryCoatTangentAngle(e){this.geometryCoatTangent=new X(Math.cos(e),Math.sin(e))}get usePhysicalLightFalloff(){return this._lightFalloff===Le.LIGHTFALLOFF_PHYSICAL}set usePhysicalLightFalloff(e){e!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=Le.LIGHTFALLOFF_PHYSICAL:this._lightFalloff=Le.LIGHTFALLOFF_STANDARD)}get useGLTFLightFalloff(){return this._lightFalloff===Le.LIGHTFALLOFF_GLTF}set useGLTFLightFalloff(e){e!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=Le.LIGHTFALLOFF_GLTF:this._lightFalloff=Le.LIGHTFALLOFF_STANDARD)}get realTimeFiltering(){return this._realTimeFiltering}set realTimeFiltering(e){this._realTimeFiltering=e,this.markAsDirty(1)}get realTimeFilteringQuality(){return this._realTimeFilteringQuality}set realTimeFilteringQuality(e){this._realTimeFilteringQuality=e,this.markAsDirty(1)}get canRenderToMRT(){return!0}constructor(e,t,i=!1){var n;super(e,t,void 0,i||oe.ForceGLSL),this._baseWeight=new Wt("base_weight",1,"vBaseWeight",1),this._baseWeightTexture=new Kt("base_weight","baseWeight","BASE_WEIGHT"),this._baseColor=new Wt("base_color",q.White(),"vBaseColor",4),this._baseColorTexture=new Kt("base_color","baseColor","BASE_COLOR"),this._baseDiffuseRoughness=new Wt("base_diffuse_roughness",0,"vBaseDiffuseRoughness",1),this._baseDiffuseRoughnessTexture=new Kt("base_diffuse_roughness","baseDiffuseRoughness","BASE_DIFFUSE_ROUGHNESS"),this._baseMetalness=new Wt("base_metalness",0,"vReflectanceInfo",4,0),this._baseMetalnessTexture=new Kt("base_metalness","baseMetalness","BASE_METALNESS"),this._specularWeight=new Wt("specular_weight",1,"vReflectanceInfo",4,3),this._specularWeightTexture=new Kt("specular_weight","specularWeight","SPECULAR_WEIGHT"),this._specularColor=new Wt("specular_color",q.White(),"vSpecularColor",4),this._specularColorTexture=new Kt("specular_color","specularColor","SPECULAR_COLOR"),this._specularRoughness=new Wt("specular_roughness",.3,"vReflectanceInfo",4,1),this._specularRoughnessTexture=new Kt("specular_roughness","specularRoughness","SPECULAR_ROUGHNESS"),this._specularRoughnessAnisotropy=new Wt("specular_roughness_anisotropy",0,"vSpecularAnisotropy",3,2),this._specularRoughnessAnisotropyTexture=new Kt("specular_roughness_anisotropy","specularRoughnessAnisotropy","SPECULAR_ROUGHNESS_ANISOTROPY"),this._specularIor=new Wt("specular_ior",1.5,"vReflectanceInfo",4,2),this._coatWeight=new Wt("coat_weight",0,"vCoatWeight",1,0),this._coatWeightTexture=new Kt("coat_weight","coatWeight","COAT_WEIGHT"),this._coatColor=new Wt("coat_color",q.White(),"vCoatColor",3,0),this._coatColorTexture=new Kt("coat_color","coatColor","COAT_COLOR"),this._coatRoughness=new Wt("coat_roughness",0,"vCoatRoughness",1,0),this._coatRoughnessTexture=new Kt("coat_roughness","coatRoughness","COAT_ROUGHNESS"),this._coatRoughnessAnisotropy=new Wt("coat_roughness_anisotropy",0,"vCoatRoughnessAnisotropy",1),this._coatRoughnessAnisotropyTexture=new Kt("coat_roughness_anisotropy","coatRoughnessAnisotropy","COAT_ROUGHNESS_ANISOTROPY"),this._coatIor=new Wt("coat_ior",1.5,"vCoatIor",1,0),this._coatDarkening=new Wt("coat_darkening",1,"vCoatDarkening",1,0),this._coatDarkeningTexture=new Kt("coat_darkening","coatDarkening","COAT_DARKENING"),this.useCoatRoughnessFromWeightTexture=!1,this._geometryNormalTexture=new Kt("geometry_normal","geometryNormal","GEOMETRY_NORMAL"),this._geometryTangent=new Wt("geometry_tangent",new X(1,0),"vSpecularAnisotropy",3,0),this._geometryTangentTexture=new Kt("geometry_tangent","geometryTangent","GEOMETRY_TANGENT"),this._geometryCoatNormalTexture=new Kt("geometry_coat_normal","geometryCoatNormal","GEOMETRY_COAT_NORMAL"),this._geometryCoatTangent=new Wt("geometry_coat_tangent",new X(1,0),"vGeometryCoatTangent",2,0),this._geometryCoatTangentTexture=new Kt("geometry_coat_tangent","geometryCoatTangent","GEOMETRY_COAT_TANGENT"),this._geometryOpacity=new Wt("geometry_opacity",1,"vBaseColor",4,3),this._geometryOpacityTexture=new Kt("geometry_opacity","geometryOpacity","GEOMETRY_OPACITY"),this._emissionLuminance=new Wt("emission_luminance",1,"vLightingIntensity",4,1),this._emissionColor=new Wt("emission_color",q.Black(),"vEmissionColor",3),this._emissionColorTexture=new Kt("emission_color","emissionColor","EMISSION_COLOR"),this._thinFilmWeight=new Wt("thin_film_weight",0,"vThinFilmWeight",1,0),this._thinFilmWeightTexture=new Kt("thin_film_weight","thinFilmWeight","THIN_FILM_WEIGHT"),this._thinFilmThickness=new Wt("thin_film_thickness",.5,"vThinFilmThickness",2,0),this._thinFilmThicknessMin=new Wt("thin_film_thickness_min",0,"vThinFilmThickness",2,1),this._thinFilmThicknessTexture=new Kt("thin_film_thickness","thinFilmThickness","THIN_FILM_THICKNESS"),this._thinFilmIor=new Wt("thin_film_ior",1.4,"vThinFilmIor",1,0),this._ambientOcclusionTexture=new Kt("ambient_occlusion","ambientOcclusion","AMBIENT_OCCLUSION"),this._uniformsList={},this._samplersList={},this._samplerDefines={},this.directIntensity=1,this.environmentIntensity=1,this.useSpecularWeightFromTextureAlpha=!1,this.forceAlphaTest=!1,this.alphaCutOff=.4,this.useAmbientOcclusionFromMetallicTextureRed=!1,this.useAmbientInGrayScale=!1,this.useObjectSpaceNormalMap=!1,this.useParallax=!1,this.useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this.disableLighting=!1,this.forceIrradianceInFragment=!1,this.maxSimultaneousLights=4,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.twoSidedLighting=!1,this.useAlphaFresnel=!1,this.useLinearAlphaFresnel=!1,this.environmentBRDFTexture=null,this.forceNormalForward=!1,this.enableSpecularAntiAliasing=!1,this.useHorizonOcclusion=!0,this.useRadianceOcclusion=!0,this.unlit=!1,this.applyDecalMapAfterDetailMap=!1,this._lightingInfos=new Ee(this.directIntensity,1,this.environmentIntensity,1),this._radianceTexture=null,this._useSpecularWeightFromAlpha=!1,this._useSpecularWeightFromSpecularColorTexture=!1,this._useSpecularRoughnessAnisotropyFromTangentTexture=!1,this._useCoatRoughnessAnisotropyFromTangentTexture=!1,this._useGltfStyleAnisotropy=!1,this._useHorizonOcclusion=!0,this._useRadianceOcclusion=!0,this._useAlphaFromBaseColorTexture=!1,this._useAmbientOcclusionFromMetallicTextureRed=!1,this._useRoughnessFromMetallicTextureGreen=!1,this._useMetallicFromMetallicTextureBlue=!1,this._useThinFilmThicknessFromTextureGreen=!1,this._lightFalloff=Le.LIGHTFALLOFF_PHYSICAL,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this._parallaxScaleBias=.05,this._disableLighting=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._alphaCutOff=.4,this._useAlphaFresnel=!1,this._useLinearAlphaFresnel=!1,this._environmentBRDFTexture=null,this._forceIrradianceInFragment=!1,this._realTimeFiltering=!1,this._realTimeFilteringQuality=8,this._forceNormalForward=!1,this._enableSpecularAntiAliasing=!1,this._renderTargets=new Xn(16),this._unlit=!1,this._applyDecalMapAfterDetailMap=!1,this._debugMode=0,this._shadersLoaded=!1,this._breakShaderLoadedCheck=!1,this.debugMode=0,this.debugLimit=-1,this.debugFactor=1,this._cacheHasRenderTargetTextures=!1,this._transparencyMode=Le.MATERIAL_OPAQUE,this.getScene()&&!((n=this.getScene())!=null&&n.getEngine().isWebGPU)&&this.getScene().getEngine().webGLVersion<2&&N.Error("OpenPBRMaterial: WebGL 2.0 or above is required for this material."),oe._noiseTextures[this.getScene().uniqueId]||(oe._noiseTextures[this.getScene().uniqueId]=new $("https://assets.babylonjs.com/textures/blue_noise/blue_noise_rgb.png",this.getScene(),!1,!0,1),this.getScene().onDisposeObservable.addOnce(()=>{var a;(a=oe._noiseTextures[this.getScene().uniqueId])==null||a.dispose(),delete oe._noiseTextures[this.getScene().uniqueId]})),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),K.ReflectionTextureEnabled&&this._radianceTexture&&this._radianceTexture.isRenderTarget&&this._renderTargets.push(this._radianceTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets),this._environmentBRDFTexture=gh(this.getScene()),this.prePassConfiguration=new Zc,this._propertyList={};for(const a of Object.getOwnPropertyNames(this)){const o=this[a];o instanceof Wt&&(this._propertyList[a]=o)}Object.keys(this._propertyList).forEach(a=>{const o=this._propertyList[a];let l=this._uniformsList[o.targetUniformName];l?l.numComponents!==o.targetUniformComponentNum&&N.Error(`Uniform ${o.targetUniformName} already exists of size ${l.numComponents}, but trying to set it to ${o.targetUniformComponentNum}.`):(l=new fo(o.targetUniformName,o.targetUniformComponentNum),this._uniformsList[o.targetUniformName]=l),l.linkedProperties[o.name]=o}),this._samplersList={};for(const a of Object.getOwnPropertyNames(this)){const o=this[a];o instanceof Kt&&(this._samplersList[a]=o)}for(const a in this._samplersList){const l=this._samplersList[a].textureDefine;this._samplerDefines[l]={type:"boolean",default:!1},this._samplerDefines[l+"DIRECTUV"]={type:"number",default:0},this._samplerDefines[l+"_GAMMA"]={type:"boolean",default:!1}}this._baseWeight,this._baseWeightTexture,this._baseColor,this._baseColorTexture,this._baseDiffuseRoughness,this._baseDiffuseRoughnessTexture,this._baseMetalness,this._baseMetalnessTexture,this._specularWeight,this._specularWeightTexture,this._specularColor,this._specularColorTexture,this._specularRoughness,this._specularIor,this._specularRoughnessTexture,this._specularRoughnessAnisotropy,this._specularRoughnessAnisotropyTexture,this._coatWeight,this._coatWeightTexture,this._coatColor,this._coatColorTexture,this._coatRoughness,this._coatRoughnessTexture,this._coatRoughnessAnisotropy,this._coatRoughnessAnisotropyTexture,this._coatIor,this._coatDarkening,this._coatDarkeningTexture,this._geometryNormalTexture,this._geometryTangent,this._geometryTangentTexture,this._geometryCoatNormalTexture,this._geometryCoatTangent,this._geometryCoatTangentTexture,this._geometryOpacity,this._geometryOpacityTexture,this._thinFilmWeight,this._thinFilmWeightTexture,this._thinFilmThickness,this._thinFilmThicknessMin,this._thinFilmThicknessTexture,this._thinFilmIor,this._emissionLuminance,this._emissionColor,this._emissionColorTexture,this._ambientOcclusionTexture}get hasRenderTargetTextures(){return K.ReflectionTextureEnabled&&this._radianceTexture&&this._radianceTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures}get isPrePassCapable(){return!this.disableDepthWrite}getClassName(){return"OpenPBRMaterial"}get transparencyMode(){return this._transparencyMode}set transparencyMode(e){this._transparencyMode!==e&&(this._transparencyMode=e,this._markAllSubMeshesAsTexturesAndMiscDirty())}_shouldUseAlphaFromBaseColorTexture(){return this._hasAlphaChannel()&&this._transparencyMode!==Le.MATERIAL_OPAQUE&&!this.geometryOpacityTexture}_hasAlphaChannel(){return this.baseColorTexture!=null&&this.baseColorTexture.hasAlpha&&this._useAlphaFromBaseColorTexture||this.geometryOpacityTexture!=null}clone(e,t=!0,i=""){const r=me.Clone(()=>new oe(e,this.getScene()),this,{cloneTexturesOnlyOnce:t});return r.id=e,r.name=e,this.stencil.copyTo(r.stencil),this._clonePlugins(r,i),r}serialize(){const e=super.serialize();return e.customType="BABYLON.OpenPBRMaterial",e}static Parse(e,t,i){const r=me.Parse(()=>new oe(e.name,t),e,t,i);return e.stencil&&r.stencil.parse(e.stencil,t,i),Le._ParsePlugins(e,r,t,i),r}forceCompilation(e,t,i){const r={clipPlane:!1,useInstances:!1,...i};this._uniformBufferLayoutBuilt||this.buildUniformLayout(),this._callbackPluginEventGeneric(4,this._eventInfo),(()=>{if(this._breakShaderLoadedCheck)return;const a=new dx({...this._eventInfo.defineNames||{},...this._samplerDefines||{}}),o=this._prepareEffect(e,e,a,void 0,void 0,r.useInstances,r.clipPlane);this._onEffectCreatedObservable&&(eo.effect=o,eo.subMesh=null,this._onEffectCreatedObservable.notifyObservers(eo)),o.isReady()?t&&t(this):o.onCompileObservable.add(()=>{t&&t(this)})})()}isReadyForSubMesh(e,t,i){var d;this._uniformBufferLayoutBuilt||this.buildUniformLayout();const r=t._drawWrapper;if(r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(4,this._eventInfo),t.materialDefines=new dx({...this._eventInfo.defineNames||{},...this._samplerDefines||{}}));const n=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const a=this.getScene(),o=a.getEngine();if(n._areTexturesDirty&&(this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,a.texturesEnabled)){for(const m in this._samplersList){const g=this._samplersList[m];if(g.value&&!g.value.isReadyOrNotBlocking())return!1}const f=this._getRadianceTexture();if(f&&K.ReflectionTextureEnabled){if(!f.isReadyOrNotBlocking())return!1;if(f.irradianceTexture){if(!f.irradianceTexture.isReadyOrNotBlocking())return!1}else if(!f.sphericalPolynomial&&((d=f.getInternalTexture())!=null&&d._sphericalPolynomialPromise))return!1}if(this._environmentBRDFTexture&&K.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady()||oe._noiseTextures[a.uniqueId]&&!oe._noiseTextures[a.uniqueId].isReady())return!1}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=n,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh||n._areImageProcessingDirty&&this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady())return!1;if(n.AREALIGHTUSED){for(let f=0;f<e.lightSources.length;f++)if(!e.lightSources[f]._isReady())return!1}!o.getCaps().standardDerivatives&&!e.isVerticesDataPresent(M.NormalKind)&&(e.createNormals(!0),N.Warn("OpenPBRMaterial: Normals have been created for the mesh: "+e.name));const l=t.effect,c=n._areLightsDisposed;let u=this._prepareEffect(e,t.getRenderingMesh(),n,this.onCompiled,this.onError,i,null),h=!1;if(u)if(this._onEffectCreatedObservable&&(eo.effect=u,eo.subMesh=t,this._onEffectCreatedObservable.notifyObservers(eo)),this.allowShaderHotSwapping&&l&&!u.isReady()){if(u=l,n.markAsUnprocessed(),h=this.isFrozen,c)return n._areLightsDisposed=!0,!1}else a.resetCachedMaterial(),t.setEffect(u,n,this._materialContext);return!t.effect||!t.effect.isReady()?!1:(n._renderId=a.getRenderId(),r._wasPreviouslyReady=!h,r._wasPreviouslyUsingInstances=!!i,this._checkScenePerformancePriority(),!0)}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("vTangentSpaceParams",2),e.addUniform("vLightingIntensity",4),e.addUniform("pointSize",1),e.addUniform("vDebugMode",2),e.addUniform("cameraInfo",4),Hm(e,!0,!0,!0,!0,!0),Object.values(this._uniformsList).forEach(t=>{e.addUniform(t.name,t.numComponents)}),Object.values(this._samplersList).forEach(t=>{e.addUniform(t.samplerInfoName,2),e.addUniform(t.samplerMatrixName,16)}),super.buildUniformLayout()}bindForSubMesh(e,t,i){var d;const r=this.getScene(),n=i.materialDefines;if(!n)return;const a=i.effect;if(!a)return;this._activeEffect=a,t.getMeshUniformBuffer().bindToEffect(a,"Mesh"),t.transferToEffect(e);const o=r.getEngine();this._uniformBuffer.bindToEffect(a,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,r,t,e,this.isFrozen),Ei.Bind(o.currentRenderPassId,this._activeEffect,t,e,this);const l=r.activeCamera;l?this._uniformBuffer.updateFloat4("cameraInfo",l.minZ,l.maxZ,0,0):this._uniformBuffer.updateFloat4("cameraInfo",0,0,0,0),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),n.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const c=this._mustRebind(r,a,i,t.visibility);Bo(t,this._activeEffect,this.prePassConfiguration);let u=null;const h=this._uniformBuffer;if(c){if(this.bindViewProjection(a),u=this._getRadianceTexture(),!h.useUbo||!this.isFrozen||!h.isSync||i._drawWrapper._forceRebindOnNextCall){if(r.texturesEnabled){for(const f in this._samplersList){const m=this._samplersList[f];m.value&&(h.updateFloat2(m.samplerInfoName,m.value.coordinatesIndex,m.value.level),Dt(m.value,h,m.samplerPrefix))}this.geometryNormalTexture&&(r._mirroredCameraPosition?h.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):h.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),$m(r,n,h,q.White(),u,this.realTimeFiltering,!0,!0,!0,!0,!0)}this.pointsCloud&&h.updateFloat("pointSize",this.pointSize),Object.values(this._uniformsList).forEach(f=>{f.numComponents===4?(f.populateVectorFromLinkedProperties(G.Vector4[0]),h.updateVector4(f.name,G.Vector4[0])):f.numComponents===3?(f.populateVectorFromLinkedProperties(G.Vector3[0]),h.updateVector3(f.name,G.Vector3[0])):f.numComponents===2?(f.populateVectorFromLinkedProperties(G.Vector2[0]),h.updateFloat2(f.name,G.Vector2[0].x,G.Vector2[0].y)):f.numComponents===1&&h.updateFloat(f.name,f.linkedProperties[Object.keys(f.linkedProperties)[0]].value)}),this._lightingInfos.x=this.directIntensity,this._lightingInfos.y=this.emissionLuminance,this._lightingInfos.z=this.environmentIntensity*r.environmentIntensity,this._lightingInfos.w=1,h.updateVector4("vLightingIntensity",this._lightingInfos),h.updateFloat2("vDebugMode",this.debugLimit,this.debugFactor)}if(r.texturesEnabled){for(const f in this._samplersList){const m=this._samplersList[f];m.value&&h.setTexture(m.samplerName,m.value)}Xm(r,n,h,u,this.realTimeFiltering),n.ENVIRONMENTBRDF&&h.setTexture("environmentBrdfSampler",this._environmentBRDFTexture),n.ANISOTROPIC&&h.setTexture("blueNoiseSampler",oe._noiseTextures[this.getScene().uniqueId])}this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(a),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),jn(this._activeEffect,this,r),this.bindEyePosition(a)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(c||!this.isFrozen)&&(r.lightsEnabled&&!this._disableLighting&&ql(r,t,this._activeEffect,n,this._maxSimultaneousLights),(r.fogEnabled&&t.applyFog&&r.fogMode!==le.FOGMODE_NONE||u||t.receiveShadows||n.PREPASS)&&this.bindView(a),Pu(r,t,this._activeEffect,!0),n.NUM_MORPH_INFLUENCERS&&Da(t,this._activeEffect),n.BAKED_VERTEX_ANIMATION_TEXTURE&&((d=t.bakedVertexAnimationManager)==null||d.bind(a,n.INSTANCES)),this._imageProcessingConfiguration.bind(this._activeEffect),Vo(n,this._activeEffect,r)),this._afterBind(t,this._activeEffect,i),h.update()}getAnimatables(){const e=super.getAnimatables();for(const t in this._samplersList){const i=this._samplersList[t];i.value&&i.value.animations&&i.value.animations.length>0&&e.push(i.value)}return this._radianceTexture&&this._radianceTexture.animations&&this._radianceTexture.animations.length>0&&e.push(this._radianceTexture),e}getActiveTextures(){const e=super.getActiveTextures();for(const t in this._samplersList){const i=this._samplersList[t];i.value&&e.push(i.value)}return this._radianceTexture&&e.push(this._radianceTexture),e}hasTexture(e){if(super.hasTexture(e))return!0;for(const t in this._samplersList)if(this._samplersList[t].value===e)return!0;return this._radianceTexture===e}setPrePassRenderer(){return!1}dispose(e,t){var i,r;if(this._breakShaderLoadedCheck=!0,t){this._environmentBRDFTexture&&this.getScene().environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose();for(const n in this._samplersList)(i=this._samplersList[n].value)==null||i.dispose();(r=this._radianceTexture)==null||r.dispose()}this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}_getRadianceTexture(){return this._radianceTexture?this._radianceTexture:this.getScene().environmentTexture}_prepareEffect(e,t,i,r=null,n=null,a=null,o=null){if(this._prepareDefines(e,t,i,a,o),!i.isDirty)return null;i.markAsProcessed();const c=this.getScene().getEngine(),u=new Ma;let h=0;i.USESPHERICALINVERTEX&&u.addFallback(h++,"USESPHERICALINVERTEX"),i.FOG&&u.addFallback(h,"FOG"),i.SPECULARAA&&u.addFallback(h,"SPECULARAA"),i.POINTSIZE&&u.addFallback(h,"POINTSIZE"),i.LOGARITHMICDEPTH&&u.addFallback(h,"LOGARITHMICDEPTH"),i.PARALLAX&&u.addFallback(h,"PARALLAX"),i.PARALLAX_RHS&&u.addFallback(h,"PARALLAX_RHS"),i.PARALLAXOCCLUSION&&u.addFallback(h++,"PARALLAXOCCLUSION"),i.ENVIRONMENTBRDF&&u.addFallback(h++,"ENVIRONMENTBRDF"),i.TANGENT&&u.addFallback(h++,"TANGENT"),h=Gm(i,u,this._maxSimultaneousLights,h++),i.SPECULARTERM&&u.addFallback(h++,"SPECULARTERM"),i.USESPHERICALFROMREFLECTIONMAP&&u.addFallback(h++,"USESPHERICALFROMREFLECTIONMAP"),i.USEIRRADIANCEMAP&&u.addFallback(h++,"USEIRRADIANCEMAP"),i.NORMAL&&u.addFallback(h++,"NORMAL"),i.VERTEXCOLOR&&u.addFallback(h++,"VERTEXCOLOR"),i.MORPHTARGETS&&u.addFallback(h++,"MORPHTARGETS"),i.MULTIVIEW&&u.addFallback(0,"MULTIVIEW");const d=[M.PositionKind];i.NORMAL&&d.push(M.NormalKind),i.TANGENT&&d.push(M.TangentKind);for(let I=1;I<=6;++I)i["UV"+I]&&d.push(`uv${I===1?"":I}`);i.VERTEXCOLOR&&d.push(M.ColorKind),zm(d,e,i,u),Ru(d,i),uI(d,e,i),hI(d,e,i);let f="openpbr";const m=["world","view","viewProjection","vEyePosition","vLightsType","visibility","vFogInfos","vFogColor","pointSize","mBones","normalMatrix","vLightingIntensity","logarithmicDepthConstant","vTangentSpaceParams","boneTextureWidth","vDebugMode","morphTargetTextureInfo","morphTargetTextureIndices","cameraInfo"];for(const I in this._uniformsList)m.push(I);const g=["environmentBrdfSampler","blueNoiseSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler","areaLightsLTC1Sampler","areaLightsLTC2Sampler"];for(const I in this._samplersList){const F=this._samplersList[I];g.push(F.samplerName),m.push(F.samplerInfoName),m.push(F.samplerMatrixName)}Wm(m,g,!0);const v=["Material","Scene","Mesh"],E={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:i.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=u,this._eventInfo.fallbackRank=h,this._eventInfo.defines=i,this._eventInfo.uniforms=m,this._eventInfo.attributes=d,this._eventInfo.samplers=g,this._eventInfo.uniformBuffersNames=v,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=E,this._callbackPluginEventGeneric(128,this._eventInfo),Ei.AddUniformsAndSamplers(m,g),Zc.AddUniforms(m),Na(m),bi&&(bi.PrepareUniforms(m,i),bi.PrepareSamplers(g,i)),Au({uniformsNames:m,uniformBuffersNames:v,samplers:g,defines:i,maxSimultaneousLights:this._maxSimultaneousLights});const T={};this.customShaderNameResolve&&(f=this.customShaderNameResolve(f,m,v,g,i,d,T));const C=i.toString(),A=c.createEffect(f,{attributes:d,uniformsNames:m,uniformBuffersNames:v,samplers:g,defines:C,fallbacks:u,onCompiled:r,onError:n,indexParameters:E,processFinalCode:T.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:i.PREPASS,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{this.shaderLanguage===1?await Promise.all([U(()=>Promise.resolve().then(()=>Ok),void 0),U(()=>Promise.resolve().then(()=>jk),void 0)]):await Promise.all([U(()=>Promise.resolve().then(()=>eG),void 0),U(()=>Promise.resolve().then(()=>vG),void 0)]),this._shadersLoaded=!0}},c);return this._eventInfo.customCode=void 0,A}_prepareDefines(e,t,i,r=null,n=null){const a=t.hasThinInstances,o=this.getScene(),l=o.getEngine();jl(o,e,i,!0,this._maxSimultaneousLights,this._disableLighting),i._needNormals=!0,bu(o,i);const c=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(jm(o,i,this.canRenderToMRT&&!c),dI(o,i,c),Ei.PrepareDefines(l.currentRenderPassId,e,i),i.METALLICWORKFLOW=!0,i._areTexturesDirty){i._needUVs=!1;for(let u=1;u<=6;++u)i["MAINUV"+u]=!1;if(o.texturesEnabled){for(const d in this._samplersList){const f=this._samplersList[d];f.value?(Nt(f.value,i,f.textureDefine),i[f.textureDefine+"_GAMMA"]=f.value.gammaSpace):i[f.textureDefine]=!1}const u=this._getRadianceTexture(),h=this._forceIrradianceInFragment||this.realTimeFiltering||this._twoSidedLighting||l.getCaps().maxVaryingVectors<=8||this._baseDiffuseRoughnessTexture!=null;km(o,u,i,this.realTimeFiltering,this.realTimeFilteringQuality,!h),this._baseMetalnessTexture&&(i.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed),i.SPECULAR_WEIGHT_IN_ALPHA=this._useSpecularWeightFromAlpha,i.SPECULAR_WEIGHT_FROM_SPECULAR_COLOR_TEXTURE=this._useSpecularWeightFromSpecularColorTexture,i.SPECULAR_ROUGHNESS_ANISOTROPY_FROM_TANGENT_TEXTURE=this._useSpecularRoughnessAnisotropyFromTangentTexture,i.COAT_ROUGHNESS_ANISOTROPY_FROM_TANGENT_TEXTURE=this._useCoatRoughnessAnisotropyFromTangentTexture,i.ROUGHNESSSTOREINMETALMAPGREEN=this._useRoughnessFromMetallicTextureGreen,i.METALLNESSSTOREINMETALMAPBLUE=this._useMetallicFromMetallicTextureBlue,i.THIN_FILM_THICKNESS_FROM_THIN_FILM_TEXTURE=this._useThinFilmThicknessFromTextureGreen,this.geometryNormalTexture?(this._useParallax&&this.baseColorTexture&&K.DiffuseTextureEnabled?(i.PARALLAX=!0,i.PARALLAX_RHS=o.useRightHandedSystem,i.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):i.PARALLAX=!1,i.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):(i.PARALLAX=!1,i.PARALLAX_RHS=!1,i.PARALLAXOCCLUSION=!1,i.OBJECTSPACE_NORMALMAP=!1),this._environmentBRDFTexture&&K.ReflectionTextureEnabled?(i.ENVIRONMENTBRDF=!0,i.ENVIRONMENTBRDF_RGBD=this._environmentBRDFTexture.isRGBD):(i.ENVIRONMENTBRDF=!1,i.ENVIRONMENTBRDF_RGBD=!1),this._shouldUseAlphaFromBaseColorTexture()?i.ALPHA_FROM_BASE_COLOR_TEXTURE=!0:i.ALPHA_FROM_BASE_COLOR_TEXTURE=!1}this._lightFalloff===Le.LIGHTFALLOFF_STANDARD?(i.USEPHYSICALLIGHTFALLOFF=!1,i.USEGLTFLIGHTFALLOFF=!1):this._lightFalloff===Le.LIGHTFALLOFF_GLTF?(i.USEPHYSICALLIGHTFALLOFF=!1,i.USEGLTFLIGHTFALLOFF=!0):(i.USEPHYSICALLIGHTFALLOFF=!0,i.USEGLTFLIGHTFALLOFF=!1),!this.backFaceCulling&&this._twoSidedLighting?i.TWOSIDEDLIGHTING=!0:i.TWOSIDEDLIGHTING=!1,i.MIRRORED=!!o._mirroredCameraPosition,i.SPECULARAA=l.getCaps().standardDerivatives&&this._enableSpecularAntiAliasing}(i._areTexturesDirty||i._areMiscDirty)&&(i.ALPHATESTVALUE=`${this._alphaCutOff}${this._alphaCutOff%1===0?".":""}`,i.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,i.ALPHABLEND=this.needAlphaBlendingForMesh(e)),i._areImageProcessingDirty&&this._imageProcessingConfiguration&&this._imageProcessingConfiguration.prepareDefines(i),i.FORCENORMALFORWARD=this._forceNormalForward,i.RADIANCEOCCLUSION=this._useRadianceOcclusion,i.HORIZONOCCLUSION=this._useHorizonOcclusion,(this.specularRoughnessAnisotropy>0||this.coatRoughnessAnisotropy>0)&&oe._noiseTextures[o.uniqueId]&&K.ReflectionTextureEnabled?(i.ANISOTROPIC=!0,e.isVerticesDataPresent(M.TangentKind)||(i._needUVs=!0,i.MAINUV1=!0),this._useGltfStyleAnisotropy&&(i.USE_GLTF_STYLE_ANISOTROPY=!0),i.ANISOTROPIC_BASE=this.specularRoughnessAnisotropy>0,i.ANISOTROPIC_COAT=this.coatRoughnessAnisotropy>0):(i.ANISOTROPIC=!1,i.USE_GLTF_STYLE_ANISOTROPY=!1,i.ANISOTROPIC_BASE=!1,i.ANISOTROPIC_COAT=!1),i.THIN_FILM=this.thinFilmWeight>0,i.IRIDESCENCE=this.thinFilmWeight>0,i._areMiscDirty&&(Cu(e,o,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this.needAlphaTestingForMesh(e),i,this._applyDecalMapAfterDetailMap,this._useVertexPulling,t,this._setVertexOutputInvariant),i.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!e.isVerticesDataPresent(M.NormalKind),i.DEBUGMODE=this._debugMode),yu(o,l,this,i,!!r,n,a),this._eventInfo.defines=i,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),Iu(e,i,!0,!0,!0,this._transparencyMode!==Le.MATERIAL_OPAQUE),this._callbackPluginEventPrepareDefines(this._eventInfo)}}oe._noiseTextures={};oe.ForceGLSL=!1;_([ke("_markAllSubMeshesAsTexturesDirty","baseWeight")],oe.prototype,"_baseWeight",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","baseWeightTexture")],oe.prototype,"_baseWeightTexture",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","baseColor")],oe.prototype,"_baseColor",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","baseColorTexture")],oe.prototype,"_baseColorTexture",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","baseDiffuseRoughness")],oe.prototype,"_baseDiffuseRoughness",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","baseDiffuseRoughnessTexture")],oe.prototype,"_baseDiffuseRoughnessTexture",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","baseMetalness")],oe.prototype,"_baseMetalness",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","baseMetalnessTexture")],oe.prototype,"_baseMetalnessTexture",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","specularWeight")],oe.prototype,"_specularWeight",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","specularWeightTexture")],oe.prototype,"_specularWeightTexture",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","specularColor")],oe.prototype,"_specularColor",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","specularColorTexture")],oe.prototype,"_specularColorTexture",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","specularRoughness")],oe.prototype,"_specularRoughness",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","specularRoughnessTexture")],oe.prototype,"_specularRoughnessTexture",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","specularRoughnessAnisotropy")],oe.prototype,"_specularRoughnessAnisotropy",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","specularRoughnessAnisotropyTexture")],oe.prototype,"_specularRoughnessAnisotropyTexture",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","specularIor")],oe.prototype,"_specularIor",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","coatWeight")],oe.prototype,"_coatWeight",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","coatWeightTexture")],oe.prototype,"_coatWeightTexture",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","coatColor")],oe.prototype,"_coatColor",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","coatColorTexture")],oe.prototype,"_coatColorTexture",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","coatRoughness")],oe.prototype,"_coatRoughness",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","coatRoughnessTexture")],oe.prototype,"_coatRoughnessTexture",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","coatRoughnessAnisotropy")],oe.prototype,"_coatRoughnessAnisotropy",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","coatRoughnessAnisotropyTexture")],oe.prototype,"_coatRoughnessAnisotropyTexture",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","coatIor")],oe.prototype,"_coatIor",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","coatDarkening")],oe.prototype,"_coatDarkening",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","coatDarkeningTexture")],oe.prototype,"_coatDarkeningTexture",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","geometryNormalTexture")],oe.prototype,"_geometryNormalTexture",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","geometryTangent")],oe.prototype,"_geometryTangent",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","geometryTangentTexture")],oe.prototype,"_geometryTangentTexture",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","geometryCoatNormalTexture")],oe.prototype,"_geometryCoatNormalTexture",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","geometryCoatTangent")],oe.prototype,"_geometryCoatTangent",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","geometryCoatTangentTexture")],oe.prototype,"_geometryCoatTangentTexture",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","geometryOpacity")],oe.prototype,"_geometryOpacity",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","geometryOpacityTexture")],oe.prototype,"_geometryOpacityTexture",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","emissionLuminance")],oe.prototype,"_emissionLuminance",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","emissionColor")],oe.prototype,"_emissionColor",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","emissionColorTexture")],oe.prototype,"_emissionColorTexture",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","thinFilmWeight")],oe.prototype,"_thinFilmWeight",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","thinFilmWeightTexture")],oe.prototype,"_thinFilmWeightTexture",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","thinFilmThickness")],oe.prototype,"_thinFilmThickness",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","thinFilmThicknessMin")],oe.prototype,"_thinFilmThicknessMin",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","thinFilmThicknessTexture")],oe.prototype,"_thinFilmThicknessTexture",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","thinFilmIor")],oe.prototype,"_thinFilmIor",void 0);_([ke("_markAllSubMeshesAsTexturesDirty","ambientOcclusionTexture")],oe.prototype,"_ambientOcclusionTexture",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"directIntensity",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"environmentIntensity",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useSpecularWeightFromTextureAlpha",void 0);_([R(),W("_markAllSubMeshesAsTexturesAndMiscDirty")],oe.prototype,"forceAlphaTest",void 0);_([R(),W("_markAllSubMeshesAsTexturesAndMiscDirty")],oe.prototype,"alphaCutOff",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useAmbientInGrayScale",void 0);_([R()],oe.prototype,"usePhysicalLightFalloff",null);_([R()],oe.prototype,"useGLTFLightFalloff",null);_([R(),W("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useObjectSpaceNormalMap",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useParallax",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useParallaxOcclusion",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"parallaxScaleBias",void 0);_([R(),W("_markAllSubMeshesAsLightsDirty")],oe.prototype,"disableLighting",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"forceIrradianceInFragment",void 0);_([R(),W("_markAllSubMeshesAsLightsDirty")],oe.prototype,"maxSimultaneousLights",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"invertNormalMapX",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"invertNormalMapY",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"twoSidedLighting",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useAlphaFresnel",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useLinearAlphaFresnel",void 0);_([W("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"environmentBRDFTexture",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"forceNormalForward",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"enableSpecularAntiAliasing",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useHorizonOcclusion",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useRadianceOcclusion",void 0);_([R(),W("_markAllSubMeshesAsMiscDirty")],oe.prototype,"unlit",void 0);_([R(),W("_markAllSubMeshesAsMiscDirty")],oe.prototype,"applyDecalMapAfterDetailMap",void 0);_([W("_markAllSubMeshesAsMiscDirty")],oe.prototype,"debugMode",void 0);_([R()],oe.prototype,"transparencyMode",null);y("BABYLON.OpenPBRMaterial",oe);class En extends Qi{constructor(e,t){super(e,t),this._useRoughnessFromMetallicTextureAlpha=!1,this._useRoughnessFromMetallicTextureGreen=!0,this._useMetallnessFromMetallicTextureBlue=!0,this.metallic=1,this.roughness=1}getClassName(){return"PBRMetallicRoughnessMaterial"}clone(e){const t=me.Clone(()=>new En(e,this.getScene()),this);return t.id=e,t.name=e,this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){const e=me.Serialize(this);return e.customType="BABYLON.PBRMetallicRoughnessMaterial",this.clearCoat.doNotSerialize||(e.clearCoat=this.clearCoat.serialize()),this.anisotropy.doNotSerialize||(e.anisotropy=this.anisotropy.serialize()),this.brdf.doNotSerialize||(e.brdf=this.brdf.serialize()),this.sheen.doNotSerialize||(e.sheen=this.sheen.serialize()),this.subSurface.doNotSerialize||(e.subSurface=this.subSurface.serialize()),this.iridescence.doNotSerialize||(e.iridescence=this.iridescence.serialize()),e}static Parse(e,t,i){const r=me.Parse(()=>new En(e.name,t),e,t,i);return e.clearCoat&&r.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&r.anisotropy.parse(e.anisotropy,t,i),e.brdf&&r.brdf.parse(e.brdf,t,i),e.sheen&&r.sheen.parse(e.sheen,t,i),e.subSurface&&r.subSurface.parse(e.subSurface,t,i),e.iridescence&&r.iridescence.parse(e.iridescence,t,i),r}}_([Xt(),W("_markAllSubMeshesAsTexturesDirty","_albedoColor")],En.prototype,"baseColor",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],En.prototype,"baseTexture",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],En.prototype,"metallic",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],En.prototype,"roughness",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty","_metallicTexture")],En.prototype,"metallicRoughnessTexture",void 0);y("BABYLON.PBRMetallicRoughnessMaterial",En);class Tn extends Qi{get useMicroSurfaceFromReflectivityMapAlpha(){return this._useMicroSurfaceFromReflectivityMapAlpha}constructor(e,t){super(e,t),this._useMicroSurfaceFromReflectivityMapAlpha=!0}getClassName(){return"PBRSpecularGlossinessMaterial"}clone(e){const t=me.Clone(()=>new Tn(e,this.getScene()),this);return t.id=e,t.name=e,this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){const e=me.Serialize(this);return e.customType="BABYLON.PBRSpecularGlossinessMaterial",this.clearCoat.doNotSerialize||(e.clearCoat=this.clearCoat.serialize()),this.anisotropy.doNotSerialize||(e.anisotropy=this.anisotropy.serialize()),this.brdf.doNotSerialize||(e.brdf=this.brdf.serialize()),this.sheen.doNotSerialize||(e.sheen=this.sheen.serialize()),this.subSurface.doNotSerialize||(e.subSurface=this.subSurface.serialize()),this.iridescence.doNotSerialize||(e.iridescence=this.iridescence.serialize()),e}static Parse(e,t,i){const r=me.Parse(()=>new Tn(e.name,t),e,t,i);return e.clearCoat&&r.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&r.anisotropy.parse(e.anisotropy,t,i),e.brdf&&r.brdf.parse(e.brdf,t,i),e.sheen&&r.sheen.parse(e.sheen,t,i),e.subSurface&&r.subSurface.parse(e.subSurface,t,i),e.iridescence&&r.iridescence.parse(e.iridescence,t,i),r}}_([Xt("diffuse"),W("_markAllSubMeshesAsTexturesDirty","_albedoColor")],Tn.prototype,"diffuseColor",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],Tn.prototype,"diffuseTexture",void 0);_([Xt("specular"),W("_markAllSubMeshesAsTexturesDirty","_reflectivityColor")],Tn.prototype,"specularColor",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty","_microSurface")],Tn.prototype,"glossiness",void 0);_([We(),W("_markAllSubMeshesAsTexturesDirty","_reflectivityTexture")],Tn.prototype,"specularGlossinessTexture",void 0);y("BABYLON.PBRSpecularGlossinessMaterial",Tn);const fx="pbrUboDeclaration",J3=`uniform vAlbedoInfos: vec2f;uniform vBaseWeightInfos: vec2f;uniform vBaseDiffuseRoughnessInfos: vec2f;uniform vAmbientInfos: vec4f;uniform vOpacityInfos: vec2f;uniform vEmissiveInfos: vec2f;uniform vLightmapInfos: vec2f;uniform vReflectivityInfos: vec3f;uniform vMicroSurfaceSamplerInfos: vec2f;uniform vBumpInfos: vec3f;uniform albedoMatrix: mat4x4f;uniform baseWeightMatrix: mat4x4f;uniform baseDiffuseRoughnessMatrix: mat4x4f;uniform ambientMatrix: mat4x4f;uniform opacityMatrix: mat4x4f;uniform emissiveMatrix: mat4x4f;uniform lightmapMatrix: mat4x4f;uniform reflectivityMatrix: mat4x4f;uniform microSurfaceSamplerMatrix: mat4x4f;uniform bumpMatrix: mat4x4f;uniform vTangentSpaceParams: vec2f;uniform vAlbedoColor: vec4f;uniform baseWeight: f32;uniform baseDiffuseRoughness: f32;uniform vLightingIntensity: vec4f;uniform pointSize: f32;uniform vReflectivityColor: vec4f;uniform vEmissiveColor: vec3f;uniform vAmbientColor: vec3f;uniform vDebugMode: vec2f;uniform vMetallicReflectanceFactors: vec4f;uniform vMetallicReflectanceInfos: vec2f;uniform metallicReflectanceMatrix: mat4x4f;uniform vReflectanceInfos: vec2f;uniform reflectanceMatrix: mat4x4f;uniform cameraInfo: vec4f;uniform vReflectionInfos: vec2f;uniform reflectionMatrix: mat4x4f;uniform vReflectionMicrosurfaceInfos: vec3f;uniform vReflectionPosition: vec3f;uniform vReflectionSize: vec3f;uniform vReflectionFilteringInfo: vec2f;uniform vReflectionDominantDirection: vec3f;uniform vReflectionColor: vec3f;uniform vSphericalL00: vec3f;uniform vSphericalL1_1: vec3f;uniform vSphericalL10: vec3f;uniform vSphericalL11: vec3f;uniform vSphericalL2_2: vec3f;uniform vSphericalL2_1: vec3f;uniform vSphericalL20: vec3f;uniform vSphericalL21: vec3f;uniform vSphericalL22: vec3f;uniform vSphericalX: vec3f;uniform vSphericalY: vec3f;uniform vSphericalZ: vec3f;uniform vSphericalXX_ZZ: vec3f;uniform vSphericalYY_ZZ: vec3f;uniform vSphericalZZ: vec3f;uniform vSphericalXY: vec3f;uniform vSphericalYZ: vec3f;uniform vSphericalZX: vec3f;
#define ADDITIONAL_UBO_DECLARATION
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;S.IncludesShadersStoreWGSL[fx]||(S.IncludesShadersStoreWGSL[fx]=J3);const px="pbrBRDFFunctions",eU=`#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
#define BRDF_DIFFUSE_MODEL_EON 0
#define BRDF_DIFFUSE_MODEL_BURLEY 1
#define BRDF_DIFFUSE_MODEL_LAMBERT 2
#define BRDF_DIFFUSE_MODEL_LEGACY 3
#define DIELECTRIC_SPECULAR_MODEL_GLTF 0
#define DIELECTRIC_SPECULAR_MODEL_OPENPBR 1
#define CONDUCTOR_SPECULAR_MODEL_GLTF 0
#define CONDUCTOR_SPECULAR_MODEL_OPENPBR 1
#if !defined(PBR_VERTEX_SHADER) && !defined(OPENPBR_VERTEX_SHADER)
#ifdef MS_BRDF_ENERGY_CONSERVATION
fn getEnergyConservationFactor(specularEnvironmentR0: vec3f,environmentBrdf: vec3f)->vec3f {return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);}
#endif
#if CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR 
fn getF82Specular(NdotV: f32,F0: vec3f,edgeTint: vec3f,roughness: f32)->vec3f {const cos_theta_max: f32=0.142857143; 
const one_minus_cos_theta_max_to_the_fifth: f32=0.462664366; 
const one_minus_cos_theta_max_to_the_sixth: f32=0.396569457; 
let white_minus_F0: vec3f=vec3f(1.0f)-F0;let b_numerator: vec3f=(F0+white_minus_F0*one_minus_cos_theta_max_to_the_fifth)*(vec3f(1.0)-edgeTint);const b_denominator: f32=cos_theta_max*one_minus_cos_theta_max_to_the_sixth;const b_denominator_reciprocal: f32=1.0f/b_denominator;let b: vec3f=b_numerator*b_denominator_reciprocal; 
let cos_theta: f32=max(roughness,NdotV);let one_minus_cos_theta: f32=1.0-cos_theta;let offset_from_F0: vec3f=(white_minus_F0-b*cos_theta*one_minus_cos_theta)*pow(one_minus_cos_theta,5.0f);return clamp(F0+offset_from_F0,vec3f(0.0f),vec3f(1.0f));}
#endif
#ifdef ENVIRONMENTBRDF
fn getBRDFLookup(NdotV: f32,perceptualRoughness: f32)->vec3f {var UV: vec2f= vec2f(NdotV,perceptualRoughness);var brdfLookup: vec4f= textureSample(environmentBrdfSampler,environmentBrdfSamplerSampler,UV);
#ifdef ENVIRONMENTBRDF_RGBD
brdfLookup=vec4f(fromRGBD(brdfLookup.rgba),brdfLookup.a);
#endif
return brdfLookup.rgb;}
fn getReflectanceFromBRDFWithEnvLookup(specularEnvironmentR0: vec3f,specularEnvironmentR90: vec3f,environmentBrdf: vec3f)->vec3f {
#ifdef BRDF_V_HEIGHT_CORRELATED
var reflectance: vec3f=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;
#else
var reflectance: vec3f=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;
#endif
return reflectance;}
fn getReflectanceFromBRDFLookup(specularEnvironmentR0: vec3f,environmentBrdf: vec3f)->vec3f {
#ifdef BRDF_V_HEIGHT_CORRELATED
var reflectance: vec3f=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);
#else
var reflectance: vec3f=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;
#endif
return reflectance;}
#endif
/* NOT USED
#if defined(SHEEN) && defined(SHEEN_SOFTER)
fn getBRDFLookupCharlieSheen(NdotV: f32,perceptualRoughness: f32)->f32
{var c: f32=1.0-NdotV;var c3: f32=c*c*c;return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));}
#endif
*/
#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)
fn getReflectanceFromAnalyticalBRDFLookup_Jones(VdotN: f32,reflectance0: vec3f,reflectance90: vec3f,smoothness: f32)->vec3f
{var weight: f32=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
/**
* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.
* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table
*/
fn getSheenReflectanceFromBRDFLookup(reflectance0: vec3f,environmentBrdf: vec3f)->vec3f {var sheenEnvironmentReflectance: vec3f=reflectance0*environmentBrdf.b;return sheenEnvironmentReflectance;}
#endif
fn fresnelSchlickGGXVec3(VdotH: f32,reflectance0: vec3f,reflectance90: vec3f)->vec3f
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
fn fresnelSchlickGGX(VdotH: f32,reflectance0: f32,reflectance90: f32)->f32
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
#ifdef CLEARCOAT
fn getR0RemappedForClearCoat(f0: vec3f)->vec3f {
#ifdef CLEARCOAT_DEFAULTIOR
#ifdef MOBILE
return saturateVec3(f0*(f0*0.526868+0.529324)-0.0482256);
#else
return saturateVec3(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);
#endif
#else
var s: vec3f=sqrt(f0);var t: vec3f=(uniforms.vClearCoatRefractionParams.z+uniforms.vClearCoatRefractionParams.w*s)/(uniforms.vClearCoatRefractionParams.w+uniforms.vClearCoatRefractionParams.z*s);return squareVec3(t);
#endif
}
#endif
#ifdef IRIDESCENCE
const XYZ_TO_REC709: mat3x3f= mat3x3f(
3.2404542,-0.9692660, 0.0556434,
-1.5371385, 1.8760108,-0.2040259,
-0.4985314, 0.0415560, 1.0572252
);fn getIORTfromAirToSurfaceR0(f0: vec3f)->vec3f {var sqrtF0: vec3f=sqrt(f0);return (1.+sqrtF0)/(1.-sqrtF0);}
fn getR0fromIORsVec3(iorT: vec3f,iorI: f32)->vec3f {return squareVec3((iorT- vec3f(iorI))/(iorT+ vec3f(iorI)));}
fn getR0fromIORs(iorT: f32,iorI: f32)->f32 {return square((iorT-iorI)/(iorT+iorI));}
fn evalSensitivity(opd: f32,shift: vec3f)->vec3f {var phase: f32=2.0*PI*opd*1.0e-9;const val: vec3f= vec3f(5.4856e-13,4.4201e-13,5.2481e-13);const pos: vec3f= vec3f(1.6810e+06,1.7953e+06,2.2084e+06);const vr: vec3f= vec3f(4.3278e+09,9.3046e+09,6.6121e+09);var xyz: vec3f=val*sqrt(2.0*PI*vr)*cos(pos*phase+shift)*exp(-square(phase)*vr);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));xyz/=1.0685e-7;var srgb: vec3f=XYZ_TO_REC709*xyz;return srgb;}
fn evalIridescence(outsideIOR: f32,eta2: f32,cosTheta1: f32,thinFilmThickness: f32,baseF0: vec3f)->vec3f {var I: vec3f= vec3f(1.0);var iridescenceIOR: f32=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));var sinTheta2Sq: f32=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));var cosTheta2Sq: f32=1.0-sinTheta2Sq;if (cosTheta2Sq<0.0) {return I;}
var cosTheta2: f32=sqrt(cosTheta2Sq);var R0: f32=getR0fromIORs(iridescenceIOR,outsideIOR);var R12: f32=fresnelSchlickGGX(cosTheta1,R0,1.);var R21: f32=R12;var T121: f32=1.0-R12;var phi12: f32=0.0;if (iridescenceIOR<outsideIOR) {phi12=PI;}
var phi21: f32=PI-phi12;var baseIOR: vec3f=getIORTfromAirToSurfaceR0(clamp(baseF0,vec3f(0.0),vec3f(0.9999))); 
var R1: vec3f=getR0fromIORsVec3(baseIOR,iridescenceIOR);var R23: vec3f=fresnelSchlickGGXVec3(cosTheta2,R1, vec3f(1.));var phi23: vec3f= vec3f(0.0);if (baseIOR[0]<iridescenceIOR) {phi23[0]=PI;}
if (baseIOR[1]<iridescenceIOR) {phi23[1]=PI;}
if (baseIOR[2]<iridescenceIOR) {phi23[2]=PI;}
var opd: f32=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;var phi: vec3f= vec3f(phi21)+phi23;var R123: vec3f=clamp(R12*R23,vec3f(1e-5),vec3f(0.9999));var r123: vec3f=sqrt(R123);var Rs: vec3f=(T121*T121)*R23/( vec3f(1.0)-R123);var C0: vec3f=R12+Rs;I=C0;var Cm: vec3f=Rs-T121;for (var m: i32=1; m<=2; m++)
{Cm*=r123;var Sm: vec3f=2.0*evalSensitivity( f32(m)*opd, f32(m)*phi);I+=Cm*Sm;}
return max(I, vec3f(0.0));}
#endif
fn normalDistributionFunction_TrowbridgeReitzGGX(NdotH: f32,alphaG: f32)->f32
{var a2: f32=alphaG*alphaG;var d: f32=NdotH*NdotH*(a2-1.0)+1.0;return a2/(PI*d*d);}
#ifdef SHEEN
fn normalDistributionFunction_CharlieSheen(NdotH: f32,alphaG: f32)->f32
{var invR: f32=1./alphaG;var cos2h: f32=NdotH*NdotH;var sin2h: f32=1.-cos2h;return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);}
#endif
#ifdef ANISOTROPIC
fn normalDistributionFunction_BurleyGGX_Anisotropic(NdotH: f32,TdotH: f32,BdotH: f32,alphaTB: vec2f)->f32 {var a2: f32=alphaTB.x*alphaTB.y;var v: vec3f= vec3f(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);var v2: f32=dot(v,v);var w2: f32=a2/v2;return a2*w2*w2*RECIPROCAL_PI;}
#endif
#ifdef BRDF_V_HEIGHT_CORRELATED
fn smithVisibility_GGXCorrelated(NdotL: f32,NdotV: f32,alphaG: f32)->f32 {
#ifdef MOBILE
var GGXV: f32=NdotL*(NdotV*(1.0-alphaG)+alphaG);var GGXL: f32=NdotV*(NdotL*(1.0-alphaG)+alphaG);return 0.5/(GGXV+GGXL);
#else
var a2: f32=alphaG*alphaG;var GGXV: f32=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);var GGXL: f32=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);return 0.5/(GGXV+GGXL);
#endif
}
#else
fn smithVisibilityG1_TrowbridgeReitzGGXFast(dot: f32,alphaG: f32)->f32
{
#ifdef MOBILE
return 1.0/(dot+alphaG+(1.0-alphaG)*dot ));
#else
var alphaSquared: f32=alphaG*alphaG;return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));
#endif
}
fn smithVisibility_TrowbridgeReitzGGXFast(NdotL: f32,NdotV: f32,alphaG: f32)->f32
{var visibility: f32=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);return visibility;}
#endif
#ifdef ANISOTROPIC
fn smithVisibility_GGXCorrelated_Anisotropic(NdotL: f32,NdotV: f32,TdotV: f32,BdotV: f32,TdotL: f32,BdotL: f32,alphaTB: vec2f)->f32 {var lambdaV: f32=NdotL*length( vec3f(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));var lambdaL: f32=NdotV*length( vec3f(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));var v: f32=0.5/(lambdaV+lambdaL);return v;}
#endif
#ifdef CLEARCOAT
fn visibility_Kelemen(VdotH: f32)->f32 {return 0.25/(VdotH*VdotH); }
#endif
#ifdef SHEEN
fn visibility_Ashikhmin(NdotL: f32,NdotV: f32)->f32
{return 1./(4.*(NdotL+NdotV-NdotL*NdotV));}
/* NOT USED
#ifdef SHEEN_SOFTER
fn l(x: f32,alphaG: f32)->f32
{var oneMinusAlphaSq: f32=(1.0-alphaG)*(1.0-alphaG);var a: f32=mix(21.5473,25.3245,oneMinusAlphaSq);var b: f32=mix(3.82987,3.32435,oneMinusAlphaSq);var c: f32=mix(0.19823,0.16801,oneMinusAlphaSq);var d: f32=mix(-1.97760,-1.27393,oneMinusAlphaSq);var e: f32=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}
fn lambdaSheen(cosTheta: f32,alphaG: f32)->f32
{return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));}
fn visibility_CharlieSheen(NdotL: f32,NdotV: f32,alphaG: f32)->f32
{var G: f32=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));return G/(4.0*NdotV*NdotL);}
#endif
*/
#endif
const constant1_FON: f32=0.5f-2.0f/(3.0f*PI);const constant2_FON: f32=2.0f/3.0f-28.0f/(15.0f*PI);fn E_FON_approx(mu: f32,roughness: f32)->f32
{var sigma: f32=roughness; 
var mucomp: f32=1.0f-mu;var mucomp2: f32=mucomp*mucomp;const Gcoeffs: mat2x2f=mat2x2f(0.0571085289f,-0.332181442f,
0.491881867f,0.0714429953f);var GoverPi: f32=dot(Gcoeffs*vec2f(mucomp,mucomp2),vec2f(1.0f,mucomp2));return (1.0f+sigma*GoverPi)/(1.0f+constant1_FON*sigma);}
fn diffuseBRDF_EON(albedo: vec3f,roughness: f32,NdotL: f32,NdotV: f32,LdotV: f32)->vec3f
{var rho: vec3f=albedo;var sigma: f32=roughness; 
var mu_i: f32=NdotL; 
var mu_o: f32=NdotV; 
var s: f32=LdotV-mu_i*mu_o; 
var sovertF: f32=select(s,s/max(mu_i,mu_o),s>0.0f); 
var AF: f32=1.0f/(1.0f+constant1_FON*sigma); 
var f_ss: vec3f=(rho*RECIPROCAL_PI)*AF*(1.0f+sigma*sovertF); 
var EFo: f32=E_FON_approx(mu_o,sigma); 
var EFi: f32=E_FON_approx(mu_i,sigma); 
var avgEF: f32=AF*(1.0f+constant2_FON*sigma); 
var rho_ms: vec3f=(rho*rho)*avgEF/(vec3f(1.0f)-rho*(1.0f-avgEF));const eps: f32=1.0e-7f;var f_ms: vec3f=(rho_ms*RECIPROCAL_PI)*max(eps,1.0f-EFo) 
* max(eps,1.0f-EFi)
/ max(eps,1.0f-avgEF);return (f_ss+f_ms);}
fn diffuseBRDF_Burley(NdotL: f32,NdotV: f32,VdotH: f32,roughness: f32)->f32 {var diffuseFresnelNV: f32=pow5(saturateEps(1.0-NdotL));var diffuseFresnelNL: f32=pow5(saturateEps(1.0-NdotV));var diffuseFresnel90: f32=0.5+2.0*VdotH*VdotH*roughness;var fresnel: f32 =
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);return fresnel/PI;}
#ifdef SS_TRANSLUCENCY
fn transmittanceBRDF_Burley(tintColor: vec3f,diffusionDistance: vec3f,thickness: f32)->vec3f {var S: vec3f=1./maxEpsVec3(diffusionDistance);var temp: vec3f=exp((-0.333333333*thickness)*S);return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);}
fn computeWrappedDiffuseNdotL(NdotL: f32,w: f32)->f32 {var t: f32=1.0+w;var invt2: f32=1.0/(t*t);return saturate((NdotL+w)*invt2);}
#endif
#endif 
`;S.IncludesShadersStoreWGSL[px]||(S.IncludesShadersStoreWGSL[px]=eU);const mx="harmonicsFunctions",tU=`#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
fn computeEnvironmentIrradiance(normal: vec3f)->vec3f {return uniforms.vSphericalL00
+ uniforms.vSphericalL1_1*(normal.y)
+ uniforms.vSphericalL10*(normal.z)
+ uniforms.vSphericalL11*(normal.x)
+ uniforms.vSphericalL2_2*(normal.y*normal.x)
+ uniforms.vSphericalL2_1*(normal.y*normal.z)
+ uniforms.vSphericalL20*((3.0*normal.z*normal.z)-1.0)
+ uniforms.vSphericalL21*(normal.z*normal.x)
+ uniforms.vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));}
#else
fn computeEnvironmentIrradiance(normal: vec3f)->vec3f {var Nx: f32=normal.x;var Ny: f32=normal.y;var Nz: f32=normal.z;var C1: vec3f=uniforms.vSphericalZZ.rgb;var Cx: vec3f=uniforms.vSphericalX.rgb;var Cy: vec3f=uniforms.vSphericalY.rgb;var Cz: vec3f=uniforms.vSphericalZ.rgb;var Cxx_zz: vec3f=uniforms.vSphericalXX_ZZ.rgb;var Cyy_zz: vec3f=uniforms.vSphericalYY_ZZ.rgb;var Cxy: vec3f=uniforms.vSphericalXY.rgb;var Cyz: vec3f=uniforms.vSphericalYZ.rgb;var Czx: vec3f=uniforms.vSphericalZX.rgb;var a1: vec3f=Cyy_zz*Ny+Cy;var a2: vec3f=Cyz*Nz+a1;var b1: vec3f=Czx*Nz+Cx;var b2: vec3f=Cxy*Ny+b1;var b3: vec3f=Cxx_zz*Nx+b2;var t1: vec3f=Cz *Nz+C1;var t2: vec3f=a2 *Ny+t1;var t3: vec3f=b3 *Nx+t2;return t3;}
#endif
#endif
`;S.IncludesShadersStoreWGSL[mx]||(S.IncludesShadersStoreWGSL[mx]=tU);const Yd="pbrVertexShader",TA=`#define PBR_VERTEX_SHADER
#include<pbrUboDeclaration>
#define CUSTOM_VERTEX_BEGIN
attribute position: vec3f;
#ifdef NORMAL
attribute normal: vec3f;
#endif
#ifdef TANGENT
attribute tangent: vec4f;
#endif
#ifdef UV1
attribute uv: vec2f;
#endif
#include<uvAttributeDeclaration>[2..7]
#include<mainUVVaryingDeclaration>[1..7]
#ifdef VERTEXCOLOR
attribute color: vec4f;
#endif
#include<helperFunctions>
#include<pbrBRDFFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)
#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight)
#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)
#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)
#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
#ifdef CLEARCOAT
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)
#endif
#ifdef SUBSURFACE
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor)
#endif
varying vPositionW: vec3f;
#if DEBUGMODE>0
varying vClipSpacePosition: vec4f;
#endif
#ifdef NORMAL
varying vNormalW: vec3f;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vEnvironmentIrradiance: vec3f;
#include<harmonicsFunctions>
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vColor: vec4f;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<lightVxUboDeclaration>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
varying vViewDepth: f32;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
var positionUpdated: vec3f=vertexInputs.position;
#ifdef NORMAL
var normalUpdated: vec3f=vertexInputs.normal;
#endif
#ifdef TANGENT
var tangentUpdated: vec4f=vertexInputs.tangent;
#endif
#ifdef UV1
var uvUpdated: vec2f=vertexInputs.uv;
#endif
#ifdef UV2
var uv2Updated: vec2f=vertexInputs.uv2;
#endif
#ifdef VERTEXCOLOR
var colorUpdated: vec4f=vertexInputs.color;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vertexOutputs.vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)
vertexOutputs.vCurrentPosition=scene.viewProjection*finalWorld*vec4f(positionUpdated,1.0);vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*vec4f(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);vertexOutputs.vPositionW= worldPos.xyz;
#ifdef PREPASS
#include<prePassVertex>
#endif
#ifdef NORMAL
var normalWorld: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vertexOutputs.vNormalW=normalUpdated/ vec3f(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vertexOutputs.vNormalW=normalize(normalWorld*vertexOutputs.vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vertexOutputs.vNormalW=normalize(normalWorld*normalUpdated);
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
#if BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LAMBERT && BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LEGACY
var viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-vertexOutputs.vPositionW);var NdotV: f32=max(dot(vertexOutputs.vNormalW,viewDirectionW),0.0);var roughNormal: vec3f=mix(vertexOutputs.vNormalW,viewDirectionW,(0.5*(1.0-NdotV))*uniforms.baseDiffuseRoughness);var reflectionVector: vec3f= (uniforms.reflectionMatrix* vec4f(roughNormal,0)).xyz;
#else
var reflectionVector: vec3f= (uniforms.reflectionMatrix* vec4f(vertexOutputs.vNormalW,0)).xyz;
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
vertexOutputs.vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {vertexOutputs.position=scene.viewProjection*worldPos;} else {vertexOutputs.position=scene.viewProjectionR*worldPos;}
#else
vertexOutputs.position=scene.viewProjection*worldPos;
#endif
#if DEBUGMODE>0
vertexOutputs.vClipSpacePosition=vertexOutputs.position;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vertexOutputs.vDirectionW=normalize((finalWorld*vec4f(positionUpdated,0.0)).xyz);
#endif
#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
vertexOutputs.vViewDepth=(scene.view*worldPos).z;
#endif
#ifndef UV1
var uvUpdated: vec2f= vec2f(0.,0.);
#endif
#ifdef MAINUV1
vertexOutputs.vMainUV1=uvUpdated;
#endif
#ifndef UV2
var uv2Updated: vec2f= vec2f(0.,0.);
#endif
#ifdef MAINUV2
vertexOutputs.vMainUV2=uv2Updated;
#endif
#include<uvVariableDeclaration>[3..7]
#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight,_MATRIXNAME_,baseWeight,_INFONAME_,BaseWeightInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness,_MATRIXNAME_,baseDiffuseRoughness,_INFONAME_,BaseDiffuseRoughnessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#ifdef CLEARCOAT
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)
#endif
#ifdef SHEEN
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheenRoughness,_INFONAME_,SheenInfos.z)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)
#endif
#ifdef SUBSURFACE
#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_MATRIXNAME_,translucencyColor,_INFONAME_,TranslucencyColorInfos.x)
#endif
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;S.ShadersStoreWGSL[Yd]||(S.ShadersStoreWGSL[Yd]=TA);const iU={name:Yd,shader:TA},bA=Object.freeze(Object.defineProperty({__proto__:null,pbrVertexShaderWGSL:iU},Symbol.toStringTag,{value:"Module"})),_x="pbrFragmentExtraDeclaration",rU=`varying vPositionW: vec3f;
#if DEBUGMODE>0
varying vClipSpacePosition: vec4f;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#ifdef NORMAL
varying vNormalW: vec3f;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vEnvironmentIrradiance: vec3f;
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vColor: vec4f;
#endif
#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
varying vViewDepth: f32;
#endif
`;S.IncludesShadersStoreWGSL[_x]||(S.IncludesShadersStoreWGSL[_x]=rU);const gx="samplerFragmentAlternateDeclaration",sU=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying v_VARYINGNAME_UV: vec2f;
#endif
#endif
`;S.IncludesShadersStoreWGSL[gx]||(S.IncludesShadersStoreWGSL[gx]=sU);const Sx="pbrFragmentSamplersDeclaration",nU=`#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight,_SAMPLERNAME_,baseWeight)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness,_SAMPLERNAME_,baseDiffuseRoughness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)
#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef CLEARCOAT
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS)
var clearCoatRoughnessSamplerSampler: sampler;var clearCoatRoughnessSampler: texture_2d<f32>;
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS)
var sheenRoughnessSamplerSampler: sampler;var sheenRoughnessSampler: texture_2d<f32>;
#endif
#endif
#ifdef ANISOTROPIC
#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_cube<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_cube<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_cube<f32>;
#endif
#ifdef USEIRRADIANCEMAP
var irradianceSamplerSampler: sampler;var irradianceSampler: texture_cube<f32>;
#endif
#else
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_2d<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_2d<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_2d<f32>;
#endif
#ifdef USEIRRADIANCEMAP
var irradianceSamplerSampler: sampler;var irradianceSampler: texture_2d<f32>;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#endif
#endif
#ifdef ENVIRONMENTBRDF
var environmentBrdfSamplerSampler: sampler;var environmentBrdfSampler: texture_2d<f32>;
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#ifdef SS_REFRACTIONMAP_3D
var refractionSamplerSampler: sampler;var refractionSampler: texture_cube<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var refractionLowSamplerSampler: sampler;var refractionLowSampler: texture_cube<f32>;var refractionHighSamplerSampler: sampler;var refractionHighSampler: texture_cube<f32>;
#endif
#else
var refractionSamplerSampler: sampler;var refractionSampler: texture_2d<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var refractionLowSamplerSampler: sampler;var refractionLowSampler: texture_2d<f32>;var refractionHighSamplerSampler: sampler;var refractionHighSampler: texture_2d<f32>;
#endif
#endif
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_SAMPLERNAME_,translucencyColor)
#endif
#ifdef IBL_CDF_FILTERING
var icdfSamplerSampler: sampler;var icdfSampler: texture_2d<f32>;
#endif
`;S.IncludesShadersStoreWGSL[Sx]||(S.IncludesShadersStoreWGSL[Sx]=nU);const vx="subSurfaceScatteringFunctions",aU=`fn testLightingForSSS(diffusionProfile: f32)->bool
{return diffusionProfile<1.;}`;S.IncludesShadersStoreWGSL[vx]||(S.IncludesShadersStoreWGSL[vx]=aU);const xx="importanceSampling",oU=`fn hemisphereCosSample(u: vec2f)->vec3f {var phi: f32=2.*PI*u.x;var cosTheta2: f32=1.-u.y;var cosTheta: f32=sqrt(cosTheta2);var sinTheta: f32=sqrt(1.-cosTheta2);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
fn hemisphereImportanceSampleDggx(u: vec2f,a: f32)->vec3f {var phi: f32=2.*PI*u.x;var cosTheta2: f32=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));var cosTheta: f32=sqrt(cosTheta2);var sinTheta: f32=sqrt(1.-cosTheta2);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
fn hemisphereImportanceSampleDggxAnisotropic(Xi: vec2f,alphaTangent: f32,alphaBitangent: f32)->vec3f
{let alphaT: f32=max(alphaTangent,0.0001);let alphaB: f32=max(alphaBitangent,0.0001);var phi: f32=atan(alphaB/alphaT*tan(2.0f*PI*Xi.x));if (Xi.x>0.5) {phi+=PI; }
let cosPhi: f32=cos(phi);let sinPhi: f32=sin(phi);let alpha2: f32=(cosPhi*cosPhi)/(alphaTangent*alphaTangent) +
(sinPhi*sinPhi)/(alphaB*alphaB);let tanTheta2: f32=Xi.y/(1.0f-Xi.y)/alpha2;let cosTheta: f32=1.0f/sqrt(1.0f+tanTheta2);let sinTheta: f32=sqrt(max(0.0f,1.0f-cosTheta*cosTheta));return vec3f(sinTheta*cosPhi,sinTheta*sinPhi,cosTheta);}
fn hemisphereImportanceSampleDCharlie(u: vec2f,a: f32)->vec3f { 
var phi: f32=2.*PI*u.x;var sinTheta: f32=pow(u.y,a/(2.*a+1.));var cosTheta: f32=sqrt(1.-sinTheta*sinTheta);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}`;S.IncludesShadersStoreWGSL[xx]||(S.IncludesShadersStoreWGSL[xx]=oU);const Ex="pbrHelperFunctions",lU=`#define MINIMUMVARIANCE 0.0005
fn convertRoughnessToAverageSlope(roughness: f32)->f32
{return roughness*roughness+MINIMUMVARIANCE;}
fn fresnelGrazingReflectance(reflectance0: f32)->f32 {var reflectance90: f32=saturate(reflectance0*25.0);return reflectance90;}
fn getAARoughnessFactors(normalVector: vec3f)->vec2f {
#ifdef SPECULARAA
var nDfdx: vec3f=dpdx(normalVector.xyz);var nDfdy: vec3f=dpdy(normalVector.xyz);var slopeSquare: f32=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));var geometricRoughnessFactor: f32=pow(saturate(slopeSquare),0.333);var geometricAlphaGFactor: f32=sqrt(slopeSquare);geometricAlphaGFactor*=0.75;return vec2f(geometricRoughnessFactor,geometricAlphaGFactor);
#else
return vec2f(0.);
#endif
}
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_LEGACY
fn getAnisotropicRoughness(alphaG: f32,anisotropy: f32)->vec2f {var alphaT: f32=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);var alphaB: f32=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);return vec2f(alphaT,alphaB);}
fn getAnisotropicBentNormals(T: vec3f,B: vec3f,N: vec3f,V: vec3f,anisotropy: f32,roughness: f32)->vec3f {var anisotropicFrameDirection: vec3f=select(T,B,anisotropy>=0.0);var anisotropicFrameTangent: vec3f=cross(normalize(anisotropicFrameDirection),V);var anisotropicFrameNormal: vec3f=cross(anisotropicFrameTangent,anisotropicFrameDirection);var anisotropicNormal: vec3f=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));return anisotropicNormal;}
#elif ANISOTROPIC_OPENPBR
fn getAnisotropicRoughness(alphaG: f32,anisotropy: f32)->vec2f {var alphaT: f32=alphaG*sqrt(2.0/(1.0+(1.0-anisotropy)*(1.0-anisotropy)));var alphaB: f32=max(alphaT*(1.0-anisotropy),MINIMUMVARIANCE);return vec2f(alphaT,alphaB);}
#else
fn getAnisotropicRoughness(alphaG: f32,anisotropy: f32)->vec2f {var alphaT: f32=max(mix(alphaG,1.0,anisotropy*anisotropy),MINIMUMVARIANCE);var alphaB: f32=max(alphaG,MINIMUMVARIANCE);return vec2f(alphaT,alphaB);}
fn getAnisotropicBentNormals(T: vec3f,B: vec3f,N: vec3f,V: vec3f,anisotropy: f32,roughness: f32)->vec3f {var bentNormal: vec3f=cross(B,V);bentNormal=normalize(cross(bentNormal,B));var sq=1.0-anisotropy*(1.0-roughness);var a: f32=sq*sq*sq*sq;bentNormal=normalize(mix(bentNormal,N,a));return bentNormal;}
#endif
#endif
#if defined(CLEARCOAT) || defined(SS_REFRACTION)
fn cocaLambertVec3(alpha: vec3f,distance: f32)->vec3f {return exp(-alpha*distance);}
fn cocaLambert(NdotVRefract: f32,NdotLRefract: f32,alpha: vec3f,thickness: f32)->vec3f {return cocaLambertVec3(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));}
fn computeColorAtDistanceInMedia(color: vec3f,distance: f32)->vec3f {return -log(color)/distance;}
fn computeClearCoatAbsorption(NdotVRefract: f32,NdotLRefract: f32,clearCoatColor: vec3f,clearCoatThickness: f32,clearCoatIntensity: f32)->vec3f {var clearCoatAbsorption: vec3f=mix( vec3f(1.0),
cocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),
clearCoatIntensity);return clearCoatAbsorption;}
#endif
#ifdef MICROSURFACEAUTOMATIC
fn computeDefaultMicroSurface(microSurface: f32,reflectivityColor: vec3f)->f32
{const kReflectivityNoAlphaWorkflow_SmoothnessMax: f32=0.95;var reflectivityLuminance: f32=getLuminance(reflectivityColor);var reflectivityLuma: f32=sqrt(reflectivityLuminance);var resultMicroSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;return resultMicroSurface;}
#endif
`;S.IncludesShadersStoreWGSL[Ex]||(S.IncludesShadersStoreWGSL[Ex]=lU);const Tx="pbrDirectLightingSetupFunctions",cU=`struct preLightingInfo
{lightOffset: vec3f,
lightDistanceSquared: f32,
lightDistance: f32,
attenuation: f32,
L: vec3f,
H: vec3f,
NdotV: f32,
NdotLUnclamped: f32,
NdotL: f32,
VdotH: f32,
LdotV: f32,
roughness: f32,
diffuseRoughness: f32,
surfaceAlbedo: vec3f,
#ifdef IRIDESCENCE
iridescenceIntensity: f32
#endif
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
areaLightDiffuse: vec3f,
#ifdef SPECULARTERM
areaLightSpecular: vec3f,
areaLightFresnel: vec4f
#endif
#endif
};fn computePointAndSpotPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f,posW: vec3f)->preLightingInfo {var result: preLightingInfo;result.lightOffset=lightData.xyz-posW;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);result.L=normalize(result.lightOffset);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}
fn computeDirectionalPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f)->preLightingInfo {var result: preLightingInfo;result.lightDistance=length(-lightData.xyz);result.L=normalize(-lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);result.LdotV=dot(result.L,V);return result;}
fn computeHemisphericPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f)->preLightingInfo {var result: preLightingInfo;result.NdotL=dot(N,lightData.xyz)*0.5+0.5;result.NdotL=saturateEps(result.NdotL);result.NdotLUnclamped=result.NdotL;
#ifdef SPECULARTERM
result.L=normalize(lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));
#endif
return result;}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
#include<ltcHelperFunctions>
var areaLightsLTC1SamplerSampler: sampler;var areaLightsLTC1Sampler: texture_2d<f32>;var areaLightsLTC2SamplerSampler: sampler;var areaLightsLTC2Sampler: texture_2d<f32>;fn computeAreaPreLightingInfo(ltc1: texture_2d<f32>,ltc1Sampler:sampler,ltc2:texture_2d<f32>,ltc2Sampler:sampler,viewDirectionW: vec3f,vNormal:vec3f,vPosition:vec3f,lightCenter:vec3f,halfWidth:vec3f, halfHeight:vec3f,roughness:f32)->preLightingInfo {var result: preLightingInfo;var data: areaLightData=computeAreaLightSpecularDiffuseFresnel(ltc1,ltc1Sampler,ltc2,ltc2Sampler,viewDirectionW,vNormal,vPosition,lightCenter,halfWidth,halfHeight,roughness);
#ifdef SPECULARTERM
result.areaLightFresnel=data.Fresnel;result.areaLightSpecular=data.Specular;
#endif
result.areaLightDiffuse+=data.Diffuse;return result;}
#endif
`;S.IncludesShadersStoreWGSL[Tx]||(S.IncludesShadersStoreWGSL[Tx]=cU);const bx="pbrDirectLightingFalloffFunctions",uU=`fn computeDistanceLightFalloff_Standard(lightOffset: vec3f,range: f32)->f32
{return max(0.,1.0-length(lightOffset)/range);}
fn computeDistanceLightFalloff_Physical(lightDistanceSquared: f32)->f32
{return 1.0/maxEps(lightDistanceSquared);}
fn computeDistanceLightFalloff_GLTF(lightDistanceSquared: f32,inverseSquaredRange: f32)->f32
{var lightDistanceFalloff: f32=1.0/maxEps(lightDistanceSquared);var factor: f32=lightDistanceSquared*inverseSquaredRange;var attenuation: f32=saturate(1.0-factor*factor);attenuation*=attenuation;lightDistanceFalloff*=attenuation;return lightDistanceFalloff;}
fn computeDirectionalLightFalloff_IES(lightDirection: vec3f,directionToLightCenterW: vec3f,iesLightTexture: texture_2d<f32>,iesLightTextureSampler: sampler)->f32
{var cosAngle: f32=dot(-lightDirection,directionToLightCenterW);var angle=acos(cosAngle)/PI;return textureSampleLevel(iesLightTexture,iesLightTextureSampler,vec2f(angle,0),0.).r;}
fn computeDistanceLightFalloff(lightOffset: vec3f,lightDistanceSquared: f32,range: f32,inverseSquaredRange: f32)->f32
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDistanceLightFalloff_Physical(lightDistanceSquared);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);
#else
return computeDistanceLightFalloff_Standard(lightOffset,range);
#endif
}
fn computeDirectionalLightFalloff_Standard(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32,exponent: f32)->f32
{var falloff: f32=0.0;var cosAngle: f32=maxEps(dot(-lightDirection,directionToLightCenterW));if (cosAngle>=cosHalfAngle)
{falloff=max(0.,pow(cosAngle,exponent));}
return falloff;}
fn computeDirectionalLightFalloff_Physical(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32)->f32
{const kMinusLog2ConeAngleIntensityRatio: f32=6.64385618977; 
var concentrationKappa: f32=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);var lightDirectionSpreadSG: vec4f= vec4f(-lightDirection*concentrationKappa,-concentrationKappa);var falloff: f32=exp2(dot( vec4f(directionToLightCenterW,1.0),lightDirectionSpreadSG));return falloff;}
fn computeDirectionalLightFalloff_GLTF(lightDirection: vec3f,directionToLightCenterW: vec3f,lightAngleScale: f32,lightAngleOffset: f32)->f32
{var cd: f32=dot(-lightDirection,directionToLightCenterW);var falloff: f32=saturate(cd*lightAngleScale+lightAngleOffset);falloff*=falloff;return falloff;}
fn computeDirectionalLightFalloff(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32,exponent: f32,lightAngleScale: f32,lightAngleOffset: f32)->f32
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);
#else
return computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);
#endif
}`;S.IncludesShadersStoreWGSL[bx]||(S.IncludesShadersStoreWGSL[bx]=uU);const Cx="hdrFilteringFunctions",hU=`#ifdef NUM_SAMPLES
#if NUM_SAMPLES>0
fn radicalInverse_VdC(value: u32)->f32 
{var bits=(value<<16u) | (value>>16u);bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);return f32(bits)*2.3283064365386963e-10; }
fn hammersley(i: u32,N: u32)->vec2f
{return vec2f( f32(i)/ f32(N),radicalInverse_VdC(i));}
fn log4(x: f32)->f32 {return log2(x)/2.;}
fn uv_to_normal(uv: vec2f)->vec3f {var N: vec3f;var uvRange: vec2f=uv;var theta: f32=uvRange.x*2.0*PI;var phi: f32=uvRange.y*PI;N.x=cos(theta)*sin(phi);N.z=sin(theta)*sin(phi);N.y=cos(phi);return N;}
const NUM_SAMPLES_FLOAT: f32= f32(NUM_SAMPLES);const NUM_SAMPLES_FLOAT_INVERSED: f32=1./NUM_SAMPLES_FLOAT;const K: f32=4.;fn irradiance(
#ifdef CUSTOM_IRRADIANCE_FILTERING_INPUT
CUSTOM_IRRADIANCE_FILTERING_INPUT
#else
inputTexture: texture_cube<f32>,inputSampler: sampler,
#endif
inputN: vec3f,
filteringInfo: vec2f,
diffuseRoughness: f32,
surfaceAlbedo: vec3f,
inputV: vec3f
#ifdef IBL_CDF_FILTERING
,icdfSampler: texture_2d<f32>,icdfSamplerSampler: sampler
#endif
)->vec3f
{var n: vec3f=normalize(inputN);var result: vec3f= vec3f(0.0);
#ifndef IBL_CDF_FILTERING
var tangent: vec3f=select(vec3f(1.,0.,0.),vec3f(0.,0.,1.),abs(n.z)<0.999);tangent=normalize(cross(tangent,n));var bitangent: vec3f=cross(n,tangent);var tbn: mat3x3f= mat3x3f(tangent,bitangent,n);var tbnInverse: mat3x3f=transpose(tbn);
#endif
var maxLevel: f32=filteringInfo.y;var dim0: f32=filteringInfo.x;var omegaP: f32=(4.*PI)/(6.*dim0*dim0);var clampedAlbedo: vec3f=clamp(surfaceAlbedo,vec3f(0.1),vec3f(1.0));for(var i: u32=0u; i<NUM_SAMPLES; i++)
{var Xi: vec2f=hammersley(i,NUM_SAMPLES);
#ifdef IBL_CDF_FILTERING
var T: vec2f;T.x=textureSampleLevel(icdfSampler,icdfSamplerSampler,vec2(Xi.x,0.0),0.0).x;T.y=textureSampleLevel(icdfSampler,icdfSamplerSampler,vec2(T.x,Xi.y),0.0).y;var Ls: vec3f=uv_to_normal(vec2f(1.0-fract(T.x+0.25),T.y));var NoL: f32=dot(n,Ls);var NoV: f32=dot(n,inputV);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
var LoV: f32=dot(Ls,inputV);
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
var H: vec3f=(inputV+Ls)*0.5;var VoH: f32=dot(inputV,H);
#endif 
#else
var Ls: vec3f=hemisphereCosSample(Xi);Ls=normalize(Ls);var Ns: vec3f= vec3f(0.,0.,1.);var NoL: f32=dot(Ns,Ls);var V: vec3f=tbnInverse*inputV;var NoV: f32=dot(Ns,V);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
var LoV: f32=dot(Ls,V);
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
var H: vec3f=(V+Ls)*0.5;var VoH: f32=dot(V,H);
#endif
#endif
if (NoL>0.) {
#ifdef IBL_CDF_FILTERING
var pdf: f32=textureSampleLevel(icdfSampler,icdfSamplerSampler,T,0.0).z;var c: vec3f=textureSampleLevel(inputTexture,inputSampler,Ls,0.0).rgb;
#else
var pdf_inversed: f32=PI/NoL;var omegaS: f32=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;var l: f32=log4(omegaS)-log4(omegaP)+log4(K);var mipLevel: f32=clamp(l,0.0,maxLevel);
#ifdef CUSTOM_IRRADIANCE_FILTERING_FUNCTION
CUSTOM_IRRADIANCE_FILTERING_FUNCTION
#else
var c: vec3f=textureSampleLevel(inputTexture,inputSampler,tbn*Ls,mipLevel).rgb;
#endif
#endif
#ifdef GAMMA_INPUT
c=toLinearSpaceVec3(c);
#endif
var diffuseRoughnessTerm: vec3f=vec3f(1.0);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
diffuseRoughnessTerm=diffuseBRDF_EON(clampedAlbedo,diffuseRoughness,NoL,NoV,LoV)*PI;
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
diffuseRoughnessTerm=vec3f(diffuseBRDF_Burley(NoL,NoV,VoH,diffuseRoughness)*PI);
#endif
#ifdef IBL_CDF_FILTERING
var light: vec3f=vec3f(0.0);if (pdf>1e-6) {light=vec3f(1.0)/vec3f(pdf)*c;}
result+=NoL*diffuseRoughnessTerm*light;
#else
result+=c*diffuseRoughnessTerm;
#endif
}}
result=result*NUM_SAMPLES_FLOAT_INVERSED;
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
result=result/clampedAlbedo;
#endif
return result;}
fn radiance(alphaG: f32,inputTexture: texture_cube<f32>,inputSampler: sampler,inputN: vec3f,filteringInfo: vec2f)->vec3f
{var n: vec3f=normalize(inputN);var c: vec3f=textureSample(inputTexture,inputSampler,n).rgb; 
if (alphaG==0.) {
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
return c;} else {var result: vec3f= vec3f(0.);var tangent: vec3f=select(vec3f(1.,0.,0.),vec3f(0.,0.,1.),abs(n.z)<0.999);tangent=normalize(cross(tangent,n));var bitangent: vec3f=cross(n,tangent);var tbn: mat3x3f= mat3x3f(tangent,bitangent,n);var maxLevel: f32=filteringInfo.y;var dim0: f32=filteringInfo.x;var omegaP: f32=(4.*PI)/(6.*dim0*dim0);var weight: f32=0.;for(var i: u32=0u; i<NUM_SAMPLES; i++)
{var Xi: vec2f=hammersley(i,NUM_SAMPLES);var H: vec3f=hemisphereImportanceSampleDggx(Xi,alphaG);var NoV: f32=1.;var NoH: f32=H.z;var NoH2: f32=H.z*H.z;var NoL: f32=2.*NoH2-1.;var L: vec3f= vec3f(2.*NoH*H.x,2.*NoH*H.y,NoL);L=normalize(L);if (NoL>0.) {var pdf_inversed: f32=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);var omegaS: f32=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;var l: f32=log4(omegaS)-log4(omegaP)+log4(K);var mipLevel: f32=clamp( f32(l),0.0,maxLevel);weight+=NoL;var c: vec3f=textureSampleLevel(inputTexture,inputSampler,tbn*L,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c*NoL;}}
result=result/weight;return result;}}
#ifdef ANISOTROPIC
fn radianceAnisotropic(
alphaTangent: f32, 
alphaBitangent: f32, 
inputTexture: texture_cube<f32>,
inputSampler: sampler,
inputView: vec3f, 
inputTangent: vec3f, 
inputBitangent: vec3f, 
inputNormal: vec3f, 
filteringInfo: vec2f,
noiseInput: vec2f 
)->vec3f {var V: vec3f=inputView;var N: vec3f=inputNormal;var T: vec3f=inputTangent;var B: vec3f=inputBitangent;var R: vec3f=reflect(-V,N);var c: vec3f=textureSample(inputTexture,inputSampler,R).rgb;if (alphaTangent==0.f && alphaBitangent==0.f) {
#if GAMMA_INPUT
c=toLinearSpace(c);
#endif
return c;}
var result: vec3f=vec3f(0.f);var maxLevel: f32=filteringInfo.y;var dim0: f32=filteringInfo.x;var effectiveDim: f32=dim0*sqrt(alphaTangent*alphaBitangent);var omegaP: f32=(4.f*PI)/(6.f*effectiveDim*effectiveDim);let noiseScale: f32=clamp(log2(f32(NUM_SAMPLES))/12.0f,0.0f,1.0f);var weight: f32=0.f;for(var i: u32=0u; i<NUM_SAMPLES; i++)
{var Xi: vec2f=hammersley(i,NUM_SAMPLES);Xi=fract(Xi+noiseInput*mix(0.5f,0.015f,noiseScale)); 
var H_tangent: vec3f=hemisphereImportanceSampleDggxAnisotropic(Xi,alphaTangent,alphaBitangent);var H: vec3f=normalize(H_tangent.x*T+H_tangent.y*B+H_tangent.z*N);var L: vec3f=normalize(2.0f*dot(V,H)*H-V);var NoH: f32=max(dot(N,H),0.001f);var VoH: f32=max(dot(V,H),0.001f);var NoL: f32=max(dot(N,L),0.001f);if (NoL>0.f) {var pdf_inversed: f32=4./normalDistributionFunction_BurleyGGX_Anisotropic(
H_tangent.z,H_tangent.x,H_tangent.y,vec2(alphaTangent,alphaBitangent)
);var omegaS: f32=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;var l: f32=log4(omegaS)-log4(omegaP)+log4(K);var mipLevel: f32=clamp(l,0.0f,maxLevel);weight+=NoL;var c: vec3f=textureSampleLevel(inputTexture,inputSampler,L,mipLevel).rgb;
#if GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c*NoL;}}
result=result/weight;return result;}
#endif
#endif
#endif
`;S.IncludesShadersStoreWGSL[Cx]||(S.IncludesShadersStoreWGSL[Cx]=hU);const yx="pbrBlockReflectance0",dU=`var reflectanceF0: f32=reflectivityOut.reflectanceF0;var specularEnvironmentR0: vec3f=reflectivityOut.colorReflectanceF0;var specularEnvironmentR90: vec3f= reflectivityOut.reflectanceF90;
#ifdef ALPHAFRESNEL
var reflectance90: f32=fresnelGrazingReflectance(reflectanceF0);specularEnvironmentR90=specularEnvironmentR90*reflectance90;
#endif
`;S.IncludesShadersStoreWGSL[yx]||(S.IncludesShadersStoreWGSL[yx]=dU);const Ix="pbrDirectLightingFunctions",fU=`#define CLEARCOATREFLECTANCE90 1.0
struct lightingInfo
{diffuse: vec3f,
#ifdef SS_TRANSLUCENCY
diffuseTransmission: vec3f,
#endif
#ifdef SPECULARTERM
specular: vec3f,
#endif
#ifdef CLEARCOAT
clearCoat: vec4f,
#endif
#ifdef SHEEN
sheen: vec3f
#endif
};fn adjustRoughnessFromLightProperties(roughness: f32,lightRadius: f32,lightDistance: f32)->f32 {
#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)
var lightRoughness: f32=lightRadius/lightDistance;var totalRoughness: f32=saturate(lightRoughness+roughness);return totalRoughness;
#else
return roughness;
#endif
}
fn computeHemisphericDiffuseLighting(info: preLightingInfo,lightColor: vec3f,groundColor: vec3f)->vec3f {return mix(groundColor,lightColor,info.NdotL);}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
fn computeAreaDiffuseLighting(info: preLightingInfo,lightColor: vec3f)->vec3f {return info.areaLightDiffuse*lightColor;}
#endif
fn computeDiffuseLighting(info: preLightingInfo,lightColor: vec3f)->vec3f {var diffuseTerm: vec3f=vec3f(1.0/PI);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_LEGACY
diffuseTerm=vec3f(diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
diffuseTerm=vec3f(diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.diffuseRoughness));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
var clampedAlbedo: vec3f=clamp(info.surfaceAlbedo,vec3f(0.1),vec3f(1.0));diffuseTerm=diffuseBRDF_EON(clampedAlbedo,info.diffuseRoughness,info.NdotL,info.NdotV,info.LdotV);diffuseTerm/=clampedAlbedo;
#endif
return diffuseTerm*info.attenuation*info.NdotL*lightColor;}
fn computeProjectionTextureDiffuseLighting(projectionLightTexture: texture_2d<f32>,projectionLightSampler: sampler,textureProjectionMatrix: mat4x4f,posW: vec3f)->vec3f{var strq: vec4f=textureProjectionMatrix* vec4f(posW,1.0);strq/=strq.w;var textureColor: vec3f=textureSample(projectionLightTexture,projectionLightSampler,strq.xy).rgb;return toLinearSpaceVec3(textureColor);}
#ifdef SS_TRANSLUCENCY
fn computeDiffuseTransmittedLighting(info: preLightingInfo,lightColor: vec3f,transmittance: vec3f)->vec3f {var transmittanceNdotL=vec3f(0.0);var NdotL: f32=absEps(info.NdotLUnclamped);
#ifndef SS_TRANSLUCENCY_LEGACY
if (info.NdotLUnclamped<0.0) {
#endif
var wrapNdotL: f32=computeWrappedDiffuseNdotL(NdotL,0.02);var trAdapt: f32=step(0.,info.NdotLUnclamped);transmittanceNdotL=mix(transmittance*wrapNdotL, vec3f(wrapNdotL),trAdapt);
#ifndef SS_TRANSLUCENCY_LEGACY
}
var diffuseTerm : vec3f=vec3f(1.0/PI);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_LEGACY
diffuseTerm=vec3f(diffuseBRDF_Burley(
info.NdotL,info.NdotV,info.VdotH,info.roughness));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
diffuseTerm=vec3f(diffuseBRDF_Burley(
info.NdotL,info.NdotV,info.VdotH,info.diffuseRoughness));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
var clampedAlbedo: vec3f=clamp(info.surfaceAlbedo,vec3f(0.1),vec3f(1.0));diffuseTerm=diffuseBRDF_EON(clampedAlbedo,info.diffuseRoughness,
info.NdotL,info.NdotV,info.LdotV);diffuseTerm/=clampedAlbedo;
#endif
return (transmittanceNdotL*diffuseTerm)*info.attenuation*lightColor;
#else
let diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;
#endif
}
#endif
#ifdef SPECULARTERM
fn computeSpecularLighting(info: preLightingInfo,N: vec3f,reflectance0: vec3f,fresnel: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var roughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(roughness);var modifiedFresnel: vec3f=fresnel;
#ifdef IRIDESCENCE
modifiedFresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
var distribution: f32=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);
#ifdef BRDF_V_HEIGHT_CORRELATED
var smithVisibility: f32=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);
#else
var smithVisibility: f32=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);
#endif
var specTerm: vec3f=modifiedFresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
fn computeAreaSpecularLighting(info: preLightingInfo,specularColor: vec3f,reflectance0: vec3f,reflectance90: vec3f)->vec3f {var fresnel:vec3f =reflectance0*specularColor*info.areaLightFresnel.x+( vec3f( 1.0 )-specularColor )*info.areaLightFresnel.y*reflectance90;return specularColor*fresnel*info.areaLightSpecular;}
#endif
#endif
#if defined(ANISOTROPIC) && defined(ANISOTROPIC_OPENPBR)
fn computeAnisotropicSpecularLighting(info: preLightingInfo,V: vec3f,N: vec3f,T: vec3f,B: vec3f,anisotropy: f32,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var TdotH: f32=dot(T,info.H);var BdotH: f32=dot(B,info.H);var TdotV: f32=dot(T,V);var BdotV: f32=dot(B,V);var TdotL: f32=dot(T,info.L);var BdotL: f32=dot(B,info.L);var alphaG: f32=convertRoughnessToAverageSlope(info.roughness);var alphaTB: vec2f=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,vec2f(geometricRoughnessFactor*geometricRoughnessFactor));var distribution: f32=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);var smithVisibility: f32=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);var specTerm: vec3f=vec3f(distribution*smithVisibility);return specTerm*info.attenuation*info.NdotL*lightColor;}
#elif defined(ANISOTROPIC)
fn computeAnisotropicSpecularLighting(info: preLightingInfo,V: vec3f,N: vec3f,T: vec3f,B: vec3f,anisotropy: f32,reflectance0: vec3f,reflectance90: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var TdotH: f32=dot(T,info.H);var BdotH: f32=dot(B,info.H);var TdotV: f32=dot(T,V);var BdotV: f32=dot(B,V);var TdotL: f32=dot(T,info.L);var BdotL: f32=dot(B,info.L);var alphaG: f32=convertRoughnessToAverageSlope(info.roughness);var alphaTB: vec2f=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,vec2f(geometricRoughnessFactor*geometricRoughnessFactor));var fresnel: vec3f=fresnelSchlickGGXVec3(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
var distribution: f32=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);var smithVisibility: f32=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);var specTerm: vec3f=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#ifdef CLEARCOAT
fn computeClearCoatLighting(info: preLightingInfo,Ncc: vec3f,geometricRoughnessFactor: f32,clearCoatIntensity: f32,lightColor: vec3f)->vec4f {var NccdotL: f32=saturateEps(dot(Ncc,info.L));var NccdotH: f32=saturateEps(dot(Ncc,info.H));var clearCoatRoughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(clearCoatRoughness);var fresnel: f32=fresnelSchlickGGX(info.VdotH,uniforms.vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnel*=clearCoatIntensity;var distribution: f32=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);var kelemenVisibility: f32=visibility_Kelemen(info.VdotH);var clearCoatTerm: f32=fresnel*distribution*kelemenVisibility;return vec4f(
clearCoatTerm*info.attenuation*NccdotL*lightColor,
1.0-fresnel
);}
fn computeClearCoatLightingAbsorption(NdotVRefract: f32,L: vec3f,Ncc: vec3f,clearCoatColor: vec3f,clearCoatThickness: f32,clearCoatIntensity: f32)->vec3f {var LRefract: vec3f=-refract(L,Ncc,uniforms.vClearCoatRefractionParams.y);var NdotLRefract: f32=saturateEps(dot(Ncc,LRefract));var absorption: vec3f=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);return absorption;}
#endif
#ifdef SHEEN
fn computeSheenLighting(info: preLightingInfo,N: vec3f,reflectance0: vec3f,reflectance90: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var roughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(roughness);var fresnel: f32=1.;var distribution: f32=normalDistributionFunction_CharlieSheen(NdotH,alphaG);/*#ifdef SHEEN_SOFTER
var visibility: f32=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);
#else */
var visibility: f32=visibility_Ashikhmin(info.NdotL,info.NdotV);/* #endif */
var sheenTerm: f32=fresnel*distribution*visibility;return sheenTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
#include<clusteredLightingFunctions>
fn computeClusteredLighting(
lightDataTexture: texture_2d<f32>,
tileMaskBuffer: ptr<storage,array<u32>>,
lightData: vec4f,
sliceRange: vec2u,
V: vec3f,
N: vec3f,
posW: vec3f,
surfaceAlbedo: vec3f,
reflectivityOut: reflectivityOutParams,
#ifdef IRIDESCENCE
iridescenceIntensity: f32,
#endif
#ifdef SS_TRANSLUCENCY
subSurfaceOut: subSurfaceOutParams,
#endif
#ifdef SPECULARTERM
AARoughnessFactor: f32,
#endif
#ifdef ANISOTROPIC
anisotropicOut: anisotropicOutParams,
#endif
#ifdef SHEEN
sheenOut: sheenOutParams,
#endif
#ifdef CLEARCOAT
clearcoatOut: clearcoatOutParams,
#endif
)->lightingInfo {let NdotV=absEps(dot(N,V));
#include<pbrBlockReflectance0>
#ifdef CLEARCOAT
specularEnvironmentR0=clearcoatOut.specularEnvironmentR0;
#endif
var result: lightingInfo;let tilePosition=vec2u(fragmentInputs.position.xy*lightData.xy);let maskResolution=vec2u(lightData.zw);var tileIndex=(tilePosition.x*maskResolution.x+tilePosition.y)*maskResolution.y;let batchRange=sliceRange/CLUSTLIGHT_BATCH;var batchOffset=batchRange.x*CLUSTLIGHT_BATCH;tileIndex+=batchRange.x;for (var i=batchRange.x; i<=batchRange.y; i+=1) {var mask=tileMaskBuffer[tileIndex];tileIndex+=1;let maskOffset=max(sliceRange.x,batchOffset)-batchOffset; 
let maskWidth=min(sliceRange.y-batchOffset+1,CLUSTLIGHT_BATCH);mask=extractBits(mask,maskOffset,maskWidth);while mask != 0 {let trailing=firstTrailingBit(mask);mask ^= 1u<<trailing;let light=getClusteredLight(lightDataTexture,batchOffset+maskOffset+trailing);var preInfo=computePointAndSpotPreLightingInfo(light.vLightData,V,N,posW);preInfo.NdotV=NdotV;preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light.vLightFalloff.x,light.vLightFalloff.y);if light.vLightDirection.w>=0.0 {preInfo.attenuation*=computeDirectionalLightFalloff(light.vLightDirection.xyz,preInfo.L,light.vLightDirection.w,light.vLightData.w,light.vLightFalloff.z,light.vLightFalloff.w);}
preInfo.roughness=adjustRoughnessFromLightProperties(reflectivityOut.roughness,light.vLightSpecular.a,preInfo.lightDistance);preInfo.diffuseRoughness=reflectivityOut.diffuseRoughness;preInfo.surfaceAlbedo=surfaceAlbedo;
#ifdef IRIDESCENCE
preInfo.iridescenceIntensity=iridescenceIntensity;
#endif
var info: lightingInfo;
#ifdef SS_TRANSLUCENCY
#ifdef SS_TRANSLUCENCY_LEGACY
info.diffuse=computeDiffuseTransmittedLighting(preInfo,light.vLightDiffuse.rgb,subSurfaceOut.transmittance);info.diffuseTransmission=vec3(0);
#else
info.diffuse=computeDiffuseLighting(preInfo,light.vLightDiffuse.rgb)*(1.0-subSurfaceOut.translucencyIntensity);info.diffuseTransmission=computeDiffuseTransmittedLighting(preInfo,light.vLightDiffuse.rgb,subSurfaceOut.transmittance);
#endif
#else
info.diffuse=computeDiffuseLighting(preInfo,light.vLightDiffuse.rgb);
#endif
#ifdef SPECULARTERM
#if CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR
let metalFresnel=reflectivityOut.specularWeight*getF82Specular(preInfo.VdotH,specularEnvironmentR0,reflectivityOut.colorReflectanceF90,reflectivityOut.roughness);let dielectricFresnel=fresnelSchlickGGXVec3(preInfo.VdotH,reflectivityOut.dielectricColorF0,reflectivityOut.colorReflectanceF90);let coloredFresnel=mix(dielectricFresnel,metalFresnel,reflectivityOut.metallic);
#else
let coloredFresnel=fresnelSchlickGGXVec3(preInfo.VdotH,specularEnvironmentR0,reflectivityOut.colorReflectanceF90);
#endif
#ifndef LEGACY_SPECULAR_ENERGY_CONSERVATION
let NdotH=dot(N,preInfo.H);let fresnel=fresnelSchlickGGXVec3(NdotH,vec3(reflectanceF0),specularEnvironmentR90);info.diffuse*=(vec3(1.0)-fresnel);
#endif
#ifdef ANISOTROPIC
info.specular=computeAnisotropicSpecularLighting(preInfo,V,N,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactor,light.vLightDiffuse.rgb);
#else
info.specular=computeSpecularLighting(preInfo,N,specularEnvironmentR0,coloredFresnel,AARoughnessFactor,light.vLightDiffuse.rgb);
#endif
#endif
#ifdef SHEEN
#ifdef SHEEN_LINKWITHALBEDO
preInfo.roughness=sheenOut.sheenIntensity;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light.vLightSpecular.a,preInfo.lightDistance);
#endif
info.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactor,light.vLightDiffuse.rgb);
#endif
#ifdef CLEARCOAT
preInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light.vLightSpecular.a,preInfo.lightDistance);info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,light.vLightDiffuse.rgb);
#ifdef CLEARCOAT_TINT
let absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;
#ifdef SS_TRANSLUCENCY
info.diffuseTransmission*=absorption;
#endif
#ifdef SPECULARTERM
info.specular*=absorption;
#endif
#endif
info.diffuse*=info.clearCoat.w;
#ifdef SS_TRANSLUCENCY
info.diffuseTransmission*=info.clearCoat.w;
#endif
#ifdef SPECULARTERM
info.specular*=info.clearCoat.w;
#endif
#ifdef SHEEN
info.sheen*=info.clearCoat.w;
#endif
#endif
result.diffuse+=info.diffuse;
#ifdef SS_TRANSLUCENCY
result.diffuseTransmission+=info.diffuseTransmission;
#endif
#ifdef SPECULARTERM
result.specular+=info.specular;
#endif
#ifdef CLEARCOAT
result.clearCoat+=info.clearCoat;
#endif
#ifdef SHEEN
result.sheen+=info.sheen;
#endif
}
batchOffset+=CLUSTLIGHT_BATCH;}
return result;}
#endif
`;S.IncludesShadersStoreWGSL[Ix]||(S.IncludesShadersStoreWGSL[Ix]=fU);const Rx="pbrIBLFunctions",pU=`#if defined(REFLECTION) || defined(SS_REFRACTION)
fn getLodFromAlphaG(cubeMapDimensionPixels: f32,microsurfaceAverageSlope: f32)->f32 {var microsurfaceAverageSlopeTexels: f32=cubeMapDimensionPixels*microsurfaceAverageSlope;var lod: f32=log2(microsurfaceAverageSlopeTexels);return lod;}
fn getLinearLodFromRoughness(cubeMapDimensionPixels: f32,roughness: f32)->f32 {var lod: f32=log2(cubeMapDimensionPixels)*roughness;return lod;}
#endif
#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)
fn environmentRadianceOcclusion(ambientOcclusion: f32,NdotVUnclamped: f32)->f32 {var temp: f32=NdotVUnclamped+ambientOcclusion;return saturate(temp*temp-1.0+ambientOcclusion);}
#endif
#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)
fn environmentHorizonOcclusion(view: vec3f,normal: vec3f,geometricNormal: vec3f)->f32 {var reflection: vec3f=reflect(view,normal);var temp: f32=saturate(1.0+1.1*dot(reflection,geometricNormal));return temp*temp;}
#endif
#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)
fn UNPACK_LOD(x: f32)->f32 {return (1.0-x)*255.0;}
fn getLodFromAlphaGNdotV(cubeMapDimensionPixels: f32,alphaG: f32,NdotV: f32)->f32 {var microsurfaceAverageSlope: f32=alphaG;microsurfaceAverageSlope*=sqrt(abs(NdotV));return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);}
#endif
`;S.IncludesShadersStoreWGSL[Rx]||(S.IncludesShadersStoreWGSL[Rx]=pU);const Ax="pbrBlockAlbedoOpacity",mU=`struct albedoOpacityOutParams
{surfaceAlbedo: vec3f,
alpha: f32};
#define pbr_inline
fn albedoOpacityBlock(
vAlbedoColor: vec4f
#ifdef ALBEDO
,albedoTexture: vec4f
,albedoInfos: vec2f
#endif
,baseWeight: f32
#ifdef BASE_WEIGHT
,baseWeightTexture: vec4f
,vBaseWeightInfos: vec2f
#endif
#ifdef OPACITY
,opacityMap: vec4f
,vOpacityInfos: vec2f
#endif
#ifdef DETAIL
,detailColor: vec4f
,vDetailInfos: vec4f
#endif
#ifdef DECAL
,decalColor: vec4f
,vDecalInfos: vec4f
#endif
)->albedoOpacityOutParams
{var outParams: albedoOpacityOutParams;var surfaceAlbedo: vec3f=vAlbedoColor.rgb;var alpha: f32=vAlbedoColor.a;
#ifdef ALBEDO
#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)
alpha*=albedoTexture.a;
#endif
#ifdef GAMMAALBEDO
surfaceAlbedo*=toLinearSpaceVec3(albedoTexture.rgb);
#else
surfaceAlbedo*=albedoTexture.rgb;
#endif
surfaceAlbedo*=albedoInfos.y;
#endif
#ifndef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
surfaceAlbedo*=fragmentInputs.vColor.rgb;
#endif
#ifdef DETAIL
var detailAlbedo: f32=2.0*mix(0.5,detailColor.r,vDetailInfos.y);surfaceAlbedo=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; 
#endif
#ifdef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALBEDO
surfaceAlbedo*=baseWeight;
#ifdef BASE_WEIGHT
surfaceAlbedo*=baseWeightTexture.r;
#endif
#ifdef OPACITY
#ifdef OPACITYRGB
alpha=getLuminance(opacityMap.rgb);
#else
alpha*=opacityMap.a;
#endif
alpha*=vOpacityInfos.y;
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=fragmentInputs.vColor.a;
#endif
#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)
#ifdef ALPHATEST
#if DEBUGMODE != 88
if (alpha<ALPHATESTVALUE) {discard;}
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
#endif
outParams.surfaceAlbedo=surfaceAlbedo;outParams.alpha=alpha;return outParams;}
`;S.IncludesShadersStoreWGSL[Ax]||(S.IncludesShadersStoreWGSL[Ax]=mU);const Px="pbrBlockReflectivity",_U=`struct reflectivityOutParams
{microSurface: f32,
roughness: f32,
diffuseRoughness: f32,
reflectanceF0: f32,
reflectanceF90: vec3f,
colorReflectanceF0: vec3f,
colorReflectanceF90: vec3f,
#ifdef METALLICWORKFLOW
surfaceAlbedo: vec3f,
metallic: f32,
specularWeight: f32,
dielectricColorF0: vec3f,
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
ambientOcclusionColor: vec3f,
#endif
#if DEBUGMODE>0
#ifdef METALLICWORKFLOW
#ifdef REFLECTIVITY
surfaceMetallicColorMap: vec4f,
#endif
metallicF0: vec3f,
#else
#ifdef REFLECTIVITY
surfaceReflectivityColorMap: vec4f,
#endif
#endif
#endif
};
#define pbr_inline
fn reflectivityBlock(
reflectivityColor: vec4f
#ifdef METALLICWORKFLOW
,surfaceAlbedo: vec3f
,metallicReflectanceFactors: vec4f
#endif
,baseDiffuseRoughness: f32
#ifdef BASE_DIFFUSE_ROUGHNESS
,baseDiffuseRoughnessTexture: f32
,baseDiffuseRoughnessInfos: vec2f
#endif
#ifdef REFLECTIVITY
,reflectivityInfos: vec3f
,surfaceMetallicOrReflectivityColorMap: vec4f
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
,ambientOcclusionColorIn: vec3f
#endif
#ifdef MICROSURFACEMAP
,microSurfaceTexel: vec4f
#endif
#ifdef DETAIL
,detailColor: vec4f
,vDetailInfos: vec4f
#endif
)->reflectivityOutParams
{var outParams: reflectivityOutParams;var microSurface: f32=reflectivityColor.a;var surfaceReflectivityColor: vec3f=reflectivityColor.rgb;
#ifdef METALLICWORKFLOW
var metallicRoughness: vec2f=surfaceReflectivityColor.rg;var ior: f32=surfaceReflectivityColor.b;
#ifdef REFLECTIVITY
#if DEBUGMODE>0
outParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef AOSTOREINMETALMAPRED
var aoStoreInMetalMap: vec3f= vec3f(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);
#endif
#ifdef METALLNESSSTOREINMETALMAPBLUE
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;
#else
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;
#endif
#ifdef ROUGHNESSSTOREINMETALMAPALPHA
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;
#else
#ifdef ROUGHNESSSTOREINMETALMAPGREEN
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;
#endif
#endif
#endif
#ifdef DETAIL
var detailRoughness: f32=mix(0.5,detailColor.b,vDetailInfos.w);var loLerp: f32=mix(0.,metallicRoughness.g,detailRoughness*2.);var hiLerp: f32=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));
#endif
#ifdef MICROSURFACEMAP
metallicRoughness.g*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS
microSurface=1.0-metallicRoughness.g;var baseColor: vec3f=surfaceAlbedo;outParams.metallic=metallicRoughness.r;outParams.specularWeight=metallicReflectanceFactors.a;var dielectricF0 : f32=reflectivityColor.a*outParams.specularWeight;surfaceReflectivityColor=metallicReflectanceFactors.rgb;
#if DEBUGMODE>0
outParams.metallicF0=dielectricF0*surfaceReflectivityColor;
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
outParams.surfaceAlbedo=baseColor.rgb*(vec3f(1.0)-vec3f(dielectricF0)*surfaceReflectivityColor)*(1.0-outParams.metallic);
#else
outParams.surfaceAlbedo=baseColor.rgb;
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
{let reflectivityColor: vec3f=mix(dielectricF0*surfaceReflectivityColor,baseColor.rgb,outParams.metallic);outParams.reflectanceF0=max(reflectivityColor.r,max(reflectivityColor.g,reflectivityColor.b));}
#else
#if DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_GLTF
let maxF0: f32=max(surfaceReflectivityColor.r,max(surfaceReflectivityColor.g,surfaceReflectivityColor.b));outParams.reflectanceF0=mix(dielectricF0*maxF0,1.0f,outParams.metallic);
#else
outParams.reflectanceF0=mix(dielectricF0,1.0,outParams.metallic);
#endif
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
outParams.reflectanceF90=vec3(outParams.specularWeight);var f90Scale: f32=1.0;
#else
var f90Scale: f32=clamp(2.0*(ior-1.0),0.0,1.0);outParams.reflectanceF90=vec3(mix(
outParams.specularWeight*f90Scale,1.0,outParams.metallic));
#endif
outParams.dielectricColorF0=vec3f(dielectricF0*surfaceReflectivityColor);var metallicColorF0: vec3f=baseColor.rgb;outParams.colorReflectanceF0=mix(outParams.dielectricColorF0,metallicColorF0,outParams.metallic);
#if (DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_OPENPBR)
let dielectricColorF90
: vec3f=surfaceReflectivityColor *
vec3f(outParams.specularWeight*f90Scale);
#else
let dielectricColorF90
: vec3f=vec3f(outParams.specularWeight*f90Scale);
#endif
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
let conductorColorF90: vec3f=surfaceReflectivityColor;
#else
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
let conductorColorF90: vec3f=outParams.reflectanceF90;
#else
let conductorColorF90: vec3f=vec3f(1.0f);
#endif
#endif
outParams.colorReflectanceF90=mix(dielectricColorF90,conductorColorF90,outParams.metallic);
#else
#ifdef REFLECTIVITY
surfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;
#if DEBUGMODE>0
outParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef MICROSURFACEFROMREFLECTIVITYMAP
microSurface*=surfaceMetallicOrReflectivityColorMap.a;microSurface*=reflectivityInfos.z;
#else
#ifdef MICROSURFACEAUTOMATIC
microSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);
#endif
#ifdef MICROSURFACEMAP
microSurface*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE
#endif
#endif
outParams.colorReflectanceF0=surfaceReflectivityColor;outParams.reflectanceF0=max(surfaceReflectivityColor.r,max(surfaceReflectivityColor.g,surfaceReflectivityColor.b));outParams.reflectanceF90=vec3f(1.0);
#if (DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_OPENPBR)
outParams.colorReflectanceF90=surfaceReflectivityColor;
#else
outParams.colorReflectanceF90=vec3(1.0);
#endif
#endif
microSurface=saturate(microSurface);var roughness: f32=1.-microSurface;var diffuseRoughness: f32=baseDiffuseRoughness;
#ifdef BASE_DIFFUSE_ROUGHNESS
diffuseRoughness*=baseDiffuseRoughnessTexture*baseDiffuseRoughnessInfos.y;
#endif
outParams.microSurface=microSurface;outParams.roughness=roughness;outParams.diffuseRoughness=diffuseRoughness;return outParams;}
`;S.IncludesShadersStoreWGSL[Px]||(S.IncludesShadersStoreWGSL[Px]=_U);const Ox="pbrBlockAmbientOcclusion",gU=`struct ambientOcclusionOutParams
{ambientOcclusionColor: vec3f,
#if DEBUGMODE>0 && defined(AMBIENT)
ambientOcclusionColorMap: vec3f
#endif
};
#define pbr_inline
fn ambientOcclusionBlock(
#ifdef AMBIENT
ambientOcclusionColorMap_: vec3f,
vAmbientInfos: vec4f
#endif
)->ambientOcclusionOutParams
{ 
var outParams: ambientOcclusionOutParams;var ambientOcclusionColor: vec3f= vec3f(1.,1.,1.);
#ifdef AMBIENT
var ambientOcclusionColorMap: vec3f=ambientOcclusionColorMap_*vAmbientInfos.y;
#ifdef AMBIENTINGRAYSCALE
ambientOcclusionColorMap= vec3f(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);
#endif
ambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);
#if DEBUGMODE>0
outParams.ambientOcclusionColorMap=ambientOcclusionColorMap;
#endif
#endif
outParams.ambientOcclusionColor=ambientOcclusionColor;return outParams;}
`;S.IncludesShadersStoreWGSL[Ox]||(S.IncludesShadersStoreWGSL[Ox]=gU);const Nx="pbrBlockAlphaFresnel",SU=`#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
struct alphaFresnelOutParams
{alpha: f32};fn faceforward(N: vec3<f32>,I: vec3<f32>,Nref: vec3<f32>)->vec3<f32> {return select(N,-N,dot(Nref,I)>0.0);}
#define pbr_inline
fn alphaFresnelBlock(
normalW: vec3f,
viewDirectionW: vec3f,
alpha: f32,
microSurface: f32
)->alphaFresnelOutParams
{var outParams: alphaFresnelOutParams;var opacityPerceptual: f32=alpha;
#ifdef LINEARALPHAFRESNEL
var opacity0: f32=opacityPerceptual;
#else
var opacity0: f32=opacityPerceptual*opacityPerceptual;
#endif
var opacity90: f32=fresnelGrazingReflectance(opacity0);var normalForward: vec3f=faceforward(normalW,-viewDirectionW,normalW);outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)), vec3f(opacity0), vec3f(opacity90),sqrt(microSurface)).x;
#ifdef ALPHATEST
if (outParams.alpha<ALPHATESTVALUE) {discard;}
#ifndef ALPHABLEND
outParams.alpha=1.0;
#endif
#endif
return outParams;}
#endif
#endif
`;S.IncludesShadersStoreWGSL[Nx]||(S.IncludesShadersStoreWGSL[Nx]=SU);const Dx="pbrBlockAnisotropic",vU=`#ifdef ANISOTROPIC
struct anisotropicOutParams
{anisotropy: f32,
anisotropicTangent: vec3f,
anisotropicBitangent: vec3f,
anisotropicNormal: vec3f,
#if DEBUGMODE>0 && defined(ANISOTROPIC_TEXTURE)
anisotropyMapData: vec3f
#endif
};
#define pbr_inline
fn anisotropicBlock(
vAnisotropy: vec3f,
roughness: f32,
#ifdef ANISOTROPIC_TEXTURE
anisotropyMapData: vec3f,
#endif
TBN: mat3x3f,
normalW: vec3f,
viewDirectionW: vec3f
)->anisotropicOutParams
{ 
var outParams: anisotropicOutParams;var anisotropy: f32=vAnisotropy.b;var anisotropyDirection: vec3f= vec3f(vAnisotropy.xy,0.);
#ifdef ANISOTROPIC_TEXTURE
var amd=anisotropyMapData.rg;anisotropy*=anisotropyMapData.b;
#if DEBUGMODE>0
outParams.anisotropyMapData=anisotropyMapData;
#endif
amd=amd*2.0-1.0;
#ifdef ANISOTROPIC_LEGACY
anisotropyDirection=vec3f(anisotropyDirection.xy*amd,anisotropyDirection.z);
#else
anisotropyDirection=vec3f(mat2x2f(anisotropyDirection.x,anisotropyDirection.y,-anisotropyDirection.y,anisotropyDirection.x)*normalize(amd),anisotropyDirection.z);
#endif
#endif
var anisoTBN: mat3x3f= mat3x3f(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));var anisotropicTangent: vec3f=normalize(anisoTBN*anisotropyDirection);var anisotropicBitangent: vec3f=normalize(cross(anisoTBN[2],anisotropicTangent));outParams.anisotropy=anisotropy;outParams.anisotropicTangent=anisotropicTangent;outParams.anisotropicBitangent=anisotropicBitangent;outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy,roughness);return outParams;}
#endif
`;S.IncludesShadersStoreWGSL[Dx]||(S.IncludesShadersStoreWGSL[Dx]=vU);const Mx="pbrBlockReflection",xU=`#ifdef REFLECTION
struct reflectionOutParams
{environmentRadiance: vec4f
,environmentIrradiance: vec3f
#ifdef REFLECTIONMAP_3D
,reflectionCoords: vec3f
#else
,reflectionCoords: vec2f
#endif
#ifdef SS_TRANSLUCENCY
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,irradianceVector: vec3f
#endif
#endif
#endif
};
#define pbr_inline
#ifdef REFLECTIONMAP_3D
fn createReflectionCoords(
vPositionW: vec3f,
normalW: vec3f,
#ifdef ANISOTROPIC
anisotropicOut: anisotropicOutParams,
#endif
)->vec3f
{var reflectionCoords: vec3f;
#else
fn createReflectionCoords(
vPositionW: vec3f,
normalW: vec3f,
#ifdef ANISOTROPIC
anisotropicOut: anisotropicOutParams,
#endif
)->vec2f
{ 
var reflectionCoords: vec2f;
#endif
#ifdef ANISOTROPIC
var reflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),anisotropicOut.anisotropicNormal);
#else
var reflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
reflectionCoords=reflectionVector;
#else
reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
return reflectionCoords;}
#define pbr_inline
fn sampleReflectionTexture(
alphaG: f32
,vReflectionMicrosurfaceInfos: vec3f
,vReflectionInfos: vec2f
,vReflectionColor: vec3f
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped: f32
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness: f32
#endif
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec3f
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec2f
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,reflectionLowSampler: texture_cube<f32>
,reflectionLowSamplerSampler: sampler
,reflectionHighSampler: texture_cube<f32>
,reflectionHighSamplerSampler: sampler
#else
,reflectionLowSampler: texture_2d<f32>
,reflectionLowSamplerSampler: sampler
,reflectionHighSampler: texture_2d<f32>
,reflectionHighSamplerSampler: sampler
#endif
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo: vec2f
#endif 
)->vec4f
{var environmentRadiance: vec4f;
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
var reflectionLOD: f32=getLodFromAlphaGNdotV(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
var reflectionLOD: f32=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);
#else
var reflectionLOD: f32=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);
#endif
#ifdef LODBASEDMICROSFURACE
reflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
#ifdef LODINREFLECTIONALPHA
var automaticReflectionLOD: f32=UNPACK_LOD(textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords).a);var requestedReflectionLOD: f32=max(automaticReflectionLOD,reflectionLOD);
#else
var requestedReflectionLOD: f32=reflectionLOD;
#endif
#ifdef REALTIME_FILTERING
environmentRadiance= vec4f(radiance(alphaG,reflectionSampler,reflectionSamplerSampler,reflectionCoords,vReflectionFilteringInfo),1.0);
#else
environmentRadiance=textureSampleLevel(reflectionSampler,reflectionSamplerSampler,reflectionCoords,reflectionLOD);
#endif
#else
var lodReflectionNormalized: f32=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));var lodReflectionNormalizedDoubled: f32=lodReflectionNormalized*2.0;var environmentMid: vec4f=textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords);if (lodReflectionNormalizedDoubled<1.0){environmentRadiance=mix(
textureSample(reflectionHighSampler,reflectionHighSamplerSampler,reflectionCoords),
environmentMid,
lodReflectionNormalizedDoubled
);} else {environmentRadiance=mix(
environmentMid,
textureSample(reflectionLowSampler,reflectionLowSamplerSampler,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
var envRadiance=environmentRadiance.rgb;
#ifdef RGBDREFLECTION
envRadiance=fromRGBD(environmentRadiance);
#endif
#ifdef GAMMAREFLECTION
envRadiance=toLinearSpaceVec3(environmentRadiance.rgb);
#endif
envRadiance*=vReflectionInfos.x;envRadiance*=vReflectionColor.rgb;return vec4f(envRadiance,environmentRadiance.a);}
#define pbr_inline
fn reflectionBlock(
vPositionW: vec3f
,normalW: vec3f
,alphaG: f32
,vReflectionMicrosurfaceInfos: vec3f
,vReflectionInfos: vec2f
,vReflectionColor: vec3f
#ifdef ANISOTROPIC
,anisotropicOut: anisotropicOutParams
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped: f32
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness: f32
#endif
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
#endif
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,vEnvironmentIrradiance: vec3f
#endif
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
,reflectionMatrix: mat4x4f
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,irradianceSampler: texture_cube<f32>
,irradianceSamplerSampler: sampler 
#else
,irradianceSampler: texture_2d<f32>
,irradianceSamplerSampler: sampler 
#endif
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
,reflectionDominantDirection: vec3f
#endif
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,reflectionLowSampler: texture_cube<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_cube<f32>
,reflectionHighSamplerSampler: sampler 
#else
,reflectionLowSampler: texture_2d<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_2d<f32>
,reflectionHighSamplerSampler: sampler 
#endif
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo: vec2f
#ifdef IBL_CDF_FILTERING
,icdfSampler: texture_2d<f32>
,icdfSamplerSampler: sampler
#endif
#endif
,viewDirectionW: vec3f
,diffuseRoughness: f32
,surfaceAlbedo: vec3f
)->reflectionOutParams
{var outParams: reflectionOutParams;var environmentRadiance: vec4f= vec4f(0.,0.,0.,0.);
#ifdef REFLECTIONMAP_3D
var reflectionCoords: vec3f= vec3f(0.);
#else
var reflectionCoords: vec2f= vec2f(0.);
#endif
reflectionCoords=createReflectionCoords(
vPositionW,
normalW,
#ifdef ANISOTROPIC
anisotropicOut,
#endif 
);environmentRadiance=sampleReflectionTexture(
alphaG
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness
#endif
#ifdef REFLECTIONMAP_3D
,reflectionSampler
,reflectionSamplerSampler
,reflectionCoords
#else
,reflectionSampler
,reflectionSamplerSampler
,reflectionCoords
#endif
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif 
);var environmentIrradiance: vec3f= vec3f(0.,0.,0.);
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
#ifdef ANISOTROPIC
var irradianceVector: vec3f= (reflectionMatrix* vec4f(anisotropicOut.anisotropicNormal,0)).xyz;
#else
var irradianceVector: vec3f= (reflectionMatrix* vec4f(normalW,0)).xyz;
#endif
var irradianceView: vec3f= (reflectionMatrix* vec4f(viewDirectionW,0)).xyz;
#if !defined(USE_IRRADIANCE_DOMINANT_DIRECTION) && !defined(REALTIME_FILTERING)
#if BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LAMBERT && BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LEGACY
var NdotV: f32=max(dot(normalW,viewDirectionW),0.0);irradianceVector=mix(irradianceVector,irradianceView,(0.5*(1.0-NdotV))*diffuseRoughness);
#endif
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
environmentIrradiance=vEnvironmentIrradiance;
#else
#if defined(REALTIME_FILTERING)
environmentIrradiance=irradiance(reflectionSampler,reflectionSamplerSampler,irradianceVector,vReflectionFilteringInfo,diffuseRoughness,surfaceAlbedo,irradianceView
#ifdef IBL_CDF_FILTERING
,icdfSampler
,icdfSamplerSampler
#endif
);
#else
environmentIrradiance=computeEnvironmentIrradiance(irradianceVector);
#endif
#ifdef SS_TRANSLUCENCY
outParams.irradianceVector=irradianceVector;
#endif
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
var environmentIrradiance4: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,irradianceVector);
#else
var environmentIrradiance4: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,reflectionCoords);
#endif
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
var Ls: vec3f=normalize(reflectionDominantDirection);var NoL: f32=dot(irradianceVector,Ls);var NoV: f32=dot(irradianceVector,irradianceView);var diffuseRoughnessTerm: vec3f=vec3f(1.0);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
var LoV: f32=dot(Ls,irradianceView);var mag: f32=length(reflectionDominantDirection)*2.0f;var clampedAlbedo: vec3f=clamp(surfaceAlbedo,vec3f(0.1),vec3f(1.0));diffuseRoughnessTerm=diffuseBRDF_EON(clampedAlbedo,diffuseRoughness,NoL,NoV,LoV)*PI;diffuseRoughnessTerm=diffuseRoughnessTerm/clampedAlbedo;diffuseRoughnessTerm=mix(vec3f(1.0),diffuseRoughnessTerm,sqrt(clamp(mag*NoV,0.0,1.0f)));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
var H: vec3f=(irradianceView+Ls)*0.5f;var VoH: f32=dot(irradianceView,H);diffuseRoughnessTerm=vec3f(diffuseBRDF_Burley(NoL,NoV,VoH,diffuseRoughness)*PI);
#endif
environmentIrradiance=environmentIrradiance4.rgb*diffuseRoughnessTerm;
#else
environmentIrradiance=environmentIrradiance4.rgb;
#endif
#ifdef RGBDREFLECTION
environmentIrradiance=fromRGBD(environmentIrradiance4);
#endif
#ifdef GAMMAREFLECTION
environmentIrradiance=toLinearSpaceVec3(environmentIrradiance.rgb);
#endif
#endif
environmentIrradiance*=vReflectionColor.rgb*vReflectionInfos.x;
#ifdef MIX_IBL_RADIANCE_WITH_IRRADIANCE
outParams.environmentRadiance=vec4f(mix(environmentRadiance.rgb,environmentIrradiance,alphaG),environmentRadiance.a);
#else
outParams.environmentRadiance=environmentRadiance;
#endif
outParams.environmentIrradiance=environmentIrradiance;outParams.reflectionCoords=reflectionCoords;return outParams;}
#endif
`;S.IncludesShadersStoreWGSL[Mx]||(S.IncludesShadersStoreWGSL[Mx]=xU);const Fx="pbrBlockSheen",EU=`#ifdef SHEEN
struct sheenOutParams
{sheenIntensity: f32
,sheenColor: vec3f
,sheenRoughness: f32
#ifdef SHEEN_LINKWITHALBEDO
,surfaceAlbedo: vec3f
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
,sheenAlbedoScaling: f32
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,finalSheenRadianceScaled: vec3f
#endif
#if DEBUGMODE>0
#ifdef SHEEN_TEXTURE
,sheenMapData: vec4f
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,sheenEnvironmentReflectance: vec3f
#endif
#endif
};
#define pbr_inline
fn sheenBlock(
vSheenColor: vec4f
#ifdef SHEEN_ROUGHNESS
,vSheenRoughness: f32
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
,sheenMapRoughnessData: vec4f
#endif
#endif
,roughness: f32
#ifdef SHEEN_TEXTURE
,sheenMapData: vec4f
,sheenMapLevel: f32
#endif
,reflectance: f32
#ifdef SHEEN_LINKWITHALBEDO
,baseColor: vec3f
,surfaceAlbedo: vec3f
#endif
#ifdef ENVIRONMENTBRDF
,NdotV: f32
,environmentBrdf: vec3f
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,AARoughnessFactors: vec2f
,vReflectionMicrosurfaceInfos: vec3f
,vReflectionInfos: vec2f
,vReflectionColor: vec3f
,vLightingIntensity: vec4f
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec3f
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec2f
#endif
,NdotVUnclamped: f32
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,reflectionLowSampler: texture_cube<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_cube<f32>
,reflectionHighSamplerSampler: sampler 
#else
,reflectionLowSampler: texture_2d<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_2d<f32>
,reflectionHighSamplerSampler: sampler 
#endif
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo: vec2f
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
,seo: f32
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
,eho: f32
#endif
#endif
)->sheenOutParams
{var outParams: sheenOutParams;var sheenIntensity: f32=vSheenColor.a;
#ifdef SHEEN_TEXTURE
#if DEBUGMODE>0
outParams.sheenMapData=sheenMapData;
#endif
#endif
#ifdef SHEEN_LINKWITHALBEDO
var sheenFactor: f32=pow5(1.0-sheenIntensity);var sheenColor: vec3f=baseColor.rgb*(1.0-sheenFactor);var sheenRoughness: f32=sheenIntensity;outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#else
var sheenColor: vec3f=vSheenColor.rgb;
#ifdef SHEEN_TEXTURE
#ifdef SHEEN_GAMMATEXTURE
sheenColor*=toLinearSpaceVec3(sheenMapData.rgb);
#else
sheenColor*=sheenMapData.rgb;
#endif
sheenColor*=sheenMapLevel;
#endif
#ifdef SHEEN_ROUGHNESS
var sheenRoughness: f32=vSheenRoughness;
#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE
#if defined(SHEEN_TEXTURE)
sheenRoughness*=sheenMapData.a;
#endif
#elif defined(SHEEN_TEXTURE_ROUGHNESS)
sheenRoughness*=sheenMapRoughnessData.a;
#endif
#else
var sheenRoughness: f32=roughness;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#endif
#if !defined(SHEEN_ALBEDOSCALING)
sheenIntensity*=(1.-reflectance);
#endif
sheenColor*=sheenIntensity;
#endif
#ifdef ENVIRONMENTBRDF
/*#ifdef SHEEN_SOFTER
var environmentSheenBrdf: vec3f= vec3f(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));
#else*/
#ifdef SHEEN_ROUGHNESS
var environmentSheenBrdf: vec3f=getBRDFLookup(NdotV,sheenRoughness);
#else
var environmentSheenBrdf: vec3f=environmentBrdf;
#endif
/*#endif*/
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
var sheenAlphaG: f32=convertRoughnessToAverageSlope(sheenRoughness);
#ifdef SPECULARAA
sheenAlphaG+=AARoughnessFactors.y;
#endif
var environmentSheenRadiance: vec4f= vec4f(0.,0.,0.,0.);environmentSheenRadiance=sampleReflectionTexture(
sheenAlphaG
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,sheenRoughness
#endif
,reflectionSampler
,reflectionSamplerSampler
,reflectionCoords
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
);var sheenEnvironmentReflectance: vec3f=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
sheenEnvironmentReflectance*=seo;
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
sheenEnvironmentReflectance*=eho;
#endif
#if DEBUGMODE>0
outParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;
#endif
outParams.finalSheenRadianceScaled=
environmentSheenRadiance.rgb *
sheenEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
outParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;
#endif
outParams.sheenIntensity=sheenIntensity;outParams.sheenColor=sheenColor;outParams.sheenRoughness=sheenRoughness;return outParams;}
#endif
`;S.IncludesShadersStoreWGSL[Fx]||(S.IncludesShadersStoreWGSL[Fx]=EU);const Lx="pbrBlockClearcoat",TU=`struct clearcoatOutParams
{specularEnvironmentR0: vec3f,
conservationFactor: f32,
clearCoatNormalW: vec3f,
clearCoatAARoughnessFactors: vec2f,
clearCoatIntensity: f32,
clearCoatRoughness: f32,
#ifdef REFLECTION
finalClearCoatRadianceScaled: vec3f,
#endif
#ifdef CLEARCOAT_TINT
absorption: vec3f,
clearCoatNdotVRefract: f32,
clearCoatColor: vec3f,
clearCoatThickness: f32,
#endif
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
energyConservationFactorClearCoat: vec3f,
#endif
#if DEBUGMODE>0
#ifdef CLEARCOAT_BUMP
TBNClearCoat: mat3x3f,
#endif
#ifdef CLEARCOAT_TEXTURE
clearCoatMapData: vec2f,
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
clearCoatTintMapData: vec4f,
#endif
#ifdef REFLECTION
environmentClearCoatRadiance: vec4f,
clearCoatEnvironmentReflectance: vec3f,
#endif
clearCoatNdotV: f32
#endif
};
#ifdef CLEARCOAT
#define pbr_inline
fn clearcoatBlock(
vPositionW: vec3f
,geometricNormalW: vec3f
,viewDirectionW: vec3f
,vClearCoatParams: vec2f
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
,clearCoatMapRoughnessData: vec4f
#endif
,specularEnvironmentR0: vec3f
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData: vec2f
#endif
#ifdef CLEARCOAT_TINT
,vClearCoatTintParams: vec4f
,clearCoatColorAtDistance: f32
,vClearCoatRefractionParams: vec4f
#ifdef CLEARCOAT_TINT_TEXTURE
,clearCoatTintMapData: vec4f
#endif
#endif
#ifdef CLEARCOAT_BUMP
,vClearCoatBumpInfos: vec2f
,clearCoatBumpMapData: vec4f
,vClearCoatBumpUV: vec2f
#if defined(TANGENT) && defined(NORMAL)
,vTBN: mat3x3f
#else
,vClearCoatTangentSpaceParams: vec2f
#endif
#ifdef OBJECTSPACE_NORMALMAP
,normalMatrix: mat4x4f
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
,faceNormal: vec3f
#endif
#ifdef REFLECTION
,vReflectionMicrosurfaceInfos: vec3f
,vReflectionInfos: vec2f
,vReflectionColor: vec3f
,vLightingIntensity: vec4f
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,reflectionLowSampler: texture_cube<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_cube<f32>
,reflectionHighSamplerSampler: sampler 
#else
,reflectionLowSampler: texture_2d<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_2d<f32>
,reflectionHighSamplerSampler: sampler 
#endif
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo: vec2f
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
,frontFacingMultiplier: f32
#endif 
)->clearcoatOutParams
{var outParams: clearcoatOutParams;var clearCoatIntensity: f32=vClearCoatParams.x;var clearCoatRoughness: f32=vClearCoatParams.y;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE
clearCoatRoughness*=clearCoatMapData.y;
#endif
#if DEBUGMODE>0
outParams.clearCoatMapData=clearCoatMapData;
#endif
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
clearCoatRoughness*=clearCoatMapRoughnessData.y;
#endif
outParams.clearCoatIntensity=clearCoatIntensity;outParams.clearCoatRoughness=clearCoatRoughness;
#ifdef CLEARCOAT_TINT
var clearCoatColor: vec3f=vClearCoatTintParams.rgb;var clearCoatThickness: f32=vClearCoatTintParams.a;
#ifdef CLEARCOAT_TINT_TEXTURE
#ifdef CLEARCOAT_TINT_GAMMATEXTURE
clearCoatColor*=toLinearSpaceVec3(clearCoatTintMapData.rgb);
#else
clearCoatColor*=clearCoatTintMapData.rgb;
#endif
clearCoatThickness*=clearCoatTintMapData.a;
#if DEBUGMODE>0
outParams.clearCoatTintMapData=clearCoatTintMapData;
#endif
#endif
outParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);outParams.clearCoatThickness=clearCoatThickness;
#endif
#ifdef CLEARCOAT_REMAP_F0
var specularEnvironmentR0Updated: vec3f=getR0RemappedForClearCoat(specularEnvironmentR0);
#else
var specularEnvironmentR0Updated: vec3f=specularEnvironmentR0;
#endif
outParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);var clearCoatNormalW: vec3f=geometricNormalW;
#ifdef CLEARCOAT_BUMP
#ifdef NORMALXYSCALE
var clearCoatNormalScale: f32=1.0;
#else
var clearCoatNormalScale: f32=vClearCoatBumpInfos.y;
#endif
#if defined(TANGENT) && defined(NORMAL)
var TBNClearCoat: mat3x3f=vTBN;
#else
var TBNClearCoatUV: vec2f=vClearCoatBumpUV*frontFacingMultiplier;var TBNClearCoat: mat3x3f=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);
#endif
#if DEBUGMODE>0
outParams.TBNClearCoat=TBNClearCoat;
#endif
#ifdef OBJECTSPACE_NORMALMAP
clearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);clearCoatNormalW=normalize( mat3x3f(normalMatrix[0].xyz,normalMatrix[1].xyz,normalMatrix[2].xyz)*clearCoatNormalW);
#else
clearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
clearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
clearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;
#endif
outParams.clearCoatNormalW=clearCoatNormalW;outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);var clearCoatNdotVUnclamped: f32=dot(clearCoatNormalW,viewDirectionW);var clearCoatNdotV: f32=absEps(clearCoatNdotVUnclamped);
#if DEBUGMODE>0
outParams.clearCoatNdotV=clearCoatNdotV;
#endif
#ifdef CLEARCOAT_TINT
var clearCoatVRefract: vec3f=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));
#endif
#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))
var environmentClearCoatBrdf: vec3f=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);
#endif
#if defined(REFLECTION)
var clearCoatAlphaG: f32=convertRoughnessToAverageSlope(clearCoatRoughness);
#ifdef SPECULARAA
clearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;
#endif
var environmentClearCoatRadiance: vec4f= vec4f(0.,0.,0.,0.);var clearCoatReflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),clearCoatNormalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
clearCoatReflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
var clearCoatReflectionCoords: vec3f=clearCoatReflectionVector;
#else
var clearCoatReflectionCoords: vec2f=clearCoatReflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
clearCoatReflectionCoords/=clearCoatReflectionVector.z;
#endif
clearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;
#endif
environmentClearCoatRadiance=sampleReflectionTexture(
clearCoatAlphaG
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,clearCoatNdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,clearCoatRoughness
#endif
,reflectionSampler
,reflectionSamplerSampler
,clearCoatReflectionCoords
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif 
);
#if DEBUGMODE>0
outParams.environmentClearCoatRadiance=environmentClearCoatRadiance;
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
var clearCoatEnvironmentReflectance: vec3f=getReflectanceFromBRDFLookup(vec3f(uniforms.vClearCoatRefractionParams.x),environmentClearCoatBrdf);
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
var clearCoatEho: f32=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);clearCoatEnvironmentReflectance*=clearCoatEho;
#endif
#endif
#endif
#else
var clearCoatEnvironmentReflectance: vec3f=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV, vec3f(1.), vec3f(1.),sqrt(1.-clearCoatRoughness));
#endif
clearCoatEnvironmentReflectance*=clearCoatIntensity;
#if DEBUGMODE>0
outParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;
#endif
outParams.finalClearCoatRadianceScaled=
environmentClearCoatRadiance.rgb *
clearCoatEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(CLEARCOAT_TINT)
outParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);
#endif
var fresnelIBLClearCoat: f32=fresnelSchlickGGX(clearCoatNdotV,uniforms.vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnelIBLClearCoat*=clearCoatIntensity;outParams.conservationFactor=(1.-fresnelIBLClearCoat);
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
outParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);
#endif
return outParams;}
#endif
`;S.IncludesShadersStoreWGSL[Lx]||(S.IncludesShadersStoreWGSL[Lx]=TU);const wx="pbrBlockIridescence",bU=`struct iridescenceOutParams
{iridescenceIntensity: f32,
iridescenceIOR: f32,
iridescenceThickness: f32,
specularEnvironmentR0: vec3f};
#ifdef IRIDESCENCE
fn iridescenceBlock(
vIridescenceParams: vec4f
,viewAngle_: f32
,specularEnvironmentR0: vec3f
#ifdef IRIDESCENCE_TEXTURE
,iridescenceMapData: vec2f
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
,iridescenceThicknessMapData: vec2f
#endif
#ifdef CLEARCOAT
,NdotVUnclamped: f32
,vClearCoatParams: vec2f
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData: vec2f
#endif
#endif
)->iridescenceOutParams
{var outParams: iridescenceOutParams;var iridescenceIntensity: f32=vIridescenceParams.x;var iridescenceIOR: f32=vIridescenceParams.y;var iridescenceThicknessMin: f32=vIridescenceParams.z;var iridescenceThicknessMax: f32=vIridescenceParams.w;var iridescenceThicknessWeight: f32=1.;var viewAngle=viewAngle_;
#ifdef IRIDESCENCE_TEXTURE
iridescenceIntensity*=iridescenceMapData.x;
#endif
#if defined(IRIDESCENCE_THICKNESS_TEXTURE)
iridescenceThicknessWeight=iridescenceThicknessMapData.g;
#endif
var iridescenceThickness: f32=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);var topIor: f32=1.; 
#ifdef CLEARCOAT
var clearCoatIntensity: f32=vClearCoatParams.x;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#endif
topIor=mix(1.0,uniforms.vClearCoatRefractionParams.w-1.,clearCoatIntensity);viewAngle=sqrt(1.0+((1.0/topIor)*(1.0/topIor))*((NdotVUnclamped*NdotVUnclamped)-1.0));
#endif
var iridescenceFresnel: vec3f=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);outParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);outParams.iridescenceIntensity=iridescenceIntensity;outParams.iridescenceThickness=iridescenceThickness;outParams.iridescenceIOR=iridescenceIOR;return outParams;}
#endif
`;S.IncludesShadersStoreWGSL[wx]||(S.IncludesShadersStoreWGSL[wx]=bU);const Bx="pbrBlockSubSurface",CU=`struct subSurfaceOutParams
{specularEnvironmentReflectance: vec3f,
#ifdef SS_REFRACTION
finalRefraction: vec3f,
surfaceAlbedo: vec3f,
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha: f32,
#endif
refractionOpacity: f32,
#endif
#ifdef SS_TRANSLUCENCY
transmittance: vec3f,
translucencyIntensity: f32,
#ifdef REFLECTION
refractionIrradiance: vec3f,
#endif
#endif
#if DEBUGMODE>0
#ifdef SS_THICKNESSANDMASK_TEXTURE
thicknessMap: vec4f,
#endif
#ifdef SS_REFRACTION
environmentRefraction: vec4f,
refractionTransmittance: vec3f
#endif
#endif
};
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#define pbr_inline
fn sampleEnvironmentRefraction(
ior: f32
,thickness: f32
,refractionLOD: f32
,normalW: vec3f
,vPositionW: vec3f
,viewDirectionW: vec3f
,view: mat4x4f
,vRefractionInfos: vec4f
,refractionMatrix: mat4x4f
,vRefractionMicrosurfaceInfos: vec4f
,alphaG: f32
#ifdef SS_REFRACTIONMAP_3D
,refractionSampler: texture_cube<f32>
,refractionSamplerSampler: sampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler: texture_cube<f32>
,refractionLowSamplerSampler: sampler
,refractionHighSampler: texture_cube<f32>
,refractionHighSamplerSampler: sampler 
#endif
#else
,refractionSampler: texture_2d<f32>
,refractionSamplerSampler: sampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler: texture_2d<f32>
,refractionLowSamplerSampler: sampler
,refractionHighSampler: texture_2d<f32>
,refractionHighSamplerSampler: sampler 
#endif
#endif
#ifdef ANISOTROPIC
,anisotropicOut: anisotropicOutParams
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo: vec2f
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,refractionPosition: vec3f
,refractionSize: vec3f
#endif
)->vec4f {var environmentRefraction: vec4f= vec4f(0.,0.,0.,0.);
#ifdef ANISOTROPIC
var refractionVector: vec3f=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,ior);
#else
var refractionVector: vec3f=refract(-viewDirectionW,normalW,ior);
#endif
#ifdef SS_REFRACTIONMAP_OPPOSITEZ
refractionVector.z*=-1.0;
#endif
#ifdef SS_REFRACTIONMAP_3D
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;var refractionCoords: vec3f=refractionVector;refractionCoords= (refractionMatrix* vec4f(refractionCoords,0)).xyz;
#else
#ifdef SS_USE_THICKNESS_AS_DEPTH
var vRefractionUVW: vec3f= (refractionMatrix*(view* vec4f(vPositionW+refractionVector*thickness,1.0))).xyz;
#else
var vRefractionUVW: vec3f= (refractionMatrix*(view* vec4f(vPositionW+refractionVector*vRefractionInfos.z,1.0))).xyz;
#endif
var refractionCoords: vec2f=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;
#endif
#ifdef LODBASEDMICROSFURACE
var lod=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;
#ifdef SS_LODINREFRACTIONALPHA
var automaticRefractionLOD: f32=UNPACK_LOD(textureSample(refractionSampler,refractionSamplerSampler,refractionCoords).a);var requestedRefractionLOD: f32=max(automaticRefractionLOD,lod);
#else
var requestedRefractionLOD: f32=lod;
#endif
#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)
environmentRefraction= vec4f(radiance(alphaG,refractionSampler,refractionSamplerSampler,refractionCoords,vRefractionFilteringInfo),1.0);
#else
environmentRefraction=textureSampleLevel(refractionSampler,refractionSamplerSampler,refractionCoords,requestedRefractionLOD);
#endif
#else
var lodRefractionNormalized: f32=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));var lodRefractionNormalizedDoubled: f32=lodRefractionNormalized*2.0;var environmentRefractionMid: vec4f=textureSample(refractionSampler,refractionSamplerSampler,refractionCoords);if (lodRefractionNormalizedDoubled<1.0){environmentRefraction=mix(
textureSample(refractionHighSampler,refractionHighSamplerSampler,refractionCoords),
environmentRefractionMid,
lodRefractionNormalizedDoubled
);} else {environmentRefraction=mix(
environmentRefractionMid,
textureSample(refractionLowSampler,refractionLowSamplerSampler,refractionCoords),
lodRefractionNormalizedDoubled-1.0
);}
#endif
var refraction=environmentRefraction.rgb;
#ifdef SS_RGBDREFRACTION
refraction=fromRGBD(environmentRefraction);
#endif
#ifdef SS_GAMMAREFRACTION
refraction=toLinearSpaceVec3(environmentRefraction.rgb);
#endif
return vec4f(refraction,environmentRefraction.a);}
#endif
#define pbr_inline
fn subSurfaceBlock(
vSubSurfaceIntensity: vec3f
,vThicknessParam: vec2f
,vTintColor: vec4f
,normalW: vec3f
,specularEnvironmentReflectance: vec3f
#ifdef SS_THICKNESSANDMASK_TEXTURE
,thicknessMap: vec4f
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
,refractionIntensityMap: vec4f
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
,translucencyIntensityMap: vec4f
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
,reflectionMatrix: mat4x4f
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,irradianceVector_: vec3f
#endif
#if defined(REALTIME_FILTERING)
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
,vReflectionFilteringInfo: vec2f
#ifdef IBL_CDF_FILTERING
,icdfSampler: texture_2d<f32>
,icdfSamplerSampler: sampler
#endif
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,irradianceSampler: texture_cube<f32>
,irradianceSamplerSampler: sampler
#else
,irradianceSampler: texture_2d<f32>
,irradianceSamplerSampler: sampler
#endif
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
,surfaceAlbedo: vec3f
#endif
#ifdef SS_REFRACTION
,vPositionW: vec3f
,viewDirectionW: vec3f
,view: mat4x4f
,vRefractionInfos: vec4f
,refractionMatrix: mat4x4f
,vRefractionMicrosurfaceInfos: vec4f
,vLightingIntensity: vec4f
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
,alpha: f32
#endif
#ifdef SS_LODINREFRACTIONALPHA
,NdotVUnclamped: f32
#endif
#ifdef SS_LINEARSPECULARREFRACTION
,roughness: f32
#endif
,alphaG: f32
#ifdef SS_REFRACTIONMAP_3D
,refractionSampler: texture_cube<f32>
,refractionSamplerSampler: sampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler: texture_cube<f32>
,refractionLowSamplerSampler: sampler
,refractionHighSampler: texture_cube<f32>
,refractionHighSamplerSampler: sampler 
#endif
#else
,refractionSampler: texture_2d<f32>
,refractionSamplerSampler: sampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler: texture_2d<f32>
,refractionLowSamplerSampler: sampler
,refractionHighSampler: texture_2d<f32>
,refractionHighSamplerSampler: sampler 
#endif
#endif
#ifdef ANISOTROPIC
,anisotropicOut: anisotropicOutParams
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo: vec2f
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,refractionPosition: vec3f
,refractionSize: vec3f
#endif
#ifdef SS_DISPERSION
,dispersion: f32
#endif
#endif
#ifdef SS_TRANSLUCENCY
,vDiffusionDistance: vec3f
,vTranslucencyColor: vec4f
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
,translucencyColorMap: vec4f
#endif
#endif
)->subSurfaceOutParams
{var outParams: subSurfaceOutParams;outParams.specularEnvironmentReflectance=specularEnvironmentReflectance;
#ifdef SS_REFRACTION
var refractionIntensity: f32=vSubSurfaceIntensity.x;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
refractionIntensity*=(1.0-alpha);outParams.alpha=1.0;
#endif
#endif
#ifdef SS_TRANSLUCENCY
var translucencyIntensity: f32=vSubSurfaceIntensity.y;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
#ifdef SS_USE_GLTF_TEXTURES
var thickness: f32=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;
#else
var thickness: f32=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;
#endif
#if DEBUGMODE>0
outParams.thicknessMap=thicknessMap;
#endif
#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS)
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=thicknessMap.r;
#else
refractionIntensity*=thicknessMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS)
#ifdef SS_USE_GLTF_TEXTURES
translucencyIntensity*=thicknessMap.a;
#else
translucencyIntensity*=thicknessMap.b;
#endif
#endif
#else
var thickness: f32=vThicknessParam.y;
#endif
#if defined(SS_REFRACTION) && defined(SS_REFRACTIONINTENSITY_TEXTURE)
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=refractionIntensityMap.r;
#else
refractionIntensity*=refractionIntensityMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCYINTENSITY_TEXTURE)
#ifdef SS_USE_GLTF_TEXTURES
translucencyIntensity*=translucencyIntensityMap.a;
#else
translucencyIntensity*=translucencyIntensityMap.b;
#endif
#endif
#ifdef SS_TRANSLUCENCY
thickness=maxEps(thickness);var translucencyColor: vec4f=vTranslucencyColor;
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
translucencyColor*=translucencyColorMap;
#endif
var transmittance: vec3f=transmittanceBRDF_Burley(translucencyColor.rgb,vDiffusionDistance,thickness);transmittance*=translucencyIntensity;outParams.transmittance=transmittance;outParams.translucencyIntensity=translucencyIntensity;
#endif
#ifdef SS_REFRACTION
var environmentRefraction: vec4f= vec4f(0.,0.,0.,0.);
#ifdef SS_HAS_THICKNESS
var ior: f32=vRefractionInfos.y;
#else
var ior: f32=vRefractionMicrosurfaceInfos.w;
#endif
#ifdef SS_LODINREFRACTIONALPHA
var refractionAlphaG: f32=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLodFromAlphaGNdotV(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);
#elif defined(SS_LINEARSPECULARREFRACTION)
var refractionRoughness: f32=alphaG;refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);
#else
var refractionAlphaG: f32=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);
#endif
var refraction_ior: f32=vRefractionInfos.y;
#ifdef SS_DISPERSION
var realIOR: f32=1.0/refraction_ior;var iorDispersionSpread: f32=0.04*dispersion*(realIOR-1.0);var iors: vec3f= vec3f(1.0/(realIOR-iorDispersionSpread),refraction_ior,1.0/(realIOR+iorDispersionSpread));for (var i: i32=0; i<3; i++) {refraction_ior=iors[i];
#endif
var envSample: vec4f=sampleEnvironmentRefraction(refraction_ior,thickness,refractionLOD,normalW,vPositionW,viewDirectionW,view,vRefractionInfos,refractionMatrix,vRefractionMicrosurfaceInfos,alphaG
#ifdef SS_REFRACTIONMAP_3D
,refractionSampler
,refractionSamplerSampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler
,refractionLowSamplerSampler
,refractionHighSampler
,refractionHighSamplerSampler
#endif
#else
,refractionSampler
,refractionSamplerSampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler
,refractionLowSamplerSampler
,refractionHighSampler
,refractionHighSamplerSampler
#endif
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,refractionPosition
,refractionSize
#endif
);
#ifdef SS_DISPERSION
environmentRefraction[i]=envSample[i];}
#else
environmentRefraction=envSample;
#endif
environmentRefraction=vec4f(environmentRefraction.rgb*vRefractionInfos.x,environmentRefraction.a);
#endif
#ifdef SS_REFRACTION
var refractionTransmittance: vec3f= vec3f(refractionIntensity);
#ifdef SS_THICKNESSANDMASK_TEXTURE
var volumeAlbedo: vec3f=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambertVec3(volumeAlbedo,thickness);
#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)
var maxChannel: f32=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);var volumeAlbedo: vec3f=saturateVec3(maxChannel*surfaceAlbedo);environmentRefraction=vec4f(environmentRefraction.rgb*volumeAlbedo,environmentRefraction.a);
#else
var volumeAlbedo: vec3f=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambertVec3(volumeAlbedo,vThicknessParam.y);
#endif
#ifdef SS_ALBEDOFORREFRACTIONTINT
environmentRefraction=vec4f(environmentRefraction.rgb*surfaceAlbedo.rgb,environmentRefraction.a);
#endif
outParams.surfaceAlbedo=surfaceAlbedo;outParams.refractionOpacity=1.-refractionIntensity;
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
outParams.surfaceAlbedo*=outParams.refractionOpacity;
#endif
#ifdef UNUSED_MULTIPLEBOUNCES
var bounceSpecularEnvironmentReflectance: vec3f=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);
#endif
#if DEBUGMODE>0
outParams.refractionTransmittance=refractionTransmittance;
#endif
outParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;outParams.finalRefraction*=vec3f(1.0)-specularEnvironmentReflectance;
#if DEBUGMODE>0
outParams.environmentRefraction=environmentRefraction;
#endif
#endif
#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)
#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)
var irradianceVector: vec3f= (reflectionMatrix* vec4f(normalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#else
var irradianceVector: vec3f=irradianceVector_;
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP)
#if defined(REALTIME_FILTERING)
var refractionIrradiance: vec3f=irradiance(reflectionSampler,reflectionSamplerSampler,-irradianceVector,vReflectionFilteringInfo,0.0,surfaceAlbedo,irradianceVector
#ifdef IBL_CDF_FILTERING
,icdfSampler
,icdfSamplerSampler
#endif
);
#else
var refractionIrradiance: vec3f=computeEnvironmentIrradiance(-irradianceVector);
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
var irradianceCoords: vec3f=irradianceVector;
#else
var irradianceCoords: vec2f=irradianceVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
irradianceCoords/=irradianceVector.z;
#endif
irradianceCoords.y=1.0-irradianceCoords.y;
#endif
var temp: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,-irradianceCoords);var refractionIrradiance=temp.rgb;
#ifdef RGBDREFLECTION
refractionIrradiance=fromRGBD(temp).rgb;
#endif
#ifdef GAMMAREFLECTION
refractionIrradiance=toLinearSpaceVec3(refractionIrradiance);
#endif
#else
var refractionIrradiance: vec3f= vec3f(0.);
#endif
refractionIrradiance*=transmittance;
#ifdef SS_ALBEDOFORTRANSLUCENCYTINT
refractionIrradiance*=surfaceAlbedo.rgb;
#endif
outParams.refractionIrradiance=refractionIrradiance;
#endif
return outParams;}
#endif
`;S.IncludesShadersStoreWGSL[Bx]||(S.IncludesShadersStoreWGSL[Bx]=CU);const Vx="pbrBlockNormalGeometric",yU=`var viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-input.vPositionW);
#ifdef NORMAL
var normalW: vec3f=normalize(input.vNormalW);
#else
var normalW: vec3f=normalize(cross(dpdx(input.vPositionW),dpdy(input.vPositionW)))*scene.vEyePosition.w;
#endif
var geometricNormalW: vec3f=normalW;
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
geometricNormalW=select(-geometricNormalW,geometricNormalW,fragmentInputs.frontFacing);
#endif
`;S.IncludesShadersStoreWGSL[Vx]||(S.IncludesShadersStoreWGSL[Vx]=yU);const Ux="pbrBlockNormalFinal",IU=`#if defined(FORCENORMALFORWARD) && defined(NORMAL)
var faceNormal: vec3f=normalize(cross(dpdx(fragmentInputs.vPositionW),dpdy(fragmentInputs.vPositionW)))*scene.vEyePosition.w;
#if defined(TWOSIDEDLIGHTING)
faceNormal=select(-faceNormal,faceNormal,fragmentInputs.frontFacing);
#endif
normalW*=sign(dot(normalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
#if defined(MIRRORED)
normalW=select(normalW,-normalW,fragmentInputs.frontFacing);
#else
normalW=select(-normalW,normalW,fragmentInputs.frontFacing);
#endif
#endif
`;S.IncludesShadersStoreWGSL[Ux]||(S.IncludesShadersStoreWGSL[Ux]=IU);const kx="pbrBlockLightmapInit",RU=`#ifdef LIGHTMAP
var lightmapColor: vec4f=textureSample(lightmapSampler,lightmapSamplerSampler,fragmentInputs.vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor=vec4f(fromRGBD(lightmapColor),lightmapColor.a);
#endif
#ifdef GAMMALIGHTMAP
lightmapColor=vec4f(toLinearSpaceVec3(lightmapColor.rgb),lightmapColor.a);
#endif
lightmapColor=vec4f(lightmapColor.rgb*uniforms.vLightmapInfos.y,lightmapColor.a);
#endif
`;S.IncludesShadersStoreWGSL[kx]||(S.IncludesShadersStoreWGSL[kx]=RU);const Gx="pbrBlockGeometryInfo",AU=`var NdotVUnclamped: f32=dot(normalW,viewDirectionW);var NdotV: f32=absEps(NdotVUnclamped);var alphaG: f32=convertRoughnessToAverageSlope(roughness);var AARoughnessFactors: vec2f=getAARoughnessFactors(normalW.xyz);
#ifdef SPECULARAA
alphaG+=AARoughnessFactors.y;
#endif
#if defined(ENVIRONMENTBRDF)
var environmentBrdf: vec3f=getBRDFLookup(NdotV,roughness);
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
#ifdef AMBIENTINGRAYSCALE
var ambientMonochrome: f32=aoOut.ambientOcclusionColor.r;
#else
var ambientMonochrome: f32=getLuminance(aoOut.ambientOcclusionColor);
#endif
var seo: f32=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
var eho: f32=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);
#endif
#endif
#endif
#endif
`;S.IncludesShadersStoreWGSL[Gx]||(S.IncludesShadersStoreWGSL[Gx]=AU);const zx="pbrBlockReflectance",PU=`#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
var baseSpecularEnvironmentReflectance: vec3f=getReflectanceFromBRDFWithEnvLookup(vec3f(reflectanceF0),vec3f(reflectivityOut.reflectanceF90),environmentBrdf);
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
let metalEnvironmentReflectance: vec3f=vec3f(reflectivityOut.specularWeight)*getF82Specular(NdotV,clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90,reflectivityOut.roughness);let dielectricEnvironmentReflectance=getReflectanceFromBRDFWithEnvLookup(reflectivityOut.dielectricColorF0,reflectivityOut.colorReflectanceF90,environmentBrdf);var colorSpecularEnvironmentReflectance: vec3f=mix(dielectricEnvironmentReflectance,metalEnvironmentReflectance,reflectivityOut.metallic);
#else
var colorSpecularEnvironmentReflectance=getReflectanceFromBRDFWithEnvLookup(clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90,environmentBrdf);
#endif
#ifdef RADIANCEOCCLUSION
colorSpecularEnvironmentReflectance*=seo;
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
colorSpecularEnvironmentReflectance*=eho;
#endif
#endif
#endif
#else
var colorSpecularEnvironmentReflectance: vec3f=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));var baseSpecularEnvironmentReflectance: vec3f=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,vec3f(reflectanceF0),vec3f(reflectivityOut.reflectanceF90),sqrt(microSurface));
#endif
#ifdef CLEARCOAT
colorSpecularEnvironmentReflectance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
colorSpecularEnvironmentReflectance*=clearcoatOut.absorption;
#endif
#endif
`;S.IncludesShadersStoreWGSL[zx]||(S.IncludesShadersStoreWGSL[zx]=PU);const Wx="pbrBlockDirectLighting",OU=`var diffuseBase: vec3f=vec3f(0.,0.,0.);
#ifdef SS_TRANSLUCENCY
var diffuseTransmissionBase: vec3f=vec3f(0.,0.,0.);
#endif
#ifdef SPECULARTERM
var specularBase: vec3f=vec3f(0.,0.,0.);
#endif
#ifdef CLEARCOAT
var clearCoatBase: vec3f=vec3f(0.,0.,0.);
#endif
#ifdef SHEEN
var sheenBase: vec3f=vec3f(0.,0.,0.);
#endif
#if defined(SPECULARTERM) && defined(LIGHT0)
var coloredFresnel: vec3f=vec3f(0.,0.,0.);
#endif
var preInfo: preLightingInfo;var info: lightingInfo;var shadow: f32=1.; 
var aggShadow: f32=0.;var numLights: f32=0.;
#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
var absorption: vec3f=vec3f(0.);
#endif
`;S.IncludesShadersStoreWGSL[Wx]||(S.IncludesShadersStoreWGSL[Wx]=OU);const Hx="pbrBlockFinalLitComponents",NU=`aggShadow=aggShadow/numLights;
#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
var baseSpecularEnergyConservationFactor: vec3f=getEnergyConservationFactor(vec3f(reflectanceF0),environmentBrdf);var coloredEnergyConservationFactor: vec3f=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);
#endif
#endif
#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)
surfaceAlbedo=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
#ifndef METALLICWORKFLOW
#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION
surfaceAlbedo=vec3f(1.-reflectanceF0)*surfaceAlbedo.rgb;
#endif
#endif
#endif
#ifdef REFLECTION
var finalIrradiance: vec3f=reflectionOut.environmentIrradiance;
#ifndef LEGACY_SPECULAR_ENERGY_CONSERVATION
#if defined(METALLICWORKFLOW) || defined(SPECULAR_GLOSSINESS_ENERGY_CONSERVATION)
var baseSpecularEnergy: vec3f=vec3f(baseSpecularEnvironmentReflectance);
#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
baseSpecularEnergy*=baseSpecularEnergyConservationFactor;
#endif
#endif
finalIrradiance*=clamp(vec3f(1.0)-baseSpecularEnergy,vec3f(0.0),vec3f(1.0));
#endif
#endif
#if defined(CLEARCOAT)
finalIrradiance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
finalIrradiance*=clearcoatOut.absorption;
#endif
#endif
#ifndef SS_APPLY_ALBEDO_AFTER_SUBSURFACE
finalIrradiance*=surfaceAlbedo.rgb;
#endif
#if defined(SS_REFRACTION)
finalIrradiance*=subSurfaceOut.refractionOpacity;
#endif
#if defined(SS_TRANSLUCENCY)
finalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);finalIrradiance+=subSurfaceOut.refractionIrradiance;
#endif
#ifdef SS_APPLY_ALBEDO_AFTER_SUBSURFACE
finalIrradiance*=surfaceAlbedo.rgb;
#endif
finalIrradiance*=uniforms.vLightingIntensity.z;finalIrradiance*=aoOut.ambientOcclusionColor;
#endif
#ifdef SPECULARTERM
var finalSpecular: vec3f=specularBase;finalSpecular=max(finalSpecular,vec3f(0.0));var finalSpecularScaled: vec3f=finalSpecular*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalSpecularScaled*=coloredEnergyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalSpecularScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef REFLECTION
var finalRadiance: vec3f=reflectionOut.environmentRadiance.rgb;finalRadiance*=colorSpecularEnvironmentReflectance;;var finalRadianceScaled: vec3f=finalRadiance*uniforms.vLightingIntensity.z;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalRadianceScaled*=coloredEnergyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalRadianceScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef SHEEN
var finalSheen: vec3f=sheenBase*sheenOut.sheenColor;finalSheen=max(finalSheen,vec3f(0.0));var finalSheenScaled: vec3f=finalSheen*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;
#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef CLEARCOAT
var finalClearCoat: vec3f=clearCoatBase;finalClearCoat=max(finalClearCoat,vec3f(0.0));var finalClearCoatScaled: vec3f=finalClearCoat*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;
#ifdef CLEARCOAT_TINT
subSurfaceOut.finalRefraction*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef ALPHABLEND
var luminanceOverAlpha: f32=0.0;
#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)
luminanceOverAlpha+=getLuminance(finalRadianceScaled);
#if defined(CLEARCOAT)
luminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);
#endif
#endif
#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)
luminanceOverAlpha+=getLuminance(finalSpecularScaled);
#endif
#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)
luminanceOverAlpha+=getLuminance(finalClearCoatScaled);
#endif
#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)
alpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);
#endif
#endif
`;S.IncludesShadersStoreWGSL[Hx]||(S.IncludesShadersStoreWGSL[Hx]=NU);const $x="pbrBlockFinalUnlitComponents",DU=`var finalDiffuse: vec3f=diffuseBase;finalDiffuse*=surfaceAlbedo;
#if defined(SS_REFRACTION) && !defined(UNLIT) && !defined(LEGACY_SPECULAR_ENERGY_CONSERVATION)
finalDiffuse*=subSurfaceOut.refractionOpacity;
#endif
#if defined(SS_TRANSLUCENCY) && !defined(UNLIT)
finalDiffuse+=diffuseTransmissionBase;
#endif
finalDiffuse=max(finalDiffuse,vec3f(0.0));finalDiffuse*=uniforms.vLightingIntensity.x;var finalAmbient: vec3f=uniforms.vAmbientColor;finalAmbient*=surfaceAlbedo.rgb;var finalEmissive: vec3f=uniforms.vEmissiveColor;
#ifdef EMISSIVE
var emissiveColorTex: vec3f=textureSample(emissiveSampler,emissiveSamplerSampler,fragmentInputs.vEmissiveUV+uvOffset).rgb;
#ifdef GAMMAEMISSIVE
finalEmissive*=toLinearSpaceVec3(emissiveColorTex.rgb);
#else
finalEmissive*=emissiveColorTex.rgb;
#endif
finalEmissive*= uniforms.vEmissiveInfos.y;
#endif
finalEmissive*=uniforms.vLightingIntensity.y;
#ifdef AMBIENT
var ambientOcclusionForDirectDiffuse: vec3f=mix( vec3f(1.),aoOut.ambientOcclusionColor,uniforms.vAmbientInfos.w);
#else
var ambientOcclusionForDirectDiffuse: vec3f=aoOut.ambientOcclusionColor;
#endif
finalAmbient*=aoOut.ambientOcclusionColor;finalDiffuse*=ambientOcclusionForDirectDiffuse;
`;S.IncludesShadersStoreWGSL[$x]||(S.IncludesShadersStoreWGSL[$x]=DU);const Xx="pbrBlockFinalColorComposition",MU=`var finalColor: vec4f= vec4f(
#ifndef UNLIT
#ifdef REFLECTION
finalIrradiance +
#endif
#ifdef SPECULARTERM
finalSpecularScaled +
#endif
#ifdef SHEEN
finalSheenScaled +
#endif
#ifdef CLEARCOAT
finalClearCoatScaled +
#endif
#ifdef REFLECTION
finalRadianceScaled +
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled +
#endif
#ifdef CLEARCOAT
clearcoatOut.finalClearCoatRadianceScaled +
#endif
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction +
#endif
#endif
finalAmbient +
finalDiffuse,
alpha);
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
finalColor=vec4f(finalColor.rgb*lightmapColor.rgb,finalColor.a);
#else
finalColor=vec4f(finalColor.rgb+lightmapColor.rgb,finalColor.a);
#endif
#endif
#endif
finalColor=vec4f(finalColor.rgb+finalEmissive,finalColor.a);
#define CUSTOM_FRAGMENT_BEFORE_FOG
finalColor=max(finalColor,vec4f(0.0));
`;S.IncludesShadersStoreWGSL[Xx]||(S.IncludesShadersStoreWGSL[Xx]=MU);const Yx="pbrBlockImageProcessing",FU=`#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)
#if !defined(SKIPFINALCOLORCLAMP)
finalColor=vec4f(clamp(finalColor.rgb,vec3f(0.),vec3f(30.0)),finalColor.a);
#endif
#else
finalColor=applyImageProcessing(finalColor);
#endif
finalColor=vec4f(finalColor.rgb,finalColor.a*mesh.visibility);
#ifdef PREMULTIPLYALPHA
finalColor=vec4f(finalColor.rgb*finalColor.a,finalColor.a);;
#endif
`;S.IncludesShadersStoreWGSL[Yx]||(S.IncludesShadersStoreWGSL[Yx]=FU);const jx="pbrBlockPrePass",LU=`#if SCENE_MRT_COUNT>0
var writeGeometryInfo: f32=select(0.0,1.0,finalColor.a>ALPHATESTVALUE);var fragData: array<vec4<f32>,SCENE_MRT_COUNT>;
#ifdef PREPASS_POSITION
fragData[PREPASS_POSITION_INDEX]= vec4f(fragmentInputs.vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_LOCAL_POSITION
fragData[PREPASS_LOCAL_POSITION_INDEX]=vec4f(fragmentInputs.vPosition,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
var a: vec2f=(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w)*0.5+0.5;var b: vec2f=(fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w)*0.5+0.5;var velocity: vec2f=abs(a-b);velocity= vec2f(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;fragData[PREPASS_VELOCITY_INDEX]= vec4f(velocity,0.0,writeGeometryInfo);
#elif defined(PREPASS_VELOCITY_LINEAR)
var velocity : vec2f=vec2f(0.5)*((fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w) -
(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w));fragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4f(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO
fragData[PREPASS_ALBEDO_INDEX]=vec4f(surfaceAlbedo,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
var sqAlbedo : vec3f=sqrt(surfaceAlbedo); 
#endif
#ifdef PREPASS_IRRADIANCE
var irradiance : vec3f=finalDiffuse;
#ifndef UNLIT
#ifdef REFLECTION
irradiance+=finalIrradiance;
#endif
#endif
#ifdef SS_SCATTERING
#ifdef PREPASS_COLOR
fragData[PREPASS_COLOR_INDEX]=vec4f(finalColor.rgb-irradiance,finalColor.a); 
#endif
irradiance/=sqAlbedo;fragData[PREPASS_IRRADIANCE_INDEX]=vec4f(clamp(irradiance,vec3f(0.),vec3f(1.)),writeGeometryInfo*uniforms.scatteringDiffusionProfile/255.); 
#else
#ifdef PREPASS_COLOR
fragData[PREPASS_COLOR_INDEX]=finalColor; 
#endif
fragData[PREPASS_IRRADIANCE_INDEX]=vec4f(clamp(irradiance,vec3f(0.),vec3f(1.)),writeGeometryInfo); 
#endif
#elif defined(PREPASS_COLOR)
fragData[PREPASS_COLOR_INDEX]=vec4f(finalColor.rgb,finalColor.a);
#endif
#ifdef PREPASS_DEPTH
fragData[PREPASS_DEPTH_INDEX]=vec4f(fragmentInputs.vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_SCREENSPACE_DEPTH
fragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4f(fragmentInputs.position.z,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMALIZED_VIEW_DEPTH
fragData[PREPASS_NORMALIZED_VIEW_DEPTH_INDEX]=vec4f(fragmentInputs.vNormViewDepth,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMAL
#ifdef PREPASS_NORMAL_WORLDSPACE
fragData[PREPASS_NORMAL_INDEX]=vec4f(normalW,writeGeometryInfo);
#else
fragData[PREPASS_NORMAL_INDEX]=vec4f(normalize((scene.view*vec4f(normalW,0.0)).rgb),writeGeometryInfo);
#endif
#endif
#ifdef PREPASS_WORLD_NORMAL
fragData[PREPASS_WORLD_NORMAL_INDEX]=vec4f(normalW*0.5+0.5,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
fragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4f(sqAlbedo,writeGeometryInfo);
#endif
#ifdef PREPASS_REFLECTIVITY
#ifndef UNLIT
fragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(specularEnvironmentR0,microSurface)*writeGeometryInfo;
#else
fragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(0.0,0.0,0.0,1.0)*writeGeometryInfo;
#endif
#endif
#if SCENE_MRT_COUNT>0
fragmentOutputs.fragData0=fragData[0];
#endif
#if SCENE_MRT_COUNT>1
fragmentOutputs.fragData1=fragData[1];
#endif
#if SCENE_MRT_COUNT>2
fragmentOutputs.fragData2=fragData[2];
#endif
#if SCENE_MRT_COUNT>3
fragmentOutputs.fragData3=fragData[3];
#endif
#if SCENE_MRT_COUNT>4
fragmentOutputs.fragData4=fragData[4];
#endif
#if SCENE_MRT_COUNT>5
fragmentOutputs.fragData5=fragData[5];
#endif
#if SCENE_MRT_COUNT>6
fragmentOutputs.fragData6=fragData[6];
#endif
#if SCENE_MRT_COUNT>7
fragmentOutputs.fragData7=fragData[7];
#endif
#endif
`;S.IncludesShadersStoreWGSL[jx]||(S.IncludesShadersStoreWGSL[jx]=LU);const qx="pbrDebug",wU=`#if DEBUGMODE>0
if (input.vClipSpacePosition.x/input.vClipSpacePosition.w>=uniforms.vDebugMode.x) {var color: vec3f;
#if DEBUGMODE==1
color=fragmentInputs.vPositionW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==2 && defined(NORMAL)
color=fragmentInputs.vNormalW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)
color=TBN[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)
color=TBN[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==5
color=normalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==6 && defined(MAINUV1)
color= vec3f(input.vMainUV1,0.0);
#elif DEBUGMODE==7 && defined(MAINUV2)
color= vec3f(input.vMainUV2,0.0);
#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
color=clearcoatOut.TBNClearCoat[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
color=clearcoatOut.TBNClearCoat[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==10 && defined(CLEARCOAT)
color=clearcoatOut.clearCoatNormalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==11 && defined(ANISOTROPIC)
color=anisotropicOut.anisotropicNormal;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==12 && defined(ANISOTROPIC)
color=anisotropicOut.anisotropicTangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==13 && defined(ANISOTROPIC)
color=anisotropicOut.anisotropicBitangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==20 && defined(ALBEDO)
color=albedoTexture.rgb;
#ifndef GAMMAALBEDO
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==21 && defined(AMBIENT)
color=aoOut.ambientOcclusionColorMap.rgb;
#elif DEBUGMODE==22 && defined(OPACITY)
color=opacityMap.rgb;
#elif DEBUGMODE==23 && defined(EMISSIVE)
color=emissiveColorTex.rgb;
#ifndef GAMMAEMISSIVE
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==24 && defined(LIGHTMAP)
color=lightmapColor;
#ifndef GAMMALIGHTMAP
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)
color=reflectivityOut.surfaceMetallicColorMap.rgb;
#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)
color=reflectivityOut.surfaceReflectivityColorMap.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)
color= vec3f(clearcoatOut.clearCoatMapData.rg,0.0);
#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
color=clearcoatOut.clearCoatTintMapData.rgb;
#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)
color=sheenOut.sheenMapData.rgb;
#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)
color=anisotropicOut.anisotropyMapData.rgb;
#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)
color=subSurfaceOut.thicknessMap.rgb;
#elif DEBUGMODE==32 && defined(BUMP)
color=textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV).rgb;
#elif DEBUGMODE==40 && defined(SS_REFRACTION)
color=subSurfaceOut.environmentRefraction.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==41 && defined(REFLECTION)
color=reflectionOut.environmentRadiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)
color=clearcoatOut.environmentClearCoatRadiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==50
color=diffuseBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==51 && defined(SPECULARTERM)
color=specularBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==52 && defined(CLEARCOAT)
color=clearCoatBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==53 && defined(SHEEN)
color=sheenBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==54 && defined(REFLECTION)
color=reflectionOut.environmentIrradiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==60
color=surfaceAlbedo.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==61
color=clearcoatOut.specularEnvironmentR0;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)
color= vec3f(reflectivityOut.metallic);
#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)
color=reflectivityOut.metallicF0;
#elif DEBUGMODE==63
color= vec3f(roughness);
#elif DEBUGMODE==64
color= vec3f(alphaG);
#elif DEBUGMODE==65
color= vec3f(NdotV);
#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
color=clearcoatOut.clearCoatColor;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==67 && defined(CLEARCOAT)
color= vec3f(clearcoatOut.clearCoatRoughness);
#elif DEBUGMODE==68 && defined(CLEARCOAT)
color= vec3f(clearcoatOut.clearCoatNdotV);
#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)
color=subSurfaceOut.transmittance;
#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)
color=subSurfaceOut.refractionTransmittance;
#elif DEBUGMODE==72
color= vec3f(microSurface);
#elif DEBUGMODE==73
color=uniforms.vAlbedoColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==74 && !defined(METALLICWORKFLOW)
color=uniforms.vReflectivityColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==75
color=uniforms.vEmissiveColor;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)
color= vec3f(seo);
#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
color= vec3f(eho);
#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)
color= vec3f(energyConservationFactor);
#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
color=baseSpecularEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
color=clearcoatOut.clearCoatEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)
color=sheenOut.sheenEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==86 && defined(ALPHABLEND)
color= vec3f(luminanceOverAlpha);
#elif DEBUGMODE==87
color= vec3f(alpha);
#elif DEBUGMODE==88 && defined(ALBEDO)
color= vec3f(albedoTexture.a);
#elif DEBUGMODE==89
color=aoOut.ambientOcclusionColor;
#else
var stripeWidth: f32=30.;var stripePos: f32=abs(floor(input.position.x/stripeWidth));var whichColor: f32=((stripePos)%(2.));var color1: vec3f= vec3f(.6,.2,.2);var color2: vec3f= vec3f(.3,.1,.1);color=mix(color1,color2,whichColor);
#endif
color*=uniforms.vDebugMode.y;
#ifdef DEBUGMODE_NORMALIZE
color=normalize(color)*0.5+0.5;
#endif
#ifdef DEBUGMODE_GAMMA
color=toGammaSpaceVec3(color);
#endif
fragmentOutputs.color=vec4f(color,1.0);
#ifdef PREPASS
fragmentOutputs.fragData0=toLinearSpaceVec3(color); 
fragmentOutputs.fragData1=vec4f(0.,0.,0.,0.); 
#endif
#ifdef DEBUGMODE_FORCERETURN
return fragmentOutputs;
#endif
}
#endif
`;S.IncludesShadersStoreWGSL[qx]||(S.IncludesShadersStoreWGSL[qx]=wU);const jd="pbrPixelShader",CA=`#define PBR_FRAGMENT_SHADER
#define CUSTOM_FRAGMENT_BEGIN
#include<prePassDeclaration>[SCENE_MRT_COUNT]
#include<oitDeclaration>
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE
#endif
#include<pbrUboDeclaration>
#include<pbrFragmentExtraDeclaration>
#include<lightUboDeclaration>[0..maxSimultaneousLights]
#include<pbrFragmentSamplersDeclaration>
#include<imageProcessingDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<importanceSampling>
#include<pbrHelperFunctions>
#include<imageProcessingFunctions>
#include<shadowsFragmentFunctions>
#include<harmonicsFunctions>
#include<pbrDirectLightingSetupFunctions>
#include<pbrDirectLightingFalloffFunctions>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
#include<pbrDirectLightingFunctions>
#include<pbrIBLFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#ifdef REFLECTION
#include<reflectionFunction>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
#include<pbrBlockAlbedoOpacity>
#include<pbrBlockReflectivity>
#include<pbrBlockAmbientOcclusion>
#include<pbrBlockAlphaFresnel>
#include<pbrBlockAnisotropic>
#include<pbrBlockReflection>
#include<pbrBlockSheen>
#include<pbrBlockClearcoat>
#include<pbrBlockIridescence>
#include<pbrBlockSubSurface>
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#include<pbrBlockNormalGeometric>
#include<bumpFragment>
#include<pbrBlockNormalFinal>
var albedoOpacityOut: albedoOpacityOutParams;
#ifdef ALBEDO
var albedoTexture: vec4f=textureSample(albedoSampler,albedoSamplerSampler,fragmentInputs.vAlbedoUV+uvOffset);
#endif
#ifdef BASE_WEIGHT
var baseWeightTexture: vec4f=textureSample(baseWeightSampler,baseWeightSamplerSampler,fragmentInputs.vBaseWeightUV+uvOffset);
#endif
#ifdef OPACITY
var opacityMap: vec4f=textureSample(opacitySampler,opacitySamplerSampler,fragmentInputs.vOpacityUV+uvOffset);
#endif
#ifdef DECAL
var decalColor: vec4f=textureSample(decalSampler,decalSamplerSampler,fragmentInputs.vDecalUV+uvOffset);
#endif
albedoOpacityOut=albedoOpacityBlock(
uniforms.vAlbedoColor
#ifdef ALBEDO
,albedoTexture
,uniforms.vAlbedoInfos
#endif
,uniforms.baseWeight
#ifdef BASE_WEIGHT
,baseWeightTexture
,uniforms.vBaseWeightInfos
#endif
#ifdef OPACITY
,opacityMap
,uniforms.vOpacityInfos
#endif
#ifdef DETAIL
,detailColor
,uniforms.vDetailInfos
#endif
#ifdef DECAL
,decalColor
,uniforms.vDecalInfos
#endif
);var surfaceAlbedo: vec3f=albedoOpacityOut.surfaceAlbedo;var alpha: f32=albedoOpacityOut.alpha;
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
#include<depthPrePass>
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
var aoOut: ambientOcclusionOutParams;
#ifdef AMBIENT
var ambientOcclusionColorMap: vec3f=textureSample(ambientSampler,ambientSamplerSampler,fragmentInputs.vAmbientUV+uvOffset).rgb;
#endif
aoOut=ambientOcclusionBlock(
#ifdef AMBIENT
ambientOcclusionColorMap,
uniforms.vAmbientInfos
#endif
);
#include<pbrBlockLightmapInit>
#ifdef UNLIT
var diffuseBase: vec3f= vec3f(1.,1.,1.);
#else
var baseColor: vec3f=surfaceAlbedo;var reflectivityOut: reflectivityOutParams;
#if defined(REFLECTIVITY)
var surfaceMetallicOrReflectivityColorMap: vec4f=textureSample(reflectivitySampler,reflectivitySamplerSampler,fragmentInputs.vReflectivityUV+uvOffset);var baseReflectivity: vec4f=surfaceMetallicOrReflectivityColorMap;
#ifndef METALLICWORKFLOW
#ifdef REFLECTIVITY_GAMMA
surfaceMetallicOrReflectivityColorMap=toLinearSpaceVec4(surfaceMetallicOrReflectivityColorMap);
#endif
surfaceMetallicOrReflectivityColorMap=vec4f(surfaceMetallicOrReflectivityColorMap.rgb*uniforms.vReflectivityInfos.y,surfaceMetallicOrReflectivityColorMap.a);
#endif
#endif
#if defined(MICROSURFACEMAP)
var microSurfaceTexel: vec4f=textureSample(microSurfaceSampler,microSurfaceSamplerSampler,fragmentInputs.vMicroSurfaceSamplerUV+uvOffset)*uniforms.vMicroSurfaceSamplerInfos.y;
#endif
#ifdef BASE_DIFFUSE_ROUGHNESS
var baseDiffuseRoughnessTexture: f32=textureSample(baseDiffuseRoughnessSampler,baseDiffuseRoughnessSamplerSampler,fragmentInputs.vBaseDiffuseRoughnessUV+uvOffset).x;
#endif
#ifdef METALLICWORKFLOW
var metallicReflectanceFactors: vec4f=uniforms.vMetallicReflectanceFactors;
#ifdef REFLECTANCE
var reflectanceFactorsMap: vec4f=textureSample(reflectanceSampler,reflectanceSamplerSampler,fragmentInputs.vReflectanceUV+uvOffset);
#ifdef REFLECTANCE_GAMMA
reflectanceFactorsMap=toLinearSpaceVec4(reflectanceFactorsMap);
#endif
metallicReflectanceFactors=vec4f(metallicReflectanceFactors.rgb*reflectanceFactorsMap.rgb,metallicReflectanceFactors.a);
#endif
#ifdef METALLIC_REFLECTANCE
var metallicReflectanceFactorsMap: vec4f=textureSample(metallicReflectanceSampler,metallicReflectanceSamplerSampler,fragmentInputs.vMetallicReflectanceUV+uvOffset);
#ifdef METALLIC_REFLECTANCE_GAMMA
metallicReflectanceFactorsMap=toLinearSpaceVec4(metallicReflectanceFactorsMap);
#endif
#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY
metallicReflectanceFactors=vec4f(metallicReflectanceFactors.rgb*metallicReflectanceFactorsMap.rgb,metallicReflectanceFactors.a);
#endif
metallicReflectanceFactors.a*=metallicReflectanceFactorsMap.a;
#endif
#endif
reflectivityOut=reflectivityBlock(
uniforms.vReflectivityColor
#ifdef METALLICWORKFLOW
,surfaceAlbedo
,metallicReflectanceFactors
#endif
,uniforms.baseDiffuseRoughness
#ifdef BASE_DIFFUSE_ROUGHNESS
,baseDiffuseRoughnessTexture
,uniforms.vBaseDiffuseRoughnessInfos
#endif
#ifdef REFLECTIVITY
,uniforms.vReflectivityInfos
,surfaceMetallicOrReflectivityColorMap
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
,aoOut.ambientOcclusionColor
#endif
#ifdef MICROSURFACEMAP
,microSurfaceTexel
#endif
#ifdef DETAIL
,detailColor
,uniforms.vDetailInfos
#endif
);var microSurface: f32=reflectivityOut.microSurface;var roughness: f32=reflectivityOut.roughness;var diffuseRoughness: f32=reflectivityOut.diffuseRoughness;
#ifdef METALLICWORKFLOW
surfaceAlbedo=reflectivityOut.surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;
#endif
#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
var alphaFresnelOut: alphaFresnelOutParams;alphaFresnelOut=alphaFresnelBlock(
normalW,
viewDirectionW,
alpha,
microSurface
);alpha=alphaFresnelOut.alpha;
#endif
#endif
#include<pbrBlockGeometryInfo>
#ifdef ANISOTROPIC
var anisotropicOut: anisotropicOutParams;
#ifdef ANISOTROPIC_TEXTURE
var anisotropyMapData: vec3f=textureSample(anisotropySampler,anisotropySamplerSampler,fragmentInputs.vAnisotropyUV+uvOffset).rgb*uniforms.vAnisotropyInfos.y;
#endif
anisotropicOut=anisotropicBlock(
uniforms.vAnisotropy,
roughness,
#ifdef ANISOTROPIC_TEXTURE
anisotropyMapData,
#endif
TBN,
normalW,
viewDirectionW
);
#endif
#ifdef REFLECTION
var reflectionOut: reflectionOutParams;
#ifndef USE_CUSTOM_REFLECTION
reflectionOut=reflectionBlock(
fragmentInputs.vPositionW
,normalW
,alphaG
,uniforms.vReflectionMicrosurfaceInfos
,uniforms.vReflectionInfos
,uniforms.vReflectionColor
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness
#endif
,reflectionSampler
,reflectionSamplerSampler
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,fragmentInputs.vEnvironmentIrradiance
#endif
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
,uniforms.reflectionMatrix
#endif
#ifdef USEIRRADIANCEMAP
,irradianceSampler
,irradianceSamplerSampler
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
,uniforms.vReflectionDominantDirection
#endif
#endif
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,uniforms.vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,icdfSampler
,icdfSamplerSampler
#endif
#endif
,viewDirectionW
,diffuseRoughness
,surfaceAlbedo
);
#else
#define CUSTOM_REFLECTION
#endif
#endif
#include<pbrBlockReflectance0>
#ifdef SHEEN
var sheenOut: sheenOutParams;
#ifdef SHEEN_TEXTURE
var sheenMapData: vec4f=textureSample(sheenSampler,sheenSamplerSampler,fragmentInputs.vSheenUV+uvOffset);
#endif
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
var sheenMapRoughnessData: vec4f=textureSample(sheenRoughnessSampler,sheenRoughnessSamplerSampler,fragmentInputs.vSheenRoughnessUV+uvOffset)*uniforms.vSheenInfos.w;
#endif
sheenOut=sheenBlock(
uniforms.vSheenColor
#ifdef SHEEN_ROUGHNESS
,uniforms.vSheenRoughness
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
,sheenMapRoughnessData
#endif
#endif
,roughness
#ifdef SHEEN_TEXTURE
,sheenMapData
,uniforms.vSheenInfos.y
#endif
,reflectanceF0
#ifdef SHEEN_LINKWITHALBEDO
,baseColor
,surfaceAlbedo
#endif
#ifdef ENVIRONMENTBRDF
,NdotV
,environmentBrdf
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,AARoughnessFactors
,uniforms.vReflectionMicrosurfaceInfos
,uniforms.vReflectionInfos
,uniforms.vReflectionColor
,uniforms.vLightingIntensity
,reflectionSampler
,reflectionSamplerSampler
,reflectionOut.reflectionCoords
,NdotVUnclamped
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,uniforms.vReflectionFilteringInfo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
,seo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
,eho
#endif
#endif
);
#ifdef SHEEN_LINKWITHALBEDO
surfaceAlbedo=sheenOut.surfaceAlbedo;
#endif
#endif
#ifdef CLEARCOAT
#ifdef CLEARCOAT_TEXTURE
var clearCoatMapData: vec2f=textureSample(clearCoatSampler,clearCoatSamplerSampler,fragmentInputs.vClearCoatUV+uvOffset).rg*uniforms.vClearCoatInfos.y;
#endif
#endif
#ifdef IRIDESCENCE
var iridescenceOut: iridescenceOutParams;
#ifdef IRIDESCENCE_TEXTURE
var iridescenceMapData: vec2f=textureSample(iridescenceSampler,iridescenceSamplerSampler,fragmentInputs.vIridescenceUV+uvOffset).rg*uniforms.vIridescenceInfos.y;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
var iridescenceThicknessMapData: vec2f=textureSample(iridescenceThicknessSampler,iridescenceThicknessSamplerSampler,fragmentInputs.vIridescenceThicknessUV+uvOffset).rg*uniforms.vIridescenceInfos.w;
#endif
iridescenceOut=iridescenceBlock(
uniforms.vIridescenceParams
,NdotV
,specularEnvironmentR0
#ifdef IRIDESCENCE_TEXTURE
,iridescenceMapData
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
,iridescenceThicknessMapData
#endif
#ifdef CLEARCOAT
,NdotVUnclamped
,uniforms.vClearCoatParams
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData
#endif
#endif
);var iridescenceIntensity: f32=iridescenceOut.iridescenceIntensity;specularEnvironmentR0=iridescenceOut.specularEnvironmentR0;
#endif
var clearcoatOut: clearcoatOutParams;
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
var clearCoatMapRoughnessData: vec4f=textureSample(clearCoatRoughnessSampler,clearCoatRoughnessSamplerSampler,fragmentInputs.vClearCoatRoughnessUV+uvOffset)*uniforms.vClearCoatInfos.w;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
var clearCoatTintMapData: vec4f=textureSample(clearCoatTintSampler,clearCoatTintSamplerSampler,fragmentInputs.vClearCoatTintUV+uvOffset);
#endif
#ifdef CLEARCOAT_BUMP
var clearCoatBumpMapData: vec4f=textureSample(clearCoatBumpSampler,clearCoatBumpSamplerSampler,fragmentInputs.vClearCoatBumpUV+uvOffset);
#endif
clearcoatOut=clearcoatBlock(
fragmentInputs.vPositionW
,geometricNormalW
,viewDirectionW
,uniforms.vClearCoatParams
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
,clearCoatMapRoughnessData
#endif
,specularEnvironmentR0
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData
#endif
#ifdef CLEARCOAT_TINT
,uniforms.vClearCoatTintParams
,uniforms.clearCoatColorAtDistance
,uniforms.vClearCoatRefractionParams
#ifdef CLEARCOAT_TINT_TEXTURE
,clearCoatTintMapData
#endif
#endif
#ifdef CLEARCOAT_BUMP
,uniforms.vClearCoatBumpInfos
,clearCoatBumpMapData
,fragmentInputs.vClearCoatBumpUV
#if defined(TANGENT) && defined(NORMAL)
,mat3x3<f32>(input.vTBN0,input.vTBN1,input.vTBN2)
#else
,uniforms.vClearCoatTangentSpaceParams
#endif
#ifdef OBJECTSPACE_NORMALMAP
,uniforms.normalMatrix
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
,faceNormal
#endif
#ifdef REFLECTION
,uniforms.vReflectionMicrosurfaceInfos
,uniforms.vReflectionInfos
,uniforms.vReflectionColor
,uniforms.vLightingIntensity
,reflectionSampler
,reflectionSamplerSampler
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,uniforms.vReflectionFilteringInfo
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
,select(-1.,1.,fragmentInputs.frontFacing)
#endif
);
#else
clearcoatOut.specularEnvironmentR0=specularEnvironmentR0;
#endif
#include<pbrBlockReflectance>
var subSurfaceOut: subSurfaceOutParams;
#ifdef SUBSURFACE
#ifdef SS_THICKNESSANDMASK_TEXTURE
var thicknessMap: vec4f=textureSample(thicknessSampler,thicknessSamplerSampler,fragmentInputs.vThicknessUV+uvOffset);
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
var refractionIntensityMap: vec4f=textureSample(refractionIntensitySampler,refractionIntensitySamplerSampler,fragmentInputs.vRefractionIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
var translucencyIntensityMap: vec4f=textureSample(translucencyIntensitySampler,translucencyIntensitySamplerSampler,fragmentInputs.vTranslucencyIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
var translucencyColorMap: vec4f=textureSample(translucencyColorSampler,translucencyColorSamplerSampler,fragmentInputs.vTranslucencyColorUV+uvOffset);
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE_GAMMA
translucencyColorMap=toLinearSpaceVec4(translucencyColorMap);
#endif
#endif
subSurfaceOut=subSurfaceBlock(
uniforms.vSubSurfaceIntensity
,uniforms.vThicknessParam
,uniforms.vTintColor
,normalW
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
,vec3f(max(colorSpecularEnvironmentReflectance.r,max(colorSpecularEnvironmentReflectance.g,colorSpecularEnvironmentReflectance.b)))
#else
,baseSpecularEnvironmentReflectance
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
,thicknessMap
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
,refractionIntensityMap
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
,translucencyIntensityMap
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
,uniforms.reflectionMatrix
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,reflectionOut.irradianceVector
#endif
#if defined(REALTIME_FILTERING)
,reflectionSampler
,reflectionSamplerSampler
,uniforms.vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,icdfSampler
,icdfSamplerSampler
#endif
#endif
#endif
#ifdef USEIRRADIANCEMAP
,irradianceSampler
,irradianceSamplerSampler
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
,surfaceAlbedo
#endif
#ifdef SS_REFRACTION
,fragmentInputs.vPositionW
,viewDirectionW
,scene.view
,uniforms.vRefractionInfos
,uniforms.refractionMatrix
,uniforms.vRefractionMicrosurfaceInfos
,uniforms.vLightingIntensity
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
,alpha
#endif
#ifdef SS_LODINREFRACTIONALPHA
,NdotVUnclamped
#endif
#ifdef SS_LINEARSPECULARREFRACTION
,roughness
#endif
,alphaG
,refractionSampler
,refractionSamplerSampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler
,refractionLowSamplerSampler
,refractionHighSampler
,refractionHighSamplerSampler
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,uniforms.vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,uniforms.vRefractionPosition
,uniforms.vRefractionSize
#endif
#ifdef SS_DISPERSION
,uniforms.dispersion
#endif
#endif
#ifdef SS_TRANSLUCENCY
,uniforms.vDiffusionDistance
,uniforms.vTranslucencyColor
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
,translucencyColorMap
#endif
#endif
);
#ifdef SS_REFRACTION
surfaceAlbedo=subSurfaceOut.surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha=subSurfaceOut.alpha;
#endif
#endif
#else
subSurfaceOut.specularEnvironmentReflectance=colorSpecularEnvironmentReflectance;
#endif
#include<pbrBlockDirectLighting>
#include<lightFragment>[0..maxSimultaneousLights]
#include<pbrBlockFinalLitComponents>
#endif 
#include<pbrBlockFinalUnlitComponents>
#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION
#include<pbrBlockFinalColorComposition>
#include<logDepthFragment>
#include<fogFragment>(color,finalColor)
#include<pbrBlockImageProcessing>
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
#include<pbrBlockPrePass>
#endif
#if !defined(PREPASS) && !defined(ORDER_INDEPENDENT_TRANSPARENCY)
fragmentOutputs.color=finalColor;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {fragmentOutputs.frontColor=vec4f(fragmentOutputs.frontColor.rgb+finalColor.rgb*finalColor.a*alphaMultiplier,1.0-alphaMultiplier*(1.0-finalColor.a));} else {fragmentOutputs.backColor+=finalColor;}
#endif
#include<pbrDebug>
#define CUSTOM_FRAGMENT_MAIN_END
}
`;S.ShadersStoreWGSL[jd]||(S.ShadersStoreWGSL[jd]=CA);const BU={name:jd,shader:CA},yA=Object.freeze(Object.defineProperty({__proto__:null,pbrPixelShaderWGSL:BU},Symbol.toStringTag,{value:"Module"})),Zx="pbrVertexDeclaration",VU=`uniform mat4 view;uniform mat4 viewProjection;uniform vec4 vEyePosition;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif
#ifdef ALBEDO
uniform mat4 albedoMatrix;uniform vec2 vAlbedoInfos;
#endif
#ifdef BASE_WEIGHT
uniform mat4 baseWeightMatrix;uniform vec2 vBaseWeightInfos;
#endif
uniform float baseDiffuseRoughness;
#ifdef BASE_DIFFUSE_ROUGHNESS
uniform mat4 baseDiffuseRoughnessMatrix;uniform vec2 vBaseDiffuseRoughnessInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;uniform vec4 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;
#endif
#ifdef REFLECTIVITY
uniform vec3 vReflectivityInfos;uniform mat4 reflectivityMatrix;
#endif
#ifdef METALLIC_REFLECTANCE
uniform vec2 vMetallicReflectanceInfos;uniform mat4 metallicReflectanceMatrix;
#endif
#ifdef REFLECTANCE
uniform vec2 vReflectanceInfos;uniform mat4 reflectanceMatrix;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;uniform mat4 microSurfaceSamplerMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform mat4 bumpMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
uniform vec4 cameraInfo;
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;
#endif
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;
#endif
#endif
#ifdef IRIDESCENCE
#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)
uniform vec4 vIridescenceInfos;
#endif
#ifdef IRIDESCENCE_TEXTURE
uniform mat4 iridescenceMatrix;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
uniform mat4 iridescenceThicknessMatrix;
#endif
#endif
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;
#endif
#endif
#ifdef SHEEN
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
uniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
uniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
uniform vec2 vTranslucencyColorInfos;uniform mat4 translucencyColorMatrix;
#endif
#endif
#ifdef NORMAL
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;
#endif
#endif
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;uniform mat4 detailMatrix;
#endif
#include<decalVertexDeclaration>
#define ADDITIONAL_VERTEX_DECLARATION
`;S.IncludesShadersStore[Zx]||(S.IncludesShadersStore[Zx]=VU);const Qx="pbrUboDeclaration",UU=`layout(std140,column_major) uniform;uniform Material {vec2 vAlbedoInfos;vec2 vBaseWeightInfos;vec2 vBaseDiffuseRoughnessInfos;vec4 vAmbientInfos;vec2 vOpacityInfos;vec2 vEmissiveInfos;vec2 vLightmapInfos;vec3 vReflectivityInfos;vec2 vMicroSurfaceSamplerInfos;vec3 vBumpInfos;mat4 albedoMatrix;mat4 baseWeightMatrix;mat4 baseDiffuseRoughnessMatrix;mat4 ambientMatrix;mat4 opacityMatrix;mat4 emissiveMatrix;mat4 lightmapMatrix;mat4 reflectivityMatrix;mat4 microSurfaceSamplerMatrix;mat4 bumpMatrix;vec2 vTangentSpaceParams;vec4 vAlbedoColor;float baseWeight;float baseDiffuseRoughness;vec4 vLightingIntensity;float pointSize;vec4 vReflectivityColor;vec3 vEmissiveColor;vec3 vAmbientColor;vec2 vDebugMode;vec4 vMetallicReflectanceFactors;vec2 vMetallicReflectanceInfos;mat4 metallicReflectanceMatrix;vec2 vReflectanceInfos;mat4 reflectanceMatrix;vec4 cameraInfo;vec2 vReflectionInfos;mat4 reflectionMatrix;vec3 vReflectionMicrosurfaceInfos;vec3 vReflectionPosition;vec3 vReflectionSize;vec2 vReflectionFilteringInfo;vec3 vReflectionDominantDirection;vec3 vReflectionColor;vec3 vSphericalL00;vec3 vSphericalL1_1;vec3 vSphericalL10;vec3 vSphericalL11;vec3 vSphericalL2_2;vec3 vSphericalL2_1;vec3 vSphericalL20;vec3 vSphericalL21;vec3 vSphericalL22;vec3 vSphericalX;vec3 vSphericalY;vec3 vSphericalZ;vec3 vSphericalXX_ZZ;vec3 vSphericalYY_ZZ;vec3 vSphericalZZ;vec3 vSphericalXY;vec3 vSphericalYZ;vec3 vSphericalZX;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;S.IncludesShadersStore[Qx]||(S.IncludesShadersStore[Qx]=UU);const Kx="pbrBRDFFunctions",kU=`#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
#define BRDF_DIFFUSE_MODEL_EON 0
#define BRDF_DIFFUSE_MODEL_BURLEY 1
#define BRDF_DIFFUSE_MODEL_LAMBERT 2
#define BRDF_DIFFUSE_MODEL_LEGACY 3
#define DIELECTRIC_SPECULAR_MODEL_GLTF 0
#define DIELECTRIC_SPECULAR_MODEL_OPENPBR 1
#define CONDUCTOR_SPECULAR_MODEL_GLTF 0
#define CONDUCTOR_SPECULAR_MODEL_OPENPBR 1
#if !defined(PBR_VERTEX_SHADER) && !defined(OPENPBR_VERTEX_SHADER)
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 getEnergyConservationFactor(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);}
#endif
#if CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR 
vec3 getF82Specular(float NdotV,vec3 F0,vec3 edgeTint,float roughness) {const float cos_theta_max=0.142857143; 
const float one_minus_cos_theta_max_to_the_fifth=0.462664366; 
const float one_minus_cos_theta_max_to_the_sixth=0.396569457; 
vec3 white_minus_F0=vec3(1.0)-F0;vec3 b_numerator=(F0+white_minus_F0*one_minus_cos_theta_max_to_the_fifth)*(vec3(1.0)-edgeTint);const float b_denominator=cos_theta_max*one_minus_cos_theta_max_to_the_sixth;const float b_denominator_reciprocal=1.0/b_denominator;vec3 b=b_numerator*b_denominator_reciprocal; 
float cos_theta=max(roughness,NdotV);float one_minus_cos_theta=1.0-cos_theta;vec3 offset_from_F0=(white_minus_F0-b*cos_theta*one_minus_cos_theta)*pow(one_minus_cos_theta,5.0);return clamp(F0+offset_from_F0,0.0,1.0);}
#endif
#ifdef ENVIRONMENTBRDF
vec3 getBRDFLookup(float NdotV,float perceptualRoughness) {vec2 UV=vec2(NdotV,perceptualRoughness);vec4 brdfLookup=texture2D(environmentBrdfSampler,UV);
#ifdef ENVIRONMENTBRDF_RGBD
brdfLookup.rgb=fromRGBD(brdfLookup.rgba);
#endif
return brdfLookup.rgb;}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 specularEnvironmentR90,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;
#endif
return reflectance;}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;
#endif
return reflectance;}
#endif
/* NOT USED
#if defined(SHEEN) && defined(SHEEN_SOFTER)
float getBRDFLookupCharlieSheen(float NdotV,float perceptualRoughness)
{float c=1.0-NdotV;float c3=c*c*c;return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));}
#endif
*/
#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)
vec3 getReflectanceFromAnalyticalBRDFLookup_Jones(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
/**
* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.
* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table
*/
vec3 getSheenReflectanceFromBRDFLookup(const vec3 reflectance0,const vec3 environmentBrdf) {vec3 sheenEnvironmentReflectance=reflectance0*environmentBrdf.b;return sheenEnvironmentReflectance;}
#endif
vec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
float fresnelSchlickGGX(float VdotH,float reflectance0,float reflectance90)
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
#ifdef CLEARCOAT
vec3 getR0RemappedForClearCoat(vec3 f0) {
#ifdef CLEARCOAT_DEFAULTIOR
#ifdef MOBILE
return saturate(f0*(f0*0.526868+0.529324)-0.0482256);
#else
return saturate(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);
#endif
#else
vec3 s=sqrt(f0);vec3 t=(vClearCoatRefractionParams.z+vClearCoatRefractionParams.w*s)/(vClearCoatRefractionParams.w+vClearCoatRefractionParams.z*s);return square(t);
#endif
}
#endif
#ifdef IRIDESCENCE
const mat3 XYZ_TO_REC709=mat3(
3.2404542,-0.9692660, 0.0556434,
-1.5371385, 1.8760108,-0.2040259,
-0.4985314, 0.0415560, 1.0572252
);vec3 getIORTfromAirToSurfaceR0(vec3 f0) {vec3 sqrtF0=sqrt(f0);return (1.+sqrtF0)/(1.-sqrtF0);}
vec3 getR0fromIORs(vec3 iorT,float iorI) {return square((iorT-vec3(iorI))/(iorT+vec3(iorI)));}
float getR0fromIORs(float iorT,float iorI) {return square((iorT-iorI)/(iorT+iorI));}
vec3 evalSensitivity(float opd,vec3 shift) {float phase=2.0*PI*opd*1.0e-9;const vec3 val=vec3(5.4856e-13,4.4201e-13,5.2481e-13);const vec3 pos=vec3(1.6810e+06,1.7953e+06,2.2084e+06);const vec3 var=vec3(4.3278e+09,9.3046e+09,6.6121e+09);vec3 xyz=val*sqrt(2.0*PI*var)*cos(pos*phase+shift)*exp(-square(phase)*var);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));xyz/=1.0685e-7;vec3 srgb=XYZ_TO_REC709*xyz;return srgb;}
vec3 evalIridescence(float outsideIOR,float eta2,float cosTheta1,float thinFilmThickness,vec3 baseF0) {vec3 I=vec3(1.0);float iridescenceIOR=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));float sinTheta2Sq=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));float cosTheta2Sq=1.0-sinTheta2Sq;if (cosTheta2Sq<0.0) {return I;}
float cosTheta2=sqrt(cosTheta2Sq);float R0=getR0fromIORs(iridescenceIOR,outsideIOR);float R12=fresnelSchlickGGX(cosTheta1,R0,1.);float R21=R12;float T121=1.0-R12;float phi12=0.0;if (iridescenceIOR<outsideIOR) phi12=PI;float phi21=PI-phi12;vec3 baseIOR=getIORTfromAirToSurfaceR0(clamp(baseF0,0.0,0.9999)); 
vec3 R1=getR0fromIORs(baseIOR,iridescenceIOR);vec3 R23=fresnelSchlickGGX(cosTheta2,R1,vec3(1.));vec3 phi23=vec3(0.0);if (baseIOR[0]<iridescenceIOR) phi23[0]=PI;if (baseIOR[1]<iridescenceIOR) phi23[1]=PI;if (baseIOR[2]<iridescenceIOR) phi23[2]=PI;float opd=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;vec3 phi=vec3(phi21)+phi23;vec3 R123=clamp(R12*R23,1e-5,0.9999);vec3 r123=sqrt(R123);vec3 Rs=square(T121)*R23/(vec3(1.0)-R123);vec3 C0=R12+Rs;I=C0;vec3 Cm=Rs-T121;for (int m=1; m<=2; ++m)
{Cm*=r123;vec3 Sm=2.0*evalSensitivity(float(m)*opd,float(m)*phi);I+=Cm*Sm;}
return max(I,vec3(0.0));}
#endif
float normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)
{float a2=square(alphaG);float d=NdotH*NdotH*(a2-1.0)+1.0;return a2/(PI*d*d);}
#ifdef SHEEN
float normalDistributionFunction_CharlieSheen(float NdotH,float alphaG)
{float invR=1./alphaG;float cos2h=NdotH*NdotH;float sin2h=1.-cos2h;return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);}
#endif
#ifdef ANISOTROPIC
float normalDistributionFunction_BurleyGGX_Anisotropic(float NdotH,float TdotH,float BdotH,const vec2 alphaTB) {float a2=alphaTB.x*alphaTB.y;vec3 v=vec3(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);float v2=dot(v,v);float w2=a2/v2;return a2*w2*w2*RECIPROCAL_PI;}
#endif
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility_GGXCorrelated(float NdotL,float NdotV,float alphaG) {
#ifdef MOBILE
float GGXV=NdotL*(NdotV*(1.0-alphaG)+alphaG);float GGXL=NdotV*(NdotL*(1.0-alphaG)+alphaG);return 0.5/(GGXV+GGXL);
#else
float a2=alphaG*alphaG;float GGXV=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);float GGXL=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);return 0.5/(GGXV+GGXL);
#endif
}
#else
float smithVisibilityG1_TrowbridgeReitzGGXFast(float dot,float alphaG)
{
#ifdef MOBILE
return 1.0/(dot+alphaG+(1.0-alphaG)*dot ));
#else
float alphaSquared=alphaG*alphaG;return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));
#endif
}
float smithVisibility_TrowbridgeReitzGGXFast(float NdotL,float NdotV,float alphaG)
{float visibility=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);return visibility;}
#endif
#ifdef ANISOTROPIC
float smithVisibility_GGXCorrelated_Anisotropic(float NdotL,float NdotV,float TdotV,float BdotV,float TdotL,float BdotL,const vec2 alphaTB) {float lambdaV=NdotL*length(vec3(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));float lambdaL=NdotV*length(vec3(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));float v=0.5/(lambdaV+lambdaL);return v;}
#endif
#ifdef CLEARCOAT
float visibility_Kelemen(float VdotH) {return 0.25/(VdotH*VdotH); }
#endif
#ifdef SHEEN
float visibility_Ashikhmin(float NdotL,float NdotV)
{return 1./(4.*(NdotL+NdotV-NdotL*NdotV));}
/* NOT USED
#ifdef SHEEN_SOFTER
float l(float x,float alphaG)
{float oneMinusAlphaSq=(1.0-alphaG)*(1.0-alphaG);float a=mix(21.5473,25.3245,oneMinusAlphaSq);float b=mix(3.82987,3.32435,oneMinusAlphaSq);float c=mix(0.19823,0.16801,oneMinusAlphaSq);float d=mix(-1.97760,-1.27393,oneMinusAlphaSq);float e=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}
float lambdaSheen(float cosTheta,float alphaG)
{return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));}
float visibility_CharlieSheen(float NdotL,float NdotV,float alphaG)
{float G=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));return G/(4.0*NdotV*NdotL);}
#endif
*/
#endif
float diffuseBRDF_Burley(float NdotL,float NdotV,float VdotH,float roughness) {float diffuseFresnelNV=pow5(saturateEps(1.0-NdotL));float diffuseFresnelNL=pow5(saturateEps(1.0-NdotV));float diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;float fresnel =
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);return fresnel/PI;}
const float constant1_FON=0.5-2.0/(3.0*PI);const float constant2_FON=2.0/3.0-28.0/(15.0*PI);float E_FON_approx(float mu,float roughness)
{float sigma=roughness; 
float mucomp=1.0-mu;float mucomp2=mucomp*mucomp;const mat2 Gcoeffs=mat2(0.0571085289,-0.332181442,
0.491881867,0.0714429953);float GoverPi=dot(Gcoeffs*vec2(mucomp,mucomp2),vec2(1.0,mucomp2));return (1.0+sigma*GoverPi)/(1.0+constant1_FON*sigma);}
vec3 diffuseBRDF_EON(vec3 albedo,float roughness,float NdotL,float NdotV,float LdotV)
{vec3 rho=albedo;float sigma=roughness; 
float mu_i=NdotL; 
float mu_o=NdotV; 
float s=LdotV-mu_i*mu_o; 
float sovertF=s>0.0 ? s/max(mu_i,mu_o) : s; 
float AF=1.0/(1.0+constant1_FON*sigma); 
vec3 f_ss=(rho*RECIPROCAL_PI)*AF*(1.0+sigma*sovertF); 
float EFo=E_FON_approx(mu_o,sigma); 
float EFi=E_FON_approx(mu_i,sigma); 
float avgEF=AF*(1.0+constant2_FON*sigma); 
vec3 rho_ms=(rho*rho)*avgEF/(vec3(1.0)-rho*(1.0-avgEF));const float eps=1.0e-7;vec3 f_ms=(rho_ms*RECIPROCAL_PI)*max(eps,1.0-EFo) 
* max(eps,1.0-EFi)
/ max(eps,1.0-avgEF);return (f_ss+f_ms);}
#ifdef SS_TRANSLUCENCY
vec3 transmittanceBRDF_Burley(const vec3 tintColor,const vec3 diffusionDistance,float thickness) {vec3 S=1./maxEps(diffusionDistance);vec3 temp=exp((-0.333333333*thickness)*S);return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);}
float computeWrappedDiffuseNdotL(float NdotL,float w) {float t=1.0+w;float invt2=1.0/square(t);return saturate((NdotL+w)*invt2);}
#endif
#endif 
`;S.IncludesShadersStore[Kx]||(S.IncludesShadersStore[Kx]=kU);const Jx="harmonicsFunctions",GU=`#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
vec3 computeEnvironmentIrradiance(vec3 normal) {return vSphericalL00
+ vSphericalL1_1*(normal.y)
+ vSphericalL10*(normal.z)
+ vSphericalL11*(normal.x)
+ vSphericalL2_2*(normal.y*normal.x)
+ vSphericalL2_1*(normal.y*normal.z)
+ vSphericalL20*((3.0*normal.z*normal.z)-1.0)
+ vSphericalL21*(normal.z*normal.x)
+ vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));}
#else
vec3 computeEnvironmentIrradiance(vec3 normal) {float Nx=normal.x;float Ny=normal.y;float Nz=normal.z;vec3 C1=vSphericalZZ.rgb;vec3 Cx=vSphericalX.rgb;vec3 Cy=vSphericalY.rgb;vec3 Cz=vSphericalZ.rgb;vec3 Cxx_zz=vSphericalXX_ZZ.rgb;vec3 Cyy_zz=vSphericalYY_ZZ.rgb;vec3 Cxy=vSphericalXY.rgb;vec3 Cyz=vSphericalYZ.rgb;vec3 Czx=vSphericalZX.rgb;vec3 a1=Cyy_zz*Ny+Cy;vec3 a2=Cyz*Nz+a1;vec3 b1=Czx*Nz+Cx;vec3 b2=Cxy*Ny+b1;vec3 b3=Cxx_zz*Nx+b2;vec3 t1=Cz *Nz+C1;vec3 t2=a2 *Ny+t1;vec3 t3=b3 *Nx+t2;return t3;}
#endif
#endif
`;S.IncludesShadersStore[Jx]||(S.IncludesShadersStore[Jx]=GU);const qd="pbrVertexShader",IA=`#define PBR_VERTEX_SHADER
#define CUSTOM_VERTEX_EXTENSION
precision highp float;
#include<__decl__pbrVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#include<mainUVVaryingDeclaration>[1..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<pbrBRDFFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)
#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight)
#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)
#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)
#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
#ifdef CLEARCOAT
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)
#endif
#ifdef SUBSURFACE
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor)
#endif
varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#include<harmonicsFunctions>
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
varying float vViewDepth;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#ifdef UV2
vec2 uv2Updated=uv2;
#endif
#ifdef VERTEXCOLOR
vec4 colorUpdated=color;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);vPositionW=vec3(worldPos);
#ifdef PREPASS
#include<prePassVertex>
#endif
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
#if BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LAMBERT && BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LEGACY
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);float NdotV=max(dot(vNormalW,viewDirectionW),0.0);vec3 roughNormal=mix(vNormalW,viewDirectionW,(0.5*(1.0-NdotV))*baseDiffuseRoughness);vec3 reflectionVector=vec3(reflectionMatrix*vec4(roughNormal,0)).xyz;
#else
vec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
#if DEBUGMODE>0
vClipSpacePosition=gl_Position;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
vViewDepth=(view*worldPos).z;
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2Updated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#ifdef MAINUV2
vMainUV2=uv2Updated;
#endif
#include<uvVariableDeclaration>[3..7]
#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight,_MATRIXNAME_,baseWeight,_INFONAME_,BaseWeightInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness,_MATRIXNAME_,baseDiffuseRoughness,_INFONAME_,BaseDiffuseRoughnessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#ifdef CLEARCOAT
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)
#endif
#ifdef SHEEN
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheenRoughness,_INFONAME_,SheenInfos.z)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)
#endif
#ifdef SUBSURFACE
#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_MATRIXNAME_,translucencyColor,_INFONAME_,TranslucencyColorInfos.x)
#endif
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;S.ShadersStore[qd]||(S.ShadersStore[qd]=IA);const zU={name:qd,shader:IA},RA=Object.freeze(Object.defineProperty({__proto__:null,pbrVertexShader:zU},Symbol.toStringTag,{value:"Module"})),eE="pbrFragmentDeclaration",WU=`uniform vec4 vEyePosition;uniform vec3 vReflectionColor;uniform vec4 vAlbedoColor;uniform float baseWeight;uniform float baseDiffuseRoughness;uniform vec4 vLightingIntensity;uniform vec4 vReflectivityColor;uniform vec4 vMetallicReflectanceFactors;uniform vec3 vEmissiveColor;uniform float visibility;uniform vec3 vAmbientColor;
#ifdef ALBEDO
uniform vec2 vAlbedoInfos;
#endif
#ifdef BASE_WEIGHT
uniform vec2 vBaseWeightInfos;
#endif
#ifdef BASE_DIFFUSE_ROUGHNESS
uniform vec2 vBaseDiffuseRoughnessInfos;
#endif
#ifdef AMBIENT
uniform vec4 vAmbientInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;
#endif
#ifdef OPACITY
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef REFLECTIVITY
uniform vec3 vReflectivityInfos;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#ifdef REALTIME_FILTERING
uniform vec2 vReflectionFilteringInfo;
#endif
uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;
#if defined(USEIRRADIANCEMAP) && defined(USE_IRRADIANCE_DOMINANT_DIRECTION)
uniform vec3 vReflectionDominantDirection;
#endif
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;uniform vec3 vReflectionSize;
#endif
#endif
#if defined(SS_REFRACTION) && defined(SS_USE_LOCAL_REFRACTIONMAP_CUBIC)
uniform vec3 vRefractionPosition;uniform vec3 vRefractionSize;
#endif
#ifdef CLEARCOAT
uniform vec2 vClearCoatParams;uniform vec4 vClearCoatRefractionParams;
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;uniform vec2 vClearCoatTangentSpaceParams;uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT
uniform vec4 vClearCoatTintParams;uniform float clearCoatColorAtDistance;
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;
#endif
#endif
#endif
#ifdef IRIDESCENCE
uniform vec4 vIridescenceParams;
#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)
uniform vec4 vIridescenceInfos;
#endif
#ifdef IRIDESCENCE_TEXTURE
uniform mat4 iridescenceMatrix;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
uniform mat4 iridescenceThicknessMatrix;
#endif
#endif
#ifdef ANISOTROPIC
uniform vec3 vAnisotropy;
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;
#endif
#endif
#ifdef SHEEN
uniform vec4 vSheenColor;
#ifdef SHEEN_ROUGHNESS
uniform float vSheenRoughness;
#endif
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionMicrosurfaceInfos;uniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;
#ifdef REALTIME_FILTERING
uniform vec2 vRefractionFilteringInfo;
#endif
#ifdef SS_DISPERSION
uniform float dispersion;
#endif
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
uniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
uniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;
#endif
uniform vec2 vThicknessParam;uniform vec3 vDiffusionDistance;uniform vec4 vTintColor;uniform vec3 vSubSurfaceIntensity;uniform vec4 vTranslucencyColor;
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
uniform vec2 vTranslucencyColorInfos;uniform mat4 translucencyColorMatrix;
#endif
#endif
#ifdef PREPASS
#ifdef SS_SCATTERING
uniform float scatteringDiffusionProfile;
#endif
#endif
#if DEBUGMODE>0
uniform vec2 vDebugMode;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#include<decalFragmentDeclaration>
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;
#endif
#endif
#define ADDITIONAL_FRAGMENT_DECLARATION
`;S.IncludesShadersStore[eE]||(S.IncludesShadersStore[eE]=WU);const tE="pbrFragmentExtraDeclaration",HU=`varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
varying float vViewDepth;
#endif
`;S.IncludesShadersStore[tE]||(S.IncludesShadersStore[tE]=HU);const iE="samplerFragmentAlternateDeclaration",$U=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
#endif
`;S.IncludesShadersStore[iE]||(S.IncludesShadersStore[iE]=$U);const rE="pbrFragmentSamplersDeclaration",XU=`#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight,_SAMPLERNAME_,baseWeight)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness,_SAMPLERNAME_,baseDiffuseRoughness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)
#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef CLEARCOAT
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform sampler2D clearCoatRoughnessSampler;
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS)
uniform sampler2D sheenRoughnessSampler;
#endif
#endif
#ifdef ANISOTROPIC
#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform samplerCube irradianceSampler;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D reflectionSamplerLow;uniform sampler2D reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform sampler2D irradianceSampler;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#endif
#ifdef ENVIRONMENTBRDF
uniform sampler2D environmentBrdfSampler;
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#ifdef SS_REFRACTIONMAP_3D
#define sampleRefraction(s,c) textureCube(s,c)
uniform samplerCube refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube refractionSamplerLow;uniform samplerCube refractionSamplerHigh;
#endif
#else
#define sampleRefraction(s,c) texture2D(s,c)
uniform sampler2D refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D refractionSamplerLow;uniform sampler2D refractionSamplerHigh;
#endif
#endif
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_SAMPLERNAME_,translucencyColor)
#endif
#ifdef IBL_CDF_FILTERING
uniform sampler2D icdfSampler;
#endif
`;S.IncludesShadersStore[rE]||(S.IncludesShadersStore[rE]=XU);const sE="subSurfaceScatteringFunctions",YU=`bool testLightingForSSS(float diffusionProfile)
{return diffusionProfile<1.;}`;S.IncludesShadersStore[sE]||(S.IncludesShadersStore[sE]=YU);const nE="importanceSampling",jU=`vec3 hemisphereCosSample(vec2 u) {float phi=2.*PI*u.x;float cosTheta2=1.-u.y;float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
vec3 hemisphereImportanceSampleDggx(vec2 u,float a) {float phi=2.*PI*u.x;float cosTheta2=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
vec3 hemisphereImportanceSampleDggxAnisotropic(vec2 Xi,float alphaTangent,float alphaBitangent)
{alphaTangent=max(alphaTangent,0.0001);alphaBitangent=max(alphaBitangent,0.0001);float phi=atan(alphaBitangent/alphaTangent*tan(2.0*3.14159265*Xi.x));if (Xi.x>0.5) phi+=3.14159265; 
float cosPhi=cos(phi);float sinPhi=sin(phi);float alpha2=(cosPhi*cosPhi)/(alphaTangent*alphaTangent) +
(sinPhi*sinPhi)/(alphaBitangent*alphaBitangent);float tanTheta2=Xi.y/(1.0-Xi.y)/alpha2;float cosTheta=1.0/sqrt(1.0+tanTheta2);float sinTheta=sqrt(max(0.0,1.0-cosTheta*cosTheta));return vec3(sinTheta*cosPhi,sinTheta*sinPhi,cosTheta);}
vec3 hemisphereImportanceSampleDCharlie(vec2 u,float a) { 
float phi=2.*PI*u.x;float sinTheta=pow(u.y,a/(2.*a+1.));float cosTheta=sqrt(1.-sinTheta*sinTheta);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}`;S.IncludesShadersStore[nE]||(S.IncludesShadersStore[nE]=jU);const aE="pbrHelperFunctions",qU=`#define MINIMUMVARIANCE 0.0005
float convertRoughnessToAverageSlope(float roughness)
{return square(roughness)+MINIMUMVARIANCE;}
float fresnelGrazingReflectance(float reflectance0) {float reflectance90=saturate(reflectance0*25.0);return reflectance90;}
vec2 getAARoughnessFactors(vec3 normalVector) {
#ifdef SPECULARAA
vec3 nDfdx=dFdx(normalVector.xyz);vec3 nDfdy=dFdy(normalVector.xyz);float slopeSquare=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));float geometricRoughnessFactor=pow(saturate(slopeSquare),0.333);float geometricAlphaGFactor=sqrt(slopeSquare);geometricAlphaGFactor*=0.75;return vec2(geometricRoughnessFactor,geometricAlphaGFactor);
#else
return vec2(0.);
#endif
}
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_LEGACY
vec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);return vec2(alphaT,alphaB);}
vec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 anisotropicFrameDirection;if (anisotropy>=0.0) {anisotropicFrameDirection=B;} else {anisotropicFrameDirection=T;}
vec3 anisotropicFrameTangent=cross(normalize(anisotropicFrameDirection),V);vec3 anisotropicFrameNormal=cross(anisotropicFrameTangent,anisotropicFrameDirection);vec3 anisotropicNormal=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));return anisotropicNormal;}
#elif ANISOTROPIC_OPENPBR
vec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=alphaG*sqrt(2.0/(1.0+(1.0-anisotropy)*(1.0-anisotropy)));float alphaB=max(alphaT*(1.0-anisotropy),MINIMUMVARIANCE);return vec2(alphaT,alphaB);}
#else
vec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(mix(alphaG,1.0,anisotropy*anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG,MINIMUMVARIANCE);return vec2(alphaT,alphaB);}
vec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 bentNormal=cross(B,V);bentNormal=normalize(cross(bentNormal,B));float a=square(square(1.0-anisotropy*(1.0-roughness)));bentNormal=normalize(mix(bentNormal,N,a));return bentNormal;}
#endif
#endif
#if defined(CLEARCOAT) || defined(SS_REFRACTION)
vec3 cocaLambert(vec3 alpha,float distance) {return exp(-alpha*distance);}
vec3 cocaLambert(float NdotVRefract,float NdotLRefract,vec3 alpha,float thickness) {return cocaLambert(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));}
vec3 computeColorAtDistanceInMedia(vec3 color,float distance) {return -log(color)/distance;}
vec3 computeClearCoatAbsorption(float NdotVRefract,float NdotLRefract,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 clearCoatAbsorption=mix(vec3(1.0),
cocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),
clearCoatIntensity);return clearCoatAbsorption;}
#endif
#ifdef MICROSURFACEAUTOMATIC
float computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)
{const float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;float reflectivityLuminance=getLuminance(reflectivityColor);float reflectivityLuma=sqrt(reflectivityLuminance);microSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;return microSurface;}
#endif
`;S.IncludesShadersStore[aE]||(S.IncludesShadersStore[aE]=qU);const oE="pbrDirectLightingSetupFunctions",ZU=`struct preLightingInfo
{vec3 lightOffset;float lightDistanceSquared;float lightDistance;float attenuation;vec3 L;vec3 H;float NdotV;float NdotLUnclamped;float NdotL;float VdotH;float LdotV;float roughness;float diffuseRoughness;vec3 surfaceAlbedo;
#ifdef IRIDESCENCE
float iridescenceIntensity;
#endif
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
vec3 areaLightDiffuse;
#ifdef SPECULARTERM
vec3 areaLightSpecular;vec4 areaLightFresnel;
#endif
#endif
};preLightingInfo computePointAndSpotPreLightingInfo(vec4 lightData,vec3 V,vec3 N,vec3 posW) {preLightingInfo result;result.lightOffset=lightData.xyz-posW;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);result.L=normalize(result.lightOffset);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);result.LdotV=0.;result.roughness=0.;result.diffuseRoughness=0.;result.surfaceAlbedo=vec3(0.);return result;}
preLightingInfo computeDirectionalPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.lightDistance=length(-lightData.xyz);result.L=normalize(-lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);result.LdotV=dot(result.L,V);result.roughness=0.;result.diffuseRoughness=0.;result.surfaceAlbedo=vec3(0.);return result;}
preLightingInfo computeHemisphericPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.NdotL=dot(N,lightData.xyz)*0.5+0.5;result.NdotL=saturateEps(result.NdotL);result.NdotLUnclamped=result.NdotL;
#ifdef SPECULARTERM
result.L=normalize(lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));
#endif
result.LdotV=0.;result.roughness=0.;result.diffuseRoughness=0.;result.surfaceAlbedo=vec3(0.);return result;}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
#include<ltcHelperFunctions>
uniform sampler2D areaLightsLTC1Sampler;uniform sampler2D areaLightsLTC2Sampler;preLightingInfo computeAreaPreLightingInfo(sampler2D ltc1,sampler2D ltc2,vec3 viewDirectionW,vec3 vNormal,vec3 vPosition,vec4 lightData,vec3 halfWidth,vec3 halfHeight,float roughness )
{preLightingInfo result;result.lightOffset=lightData.xyz-vPosition;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);areaLightData data=computeAreaLightSpecularDiffuseFresnel(ltc1,ltc2,viewDirectionW,vNormal,vPosition,lightData.xyz,halfWidth,halfHeight,roughness);
#ifdef SPECULARTERM
result.areaLightFresnel=data.Fresnel;result.areaLightSpecular=data.Specular;
#endif
result.areaLightDiffuse=data.Diffuse;result.LdotV=0.;result.roughness=0.;result.diffuseRoughness=0.;result.surfaceAlbedo=vec3(0.);return result;}
#endif
`;S.IncludesShadersStore[oE]||(S.IncludesShadersStore[oE]=ZU);const lE="pbrDirectLightingFalloffFunctions",QU=`float computeDistanceLightFalloff_Standard(vec3 lightOffset,float range)
{return max(0.,1.0-length(lightOffset)/range);}
float computeDistanceLightFalloff_Physical(float lightDistanceSquared)
{return 1.0/maxEps(lightDistanceSquared);}
float computeDistanceLightFalloff_GLTF(float lightDistanceSquared,float inverseSquaredRange)
{float lightDistanceFalloff=1.0/maxEps(lightDistanceSquared);float factor=lightDistanceSquared*inverseSquaredRange;float attenuation=saturate(1.0-factor*factor);attenuation*=attenuation;lightDistanceFalloff*=attenuation;return lightDistanceFalloff;}
float computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range,float inverseSquaredRange)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDistanceLightFalloff_Physical(lightDistanceSquared);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);
#else
return computeDistanceLightFalloff_Standard(lightOffset,range);
#endif
}
float computeDirectionalLightFalloff_Standard(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)
{float falloff=0.0;float cosAngle=maxEps(dot(-lightDirection,directionToLightCenterW));if (cosAngle>=cosHalfAngle)
{falloff=max(0.,pow(cosAngle,exponent));}
return falloff;}
float computeDirectionalLightFalloff_IES(vec3 lightDirection,vec3 directionToLightCenterW,sampler2D iesLightSampler)
{float cosAngle=dot(-lightDirection,directionToLightCenterW);float angle=acos(cosAngle)/PI;return texture2D(iesLightSampler,vec2(angle,0.)).r;}
float computeDirectionalLightFalloff_Physical(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle)
{const float kMinusLog2ConeAngleIntensityRatio=6.64385618977; 
float concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);vec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);float falloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));return falloff;}
float computeDirectionalLightFalloff_GLTF(vec3 lightDirection,vec3 directionToLightCenterW,float lightAngleScale,float lightAngleOffset)
{float cd=dot(-lightDirection,directionToLightCenterW);float falloff=saturate(cd*lightAngleScale+lightAngleOffset);falloff*=falloff;return falloff;}
float computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent,float lightAngleScale,float lightAngleOffset)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);
#else
return computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);
#endif
}`;S.IncludesShadersStore[lE]||(S.IncludesShadersStore[lE]=QU);const cE="hdrFilteringFunctions",KU=`#if NUM_SAMPLES
#if NUM_SAMPLES>0
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
float radicalInverse_VdC(uint bits) 
{bits=(bits<<16u) | (bits>>16u);bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);return float(bits)*2.3283064365386963e-10; }
vec2 hammersley(uint i,uint N)
{return vec2(float(i)/float(N),radicalInverse_VdC(i));}
#else
float vanDerCorpus(int n,int base)
{float invBase=1.0/float(base);float denom =1.0;float result =0.0;for(int i=0; i<32; ++i)
{if(n>0)
{denom =mod(float(n),2.0);result+=denom*invBase;invBase=invBase/2.0;n =int(float(n)/2.0);}}
return result;}
vec2 hammersley(int i,int N)
{return vec2(float(i)/float(N),vanDerCorpus(i,2));}
#endif
float log4(float x) {return log2(x)/2.;}
vec3 uv_to_normal(vec2 uv) {vec3 N;vec2 uvRange=uv;float theta=uvRange.x*2.*PI;float phi=uvRange.y*PI;float sinPhi=sin(phi);N.x=cos(theta)*sinPhi;N.z=sin(theta)*sinPhi;N.y=cos(phi);return N;}
const float NUM_SAMPLES_FLOAT=float(NUM_SAMPLES);const float NUM_SAMPLES_FLOAT_INVERSED=1./NUM_SAMPLES_FLOAT;const float K=4.;
#define inline
vec3 irradiance(
#ifdef CUSTOM_IRRADIANCE_FILTERING_INPUT
CUSTOM_IRRADIANCE_FILTERING_INPUT
#else
samplerCube inputTexture,
#endif
vec3 inputN,vec2 filteringInfo,
float diffuseRoughness,
vec3 surfaceAlbedo,
vec3 inputV
#if IBL_CDF_FILTERING
,sampler2D icdfSampler
#endif
)
{vec3 n=normalize(inputN);vec3 result=vec3(0.);
#ifndef IBL_CDF_FILTERING
vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);mat3 tbnInverse=mat3(tangent.x,bitangent.x,n.x,tangent.y,bitangent.y,n.y,tangent.z,bitangent.z,n.z);
#endif
float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);vec3 clampedAlbedo=clamp(surfaceAlbedo,vec3(0.1),vec3(1.0));
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{vec2 Xi=hammersley(i,NUM_SAMPLES);
#if IBL_CDF_FILTERING
vec2 T;T.x=texture2D(icdfSampler,vec2(Xi.x,0.)).x;T.y=texture2D(icdfSampler,vec2(T.x,Xi.y)).y;vec3 Ls=uv_to_normal(vec2(1.0-fract(T.x+0.25),T.y));float NoL=dot(n,Ls);float NoV=dot(n,inputV);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
float LoV=dot (Ls,inputV);
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
vec3 H=(inputV+Ls)*0.5;float VoH=dot(inputV,H);
#endif
#else
vec3 Ls=hemisphereCosSample(Xi);Ls=normalize(Ls);float NoL=Ls.z; 
vec3 V=tbnInverse*inputV;float NoV=V.z; 
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
float LoV=dot (Ls,V);
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
vec3 H=(V+Ls)*0.5;float VoH=dot(V,H);
#endif
#endif
if (NoL>0.) {
#if IBL_CDF_FILTERING
float pdf=texture2D(icdfSampler,T).z;vec3 c=textureCubeLodEXT(inputTexture,Ls,0.).rgb;
#else
float pdf_inversed=PI/NoL;float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(l,0.,maxLevel);
#ifdef CUSTOM_IRRADIANCE_FILTERING_FUNCTION
CUSTOM_IRRADIANCE_FILTERING_FUNCTION
#else
vec3 c=textureCubeLodEXT(inputTexture,tbn*Ls,mipLevel).rgb;
#endif
#endif
#if GAMMA_INPUT
c=toLinearSpace(c);
#endif
vec3 diffuseRoughnessTerm=vec3(1.0);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
diffuseRoughnessTerm=diffuseBRDF_EON(clampedAlbedo,diffuseRoughness,NoL,NoV,LoV)*PI;
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
diffuseRoughnessTerm=vec3(diffuseBRDF_Burley(NoL,NoV,VoH,diffuseRoughness)*PI);
#endif
#if IBL_CDF_FILTERING
vec3 light=pdf<1e-6 ? vec3(0.0) : vec3(1.0)/vec3(pdf)*c;result+=NoL*diffuseRoughnessTerm*light;
#else
result+=c*diffuseRoughnessTerm;
#endif
}}
result=result*NUM_SAMPLES_FLOAT_INVERSED;
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
result=result/clampedAlbedo;
#endif
return result;}
#define inline
vec3 radiance(float alphaG,samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)
{vec3 n=normalize(inputN);vec3 c=textureCube(inputTexture,n).rgb; 
if (alphaG==0.) {
#if GAMMA_INPUT
c=toLinearSpace(c);
#endif
return c;} else {vec3 result=vec3(0.);vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);float weight=0.;
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{vec2 Xi=hammersley(i,NUM_SAMPLES);vec3 H=hemisphereImportanceSampleDggx(Xi,alphaG);float NoV=1.;float NoH=H.z;float NoH2=H.z*H.z;float NoL=2.*NoH2-1.;vec3 L=vec3(2.*NoH*H.x,2.*NoH*H.y,NoL);L=normalize(L);if (NoL>0.) {float pdf_inversed=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(float(l),0.0,maxLevel);weight+=NoL;vec3 c=textureCubeLodEXT(inputTexture,tbn*L,mipLevel).rgb;
#if GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c*NoL;}}
result=result/weight;return result;}}
#ifdef ANISOTROPIC
#define inline
vec3 radianceAnisotropic(
float alphaTangent, 
float alphaBitangent, 
samplerCube inputTexture,
vec3 inputView, 
vec3 inputTangent, 
vec3 inputBitangent, 
vec3 inputNormal, 
vec2 filteringInfo,
vec2 noiseInput 
)
{vec3 V=inputView;vec3 N=inputNormal;vec3 T=inputTangent;vec3 B=inputBitangent;vec3 R=reflect(-V,N);if (alphaTangent==0. && alphaBitangent==0.) {vec3 c=textureCube(inputTexture,R).rgb;
#if GAMMA_INPUT
c=toLinearSpace(c);
#endif
return c;}
vec3 result=vec3(0.);float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float effectiveDim=dim0*sqrt(alphaTangent*alphaBitangent);float omegaP=(4.*PI)/(6.*effectiveDim*effectiveDim);const float noiseScale=clamp(log2(float(NUM_SAMPLES))/12.0f,0.0f,1.0f);float weight=0.;
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{vec2 Xi=hammersley(i,NUM_SAMPLES);Xi=fract(Xi+noiseInput*mix(0.5f,0.015f,noiseScale)); 
vec3 H_tangent=hemisphereImportanceSampleDggxAnisotropic(Xi,alphaTangent,alphaBitangent);vec3 H=normalize(H_tangent.x*T+H_tangent.y*B+H_tangent.z*N);vec3 L=normalize(2.0*dot(V,H)*H-V);float NoH=max(dot(N,H),0.001);float VoH=max(dot(V,H),0.001);float NoL=max(dot(N,L),0.001);if (NoL>0.) {float pdf_inversed=4./normalDistributionFunction_BurleyGGX_Anisotropic(
H_tangent.z,H_tangent.x,H_tangent.y,vec2(alphaTangent,alphaBitangent)
);float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(float(l),0.0,maxLevel);weight+=NoL;vec3 c=textureCubeLodEXT(inputTexture,L,mipLevel).rgb;
#if GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c*NoL;}}
result=result/weight;return result;}
#endif
#endif
#endif
`;S.IncludesShadersStore[cE]||(S.IncludesShadersStore[cE]=KU);const uE="pbrDirectLightingFunctions",JU=`#define CLEARCOATREFLECTANCE90 1.0
struct lightingInfo
{vec3 diffuse;
#ifdef SS_TRANSLUCENCY
vec3 diffuseTransmission;
#endif
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef CLEARCOAT
vec4 clearCoat;
#endif
#ifdef SHEEN
vec3 sheen;
#endif
};float adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance) {
#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)
float lightRoughness=lightRadius/lightDistance;float totalRoughness=saturate(lightRoughness+roughness);return totalRoughness;
#else
return roughness;
#endif
}
vec3 computeHemisphericDiffuseLighting(preLightingInfo info,vec3 lightColor,vec3 groundColor) {return mix(groundColor,lightColor,info.NdotL);}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
vec3 computeAreaDiffuseLighting(preLightingInfo info,vec3 lightColor) {return info.areaLightDiffuse*lightColor;}
#endif
vec3 computeDiffuseLighting(preLightingInfo info,vec3 lightColor) {vec3 diffuseTerm=vec3(1.0/PI);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_LEGACY
diffuseTerm=vec3(diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
diffuseTerm=vec3(diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.diffuseRoughness));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
vec3 clampedAlbedo=clamp(info.surfaceAlbedo,vec3(0.1),vec3(1.0));diffuseTerm=diffuseBRDF_EON(clampedAlbedo,info.diffuseRoughness,info.NdotL,info.NdotV,info.LdotV);diffuseTerm/=clampedAlbedo;
#endif
return diffuseTerm*info.attenuation*info.NdotL*lightColor;}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix,vec3 posW){vec4 strq=textureProjectionMatrix*vec4(posW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return toLinearSpace(textureColor);}
#ifdef SS_TRANSLUCENCY
vec3 computeDiffuseTransmittedLighting(preLightingInfo info,vec3 lightColor,vec3 transmittance) {vec3 transmittanceNdotL=vec3(0.);float NdotL=absEps(info.NdotLUnclamped);
#ifndef SS_TRANSLUCENCY_LEGACY
if (info.NdotLUnclamped<0.0) {
#endif
float wrapNdotL=computeWrappedDiffuseNdotL(NdotL,0.02);float trAdapt=step(0.,info.NdotLUnclamped);transmittanceNdotL=mix(transmittance*wrapNdotL,vec3(wrapNdotL),trAdapt);
#ifndef SS_TRANSLUCENCY_LEGACY
}
vec3 diffuseTerm=vec3(1.0/PI);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_LEGACY
diffuseTerm=vec3(diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
diffuseTerm=vec3(diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.diffuseRoughness));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
vec3 clampedAlbedo=clamp(info.surfaceAlbedo,vec3(0.1),vec3(1.0));diffuseTerm=diffuseBRDF_EON(clampedAlbedo,info.diffuseRoughness,info.NdotL,info.NdotV,info.LdotV);diffuseTerm/=clampedAlbedo;
#endif
#else
float diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);
#endif
return diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;}
#endif
#ifdef SPECULARTERM
vec3 computeSpecularLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 fresnel,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);
#else
float smithVisibility=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);
#endif
vec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
vec3 computeAreaSpecularLighting(preLightingInfo info,vec3 specularColor,vec3 reflectance0,vec3 reflectance90) {vec3 fresnel=specularColor*info.areaLightFresnel.x*reflectance0+( vec3( 1.0 )-specularColor )*info.areaLightFresnel.y*reflectance90;return specularColor*fresnel*info.areaLightSpecular;}
#endif
#endif
#if defined(ANISOTROPIC) && defined(ANISOTROPIC_OPENPBR)
vec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float TdotH=dot(T,info.H);float BdotH=dot(B,info.H);float TdotV=dot(T,V);float BdotV=dot(B,V);float TdotL=dot(T,info.L);float BdotL=dot(B,info.L);float alphaG=convertRoughnessToAverageSlope(info.roughness);vec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,square(geometricRoughnessFactor));float distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);float smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);vec3 specTerm=vec3(distribution*smithVisibility);return specTerm*info.attenuation*info.NdotL*lightColor;}
#elif defined(ANISOTROPIC)
vec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float TdotH=dot(T,info.H);float BdotH=dot(B,info.H);float TdotV=dot(T,V);float BdotV=dot(B,V);float TdotL=dot(T,info.L);float BdotL=dot(B,info.L);float alphaG=convertRoughnessToAverageSlope(info.roughness);vec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,square(geometricRoughnessFactor));vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
float distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);float smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);vec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#ifdef CLEARCOAT
vec4 computeClearCoatLighting(preLightingInfo info,vec3 Ncc,float geometricRoughnessFactor,float clearCoatIntensity,vec3 lightColor) {float NccdotL=saturateEps(dot(Ncc,info.L));float NccdotH=saturateEps(dot(Ncc,info.H));float clearCoatRoughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(clearCoatRoughness);float fresnel=fresnelSchlickGGX(info.VdotH,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnel*=clearCoatIntensity;float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);float kelemenVisibility=visibility_Kelemen(info.VdotH);float clearCoatTerm=fresnel*distribution*kelemenVisibility;return vec4(
clearCoatTerm*info.attenuation*NccdotL*lightColor,
1.0-fresnel
);}
vec3 computeClearCoatLightingAbsorption(float NdotVRefract,vec3 L,vec3 Ncc,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 LRefract=-refract(L,Ncc,vClearCoatRefractionParams.y);float NdotLRefract=saturateEps(dot(Ncc,LRefract));vec3 absorption=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);return absorption;}
#endif
#ifdef SHEEN
vec3 computeSheenLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);float fresnel=1.;float distribution=normalDistributionFunction_CharlieSheen(NdotH,alphaG);/*#ifdef SHEEN_SOFTER
float visibility=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);
#else */
float visibility=visibility_Ashikhmin(info.NdotL,info.NdotV);/* #endif */
float sheenTerm=fresnel*distribution*visibility;return sheenTerm*info.attenuation*info.NdotL*lightColor;}
#endif
`;S.IncludesShadersStore[uE]||(S.IncludesShadersStore[uE]=JU);const hE="pbrIBLFunctions",ek=`#if defined(REFLECTION) || defined(SS_REFRACTION)
float getLodFromAlphaG(float cubeMapDimensionPixels,float microsurfaceAverageSlope) {float microsurfaceAverageSlopeTexels=cubeMapDimensionPixels*microsurfaceAverageSlope;float lod=log2(microsurfaceAverageSlopeTexels);return lod;}
float getLinearLodFromRoughness(float cubeMapDimensionPixels,float roughness) {float lod=log2(cubeMapDimensionPixels)*roughness;return lod;}
#endif
#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)
float environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {float temp=NdotVUnclamped+ambientOcclusion;return saturate(square(temp)-1.0+ambientOcclusion);}
#endif
#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)
float environmentHorizonOcclusion(vec3 view,vec3 normal,vec3 geometricNormal) {vec3 reflection=reflect(view,normal);float temp=saturate(1.0+1.1*dot(reflection,geometricNormal));return square(temp);}
#endif
#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)
#define UNPACK_LOD(x) (1.0-x)*255.0
float getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {float microsurfaceAverageSlope=alphaG;microsurfaceAverageSlope*=sqrt(abs(NdotV));return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);}
#endif
`;S.IncludesShadersStore[hE]||(S.IncludesShadersStore[hE]=ek);const dE="pbrBlockAlbedoOpacity",tk=`struct albedoOpacityOutParams
{vec3 surfaceAlbedo;float alpha;};
#define pbr_inline
albedoOpacityOutParams albedoOpacityBlock(
in vec4 vAlbedoColor
#ifdef ALBEDO
,in vec4 albedoTexture
,in vec2 albedoInfos
#endif
,in float baseWeight
#ifdef BASE_WEIGHT
,in vec4 baseWeightTexture
,in vec2 vBaseWeightInfos
#endif
#ifdef OPACITY
,in vec4 opacityMap
,in vec2 vOpacityInfos
#endif
#ifdef DETAIL
,in vec4 detailColor
,in vec4 vDetailInfos
#endif
#ifdef DECAL
,in vec4 decalColor
,in vec4 vDecalInfos
#endif
)
{albedoOpacityOutParams outParams;vec3 surfaceAlbedo=vAlbedoColor.rgb;float alpha=vAlbedoColor.a;
#ifdef ALBEDO
#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)
alpha*=albedoTexture.a;
#endif
#ifdef GAMMAALBEDO
surfaceAlbedo*=toLinearSpace(albedoTexture.rgb);
#else
surfaceAlbedo*=albedoTexture.rgb;
#endif
surfaceAlbedo*=albedoInfos.y;
#endif
#ifndef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
surfaceAlbedo*=vColor.rgb;
#endif
#ifdef DETAIL
float detailAlbedo=2.0*mix(0.5,detailColor.r,vDetailInfos.y);surfaceAlbedo.rgb=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; 
#endif
#ifdef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALBEDO
surfaceAlbedo*=baseWeight;
#ifdef BASE_WEIGHT
surfaceAlbedo*=baseWeightTexture.r;
#endif
#ifdef OPACITY
#ifdef OPACITYRGB
alpha=getLuminance(opacityMap.rgb);
#else
alpha*=opacityMap.a;
#endif
alpha*=vOpacityInfos.y;
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=vColor.a;
#endif
#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)
#ifdef ALPHATEST
#if DEBUGMODE != 88
if (alpha<ALPHATESTVALUE)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
#endif
outParams.surfaceAlbedo=surfaceAlbedo;outParams.alpha=alpha;return outParams;}
`;S.IncludesShadersStore[dE]||(S.IncludesShadersStore[dE]=tk);const fE="pbrBlockReflectivity",ik=`struct reflectivityOutParams
{float microSurface;float roughness;float diffuseRoughness;float reflectanceF0;vec3 reflectanceF90;vec3 colorReflectanceF0;vec3 colorReflectanceF90;
#ifdef METALLICWORKFLOW
vec3 surfaceAlbedo;float metallic;float specularWeight;vec3 dielectricColorF0;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
vec3 ambientOcclusionColor;
#endif
#if DEBUGMODE>0
#ifdef METALLICWORKFLOW
#ifdef REFLECTIVITY
vec4 surfaceMetallicColorMap;
#endif
vec3 metallicF0;
#else
#ifdef REFLECTIVITY
vec4 surfaceReflectivityColorMap;
#endif
#endif
#endif
};
#define pbr_inline
reflectivityOutParams reflectivityBlock(
in vec4 reflectivityColor
#ifdef METALLICWORKFLOW
,in vec3 surfaceAlbedo
,in vec4 metallicReflectanceFactors
#endif
,in float baseDiffuseRoughness
#ifdef BASE_DIFFUSE_ROUGHNESS
,in float baseDiffuseRoughnessTexture
,in vec2 baseDiffuseRoughnessInfos
#endif
#ifdef REFLECTIVITY
,in vec3 reflectivityInfos
,in vec4 surfaceMetallicOrReflectivityColorMap
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
,in vec3 ambientOcclusionColorIn
#endif
#ifdef MICROSURFACEMAP
,in vec4 microSurfaceTexel
#endif
#ifdef DETAIL
,in vec4 detailColor
,in vec4 vDetailInfos
#endif
)
{reflectivityOutParams outParams;float microSurface=reflectivityColor.a;vec3 surfaceReflectivityColor=reflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec2 metallicRoughness=surfaceReflectivityColor.rg;float ior=surfaceReflectivityColor.b;
#ifdef REFLECTIVITY
#if DEBUGMODE>0
outParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef AOSTOREINMETALMAPRED
vec3 aoStoreInMetalMap=vec3(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);
#endif
#ifdef METALLNESSSTOREINMETALMAPBLUE
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;
#else
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;
#endif
#ifdef ROUGHNESSSTOREINMETALMAPALPHA
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;
#else
#ifdef ROUGHNESSSTOREINMETALMAPGREEN
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;
#endif
#endif
#endif
#ifdef DETAIL
float detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);float loLerp=mix(0.,metallicRoughness.g,detailRoughness*2.);float hiLerp=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));
#endif
#ifdef MICROSURFACEMAP
metallicRoughness.g*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS
microSurface=1.0-metallicRoughness.g;vec3 baseColor=surfaceAlbedo;outParams.metallic=metallicRoughness.r;outParams.specularWeight=metallicReflectanceFactors.a;float dielectricF0=reflectivityColor.a*outParams.specularWeight;surfaceReflectivityColor=metallicReflectanceFactors.rgb;
#if DEBUGMODE>0
outParams.metallicF0=vec3(dielectricF0)*surfaceReflectivityColor;
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
outParams.surfaceAlbedo=baseColor.rgb*(vec3(1.0)-vec3(dielectricF0)*surfaceReflectivityColor)*(1.0-outParams.metallic);
#else
outParams.surfaceAlbedo=baseColor.rgb;
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
{vec3 reflectivityColor=mix(dielectricF0*surfaceReflectivityColor,baseColor.rgb,outParams.metallic);outParams.reflectanceF0=max(reflectivityColor.r,max(reflectivityColor.g,reflectivityColor.b));}
#else
#if DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_GLTF
float maxF0=max(surfaceReflectivityColor.r,max(surfaceReflectivityColor.g,surfaceReflectivityColor.b));outParams.reflectanceF0=mix(dielectricF0*maxF0,1.0,outParams.metallic);
#else
outParams.reflectanceF0=mix(dielectricF0,1.0,outParams.metallic);
#endif
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
outParams.reflectanceF90=vec3(outParams.specularWeight);float f90Scale=1.0;
#else
float f90Scale=clamp(2.0*(ior-1.0),0.0,1.0);outParams.reflectanceF90=vec3(mix(outParams.specularWeight*f90Scale,1.0,outParams.metallic));
#endif
outParams.dielectricColorF0=vec3(dielectricF0*surfaceReflectivityColor);vec3 metallicColorF0=baseColor.rgb;outParams.colorReflectanceF0=mix(outParams.dielectricColorF0,metallicColorF0,outParams.metallic);
#if (DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_OPENPBR)
vec3 dielectricColorF90=surfaceReflectivityColor*vec3(outParams.specularWeight)*vec3(f90Scale);
#else
vec3 dielectricColorF90=vec3(outParams.specularWeight*f90Scale);
#endif
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
vec3 conductorColorF90=surfaceReflectivityColor;
#else
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
vec3 conductorColorF90=outParams.reflectanceF90;
#else
vec3 conductorColorF90=vec3(1.0);
#endif
#endif
outParams.colorReflectanceF90=mix(dielectricColorF90,conductorColorF90,outParams.metallic);
#else
#ifdef REFLECTIVITY
surfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;
#if DEBUGMODE>0
outParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef MICROSURFACEFROMREFLECTIVITYMAP
microSurface*=surfaceMetallicOrReflectivityColorMap.a;microSurface*=reflectivityInfos.z;
#else
#ifdef MICROSURFACEAUTOMATIC
microSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);
#endif
#ifdef MICROSURFACEMAP
microSurface*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE
#endif
#endif
outParams.colorReflectanceF0=surfaceReflectivityColor;outParams.reflectanceF0=max(surfaceReflectivityColor.r,max(surfaceReflectivityColor.g,surfaceReflectivityColor.b));outParams.reflectanceF90=vec3(1.0);
#if (DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_OPENPBR)
outParams.colorReflectanceF90=surfaceReflectivityColor;
#else
outParams.colorReflectanceF90=vec3(1.0);
#endif
#endif
microSurface=saturate(microSurface);float roughness=1.-microSurface;float diffuseRoughness=baseDiffuseRoughness;
#ifdef BASE_DIFFUSE_ROUGHNESS
diffuseRoughness*=baseDiffuseRoughnessTexture*baseDiffuseRoughnessInfos.y;
#endif
outParams.microSurface=microSurface;outParams.roughness=roughness;outParams.diffuseRoughness=diffuseRoughness;return outParams;}
`;S.IncludesShadersStore[fE]||(S.IncludesShadersStore[fE]=ik);const pE="pbrBlockAmbientOcclusion",rk=`struct ambientOcclusionOutParams
{vec3 ambientOcclusionColor;
#if DEBUGMODE>0 && defined(AMBIENT)
vec3 ambientOcclusionColorMap;
#endif
};ambientOcclusionOutParams ambientOcclusionBlock(
#ifdef AMBIENT
in vec3 ambientOcclusionColorMap_,
in vec4 vAmbientInfos
#endif
)
{ambientOcclusionOutParams outParams;vec3 ambientOcclusionColor=vec3(1.,1.,1.);
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*vAmbientInfos.y;
#ifdef AMBIENTINGRAYSCALE
ambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);
#endif
ambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);
#if DEBUGMODE>0
outParams.ambientOcclusionColorMap=ambientOcclusionColorMap;
#endif
#endif
outParams.ambientOcclusionColor=ambientOcclusionColor;return outParams;}
`;S.IncludesShadersStore[pE]||(S.IncludesShadersStore[pE]=rk);const mE="pbrBlockAlphaFresnel",sk=`#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
struct alphaFresnelOutParams
{float alpha;};
#define pbr_inline
alphaFresnelOutParams alphaFresnelBlock(
in vec3 normalW,
in vec3 viewDirectionW,
in float alpha,
in float microSurface
)
{alphaFresnelOutParams outParams;float opacityPerceptual=alpha;
#ifdef LINEARALPHAFRESNEL
float opacity0=opacityPerceptual;
#else
float opacity0=opacityPerceptual*opacityPerceptual;
#endif
float opacity90=fresnelGrazingReflectance(opacity0);vec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;
#ifdef ALPHATEST
if (outParams.alpha<ALPHATESTVALUE)
discard;
#ifndef ALPHABLEND
outParams.alpha=1.0;
#endif
#endif
return outParams;}
#endif
#endif
`;S.IncludesShadersStore[mE]||(S.IncludesShadersStore[mE]=sk);const _E="pbrBlockAnisotropic",nk=`#ifdef ANISOTROPIC
struct anisotropicOutParams
{float anisotropy;vec3 anisotropicTangent;vec3 anisotropicBitangent;vec3 anisotropicNormal;
#if DEBUGMODE>0 && defined(ANISOTROPIC_TEXTURE)
vec3 anisotropyMapData;
#endif
};
#define pbr_inline
anisotropicOutParams anisotropicBlock(
in vec3 vAnisotropy,
in float roughness,
#ifdef ANISOTROPIC_TEXTURE
in vec3 anisotropyMapData,
#endif
in mat3 TBN,
in vec3 normalW,
in vec3 viewDirectionW
)
{anisotropicOutParams outParams;float anisotropy=vAnisotropy.b;vec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);
#ifdef ANISOTROPIC_TEXTURE
anisotropy*=anisotropyMapData.b;
#if DEBUGMODE>0
outParams.anisotropyMapData=anisotropyMapData;
#endif
anisotropyMapData.rg=anisotropyMapData.rg*2.0-1.0;
#ifdef ANISOTROPIC_LEGACY
anisotropyDirection.rg*=anisotropyMapData.rg;
#else
anisotropyDirection.xy=mat2(anisotropyDirection.x,anisotropyDirection.y,-anisotropyDirection.y,anisotropyDirection.x)*normalize(anisotropyMapData.rg);
#endif
#endif
mat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));vec3 anisotropicTangent=normalize(anisoTBN*anisotropyDirection);vec3 anisotropicBitangent=normalize(cross(anisoTBN[2],anisotropicTangent));outParams.anisotropy=anisotropy;outParams.anisotropicTangent=anisotropicTangent;outParams.anisotropicBitangent=anisotropicBitangent;outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy,roughness);return outParams;}
#endif
`;S.IncludesShadersStore[_E]||(S.IncludesShadersStore[_E]=nk);const gE="pbrBlockReflection",ak=`#ifdef REFLECTION
struct reflectionOutParams
{vec4 environmentRadiance;vec3 environmentIrradiance;
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords;
#else
vec2 reflectionCoords;
#endif
#ifdef SS_TRANSLUCENCY
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
vec3 irradianceVector;
#endif
#endif
#endif
};
#define pbr_inline
void createReflectionCoords(
in vec3 vPositionW,
in vec3 normalW,
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#ifdef REFLECTIONMAP_3D
out vec3 reflectionCoords
#else
out vec2 reflectionCoords
#endif
)
{
#ifdef ANISOTROPIC
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),anisotropicOut.anisotropicNormal);
#else
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
reflectionCoords=reflectionVector;
#else
reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
}
#define pbr_inline
#define inline
void sampleReflectionTexture(
in float alphaG,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
in float NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
in float roughness,
#endif
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
const vec3 reflectionCoords,
#else
in sampler2D reflectionSampler,
const vec2 reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
out vec4 environmentRadiance
)
{
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
float reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);
#else
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);
#endif
#ifdef LODBASEDMICROSFURACE
reflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
#ifdef LODINREFLECTIONALPHA
float automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);float requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);
#else
float requestedReflectionLOD=reflectionLOD;
#endif
#ifdef REALTIME_FILTERING
environmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);
#else
environmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#endif
#else
float lodReflectionNormalized=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;vec4 environmentMid=sampleReflection(reflectionSampler,reflectionCoords);if (lodReflectionNormalizedDoubled<1.0){environmentRadiance=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
environmentMid,
lodReflectionNormalizedDoubled
);} else {environmentRadiance=mix(
environmentMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
#ifdef RGBDREFLECTION
environmentRadiance.rgb=fromRGBD(environmentRadiance);
#endif
#ifdef GAMMAREFLECTION
environmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);
#endif
environmentRadiance.rgb*=vReflectionInfos.x;environmentRadiance.rgb*=vReflectionColor.rgb;}
#define pbr_inline
#define inline
reflectionOutParams reflectionBlock(
in vec3 vPositionW
,in vec3 normalW
,in float alphaG
,in vec3 vReflectionMicrosurfaceInfos
,in vec2 vReflectionInfos
,in vec3 vReflectionColor
#ifdef ANISOTROPIC
,in anisotropicOutParams anisotropicOut
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,in float NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,in float roughness
#endif
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSampler
#else
,in sampler2D reflectionSampler
#endif
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,in vec3 vEnvironmentIrradiance
#endif
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
,in mat4 reflectionMatrix
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,in samplerCube irradianceSampler
#else
,in sampler2D irradianceSampler
#endif
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
,in vec3 reflectionDominantDirection
#endif
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSamplerLow
,in samplerCube reflectionSamplerHigh
#else
,in sampler2D reflectionSamplerLow
,in sampler2D reflectionSamplerHigh
#endif
#endif
#ifdef REALTIME_FILTERING
,in vec2 vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,in sampler2D icdfSampler
#endif
#endif
,in vec3 viewDirectionW
,in float diffuseRoughness
,in vec3 surfaceAlbedo
)
{reflectionOutParams outParams;vec4 environmentRadiance=vec4(0.,0.,0.,0.);
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=vec3(0.);
#else
vec2 reflectionCoords=vec2(0.);
#endif
createReflectionCoords(
vPositionW,
normalW,
#ifdef ANISOTROPIC
anisotropicOut,
#endif
reflectionCoords
);sampleReflectionTexture(
alphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
roughness,
#endif
#ifdef REFLECTIONMAP_3D
reflectionSampler,
reflectionCoords,
#else
reflectionSampler,
reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentRadiance
);vec3 environmentIrradiance=vec3(0.,0.,0.);
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
#ifdef ANISOTROPIC
vec3 irradianceVector=vec3(reflectionMatrix*vec4(anisotropicOut.anisotropicNormal,0)).xyz;
#else
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#endif
vec3 irradianceView=vec3(reflectionMatrix*vec4(viewDirectionW,0)).xyz;
#if !defined(USE_IRRADIANCE_DOMINANT_DIRECTION) && !defined(REALTIME_FILTERING)
#if BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LAMBERT && BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LEGACY
float NdotV=max(dot(normalW,viewDirectionW),0.0);irradianceVector=mix(irradianceVector,irradianceView,(0.5*(1.0-NdotV))*diffuseRoughness);
#endif
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
environmentIrradiance=vEnvironmentIrradiance;
#else
#if defined(REALTIME_FILTERING)
environmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo,diffuseRoughness,surfaceAlbedo,irradianceView
#ifdef IBL_CDF_FILTERING
,icdfSampler
#endif
);
#else
environmentIrradiance=computeEnvironmentIrradiance(irradianceVector);
#endif
#ifdef SS_TRANSLUCENCY
outParams.irradianceVector=irradianceVector;
#endif
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
vec4 environmentIrradiance4=sampleReflection(irradianceSampler,irradianceVector);
#else
vec4 environmentIrradiance4=sampleReflection(irradianceSampler,reflectionCoords);
#endif
environmentIrradiance=environmentIrradiance4.rgb;
#ifdef RGBDREFLECTION
environmentIrradiance.rgb=fromRGBD(environmentIrradiance4);
#endif
#ifdef GAMMAREFLECTION
environmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);
#endif
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
vec3 Ls=normalize(reflectionDominantDirection);float NoL=dot(irradianceVector,Ls);float NoV=dot(irradianceVector,irradianceView);vec3 diffuseRoughnessTerm=vec3(1.0);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
float LoV=dot (Ls,irradianceView);float mag=length(reflectionDominantDirection)*2.0;vec3 clampedAlbedo=clamp(surfaceAlbedo,vec3(0.1),vec3(1.0));diffuseRoughnessTerm=diffuseBRDF_EON(clampedAlbedo,diffuseRoughness,NoL,NoV,LoV)*PI;diffuseRoughnessTerm=diffuseRoughnessTerm/clampedAlbedo;diffuseRoughnessTerm=mix(vec3(1.0),diffuseRoughnessTerm,sqrt(clamp(mag*NoV,0.0,1.0)));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
vec3 H=(irradianceView+Ls)*0.5;float VoH=dot(irradianceView,H);diffuseRoughnessTerm=vec3(diffuseBRDF_Burley(NoL,NoV,VoH,diffuseRoughness)*PI);
#endif
environmentIrradiance=environmentIrradiance.rgb*diffuseRoughnessTerm;
#endif
#endif
environmentIrradiance*=vReflectionColor.rgb*vReflectionInfos.x;
#ifdef MIX_IBL_RADIANCE_WITH_IRRADIANCE
outParams.environmentRadiance=vec4(mix(environmentRadiance.rgb,environmentIrradiance,alphaG),environmentRadiance.a);
#else
outParams.environmentRadiance=environmentRadiance;
#endif
outParams.environmentIrradiance=environmentIrradiance;outParams.reflectionCoords=reflectionCoords;return outParams;}
#endif
`;S.IncludesShadersStore[gE]||(S.IncludesShadersStore[gE]=ak);const SE="pbrBlockSheen",ok=`#ifdef SHEEN
struct sheenOutParams
{float sheenIntensity;vec3 sheenColor;float sheenRoughness;
#ifdef SHEEN_LINKWITHALBEDO
vec3 surfaceAlbedo;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
float sheenAlbedoScaling;
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
vec3 finalSheenRadianceScaled;
#endif
#if DEBUGMODE>0
#ifdef SHEEN_TEXTURE
vec4 sheenMapData;
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
vec3 sheenEnvironmentReflectance;
#endif
#endif
};
#define pbr_inline
#define inline
sheenOutParams sheenBlock(
in vec4 vSheenColor
#ifdef SHEEN_ROUGHNESS
,in float vSheenRoughness
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
,in vec4 sheenMapRoughnessData
#endif
#endif
,in float roughness
#ifdef SHEEN_TEXTURE
,in vec4 sheenMapData
,in float sheenMapLevel
#endif
,in float reflectance
#ifdef SHEEN_LINKWITHALBEDO
,in vec3 baseColor
,in vec3 surfaceAlbedo
#endif
#ifdef ENVIRONMENTBRDF
,in float NdotV
,in vec3 environmentBrdf
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,in vec2 AARoughnessFactors
,in vec3 vReflectionMicrosurfaceInfos
,in vec2 vReflectionInfos
,in vec3 vReflectionColor
,in vec4 vLightingIntensity
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSampler
,in vec3 reflectionCoords
#else
,in sampler2D reflectionSampler
,in vec2 reflectionCoords
#endif
,in float NdotVUnclamped
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSamplerLow
,in samplerCube reflectionSamplerHigh
#else
,in sampler2D reflectionSamplerLow
,in sampler2D reflectionSamplerHigh
#endif
#endif
#ifdef REALTIME_FILTERING
,in vec2 vReflectionFilteringInfo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
,in float seo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
,in float eho
#endif
#endif
)
{sheenOutParams outParams;float sheenIntensity=vSheenColor.a;
#ifdef SHEEN_TEXTURE
#if DEBUGMODE>0
outParams.sheenMapData=sheenMapData;
#endif
#endif
#ifdef SHEEN_LINKWITHALBEDO
float sheenFactor=pow5(1.0-sheenIntensity);vec3 sheenColor=baseColor.rgb*(1.0-sheenFactor);float sheenRoughness=sheenIntensity;outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#else
vec3 sheenColor=vSheenColor.rgb;
#ifdef SHEEN_TEXTURE
#ifdef SHEEN_GAMMATEXTURE
sheenColor.rgb*=toLinearSpace(sheenMapData.rgb);
#else
sheenColor.rgb*=sheenMapData.rgb;
#endif
sheenColor.rgb*=sheenMapLevel;
#endif
#ifdef SHEEN_ROUGHNESS
float sheenRoughness=vSheenRoughness;
#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE
#if defined(SHEEN_TEXTURE)
sheenRoughness*=sheenMapData.a;
#endif
#elif defined(SHEEN_TEXTURE_ROUGHNESS)
sheenRoughness*=sheenMapRoughnessData.a;
#endif
#else
float sheenRoughness=roughness;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#endif
#if !defined(SHEEN_ALBEDOSCALING)
sheenIntensity*=(1.-reflectance);
#endif
sheenColor*=sheenIntensity;
#endif
#ifdef ENVIRONMENTBRDF
/*#ifdef SHEEN_SOFTER
vec3 environmentSheenBrdf=vec3(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));
#else*/
#ifdef SHEEN_ROUGHNESS
vec3 environmentSheenBrdf=getBRDFLookup(NdotV,sheenRoughness);
#else
vec3 environmentSheenBrdf=environmentBrdf;
#endif
/*#endif*/
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
float sheenAlphaG=convertRoughnessToAverageSlope(sheenRoughness);
#ifdef SPECULARAA
sheenAlphaG+=AARoughnessFactors.y;
#endif
vec4 environmentSheenRadiance=vec4(0.,0.,0.,0.);sampleReflectionTexture(
sheenAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
sheenRoughness,
#endif
reflectionSampler,
reflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentSheenRadiance
);vec3 sheenEnvironmentReflectance=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
sheenEnvironmentReflectance*=seo;
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
sheenEnvironmentReflectance*=eho;
#endif
#if DEBUGMODE>0
outParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;
#endif
outParams.finalSheenRadianceScaled=
environmentSheenRadiance.rgb *
sheenEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
outParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;
#endif
outParams.sheenIntensity=sheenIntensity;outParams.sheenColor=sheenColor;outParams.sheenRoughness=sheenRoughness;return outParams;}
#endif
`;S.IncludesShadersStore[SE]||(S.IncludesShadersStore[SE]=ok);const vE="pbrBlockClearcoat",lk=`struct clearcoatOutParams
{vec3 specularEnvironmentR0;float conservationFactor;vec3 clearCoatNormalW;vec2 clearCoatAARoughnessFactors;float clearCoatIntensity;float clearCoatRoughness;
#ifdef REFLECTION
vec3 finalClearCoatRadianceScaled;
#endif
#ifdef CLEARCOAT_TINT
vec3 absorption;float clearCoatNdotVRefract;vec3 clearCoatColor;float clearCoatThickness;
#endif
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
vec3 energyConservationFactorClearCoat;
#endif
#if DEBUGMODE>0
#ifdef CLEARCOAT_BUMP
mat3 TBNClearCoat;
#endif
#ifdef CLEARCOAT_TEXTURE
vec2 clearCoatMapData;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
vec4 clearCoatTintMapData;
#endif
#ifdef REFLECTION
vec4 environmentClearCoatRadiance;vec3 clearCoatEnvironmentReflectance;
#endif
float clearCoatNdotV;
#endif
};
#ifdef CLEARCOAT
#define pbr_inline
#define inline
clearcoatOutParams clearcoatBlock(
in vec3 vPositionW
,in vec3 geometricNormalW
,in vec3 viewDirectionW
,in vec2 vClearCoatParams
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
,in vec4 clearCoatMapRoughnessData
#endif
,in vec3 specularEnvironmentR0
#ifdef CLEARCOAT_TEXTURE
,in vec2 clearCoatMapData
#endif
#ifdef CLEARCOAT_TINT
,in vec4 vClearCoatTintParams
,in float clearCoatColorAtDistance
,in vec4 vClearCoatRefractionParams
#ifdef CLEARCOAT_TINT_TEXTURE
,in vec4 clearCoatTintMapData
#endif
#endif
#ifdef CLEARCOAT_BUMP
,in vec2 vClearCoatBumpInfos
,in vec4 clearCoatBumpMapData
,in vec2 vClearCoatBumpUV
#if defined(TANGENT) && defined(NORMAL)
,in mat3 vTBN
#else
,in vec2 vClearCoatTangentSpaceParams
#endif
#ifdef OBJECTSPACE_NORMALMAP
,in mat4 normalMatrix
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
,in vec3 faceNormal
#endif
#ifdef REFLECTION
,in vec3 vReflectionMicrosurfaceInfos
,in vec2 vReflectionInfos
,in vec3 vReflectionColor
,in vec4 vLightingIntensity
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSampler
#else
,in sampler2D reflectionSampler
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSamplerLow
,in samplerCube reflectionSamplerHigh
#else
,in sampler2D reflectionSamplerLow
,in sampler2D reflectionSamplerHigh
#endif
#endif
#ifdef REALTIME_FILTERING
,in vec2 vReflectionFilteringInfo
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
,in float frontFacingMultiplier
#endif
)
{clearcoatOutParams outParams;float clearCoatIntensity=vClearCoatParams.x;float clearCoatRoughness=vClearCoatParams.y;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE
clearCoatRoughness*=clearCoatMapData.y;
#endif
#if DEBUGMODE>0
outParams.clearCoatMapData=clearCoatMapData;
#endif
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
clearCoatRoughness*=clearCoatMapRoughnessData.y;
#endif
outParams.clearCoatIntensity=clearCoatIntensity;outParams.clearCoatRoughness=clearCoatRoughness;
#ifdef CLEARCOAT_TINT
vec3 clearCoatColor=vClearCoatTintParams.rgb;float clearCoatThickness=vClearCoatTintParams.a;
#ifdef CLEARCOAT_TINT_TEXTURE
#ifdef CLEARCOAT_TINT_GAMMATEXTURE
clearCoatColor*=toLinearSpace(clearCoatTintMapData.rgb);
#else
clearCoatColor*=clearCoatTintMapData.rgb;
#endif
clearCoatThickness*=clearCoatTintMapData.a;
#if DEBUGMODE>0
outParams.clearCoatTintMapData=clearCoatTintMapData;
#endif
#endif
outParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);outParams.clearCoatThickness=clearCoatThickness;
#endif
#ifdef CLEARCOAT_REMAP_F0
vec3 specularEnvironmentR0Updated=getR0RemappedForClearCoat(specularEnvironmentR0);
#else
vec3 specularEnvironmentR0Updated=specularEnvironmentR0;
#endif
outParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);vec3 clearCoatNormalW=geometricNormalW;
#ifdef CLEARCOAT_BUMP
#ifdef NORMALXYSCALE
float clearCoatNormalScale=1.0;
#else
float clearCoatNormalScale=vClearCoatBumpInfos.y;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBNClearCoat=vTBN;
#else
vec2 TBNClearCoatUV=vClearCoatBumpUV*frontFacingMultiplier;mat3 TBNClearCoat=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);
#endif
#if DEBUGMODE>0
outParams.TBNClearCoat=TBNClearCoat;
#endif
#ifdef OBJECTSPACE_NORMALMAP
clearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);clearCoatNormalW=normalize(mat3(normalMatrix)*clearCoatNormalW);
#else
clearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
clearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
clearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;
#endif
outParams.clearCoatNormalW=clearCoatNormalW;outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);float clearCoatNdotVUnclamped=dot(clearCoatNormalW,viewDirectionW);float clearCoatNdotV=absEps(clearCoatNdotVUnclamped);
#if DEBUGMODE>0
outParams.clearCoatNdotV=clearCoatNdotV;
#endif
#ifdef CLEARCOAT_TINT
vec3 clearCoatVRefract=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));
#endif
#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))
vec3 environmentClearCoatBrdf=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);
#endif
#if defined(REFLECTION)
float clearCoatAlphaG=convertRoughnessToAverageSlope(clearCoatRoughness);
#ifdef SPECULARAA
clearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;
#endif
vec4 environmentClearCoatRadiance=vec4(0.,0.,0.,0.);vec3 clearCoatReflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),clearCoatNormalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
clearCoatReflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
vec3 clearCoatReflectionCoords=clearCoatReflectionVector;
#else
vec2 clearCoatReflectionCoords=clearCoatReflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
clearCoatReflectionCoords/=clearCoatReflectionVector.z;
#endif
clearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;
#endif
sampleReflectionTexture(
clearCoatAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
clearCoatNdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
clearCoatRoughness,
#endif
reflectionSampler,
clearCoatReflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentClearCoatRadiance
);
#if DEBUGMODE>0
outParams.environmentClearCoatRadiance=environmentClearCoatRadiance;
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 clearCoatEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(vClearCoatRefractionParams.x),environmentClearCoatBrdf);
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float clearCoatEho=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);clearCoatEnvironmentReflectance*=clearCoatEho;
#endif
#endif
#endif
#else
vec3 clearCoatEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV,vec3(1.),vec3(1.),sqrt(1.-clearCoatRoughness));
#endif
clearCoatEnvironmentReflectance*=clearCoatIntensity;
#if DEBUGMODE>0
outParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;
#endif
outParams.finalClearCoatRadianceScaled=
environmentClearCoatRadiance.rgb *
clearCoatEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(CLEARCOAT_TINT)
outParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);
#endif
float fresnelIBLClearCoat=fresnelSchlickGGX(clearCoatNdotV,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnelIBLClearCoat*=clearCoatIntensity;outParams.conservationFactor=(1.-fresnelIBLClearCoat);
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
outParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);
#endif
return outParams;}
#endif
`;S.IncludesShadersStore[vE]||(S.IncludesShadersStore[vE]=lk);const xE="pbrBlockIridescence",ck=`struct iridescenceOutParams
{float iridescenceIntensity;float iridescenceIOR;float iridescenceThickness;vec3 specularEnvironmentR0;};
#ifdef IRIDESCENCE
#define pbr_inline
#define inline
iridescenceOutParams iridescenceBlock(
in vec4 vIridescenceParams
,in float viewAngle
,in vec3 specularEnvironmentR0
#ifdef IRIDESCENCE_TEXTURE
,in vec2 iridescenceMapData
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
,in vec2 iridescenceThicknessMapData
#endif
#ifdef CLEARCOAT
,in float NdotVUnclamped
,in vec2 vClearCoatParams
#ifdef CLEARCOAT_TEXTURE
,in vec2 clearCoatMapData
#endif
#endif
)
{iridescenceOutParams outParams;float iridescenceIntensity=vIridescenceParams.x;float iridescenceIOR=vIridescenceParams.y;float iridescenceThicknessMin=vIridescenceParams.z;float iridescenceThicknessMax=vIridescenceParams.w;float iridescenceThicknessWeight=1.;
#ifdef IRIDESCENCE_TEXTURE
iridescenceIntensity*=iridescenceMapData.x;
#endif
#if defined(IRIDESCENCE_THICKNESS_TEXTURE)
iridescenceThicknessWeight=iridescenceThicknessMapData.g;
#endif
float iridescenceThickness=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);float topIor=1.; 
#ifdef CLEARCOAT
float clearCoatIntensity=vClearCoatParams.x;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#endif
topIor=mix(1.0,vClearCoatRefractionParams.w-1.,clearCoatIntensity);viewAngle=sqrt(1.0+square(1.0/topIor)*(square(NdotVUnclamped)-1.0));
#endif
vec3 iridescenceFresnel=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);outParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);outParams.iridescenceIntensity=iridescenceIntensity;outParams.iridescenceThickness=iridescenceThickness;outParams.iridescenceIOR=iridescenceIOR;return outParams;}
#endif
`;S.IncludesShadersStore[xE]||(S.IncludesShadersStore[xE]=ck);const EE="pbrBlockSubSurface",uk=`struct subSurfaceOutParams
{vec3 specularEnvironmentReflectance;
#ifdef SS_REFRACTION
vec3 finalRefraction;vec3 surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
float alpha;
#endif
float refractionOpacity;
#endif
#ifdef SS_TRANSLUCENCY
vec3 transmittance;float translucencyIntensity;
#ifdef REFLECTION
vec3 refractionIrradiance;
#endif
#endif
#if DEBUGMODE>0
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec4 thicknessMap;
#endif
#ifdef SS_REFRACTION
vec4 environmentRefraction;vec3 refractionTransmittance;
#endif
#endif
};
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#define pbr_inline
#define inline
vec4 sampleEnvironmentRefraction(
in float ior
,in float thickness
,in float refractionLOD
,in vec3 normalW
,in vec3 vPositionW
,in vec3 viewDirectionW
,in mat4 view
,in vec4 vRefractionInfos
,in mat4 refractionMatrix
,in vec4 vRefractionMicrosurfaceInfos
,in float alphaG
#ifdef SS_REFRACTIONMAP_3D
,in samplerCube refractionSampler
#ifndef LODBASEDMICROSFURACE
,in samplerCube refractionSamplerLow
,in samplerCube refractionSamplerHigh
#endif
#else
,in sampler2D refractionSampler
#ifndef LODBASEDMICROSFURACE
,in sampler2D refractionSamplerLow
,in sampler2D refractionSamplerHigh
#endif
#endif
#ifdef ANISOTROPIC
,in anisotropicOutParams anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,in vec2 vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,in vec3 refractionPosition
,in vec3 refractionSize
#endif
) {vec4 environmentRefraction=vec4(0.,0.,0.,0.);
#ifdef ANISOTROPIC
vec3 refractionVector=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,ior);
#else
vec3 refractionVector=refract(-viewDirectionW,normalW,ior);
#endif
#ifdef SS_REFRACTIONMAP_OPPOSITEZ
refractionVector.z*=-1.0;
#endif
#ifdef SS_REFRACTIONMAP_3D
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;vec3 refractionCoords=refractionVector;refractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));
#else
#ifdef SS_USE_THICKNESS_AS_DEPTH
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*thickness,1.0)));
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));
#endif
vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;
#endif
#ifdef LODBASEDMICROSFURACE
refractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;
#ifdef SS_LODINREFRACTIONALPHA
float automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);float requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);
#else
float requestedRefractionLOD=refractionLOD;
#endif
#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)
environmentRefraction=vec4(radiance(alphaG,refractionSampler,refractionCoords,vRefractionFilteringInfo),1.0);
#else
environmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD);
#endif
#else
float lodRefractionNormalized=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));float lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;vec4 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords);if (lodRefractionNormalizedDoubled<1.0){environmentRefraction=mix(
sampleRefraction(refractionSamplerHigh,refractionCoords),
environmentRefractionMid,
lodRefractionNormalizedDoubled
);} else {environmentRefraction=mix(
environmentRefractionMid,
sampleRefraction(refractionSamplerLow,refractionCoords),
lodRefractionNormalizedDoubled-1.0
);}
#endif
#ifdef SS_RGBDREFRACTION
environmentRefraction.rgb=fromRGBD(environmentRefraction);
#endif
#ifdef SS_GAMMAREFRACTION
environmentRefraction.rgb=toLinearSpace(environmentRefraction.rgb);
#endif
return environmentRefraction;}
#endif
#define pbr_inline
#define inline
subSurfaceOutParams subSurfaceBlock(
in vec3 vSubSurfaceIntensity
,in vec2 vThicknessParam
,in vec4 vTintColor
,in vec3 normalW
,in vec3 vSpecularEnvironmentReflectance
#ifdef SS_THICKNESSANDMASK_TEXTURE
,in vec4 thicknessMap
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
,in vec4 refractionIntensityMap
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
,in vec4 translucencyIntensityMap
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
,in mat4 reflectionMatrix
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,in vec3 irradianceVector_
#endif
#if defined(REALTIME_FILTERING)
,in samplerCube reflectionSampler
,in vec2 vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,in sampler2D icdfSampler
#endif
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,in samplerCube irradianceSampler
#else
,in sampler2D irradianceSampler
#endif
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
,in vec3 surfaceAlbedo
#endif
#ifdef SS_REFRACTION
,in vec3 vPositionW
,in vec3 viewDirectionW
,in mat4 view
,in vec4 vRefractionInfos
,in mat4 refractionMatrix
,in vec4 vRefractionMicrosurfaceInfos
,in vec4 vLightingIntensity
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
,in float alpha
#endif
#ifdef SS_LODINREFRACTIONALPHA
,in float NdotVUnclamped
#endif
#ifdef SS_LINEARSPECULARREFRACTION
,in float roughness
#endif
,in float alphaG
#ifdef SS_REFRACTIONMAP_3D
,in samplerCube refractionSampler
#ifndef LODBASEDMICROSFURACE
,in samplerCube refractionSamplerLow
,in samplerCube refractionSamplerHigh
#endif
#else
,in sampler2D refractionSampler
#ifndef LODBASEDMICROSFURACE
,in sampler2D refractionSamplerLow
,in sampler2D refractionSamplerHigh
#endif
#endif
#ifdef ANISOTROPIC
,in anisotropicOutParams anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,in vec2 vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,in vec3 refractionPosition
,in vec3 refractionSize
#endif
#ifdef SS_DISPERSION
,in float dispersion
#endif
#endif
#ifdef SS_TRANSLUCENCY
,in vec3 vDiffusionDistance
,in vec4 vTranslucencyColor
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
,in vec4 translucencyColorMap
#endif
#endif
)
{subSurfaceOutParams outParams;outParams.specularEnvironmentReflectance=vSpecularEnvironmentReflectance;
#ifdef SS_REFRACTION
float refractionIntensity=vSubSurfaceIntensity.x;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
refractionIntensity*=(1.0-alpha);outParams.alpha=1.0;
#endif
#endif
#ifdef SS_TRANSLUCENCY
float translucencyIntensity=vSubSurfaceIntensity.y;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
#ifdef SS_USE_GLTF_TEXTURES
float thickness=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;
#else
float thickness=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;
#endif
#if DEBUGMODE>0
outParams.thicknessMap=thicknessMap;
#endif
#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS)
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=thicknessMap.r;
#else
refractionIntensity*=thicknessMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS)
#ifdef SS_USE_GLTF_TEXTURES
translucencyIntensity*=thicknessMap.a;
#else
translucencyIntensity*=thicknessMap.b;
#endif
#endif
#else
float thickness=vThicknessParam.y;
#endif
#if defined(SS_REFRACTION) && defined(SS_REFRACTIONINTENSITY_TEXTURE)
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=refractionIntensityMap.r;
#else
refractionIntensity*=refractionIntensityMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCYINTENSITY_TEXTURE)
#ifdef SS_USE_GLTF_TEXTURES
translucencyIntensity*=translucencyIntensityMap.a;
#else
translucencyIntensity*=translucencyIntensityMap.b;
#endif
#endif
#ifdef SS_TRANSLUCENCY
thickness=maxEps(thickness);vec4 translucencyColor=vTranslucencyColor;
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
translucencyColor*=translucencyColorMap;
#endif
vec3 transmittance=transmittanceBRDF_Burley(translucencyColor.rgb,vDiffusionDistance,thickness);transmittance*=translucencyIntensity;outParams.transmittance=transmittance;outParams.translucencyIntensity=translucencyIntensity;
#endif
#ifdef SS_REFRACTION
vec4 environmentRefraction=vec4(0.,0.,0.,0.);
#ifdef SS_HAS_THICKNESS
float ior=vRefractionInfos.y;
#else
float ior=vRefractionMicrosurfaceInfos.w;
#endif
#ifdef SS_LODINREFRACTIONALPHA
float refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);
#elif defined(SS_LINEARSPECULARREFRACTION)
float refractionRoughness=alphaG;refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);
#else
float refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);
#endif
float refraction_ior=vRefractionInfos.y;
#ifdef SS_DISPERSION
float realIOR=1.0/refraction_ior;float iorDispersionSpread=0.04*dispersion*(realIOR-1.0);vec3 iors=vec3(1.0/(realIOR-iorDispersionSpread),refraction_ior,1.0/(realIOR+iorDispersionSpread));for (int i=0; i<3; i++) {refraction_ior=iors[i];
#endif
vec4 envSample=sampleEnvironmentRefraction(refraction_ior,thickness,refractionLOD,normalW,vPositionW,viewDirectionW,view,vRefractionInfos,refractionMatrix,vRefractionMicrosurfaceInfos,alphaG
#ifdef SS_REFRACTIONMAP_3D
,refractionSampler
#ifndef LODBASEDMICROSFURACE
,refractionSamplerLow
,refractionSamplerHigh
#endif
#else
,refractionSampler
#ifndef LODBASEDMICROSFURACE
,refractionSamplerLow
,refractionSamplerHigh
#endif
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,refractionPosition
,refractionSize
#endif
);
#ifdef SS_DISPERSION
environmentRefraction[i]=envSample[i];}
#else
environmentRefraction=envSample;
#endif
environmentRefraction.rgb*=vRefractionInfos.x;
#endif
#ifdef SS_REFRACTION
vec3 refractionTransmittance=vec3(refractionIntensity);
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,thickness);
#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)
float maxChannel=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);vec3 volumeAlbedo=saturate(maxChannel*surfaceAlbedo);environmentRefraction.rgb*=volumeAlbedo;
#else
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,vThicknessParam.y);
#endif
#ifdef SS_ALBEDOFORREFRACTIONTINT
environmentRefraction.rgb*=surfaceAlbedo.rgb;
#endif
outParams.surfaceAlbedo=surfaceAlbedo;outParams.refractionOpacity=1.-refractionIntensity;
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
outParams.surfaceAlbedo*=outParams.refractionOpacity;
#endif
#ifdef UNUSED_MULTIPLEBOUNCES
vec3 bounceSpecularEnvironmentReflectance=(2.0*vSpecularEnvironmentReflectance)/(1.0+vSpecularEnvironmentReflectance);outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,vSpecularEnvironmentReflectance,refractionIntensity);
#endif
#if DEBUGMODE>0
outParams.refractionTransmittance=refractionTransmittance;
#endif
outParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;outParams.finalRefraction*=vec3(1.0)-vSpecularEnvironmentReflectance;
#if DEBUGMODE>0
outParams.environmentRefraction=environmentRefraction;
#endif
#endif
#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)
#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#else
vec3 irradianceVector=irradianceVector_;
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP)
#if defined(REALTIME_FILTERING)
vec3 refractionIrradiance=irradiance(reflectionSampler,-irradianceVector,vReflectionFilteringInfo,0.0,surfaceAlbedo,irradianceVector
#ifdef IBL_CDF_FILTERING
,icdfSampler
#endif
);
#else
vec3 refractionIrradiance=computeEnvironmentIrradiance(-irradianceVector);
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
vec3 irradianceCoords=irradianceVector;
#else
vec2 irradianceCoords=irradianceVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
irradianceCoords/=irradianceVector.z;
#endif
irradianceCoords.y=1.0-irradianceCoords.y;
#endif
vec4 refractionIrradiance=sampleReflection(irradianceSampler,-irradianceCoords);
#ifdef RGBDREFLECTION
refractionIrradiance.rgb=fromRGBD(refractionIrradiance);
#endif
#ifdef GAMMAREFLECTION
refractionIrradiance.rgb=toLinearSpace(refractionIrradiance.rgb);
#endif
#else
vec4 refractionIrradiance=vec4(0.);
#endif
refractionIrradiance.rgb*=transmittance;
#ifdef SS_ALBEDOFORTRANSLUCENCYTINT
refractionIrradiance.rgb*=surfaceAlbedo.rgb;
#endif
outParams.refractionIrradiance=refractionIrradiance.rgb;
#endif
return outParams;}
#endif
`;S.IncludesShadersStore[EE]||(S.IncludesShadersStore[EE]=uk);const TE="pbrBlockReflectance0",hk=`float reflectanceF0=reflectivityOut.reflectanceF0;vec3 specularEnvironmentR0=reflectivityOut.colorReflectanceF0;vec3 specularEnvironmentR90=reflectivityOut.colorReflectanceF90;
#ifdef ALPHAFRESNEL
float reflectance90=fresnelGrazingReflectance(reflectanceF0);specularEnvironmentR90=specularEnvironmentR90*reflectance90;
#endif
`;S.IncludesShadersStore[TE]||(S.IncludesShadersStore[TE]=hk);const bE="pbrClusteredLightingFunctions",dk=`#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
#include<clusteredLightingFunctions>
#define inline
lightingInfo computeClusteredLighting(
sampler2D lightDataTexture,
sampler2D tileMaskTexture,
vec4 lightData,
ivec2 sliceRange,
vec3 V,
vec3 N,
vec3 posW,
vec3 surfaceAlbedo,
reflectivityOutParams reflectivityOut
#ifdef IRIDESCENCE
,float iridescenceIntensity
#endif
#ifdef SS_TRANSLUCENCY
,subSurfaceOutParams subSurfaceOut
#endif
#ifdef SPECULARTERM
,float AARoughnessFactor
#endif
#ifdef ANISOTROPIC
,anisotropicOutParams anisotropicOut
#endif
#ifdef SHEEN
,sheenOutParams sheenOut
#endif
#ifdef CLEARCOAT
,clearcoatOutParams clearcoatOut
#endif
) {float NdotV=absEps(dot(N,V));
#include<pbrBlockReflectance0>
#ifdef CLEARCOAT
specularEnvironmentR0=clearcoatOut.specularEnvironmentR0;
#endif
lightingInfo result;ivec2 tilePosition=ivec2(gl_FragCoord.xy*lightData.xy);int maskHeight=int(lightData.z);tilePosition.y=min(tilePosition.y,maskHeight-1);ivec2 batchRange=sliceRange/CLUSTLIGHT_BATCH;int batchOffset=batchRange.x*CLUSTLIGHT_BATCH;tilePosition.y+=maskHeight*batchRange.x;for (int i=batchRange.x; i<=batchRange.y; i+=1) {uint mask=uint(texelFetch(tileMaskTexture,tilePosition,0).r);tilePosition.y+=maskHeight;int maskOffset=max(sliceRange.x-batchOffset,0);int maskWidth=min(sliceRange.y-batchOffset+1,CLUSTLIGHT_BATCH);mask=extractBits(mask,maskOffset,maskWidth);while (mask != 0u) {uint bit=mask & -mask;mask ^= bit;int position=onlyBitPosition(bit);ClusteredLight light=getClusteredLight(lightDataTexture,batchOffset+maskOffset+position);preLightingInfo preInfo=computePointAndSpotPreLightingInfo(light.vLightData,V,N,posW);preInfo.NdotV=NdotV;preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light.vLightFalloff.x,light.vLightFalloff.y);if (light.vLightDirection.w>=0.0) {preInfo.attenuation*=computeDirectionalLightFalloff(light.vLightDirection.xyz,preInfo.L,light.vLightDirection.w,light.vLightData.w,light.vLightFalloff.z,light.vLightFalloff.w);}
preInfo.roughness=adjustRoughnessFromLightProperties(reflectivityOut.roughness,light.vLightSpecular.a,preInfo.lightDistance);preInfo.diffuseRoughness=reflectivityOut.diffuseRoughness;preInfo.surfaceAlbedo=surfaceAlbedo;
#ifdef IRIDESCENCE
preInfo.iridescenceIntensity=iridescenceIntensity;
#endif
lightingInfo info;
#ifdef SS_TRANSLUCENCY
#ifdef SS_TRANSLUCENCY_LEGACY
info.diffuse=computeDiffuseTransmittedLighting(preInfo,light.vLightDiffuse.rgb,subSurfaceOut.transmittance);info.diffuseTransmission=vec3(0);
#else
info.diffuse=computeDiffuseLighting(preInfo,light.vLightDiffuse.rgb)*(1.0-subSurfaceOut.translucencyIntensity);info.diffuseTransmission=computeDiffuseTransmittedLighting(preInfo,light.vLightDiffuse.rgb,subSurfaceOut.transmittance);
#endif
#else
info.diffuse=computeDiffuseLighting(preInfo,light.vLightDiffuse.rgb);
#endif
#ifdef SPECULARTERM
#if CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR
vec3 metalFresnel=reflectivityOut.specularWeight*getF82Specular(preInfo.VdotH,specularEnvironmentR0,reflectivityOut.colorReflectanceF90,reflectivityOut.roughness);vec3 dielectricFresnel=fresnelSchlickGGX(preInfo.VdotH,reflectivityOut.dielectricColorF0,reflectivityOut.colorReflectanceF90);vec3 coloredFresnel=mix(dielectricFresnel,metalFresnel,reflectivityOut.metallic);
#else
vec3 coloredFresnel=fresnelSchlickGGX(preInfo.VdotH,specularEnvironmentR0,reflectivityOut.colorReflectanceF90);
#endif
#ifndef LEGACY_SPECULAR_ENERGY_CONSERVATION
float NdotH=dot(N,preInfo.H);vec3 fresnel=fresnelSchlickGGX(NdotH,vec3(reflectanceF0),specularEnvironmentR90);info.diffuse*=(vec3(1.0)-fresnel);
#endif
#ifdef ANISOTROPIC
info.specular=computeAnisotropicSpecularLighting(preInfo,V,N,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactor,light.vLightDiffuse.rgb);
#else
info.specular=computeSpecularLighting(preInfo,N,specularEnvironmentR0,coloredFresnel,AARoughnessFactor,light.vLightDiffuse.rgb);
#endif
#endif
#ifdef SHEEN
#ifdef SHEEN_LINKWITHALBEDO
preInfo.roughness=sheenOut.sheenIntensity;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light.vLightSpecular.a,preInfo.lightDistance);
#endif
info.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactor,light.vLightDiffuse.rgb);
#endif
#ifdef CLEARCOAT
preInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light.vLightSpecular.a,preInfo.lightDistance);info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,light.vLightDiffuse.rgb);
#ifdef CLEARCOAT_TINT
float absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;
#ifdef SS_TRANSLUCENCY
info.diffuseTransmission*=absorption;
#endif
#ifdef SPECULARTERM
info.specular*=absorption;
#endif
#endif
info.diffuse*=info.clearCoat.w;
#ifdef SS_TRANSLUCENCY
info.diffuseTransmission*=info.clearCoat.w;
#endif
#ifdef SPECULARTERM
info.specular*=info.clearCoat.w;
#endif
#ifdef SHEEN
info.sheen*=info.clearCoat.w;
#endif
#endif
result.diffuse+=info.diffuse;
#ifdef SS_TRANSLUCENCY
result.diffuseTransmission+=info.diffuseTransmission;
#endif
#ifdef SPECULARTERM
result.specular+=info.specular;
#endif
#ifdef CLEARCOAT
result.clearCoat+=info.clearCoat;
#endif
#ifdef SHEEN
result.sheen+=info.sheen;
#endif
}
batchOffset+=CLUSTLIGHT_BATCH;}
return result;}
#endif
`;S.IncludesShadersStore[bE]||(S.IncludesShadersStore[bE]=dk);const CE="pbrBlockNormalGeometric",fk=`vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#endif
vec3 geometricNormalW=normalW;
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
geometricNormalW=gl_FrontFacing ? geometricNormalW : -geometricNormalW;
#endif
`;S.IncludesShadersStore[CE]||(S.IncludesShadersStore[CE]=fk);const yE="pbrBlockNormalFinal",pk=`#if defined(FORCENORMALFORWARD) && defined(NORMAL)
vec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#if defined(TWOSIDEDLIGHTING)
faceNormal=gl_FrontFacing ? faceNormal : -faceNormal;
#endif
normalW*=sign(dot(normalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
#if defined(MIRRORED)
normalW=gl_FrontFacing ? -normalW : normalW;
#else
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
#endif
`;S.IncludesShadersStore[yE]||(S.IncludesShadersStore[yE]=pk);const IE="pbrBlockLightmapInit",mk=`#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
#ifdef GAMMALIGHTMAP
lightmapColor.rgb=toLinearSpace(lightmapColor.rgb);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
`;S.IncludesShadersStore[IE]||(S.IncludesShadersStore[IE]=mk);const RE="pbrBlockGeometryInfo",_k=`float NdotVUnclamped=dot(normalW,viewDirectionW);float NdotV=absEps(NdotVUnclamped);float alphaG=convertRoughnessToAverageSlope(roughness);vec2 AARoughnessFactors=getAARoughnessFactors(normalW.xyz);
#ifdef SPECULARAA
alphaG+=AARoughnessFactors.y;
#endif
#if defined(ENVIRONMENTBRDF)
vec3 environmentBrdf=getBRDFLookup(NdotV,roughness);
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
#ifdef AMBIENTINGRAYSCALE
float ambientMonochrome=aoOut.ambientOcclusionColor.r;
#else
float ambientMonochrome=getLuminance(aoOut.ambientOcclusionColor);
#endif
float seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float eho=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);
#endif
#endif
#endif
#endif
`;S.IncludesShadersStore[RE]||(S.IncludesShadersStore[RE]=_k);const AE="pbrBlockReflectance",gk=`#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 baseSpecularEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(reflectanceF0),reflectivityOut.reflectanceF90,environmentBrdf);
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
vec3 metalEnvironmentReflectance=reflectivityOut.specularWeight*getF82Specular(NdotV,clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90,reflectivityOut.roughness);vec3 dielectricEnvironmentReflectance=getReflectanceFromBRDFLookup(reflectivityOut.dielectricColorF0,reflectivityOut.colorReflectanceF90,environmentBrdf);vec3 colorSpecularEnvironmentReflectance=mix(dielectricEnvironmentReflectance,metalEnvironmentReflectance,reflectivityOut.metallic);
#else
vec3 colorSpecularEnvironmentReflectance=getReflectanceFromBRDFLookup(clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90,environmentBrdf);
#endif
#ifdef RADIANCEOCCLUSION
colorSpecularEnvironmentReflectance*=seo;
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
colorSpecularEnvironmentReflectance*=eho;
#endif
#endif
#endif
#else
vec3 colorSpecularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));vec3 baseSpecularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,vec3(reflectanceF0),reflectivityOut.reflectanceF90,sqrt(microSurface));
#endif
#ifdef CLEARCOAT
colorSpecularEnvironmentReflectance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
colorSpecularEnvironmentReflectance*=clearcoatOut.absorption;
#endif
#endif
`;S.IncludesShadersStore[AE]||(S.IncludesShadersStore[AE]=gk);const PE="pbrBlockDirectLighting",Sk=`vec3 diffuseBase=vec3(0.,0.,0.);
#ifdef SS_TRANSLUCENCY
vec3 diffuseTransmissionBase=vec3(0.,0.,0.);
#endif
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
#ifdef CLEARCOAT
vec3 clearCoatBase=vec3(0.,0.,0.);
#endif
#ifdef SHEEN
vec3 sheenBase=vec3(0.,0.,0.);
#endif
#if defined(SPECULARTERM) && defined(LIGHT0)
vec3 coloredFresnel;
#endif
preLightingInfo preInfo;lightingInfo info;float shadow=1.; 
float aggShadow=0.;float numLights=0.;
#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
vec3 absorption=vec3(0.);
#endif
`;S.IncludesShadersStore[PE]||(S.IncludesShadersStore[PE]=Sk);const OE="pbrBlockFinalLitComponents",vk=`aggShadow=aggShadow/numLights;
#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 baseSpecularEnergyConservationFactor=getEnergyConservationFactor(vec3(reflectanceF0),environmentBrdf);vec3 coloredEnergyConservationFactor=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);
#endif
#endif
#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)
surfaceAlbedo.rgb=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
#ifndef METALLICWORKFLOW
#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION
surfaceAlbedo.rgb=(1.-reflectanceF0)*surfaceAlbedo.rgb;
#endif
#endif
#endif
#ifdef REFLECTION
vec3 finalIrradiance=reflectionOut.environmentIrradiance;
#ifndef LEGACY_SPECULAR_ENERGY_CONSERVATION
#if defined(METALLICWORKFLOW) || defined(SPECULAR_GLOSSINESS_ENERGY_CONSERVATION)
vec3 baseSpecularEnergy=vec3(baseSpecularEnvironmentReflectance);
#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
baseSpecularEnergy*=baseSpecularEnergyConservationFactor;
#endif
#endif
finalIrradiance*=clamp(vec3(1.0)-baseSpecularEnergy,0.0,1.0);
#endif
#endif
#if defined(CLEARCOAT)
finalIrradiance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
finalIrradiance*=clearcoatOut.absorption;
#endif
#endif
#ifndef SS_APPLY_ALBEDO_AFTER_SUBSURFACE
finalIrradiance*=surfaceAlbedo.rgb;
#endif
#if defined(SS_REFRACTION)
finalIrradiance*=subSurfaceOut.refractionOpacity;
#endif
#if defined(SS_TRANSLUCENCY)
finalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);finalIrradiance+=subSurfaceOut.refractionIrradiance;
#endif
#ifdef SS_APPLY_ALBEDO_AFTER_SUBSURFACE
finalIrradiance*=surfaceAlbedo.rgb;
#endif
finalIrradiance*=vLightingIntensity.z;finalIrradiance*=aoOut.ambientOcclusionColor;
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase;finalSpecular=max(finalSpecular,0.0);vec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalSpecularScaled*=coloredEnergyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalSpecularScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef REFLECTION
vec3 finalRadiance=reflectionOut.environmentRadiance.rgb;finalRadiance*=colorSpecularEnvironmentReflectance;vec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalRadianceScaled*=coloredEnergyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalRadianceScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef SHEEN
vec3 finalSheen=sheenBase*sheenOut.sheenColor;finalSheen=max(finalSheen,0.0);vec3 finalSheenScaled=finalSheen*vLightingIntensity.x*vLightingIntensity.w;
#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef CLEARCOAT
vec3 finalClearCoat=clearCoatBase;finalClearCoat=max(finalClearCoat,0.0);vec3 finalClearCoatScaled=finalClearCoat*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;
#ifdef CLEARCOAT_TINT
subSurfaceOut.finalRefraction*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef ALPHABLEND
float luminanceOverAlpha=0.0;
#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)
luminanceOverAlpha+=getLuminance(finalRadianceScaled);
#if defined(CLEARCOAT)
luminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);
#endif
#endif
#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)
luminanceOverAlpha+=getLuminance(finalSpecularScaled);
#endif
#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)
luminanceOverAlpha+=getLuminance(finalClearCoatScaled);
#endif
#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)
alpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);
#endif
#endif
`;S.IncludesShadersStore[OE]||(S.IncludesShadersStore[OE]=vk);const NE="pbrBlockFinalUnlitComponents",xk=`vec3 finalDiffuse=diffuseBase;finalDiffuse*=surfaceAlbedo;
#if defined(SS_REFRACTION) && !defined(UNLIT) && !defined(LEGACY_SPECULAR_ENERGY_CONSERVATION)
finalDiffuse*=subSurfaceOut.refractionOpacity;
#endif
#if defined(SS_TRANSLUCENCY) && !defined(UNLIT)
finalDiffuse+=diffuseTransmissionBase;
#endif
finalDiffuse=max(finalDiffuse,0.0);finalDiffuse*=vLightingIntensity.x;vec3 finalAmbient=vAmbientColor;finalAmbient*=surfaceAlbedo.rgb;vec3 finalEmissive=vEmissiveColor;
#ifdef EMISSIVE
vec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;
#ifdef GAMMAEMISSIVE
finalEmissive*=toLinearSpace(emissiveColorTex.rgb);
#else
finalEmissive*=emissiveColorTex.rgb;
#endif
finalEmissive*= vEmissiveInfos.y;
#endif
finalEmissive*=vLightingIntensity.y;
#ifdef AMBIENT
vec3 ambientOcclusionForDirectDiffuse=mix(vec3(1.),aoOut.ambientOcclusionColor,vAmbientInfos.w);
#else
vec3 ambientOcclusionForDirectDiffuse=aoOut.ambientOcclusionColor;
#endif
finalAmbient*=aoOut.ambientOcclusionColor;finalDiffuse*=ambientOcclusionForDirectDiffuse;
`;S.IncludesShadersStore[NE]||(S.IncludesShadersStore[NE]=xk);const DE="pbrBlockFinalColorComposition",Ek=`vec4 finalColor=vec4(
#ifndef UNLIT
#ifdef REFLECTION
finalIrradiance +
#endif
#ifdef SPECULARTERM
finalSpecularScaled +
#endif
#ifdef SHEEN
finalSheenScaled +
#endif
#ifdef CLEARCOAT
finalClearCoatScaled +
#endif
#ifdef REFLECTION
finalRadianceScaled +
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled +
#endif
#ifdef CLEARCOAT
clearcoatOut.finalClearCoatRadianceScaled +
#endif
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction +
#endif
#endif
finalAmbient +
finalDiffuse,
alpha);
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
finalColor.rgb*=lightmapColor.rgb;
#else
finalColor.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
finalColor.rgb+=finalEmissive;
#define CUSTOM_FRAGMENT_BEFORE_FOG
finalColor=max(finalColor,0.0);
`;S.IncludesShadersStore[DE]||(S.IncludesShadersStore[DE]=Ek);const ME="pbrBlockImageProcessing",Tk=`#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)
#if !defined(SKIPFINALCOLORCLAMP)
finalColor.rgb=clamp(finalColor.rgb,0.,30.0);
#endif
#else
finalColor=applyImageProcessing(finalColor);
#endif
finalColor.a*=visibility;
#ifdef PREMULTIPLYALPHA
finalColor.rgb*=finalColor.a;
#endif
`;S.IncludesShadersStore[ME]||(S.IncludesShadersStore[ME]=Tk);const FE="pbrBlockPrePass",bk=`#if SCENE_MRT_COUNT>0
float writeGeometryInfo=finalColor.a>ALPHATESTVALUE ? 1.0 : 0.0;
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_LOCAL_POSITION
gl_FragData[PREPASS_LOCAL_POSITION_INDEX]=vec4(vPosition,writeGeometryInfo);
#endif
#if defined(PREPASS_VELOCITY)
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#elif defined(PREPASS_VELOCITY_LINEAR)
vec2 velocity=vec2(0.5)*((vPreviousPosition.xy/vPreviousPosition.w)-(vCurrentPosition.xy/vCurrentPosition.w));gl_FragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO
gl_FragData[PREPASS_ALBEDO_INDEX]=vec4(surfaceAlbedo,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
vec3 sqAlbedo=sqrt(surfaceAlbedo); 
#endif
#ifdef PREPASS_IRRADIANCE
vec3 irradiance=finalDiffuse;
#ifndef UNLIT
#ifdef REFLECTION
irradiance+=finalIrradiance;
#endif
#endif
#ifdef SS_SCATTERING
#ifdef PREPASS_COLOR
gl_FragData[PREPASS_COLOR_INDEX]=vec4(finalColor.rgb-irradiance,finalColor.a); 
#endif
irradiance/=sqAlbedo;
#else
#ifdef PREPASS_COLOR
gl_FragData[PREPASS_COLOR_INDEX]=finalColor; 
#endif
float scatteringDiffusionProfile=255.;
#endif
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(clamp(irradiance,vec3(0.),vec3(1.)),writeGeometryInfo*scatteringDiffusionProfile/255.); 
#elif defined(PREPASS_COLOR)
gl_FragData[PREPASS_COLOR_INDEX]=vec4(finalColor.rgb,finalColor.a);
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_SCREENSPACE_DEPTH
gl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4(gl_FragCoord.z,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMALIZED_VIEW_DEPTH
gl_FragData[PREPASS_NORMALIZED_VIEW_DEPTH_INDEX]=vec4(vNormViewDepth,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMAL
#ifdef PREPASS_NORMAL_WORLDSPACE
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalW,writeGeometryInfo);
#else
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo);
#endif
#endif
#ifdef PREPASS_WORLD_NORMAL
gl_FragData[PREPASS_WORLD_NORMAL_INDEX]=vec4(normalW*0.5+0.5,writeGeometryInfo); 
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqAlbedo,writeGeometryInfo); 
#endif
#ifdef PREPASS_REFLECTIVITY
#ifndef UNLIT
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularEnvironmentR0,microSurface)*writeGeometryInfo;
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4( 0.0,0.0,0.0,1.0 )*writeGeometryInfo;
#endif
#endif
#endif
`;S.IncludesShadersStore[FE]||(S.IncludesShadersStore[FE]=bk);const LE="pbrDebug",Ck=`#if DEBUGMODE>0
if (vClipSpacePosition.x/vClipSpacePosition.w>=vDebugMode.x) {
#if DEBUGMODE==1
gl_FragColor.rgb=vPositionW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==2 && defined(NORMAL)
gl_FragColor.rgb=vNormalW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)
gl_FragColor.rgb=TBN[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)
gl_FragColor.rgb=TBN[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==5
gl_FragColor.rgb=normalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==6 && defined(MAINUV1)
gl_FragColor.rgb=vec3(vMainUV1,0.0);
#elif DEBUGMODE==7 && defined(MAINUV2)
gl_FragColor.rgb=vec3(vMainUV2,0.0);
#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
gl_FragColor.rgb=clearcoatOut.TBNClearCoat[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
gl_FragColor.rgb=clearcoatOut.TBNClearCoat[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==10 && defined(CLEARCOAT)
gl_FragColor.rgb=clearcoatOut.clearCoatNormalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==11 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicNormal;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==12 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicTangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==13 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicBitangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==20 && defined(ALBEDO)
gl_FragColor.rgb=albedoTexture.rgb;
#ifndef GAMMAALBEDO
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==21 && defined(AMBIENT)
gl_FragColor.rgb=aoOut.ambientOcclusionColorMap.rgb;
#elif DEBUGMODE==22 && defined(OPACITY)
gl_FragColor.rgb=opacityMap.rgb;
#elif DEBUGMODE==23 && defined(EMISSIVE)
gl_FragColor.rgb=emissiveColorTex.rgb;
#ifndef GAMMAEMISSIVE
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==24 && defined(LIGHTMAP)
gl_FragColor.rgb=lightmapColor.rgb;
#ifndef GAMMALIGHTMAP
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceMetallicColorMap.rgb;
#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceReflectivityColorMap.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatMapData.rg,0.0);
#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
gl_FragColor.rgb=clearcoatOut.clearCoatTintMapData.rgb;
#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)
gl_FragColor.rgb=sheenOut.sheenMapData.rgb;
#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)
gl_FragColor.rgb=anisotropicOut.anisotropyMapData.rgb;
#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)
gl_FragColor.rgb=subSurfaceOut.thicknessMap.rgb;
#elif DEBUGMODE==32 && defined(BUMP)
gl_FragColor.rgb=texture2D(bumpSampler,vBumpUV).rgb;
#elif DEBUGMODE==40 && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.environmentRefraction.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==41 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentRadiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)
gl_FragColor.rgb=clearcoatOut.environmentClearCoatRadiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==50
gl_FragColor.rgb=diffuseBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==51 && defined(SPECULARTERM)
gl_FragColor.rgb=specularBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==52 && defined(CLEARCOAT)
gl_FragColor.rgb=clearCoatBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==53 && defined(SHEEN)
gl_FragColor.rgb=sheenBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==54 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentIrradiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==60
gl_FragColor.rgb=surfaceAlbedo.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==61
gl_FragColor.rgb=clearcoatOut.specularEnvironmentR0;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=vec3(reflectivityOut.metallic);
#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.metallicF0;
#elif DEBUGMODE==63
gl_FragColor.rgb=vec3(roughness);
#elif DEBUGMODE==64
gl_FragColor.rgb=vec3(alphaG);
#elif DEBUGMODE==65
gl_FragColor.rgb=vec3(NdotV);
#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
gl_FragColor.rgb=clearcoatOut.clearCoatColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==67 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatRoughness);
#elif DEBUGMODE==68 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatNdotV);
#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)
gl_FragColor.rgb=subSurfaceOut.transmittance;
#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.refractionTransmittance;
#elif DEBUGMODE==72
gl_FragColor.rgb=vec3(microSurface);
#elif DEBUGMODE==73
gl_FragColor.rgb=vAlbedoColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==74 && !defined(METALLICWORKFLOW)
gl_FragColor.rgb=vReflectivityColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==75
gl_FragColor.rgb=vEmissiveColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)
gl_FragColor.rgb=vec3(seo);
#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
gl_FragColor.rgb=vec3(eho);
#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)
gl_FragColor.rgb=vec3(energyConservationFactor);
#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=baseSpecularEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=clearcoatOut.clearCoatEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)
gl_FragColor.rgb=sheenOut.sheenEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==86 && defined(ALPHABLEND)
gl_FragColor.rgb=vec3(luminanceOverAlpha);
#elif DEBUGMODE==87
gl_FragColor.rgb=vec3(alpha);
#elif DEBUGMODE==88 && defined(ALBEDO)
gl_FragColor.rgb=vec3(albedoTexture.a);
#elif DEBUGMODE==89
gl_FragColor.rgb=aoOut.ambientOcclusionColor.rgb;
#else
float stripeWidth=30.;float stripePos=floor(gl_FragCoord.x/stripeWidth);float whichColor=mod(stripePos,2.);vec3 color1=vec3(.6,.2,.2);vec3 color2=vec3(.3,.1,.1);gl_FragColor.rgb=mix(color1,color2,whichColor);
#endif
gl_FragColor.rgb*=vDebugMode.y;
#ifdef DEBUGMODE_NORMALIZE
gl_FragColor.rgb=normalize(gl_FragColor.rgb)*0.5+0.5;
#endif
#ifdef DEBUGMODE_GAMMA
gl_FragColor.rgb=toGammaSpace(gl_FragColor.rgb);
#endif
gl_FragColor.a=1.0;
#ifdef PREPASS
gl_FragData[0]=toLinearSpace(gl_FragColor); 
gl_FragData[1]=vec4(0.,0.,0.,0.); 
#endif
#ifdef DEBUGMODE_FORCERETURN
return;
#endif
}
#endif
`;S.IncludesShadersStore[LE]||(S.IncludesShadersStore[LE]=Ck);const Zd="pbrPixelShader",AA=`#define PBR_FRAGMENT_SHADER
#define CUSTOM_FRAGMENT_EXTENSION
#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#extension GL_OES_standard_derivatives : enable
#endif
#ifdef LODBASEDMICROSFURACE
#extension GL_EXT_shader_texture_lod : enable
#endif
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#if SCENE_MRT_COUNT>0
#include<prePassDeclaration>[SCENE_MRT_COUNT]
#endif
precision highp float;
#include<oitDeclaration>
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE
#endif
#include<__decl__pbrFragment>
#include<pbrFragmentExtraDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<pbrFragmentSamplersDeclaration>
#include<imageProcessingDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<importanceSampling>
#include<pbrHelperFunctions>
#include<imageProcessingFunctions>
#include<shadowsFragmentFunctions>
#include<harmonicsFunctions>
#include<pbrDirectLightingSetupFunctions>
#include<pbrDirectLightingFalloffFunctions>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
#include<pbrDirectLightingFunctions>
#include<pbrIBLFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#ifdef REFLECTION
#include<reflectionFunction>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
#include<pbrBlockAlbedoOpacity>
#include<pbrBlockReflectivity>
#include<pbrBlockAmbientOcclusion>
#include<pbrBlockAlphaFresnel>
#include<pbrBlockAnisotropic>
#include<pbrBlockReflection>
#include<pbrBlockSheen>
#include<pbrBlockClearcoat>
#include<pbrBlockIridescence>
#include<pbrBlockSubSurface>
#include<pbrClusteredLightingFunctions>
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#include<pbrBlockNormalGeometric>
#include<bumpFragment>
#include<pbrBlockNormalFinal>
albedoOpacityOutParams albedoOpacityOut;
#ifdef ALBEDO
vec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);
#endif
#ifdef BASE_WEIGHT
vec4 baseWeightTexture=texture2D(baseWeightSampler,vBaseWeightUV+uvOffset);
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#endif
#ifdef DECAL
vec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);
#endif
albedoOpacityOut=albedoOpacityBlock(
vAlbedoColor
#ifdef ALBEDO
,albedoTexture
,vAlbedoInfos
#endif
,baseWeight
#ifdef BASE_WEIGHT
,baseWeightTexture
,vBaseWeightInfos
#endif
#ifdef OPACITY
,opacityMap
,vOpacityInfos
#endif
#ifdef DETAIL
,detailColor
,vDetailInfos
#endif
#ifdef DECAL
,decalColor
,vDecalInfos
#endif
);vec3 surfaceAlbedo=albedoOpacityOut.surfaceAlbedo;float alpha=albedoOpacityOut.alpha;
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
#include<depthPrePass>
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
ambientOcclusionOutParams aoOut;
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb;
#endif
aoOut=ambientOcclusionBlock(
#ifdef AMBIENT
ambientOcclusionColorMap,
vAmbientInfos
#endif
);
#include<pbrBlockLightmapInit>
#ifdef UNLIT
vec3 diffuseBase=vec3(1.,1.,1.);
#else 
vec3 baseColor=surfaceAlbedo;reflectivityOutParams reflectivityOut;
#if defined(REFLECTIVITY)
vec4 surfaceMetallicOrReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);vec4 baseReflectivity=surfaceMetallicOrReflectivityColorMap;
#ifndef METALLICWORKFLOW
#ifdef REFLECTIVITY_GAMMA
surfaceMetallicOrReflectivityColorMap=toLinearSpace(surfaceMetallicOrReflectivityColorMap);
#endif
surfaceMetallicOrReflectivityColorMap.rgb*=vReflectivityInfos.y;
#endif
#endif
#if defined(MICROSURFACEMAP)
vec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;
#endif
#ifdef METALLICWORKFLOW
vec4 metallicReflectanceFactors=vMetallicReflectanceFactors;
#ifdef REFLECTANCE
vec4 reflectanceFactorsMap=texture2D(reflectanceSampler,vReflectanceUV+uvOffset);
#ifdef REFLECTANCE_GAMMA
reflectanceFactorsMap=toLinearSpace(reflectanceFactorsMap);
#endif
metallicReflectanceFactors.rgb*=reflectanceFactorsMap.rgb;
#endif
#ifdef METALLIC_REFLECTANCE
vec4 metallicReflectanceFactorsMap=texture2D(metallicReflectanceSampler,vMetallicReflectanceUV+uvOffset);
#ifdef METALLIC_REFLECTANCE_GAMMA
metallicReflectanceFactorsMap=toLinearSpace(metallicReflectanceFactorsMap);
#endif
#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY
metallicReflectanceFactors.rgb*=metallicReflectanceFactorsMap.rgb;
#endif
metallicReflectanceFactors.a*=metallicReflectanceFactorsMap.a;
#endif
#endif
#ifdef BASE_DIFFUSE_ROUGHNESS
float baseDiffuseRoughnessTexture=texture2D(baseDiffuseRoughnessSampler,vBaseDiffuseRoughnessUV+uvOffset).r;
#endif
reflectivityOut=reflectivityBlock(
vReflectivityColor
#ifdef METALLICWORKFLOW
,surfaceAlbedo
,metallicReflectanceFactors
#endif
,baseDiffuseRoughness
#ifdef BASE_DIFFUSE_ROUGHNESS
,baseDiffuseRoughnessTexture
,vBaseDiffuseRoughnessInfos
#endif
#ifdef REFLECTIVITY
,vReflectivityInfos
,surfaceMetallicOrReflectivityColorMap
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
,aoOut.ambientOcclusionColor
#endif
#ifdef MICROSURFACEMAP
,microSurfaceTexel
#endif
#ifdef DETAIL
,detailColor
,vDetailInfos
#endif
);float microSurface=reflectivityOut.microSurface;float roughness=reflectivityOut.roughness;float diffuseRoughness=reflectivityOut.diffuseRoughness;
#ifdef METALLICWORKFLOW
surfaceAlbedo=reflectivityOut.surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;
#endif
#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
alphaFresnelOutParams alphaFresnelOut;alphaFresnelOut=alphaFresnelBlock(
normalW,
viewDirectionW,
alpha,
microSurface
);alpha=alphaFresnelOut.alpha;
#endif
#endif
#include<pbrBlockGeometryInfo>
#ifdef ANISOTROPIC
anisotropicOutParams anisotropicOut;
#ifdef ANISOTROPIC_TEXTURE
vec3 anisotropyMapData=texture2D(anisotropySampler,vAnisotropyUV+uvOffset).rgb*vAnisotropyInfos.y;
#endif
anisotropicOut=anisotropicBlock(
vAnisotropy,
roughness,
#ifdef ANISOTROPIC_TEXTURE
anisotropyMapData,
#endif
TBN,
normalW,
viewDirectionW
);
#endif
#ifdef REFLECTION
reflectionOutParams reflectionOut;
#ifndef USE_CUSTOM_REFLECTION
reflectionOut=reflectionBlock(
vPositionW
,normalW
,alphaG
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness
#endif
,reflectionSampler
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,vEnvironmentIrradiance
#endif
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
,reflectionMatrix
#endif
#ifdef USEIRRADIANCEMAP
,irradianceSampler
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
,vReflectionDominantDirection
#endif
#endif
#ifndef LODBASEDMICROSFURACE
,reflectionSamplerLow
,reflectionSamplerHigh
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,icdfSampler
#endif
#endif
,viewDirectionW
,diffuseRoughness
,baseColor
);
#else
#define CUSTOM_REFLECTION
#endif
#endif
#include<pbrBlockReflectance0>
#ifdef SHEEN
sheenOutParams sheenOut;
#ifdef SHEEN_TEXTURE
vec4 sheenMapData=texture2D(sheenSampler,vSheenUV+uvOffset);
#endif
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 sheenMapRoughnessData=texture2D(sheenRoughnessSampler,vSheenRoughnessUV+uvOffset)*vSheenInfos.w;
#endif
sheenOut=sheenBlock(
vSheenColor
#ifdef SHEEN_ROUGHNESS
,vSheenRoughness
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
,sheenMapRoughnessData
#endif
#endif
,roughness
#ifdef SHEEN_TEXTURE
,sheenMapData
,vSheenInfos.y
#endif
,reflectanceF0
#ifdef SHEEN_LINKWITHALBEDO
,baseColor
,surfaceAlbedo
#endif
#ifdef ENVIRONMENTBRDF
,NdotV
,environmentBrdf
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,AARoughnessFactors
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
,vLightingIntensity
,reflectionSampler
,reflectionOut.reflectionCoords
,NdotVUnclamped
#ifndef LODBASEDMICROSFURACE
,reflectionSamplerLow
,reflectionSamplerHigh
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
,seo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
,eho
#endif
#endif
);
#ifdef SHEEN_LINKWITHALBEDO
surfaceAlbedo=sheenOut.surfaceAlbedo;
#endif
#endif
#ifdef CLEARCOAT
#ifdef CLEARCOAT_TEXTURE
vec2 clearCoatMapData=texture2D(clearCoatSampler,vClearCoatUV+uvOffset).rg*vClearCoatInfos.y;
#endif
#endif
#ifdef IRIDESCENCE
iridescenceOutParams iridescenceOut;
#ifdef IRIDESCENCE_TEXTURE
vec2 iridescenceMapData=texture2D(iridescenceSampler,vIridescenceUV+uvOffset).rg*vIridescenceInfos.y;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
vec2 iridescenceThicknessMapData=texture2D(iridescenceThicknessSampler,vIridescenceThicknessUV+uvOffset).rg*vIridescenceInfos.w;
#endif
iridescenceOut=iridescenceBlock(
vIridescenceParams
,NdotV
,specularEnvironmentR0
#ifdef IRIDESCENCE_TEXTURE
,iridescenceMapData
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
,iridescenceThicknessMapData
#endif
#ifdef CLEARCOAT
,NdotVUnclamped
,vClearCoatParams
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData
#endif
#endif
);float iridescenceIntensity=iridescenceOut.iridescenceIntensity;specularEnvironmentR0=iridescenceOut.specularEnvironmentR0;
#endif
clearcoatOutParams clearcoatOut;
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 clearCoatMapRoughnessData=texture2D(clearCoatRoughnessSampler,vClearCoatRoughnessUV+uvOffset)*vClearCoatInfos.w;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
vec4 clearCoatTintMapData=texture2D(clearCoatTintSampler,vClearCoatTintUV+uvOffset);
#endif
#ifdef CLEARCOAT_BUMP
vec4 clearCoatBumpMapData=texture2D(clearCoatBumpSampler,vClearCoatBumpUV+uvOffset);
#endif
clearcoatOut=clearcoatBlock(
vPositionW
,geometricNormalW
,viewDirectionW
,vClearCoatParams
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
,clearCoatMapRoughnessData
#endif
,specularEnvironmentR0
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData
#endif
#ifdef CLEARCOAT_TINT
,vClearCoatTintParams
,clearCoatColorAtDistance
,vClearCoatRefractionParams
#ifdef CLEARCOAT_TINT_TEXTURE
,clearCoatTintMapData
#endif
#endif
#ifdef CLEARCOAT_BUMP
,vClearCoatBumpInfos
,clearCoatBumpMapData
,vClearCoatBumpUV
#if defined(TANGENT) && defined(NORMAL)
,vTBN
#else
,vClearCoatTangentSpaceParams
#endif
#ifdef OBJECTSPACE_NORMALMAP
,normalMatrix
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
,faceNormal
#endif
#ifdef REFLECTION
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
,vLightingIntensity
,reflectionSampler
#ifndef LODBASEDMICROSFURACE
,reflectionSamplerLow
,reflectionSamplerHigh
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
,(gl_FrontFacing ? 1. : -1.)
#endif
);
#else
clearcoatOut.specularEnvironmentR0=specularEnvironmentR0;
#endif
#include<pbrBlockReflectance>
subSurfaceOutParams subSurfaceOut;
#ifdef SUBSURFACE
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec4 thicknessMap=texture2D(thicknessSampler,vThicknessUV+uvOffset);
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
vec4 refractionIntensityMap=texture2D(refractionIntensitySampler,vRefractionIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
vec4 translucencyIntensityMap=texture2D(translucencyIntensitySampler,vTranslucencyIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
vec4 translucencyColorMap=texture2D(translucencyColorSampler,vTranslucencyColorUV+uvOffset);
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE_GAMMA
translucencyColorMap=toLinearSpace(translucencyColorMap);
#endif
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
vec3 vSpecularEnvironmentReflectance=vec3(max(colorSpecularEnvironmentReflectance.r,max(colorSpecularEnvironmentReflectance.g,colorSpecularEnvironmentReflectance.b)));
#endif
subSurfaceOut=subSurfaceBlock(
vSubSurfaceIntensity
,vThicknessParam
,vTintColor
,normalW
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
,vSpecularEnvironmentReflectance
#else
,baseSpecularEnvironmentReflectance
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
,thicknessMap
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
,refractionIntensityMap
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
,translucencyIntensityMap
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
,reflectionMatrix
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,reflectionOut.irradianceVector
#endif
#if defined(REALTIME_FILTERING)
,reflectionSampler
,vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,icdfSampler
#endif
#endif
#endif
#ifdef USEIRRADIANCEMAP
,irradianceSampler
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
,surfaceAlbedo
#endif
#ifdef SS_REFRACTION
,vPositionW
,viewDirectionW
,view
,vRefractionInfos
,refractionMatrix
,vRefractionMicrosurfaceInfos
,vLightingIntensity
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
,alpha
#endif
#ifdef SS_LODINREFRACTIONALPHA
,NdotVUnclamped
#endif
#ifdef SS_LINEARSPECULARREFRACTION
,roughness
#endif
,alphaG
,refractionSampler
#ifndef LODBASEDMICROSFURACE
,refractionSamplerLow
,refractionSamplerHigh
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,vRefractionPosition
,vRefractionSize
#endif
#ifdef SS_DISPERSION
,dispersion
#endif
#endif
#ifdef SS_TRANSLUCENCY
,vDiffusionDistance
,vTranslucencyColor
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
,translucencyColorMap
#endif
#endif
);
#ifdef SS_REFRACTION
surfaceAlbedo=subSurfaceOut.surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha=subSurfaceOut.alpha;
#endif
#endif
#else
subSurfaceOut.specularEnvironmentReflectance=colorSpecularEnvironmentReflectance;
#endif
#include<pbrBlockDirectLighting>
#include<lightFragment>[0..maxSimultaneousLights]
#include<pbrBlockFinalLitComponents>
#endif 
#include<pbrBlockFinalUnlitComponents>
#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION
#include<pbrBlockFinalColorComposition>
#include<logDepthFragment>
#include<fogFragment>(color,finalColor)
#include<pbrBlockImageProcessing>
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
#include<pbrBlockPrePass>
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=finalColor;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {frontColor.rgb+=finalColor.rgb*finalColor.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-finalColor.a);} else {backColor+=finalColor;}
#endif
#include<pbrDebug>
#define CUSTOM_FRAGMENT_MAIN_END
}
`;S.ShadersStore[Zd]||(S.ShadersStore[Zd]=AA);const yk={name:Zd,shader:AA},PA=Object.freeze(Object.defineProperty({__proto__:null,pbrPixelShader:yk},Symbol.toStringTag,{value:"Module"})),wE="openpbrUboDeclaration",Ik=`uniform vTangentSpaceParams: vec2f;uniform vLightingIntensity: vec4f;uniform pointSize: f32;uniform vDebugMode: vec2f;uniform cameraInfo: vec4f;uniform vReflectionInfos: vec2f;uniform reflectionMatrix: mat4x4f;uniform vReflectionMicrosurfaceInfos: vec3f;uniform vReflectionPosition: vec3f;uniform vReflectionSize: vec3f;uniform vReflectionFilteringInfo: vec2f;uniform vReflectionDominantDirection: vec3f;uniform vReflectionColor: vec3f;uniform vSphericalL00: vec3f;uniform vSphericalL1_1: vec3f;uniform vSphericalL10: vec3f;uniform vSphericalL11: vec3f;uniform vSphericalL2_2: vec3f;uniform vSphericalL2_1: vec3f;uniform vSphericalL20: vec3f;uniform vSphericalL21: vec3f;uniform vSphericalL22: vec3f;uniform vSphericalX: vec3f;uniform vSphericalY: vec3f;uniform vSphericalZ: vec3f;uniform vSphericalXX_ZZ: vec3f;uniform vSphericalYY_ZZ: vec3f;uniform vSphericalZZ: vec3f;uniform vSphericalXY: vec3f;uniform vSphericalYZ: vec3f;uniform vSphericalZX: vec3f;uniform vBaseWeight: f32;uniform vBaseColor: vec4f;uniform vBaseDiffuseRoughness: f32;uniform vReflectanceInfo: vec4f;uniform vSpecularColor: vec4f;uniform vSpecularAnisotropy: vec3f;uniform vCoatWeight: f32;uniform vCoatColor: vec3f;uniform vCoatRoughness: f32;uniform vCoatRoughnessAnisotropy: f32;uniform vCoatIor: f32;uniform vCoatDarkening : f32;uniform vGeometryCoatTangent: vec2f;uniform vEmissionColor: vec3f;uniform vThinFilmWeight: f32;uniform vThinFilmThickness: vec2f;uniform vThinFilmIor: f32;uniform vBaseWeightInfos: vec2f;uniform baseWeightMatrix: mat4x4f;uniform vBaseColorInfos: vec2f;uniform baseColorMatrix: mat4x4f;uniform vBaseDiffuseRoughnessInfos: vec2f;uniform baseDiffuseRoughnessMatrix: mat4x4f;uniform vBaseMetalnessInfos: vec2f;uniform baseMetalnessMatrix: mat4x4f;uniform vSpecularWeightInfos: vec2f;uniform specularWeightMatrix: mat4x4f;uniform vSpecularColorInfos: vec2f;uniform specularColorMatrix: mat4x4f;uniform vSpecularRoughnessInfos: vec2f;uniform specularRoughnessMatrix: mat4x4f;uniform vSpecularRoughnessAnisotropyInfos: vec2f;uniform specularRoughnessAnisotropyMatrix: mat4x4f;uniform vCoatWeightInfos: vec2f;uniform coatWeightMatrix: mat4x4f;uniform vCoatColorInfos: vec2f;uniform coatColorMatrix: mat4x4f;uniform vCoatRoughnessInfos: vec2f;uniform coatRoughnessMatrix: mat4x4f;uniform vCoatRoughnessAnisotropyInfos: vec2f;uniform coatRoughnessAnisotropyMatrix: mat4x4f;uniform vCoatDarkeningInfos : vec2f;uniform coatDarkeningMatrix : mat4x4f;uniform vGeometryNormalInfos: vec2f;uniform geometryNormalMatrix: mat4x4f;uniform vGeometryTangentInfos: vec2f;uniform geometryTangentMatrix: mat4x4f;uniform vGeometryCoatNormalInfos: vec2f;uniform geometryCoatNormalMatrix: mat4x4f;uniform vGeometryCoatTangentInfos: vec2f;uniform geometryCoatTangentMatrix: mat4x4f;uniform vGeometryOpacityInfos: vec2f;uniform geometryOpacityMatrix: mat4x4f;uniform vEmissionInfos: vec2f;uniform emissionMatrix: mat4x4f;uniform vThinFilmWeightInfos: vec2f;uniform thinFilmWeightMatrix: mat4x4f;uniform vThinFilmThicknessInfos: vec2f;uniform thinFilmThicknessMatrix: mat4x4f;uniform vAmbientOcclusionInfos: vec2f;uniform ambientOcclusionMatrix: mat4x4f;
#define ADDITIONAL_UBO_DECLARATION
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;S.IncludesShadersStoreWGSL[wE]||(S.IncludesShadersStoreWGSL[wE]=Ik);const BE="openpbrNormalMapVertexDeclaration",Rk=`#if defined(GEOMETRY_NORMAL) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL) 
varying vTBN0: vec3f;varying vTBN1: vec3f;varying vTBN2: vec3f;
#endif
#endif
`;S.IncludesShadersStoreWGSL[BE]||(S.IncludesShadersStoreWGSL[BE]=Rk);const VE="openpbrNormalMapVertex",Ak=`#if defined(GEOMETRY_NORMAL) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
var tbnNormal: vec3f=normalize(normalUpdated);var tbnTangent: vec3f=normalize(tangentUpdated.xyz);var tbnBitangent: vec3f=cross(tbnNormal,tbnTangent)*tangentUpdated.w;var matTemp= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz)* mat3x3f(tbnTangent,tbnBitangent,tbnNormal);vertexOutputs.vTBN0=matTemp[0];vertexOutputs.vTBN1=matTemp[1];vertexOutputs.vTBN2=matTemp[2];
#endif
#endif
`;S.IncludesShadersStoreWGSL[VE]||(S.IncludesShadersStoreWGSL[VE]=Ak);const Qd="openpbrVertexShader",OA=`#define OPENPBR_VERTEX_SHADER
#include<openpbrUboDeclaration>
#define CUSTOM_VERTEX_BEGIN
attribute position: vec3f;
#ifdef NORMAL
attribute normal: vec3f;
#endif
#ifdef TANGENT
attribute tangent: vec4f;
#endif
#ifdef UV1
attribute uv: vec2f;
#endif
#include<uvAttributeDeclaration>[2..7]
#include<mainUVVaryingDeclaration>[1..7]
#ifdef VERTEXCOLOR
attribute color: vec4f;
#endif
#include<helperFunctions>
#include<pbrBRDFFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_COLOR,_VARYINGNAME_,BaseColor)
#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight)
#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_METALNESS,_VARYINGNAME_,BaseMetalness)
#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR_WEIGHT,_VARYINGNAME_,SpecularWeight)
#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR_COLOR,_VARYINGNAME_,SpecularColor)
#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR_ROUGHNESS,_VARYINGNAME_,SpecularRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,SpecularRoughnessAnisotropy)
#include<samplerVertexDeclaration>(_DEFINENAME_,COAT_WEIGHT,_VARYINGNAME_,CoatWeight)
#include<samplerVertexDeclaration>(_DEFINENAME_,COAT_COLOR,_VARYINGNAME_,CoatColor)
#include<samplerVertexDeclaration>(_DEFINENAME_,COAT_ROUGHNESS,_VARYINGNAME_,CoatRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,COAT_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,CoatRoughnessAnisotropy)
#include<samplerVertexDeclaration>(_DEFINENAME_,COAT_DARKENING,_VARYINGNAME_,CoatDarkening)
#include<samplerVertexDeclaration>(_DEFINENAME_,GEOMETRY_NORMAL,_VARYINGNAME_,GeometryNormal)
#include<samplerVertexDeclaration>(_DEFINENAME_,GEOMETRY_TANGENT,_VARYINGNAME_,GeometryTangent)
#include<samplerVertexDeclaration>(_DEFINENAME_,GEOMETRY_COAT_NORMAL,_VARYINGNAME_,GeometryCoatNormal)
#include<samplerVertexDeclaration>(_DEFINENAME_,GEOMETRY_OPACITY,_VARYINGNAME_,GeometryOpacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSION_COLOR,_VARYINGNAME_,EmissionColor)
#include<samplerVertexDeclaration>(_DEFINENAME_,THIN_FILM_WEIGHT,_VARYINGNAME_,ThinFilmWeight)
#include<samplerVertexDeclaration>(_DEFINENAME_,THIN_FILM_THICKNESS,_VARYINGNAME_,ThinFilmThickness)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT_OCCLUSION,_VARYINGNAME_,AmbientOcclusion)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
varying vPositionW: vec3f;
#if DEBUGMODE>0
varying vClipSpacePosition: vec4f;
#endif
#ifdef NORMAL
varying vNormalW: vec3f;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vEnvironmentIrradiance: vec3f;
#include<harmonicsFunctions>
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vColor: vec4f;
#endif
#include<openpbrNormalMapVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<lightVxUboDeclaration>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
var positionUpdated: vec3f=vertexInputs.position;
#ifdef NORMAL
var normalUpdated: vec3f=vertexInputs.normal;
#endif
#ifdef TANGENT
var tangentUpdated: vec4f=vertexInputs.tangent;
#endif
#ifdef UV1
var uvUpdated: vec2f=vertexInputs.uv;
#endif
#ifdef UV2
var uv2Updated: vec2f=vertexInputs.uv2;
#endif
#ifdef VERTEXCOLOR
var colorUpdated: vec4f=vertexInputs.color;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vertexOutputs.vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)
vertexOutputs.vCurrentPosition=scene.viewProjection*finalWorld*vec4f(positionUpdated,1.0);vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*vec4f(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);vertexOutputs.vPositionW= worldPos.xyz;
#ifdef PREPASS
#include<prePassVertex>
#endif
#ifdef NORMAL
var normalWorld: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vertexOutputs.vNormalW=normalUpdated/ vec3f(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vertexOutputs.vNormalW=normalize(normalWorld*vertexOutputs.vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vertexOutputs.vNormalW=normalize(normalWorld*normalUpdated);
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
#if BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LAMBERT && BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LEGACY
var viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-vertexOutputs.vPositionW);var NdotV: f32=max(dot(vertexOutputs.vNormalW,viewDirectionW),0.0);var roughNormal: vec3f=mix(vertexOutputs.vNormalW,viewDirectionW,(0.5*(1.0-NdotV))*uniforms.vBaseDiffuseRoughness);var reflectionVector: vec3f= (uniforms.reflectionMatrix* vec4f(roughNormal,0)).xyz;
#else
var reflectionVector: vec3f= (uniforms.reflectionMatrix* vec4f(vertexOutputs.vNormalW,0)).xyz;
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
vertexOutputs.vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {vertexOutputs.position=scene.viewProjection*worldPos;} else {vertexOutputs.position=scene.viewProjectionR*worldPos;}
#else
vertexOutputs.position=scene.viewProjection*worldPos;
#endif
#if DEBUGMODE>0
vertexOutputs.vClipSpacePosition=vertexOutputs.position;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vertexOutputs.vDirectionW=normalize((finalWorld*vec4f(positionUpdated,0.0)).xyz);
#endif
#ifndef UV1
var uvUpdated: vec2f= vec2f(0.,0.);
#endif
#ifdef MAINUV1
vertexOutputs.vMainUV1=uvUpdated;
#endif
#ifndef UV2
var uv2Updated: vec2f= vec2f(0.,0.);
#endif
#ifdef MAINUV2
vertexOutputs.vMainUV2=uv2Updated;
#endif
#include<uvVariableDeclaration>[3..7]
#include<samplerVertexImplementation>(_DEFINENAME_,BASE_COLOR,_VARYINGNAME_,BaseColor,_MATRIXNAME_,baseColor,_INFONAME_,BaseColorInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight,_MATRIXNAME_,baseWeight,_INFONAME_,BaseWeightInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness,_MATRIXNAME_,baseDiffuseRoughness,_INFONAME_,BaseDiffuseRoughnessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BASE_METALNESS,_VARYINGNAME_,BaseMetalness,_MATRIXNAME_,baseMetalness,_INFONAME_,BaseMetalnessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR_WEIGHT,_VARYINGNAME_,SpecularWeight,_MATRIXNAME_,specularWeight,_INFONAME_,SpecularWeightInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR_COLOR,_VARYINGNAME_,SpecularColor,_MATRIXNAME_,specularColor,_INFONAME_,SpecularColorInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR_ROUGHNESS,_VARYINGNAME_,SpecularRoughness,_MATRIXNAME_,specularRoughness,_INFONAME_,SpecularRoughnessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,SpecularRoughnessAnisotropy,_MATRIXNAME_,specularRoughnessAnisotropy,_INFONAME_,SpecularRoughnessAnisotropyInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,COAT_WEIGHT,_VARYINGNAME_,CoatWeight,_MATRIXNAME_,coatWeight,_INFONAME_,CoatWeightInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,COAT_COLOR,_VARYNAME_,CoatColor,_MATRIXNAME_,coatColor,_INFONAME_,CoatColorInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,COAT_ROUGHNESS,_VARYINGNAME_,CoatRoughness,_MATRIXNAME_,coatRoughness,_INFONAME_,CoatRoughnessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,COAT_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,CoatRoughnessAnisotropy,_MATRIXNAME_,coatRoughnessAnisotropy,_INFONAME_,CoatRoughnessAnisotropyInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,COAT_DARKENING,_VARYINGNAME_,CoatDarkening,_MATRIXNAME_,coatDarkening,_INFONAME_,CoatDarkeningInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,GEOMETRY_NORMAL,_VARYINGNAME_,GeometryNormal,_MATRIXNAME_,geometryNormal,_INFONAME_,GeometryNormalInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,GEOMETRY_TANGENT,_VARYINGNAME_,GeometryTangent,_MATRIXNAME_,geometryTangent,_INFONAME_,GeometryTangentInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,GEOMETRY_COAT_NORMAL,_VARYINGNAME_,GeometryCoatNormal,_MATRIXNAME_,geometryCoatNormal,_INFONAME_,GeometryCoatNormalInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,GEOMETRY_OPACITY,_VARYINGNAME_,GeometryOpacity,_MATRIXNAME_,geometryOpacity,_INFONAME_,GeometryOpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSION_COLOR,_VARYINGNAME_,EmissionColor,_MATRIXNAME_,emissionColor,_INFONAME_,EmissionColorInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,THIN_FILM_WEIGHT,_VARYINGNAME_,ThinFilmWeight,_MATRIXNAME_,thinFilmWeight,_INFONAME_,ThinFilmWeightInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,THIN_FILM_THICKNESS,_VARYINGNAME_,ThinFilmThickness,_MATRIXNAME_,thinFilmThickness,_INFONAME_,ThinFilmThicknessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT_OCCLUSION,_VARYINGNAME_,AmbientOcclusion,_MATRIXNAME_,ambientOcclusion,_INFONAME_,AmbientOcclusionInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<openpbrNormalMapVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;S.ShadersStoreWGSL[Qd]||(S.ShadersStoreWGSL[Qd]=OA);const Pk={name:Qd,shader:OA},Ok=Object.freeze(Object.defineProperty({__proto__:null,openpbrVertexShaderWGSL:Pk},Symbol.toStringTag,{value:"Module"})),UE="openpbrFragmentSamplersDeclaration",Nk=`#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_COLOR,_VARYINGNAME_,BaseColor,_SAMPLERNAME_,baseColor)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight,_SAMPLERNAME_,baseWeight)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness,_SAMPLERNAME_,baseDiffuseRoughness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_METALNESS,_VARYINGNAME_,BaseMetalness,_SAMPLERNAME_,baseMetalness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR_WEIGHT,_VARYINGNAME_,SpecularWeight,_SAMPLERNAME_,specularWeight)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR_COLOR,_VARYINGNAME_,SpecularColor,_SAMPLERNAME_,specularColor)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR_ROUGHNESS,_VARYINGNAME_,SpecularRoughness,_SAMPLERNAME_,specularRoughness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,SpecularRoughnessAnisotropy,_SAMPLERNAME_,specularRoughnessAnisotropy)
#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_WEIGHT,_VARYINGNAME_,CoatWeight,_SAMPLERNAME_,coatWeight)
#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_COLOR,_VARYINGNAME_,CoatColor,_SAMPLERNAME_,coatColor)
#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_ROUGHNESS,_VARYINGNAME_,CoatRoughness,_SAMPLERNAME_,coatRoughness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,CoatRoughnessAnisotropy,_SAMPLERNAME_,coatRoughnessAnisotropy)
#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_DARKENING,_VARYINGNAME_,CoatDarkening,_SAMPLERNAME_,coatDarkening)
#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_OPACITY,_VARYINGNAME_,GeometryOpacity,_SAMPLERNAME_,geometryOpacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_TANGENT,_VARYINGNAME_,GeometryTangent,_SAMPLERNAME_,geometryTangent)
#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_COAT_TANGENT,_VARYINGNAME_,GeometryCoatTangent,_SAMPLERNAME_,geometryCoatTangent)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSION_COLOR,_VARYINGNAME_,EmissionColor,_SAMPLERNAME_,emissionColor)
#include<samplerFragmentDeclaration>(_DEFINENAME_,THIN_FILM_WEIGHT,_VARYINGNAME_,ThinFilmWeight,_SAMPLERNAME_,thinFilmWeight)
#include<samplerFragmentDeclaration>(_DEFINENAME_,THIN_FILM_THICKNESS,_VARYINGNAME_,ThinFilmThickness,_SAMPLERNAME_,thinFilmThickness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT_OCCLUSION,_VARYINGNAME_,AmbientOcclusion,_SAMPLERNAME_,ambientOcclusion)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_cube<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_cube<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_cube<f32>;
#endif
#ifdef USEIRRADIANCEMAP
var irradianceSamplerSampler: sampler;var irradianceSampler: texture_cube<f32>;
#endif
#else
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_2d<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_2d<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_2d<f32>;
#endif
#ifdef USEIRRADIANCEMAP
var irradianceSamplerSampler: sampler;var irradianceSampler: texture_2d<f32>;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#endif
#endif
#ifdef ENVIRONMENTBRDF
var environmentBrdfSamplerSampler: sampler;var environmentBrdfSampler: texture_2d<f32>;
#endif
#ifdef ANISOTROPIC
var blueNoiseSamplerSampler: sampler;var blueNoiseSampler: texture_2d<f32>;
#endif
#ifdef IBL_CDF_FILTERING
var icdfSamplerSampler: sampler;var icdfSampler: texture_2d<f32>;
#endif
`;S.IncludesShadersStoreWGSL[UE]||(S.IncludesShadersStoreWGSL[UE]=Nk);const kE="openpbrNormalMapFragmentMainFunctions",Dk=`#if defined(GEOMETRY_NORMAL) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)
#if defined(TANGENT) && defined(NORMAL) 
varying vTBN0: vec3f;varying vTBN1: vec3f;varying vTBN2: vec3f;
#endif
#ifdef OBJECTSPACE_NORMALMAP
uniform normalMatrix: mat4x4f;fn toNormalMatrix(m: mat4x4f)->mat4x4f
{var a00=m[0][0];var a01=m[0][1];var a02=m[0][2];var a03=m[0][3];var a10=m[1][0];var a11=m[1][1];var a12=m[1][2];var a13=m[1][3];var a20=m[2][0]; 
var a21=m[2][1];var a22=m[2][2];var a23=m[2][3];var a30=m[3][0]; 
var a31=m[3][1];var a32=m[3][2];var a33=m[3][3];var b00=a00*a11-a01*a10;var b01=a00*a12-a02*a10;var b02=a00*a13-a03*a10;var b03=a01*a12-a02*a11;var b04=a01*a13-a03*a11;var b05=a02*a13-a03*a12;var b06=a20*a31-a21*a30;var b07=a20*a32-a22*a30;var b08=a20*a33-a23*a30;var b09=a21*a32-a22*a31;var b10=a21*a33-a23*a31;var b11=a22*a33-a23*a32;var det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;var mi=mat4x4<f32>(
(a11*b11-a12*b10+a13*b09)/det,
(a02*b10-a01*b11-a03*b09)/det,
(a31*b05-a32*b04+a33*b03)/det,
(a22*b04-a21*b05-a23*b03)/det,
(a12*b08-a10*b11-a13*b07)/det,
(a00*b11-a02*b08+a03*b07)/det,
(a32*b02-a30*b05-a33*b01)/det,
(a20*b05-a22*b02+a23*b01)/det,
(a10*b10-a11*b08+a13*b06)/det,
(a01*b08-a00*b10-a03*b06)/det,
(a30*b04-a31*b02+a33*b00)/det,
(a21*b02-a20*b04-a23*b00)/det,
(a11*b07-a10*b09-a12*b06)/det,
(a00*b09-a01*b07+a02*b06)/det,
(a31*b01-a30*b03-a32*b00)/det,
(a20*b03-a21*b01+a22*b00)/det);return mat4x4<f32>(mi[0][0],mi[1][0],mi[2][0],mi[3][0],
mi[0][1],mi[1][1],mi[2][1],mi[3][1],
mi[0][2],mi[1][2],mi[2][2],mi[3][2],
mi[0][3],mi[1][3],mi[2][3],mi[3][3]);}
#endif
fn perturbNormalBase(cotangentFrame: mat3x3f,normal: vec3f,scale: f32)->vec3f
{var output=normal;
#ifdef NORMALXYSCALE
output=normalize(output* vec3f(scale,scale,1.0));
#endif
return normalize(cotangentFrame*output);}
fn perturbNormal(cotangentFrame: mat3x3f,textureSample: vec3f,scale: f32)->vec3f
{return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);}
fn cotangent_frame(normal: vec3f,p: vec3f,uv: vec2f,tangentSpaceParams: vec2f)->mat3x3f
{var dp1: vec3f=dpdx(p);var dp2: vec3f=dpdy(p);var duv1: vec2f=dpdx(uv);var duv2: vec2f=dpdy(uv);var dp2perp: vec3f=cross(dp2,normal);var dp1perp: vec3f=cross(normal,dp1);var tangent: vec3f=dp2perp*duv1.x+dp1perp*duv2.x;var bitangent: vec3f=dp2perp*duv1.y+dp1perp*duv2.y;tangent*=tangentSpaceParams.x;bitangent*=tangentSpaceParams.y;var det: f32=max(dot(tangent,tangent),dot(bitangent,bitangent));var invmax: f32=select(inverseSqrt(det),0.0,det==0.0);return mat3x3f(tangent*invmax,bitangent*invmax,normal);}
#endif
`;S.IncludesShadersStoreWGSL[kE]||(S.IncludesShadersStoreWGSL[kE]=Dk);const GE="openpbrNormalMapFragmentFunctions",Mk=`#if defined(GEOMETRY_NORMAL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_NORMAL,_VARYINGNAME_,GeometryNormal,_SAMPLERNAME_,geometryNormal)
#endif
#if defined(GEOMETRY_COAT_NORMAL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_COAT_NORMAL,_VARYINGNAME_,GeometryCoatNormal,_SAMPLERNAME_,geometryCoatNormal)
#endif
#if defined(DETAIL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)
#endif
#if defined(GEOMETRY_NORMAL) && defined(PARALLAX)
const minSamples: f32=4.;const maxSamples: f32=15.;const iMaxSamples: i32=15;fn parallaxOcclusion(vViewDirCoT: vec3f,vNormalCoT: vec3f,texCoord: vec2f,parallaxScale: f32)->vec2f {var parallaxLimit: f32=length(vViewDirCoT.xy)/vViewDirCoT.z;parallaxLimit*=parallaxScale;var vOffsetDir: vec2f=normalize(vViewDirCoT.xy);var vMaxOffset: vec2f=vOffsetDir*parallaxLimit;var numSamples: f32=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));var stepSize: f32=1.0/numSamples;var currRayHeight: f32=1.0;var vCurrOffset: vec2f= vec2f(0,0);var vLastOffset: vec2f= vec2f(0,0);var lastSampledHeight: f32=1.0;var currSampledHeight: f32=1.0;var keepWorking: bool=true;for (var i: i32=0; i<iMaxSamples; i++)
{currSampledHeight=textureSample(geometryNormalSampler,geometryNormalSamplerSampler,texCoord+vCurrOffset).w;if (!keepWorking)
{}
else if (currSampledHeight>currRayHeight)
{var delta1: f32=currSampledHeight-currRayHeight;var delta2: f32=(currRayHeight+stepSize)-lastSampledHeight;var ratio: f32=delta1/(delta1+delta2);vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;keepWorking=false;}
else
{currRayHeight-=stepSize;vLastOffset=vCurrOffset;
#ifdef PARALLAX_RHS
vCurrOffset-=stepSize*vMaxOffset;
#else
vCurrOffset+=stepSize*vMaxOffset;
#endif
lastSampledHeight=currSampledHeight;}}
return vCurrOffset;}
fn parallaxOffset(viewDir: vec3f,heightScale: f32)->vec2f
{var height: f32=textureSample(geometryNormalSampler,geometryNormalSamplerSampler,fragmentInputs.vGeometryNormalUV).w;var texCoordOffset: vec2f=heightScale*viewDir.xy*height;
#ifdef PARALLAX_RHS
return texCoordOffset;
#else
return -texCoordOffset;
#endif
}
#endif
`;S.IncludesShadersStoreWGSL[GE]||(S.IncludesShadersStoreWGSL[GE]=Mk);const zE="openpbrDielectricReflectance",Fk=`struct ReflectanceParams
{F0: f32,
F90: f32,
coloredF0: vec3f,
coloredF90: vec3f,};
#define pbr_inline
fn dielectricReflectance(
insideIOR: f32,outsideIOR: f32,specularColor: vec3f,specularWeight: f32
)->ReflectanceParams
{var outParams: ReflectanceParams;let dielectricF0=pow((insideIOR-outsideIOR)/(insideIOR+outsideIOR),2.0);
#if DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_GLTF
let maxF0=max(specularColor.r,max(specularColor.g,specularColor.b));outParams.F0=dielectricF0*maxF0*specularWeight;
#else
outParams.F0=dielectricF0*specularWeight;
#endif
let f90Scale=clamp(2.0f*abs(insideIOR-outsideIOR),0.0f,1.0f);outParams.F90=f90Scale*specularWeight;outParams.coloredF0=vec3f(dielectricF0*specularWeight)*specularColor.rgb;
#if (DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_OPENPBR)
let dielectricColorF90: vec3f=specularColor.rgb*vec3f(f90Scale)*specularWeight;
#else
let dielectricColorF90: vec3f=vec3f(f90Scale)*specularWeight;
#endif
outParams.coloredF90=dielectricColorF90;return outParams;}
`;S.IncludesShadersStoreWGSL[zE]||(S.IncludesShadersStoreWGSL[zE]=Fk);const WE="openpbrConductorReflectance",Lk=`#define pbr_inline
fn conductorReflectance(baseColor: vec3f,specularColor: vec3f,specularWeight: f32)->ReflectanceParams
{var outParams: ReflectanceParams;
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
outParams.coloredF0=baseColor*specularWeight;outParams.coloredF90=specularColor*specularWeight;
#else
outParams.coloredF0=baseColor;outParams.coloredF90=vec3f(1.0f);
#endif
outParams.F0=1.0f;outParams.F90=1.0f;return outParams;}`;S.IncludesShadersStoreWGSL[WE]||(S.IncludesShadersStoreWGSL[WE]=Lk);const HE="openpbrBlockAmbientOcclusion",wk=`struct ambientOcclusionOutParams
{ambientOcclusionColor: vec3f,
#if DEBUGMODE>0 && defined(AMBIENT_OCCLUSION)
ambientOcclusionColorMap: vec3f
#endif
};
#define pbr_inline
fn ambientOcclusionBlock(
#ifdef AMBIENT_OCCLUSION
ambientOcclusionColorMap_: vec3f,
ambientInfos: vec2f
#endif
)->ambientOcclusionOutParams
{ 
var outParams: ambientOcclusionOutParams;var ambientOcclusionColor: vec3f= vec3f(1.,1.,1.);
#ifdef AMBIENT_OCCLUSION
var ambientOcclusionColorMap: vec3f=ambientOcclusionColorMap_*ambientInfos.y;
#ifdef AMBIENTINGRAYSCALE
ambientOcclusionColorMap= vec3f(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);
#endif
#if DEBUGMODE>0
outParams.ambientOcclusionColorMap=ambientOcclusionColorMap;
#endif
#endif
outParams.ambientOcclusionColor=ambientOcclusionColor;return outParams;}
`;S.IncludesShadersStoreWGSL[HE]||(S.IncludesShadersStoreWGSL[HE]=wk);const $E="openpbrGeometryInfo",Bk=`struct geometryInfoOutParams
{NdotV: f32,
NdotVUnclamped: f32,
environmentBrdf: vec3f,
horizonOcclusion: f32};
#ifdef ANISOTROPIC
struct geometryInfoAnisoOutParams
{NdotV: f32,
NdotVUnclamped: f32,
environmentBrdf: vec3f,
horizonOcclusion: f32,
anisotropy: f32,
anisotropicTangent: vec3f,
anisotropicBitangent: vec3f,
TBN: mat3x3<f32>};
#endif
fn geometryInfo(
normalW: vec3f,viewDirectionW: vec3f,roughness: f32,geometricNormalW: vec3f
)->geometryInfoOutParams
{var outParams: geometryInfoOutParams;outParams.NdotVUnclamped=dot(normalW,viewDirectionW);outParams.NdotV=absEps(outParams.NdotVUnclamped);
#if defined(ENVIRONMENTBRDF)
outParams.environmentBrdf=getBRDFLookup(outParams.NdotV,roughness);
#else
outParams.environmentBrdf=vec3f(0.0);
#endif
outParams.horizonOcclusion=1.0f;
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef HORIZONOCCLUSION
#if defined(GEOMETRY_NORMAL) || defined(GEOMETRY_COAT_NORMAL)
#ifdef REFLECTIONMAP_3D
outParams.horizonOcclusion=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);
#endif
#endif
#endif
#endif
return outParams;}
#ifdef ANISOTROPIC
fn geometryInfoAniso(
normalW: vec3f,viewDirectionW: vec3f,roughness: f32,geometricNormalW: vec3f
,vAnisotropy: vec3f,TBN: mat3x3<f32>
)->geometryInfoAnisoOutParams
{let geoInfo: geometryInfoOutParams=geometryInfo(normalW,viewDirectionW,roughness,geometricNormalW);var outParams: geometryInfoAnisoOutParams;outParams.NdotV=geoInfo.NdotV;outParams.NdotVUnclamped=geoInfo.NdotVUnclamped;outParams.environmentBrdf=geoInfo.environmentBrdf;outParams.horizonOcclusion=geoInfo.horizonOcclusion;outParams.anisotropy=vAnisotropy.b;let anisotropyDirection: vec3f=vec3f(vAnisotropy.xy,0.);let anisoTBN: mat3x3<f32>=mat3x3<f32>(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));outParams.anisotropicTangent=normalize(anisoTBN*anisotropyDirection);outParams.anisotropicBitangent=normalize(cross(anisoTBN[2],outParams.anisotropicTangent));outParams.TBN=TBN;return outParams;}
#endif
`;S.IncludesShadersStoreWGSL[$E]||(S.IncludesShadersStoreWGSL[$E]=Bk);const XE="openpbrIblFunctions",Vk=`#ifdef REFLECTION
fn sampleIrradiance(
surfaceNormal: vec3f
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,vEnvironmentIrradianceSH: vec3f
#endif
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
,iblMatrix: mat4x4f
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,irradianceSampler: texture_cube<f32>
,irradianceSamplerSampler: sampler
#else
,irradianceSampler: texture_2d<f32>
,irradianceSamplerSampler: sampler
#endif
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
,reflectionDominantDirection: vec3f
#endif
#endif
#ifdef REALTIME_FILTERING
,reflectionFilteringInfo: vec2f
#ifdef IBL_CDF_FILTERING
,icdfSampler: texture_2d<f32>
,icdfSamplerSampler: sampler
#endif
#endif
,reflectionInfos: vec2f
,viewDirectionW: vec3f
,diffuseRoughness: f32
,surfaceAlbedo: vec3f
)->vec3f {var environmentIrradiance=vec3f(0.,0.,0.);
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
var irradianceVector=(iblMatrix*vec4f(surfaceNormal,0.0f)).xyz;let irradianceView=(iblMatrix*vec4f(viewDirectionW,0.0f)).xyz;
#if !defined(USE_IRRADIANCE_DOMINANT_DIRECTION) && !defined(REALTIME_FILTERING)
#if BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LAMBERT && BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LEGACY
{let NdotV=max(dot(surfaceNormal,viewDirectionW),0.0f);irradianceVector=mix(irradianceVector,irradianceView,(0.5f*(1.0f-NdotV))*diffuseRoughness);}
#endif
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0f;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0f;
#endif
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
environmentIrradiance=vEnvironmentIrradianceSH;
#else
#if defined(REALTIME_FILTERING)
environmentIrradiance=irradiance(reflectionSampler,reflectionSamplerSampler,irradianceVector,reflectionFilteringInfo,diffuseRoughness,surfaceAlbedo,irradianceView
#ifdef IBL_CDF_FILTERING
,icdfSampler
,icdfSamplerSampler
#endif
);
#else
environmentIrradiance=computeEnvironmentIrradiance(irradianceVector);
#endif
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
let environmentIrradianceFromTexture: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,irradianceVector);
#else
let environmentIrradianceFromTexture: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,reflectionCoords);
#endif
environmentIrradiance=environmentIrradianceFromTexture.rgb;
#ifdef RGBDREFLECTION
environmentIrradiance.rgb=fromRGBD(environmentIrradianceFromTexture);
#endif
#ifdef GAMMAREFLECTION
environmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);
#endif
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
let Ls: vec3f=normalize(reflectionDominantDirection);let NoL: f32=dot(irradianceVector,Ls);let NoV: f32=dot(irradianceVector,irradianceView);var diffuseRoughnessTerm=vec3f(1.0f);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
let LoV: f32=dot (Ls,irradianceView);let mag: f32=length(reflectionDominantDirection)*2.0f;let clampedAlbedo: vec3f=clamp(surfaceAlbedo,vec3f(0.1f),vec3f(1.0f));diffuseRoughnessTerm=diffuseBRDF_EON(clampedAlbedo,diffuseRoughness,NoL,NoV,LoV)*PI;diffuseRoughnessTerm=diffuseRoughnessTerm/clampedAlbedo;diffuseRoughnessTerm=mix(vec3f(1.0f),diffuseRoughnessTerm,sqrt(clamp(mag*NoV,0.0f,1.0f)));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
let H: vec3f=(irradianceView+Ls)*0.5f;let VoH: f32=dot(irradianceView,H);diffuseRoughnessTerm=vec3f(diffuseBRDF_Burley(NoL,NoV,VoH,diffuseRoughness)*PI);
#endif
environmentIrradiance=environmentIrradiance.rgb*diffuseRoughnessTerm;
#endif
#endif
environmentIrradiance*=reflectionInfos.x;return environmentIrradiance;}
#ifdef REFLECTIONMAP_3D
fn createReflectionCoords(vPositionW: vec3f,normalW: vec3f)->vec3f
#else
fn createReflectionCoords(vPositionW: vec3f,normalW: vec3f)->vec2f
#endif
{var reflectionVector: vec3f=computeReflectionCoords(vec4f(vPositionW,1.0f),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
var reflectionCoords: vec3f=reflectionVector;
#else
var reflectionCoords: vec2f=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0f-reflectionCoords.y;
#endif
return reflectionCoords;}
fn sampleRadiance(
alphaG: f32
,reflectionMicrosurfaceInfos: vec3f
,reflectionInfos: vec2f
,geoInfo: geometryInfoOutParams
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec3f
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec2f
#endif
#ifdef REALTIME_FILTERING
,reflectionFilteringInfo: vec2f
#endif
)->vec3f {var environmentRadiance: vec4f=vec4f(0.f,0.f,0.f,0.f);
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
var reflectionLOD: f32=getLodFromAlphaG(reflectionMicrosurfaceInfos.x,alphaG,geoInfo.NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
var reflectionLOD: f32=getLinearLodFromRoughness(reflectionMicrosurfaceInfos.x,roughness);
#else
var reflectionLOD: f32=getLodFromAlphaG(reflectionMicrosurfaceInfos.x,alphaG);
#endif
reflectionLOD=reflectionLOD*reflectionMicrosurfaceInfos.y+reflectionMicrosurfaceInfos.z;
#ifdef REALTIME_FILTERING
environmentRadiance=vec4f(radiance(alphaG,reflectionSampler,reflectionSamplerSampler,reflectionCoords,reflectionFilteringInfo),1.0f);
#else
environmentRadiance=textureSampleLevel(reflectionSampler,reflectionSamplerSampler,reflectionCoords,reflectionLOD);
#endif
#ifdef RGBDREFLECTION
environmentRadiance.rgb=fromRGBD(environmentRadiance);
#endif
#ifdef GAMMAREFLECTION
environmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);
#endif
return environmentRadiance.rgb;}
#if defined(ANISOTROPIC)
fn sampleRadianceAnisotropic(
alphaG: f32
,reflectionMicrosurfaceInfos: vec3f
,reflectionInfos: vec2f
,geoInfo: geometryInfoAnisoOutParams
,normalW: vec3f
,viewDirectionW: vec3f
,positionW: vec3f
,noise: vec3f
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
#endif
#ifdef REALTIME_FILTERING
,reflectionFilteringInfo: vec2f
#endif
)->vec3f {var environmentRadiance: vec4f=vec4f(0.f,0.f,0.f,0.f);let alphaT=alphaG*sqrt(2.0f/(1.0f+(1.0f-geoInfo.anisotropy)*(1.0f-geoInfo.anisotropy)));let alphaB=(1.0f-geoInfo.anisotropy)*alphaT;let modifiedAlphaG=alphaB;
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
var reflectionLOD: f32=getLodFromAlphaG(reflectionMicrosurfaceInfos.x,modifiedAlphaG,geoInfo.NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
var reflectionLOD: f32=getLinearLodFromRoughness(reflectionMicrosurfaceInfos.x,roughness);
#else
var reflectionLOD: f32=getLodFromAlphaG(reflectionMicrosurfaceInfos.x,modifiedAlphaG);
#endif
reflectionLOD=reflectionLOD*reflectionMicrosurfaceInfos.y+reflectionMicrosurfaceInfos.z;
#ifdef REALTIME_FILTERING
var view=(uniforms.reflectionMatrix*vec4f(viewDirectionW,0.0f)).xyz;var tangent=(uniforms.reflectionMatrix*vec4f(geoInfo.anisotropicTangent,0.0f)).xyz;var bitangent=(uniforms.reflectionMatrix*vec4f(geoInfo.anisotropicBitangent,0.0f)).xyz;var normal=(uniforms.reflectionMatrix*vec4f(normalW,0.0f)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
view.z*=-1.0f;tangent.z*=-1.0f;bitangent.z*=-1.0f;normal.z*=-1.0f;
#endif
environmentRadiance =
vec4f(radianceAnisotropic(alphaT,alphaB,reflectionSampler,reflectionSamplerSampler,
view,tangent,
bitangent,normal,
reflectionFilteringInfo,noise.xy),
1.0f);
#else
const samples: i32=16;var radianceSample=vec4f(0.0);var accumulatedRadiance=vec3f(0.0);var reflectionCoords=vec3f(0.0);var sample_weight=0.0f;var total_weight=0.0f;let step=1.0f/f32(max(samples-1,1));for (var i: i32=0; i<samples; i++) {var t: f32=mix(-1.0,1.0,f32(i)*step);t+=step*2.0*noise.x;sample_weight=max(1.0-abs(t),0.001);sample_weight*=sample_weight;t*=min(4.0*alphaT*geoInfo.anisotropy,1.0);var bentNormal: vec3f;if (t<0.0) {let blend: f32=t+1.0;bentNormal=normalize(mix(-geoInfo.anisotropicTangent,normalW,blend));} else if (t>0.0) {let blend: f32=t;bentNormal=normalize(mix(normalW,geoInfo.anisotropicTangent,blend));} else {bentNormal=normalW;}
reflectionCoords=createReflectionCoords(positionW,bentNormal);radianceSample=textureSampleLevel(reflectionSampler,reflectionSamplerSampler,reflectionCoords,reflectionLOD);
#ifdef RGBDREFLECTION
accumulatedRadiance+=vec3f(sample_weight)*fromRGBD(radianceSample);
#elif defined(GAMMAREFLECTION)
accumulatedRadiance+=vec3f(sample_weight)*toLinearSpace(radianceSample.rgb);
#else
accumulatedRadiance+=vec3f(sample_weight)*radianceSample.rgb;
#endif
total_weight+=sample_weight;}
environmentRadiance=vec4f(accumulatedRadiance/vec3f(total_weight),1.0f);
#endif
environmentRadiance=vec4f(environmentRadiance.rgb*reflectionInfos.xxx,environmentRadiance.a);return environmentRadiance.rgb;}
#endif
fn conductorIblFresnel(reflectance: ReflectanceParams,NdotV: f32,roughness: f32,environmentBrdf: vec3f)->vec3f
{
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
let albedoF0: vec3f=mix(reflectance.coloredF0,pow(reflectance.coloredF0,vec3f(1.4f)),roughness);return getF82Specular(NdotV,albedoF0,reflectance.coloredF90,roughness);
#else
return getReflectanceFromBRDFLookup(reflectance.coloredF0,reflectance.coloredF90,environmentBrdf);
#endif
}
#endif
`;S.IncludesShadersStoreWGSL[XE]||(S.IncludesShadersStoreWGSL[XE]=Vk);const YE="openpbrNormalMapFragment",Uk=`var uvOffset: vec2f= vec2f(0.0,0.0);
#if defined(GEOMETRY_NORMAL) || defined(GEOMETRY_COAT_NORMAL) || defined(PARALLAX) || defined(DETAIL)
#ifdef NORMALXYSCALE
var normalScale: f32=1.0;
#elif defined(GEOMETRY_NORMAL)
var normalScale: f32=uniforms.vGeometryNormalInfos.y;
#else
var normalScale: f32=1.0;
#endif
#if defined(TANGENT) && defined(NORMAL)
var TBN: mat3x3f=mat3x3<f32>(input.vTBN0,input.vTBN1,input.vTBN2); 
#elif defined(GEOMETRY_NORMAL)
var TBNUV: vec2f=select(-fragmentInputs.vGeometryNormalUV,fragmentInputs.vGeometryNormalUV,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW*normalScale,input.vPositionW,TBNUV,uniforms.vTangentSpaceParams);
#else
var TBNUV: vec2f=select(-fragmentInputs.vDetailUV,fragmentInputs.vDetailUV,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW*normalScale,input.vPositionW,TBNUV, vec2f(1.,1.));
#endif
#elif defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
var TBN: mat3x3f=mat3x3<f32>(input.vTBN0,input.vTBN1,input.vTBN2);
#else
var TBNUV: vec2f=select( -fragmentInputs.vMainUV1,fragmentInputs.vMainUV1,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW,input.vPositionW,TBNUV, vec2f(1.,1.));
#endif
#endif
#ifdef PARALLAX
var invTBN: mat3x3f=transposeMat3(TBN);
#ifdef PARALLAXOCCLUSION
#else
#endif
#endif
#ifdef DETAIL
var detailColor: vec4f=textureSample(detailSampler,detailSamplerSampler,fragmentInputs.vDetailUV+uvOffset);var detailNormalRG: vec2f=detailColor.wy*2.0-1.0;var detailNormalB: f32=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));var detailNormal: vec3f= vec3f(detailNormalRG,detailNormalB);
#endif
#ifdef GEOMETRY_COAT_NORMAL
coatNormalW=perturbNormal(TBN,textureSample(geometryCoatNormalSampler,geometryCoatNormalSamplerSampler,fragmentInputs.vGeometryCoatNormalUV+uvOffset).xyz,uniforms.vGeometryCoatNormalInfos.y);
#endif
#ifdef GEOMETRY_NORMAL
#ifdef OBJECTSPACE_NORMALMAP
#define CUSTOM_FRAGMENT_BUMP_FRAGMENT
normalW=normalize(textureSample(geometryNormalSampler,geometryNormalSamplerSampler,fragmentInputs.vGeometryNormalUV).xyz *2.0-1.0);normalW=normalize(mat3x3f(uniforms.normalMatrix[0].xyz,uniforms.normalMatrix[1].xyz,uniforms.normalMatrix[2].xyz)*normalW);
#elif !defined(DETAIL)
normalW=perturbNormal(TBN,textureSample(geometryNormalSampler,geometryNormalSamplerSampler,fragmentInputs.vGeometryNormalUV+uvOffset).xyz,uniforms.vGeometryNormalInfos.y);
#else
var sampledNormal: vec3f=textureSample(geometryNormalSampler,geometryNormalSamplerSampler,fragmentInputs.vGeometryNormalUV+uvOffset).xyz*2.0-1.0;
#if DETAIL_NORMALBLENDMETHOD==0 
detailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);var blendedNormal: vec3f=normalize( vec3f(sampledNormal.xy+detailNormal.xy,sampledNormal.z*detailNormal.z));
#elif DETAIL_NORMALBLENDMETHOD==1 
detailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);sampledNormal+= vec3f(0.0,0.0,1.0);detailNormal*= vec3f(-1.0,-1.0,1.0);var blendedNormal: vec3f=sampledNormal*dot(sampledNormal,detailNormal)/sampledNormal.z-detailNormal;
#endif
normalW=perturbNormalBase(TBN,blendedNormal,uniforms.vGeometryNormalInfos.y);
#endif
#elif defined(DETAIL)
detailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);normalW=perturbNormalBase(TBN,detailNormal,uniforms.vDetailInfos.z);
#endif
`;S.IncludesShadersStoreWGSL[YE]||(S.IncludesShadersStoreWGSL[YE]=Uk);const jE="openpbrBlockNormalFinal",kk=`#if defined(FORCENORMALFORWARD) && defined(NORMAL)
var faceNormal: vec3f=normalize(cross(dpdx(fragmentInputs.vPositionW),dpdy(fragmentInputs.vPositionW)))*scene.vEyePosition.w;
#if defined(TWOSIDEDLIGHTING)
faceNormal=select(-faceNormal,faceNormal,fragmentInputs.frontFacing);
#endif
normalW*=sign(dot(normalW,faceNormal));coatNormalW*=sign(dot(coatNormalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
#if defined(MIRRORED)
normalW=select(normalW,-normalW,fragmentInputs.frontFacing);coatNormalW=select(coatNormalW,-coatNormalW,fragmentInputs.frontFacing);
#else
normalW=select(-normalW,normalW,fragmentInputs.frontFacing);coatNormalW=select(-coatNormalW,coatNormalW,fragmentInputs.frontFacing);
#endif
#endif
`;S.IncludesShadersStoreWGSL[jE]||(S.IncludesShadersStoreWGSL[jE]=kk);const qE="openpbrBaseLayerData",Gk=`var base_color=vec3f(0.8);var base_metalness: f32=0.0;var base_diffuse_roughness: f32=0.0;var specular_weight: f32=1.0;var specular_roughness: f32=0.3;var specular_color: vec3f=vec3f(1.0);var specular_roughness_anisotropy: f32=0.0;var specular_ior: f32=1.5;var alpha: f32=1.0;var geometry_tangent: vec2f=vec2f(1.0,0.0);
#ifdef BASE_WEIGHT
let baseWeightFromTexture: vec4f=textureSample(baseWeightSampler,baseWeightSamplerSampler,fragmentInputs.vBaseWeightUV+uvOffset);
#endif
#ifdef BASE_COLOR
let baseColorFromTexture: vec4f=textureSample(baseColorSampler,baseColorSamplerSampler,fragmentInputs.vBaseColorUV+uvOffset);
#endif
#ifdef BASE_METALNESS
let metallicFromTexture: vec4f=textureSample(baseMetalnessSampler,baseMetalnessSamplerSampler,fragmentInputs.vBaseMetalnessUV+uvOffset);
#endif
#ifdef BASE_DIFFUSE_ROUGHNESS
let baseDiffuseRoughnessFromTexture: f32=textureSample(baseDiffuseRoughnessSampler,baseDiffuseRoughnessSamplerSampler,fragmentInputs.vBaseDiffuseRoughnessUV+uvOffset).r;
#endif
#ifdef GEOMETRY_TANGENT
let geometryTangentFromTexture: vec3f=textureSample(geometryTangentSampler,geometryTangentSamplerSampler,fragmentInputs.vGeometryTangentUV+uvOffset).rgb;
#endif
#ifdef SPECULAR_ROUGHNESS_ANISOTROPY
let anisotropyFromTexture: f32=textureSample(specularRoughnessAnisotropySampler,specularRoughnessAnisotropySamplerSampler,fragmentInputs.vSpecularRoughnessAnisotropyUV+uvOffset).r*uniforms.vSpecularRoughnessAnisotropyInfos.y;
#endif
#ifdef GEOMETRY_OPACITY
let opacityFromTexture: vec4f=textureSample(opacitySampler,opacitySamplerSampler,fragmentInputs.vOpacityUV+uvOffset);
#endif
#ifdef DECAL
let decalFromTexture: vec4f=textureSample(decalSampler,decalSamplerSampler,fragmentInputs.vDecalUV+uvOffset);
#endif
#ifdef SPECULAR_COLOR
let specularColorFromTexture: vec4f=textureSample(specularColorSampler,specularColorSamplerSampler,fragmentInputs.vSpecularColorUV+uvOffset);
#endif
#if defined(SPECULAR_WEIGHT)
#ifdef SPECULAR_WEIGHT_IN_ALPHA
let specularWeightFromTexture: f32=textureSample(specularWeightSampler,specularWeightSamplerSampler,fragmentInputs.vSpecularWeightUV+uvOffset).a;
#else
let specularWeightFromTexture: f32=textureSample(specularWeightSampler,specularWeightSamplerSampler,fragmentInputs.vSpecularWeightUV+uvOffset).r;
#endif
#endif
#ifdef ANISOTROPIC
let noise=textureSample(blueNoiseSampler,blueNoiseSamplerSampler,fragmentInputs.position.xy/256.0).xyz;
#endif
#if defined(ROUGHNESSSTOREINMETALMAPGREEN) && defined(BASE_METALNESS)
let roughnessFromTexture: f32=metallicFromTexture.g;
#elif defined(SPECULAR_ROUGHNESS)
let roughnessFromTexture: f32=textureSample(specularRoughnessSampler,specularRoughnessSamplerSampler,fragmentInputs.vSpecularRoughnessUV+uvOffset).r;
#endif
base_color=uniforms.vBaseColor.rgb;
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
base_color*=fragmentInputs.vColor.rgb;
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=fragmentInputs.vColor.a;
#endif
base_color*=vec3(uniforms.vBaseWeight);alpha=uniforms.vBaseColor.a;base_metalness=uniforms.vReflectanceInfo.x;base_diffuse_roughness=uniforms.vBaseDiffuseRoughness;specular_roughness=uniforms.vReflectanceInfo.y;specular_color=uniforms.vSpecularColor.rgb;specular_weight=uniforms.vReflectanceInfo.a;specular_ior=uniforms.vReflectanceInfo.z;specular_roughness_anisotropy=uniforms.vSpecularAnisotropy.b;geometry_tangent=uniforms.vSpecularAnisotropy.rg;
#ifdef BASE_COLOR
#ifdef BASE_COLOR_GAMMA
base_color*=toLinearSpace(baseColorFromTexture.rgb);
#else
base_color*=baseColorFromTexture.rgb;
#endif
base_color*=uniforms.vBaseColorInfos.y;
#endif
#ifdef BASE_WEIGHT
base_color*=baseWeightFromTexture.r;
#endif
#if defined(BASE_COLOR) && defined(ALPHA_FROM_BASE_COLOR_TEXTURE)
alpha*=baseColorFromTexture.a;
#elif defined(GEOMETRY_OPACITY)
alpha*=opacityFromTexture.a;alpha*=uniforms.vGeometryOpacityInfos.y;
#endif
#ifdef ALPHATEST
#if DEBUGMODE != 88
if (alpha<ALPHATESTVALUE)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
#ifdef BASE_METALNESS
#ifdef METALLNESSSTOREINMETALMAPBLUE
base_metalness*=metallicFromTexture.b;
#else
base_metalness*=metallicFromTexture.r;
#endif
#endif
#ifdef BASE_DIFFUSE_ROUGHNESS
base_diffuse_roughness*=baseDiffuseRoughnessFromTexture*uniforms.vBaseDiffuseRoughnessInfos.y;
#endif
#ifdef SPECULAR_COLOR
#ifdef SPECULAR_COLOR_GAMMA
specular_color*=toLinearSpace(specularColorFromTexture.rgb);
#else
specular_color*=specularColorFromTexture.rgb;
#endif
#endif
#ifdef SPECULAR_WEIGHT_FROM_SPECULAR_COLOR_TEXTURE
specular_weight*=specularColorFromTexture.a;
#elif defined(SPECULAR_WEIGHT)
specular_weight*=specularWeightFromTexture;
#endif
#if defined(SPECULAR_ROUGHNESS) || (defined(ROUGHNESSSTOREINMETALMAPGREEN) && defined(BASE_METALNESS))
specular_roughness*=roughnessFromTexture;
#endif
#ifdef GEOMETRY_TANGENT
{let tangentFromTexture: vec2f=normalize(geometryTangentFromTexture.xy*vec2f(2.0f)-vec2f(1.0f));let tangent_angle_texture: f32=atan2(tangentFromTexture.y,tangentFromTexture.x);let tangent_angle_uniform: f32=atan2(geometry_tangent.y,geometry_tangent.x);let tangent_angle: f32=tangent_angle_texture+tangent_angle_uniform;geometry_tangent=vec2f(cos(tangent_angle),sin(tangent_angle));}
#endif
#if defined(GEOMETRY_TANGENT) && defined(SPECULAR_ROUGHNESS_ANISOTROPY_FROM_TANGENT_TEXTURE)
specular_roughness_anisotropy*=geometryTangentFromTexture.b;
#elif defined(SPECULAR_ROUGHNESS_ANISOTROPY)
specular_roughness_anisotropy*=anisotropyFromTexture;
#endif
#ifdef DETAIL
let detailRoughness: f32=mix(0.5f,detailColor.b,vDetailInfos.w);let loLerp: f32=mix(0.f,specular_roughness,detailRoughness*2.f);let hiLerp: f32=mix(specular_roughness,1.f,(detailRoughness-0.5f)*2.f);specular_roughness=mix(loLerp,hiLerp,step(detailRoughness,0.5f));
#endif
#ifdef USE_GLTF_STYLE_ANISOTROPY
let baseAlpha: f32=specular_roughness*specular_roughness;let roughnessT: f32=mix(baseAlpha,1.0f,specular_roughness_anisotropy*specular_roughness_anisotropy);let roughnessB: f32=baseAlpha;specular_roughness_anisotropy=1.0f-roughnessB/max(roughnessT,0.00001f);specular_roughness=sqrt(roughnessT/sqrt(2.0f/(1.0f+(1.0f-specular_roughness_anisotropy)*(1.0f-specular_roughness_anisotropy))));
#endif
`;S.IncludesShadersStoreWGSL[qE]||(S.IncludesShadersStoreWGSL[qE]=Gk);const ZE="openpbrCoatLayerData",zk=`var coat_weight: f32=0.0f;var coat_color: vec3f=vec3f(1.0f);var coat_roughness: f32=0.0f;var coat_roughness_anisotropy: f32=0.0f;var coat_ior: f32=1.6f;var coat_darkening: f32=1.0f;var geometry_coat_tangent: vec2f=vec2f(1.0f,0.0f);
#ifdef COAT_WEIGHT
var coatWeightFromTexture: vec4f=textureSample(coatWeightSampler,coatWeightSamplerSampler,fragmentInputs.vCoatWeightUV+uvOffset);
#endif
#ifdef COAT_COLOR
var coatColorFromTexture: vec4f=textureSample(coatColorSampler,coatColorSamplerSampler,fragmentInputs.vCoatColorUV+uvOffset);
#endif
#ifdef COAT_ROUGHNESS
var coatRoughnessFromTexture: vec4f=textureSample(coatRoughnessSampler,coatRoughnessSamplerSampler,fragmentInputs.vCoatRoughnessUV+uvOffset);
#endif
#ifdef COAT_ROUGHNESS_ANISOTROPY
var coatRoughnessAnisotropyFromTexture: f32=textureSample(coatRoughnessAnisotropySampler,coatRoughnessAnisotropySamplerSampler,fragmentInputs.vCoatRoughnessAnisotropyUV+uvOffset).r;
#endif
#ifdef COAT_DARKENING
var coatDarkeningFromTexture: vec4f=textureSample(coatDarkeningSampler,coatDarkeningSamplerSampler,fragmentInputs.vCoatDarkeningUV+uvOffset);
#endif
#ifdef GEOMETRY_COAT_TANGENT
var geometryCoatTangentFromTexture: vec3f=textureSample(geometryCoatTangentSampler,geometryCoatTangentSamplerSampler,fragmentInputs.vGeometryCoatTangentUV+uvOffset).rgb;
#endif
coat_color=uniforms.vCoatColor.rgb;coat_weight=uniforms.vCoatWeight;coat_roughness=uniforms.vCoatRoughness;coat_roughness_anisotropy=uniforms.vCoatRoughnessAnisotropy;coat_ior=uniforms.vCoatIor;coat_darkening=uniforms.vCoatDarkening;geometry_coat_tangent=uniforms.vGeometryCoatTangent.rg;
#ifdef COAT_WEIGHT
coat_weight*=coatWeightFromTexture.r;
#endif
#ifdef COAT_COLOR
#ifdef COAT_COLOR_GAMMA
coat_color*=toLinearSpace(coatColorFromTexture.rgb);
#else
coat_color*=coatColorFromTexture.rgb;
#endif
coat_color*=uniforms.vCoatColorInfos.y;
#endif
#ifdef COAT_ROUGHNESS
coat_roughness*=coatRoughnessFromTexture.r;
#endif
#if defined(GEOMETRY_COAT_TANGENT) && defined(COAT_ROUGHNESS_ANISOTROPY_FROM_TANGENT_TEXTURE)
coat_roughness_anisotropy*=geometryCoatTangentFromTexture.b;
#elif defined(COAT_ROUGHNESS_ANISOTROPY)
coat_roughness_anisotropy*=coatRoughnessAnisotropyFromTexture;
#endif
#ifdef COAT_DARKENING
coat_darkening*=coatDarkeningFromTexture.r;
#endif
#ifdef GEOMETRY_COAT_TANGENT
{let tangentFromTexture: vec2f=normalize(geometryCoatTangentFromTexture.xy*vec2f(2.0f)-vec2f(1.0f));let tangent_angle_texture: f32=atan2(tangentFromTexture.y,tangentFromTexture.x);let tangent_angle_uniform: f32=atan2(geometry_coat_tangent.y,geometry_coat_tangent.x);let tangent_angle: f32=tangent_angle_texture+tangent_angle_uniform;geometry_coat_tangent=vec2f(cos(tangent_angle),sin(tangent_angle));}
#endif
#ifdef USE_GLTF_STYLE_ANISOTROPY
let coatAlpha: f32=coat_roughness*coat_roughness;let coatRoughnessT: f32=mix(coatAlpha,1.0f,coat_roughness_anisotropy*coat_roughness_anisotropy);let coatRoughnessB: f32=coatAlpha;coat_roughness_anisotropy=1.0f-coatRoughnessB/max(coatRoughnessT,0.00001f);coat_roughness=sqrt(coatRoughnessT/sqrt(2.0f/(1.0f+(1.0f-coat_roughness_anisotropy)*(1.0f-coat_roughness_anisotropy))));
#endif
`;S.IncludesShadersStoreWGSL[ZE]||(S.IncludesShadersStoreWGSL[ZE]=zk);const QE="openpbrThinFilmLayerData",Wk=`#ifdef THIN_FILM
var thin_film_weight: f32=uniforms.vThinFilmWeight;var thin_film_thickness: f32=uniforms.vThinFilmThickness.r*1000.0f; 
var thin_film_ior: f32=uniforms.vThinFilmIor;
#ifdef THIN_FILM_WEIGHT
var thinFilmWeightFromTexture: f32=textureSample(thinFilmWeightSampler,thinFilmWeightSamplerSampler,fragmentInputs.vThinFilmWeightUV+uvOffset).r*uniforms.vThinFilmWeightInfos.y;
#endif
#ifdef THIN_FILM_THICKNESS
var thinFilmThicknessFromTexture: f32=textureSample(thinFilmThicknessSampler,thinFilmThicknessSamplerSampler,fragmentInputs.vThinFilmThicknessUV+uvOffset).g*uniforms.vThinFilmThicknessInfos.y;
#endif
#ifdef THIN_FILM_WEIGHT
thin_film_weight*=thinFilmWeightFromTexture;
#endif
#ifdef THIN_FILM_THICKNESS
thin_film_thickness*=thinFilmThicknessFromTexture;
#endif
#endif
`;S.IncludesShadersStoreWGSL[QE]||(S.IncludesShadersStoreWGSL[QE]=Wk);const KE="openpbrEnvironmentLighting",Hk=`#ifdef REFLECTION
var baseDiffuseEnvironmentLight: vec3f=sampleIrradiance(
normalW
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,vEnvironmentIrradiance 
#endif
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
,uniforms.reflectionMatrix
#endif
#ifdef USEIRRADIANCEMAP
,irradianceSampler
,irradianceSamplerSampler
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
,uniforms.vReflectionDominantDirection
#endif
#endif
#ifdef REALTIME_FILTERING
,uniforms.vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,icdfSampler
,icdfSamplerSampler
#endif
#endif
,uniforms.vReflectionInfos
,viewDirectionW
,base_diffuse_roughness
,base_color
);
#ifdef REFLECTIONMAP_3D
var reflectionCoords: vec3f=vec3f(0.f,0.f,0.f);
#else
var reflectionCoords: vec2f=vec2f(0.f,0.f);
#endif
let specularAlphaG: f32=specular_roughness*specular_roughness;
#ifdef ANISOTROPIC_BASE
var baseSpecularEnvironmentLight: vec3f=sampleRadianceAnisotropic(specularAlphaG,uniforms.vReflectionMicrosurfaceInfos.rgb,uniforms.vReflectionInfos
,baseGeoInfo
,normalW
,viewDirectionW
,fragmentInputs.vPositionW
,noise
,reflectionSampler
,reflectionSamplerSampler
#ifdef REALTIME_FILTERING
,uniforms.vReflectionFilteringInfo
#endif
);
#else
reflectionCoords=createReflectionCoords(fragmentInputs.vPositionW,normalW);var baseSpecularEnvironmentLight: vec3f=sampleRadiance(specularAlphaG,uniforms.vReflectionMicrosurfaceInfos.rgb,uniforms.vReflectionInfos
,baseGeoInfo
,reflectionSampler
,reflectionSamplerSampler
,reflectionCoords
#ifdef REALTIME_FILTERING
,uniforms.vReflectionFilteringInfo
#endif
);
#endif
#ifdef ANISOTROPIC_BASE
baseSpecularEnvironmentLight=mix(baseSpecularEnvironmentLight.rgb,baseDiffuseEnvironmentLight,specularAlphaG*specularAlphaG *max(1.0f-baseGeoInfo.anisotropy,0.3f));
#else
baseSpecularEnvironmentLight=mix(baseSpecularEnvironmentLight.rgb,baseDiffuseEnvironmentLight,specularAlphaG);
#endif
var coatEnvironmentLight: vec3f=vec3f(0.f,0.f,0.f);if (coat_weight>0.0) {
#ifdef REFLECTIONMAP_3D
var reflectionCoords: vec3f=vec3f(0.f,0.f,0.f);
#else
var reflectionCoords: vec2f=vec2f(0.f,0.f);
#endif
reflectionCoords=createReflectionCoords(fragmentInputs.vPositionW,coatNormalW);var coatAlphaG: f32=coat_roughness*coat_roughness;
#ifdef ANISOTROPIC_COAT
coatEnvironmentLight=sampleRadianceAnisotropic(coatAlphaG,uniforms.vReflectionMicrosurfaceInfos.rgb,uniforms.vReflectionInfos
,coatGeoInfo
,coatNormalW
,viewDirectionW
,fragmentInputs.vPositionW
,noise
,reflectionSampler
,reflectionSamplerSampler
#ifdef REALTIME_FILTERING
,uniforms.vReflectionFilteringInfo
#endif
);
#else
coatEnvironmentLight=sampleRadiance(coatAlphaG,uniforms.vReflectionMicrosurfaceInfos.rgb,uniforms.vReflectionInfos
,coatGeoInfo
,reflectionSampler
,reflectionSamplerSampler
,reflectionCoords
#ifdef REALTIME_FILTERING
,uniforms.vReflectionFilteringInfo
#endif
);
#endif
}
let dielectricIblFresnel: f32=getReflectanceFromBRDFWithEnvLookup(vec3f(baseDielectricReflectance.F0),vec3f(baseDielectricReflectance.F90),baseGeoInfo.environmentBrdf).r;var dielectricIblColoredFresnel: vec3f=dielectricIblFresnel*specular_color;
#ifdef THIN_FILM
let thinFilmIorScale: f32=clamp(2.0f*abs(thin_film_ior-1.0f),0.0f,1.0f);let thin_film_dielectric: vec3f=evalIridescence(thin_film_outside_ior,thin_film_ior,baseGeoInfo.NdotV,thin_film_thickness,baseDielectricReflectance.coloredF0);dielectricIblColoredFresnel=mix(dielectricIblColoredFresnel,thin_film_dielectric*specular_color,thin_film_weight*thinFilmIorScale);
#endif
var conductorIblFresnel: vec3f=conductorIblFresnel(baseConductorReflectance,baseGeoInfo.NdotV,specular_roughness,baseGeoInfo.environmentBrdf);
#ifdef THIN_FILM
let thinFilmConductorFresnel: vec3f=specular_weight*evalIridescence(thin_film_outside_ior,thin_film_ior,baseGeoInfo.NdotV,thin_film_thickness,baseConductorReflectance.coloredF0);conductorIblFresnel=mix(conductorIblFresnel,thinFilmConductorFresnel,thin_film_weight*thinFilmIorScale);
#endif
var coatIblFresnel: f32=0.0;if (coat_weight>0.0) {coatIblFresnel=getReflectanceFromBRDFWithEnvLookup(vec3f(coatReflectance.F0),vec3f(coatReflectance.F90),coatGeoInfo.environmentBrdf).r;}
var slab_diffuse_ibl: vec3f=vec3f(0.,0.,0.);var slab_glossy_ibl: vec3f=vec3f(0.,0.,0.);var slab_metal_ibl: vec3f=vec3f(0.,0.,0.);var slab_coat_ibl: vec3f=vec3f(0.,0.,0.);slab_diffuse_ibl=baseDiffuseEnvironmentLight*uniforms.vLightingIntensity.z;slab_diffuse_ibl*=aoOut.ambientOcclusionColor;slab_glossy_ibl=baseSpecularEnvironmentLight*uniforms.vLightingIntensity.z;slab_metal_ibl=baseSpecularEnvironmentLight*conductorIblFresnel*uniforms.vLightingIntensity.z;var coatAbsorption=vec3f(1.0);if (coat_weight>0.0) {slab_coat_ibl=coatEnvironmentLight*uniforms.vLightingIntensity.z;let hemisphere_avg_fresnel: f32=coatReflectance.F0+0.5f*(1.0f-coatReflectance.F0);var averageReflectance: f32=(coatIblFresnel+hemisphere_avg_fresnel)*0.5f;let roughnessFactor=1.0f-coat_roughness*0.5f;averageReflectance*=roughnessFactor;var darkened_transmission: f32=(1.0f-averageReflectance)*(1.0f-averageReflectance);darkened_transmission=mix(1.0,darkened_transmission,coat_darkening);var sin2: f32=1.0f-coatGeoInfo.NdotV*coatGeoInfo.NdotV;sin2=sin2/(coat_ior*coat_ior);let cos_t: f32=sqrt(1.0f-sin2);let coatPathLength=1.0f/cos_t;let colored_transmission: vec3f=pow(coat_color,vec3f(coatPathLength));coatAbsorption=mix(vec3f(1.0f),colored_transmission*vec3f(darkened_transmission),coat_weight);}
var slab_subsurface_ibl: vec3f=vec3f(0.,0.,0.);var slab_translucent_base_ibl: vec3f=vec3f(0.,0.,0.);var slab_fuzz_ibl: vec3f=vec3f(0.,0.,0.);slab_diffuse_ibl*=base_color.rgb;
#define CUSTOM_FRAGMENT_BEFORE_IBLLAYERCOMPOSITION
let material_opaque_base_ibl: vec3f=mix(slab_diffuse_ibl,slab_subsurface_ibl,subsurface_weight);let material_dielectric_base_ibl: vec3f=mix(material_opaque_base_ibl,slab_translucent_base_ibl,transmission_weight);let material_dielectric_gloss_ibl: vec3f=material_dielectric_base_ibl*(1.0-dielectricIblFresnel)+slab_glossy_ibl*dielectricIblColoredFresnel;let material_base_substrate_ibl: vec3f=mix(material_dielectric_gloss_ibl,slab_metal_ibl,base_metalness);let material_coated_base_ibl: vec3f=layer(material_base_substrate_ibl,slab_coat_ibl,coatIblFresnel,coatAbsorption,vec3f(1.0f));material_surface_ibl=mix(material_coated_base_ibl,slab_fuzz_ibl,fuzz_weight);
#endif
`;S.IncludesShadersStoreWGSL[KE]||(S.IncludesShadersStoreWGSL[KE]=Hk);const JE="openpbrDirectLightingInit",$k=`#ifdef LIGHT{X}
var preInfo{X}: preLightingInfo;var preInfoCoat{X}: preLightingInfo;let lightColor{X}: vec4f=light{X}.vLightDiffuse;var shadow{X}: f32=1.0f;
#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})
#else
#define CUSTOM_LIGHT{X}_COLOR 
#ifdef SPOTLIGHT{X}
preInfo{X}=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,vPositionW);preInfoCoat{X}=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,coatNormalW,vPositionW);
#elif defined(POINTLIGHT{X})
preInfo{X}=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,vPositionW);preInfoCoat{X}=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,coatNormalW,vPositionW);
#elif defined(HEMILIGHT{X})
preInfo{X}=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);preInfoCoat{X}=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,coatNormalW);
#elif defined(DIRLIGHT{X})
preInfo{X}=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);preInfoCoat{X}=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,coatNormalW);
#elif defined(AREALIGHT{X}) && defined(AREALIGHTSUPPORTED)
preInfo{X}=computeAreaPreLightingInfo(areaLightsLTC1Sampler,areaLightsLTC2Sampler,viewDirectionW,normalW,vPositionW,light{X}.vLightData,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,specular_roughness);preInfoCoat{X}=computeAreaPreLightingInfo(areaLightsLTC1Sampler,areaLightsLTC2Sampler,viewDirectionW,coatNormalW,vPositionW,light{X}.vLightData,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,coat_roughness);
#endif
preInfo{X}.NdotV=baseGeoInfo.NdotV;preInfoCoat{X}.NdotV=coatGeoInfo.NdotV;
#ifdef SPOTLIGHT{X}
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo{X}.attenuation=computeDistanceLightFalloff_GLTF(preInfo{X}.lightDistanceSquared,light{X}.vLightFalloff.y);
#ifdef IESLIGHTTEXTURE{X}
preInfo{X}.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo{X}.L,iesLightTexture{X});
#else
preInfo{X}.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo{X}.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo{X}.attenuation=computeDistanceLightFalloff_Physical(preInfo{X}.lightDistanceSquared);
#ifdef IESLIGHTTEXTURE{X}
preInfo{X}.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo{X}.L,iesLightTexture{X});
#else
preInfo{X}.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo{X}.L,light{X}.vLightDirection.w);
#endif
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo{X}.attenuation=computeDistanceLightFalloff_Standard(preInfo{X}.lightOffset,light{X}.vLightFalloff.x);
#ifdef IESLIGHTTEXTURE{X}
preInfo{X}.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo{X}.L,iesLightTexture{X});
#else
preInfo{X}.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo{X}.L,light{X}.vLightDirection.w,light{X}.vLightData.w);
#endif
#else
preInfo{X}.attenuation=computeDistanceLightFalloff(preInfo{X}.lightOffset,preInfo{X}.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#ifdef IESLIGHTTEXTURE{X}
preInfo{X}.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo{X}.L,iesLightTexture{X});
#else
preInfo{X}.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo{X}.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#endif
#elif defined(POINTLIGHT{X})
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo{X}.attenuation=computeDistanceLightFalloff_GLTF(preInfo{X}.lightDistanceSquared,light{X}.vLightFalloff.y);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo{X}.attenuation=computeDistanceLightFalloff_Physical(preInfo{X}.lightDistanceSquared);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo{X}.attenuation=computeDistanceLightFalloff_Standard(preInfo{X}.lightOffset,light{X}.vLightFalloff.x);
#else
preInfo{X}.attenuation=computeDistanceLightFalloff(preInfo{X}.lightOffset,preInfo{X}.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#endif
#else
preInfo{X}.attenuation=1.0f;
#endif
preInfoCoat{X}.attenuation=preInfo{X}.attenuation;
#if defined(HEMILIGHT{X}) || defined(AREALIGHT{X})
preInfo{X}.roughness=specular_roughness;preInfoCoat{X}.roughness=coat_roughness;
#else
preInfo{X}.roughness=adjustRoughnessFromLightProperties(specular_roughness,light{X}.vLightSpecular.a,preInfo{X}.lightDistance);preInfoCoat{X}.roughness=adjustRoughnessFromLightProperties(coat_roughness,light{X}.vLightSpecular.a,preInfoCoat{X}.lightDistance);
#endif
preInfo{X}.diffuseRoughness=base_diffuse_roughness;preInfo{X}.surfaceAlbedo=base_color.rgb;
#endif
#endif
`;S.IncludesShadersStoreWGSL[JE]||(S.IncludesShadersStoreWGSL[JE]=$k);const eT="openpbrDirectLighting",Xk=`#ifdef LIGHT{X}
{var slab_diffuse: vec3f=vec3f(0.f,0.f,0.f);var slab_subsurface: vec3f=vec3f(0.f,0.f,0.f);var slab_translucent: vec3f=vec3f(0.f,0.f,0.f);var slab_glossy: vec3f=vec3f(0.f,0.f,0.f);var specularFresnel: f32=0.0f;var specularColoredFresnel: vec3f=vec3f(0.f,0.f,0.f);var slab_metal: vec3f=vec3f(0.f,0.f,0.f);var slab_coat: vec3f=vec3f(0.f,0.f,0.f);var coatFresnel: f32=0.0f;var slab_fuzz: vec3f=vec3f(0.f,0.f,0.f);
#ifdef HEMILIGHT{X}
slab_diffuse=computeHemisphericDiffuseLighting(preInfo{X},lightColor{X}.rgb,light{X}.vLightGround);
#elif defined(AREALIGHT{X})
slab_diffuse=computeAreaDiffuseLighting(preInfo{X},lightColor{X}.rgb);
#else
slab_diffuse=computeDiffuseLighting(preInfo{X},lightColor{X}.rgb);
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
slab_diffuse*=computeProjectionTextureDiffuseLighting(projectionLightTexture{X},textureProjectionMatrix{X},vPositionW);
#endif
numLights+=1.0f;
#if AREALIGHT{X}
slab_glossy=computeAreaSpecularLighting(preInfo{X},light{X}.vLightSpecular.rgb,baseConductorReflectance.F0,baseConductorReflectance.F90);
#else
{
#ifdef ANISOTROPIC_BASE
slab_glossy=computeAnisotropicSpecularLighting(preInfo{X},viewDirectionW,normalW,
baseGeoInfo.anisotropicTangent,baseGeoInfo.anisotropicBitangent,baseGeoInfo.anisotropy,
0.0f,lightColor{X}.rgb);
#else
slab_glossy=computeSpecularLighting(preInfo{X},normalW,vec3(1.0),vec3(1.0),specular_roughness,lightColor{X}.rgb);
#endif
let NdotH: f32=dot(normalW,preInfo{X}.H);specularFresnel=fresnelSchlickGGX(NdotH,baseDielectricReflectance.F0,baseDielectricReflectance.F90);specularColoredFresnel=specularFresnel*specular_color;
#ifdef THIN_FILM
let thinFilmIorScale: f32=clamp(2.0f*abs(thin_film_ior-1.0f),0.0f,1.0f);let thinFilmDielectricFresnel: vec3f=evalIridescence(thin_film_outside_ior,thin_film_ior,preInfo{X}.VdotH,thin_film_thickness,baseDielectricReflectance.coloredF0);specularColoredFresnel=mix(specularColoredFresnel,thinFilmDielectricFresnel*specular_color,thin_film_weight*thinFilmIorScale);
#endif
}
#endif
#if AREALIGHT{X}
slab_metal=computeAreaSpecularLighting(preInfo{X},light{X}.vLightSpecular.rgb,baseConductorReflectance.F0,baseConductorReflectance.F90);
#else
{
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
var coloredFresnel: vec3f=getF82Specular(preInfo{X}.VdotH,baseConductorReflectance.coloredF0,baseConductorReflectance.coloredF90,specular_roughness);
#else
var coloredFresnel: vec3f=fresnelSchlickGGX(preInfo{X}.VdotH,baseConductorReflectance.coloredF0,baseConductorReflectance.coloredF90);
#endif
#ifdef THIN_FILM
let thinFilmIorScale: f32=clamp(2.0f*abs(thin_film_ior-1.0f),0.0f,1.0f);let thinFilmConductorFresnel=evalIridescence(thin_film_outside_ior,thin_film_ior,preInfo{X}.VdotH,thin_film_thickness,baseConductorReflectance.coloredF0);coloredFresnel=mix(coloredFresnel,specular_weight*thinFilmIorScale*thinFilmConductorFresnel,thin_film_weight);
#endif
#ifdef ANISOTROPIC_BASE
slab_metal=computeAnisotropicSpecularLighting(preInfo{X},viewDirectionW,normalW,baseGeoInfo.anisotropicTangent,baseGeoInfo.anisotropicBitangent,baseGeoInfo.anisotropy,0.0,lightColor{X}.rgb);
#else
slab_metal=computeSpecularLighting(preInfo{X},normalW,vec3f(baseConductorReflectance.coloredF0),coloredFresnel,specular_roughness,lightColor{X}.rgb);
#endif
}
#endif
#if AREALIGHT{X}
slab_coat=computeAreaSpecularLighting(preInfoCoat{X},light{X}.vLightSpecular.rgb,coatReflectance.F0,coatReflectance.F90);
#else
{
#ifdef ANISOTROPIC_COAT
slab_coat=computeAnisotropicSpecularLighting(preInfoCoat{X},viewDirectionW,coatNormalW,
coatGeoInfo.anisotropicTangent,coatGeoInfo.anisotropicBitangent,coatGeoInfo.anisotropy,0.0,
lightColor{X}.rgb);
#else
slab_coat=computeSpecularLighting(preInfoCoat{X},coatNormalW,vec3f(coatReflectance.F0),vec3f(1.0f),coat_roughness,lightColor{X}.rgb);
#endif
let NdotH: f32=dot(coatNormalW,preInfoCoat{X}.H);coatFresnel=fresnelSchlickGGX(NdotH,coatReflectance.F0,coatReflectance.F90);}
#endif
var coatAbsorption=vec3f(1.0f);if (coat_weight>0.0) {let cosTheta_view: f32=max(preInfoCoat{X}.NdotV,0.001f);let cosTheta_light: f32=max(preInfoCoat{X}.NdotL,0.001f);let fresnel_view: f32=coatReflectance.F0+(1.0f-coatReflectance.F0)*pow(1.0f-cosTheta_view,5.0);let fresnel_light: f32=coatReflectance.F0+(1.0f-coatReflectance.F0)*pow(1.0f-cosTheta_light,5.0);let averageReflectance: f32=(fresnel_view+fresnel_light)*0.5;var darkened_transmission: f32=(1.0f-averageReflectance)/(1.0f+averageReflectance);darkened_transmission=mix(1.0f,darkened_transmission,coat_darkening);var sin2: f32=1.0f-coatGeoInfo.NdotV*coatGeoInfo.NdotV;sin2=sin2/(coat_ior*coat_ior);let cos_t: f32=sqrt(1.0f-sin2);let coatPathLength=1.0f/cos_t;let colored_transmission: vec3f=pow(coat_color,vec3f(coatPathLength));coatAbsorption=mix(vec3f(1.0f),colored_transmission*vec3f(darkened_transmission),coat_weight);}
slab_diffuse*=base_color.rgb;let material_opaque_base: vec3f=mix(slab_diffuse,slab_subsurface,subsurface_weight);let material_dielectric_base: vec3f=mix(material_opaque_base,slab_translucent,transmission_weight);let material_dielectric_gloss: vec3f=material_dielectric_base*(1.0f-specularFresnel)+slab_glossy*specularColoredFresnel;let material_base_substrate: vec3f=mix(material_dielectric_gloss,slab_metal,base_metalness);let material_coated_base: vec3f=layer(material_base_substrate,slab_coat,coatFresnel,coatAbsorption,vec3f(1.0));material_surface_direct+=mix(material_coated_base,slab_fuzz,fuzz_weight);}
#endif
`;S.IncludesShadersStoreWGSL[eT]||(S.IncludesShadersStoreWGSL[eT]=Xk);const Kd="openpbrPixelShader",NA=`#define OPENPBR_FRAGMENT_SHADER
#define CUSTOM_FRAGMENT_BEGIN
#include<prePassDeclaration>[SCENE_MRT_COUNT]
#include<oitDeclaration>
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE
#endif
#include<openpbrUboDeclaration>
#include<pbrFragmentExtraDeclaration>
#include<lightUboDeclaration>[0..maxSimultaneousLights]
#include<openpbrFragmentSamplersDeclaration>
#include<imageProcessingDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<importanceSampling>
#include<pbrHelperFunctions>
#include<imageProcessingFunctions>
#include<shadowsFragmentFunctions>
#include<harmonicsFunctions>
#include<pbrDirectLightingSetupFunctions>
#include<pbrDirectLightingFalloffFunctions>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
#include<pbrDirectLightingFunctions>
#include<pbrIBLFunctions>
#include<openpbrNormalMapFragmentMainFunctions>
#include<openpbrNormalMapFragmentFunctions>
#ifdef REFLECTION
#include<reflectionFunction>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
#include<openpbrDielectricReflectance>
#include<openpbrConductorReflectance>
#include<openpbrBlockAmbientOcclusion>
#include<openpbrGeometryInfo>
#include<openpbrIblFunctions>
fn layer(slab_bottom: vec3f,slab_top: vec3f,lerp_factor: f32,bottom_multiplier: vec3f,top_multiplier: vec3f)->vec3f {return mix(slab_bottom*bottom_multiplier,slab_top*top_multiplier,lerp_factor);}
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#include<pbrBlockNormalGeometric>
var coatNormalW: vec3f=normalW;
#include<openpbrNormalMapFragment>
#include<openpbrBlockNormalFinal>
#include<openpbrBaseLayerData>
#include<openpbrCoatLayerData>
#include<openpbrThinFilmLayerData>
var subsurface_weight: f32=0.0f;var transmission_weight: f32=0.0f;var fuzz_weight: f32=0.0f;
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
#include<depthPrePass>
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
var aoOut: ambientOcclusionOutParams;
#ifdef AMBIENT_OCCLUSION
var ambientOcclusionFromTexture: vec3f=textureSample(ambientOcclusionSampler,ambientOcclusionSamplerSampler,fragmentInputs.vAmbientOcclusionUV+uvOffset).rgb;
#endif
aoOut=ambientOcclusionBlock(
#ifdef AMBIENT_OCCLUSION
ambientOcclusionFromTexture,
uniforms.vAmbientOcclusionInfos
#endif
);
#ifdef ANISOTROPIC_COAT
let coatGeoInfo: geometryInfoAnisoOutParams=geometryInfoAniso(
coatNormalW,viewDirectionW.xyz,coat_roughness,geometricNormalW
,vec3f(geometry_coat_tangent.x,geometry_coat_tangent.y,coat_roughness_anisotropy),TBN
);
#else
let coatGeoInfo: geometryInfoOutParams=geometryInfo(
coatNormalW,viewDirectionW.xyz,coat_roughness,geometricNormalW
);
#endif
specular_roughness=mix(specular_roughness,pow(min(1.0f,pow(specular_roughness,4.0f)+2.0f*pow(coat_roughness,4.0f)),0.25f),coat_weight);
#ifdef ANISOTROPIC_BASE
let baseGeoInfo: geometryInfoAnisoOutParams=geometryInfoAniso(
normalW,viewDirectionW.xyz,specular_roughness,geometricNormalW
,vec3f(geometry_tangent.x,geometry_tangent.y,specular_roughness_anisotropy),TBN
);
#else
let baseGeoInfo: geometryInfoOutParams=geometryInfo(
normalW,viewDirectionW.xyz,specular_roughness,geometricNormalW
);
#endif
let coatReflectance: ReflectanceParams=dielectricReflectance(
coat_ior 
,1.0f 
,vec3f(1.0f)
,coat_weight
);
#ifdef THIN_FILM
let thin_film_outside_ior: f32=mix(1.0f,coat_ior,coat_weight);
#endif
let baseDielectricReflectance: ReflectanceParams=dielectricReflectance(
specular_ior 
,mix(1.0f,coat_ior,coat_weight) 
,specular_color
,specular_weight
);let baseConductorReflectance: ReflectanceParams=conductorReflectance(base_color,specular_color,specular_weight);var material_surface_ibl: vec3f=vec3f(0.f,0.f,0.f);
#include<openpbrEnvironmentLighting>
var material_surface_direct: vec3f=vec3f(0.f,0.f,0.f);
#if defined(LIGHT0)
var aggShadow: f32=0.f;var numLights: f32=0.f;
#include<openpbrDirectLightingInit>[0..maxSimultaneousLights]
#include<openpbrDirectLighting>[0..maxSimultaneousLights]
#endif
var material_surface_emission: vec3f=uniforms.vEmissionColor;
#ifdef EMISSION_COLOR
let emissionColorTex: vec3f=textureSample(emissionColorSampler,emissionColorSamplerSampler,uniforms.vEmissionColorUV+uvOffset).rgb;
#ifdef EMISSION_COLOR_GAMMA
material_surface_emission*=toLinearSpace(emissionColorTex.rgb);
#else
material_surface_emission*=emissionColorTex.rgb;
#endif
material_surface_emission*= uniforms.vEmissionColorInfos.y;
#endif
material_surface_emission*=uniforms.vLightingIntensity.y;
#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION
var finalColor: vec4f=vec4f(material_surface_ibl+material_surface_direct+material_surface_emission,alpha);
#define CUSTOM_FRAGMENT_BEFORE_FOG
finalColor=max(finalColor,vec4f(0.0));
#include<logDepthFragment>
#include<fogFragment>(color,finalColor)
#include<pbrBlockImageProcessing>
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
#include<pbrBlockPrePass>
#endif
#if !defined(PREPASS) && !defined(ORDER_INDEPENDENT_TRANSPARENCY)
fragmentOutputs.color=finalColor;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {fragmentOutputs.frontColor=vec4f(fragmentOutputs.frontColor.rgb+finalColor.rgb*finalColor.a*alphaMultiplier,1.0-alphaMultiplier*(1.0-finalColor.a));} else {fragmentOutputs.backColor+=finalColor;}
#endif
#include<pbrDebug>
#define CUSTOM_FRAGMENT_MAIN_END
}
`;S.ShadersStoreWGSL[Kd]||(S.ShadersStoreWGSL[Kd]=NA);const Yk={name:Kd,shader:NA},jk=Object.freeze(Object.defineProperty({__proto__:null,openpbrPixelShaderWGSL:Yk},Symbol.toStringTag,{value:"Module"})),tT="openpbrVertexDeclaration",qk=`uniform mat4 view;uniform mat4 viewProjection;uniform vec4 vEyePosition;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif
#ifdef BASE_COLOR
uniform vec2 vBaseColorInfos;uniform mat4 baseColorMatrix;
#endif
#ifdef BASE_WEIGHT
uniform mat4 baseWeightMatrix;uniform vec2 vBaseWeightInfos;
#endif
uniform float vBaseDiffuseRoughness;
#ifdef BASE_DIFFUSE_ROUGHNESS
uniform mat4 baseDiffuseRoughnessMatrix;uniform vec2 vBaseDiffuseRoughnessInfos;
#endif
#ifdef AMBIENT_OCCLUSION
uniform vec2 vAmbientOcclusionInfos;uniform mat4 ambientOcclusionMatrix;
#endif
#ifdef EMISSION_COLOR
uniform vec2 vEmissionColorInfos;uniform mat4 emissionColorMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;
#endif
#ifdef BASE_METALNESS
uniform vec2 vBaseMetalnessInfos;uniform mat4 baseMetalnessMatrix;
#endif
#ifdef SPECULAR_WEIGHT
uniform vec2 vSpecularWeightInfos;uniform mat4 specularWeightMatrix;
#endif
#ifdef SPECULAR_COLOR
uniform vec2 vSpecularColorInfos;uniform mat4 specularColorMatrix;
#endif
#ifdef SPECULAR_ROUGHNESS
uniform vec2 vSpecularRoughnessInfos;uniform mat4 specularRoughnessMatrix;
#endif
#ifdef SPECULAR_ROUGHNESS_ANISOTROPY
uniform vec2 vSpecularRoughnessAnisotropyInfos;uniform mat4 specularRoughnessAnisotropyMatrix;
#endif
#ifdef COAT_WEIGHT
uniform vec2 vCoatWeightInfos;uniform mat4 coatWeightMatrix;
#endif
#ifdef COAT_COLOR
uniform vec2 vCoatColorInfos;uniform mat4 coatColorMatrix;
#endif
#ifdef COAT_ROUGHNESS
uniform vec2 vCoatRoughnessInfos;uniform mat4 coatRoughnessMatrix;
#endif
#ifdef COAT_ROUGHNESS_ANISOTROPY
uniform vec2 vCoatRoughnessAnisotropyInfos;uniform mat4 coatRoughnessAnisotropyMatrix;
#endif
#ifdef COAT_IOR
uniform vec2 vCoatIorInfos;uniform mat4 coatIorMatrix;
#endif
#ifdef COAT_DARKENING
uniform vec2 vCoatDarkeningInfos;uniform mat4 coatDarkeningMatrix;
#endif
#ifdef GEOMETRY_NORMAL
uniform vec2 vGeometryNormalInfos;uniform mat4 geometryNormalMatrix;
#endif
#ifdef GEOMETRY_TANGENT
uniform vec2 vGeometryTangentInfos;uniform mat4 geometryTangentMatrix;
#endif
#ifdef GEOMETRY_COAT_NORMAL
uniform vec2 vGeometryCoatNormalInfos;uniform mat4 geometryCoatNormalMatrix;
#endif
#ifdef THIN_FILM_WEIGHT
uniform vec2 vThinFilmWeightInfos;uniform mat4 thinFilmWeightMatrix;
#endif
#ifdef THIN_FILM_THICKNESS
uniform vec2 vThinFilmThicknessInfos;uniform mat4 thinFilmThicknessMatrix;
#endif
#ifdef GEOMETRY_OPACITY
uniform mat4 geometryOpacityMatrix;uniform vec2 vGeometryOpacityInfos;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
uniform vec4 cameraInfo;
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;
#endif
#ifdef NORMAL
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;
#endif
#endif
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;uniform mat4 detailMatrix;
#endif
#include<decalVertexDeclaration>
#define ADDITIONAL_VERTEX_DECLARATION
`;S.IncludesShadersStore[tT]||(S.IncludesShadersStore[tT]=qk);const iT="openpbrUboDeclaration",Zk=`layout(std140,column_major) uniform;uniform Material {vec2 vTangentSpaceParams;vec4 vLightingIntensity;float pointSize;vec2 vDebugMode;vec4 cameraInfo;vec2 vReflectionInfos;mat4 reflectionMatrix;vec3 vReflectionMicrosurfaceInfos;vec3 vReflectionPosition;vec3 vReflectionSize;vec2 vReflectionFilteringInfo;vec3 vReflectionDominantDirection;vec3 vReflectionColor;vec3 vSphericalL00;vec3 vSphericalL1_1;vec3 vSphericalL10;vec3 vSphericalL11;vec3 vSphericalL2_2;vec3 vSphericalL2_1;vec3 vSphericalL20;vec3 vSphericalL21;vec3 vSphericalL22;vec3 vSphericalX;vec3 vSphericalY;vec3 vSphericalZ;vec3 vSphericalXX_ZZ;vec3 vSphericalYY_ZZ;vec3 vSphericalZZ;vec3 vSphericalXY;vec3 vSphericalYZ;vec3 vSphericalZX;float vBaseWeight;vec4 vBaseColor;float vBaseDiffuseRoughness;vec4 vReflectanceInfo;vec4 vSpecularColor;vec3 vSpecularAnisotropy;float vCoatWeight;vec3 vCoatColor;float vCoatRoughness;float vCoatRoughnessAnisotropy;float vCoatIor;float vCoatDarkening;vec2 vGeometryCoatTangent;vec3 vEmissionColor;float vThinFilmWeight;vec2 vThinFilmThickness;float vThinFilmIor;vec2 vBaseWeightInfos;mat4 baseWeightMatrix;vec2 vBaseColorInfos;mat4 baseColorMatrix;vec2 vBaseDiffuseRoughnessInfos;mat4 baseDiffuseRoughnessMatrix;vec2 vBaseMetalnessInfos;mat4 baseMetalnessMatrix;vec2 vSpecularWeightInfos;mat4 specularWeightMatrix;vec2 vSpecularColorInfos;mat4 specularColorMatrix;vec2 vSpecularRoughnessInfos;mat4 specularRoughnessMatrix;vec2 vSpecularRoughnessAnisotropyInfos;mat4 specularRoughnessAnisotropyMatrix;vec2 vCoatWeightInfos;mat4 coatWeightMatrix;vec2 vCoatColorInfos;mat4 coatColorMatrix;vec2 vCoatRoughnessInfos;mat4 coatRoughnessMatrix;vec2 vCoatRoughnessAnisotropyInfos;mat4 coatRoughnessAnisotropyMatrix;vec2 vCoatDarkeningInfos;mat4 coatDarkeningMatrix;vec2 vGeometryNormalInfos;mat4 geometryNormalMatrix;vec2 vGeometryTangentInfos;mat4 geometryTangentMatrix;vec2 vGeometryCoatNormalInfos;mat4 geometryCoatNormalMatrix;vec2 vGeometryCoatTangentInfos;mat4 geometryCoatTangentMatrix;vec2 vGeometryOpacityInfos;mat4 geometryOpacityMatrix;vec2 vEmissionColorInfos;mat4 emissionColorMatrix;vec2 vThinFilmWeightInfos;mat4 thinFilmWeightMatrix;vec2 vThinFilmThicknessInfos;mat4 thinFilmThicknessMatrix;vec2 vAmbientOcclusionInfos;mat4 ambientOcclusionMatrix;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;S.IncludesShadersStore[iT]||(S.IncludesShadersStore[iT]=Zk);const rT="openpbrNormalMapVertexDeclaration",Qk=`#if defined(GEOMETRY_NORMAL) || defined(PARALLAX) || defined(GEOMETRY_COAT_NORMAL) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#endif
`;S.IncludesShadersStore[rT]||(S.IncludesShadersStore[rT]=Qk);const sT="openpbrNormalMapVertex",Kk=`#if defined(GEOMETRY_NORMAL) || defined(PARALLAX) || defined(GEOMETRY_COAT_NORMAL) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
vec3 tbnNormal=normalize(normalUpdated);vec3 tbnTangent=normalize(tangentUpdated.xyz);vec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;vTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);
#endif
#endif
`;S.IncludesShadersStore[sT]||(S.IncludesShadersStore[sT]=Kk);const Jd="openpbrVertexShader",DA=`#define OPENPBR_VERTEX_SHADER
#define CUSTOM_VERTEX_EXTENSION
precision highp float;
#include<__decl__openpbrVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#include<mainUVVaryingDeclaration>[1..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<pbrBRDFFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_COLOR,_VARYINGNAME_,BaseColor)
#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight)
#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_METALNESS,_VARYINGNAME_,BaseMetalness)
#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR_WEIGHT,_VARYINGNAME_,SpecularWeight)
#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR_COLOR,_VARYINGNAME_,SpecularColor)
#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR_ROUGHNESS,_VARYINGNAME_,SpecularRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,SpecularRoughnessAnisotropy)
#include<samplerVertexDeclaration>(_DEFINENAME_,COAT_WEIGHT,_VARYINGNAME_,CoatWeight)
#include<samplerVertexDeclaration>(_DEFINENAME_,COAT_COLOR,_VARYINGNAME_,CoatColor)
#include<samplerVertexDeclaration>(_DEFINENAME_,COAT_ROUGHNESS,_VARYINGNAME_,CoatRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,COAT_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,CoatRoughnessAnisotropy)
#include<samplerVertexDeclaration>(_DEFINENAME_,COAT_DARKENING,_VARYINGNAME_,CoatDarkening)
#include<samplerVertexDeclaration>(_DEFINENAME_,GEOMETRY_NORMAL,_VARYINGNAME_,GeometryNormal)
#include<samplerVertexDeclaration>(_DEFINENAME_,GEOMETRY_TANGENT,_VARYINGNAME_,GeometryTangent)
#include<samplerVertexDeclaration>(_DEFINENAME_,GEOMETRY_COAT_NORMAL,_VARYINGNAME_,GeometryCoatNormal)
#include<samplerVertexDeclaration>(_DEFINENAME_,GEOMETRY_OPACITY,_VARYINGNAME_,GeometryOpacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSION_COLOR,_VARYINGNAME_,EmissionColor)
#include<samplerVertexDeclaration>(_DEFINENAME_,THIN_FILM_WEIGHT,_VARYINGNAME_,ThinFilmWeight)
#include<samplerVertexDeclaration>(_DEFINENAME_,THIN_FILM_THICKNESS,_VARYINGNAME_,ThinFilmThickness)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT_OCCLUSION,_VARYINGNAME_,AmbientOcclusion)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#include<harmonicsFunctions>
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<openpbrNormalMapVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#ifdef UV2
vec2 uv2Updated=uv2;
#endif
#ifdef VERTEXCOLOR
vec4 colorUpdated=color;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);vPositionW=vec3(worldPos);
#ifdef PREPASS
#include<prePassVertex>
#endif
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
#if BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LAMBERT && BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LEGACY
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#if !defined(NATIVE) && !defined(WEBGPU)
bool bbb=any(isnan(position));if (bbb) { }
#endif
float NdotV=max(dot(vNormalW,viewDirectionW),0.0);vec3 roughNormal=mix(vNormalW,viewDirectionW,(0.5*(1.0-NdotV))*vBaseDiffuseRoughness);vec3 reflectionVector=vec3(reflectionMatrix*vec4(roughNormal,0)).xyz;
#else
vec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
#if DEBUGMODE>0
vClipSpacePosition=gl_Position;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2Updated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#ifdef MAINUV2
vMainUV2=uv2Updated;
#endif
#include<uvVariableDeclaration>[3..7]
#include<samplerVertexImplementation>(_DEFINENAME_,BASE_COLOR,_VARYINGNAME_,BaseColor,_MATRIXNAME_,baseColor,_INFONAME_,BaseColorInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight,_MATRIXNAME_,baseWeight,_INFONAME_,BaseWeightInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness,_MATRIXNAME_,baseDiffuseRoughness,_INFONAME_,BaseDiffuseRoughnessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BASE_METALNESS,_VARYINGNAME_,BaseMetalness,_MATRIXNAME_,baseMetalness,_INFONAME_,BaseMetalnessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR_WEIGHT,_VARYINGNAME_,SpecularWeight,_MATRIXNAME_,specularWeight,_INFONAME_,SpecularWeightInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR_COLOR,_VARYINGNAME_,SpecularColor,_MATRIXNAME_,specularColor,_INFONAME_,SpecularColorInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR_ROUGHNESS,_VARYINGNAME_,SpecularRoughness,_MATRIXNAME_,specularRoughness,_INFONAME_,SpecularRoughnessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,SpecularRoughnessAnisotropy,_MATRIXNAME_,specularRoughnessAnisotropy,_INFONAME_,SpecularRoughnessAnisotropyInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,COAT_WEIGHT,_VARYINGNAME_,CoatWeight,_MATRIXNAME_,coatWeight,_INFONAME_,CoatWeightInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,COAT_COLOR,_VARYINGNAME_,CoatColor,_MATRIXNAME_,coatColor,_INFONAME_,CoatColorInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,COAT_ROUGHNESS,_VARYINGNAME_,CoatRoughness,_MATRIXNAME_,coatRoughness,_INFONAME_,CoatRoughnessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,COAT_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,CoatRoughnessAnisotropy,_MATRIXNAME_,coatRoughnessAnisotropy,_INFONAME_,CoatRoughnessAnisotropyInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,COAT_DARKENING,_VARYINGNAME_,CoatDarkening,_MATRIXNAME_,coatDarkening,_INFONAME_,CoatDarkeningInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,GEOMETRY_NORMAL,_VARYINGNAME_,GeometryNormal,_MATRIXNAME_,geometryNormal,_INFONAME_,GeometryNormalInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,GEOMETRY_COAT_NORMAL,_VARYINGNAME_,GeometryCoatNormal,_MATRIXNAME_,geometryCoatNormal,_INFONAME_,GeometryCoatNormalInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,GEOMETRY_OPACITY,_VARYINGNAME_,GeometryOpacity,_MATRIXNAME_,geometryOpacity,_INFONAME_,GeometryOpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,GEOMETRY_TANGENT,_VARYINGNAME_,GeometryTangent,_MATRIXNAME_,geometryTangent,_INFONAME_,GeometryTangentInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSION_COLOR,_VARYINGNAME_,EmissionColor,_MATRIXNAME_,emissionColor,_INFONAME_,EmissionColorInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,THIN_FILM_WEIGHT,_VARYINGNAME_,ThinFilmWeight,_MATRIXNAME_,thinFilmWeight,_INFONAME_,ThinFilmWeightInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,THIN_FILM_THICKNESS,_VARYINGNAME_,ThinFilmThickness,_MATRIXNAME_,thinFilmThickness,_INFONAME_,ThinFilmThicknessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT_OCCLUSION,_VARYINGNAME_,AmbientOcclusion,_MATRIXNAME_,ambientOcclusion,_INFONAME_,AmbientOcclusionInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<openpbrNormalMapVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;S.ShadersStore[Jd]||(S.ShadersStore[Jd]=DA);const Jk={name:Jd,shader:DA},eG=Object.freeze(Object.defineProperty({__proto__:null,openpbrVertexShader:Jk},Symbol.toStringTag,{value:"Module"})),nT="openpbrFragmentDeclaration",tG=`uniform vec4 vEyePosition;uniform float vBaseWeight;uniform vec4 vBaseColor;uniform float vBaseDiffuseRoughness;uniform vec4 vReflectanceInfo;uniform vec4 vSpecularColor;uniform vec3 vSpecularAnisotropy;uniform float vCoatWeight;uniform vec3 vCoatColor;uniform float vCoatRoughness;uniform float vCoatRoughnessAnisotropy;uniform float vCoatIor;uniform float vCoatDarkening;uniform vec2 vGeometryCoatTangent;uniform vec3 vEmissionColor;uniform float vThinFilmWeight;uniform vec2 vThinFilmThickness;uniform float vThinFilmIor;uniform vec4 vLightingIntensity;uniform float visibility;
#ifdef BASE_COLOR
uniform vec2 vBaseColorInfos;
#endif
#ifdef BASE_WEIGHT
uniform vec2 vBaseWeightInfos;
#endif
#ifdef BASE_METALNESS
uniform vec2 vBaseMetalnessInfos;
#endif
#ifdef BASE_DIFFUSE_ROUGHNESS
uniform vec2 vBaseDiffuseRoughnessInfos;
#endif
#ifdef SPECULAR_WEIGHT
uniform vec2 vSpecularWeightInfos;
#endif
#ifdef SPECULAR_COLOR
uniform vec2 vSpecularColorInfos;
#endif
#ifdef SPECULAR_ROUGHNESS
uniform vec2 vSpecularRoughnessInfos;
#endif
#ifdef SPECULAR_ROUGHNESS_ANISOTROPY
uniform vec2 vSpecularRoughnessAnisotropyInfos;
#endif
#ifdef SPECULAR_IOR
uniform vec2 vSpecularIorInfos;
#endif
#ifdef AMBIENT_OCCLUSION
uniform vec2 vAmbientOcclusionInfos;
#endif
#ifdef GEOMETRY_NORMAL
uniform vec2 vGeometryNormalInfos;uniform vec2 vTangentSpaceParams;
#endif
#ifdef GEOMETRY_TANGENT
uniform vec2 vGeometryTangentInfos;
#endif
#ifdef GEOMETRY_COAT_NORMAL
uniform vec2 vGeometryCoatNormalInfos;
#endif
#ifdef GEOMETRY_OPACITY
uniform vec2 vGeometryOpacityInfos;
#endif
#ifdef EMISSION_COLOR
uniform vec2 vEmissionColorInfos;
#endif
#ifdef COAT_WEIGHT
uniform vec2 vCoatWeightInfos;
#endif
#ifdef COAT_COLOR
uniform vec2 vCoatColorInfos;
#endif
#ifdef COAT_ROUGHNESS
uniform vec2 vCoatRoughnessInfos;
#endif
#ifdef COAT_ROUGHNESS_ANISOTROPY
uniform vec2 vCoatRoughnessAnisotropyInfos;
#endif
#ifdef COAT_IOR
uniform vec2 vCoatIorInfos;
#endif
#ifdef COAT_DARKENING
uniform vec2 vCoatDarkeningInfos;
#endif
#ifdef GEOMETRY_COAT_TANGENT
uniform vec2 vGeometryCoatTangentInfos;
#endif
#ifdef THIN_FILM_WEIGHT
uniform vec2 vThinFilmWeightInfos;
#endif
#ifdef THIN_FILM_THICKNESS
uniform vec2 vThinFilmThicknessInfos;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#ifdef REALTIME_FILTERING
uniform vec2 vReflectionFilteringInfo;
#endif
uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;
#if defined(USEIRRADIANCEMAP) && defined(USE_IRRADIANCE_DOMINANT_DIRECTION)
uniform vec3 vReflectionDominantDirection;
#endif
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;uniform vec3 vReflectionSize;
#endif
#endif
#ifdef PREPASS
#ifdef SS_SCATTERING
uniform float scatteringDiffusionProfile;
#endif
#endif
#if DEBUGMODE>0
uniform vec2 vDebugMode;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#include<decalFragmentDeclaration>
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;
#endif
#endif
#define ADDITIONAL_FRAGMENT_DECLARATION
`;S.IncludesShadersStore[nT]||(S.IncludesShadersStore[nT]=tG);const aT="openpbrFragmentSamplersDeclaration",iG=`#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_COLOR,_VARYINGNAME_,BaseColor,_SAMPLERNAME_,baseColor)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight,_SAMPLERNAME_,baseWeight)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness,_SAMPLERNAME_,baseDiffuseRoughness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_METALNESS,_VARYINGNAME_,BaseMetalness,_SAMPLERNAME_,baseMetalness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR_WEIGHT,_VARYINGNAME_,SpecularWeight,_SAMPLERNAME_,specularWeight)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR_COLOR,_VARYINGNAME_,SpecularColor,_SAMPLERNAME_,specularColor)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR_ROUGHNESS,_VARYINGNAME_,SpecularRoughness,_SAMPLERNAME_,specularRoughness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,SpecularRoughnessAnisotropy,_SAMPLERNAME_,specularRoughnessAnisotropy)
#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_WEIGHT,_VARYINGNAME_,CoatWeight,_SAMPLERNAME_,coatWeight)
#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_COLOR,_VARYINGNAME_,CoatColor,_SAMPLERNAME_,coatColor)
#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_ROUGHNESS,_VARYINGNAME_,CoatRoughness,_SAMPLERNAME_,coatRoughness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,CoatRoughnessAnisotropy,_SAMPLERNAME_,coatRoughnessAnisotropy)
#include <samplerFragmentDeclaration>(_DEFINENAME_,COAT_DARKENING,_VARYINGNAME_,CoatDarkening,_SAMPLERNAME_,coatDarkening)
#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_OPACITY,_VARYINGNAME_,GeometryOpacity,_SAMPLERNAME_,geometryOpacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_TANGENT,_VARYINGNAME_,GeometryTangent,_SAMPLERNAME_,geometryTangent)
#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_COAT_TANGENT,_VARYINGNAME_,GeometryCoatTangent,_SAMPLERNAME_,geometryCoatTangent)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSION_COLOR,_VARYINGNAME_,EmissionColor,_SAMPLERNAME_,emissionColor)
#include<samplerFragmentDeclaration>(_DEFINENAME_,THIN_FILM_WEIGHT,_VARYINGNAME_,ThinFilmWeight,_SAMPLERNAME_,thinFilmWeight)
#include<samplerFragmentDeclaration>(_DEFINENAME_,THIN_FILM_THICKNESS,_VARYINGNAME_,ThinFilmThickness,_SAMPLERNAME_,thinFilmThickness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT_OCCLUSION,_VARYINGNAME_,AmbientOcclusion,_SAMPLERNAME_,ambientOcclusion)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform samplerCube irradianceSampler;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D reflectionSamplerLow;uniform sampler2D reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform sampler2D irradianceSampler;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#endif
#ifdef ENVIRONMENTBRDF
uniform sampler2D environmentBrdfSampler;
#endif
#ifdef ANISOTROPIC
uniform sampler2D blueNoiseSampler;
#endif
#ifdef IBL_CDF_FILTERING
uniform sampler2D icdfSampler;
#endif
`;S.IncludesShadersStore[aT]||(S.IncludesShadersStore[aT]=iG);const oT="openpbrNormalMapFragmentMainFunctions",rG=`#if defined(GEOMETRY_NORMAL) || defined(GEOMETRY_COAT_NORMAL) || defined(ANISOTROPIC) || defined(DETAIL)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#ifdef OBJECTSPACE_NORMALMAP
uniform mat4 normalMatrix;
#if defined(WEBGL2) || defined(WEBGPU)
mat4 toNormalMatrix(mat4 wMatrix)
{mat4 ret=inverse(wMatrix);ret=transpose(ret);ret[0][3]=0.;ret[1][3]=0.;ret[2][3]=0.;ret[3]=vec4(0.,0.,0.,1.);return ret;}
#else
mat4 toNormalMatrix(mat4 m)
{float
a00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],
a10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],
a20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],
a30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],
b00=a00*a11-a01*a10,
b01=a00*a12-a02*a10,
b02=a00*a13-a03*a10,
b03=a01*a12-a02*a11,
b04=a01*a13-a03*a11,
b05=a02*a13-a03*a12,
b06=a20*a31-a21*a30,
b07=a20*a32-a22*a30,
b08=a20*a33-a23*a30,
b09=a21*a32-a22*a31,
b10=a21*a33-a23*a31,
b11=a22*a33-a23*a32,
det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;mat4 mi=mat4(
a11*b11-a12*b10+a13*b09,
a02*b10-a01*b11-a03*b09,
a31*b05-a32*b04+a33*b03,
a22*b04-a21*b05-a23*b03,
a12*b08-a10*b11-a13*b07,
a00*b11-a02*b08+a03*b07,
a32*b02-a30*b05-a33*b01,
a20*b05-a22*b02+a23*b01,
a10*b10-a11*b08+a13*b06,
a01*b08-a00*b10-a03*b06,
a30*b04-a31*b02+a33*b00,
a21*b02-a20*b04-a23*b00,
a11*b07-a10*b09-a12*b06,
a00*b09-a01*b07+a02*b06,
a31*b01-a30*b03-a32*b00,
a20*b03-a21*b01+a22*b00)/det;return mat4(mi[0][0],mi[1][0],mi[2][0],mi[3][0],
mi[0][1],mi[1][1],mi[2][1],mi[3][1],
mi[0][2],mi[1][2],mi[2][2],mi[3][2],
mi[0][3],mi[1][3],mi[2][3],mi[3][3]);}
#endif
#endif
vec3 perturbNormalBase(mat3 cotangentFrame,vec3 normal,float scale)
{
#ifdef NORMALXYSCALE
normal=normalize(normal*vec3(scale,scale,1.0));
#endif
return normalize(cotangentFrame*normal);}
vec3 perturbNormal(mat3 cotangentFrame,vec3 textureSample,float scale)
{return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);}
mat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv,vec2 tangentSpaceParams)
{vec3 dp1=dFdx(p);vec3 dp2=dFdy(p);vec2 duv1=dFdx(uv);vec2 duv2=dFdy(uv);vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;vec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;tangent*=tangentSpaceParams.x;bitangent*=tangentSpaceParams.y;float det=max(dot(tangent,tangent),dot(bitangent,bitangent));float invmax=det==0.0 ? 0.0 : inversesqrt(det);return mat3(tangent*invmax,bitangent*invmax,normal);}
#endif
`;S.IncludesShadersStore[oT]||(S.IncludesShadersStore[oT]=rG);const lT="openpbrNormalMapFragmentFunctions",sG=`#if defined(GEOMETRY_NORMAL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_NORMAL,_VARYINGNAME_,GeometryNormal,_SAMPLERNAME_,geometryNormal)
#endif
#if defined(GEOMETRY_COAT_NORMAL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_COAT_NORMAL,_VARYINGNAME_,GeometryCoatNormal,_SAMPLERNAME_,geometryCoatNormal)
#endif
#if defined(DETAIL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)
#endif
#if defined(GEOMETRY_NORMAL) && defined(PARALLAX)
const float minSamples=4.;const float maxSamples=15.;const int iMaxSamples=15;vec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {float parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;parallaxLimit*=parallaxScale;vec2 vOffsetDir=normalize(vViewDirCoT.xy);vec2 vMaxOffset=vOffsetDir*parallaxLimit;float numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));float stepSize=1.0/numSamples;float currRayHeight=1.0;vec2 vCurrOffset=vec2(0,0);vec2 vLastOffset=vec2(0,0);float lastSampledHeight=1.0;float currSampledHeight=1.0;bool keepWorking=true;for (int i=0; i<iMaxSamples; i++)
{currSampledHeight=texture2D(geometryNormalSampler,texCoord+vCurrOffset).w;if (!keepWorking)
{}
else if (currSampledHeight>currRayHeight)
{float delta1=currSampledHeight-currRayHeight;float delta2=(currRayHeight+stepSize)-lastSampledHeight;float ratio=delta1/(delta1+delta2);vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;keepWorking=false;}
else
{currRayHeight-=stepSize;vLastOffset=vCurrOffset;
#ifdef PARALLAX_RHS
vCurrOffset-=stepSize*vMaxOffset;
#else
vCurrOffset+=stepSize*vMaxOffset;
#endif
lastSampledHeight=currSampledHeight;}}
return vCurrOffset;}
vec2 parallaxOffset(vec3 viewDir,float heightScale)
{float height=texture2D(geometryNormalSampler,vGeometryNormalUV).w;vec2 texCoordOffset=heightScale*viewDir.xy*height;
#ifdef PARALLAX_RHS
return texCoordOffset;
#else
return -texCoordOffset;
#endif
}
#endif
`;S.IncludesShadersStore[lT]||(S.IncludesShadersStore[lT]=sG);const cT="openpbrDielectricReflectance",nG=`struct ReflectanceParams
{float F0;float F90;vec3 coloredF0;vec3 coloredF90;};
#define pbr_inline
ReflectanceParams dielectricReflectance(
in float insideIOR,in float outsideIOR,in vec3 specularColor,in float specularWeight
)
{ReflectanceParams outParams;float dielectricF0=pow((insideIOR-outsideIOR)/(insideIOR+outsideIOR),2.0);float dielectricF0_NoSpec=pow((1.0-outsideIOR)/(1.0+outsideIOR),2.0);float f90Scale=clamp(2.0*abs(insideIOR-outsideIOR),0.0,1.0);float f90Scale_NoSpec=clamp(2.0*abs(1.0-outsideIOR),0.0,1.0);
#if (DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_OPENPBR)
vec3 dielectricColorF90=specularColor.rgb*vec3(f90Scale);vec3 dielectricColorF90_NoSpec=specularColor.rgb*vec3(f90Scale_NoSpec);
#else
vec3 dielectricColorF90=vec3(f90Scale);vec3 dielectricColorF90_NoSpec=vec3(f90Scale_NoSpec);
#endif
#if DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_GLTF
float maxF0=max(specularColor.r,max(specularColor.g,specularColor.b));outParams.F0=mix(dielectricF0_NoSpec,dielectricF0,specularWeight)*maxF0;
#else
outParams.F0=mix(dielectricF0_NoSpec,dielectricF0,specularWeight);
#endif
outParams.F90=mix(f90Scale_NoSpec,f90Scale,specularWeight);outParams.coloredF0=mix(vec3(dielectricF0_NoSpec),vec3(dielectricF0),specularWeight)*specularColor.rgb;outParams.coloredF90=mix(dielectricColorF90_NoSpec,dielectricColorF90,specularWeight);return outParams;}
`;S.IncludesShadersStore[cT]||(S.IncludesShadersStore[cT]=nG);const uT="openpbrConductorReflectance",aG=`#define pbr_inline
ReflectanceParams conductorReflectance(in vec3 baseColor,in vec3 specularColor,in float specularWeight)
{ReflectanceParams outParams;
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
outParams.coloredF0=baseColor*specularWeight;outParams.coloredF90=specularColor*specularWeight;
#else
outParams.coloredF0=baseColor;outParams.coloredF90=vec3(1.0);
#endif
outParams.F0=1.0;outParams.F90=1.0;return outParams;}`;S.IncludesShadersStore[uT]||(S.IncludesShadersStore[uT]=aG);const hT="openpbrBlockAmbientOcclusion",oG=`struct ambientOcclusionOutParams
{vec3 ambientOcclusionColor;
#if DEBUGMODE>0 && defined(AMBIENT_OCCLUSION)
vec3 ambientOcclusionColorMap;
#endif
};
#define pbr_inline
ambientOcclusionOutParams ambientOcclusionBlock(
#ifdef AMBIENT_OCCLUSION
in vec3 ambientOcclusionColorMap_,
in vec2 ambientInfos
#endif
)
{ambientOcclusionOutParams outParams;vec3 ambientOcclusionColor=vec3(1.,1.,1.);
#ifdef AMBIENT_OCCLUSION
vec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*ambientInfos.y;
#ifdef AMBIENTINGRAYSCALE
ambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);
#endif
#if DEBUGMODE>0
outParams.ambientOcclusionColorMap=ambientOcclusionColorMap;
#endif
#endif
outParams.ambientOcclusionColor=ambientOcclusionColor;return outParams;}
`;S.IncludesShadersStore[hT]||(S.IncludesShadersStore[hT]=oG);const dT="openpbrGeometryInfo",lG=`struct geometryInfoOutParams
{float NdotV;float NdotVUnclamped;vec3 environmentBrdf;float horizonOcclusion;};
#ifdef ANISOTROPIC
struct geometryInfoAnisoOutParams
{float NdotV;float NdotVUnclamped;vec3 environmentBrdf;float horizonOcclusion;float anisotropy;vec3 anisotropicTangent;vec3 anisotropicBitangent;mat3 TBN;};
#endif
#define pbr_inline
geometryInfoOutParams geometryInfo(
in vec3 normalW,in vec3 viewDirectionW,in float roughness,in vec3 geometricNormalW
)
{geometryInfoOutParams outParams;outParams.NdotVUnclamped=dot(normalW,viewDirectionW);outParams.NdotV=absEps(outParams.NdotVUnclamped);
#if defined(ENVIRONMENTBRDF)
outParams.environmentBrdf=getBRDFLookup(outParams.NdotV,roughness);
#else
outParams.environmentBrdf=vec3(0.0);
#endif
outParams.horizonOcclusion=1.0;
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef HORIZONOCCLUSION
#if defined(GEOMETRY_NORMAL) || defined(GEOMETRY_COAT_NORMAL)
#ifdef REFLECTIONMAP_3D
outParams.horizonOcclusion=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);
#endif
#endif
#endif
#endif
return outParams;}
#ifdef ANISOTROPIC
#define pbr_inline
geometryInfoAnisoOutParams geometryInfoAniso(
in vec3 normalW,in vec3 viewDirectionW,in float roughness,in vec3 geometricNormalW
,in vec3 vAnisotropy,in mat3 TBN
)
{geometryInfoOutParams geoInfo=geometryInfo(normalW,viewDirectionW,roughness,geometricNormalW);geometryInfoAnisoOutParams outParams;outParams.NdotV=geoInfo.NdotV;outParams.NdotVUnclamped=geoInfo.NdotVUnclamped;outParams.environmentBrdf=geoInfo.environmentBrdf;outParams.horizonOcclusion=geoInfo.horizonOcclusion;outParams.anisotropy=vAnisotropy.b;vec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);mat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));outParams.anisotropicTangent=normalize(anisoTBN*anisotropyDirection);outParams.anisotropicBitangent=normalize(cross(anisoTBN[2],outParams.anisotropicTangent));outParams.TBN=TBN;return outParams;}
#endif
`;S.IncludesShadersStore[dT]||(S.IncludesShadersStore[dT]=lG);const fT="openpbrIblFunctions",cG=`#ifdef REFLECTION
vec3 sampleIrradiance(
in vec3 surfaceNormal
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,in vec3 vEnvironmentIrradianceSH
#endif
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
,in mat4 iblMatrix
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,in samplerCube irradianceSampler
#else
,in sampler2D irradianceSampler
#endif
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
,in vec3 reflectionDominantDirection
#endif
#endif
#ifdef REALTIME_FILTERING
,in vec2 vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,in sampler2D icdfSampler
#endif
#endif
,in vec2 vReflectionInfos
,in vec3 viewDirectionW
,in float diffuseRoughness
,in vec3 surfaceAlbedo
) {vec3 environmentIrradiance=vec3(0.,0.,0.);
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
vec3 irradianceVector=(iblMatrix*vec4(surfaceNormal,0)).xyz;vec3 irradianceView=(iblMatrix*vec4(viewDirectionW,0)).xyz;
#if !defined(USE_IRRADIANCE_DOMINANT_DIRECTION) && !defined(REALTIME_FILTERING)
#if BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LAMBERT && BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LEGACY
{float NdotV=max(dot(surfaceNormal,viewDirectionW),0.0);irradianceVector=mix(irradianceVector,irradianceView,(0.5*(1.0-NdotV))*diffuseRoughness);}
#endif
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
environmentIrradiance=vEnvironmentIrradianceSH;
#else
#if defined(REALTIME_FILTERING)
environmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo,diffuseRoughness,surfaceAlbedo,irradianceView
#ifdef IBL_CDF_FILTERING
,icdfSampler
#endif
);
#else
environmentIrradiance=computeEnvironmentIrradiance(irradianceVector);
#endif
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
vec4 environmentIrradianceFromTexture=sampleReflection(irradianceSampler,irradianceVector);
#else
vec4 environmentIrradianceFromTexture=sampleReflection(irradianceSampler,reflectionCoords);
#endif
environmentIrradiance=environmentIrradianceFromTexture.rgb;
#ifdef RGBDREFLECTION
environmentIrradiance.rgb=fromRGBD(environmentIrradianceFromTexture);
#endif
#ifdef GAMMAREFLECTION
environmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);
#endif
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
vec3 Ls=normalize(reflectionDominantDirection);float NoL=dot(irradianceVector,Ls);float NoV=dot(irradianceVector,irradianceView);vec3 diffuseRoughnessTerm=vec3(1.0);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
float LoV=dot (Ls,irradianceView);float mag=length(reflectionDominantDirection)*2.0;vec3 clampedAlbedo=clamp(surfaceAlbedo,vec3(0.1),vec3(1.0));diffuseRoughnessTerm=diffuseBRDF_EON(clampedAlbedo,diffuseRoughness,NoL,NoV,LoV)*PI;diffuseRoughnessTerm=diffuseRoughnessTerm/clampedAlbedo;diffuseRoughnessTerm=mix(vec3(1.0),diffuseRoughnessTerm,sqrt(clamp(mag*NoV,0.0,1.0)));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
vec3 H=(irradianceView+Ls)*0.5;float VoH=dot(irradianceView,H);diffuseRoughnessTerm=vec3(diffuseBRDF_Burley(NoL,NoV,VoH,diffuseRoughness)*PI);
#endif
environmentIrradiance=environmentIrradiance.rgb*diffuseRoughnessTerm;
#endif
#endif
environmentIrradiance*=vReflectionInfos.x;return environmentIrradiance;}
#define pbr_inline
#ifdef REFLECTIONMAP_3D
vec3 createReflectionCoords(
#else
vec2 createReflectionCoords(
#endif
in vec3 vPositionW
,in vec3 normalW
)
{vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=reflectionVector;
#else
vec2 reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
return reflectionCoords;}
#define pbr_inline
#define inline
vec3 sampleRadiance(
in float alphaG
,in vec3 vReflectionMicrosurfaceInfos
,in vec2 vReflectionInfos
,in geometryInfoOutParams geoInfo
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSampler
,const vec3 reflectionCoords
#else
,in sampler2D reflectionSampler
,const vec2 reflectionCoords
#endif
#ifdef REALTIME_FILTERING
,in vec2 vReflectionFilteringInfo
#endif
)
{vec4 environmentRadiance=vec4(0.,0.,0.,0.);
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,geoInfo.NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
float reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);
#else
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);
#endif
reflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
#ifdef REALTIME_FILTERING
environmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);
#else
environmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#endif
#ifdef RGBDREFLECTION
environmentRadiance.rgb=fromRGBD(environmentRadiance);
#endif
#ifdef GAMMAREFLECTION
environmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);
#endif
environmentRadiance.rgb*=vec3(vReflectionInfos.x);return environmentRadiance.rgb;}
#if defined(ANISOTROPIC)
#define pbr_inline
#define inline
vec3 sampleRadianceAnisotropic(
in float alphaG
,in vec3 vReflectionMicrosurfaceInfos
,in vec2 vReflectionInfos
,in geometryInfoAnisoOutParams geoInfo
,const vec3 normalW
,const vec3 viewDirectionW
,const vec3 positionW
,const vec3 noise
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSampler
#else
,in sampler2D reflectionSampler
#endif
#ifdef REALTIME_FILTERING
,in vec2 vReflectionFilteringInfo
#endif
)
{vec4 environmentRadiance=vec4(0.,0.,0.,0.);float alphaT=alphaG*sqrt(2.0/(1.0+(1.0-geoInfo.anisotropy)*(1.0-geoInfo.anisotropy)));float alphaB=(1.0-geoInfo.anisotropy)*alphaT;alphaG=alphaB;
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,geoInfo.NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
float reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);
#else
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);
#endif
reflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
#ifdef REALTIME_FILTERING
vec3 view=(reflectionMatrix*vec4(viewDirectionW,0.0)).xyz;vec3 tangent=(reflectionMatrix*vec4(geoInfo.anisotropicTangent,0.0)).xyz;vec3 bitangent=(reflectionMatrix*vec4(geoInfo.anisotropicBitangent,0.0)).xyz;vec3 normal=(reflectionMatrix*vec4(normalW,0.0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
view.z*=-1.0;tangent.z*=-1.0;bitangent.z*=-1.0;normal.z*=-1.0;
#endif
environmentRadiance =
vec4(radianceAnisotropic(alphaT,alphaB,reflectionSampler,
view,tangent,
bitangent,normal,
vReflectionFilteringInfo,noise.xy),
1.0);
#else
const int samples=16;vec4 radianceSample=vec4(0.0);vec3 reflectionCoords=vec3(0.0);float sample_weight=0.0;float total_weight=0.0;float step=1.0/float(max(samples-1,1));for (int i=0; i<samples; ++i) {float t=mix(-1.0,1.0,float(i)*step);t+=step*2.0*noise.x;sample_weight=max(1.0-abs(t),0.001);sample_weight*=sample_weight;t*=min(4.0*alphaT*geoInfo.anisotropy,1.0);vec3 bentNormal;if (t<0.0) {float blend=t+1.0;bentNormal=normalize(mix(-geoInfo.anisotropicTangent,normalW,blend));} else if (t>0.0) {float blend=t;bentNormal=normalize(mix(normalW,geoInfo.anisotropicTangent,blend));} else {bentNormal=normalW;}
reflectionCoords=createReflectionCoords(positionW,bentNormal);radianceSample=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#ifdef RGBDREFLECTION
environmentRadiance.rgb+=sample_weight*fromRGBD(radianceSample);
#elif defined(GAMMAREFLECTION)
environmentRadiance.rgb+=sample_weight*toLinearSpace(radianceSample.rgb);
#else
environmentRadiance.rgb+=sample_weight*radianceSample.rgb;
#endif
total_weight+=sample_weight;}
environmentRadiance=vec4(environmentRadiance.xyz/float(total_weight),1.0);
#endif
environmentRadiance.rgb*=vec3(vReflectionInfos.x);return environmentRadiance.rgb;}
#endif
#define pbr_inline
vec3 conductorIblFresnel(in ReflectanceParams reflectance,in float NdotV,in float roughness,in vec3 environmentBrdf)
{
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
vec3 albedoF0=mix(reflectance.coloredF0,pow(reflectance.coloredF0,vec3(1.4)),roughness);return getF82Specular(NdotV,albedoF0,reflectance.coloredF90,roughness);
#else
return getReflectanceFromBRDFLookup(reflectance.coloredF0,reflectance.coloredF90,environmentBrdf);
#endif
}
#endif
`;S.IncludesShadersStore[fT]||(S.IncludesShadersStore[fT]=cG);const pT="openpbrNormalMapFragment",uG=`vec2 uvOffset=vec2(0.0,0.0);
#if defined(GEOMETRY_NORMAL) || defined(GEOMETRY_COAT_NORMAL) || defined(PARALLAX) || defined(DETAIL)
#ifdef NORMALXYSCALE
float normalScale=1.0;
#elif defined(GEOMETRY_NORMAL)
float normalScale=vGeometryNormalInfos.y;
#else
float normalScale=1.0;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#elif defined(GEOMETRY_NORMAL)
vec2 TBNUV=gl_FrontFacing ? vGeometryNormalUV : -vGeometryNormalUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);
#else
vec2 TBNUV=gl_FrontFacing ? vDetailUV : -vDetailUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vec2(1.,1.));
#endif
#elif defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#else
vec2 TBNUV=gl_FrontFacing ? vMainUV1 : -vMainUV1;mat3 TBN=cotangent_frame(normalW,vPositionW,TBNUV,vec2(1.,1.));
#endif
#endif
#ifdef PARALLAX
mat3 invTBN=transposeMat3(TBN);
#ifdef PARALLAXOCCLUSION
#else
#endif
#endif
#ifdef DETAIL
vec4 detailColor=texture2D(detailSampler,vDetailUV+uvOffset);vec2 detailNormalRG=detailColor.wy*2.0-1.0;float detailNormalB=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));vec3 detailNormal=vec3(detailNormalRG,detailNormalB);
#endif
#ifdef GEOMETRY_COAT_NORMAL
coatNormalW=perturbNormal(TBN,texture2D(geometryCoatNormalSampler,vGeometryCoatNormalUV+uvOffset).xyz,vGeometryCoatNormalInfos.y);
#endif
#ifdef GEOMETRY_NORMAL
#ifdef OBJECTSPACE_NORMALMAP
#define CUSTOM_FRAGMENT_BUMP_FRAGMENT
normalW=normalize(texture2D(geometryNormalSampler,vGeometryNormalUV).xyz *2.0-1.0);normalW=normalize(mat3(normalMatrix)*normalW);
#elif !defined(DETAIL)
normalW=perturbNormal(TBN,texture2D(geometryNormalSampler,vGeometryNormalUV+uvOffset).xyz,vGeometryNormalInfos.y);
#else
vec3 sampledNormal=texture2D(geometryNormalSampler,vGeometryNormalUV+uvOffset).xyz*2.0-1.0;
#if DETAIL_NORMALBLENDMETHOD==0 
detailNormal.xy*=vDetailInfos.z;vec3 blendedNormal=normalize(vec3(sampledNormal.xy+detailNormal.xy,sampledNormal.z*detailNormal.z));
#elif DETAIL_NORMALBLENDMETHOD==1 
detailNormal.xy*=vDetailInfos.z;sampledNormal+=vec3(0.0,0.0,1.0);detailNormal*=vec3(-1.0,-1.0,1.0);vec3 blendedNormal=sampledNormal*dot(sampledNormal,detailNormal)/sampledNormal.z-detailNormal;
#endif
normalW=perturbNormalBase(TBN,blendedNormal,vGeometryNormalInfos.y);
#endif
#elif defined(DETAIL)
detailNormal.xy*=vDetailInfos.z;normalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);
#endif
`;S.IncludesShadersStore[pT]||(S.IncludesShadersStore[pT]=uG);const mT="openpbrBlockNormalFinal",hG=`#if defined(FORCENORMALFORWARD) && defined(NORMAL)
vec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#if defined(TWOSIDEDLIGHTING)
faceNormal=gl_FrontFacing ? faceNormal : -faceNormal;
#endif
normalW*=sign(dot(normalW,faceNormal));coatNormalW*=sign(dot(coatNormalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
#if defined(MIRRORED)
normalW=gl_FrontFacing ? -normalW : normalW;coatNormalW=gl_FrontFacing ? -coatNormalW : coatNormalW;
#else
normalW=gl_FrontFacing ? normalW : -normalW;coatNormalW=gl_FrontFacing ? coatNormalW : -coatNormalW;
#endif
#endif
`;S.IncludesShadersStore[mT]||(S.IncludesShadersStore[mT]=hG);const _T="openpbrBaseLayerData",dG=`vec3 base_color=vec3(0.8);float base_metalness=0.0;float base_diffuse_roughness=0.0;float specular_weight=1.0;float specular_roughness=0.3;vec3 specular_color=vec3(1.0);float specular_roughness_anisotropy=0.0;float specular_ior=1.5;float alpha=1.0;vec2 geometry_tangent=vec2(1.0,0.0);
#ifdef BASE_WEIGHT
vec4 baseWeightFromTexture=texture2D(baseWeightSampler,vBaseWeightUV+uvOffset);
#endif
#ifdef BASE_COLOR
vec4 baseColorFromTexture=texture2D(baseColorSampler,vBaseColorUV+uvOffset);
#endif
#ifdef BASE_METALNESS
vec4 metallicFromTexture=texture2D(baseMetalnessSampler,vBaseMetalnessUV+uvOffset);
#endif
#if defined(ROUGHNESSSTOREINMETALMAPGREEN) && defined(BASE_METALNESS)
float roughnessFromTexture=metallicFromTexture.g;
#elif defined(SPECULAR_ROUGHNESS)
float roughnessFromTexture=texture2D(specularRoughnessSampler,vSpecularRoughnessUV+uvOffset).r;
#endif
#ifdef GEOMETRY_TANGENT
vec3 geometryTangentFromTexture=texture2D(geometryTangentSampler,vGeometryTangentUV+uvOffset).rgb;
#endif
#ifdef SPECULAR_ROUGHNESS_ANISOTROPY
float anisotropyFromTexture=texture2D(specularRoughnessAnisotropySampler,vSpecularRoughnessAnisotropyUV+uvOffset).r*vSpecularRoughnessAnisotropyInfos.y;
#endif
#ifdef BASE_DIFFUSE_ROUGHNESS
float baseDiffuseRoughnessFromTexture=texture2D(baseDiffuseRoughnessSampler,vBaseDiffuseRoughnessUV+uvOffset).r;
#endif
#ifdef GEOMETRY_OPACITY
vec4 opacityFromTexture=texture2D(opacitySampler,vOpacityUV+uvOffset);
#endif
#ifdef DECAL
vec4 decalFromTexture=texture2D(decalSampler,vDecalUV+uvOffset);
#endif
#ifdef SPECULAR_COLOR
vec4 specularColorFromTexture=texture2D(specularColorSampler,vSpecularColorUV+uvOffset);
#endif
#ifdef SPECULAR_WEIGHT
#ifdef SPECULAR_WEIGHT_IN_ALPHA
float specularWeightFromTexture=texture2D(specularWeightSampler,vSpecularWeightUV+uvOffset).a;
#else
float specularWeightFromTexture=texture2D(specularWeightSampler,vSpecularWeightUV+uvOffset).r;
#endif
#endif
#ifdef ANISOTROPIC
vec3 noise=texture2D(blueNoiseSampler,gl_FragCoord.xy/256.0).xyz;
#endif
base_color=vBaseColor.rgb;
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
base_color*=vColor.rgb;
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=vColor.a;
#endif
base_color*=vec3(vBaseWeight);alpha=vBaseColor.a;base_metalness=vReflectanceInfo.x;base_diffuse_roughness=vBaseDiffuseRoughness;specular_roughness=vReflectanceInfo.y;specular_color=vSpecularColor.rgb;specular_weight=vReflectanceInfo.a;specular_ior=vReflectanceInfo.z;specular_roughness_anisotropy=vSpecularAnisotropy.b;geometry_tangent=vSpecularAnisotropy.rg;
#ifdef BASE_COLOR
#ifdef BASE_COLOR_GAMMA
base_color*=toLinearSpace(baseColorFromTexture.rgb);
#else
base_color*=baseColorFromTexture.rgb;
#endif
base_color*=vBaseColorInfos.y;
#endif
#ifdef BASE_WEIGHT
base_color*=baseWeightFromTexture.r;
#endif
#if defined(BASE_COLOR) && defined(ALPHA_FROM_BASE_COLOR_TEXTURE)
alpha*=baseColorFromTexture.a;
#elif defined(GEOMETRY_OPACITY)
alpha*=opacityFromTexture.r;alpha*=vGeometryOpacityInfos.y;
#endif
#ifdef ALPHATEST
#if DEBUGMODE != 88
if (alpha<ALPHATESTVALUE)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
#ifdef BASE_METALNESS
#ifdef METALLNESSSTOREINMETALMAPBLUE
base_metalness*=metallicFromTexture.b;
#else
base_metalness*=metallicFromTexture.r;
#endif
#endif
#ifdef BASE_DIFFUSE_ROUGHNESS
base_diffuse_roughness*=baseDiffuseRoughnessFromTexture*vBaseDiffuseRoughnessInfos.y;
#endif
#ifdef SPECULAR_COLOR
#ifdef SPECULAR_COLOR_GAMMA
specular_color*=toLinearSpace(specularColorFromTexture.rgb);
#else
specular_color*=specularColorFromTexture.rgb;
#endif
#endif
#ifdef SPECULAR_WEIGHT_FROM_SPECULAR_COLOR_TEXTURE
specular_weight*=specularColorFromTexture.a;
#elif defined(SPECULAR_WEIGHT)
specular_weight*=specularWeightFromTexture;
#endif
#if defined(SPECULAR_ROUGHNESS) || (defined(ROUGHNESSSTOREINMETALMAPGREEN) && defined(BASE_METALNESS))
specular_roughness*=roughnessFromTexture;
#endif
#ifdef GEOMETRY_TANGENT
{vec2 tangentFromTexture=normalize(geometryTangentFromTexture.xy*2.0-1.0);float tangent_angle_texture=atan(tangentFromTexture.y,tangentFromTexture.x);float tangent_angle_uniform=atan(geometry_tangent.y,geometry_tangent.x);float tangent_angle=tangent_angle_texture+tangent_angle_uniform;geometry_tangent=vec2(cos(tangent_angle),sin(tangent_angle));}
#endif
#if defined(GEOMETRY_TANGENT) && defined(SPECULAR_ROUGHNESS_ANISOTROPY_FROM_TANGENT_TEXTURE)
specular_roughness_anisotropy*=geometryTangentFromTexture.b;
#elif defined(SPECULAR_ROUGHNESS_ANISOTROPY)
specular_roughness_anisotropy*=anisotropyFromTexture;
#endif
#ifdef DETAIL
float detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);float loLerp=mix(0.,specular_roughness,detailRoughness*2.);float hiLerp=mix(specular_roughness,1.,(detailRoughness-0.5)*2.);specular_roughness=mix(loLerp,hiLerp,step(detailRoughness,0.5));
#endif
#ifdef USE_GLTF_STYLE_ANISOTROPY
float baseAlpha=specular_roughness*specular_roughness;float roughnessT=mix(baseAlpha,1.0,specular_roughness_anisotropy*specular_roughness_anisotropy);float roughnessB=baseAlpha;specular_roughness_anisotropy=1.0-roughnessB/max(roughnessT,0.00001);specular_roughness=sqrt(roughnessT/sqrt(2.0/(1.0+(1.0-specular_roughness_anisotropy)*(1.0-specular_roughness_anisotropy))));
#endif
`;S.IncludesShadersStore[_T]||(S.IncludesShadersStore[_T]=dG);const gT="openpbrCoatLayerData",fG=`float coat_weight=0.0;vec3 coat_color=vec3(1.0);float coat_roughness=0.0;float coat_roughness_anisotropy=0.0;float coat_ior=1.6;float coat_darkening=1.0;vec2 geometry_coat_tangent=vec2(1.0,0.0);
#ifdef COAT_WEIGHT
vec4 coatWeightFromTexture=texture2D(coatWeightSampler,vCoatWeightUV+uvOffset);
#endif
#ifdef COAT_COLOR
vec4 coatColorFromTexture=texture2D(coatColorSampler,vCoatColorUV+uvOffset);
#endif
#ifdef COAT_ROUGHNESS
vec4 coatRoughnessFromTexture=texture2D(coatRoughnessSampler,vCoatRoughnessUV+uvOffset);
#endif
#ifdef COAT_ROUGHNESS_ANISOTROPY
float coatRoughnessAnisotropyFromTexture=texture2D(coatRoughnessAnisotropySampler,vCoatRoughnessAnisotropyUV+uvOffset).r;
#endif
#ifdef COAT_DARKENING
vec4 coatDarkeningFromTexture=texture2D(coatDarkeningSampler,vCoatDarkeningUV+uvOffset);
#endif
#ifdef GEOMETRY_COAT_TANGENT
vec3 geometryCoatTangentFromTexture=texture2D(geometryCoatTangentSampler,vGeometryCoatTangentUV+uvOffset).rgb;
#endif
coat_color=vCoatColor.rgb;coat_weight=vCoatWeight;coat_roughness=vCoatRoughness;coat_roughness_anisotropy=vCoatRoughnessAnisotropy;coat_ior=vCoatIor;coat_darkening=vCoatDarkening;geometry_coat_tangent=vGeometryCoatTangent.rg;
#ifdef COAT_WEIGHT
coat_weight*=coatWeightFromTexture.r;
#endif
#ifdef COAT_COLOR
#ifdef COAT_COLOR_GAMMA
coat_color*=toLinearSpace(coatColorFromTexture.rgb);
#else
coat_color*=coatColorFromTexture.rgb;
#endif
coat_color*=vCoatColorInfos.y;
#endif
#ifdef COAT_ROUGHNESS
coat_roughness*=coatRoughnessFromTexture.r;
#endif
#if defined(GEOMETRY_COAT_TANGENT) && defined(COAT_ROUGHNESS_ANISOTROPY_FROM_TANGENT_TEXTURE)
coat_roughness_anisotropy*=geometryCoatTangentFromTexture.b;
#elif defined(COAT_ROUGHNESS_ANISOTROPY)
coat_roughness_anisotropy*=coatRoughnessAnisotropyFromTexture;
#endif
#ifdef COAT_DARKENING
coat_darkening*=coatDarkeningFromTexture.r;
#endif
#ifdef GEOMETRY_COAT_TANGENT
{vec2 tangentFromTexture=normalize(geometryCoatTangentFromTexture.xy*2.0-1.0);float tangent_angle_texture=atan(tangentFromTexture.y,tangentFromTexture.x);float tangent_angle_uniform=atan(geometry_coat_tangent.y,geometry_coat_tangent.x);float tangent_angle=tangent_angle_texture+tangent_angle_uniform;geometry_coat_tangent=vec2(cos(tangent_angle),sin(tangent_angle));}
#endif
#ifdef USE_GLTF_STYLE_ANISOTROPY
float coatAlpha=coat_roughness*coat_roughness;float coatRoughnessT=mix(coatAlpha,1.0,coat_roughness_anisotropy*coat_roughness_anisotropy);float coatRoughnessB=coatAlpha;coat_roughness_anisotropy=1.0-coatRoughnessB/max(coatRoughnessT,0.00001);coat_roughness=sqrt(coatRoughnessT/sqrt(2.0/(1.0+(1.0-coat_roughness_anisotropy)*(1.0-coat_roughness_anisotropy))));
#endif
`;S.IncludesShadersStore[gT]||(S.IncludesShadersStore[gT]=fG);const ST="openpbrThinFilmLayerData",pG=`#ifdef THIN_FILM
float thin_film_weight=vThinFilmWeight;float thin_film_thickness=vThinFilmThickness.r*1000.0; 
float thin_film_ior=vThinFilmIor;
#ifdef THIN_FILM_WEIGHT
float thinFilmWeightFromTexture=texture2D(thinFilmWeightSampler,vThinFilmWeightUV+uvOffset).r*vThinFilmWeightInfos.y;
#endif
#ifdef THIN_FILM_THICKNESS
float thinFilmThicknessFromTexture=texture2D(thinFilmThicknessSampler,vThinFilmThicknessUV+uvOffset).g*vThinFilmThicknessInfos.y;
#endif
#ifdef THIN_FILM_WEIGHT
thin_film_weight*=thinFilmWeightFromTexture;
#endif
#ifdef THIN_FILM_THICKNESS
thin_film_thickness*=thinFilmThicknessFromTexture;
#endif
#endif
`;S.IncludesShadersStore[ST]||(S.IncludesShadersStore[ST]=pG);const vT="openpbrEnvironmentLighting",mG=`#ifdef REFLECTION
vec3 baseDiffuseEnvironmentLight=sampleIrradiance(
normalW
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,vEnvironmentIrradiance
#endif
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
,reflectionMatrix
#endif
#ifdef USEIRRADIANCEMAP
,irradianceSampler
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
,vReflectionDominantDirection
#endif
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,icdfSampler
#endif
#endif
,vReflectionInfos
,viewDirectionW
,base_diffuse_roughness
,base_color
);
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=vec3(0.,0.,0.);
#else
vec2 reflectionCoords=vec2(0.,0.);
#endif
float specularAlphaG=specular_roughness*specular_roughness;
#ifdef ANISOTROPIC_BASE
vec3 baseSpecularEnvironmentLight=sampleRadianceAnisotropic(specularAlphaG,vReflectionMicrosurfaceInfos.rgb,vReflectionInfos
,baseGeoInfo
,normalW
,viewDirectionW
,vPositionW
,noise
,reflectionSampler
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
);
#else
reflectionCoords=createReflectionCoords(vPositionW,normalW);vec3 baseSpecularEnvironmentLight=sampleRadiance(specularAlphaG,vReflectionMicrosurfaceInfos.rgb,vReflectionInfos
,baseGeoInfo
,reflectionSampler
,reflectionCoords
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
);
#endif
#ifdef ANISOTROPIC_BASE
baseSpecularEnvironmentLight=mix(baseSpecularEnvironmentLight.rgb,baseDiffuseEnvironmentLight,specularAlphaG*specularAlphaG*max(1.0-baseGeoInfo.anisotropy,0.3));
#else
baseSpecularEnvironmentLight=mix(baseSpecularEnvironmentLight.rgb,baseDiffuseEnvironmentLight,specularAlphaG);
#endif
vec3 coatEnvironmentLight=vec3(0.,0.,0.);if (coat_weight>0.0) {
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=vec3(0.,0.,0.);
#else
vec2 reflectionCoords=vec2(0.,0.);
#endif
reflectionCoords=createReflectionCoords(vPositionW,coatNormalW);float coatAlphaG=coat_roughness*coat_roughness;
#ifdef ANISOTROPIC_COAT
coatEnvironmentLight=sampleRadianceAnisotropic(coatAlphaG,vReflectionMicrosurfaceInfos.rgb,vReflectionInfos
,coatGeoInfo
,coatNormalW
,viewDirectionW
,vPositionW
,noise
,reflectionSampler
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
);
#else
coatEnvironmentLight=sampleRadiance(coatAlphaG,vReflectionMicrosurfaceInfos.rgb,vReflectionInfos
,coatGeoInfo
,reflectionSampler
,reflectionCoords
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
);
#endif
}
float dielectricIblFresnel=getReflectanceFromBRDFLookup(vec3(baseDielectricReflectance.F0),vec3(baseDielectricReflectance.F90),baseGeoInfo.environmentBrdf).r;vec3 dielectricIblColoredFresnel=dielectricIblFresnel*specular_color;
#ifdef THIN_FILM
float thinFilmIorScale=clamp(2.0f*abs(thin_film_ior-1.0f),0.0f,1.0f);vec3 thinFilmDielectricFresnel=evalIridescence(thin_film_outside_ior,thin_film_ior,baseGeoInfo.NdotV,thin_film_thickness,baseDielectricReflectance.coloredF0);dielectricIblColoredFresnel=mix(dielectricIblColoredFresnel,thinFilmDielectricFresnel*specular_color,thin_film_weight*thinFilmIorScale);
#endif
vec3 conductorIblFresnel=conductorIblFresnel(baseConductorReflectance,baseGeoInfo.NdotV,specular_roughness,baseGeoInfo.environmentBrdf);
#ifdef THIN_FILM
vec3 thinFilmConductorFresnel=specular_weight*evalIridescence(thin_film_outside_ior,thin_film_ior,baseGeoInfo.NdotV,thin_film_thickness,baseConductorReflectance.coloredF0);conductorIblFresnel=mix(conductorIblFresnel,thinFilmConductorFresnel,thin_film_weight*thinFilmIorScale);
#endif
float coatIblFresnel=0.0;if (coat_weight>0.0) {coatIblFresnel=getReflectanceFromBRDFLookup(vec3(coatReflectance.F0),vec3(coatReflectance.F90),coatGeoInfo.environmentBrdf).r;}
vec3 slab_diffuse_ibl=vec3(0.,0.,0.);vec3 slab_glossy_ibl=vec3(0.,0.,0.);vec3 slab_metal_ibl=vec3(0.,0.,0.);vec3 slab_coat_ibl=vec3(0.,0.,0.);slab_diffuse_ibl=baseDiffuseEnvironmentLight*vLightingIntensity.z;slab_diffuse_ibl*=aoOut.ambientOcclusionColor;slab_glossy_ibl=baseSpecularEnvironmentLight*vLightingIntensity.z;slab_metal_ibl=baseSpecularEnvironmentLight*conductorIblFresnel*vLightingIntensity.z;vec3 coatAbsorption=vec3(1.0);if (coat_weight>0.0) {slab_coat_ibl=coatEnvironmentLight*vLightingIntensity.z;float hemisphere_avg_fresnel=coatReflectance.F0+0.5*(1.0-coatReflectance.F0);float averageReflectance=(coatIblFresnel+hemisphere_avg_fresnel)*0.5;float roughnessFactor=1.0-coat_roughness*0.5;averageReflectance*=roughnessFactor;float darkened_transmission=(1.0-averageReflectance)*(1.0-averageReflectance);darkened_transmission=mix(1.0,darkened_transmission,coat_darkening);float sin2=1.0-coatGeoInfo.NdotV*coatGeoInfo.NdotV;sin2=sin2/(coat_ior*coat_ior);float cos_t=sqrt(1.0-sin2);float coatPathLength=1.0/cos_t;vec3 colored_transmission=pow(coat_color,vec3(coatPathLength));coatAbsorption=mix(vec3(1.0),colored_transmission*darkened_transmission,coat_weight);}
vec3 slab_subsurface_ibl=vec3(0.,0.,0.);vec3 slab_translucent_base_ibl=vec3(0.,0.,0.);vec3 slab_fuzz_ibl=vec3(0.,0.,0.);slab_diffuse_ibl*=base_color.rgb;
#define CUSTOM_FRAGMENT_BEFORE_IBLLAYERCOMPOSITION
vec3 material_opaque_base_ibl=mix(slab_diffuse_ibl,slab_subsurface_ibl,subsurface_weight);vec3 material_dielectric_base_ibl=mix(material_opaque_base_ibl,slab_translucent_base_ibl,transmission_weight);vec3 material_dielectric_gloss_ibl=material_dielectric_base_ibl*(1.0-dielectricIblFresnel)+slab_glossy_ibl*dielectricIblColoredFresnel;vec3 material_base_substrate_ibl=mix(material_dielectric_gloss_ibl,slab_metal_ibl,base_metalness);vec3 material_coated_base_ibl=layer(material_base_substrate_ibl,slab_coat_ibl,coatIblFresnel,coatAbsorption,vec3(1.0));material_surface_ibl=mix(material_coated_base_ibl,slab_fuzz_ibl,fuzz_weight);
#endif
`;S.IncludesShadersStore[vT]||(S.IncludesShadersStore[vT]=mG);const xT="openpbrDirectLightingInit",_G=`#ifdef LIGHT{X}
preLightingInfo preInfo{X};preLightingInfo preInfoCoat{X};vec4 lightColor{X}=light{X}.vLightDiffuse;float shadow{X}=1.;
#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})
#else
#define CUSTOM_LIGHT{X}_COLOR 
#ifdef SPOTLIGHT{X}
preInfo{X}=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,vPositionW);preInfoCoat{X}=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,coatNormalW,vPositionW);
#elif defined(POINTLIGHT{X})
preInfo{X}=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,vPositionW);preInfoCoat{X}=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,coatNormalW,vPositionW);
#elif defined(HEMILIGHT{X})
preInfo{X}=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);preInfoCoat{X}=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,coatNormalW);
#elif defined(DIRLIGHT{X})
preInfo{X}=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);preInfoCoat{X}=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,coatNormalW);
#elif defined(AREALIGHT{X}) && defined(AREALIGHTSUPPORTED)
preInfo{X}=computeAreaPreLightingInfo(areaLightsLTC1Sampler,areaLightsLTC2Sampler,viewDirectionW,normalW,vPositionW,light{X}.vLightData,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,specular_roughness);preInfoCoat{X}=computeAreaPreLightingInfo(areaLightsLTC1Sampler,areaLightsLTC2Sampler,viewDirectionW,coatNormalW,vPositionW,light{X}.vLightData,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,coat_roughness);
#endif
preInfo{X}.NdotV=baseGeoInfo.NdotV;preInfoCoat{X}.NdotV=coatGeoInfo.NdotV;
#ifdef SPOTLIGHT{X}
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo{X}.attenuation=computeDistanceLightFalloff_GLTF(preInfo{X}.lightDistanceSquared,light{X}.vLightFalloff.y);
#ifdef IESLIGHTTEXTURE{X}
preInfo{X}.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo{X}.L,iesLightTexture{X});
#else
preInfo{X}.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo{X}.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo{X}.attenuation=computeDistanceLightFalloff_Physical(preInfo{X}.lightDistanceSquared);
#ifdef IESLIGHTTEXTURE{X}
preInfo{X}.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo{X}.L,iesLightTexture{X});
#else
preInfo{X}.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo{X}.L,light{X}.vLightDirection.w);
#endif
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo{X}.attenuation=computeDistanceLightFalloff_Standard(preInfo{X}.lightOffset,light{X}.vLightFalloff.x);
#ifdef IESLIGHTTEXTURE{X}
preInfo{X}.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo{X}.L,iesLightTexture{X});
#else
preInfo{X}.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo{X}.L,light{X}.vLightDirection.w,light{X}.vLightData.w);
#endif
#else
preInfo{X}.attenuation=computeDistanceLightFalloff(preInfo{X}.lightOffset,preInfo{X}.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#ifdef IESLIGHTTEXTURE{X}
preInfo{X}.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo{X}.L,iesLightTexture{X});
#else
preInfo{X}.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo{X}.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#endif
#elif defined(POINTLIGHT{X})
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo{X}.attenuation=computeDistanceLightFalloff_GLTF(preInfo{X}.lightDistanceSquared,light{X}.vLightFalloff.y);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo{X}.attenuation=computeDistanceLightFalloff_Physical(preInfo{X}.lightDistanceSquared);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo{X}.attenuation=computeDistanceLightFalloff_Standard(preInfo{X}.lightOffset,light{X}.vLightFalloff.x);
#else
preInfo{X}.attenuation=computeDistanceLightFalloff(preInfo{X}.lightOffset,preInfo{X}.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#endif
#else
preInfo{X}.attenuation=1.0;
#endif
preInfoCoat{X}.attenuation=preInfo{X}.attenuation;
#if defined(HEMILIGHT{X}) || defined(AREALIGHT{X})
preInfo{X}.roughness=specular_roughness;preInfoCoat{X}.roughness=coat_roughness;
#else
preInfo{X}.roughness=adjustRoughnessFromLightProperties(specular_roughness,light{X}.vLightSpecular.a,preInfo{X}.lightDistance);preInfoCoat{X}.roughness=adjustRoughnessFromLightProperties(coat_roughness,light{X}.vLightSpecular.a,preInfoCoat{X}.lightDistance);
#endif
preInfo{X}.diffuseRoughness=base_diffuse_roughness;preInfo{X}.surfaceAlbedo=base_color.rgb;
#endif
#endif
`;S.IncludesShadersStore[xT]||(S.IncludesShadersStore[xT]=_G);const ET="openpbrDirectLighting",gG=`#ifdef LIGHT{X}
{vec3 slab_diffuse=vec3(0.,0.,0.);vec3 slab_subsurface=vec3(0.,0.,0.);vec3 slab_translucent=vec3(0.,0.,0.);vec3 slab_glossy=vec3(0.,0.,0.);float specularFresnel=0.0;vec3 specularColoredFresnel=vec3(0.,0.,0.);vec3 slab_metal=vec3(0.,0.,0.);vec3 slab_coat=vec3(0.,0.,0.);float coatFresnel=0.0;vec3 slab_fuzz=vec3(0.,0.,0.);
#ifdef HEMILIGHT{X}
slab_diffuse=computeHemisphericDiffuseLighting(preInfo{X},lightColor{X}.rgb,light{X}.vLightGround);
#elif defined(AREALIGHT{X})
slab_diffuse=computeAreaDiffuseLighting(preInfo{X},lightColor{X}.rgb);
#else
slab_diffuse=computeDiffuseLighting(preInfo{X},lightColor{X}.rgb);
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
slab_diffuse*=computeProjectionTextureDiffuseLighting(projectionLightTexture{X},textureProjectionMatrix{X},vPositionW);
#endif
numLights+=1.0;
#if AREALIGHT{X}
slab_glossy=computeAreaSpecularLighting(preInfo{X},light{X}.vLightSpecular.rgb,baseConductorReflectance.F0,baseConductorReflectance.F90);
#else
{
#ifdef ANISOTROPIC_BASE
slab_glossy=computeAnisotropicSpecularLighting(preInfo{X},viewDirectionW,normalW,
baseGeoInfo.anisotropicTangent,baseGeoInfo.anisotropicBitangent,baseGeoInfo.anisotropy,
0.0,lightColor{X}.rgb);
#else
slab_glossy=computeSpecularLighting(preInfo{X},normalW,vec3(1.0),vec3(1.0),specular_roughness,lightColor{X}.rgb);
#endif
float NdotH=dot(normalW,preInfo{X}.H);specularFresnel=fresnelSchlickGGX(NdotH,baseDielectricReflectance.F0,baseDielectricReflectance.F90);specularColoredFresnel=specularFresnel*specular_color;
#ifdef THIN_FILM
float thinFilmIorScale=clamp(2.0f*abs(thin_film_ior-1.0f),0.0f,1.0f);vec3 thinFilmDielectricFresnel=evalIridescence(thin_film_outside_ior,thin_film_ior,preInfo{X}.VdotH,thin_film_thickness,baseDielectricReflectance.coloredF0);specularColoredFresnel=mix(specularColoredFresnel,thinFilmDielectricFresnel*specular_color,thin_film_weight*thinFilmIorScale);
#endif
}
#endif
#if AREALIGHT{X}
slab_metal=computeAreaSpecularLighting(preInfo{X},light{X}.vLightSpecular.rgb,baseConductorReflectance.F0,baseConductorReflectance.F90);
#else
{
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
vec3 coloredFresnel=getF82Specular(preInfo{X}.VdotH,baseConductorReflectance.coloredF0,baseConductorReflectance.coloredF90,specular_roughness);
#else
vec3 coloredFresnel=fresnelSchlickGGX(preInfo{X}.VdotH,baseConductorReflectance.coloredF0,baseConductorReflectance.coloredF90);
#endif
#ifdef THIN_FILM
float thinFilmIorScale=clamp(2.0f*abs(thin_film_ior-1.0f),0.0f,1.0f);vec3 thinFilmConductorFresnel=evalIridescence(thin_film_outside_ior,thin_film_ior,preInfo{X}.VdotH,thin_film_thickness,baseConductorReflectance.coloredF0);coloredFresnel=mix(coloredFresnel,specular_weight*thinFilmIorScale*thinFilmConductorFresnel,thin_film_weight);
#endif
#ifdef ANISOTROPIC_BASE
slab_metal=computeAnisotropicSpecularLighting(preInfo{X},viewDirectionW,normalW,baseGeoInfo.anisotropicTangent,baseGeoInfo.anisotropicBitangent,baseGeoInfo.anisotropy,0.0,lightColor{X}.rgb);
#else
slab_metal=computeSpecularLighting(preInfo{X},normalW,vec3(1.0),coloredFresnel,specular_roughness,lightColor{X}.rgb);
#endif
}
#endif
#if AREALIGHT{X}
slab_coat=computeAreaSpecularLighting(preInfoCoat{X},light{X}.vLightSpecular.rgb,coatReflectance.F0,coatReflectance.F90);
#else
{
#ifdef ANISOTROPIC_COAT
slab_coat=computeAnisotropicSpecularLighting(preInfoCoat{X},viewDirectionW,coatNormalW,
coatGeoInfo.anisotropicTangent,coatGeoInfo.anisotropicBitangent,coatGeoInfo.anisotropy,
0.0,lightColor{X}.rgb);
#else
slab_coat=computeSpecularLighting(preInfoCoat{X},coatNormalW,vec3(coatReflectance.F0),vec3(1.0),coat_roughness,lightColor{X}.rgb);
#endif
float NdotH=dot(coatNormalW,preInfoCoat{X}.H);coatFresnel=fresnelSchlickGGX(NdotH,coatReflectance.F0,coatReflectance.F90);}
#endif
vec3 coatAbsorption=vec3(1.0);if (coat_weight>0.0) {float cosTheta_view=max(preInfoCoat{X}.NdotV,0.001);float cosTheta_light=max(preInfoCoat{X}.NdotL,0.001);float fresnel_view=coatReflectance.F0+(1.0-coatReflectance.F0)*pow(1.0-cosTheta_view,5.0);float fresnel_light=coatReflectance.F0+(1.0-coatReflectance.F0)*pow(1.0-cosTheta_light,5.0);float averageReflectance=(fresnel_view+fresnel_light)*0.5;float darkened_transmission=(1.0-averageReflectance)/(1.0+averageReflectance);darkened_transmission=mix(1.0,darkened_transmission,coat_darkening);float sin2=1.0-cosTheta_view*cosTheta_view;sin2=sin2/(coat_ior*coat_ior);float cos_t=sqrt(1.0-sin2);float coatPathLength=1.0/cos_t;vec3 colored_transmission=pow(coat_color,vec3(coatPathLength));coatAbsorption=mix(vec3(1.0),colored_transmission*darkened_transmission,coat_weight);}
slab_diffuse*=base_color.rgb;vec3 material_opaque_base=mix(slab_diffuse,slab_subsurface,subsurface_weight);vec3 material_dielectric_base=mix(material_opaque_base,slab_translucent,transmission_weight);vec3 material_dielectric_gloss=material_dielectric_base*(1.0-specularFresnel)+slab_glossy*specularColoredFresnel;vec3 material_base_substrate=mix(material_dielectric_gloss,slab_metal,base_metalness);vec3 material_coated_base=layer(material_base_substrate,slab_coat,coatFresnel,coatAbsorption,vec3(1.0));material_surface_direct+=mix(material_coated_base,slab_fuzz,fuzz_weight);}
#endif
`;S.IncludesShadersStore[ET]||(S.IncludesShadersStore[ET]=gG);const ef="openpbrPixelShader",MA=`#define OPENPBR_FRAGMENT_SHADER
#define CUSTOM_FRAGMENT_EXTENSION
#if defined(GEOMETRY_NORMAL) || defined(GEOMETRY_COAT_NORMAL) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA)
#extension GL_OES_standard_derivatives : enable
#endif
#ifdef LODBASEDMICROSFURACE
#extension GL_EXT_shader_texture_lod : enable
#endif
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
precision highp float;
#include<oitDeclaration>
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE
#endif
#include<__decl__openpbrFragment>
#include<pbrFragmentExtraDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<openpbrFragmentSamplersDeclaration>
#include<imageProcessingDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<importanceSampling>
#include<pbrHelperFunctions>
#include<imageProcessingFunctions>
#include<shadowsFragmentFunctions>
#include<harmonicsFunctions>
#include<pbrDirectLightingSetupFunctions>
#include<pbrDirectLightingFalloffFunctions>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
#include<pbrDirectLightingFunctions>
#include<pbrIBLFunctions>
#include<openpbrNormalMapFragmentMainFunctions>
#include<openpbrNormalMapFragmentFunctions>
#ifdef REFLECTION
#include<reflectionFunction>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
#include<openpbrDielectricReflectance>
#include<openpbrConductorReflectance>
#include<openpbrBlockAmbientOcclusion>
#include<openpbrGeometryInfo>
#include<openpbrIblFunctions>
vec3 layer(vec3 slab_bottom,vec3 slab_top,float lerp_factor,vec3 bottom_multiplier,vec3 top_multiplier) {return mix(slab_bottom*bottom_multiplier,slab_top*top_multiplier,lerp_factor);}
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#include<pbrBlockNormalGeometric>
vec3 coatNormalW=normalW;
#include<openpbrNormalMapFragment>
#include<openpbrBlockNormalFinal>
#include<openpbrBaseLayerData>
#include<openpbrCoatLayerData>
#include<openpbrThinFilmLayerData>
float subsurface_weight=0.0;float transmission_weight=0.0;float fuzz_weight=0.0;
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
#include<depthPrePass>
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
ambientOcclusionOutParams aoOut;
#ifdef AMBIENT_OCCLUSION
vec3 ambientOcclusionFromTexture=texture2D(ambientOcclusionSampler,vAmbientOcclusionUV+uvOffset).rgb;
#endif
aoOut=ambientOcclusionBlock(
#ifdef AMBIENT_OCCLUSION
ambientOcclusionFromTexture,
vAmbientOcclusionInfos
#endif
);
#ifdef ANISOTROPIC_COAT
geometryInfoAnisoOutParams coatGeoInfo=geometryInfoAniso(
coatNormalW,viewDirectionW.xyz,coat_roughness,geometricNormalW
,vec3(geometry_coat_tangent.x,geometry_coat_tangent.y,coat_roughness_anisotropy),TBN
);
#else
geometryInfoOutParams coatGeoInfo=geometryInfo(
coatNormalW,viewDirectionW.xyz,coat_roughness,geometricNormalW
);
#endif
specular_roughness=mix(specular_roughness,pow(min(1.0,pow(specular_roughness,4.0)+2.0*pow(coat_roughness,4.0)),0.25),coat_weight);
#ifdef ANISOTROPIC_BASE
geometryInfoAnisoOutParams baseGeoInfo=geometryInfoAniso(
normalW,viewDirectionW.xyz,specular_roughness,geometricNormalW
,vec3(geometry_tangent.x,geometry_tangent.y,specular_roughness_anisotropy),TBN
);
#else
geometryInfoOutParams baseGeoInfo=geometryInfo(
normalW,viewDirectionW.xyz,specular_roughness,geometricNormalW
);
#endif
ReflectanceParams coatReflectance;coatReflectance=dielectricReflectance(
coat_ior 
,1.0 
,vec3(1.0)
,coat_weight
);
#ifdef THIN_FILM
float thin_film_outside_ior=mix(1.0,coat_ior,coat_weight);
#endif
ReflectanceParams baseDielectricReflectance;{float effectiveCoatIor=mix(1.0,coat_ior,coat_weight);baseDielectricReflectance=dielectricReflectance(
specular_ior 
,effectiveCoatIor 
,specular_color
,specular_weight
);}
ReflectanceParams baseConductorReflectance;baseConductorReflectance=conductorReflectance(base_color,specular_color,specular_weight);vec3 material_surface_ibl=vec3(0.,0.,0.);
#include<openpbrEnvironmentLighting>
vec3 material_surface_direct=vec3(0.,0.,0.);
#if defined(LIGHT0)
float aggShadow=0.;float numLights=0.;
#include<openpbrDirectLightingInit>[0..maxSimultaneousLights]
#include<openpbrDirectLighting>[0..maxSimultaneousLights]
#endif
vec3 material_surface_emission=vEmissionColor;
#ifdef EMISSION_COLOR
vec3 emissionColorTex=texture2D(emissionColorSampler,vEmissionColorUV+uvOffset).rgb;
#ifdef EMISSION_COLOR_GAMMA
material_surface_emission*=toLinearSpace(emissionColorTex.rgb);
#else
material_surface_emission*=emissionColorTex.rgb;
#endif
material_surface_emission*= vEmissionColorInfos.y;
#endif
material_surface_emission*=vLightingIntensity.y;
#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION
vec4 finalColor=vec4(material_surface_ibl+material_surface_direct+material_surface_emission,alpha);
#define CUSTOM_FRAGMENT_BEFORE_FOG
finalColor=max(finalColor,0.0);
#include<logDepthFragment>
#include<fogFragment>(color,finalColor)
#include<pbrBlockImageProcessing>
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
#include<pbrBlockPrePass>
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=finalColor;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {frontColor.rgb+=finalColor.rgb*finalColor.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-finalColor.a);} else {backColor+=finalColor;}
#endif
#include<pbrDebug>
#define CUSTOM_FRAGMENT_MAIN_END
}
`;S.ShadersStore[ef]||(S.ShadersStore[ef]=MA);const SG={name:ef,shader:MA},vG=Object.freeze(Object.defineProperty({__proto__:null,openpbrPixelShader:SG},Symbol.toStringTag,{value:"Module"}));var TT;(function(s){s[s.GLSL=0]="GLSL",s[s.WGSL=1]="WGSL"})(TT||(TT={}));class po extends ps{constructor(e,t,i=null){if(super(t),!!e)if(this._textureMatrix=z.Identity(),this.name=e,this.url=e,this._onLoad=i,this._texture=this._getFromCache(e,!0),this._texture)this._triggerOnLoad();else{const r=this.getScene();r?r.useDelayedTextureLoading?this.delayLoadState=4:this._loadTexture():this._loadTexture()}}_triggerOnLoad(){this._onLoad&&this._onLoad()}getTextureMatrix(){return this._textureMatrix}_load3dlTexture(){const e=this._getEngine();let t;e._features.support3DTextures?t=e.createRawTexture3D(null,1,1,1,5,!1,!1,2,null,0):t=e.createRawTexture(null,1,1,5,!1,!1,2,null,0),this._texture=t,this._texture.isReady=!1,this.isCube=!1,this.is3D=e._features.support3DTextures,this.wrapU=0,this.wrapV=0,this.wrapR=0,this.anisotropicFilteringLevel=1;const i=n=>{if(typeof n!="string")return;let a=null,o=null,l;const c=n.split(`
`);let u=0,h=0,d=0,f=0,m=0;for(let g=0;g<c.length;g++){if(l=c[g],!po._NoneEmptyLineRegex.test(l)||l.indexOf("#")===0)continue;const v=l.split(" ");if(u===0){u=v.length,a=new Uint8Array(u*u*u*4),o=new Float32Array(u*u*u*4);continue}if(u!=0){const E=Math.max(parseInt(v[0]),0),T=Math.max(parseInt(v[1]),0),C=Math.max(parseInt(v[2]),0);m=Math.max(E,m),m=Math.max(T,m),m=Math.max(C,m);const A=(h+f*u+d*u*u)*4;o&&(o[A+0]=E,o[A+1]=T,o[A+2]=C),d++,d%u==0&&(f++,d=0,f%u==0&&(h++,f=0))}}if(o&&a)for(let g=0;g<o.length;g++)if(g>0&&(g+1)%4===0)a[g]=255;else{const v=o[g];a[g]=v/m*255}t.is3D?(t.updateSize(u,u,u),e.updateRawTexture3D(t,a,5,!1)):(t.updateSize(u*u,u),e.updateRawTexture(t,a,5,!1)),t.isReady=!0,this._triggerOnLoad()},r=this.getScene();return r?r._loadFile(this.url,i):e._loadFile(this.url,i),this._texture}_loadTexture(){if(this.url){const e=this.url.toLocaleLowerCase();(e.endsWith(".3dl")||e.startsWith("blob:"))&&this._load3dlTexture()}}clone(){const e=new po(this.url,this.getScene()||this._getEngine());return e.level=this.level,e}delayLoad(){this.delayLoadState===4&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,!0),this._texture||this._loadTexture())}static Parse(e,t){let i=null;return e.name&&!e.isRenderTarget&&(i=new po(e.name,t),i.name=e.name,i.level=e.level),i}serialize(){if(!this.name)return null;const e={};return e.name=this.name,e.level=this.level,e.customType="BABYLON.ColorGradingTexture",e}}po._NoneEmptyLineRegex=/\S+/;y("BABYLON.ColorGradingTexture",po);class ou extends ps{constructor(e,t,i,r=!1,n=!0,a=null,o=null,l=!1){if(super(t),this._onLoad=null,this._onError=null,!e)throw new Error("Image url is not set");this._coordinatesMode=$.CUBIC_MODE,this.name=e,this.url=e,this._size=i,this._supersample=l,this._noMipmap=r,this.gammaSpace=n,this._onLoad=a,this._onError=o,this.hasAlpha=!1,this.isCube=!0,this._texture=this._getFromCache(e,this._noMipmap,void 0,void 0,void 0,this.isCube),this._texture?a&&(this._texture.isReady?j.SetImmediate(()=>a()):this._texture.onLoadedObservable.add(a)):t.useDelayedTextureLoading?this.delayLoadState=4:this._loadImage(()=>this._loadTexture(),this._onError)}_loadImage(e,t){const i=this.getScene();if(!i)return;const r=i.getEngine().createRawCubeTexture(null,this._size,4,i.getEngine().getCaps().textureFloat?1:7,!this._noMipmap,!1,3);r.generateMipMaps=!this._noMipmap,i.addPendingData(r),r.url=this.url,r.isReady=!1,i.getEngine()._internalTexturesCache.push(r),this._texture=r,LD(this.url,n=>{this._width=n.width,this._height=n.height;let a;wD()?(a=document.createElement("canvas"),a.width=this._width,a.height=this._height):a=new OffscreenCanvas(this._width,this._height);const o=a.getContext("2d");o.drawImage(n,0,0);const l=o.getImageData(0,0,n.width,n.height);this._buffer=l.data.buffer,a.remove&&a.remove(),e()},(n,a)=>{i.removePendingData(r),t&&t(`${this.getClassName()} could not be loaded`,a)},i?i.offlineProvider:null)}_loadTexture(){const e=this.getScene(),t=()=>{const n=this._getFloat32ArrayFromArrayBuffer(this._buffer),a=PI.ConvertPanoramaToCubemap(n,this._width,this._height,this._size,this._supersample),o=[];for(let l=0;l<6;l++){const c=a[ou._FacesMapping[l]];o.push(c)}return o};if(!e)return;const i=t(),r=this._texture;e.getEngine().updateRawCubeTexture(r,i,r.format,r.type,r.invertY),r.isReady=!0,e.removePendingData(r),r.onLoadedObservable.notifyObservers(r),r.onLoadedObservable.clear(),this._onLoad&&this._onLoad()}_getFloat32ArrayFromArrayBuffer(e){const t=new DataView(e),i=new Float32Array(e.byteLength*3/4);let r=0;for(let n=0;n<e.byteLength;n++)(n+1)%4!==0&&(i[r++]=t.getUint8(n)/255);return i}getClassName(){return"EquiRectangularCubeTexture"}clone(){const e=this.getScene();if(!e)return this;const t=new ou(this.url,e,this._size,this._noMipmap,this.gammaSpace);return t.level=this.level,t.wrapU=this.wrapU,t.wrapV=this.wrapV,t.coordinatesIndex=this.coordinatesIndex,t.coordinatesMode=this.coordinatesMode,t}}ou._FacesMapping=["right","left","up","down","front","back"];class lu extends lc{constructor(e,t,i,r=!1,n=!0,a=!1,o=!1,l=null,c=null,u=!1,h=!1,d=!1){super(e,t,i,r,n,a,o,l,c,u,h,d)}getClassName(){return"EXRCubeTexture"}async _getCubeMapTextureDataAsync(e,t,i){const r=await mM(e);if(!r.data)throw new Error("EXR data could not be decoded.");return PI.ConvertPanoramaToCubemap(r.data,r.width,r.height,t,i,!1)}_instantiateClone(){return new lu(this.url,this.getScene()||this._getEngine(),this._size,this._noMipmap,this._generateHarmonics,this.gammaSpace)}serialize(){const e=super.serialize();return e?(e.customType="BABYLON.EXRCubeTexture",e):null}static Parse(e,t,i){if(!e.name||e.isRenderTarget)return null;const r=new lu(i+e.name,t,e.size,e.noMipmap,e.generateHarmonics,e.useInGammaSpace);return this._Parse(e,r),r}}y("BABYLON.EXRCubeTexture",lu);class w_ extends ps{constructor(e,t,i){if(super(i.scene||i.engine),this.onLoadObservable=new k,!(!t||!i.engine&&!i.scene)){if(i={...w_._DefaultOptions,...i},this._generateMipMaps=i.generateMipMaps,this._samplingMode=i.samplingMode,this._textureMatrix=z.Identity(),this._format=i.format,this.name=e,this.element=t,this._isVideo=!!t.getVideoPlaybackQuality,this._isVideo){const r=this._engine,n=r==null?void 0:r.createExternalTexture;n&&(this._externalTexture=n.call(r,t))}this.anisotropicFilteringLevel=1,this._createInternalTexture()}}_createInternalTexture(){let e=0,t=0;this._isVideo?(e=this.element.videoWidth,t=this.element.videoHeight):(e=this.element.width,t=this.element.height);const i=this._getEngine();i&&(this._texture=i.createDynamicTexture(e,t,this._generateMipMaps,this._samplingMode),this._texture.format=this._format),this.update()}getTextureMatrix(){return this._textureMatrix}update(e=null){const t=this._getEngine();if(this._texture==null||t==null)return;const i=this.isReady();if(this._isVideo){const r=this.element;if(r.readyState<r.HAVE_CURRENT_DATA)return;t.updateVideoTexture(this._texture,this._externalTexture?this._externalTexture:r,e===null?!0:e)}else{const r=this.element;t.updateDynamicTexture(this._texture,r,e===null?!0:e,!1,this._format)}!i&&this.isReady()&&this.onLoadObservable.notifyObservers(this)}dispose(){this.onLoadObservable.clear(),super.dispose()}}w_._DefaultOptions={generateMipMaps:!1,samplingMode:2,format:5,engine:null,scene:null};class da extends Zi{get isSupported(){var e;return((e=this._engine)==null?void 0:e.getCaps().drawBuffersExtension)??!1}get textures(){return this._textures}get count(){return this._count}get depthTexture(){return this._textures[this._textures.length-1]}set wrapU(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapU=e}set wrapV(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapV=e}constructor(e,t,i,r,n,a){const o=n&&n.generateMipMaps?n.generateMipMaps:!1,l=n&&n.generateDepthTexture?n.generateDepthTexture:!1,c=n&&n.depthTextureFormat?n.depthTextureFormat:15,u=!n||n.doNotChangeAspectRatio===void 0?!0:n.doNotChangeAspectRatio,h=n&&n.drawOnlyOnFirstAttachmentByDefault?n.drawOnlyOnFirstAttachmentByDefault:!1;if(super(e,t,r,o,u,void 0,void 0,void 0,void 0,void 0,void 0,void 0,!0),!this.isSupported){this.dispose();return}this._textureNames=a;const d=[],f=[],m=[],g=[],v=[],E=[],T=[],C=[];this._initTypes(i,d,f,m,g,v,E,T,C,n);const A=!n||n.generateDepthBuffer===void 0?!0:n.generateDepthBuffer,I=!n||n.generateStencilBuffer===void 0?!1:n.generateStencilBuffer,F=n&&n.samples?n.samples:1;this._multiRenderTargetOptions={samplingModes:f,generateMipMaps:o,generateDepthBuffer:A,generateStencilBuffer:I,generateDepthTexture:l,depthTextureFormat:c,types:d,textureCount:i,useSRGBBuffers:m,samples:F,formats:g,targetTypes:v,faceIndex:E,layerIndex:T,layerCounts:C,labels:a,label:e},this._count=i,this._drawOnlyOnFirstAttachmentByDefault=h,i>0&&(this._createInternalTextures(),this._createTextures(a))}_initTypes(e,t,i,r,n,a,o,l,c,u){for(let h=0;h<e;h++)u&&u.types&&u.types[h]!==void 0?t.push(u.types[h]):t.push(u&&u.defaultType?u.defaultType:0),u&&u.samplingModes&&u.samplingModes[h]!==void 0?i.push(u.samplingModes[h]):i.push($.BILINEAR_SAMPLINGMODE),u&&u.useSRGBBuffers&&u.useSRGBBuffers[h]!==void 0?r.push(u.useSRGBBuffers[h]):r.push(!1),u&&u.formats&&u.formats[h]!==void 0?n.push(u.formats[h]):n.push(5),u&&u.targetTypes&&u.targetTypes[h]!==void 0?a.push(u.targetTypes[h]):a.push(3553),u&&u.faceIndex&&u.faceIndex[h]!==void 0?o.push(u.faceIndex[h]):o.push(0),u&&u.layerIndex&&u.layerIndex[h]!==void 0?l.push(u.layerIndex[h]):l.push(0),u&&u.layerCounts&&u.layerCounts[h]!==void 0?c.push(u.layerCounts[h]):c.push(1)}_createInternaTextureIndexMapping(){const e={},t=[];if(!this._renderTarget)return t;const i=this._renderTarget.textures;for(let r=0;r<i.length;r++){const n=i[r];if(!n)continue;const a=e[n.uniqueId];a!==void 0?t[r]=a:e[n.uniqueId]=r}return t}_rebuild(e=!1,t=!1,i){if(this._count<1||e)return;const r=this._createInternaTextureIndexMapping();this.releaseInternalTextures(),this._createInternalTextures(),t&&(this._releaseTextures(),this._createTextures(i));const n=this._renderTarget.textures;for(let a=0;a<n.length;a++){const o=this._textures[a];r[a]!==void 0&&this._renderTarget.setTexture(n[r[a]],a),o._texture=n[a],o._texture&&(o._noMipmap=!o._texture.useMipMaps,o._useSRGBBuffer=o._texture._useSRGBBuffer)}this.samples!==1&&this._renderTarget.setSamples(this.samples,!this._drawOnlyOnFirstAttachmentByDefault,!0)}_createInternalTextures(){this._renderTarget=this._getEngine().createMultipleRenderTarget(this._size,this._multiRenderTargetOptions,!this._drawOnlyOnFirstAttachmentByDefault),this._texture=this._renderTarget.texture}_releaseTextures(){if(this._textures)for(let e=0;e<this._textures.length;e++)this._textures[e]._texture=null,this._textures[e].dispose()}_createTextures(e){const t=this._renderTarget.textures;this._textures=[];for(let i=0;i<t.length;i++){const r=new $(null,this.getScene());e!=null&&e[i]&&(r.name=e[i]),r._texture=t[i],r._texture&&(r._noMipmap=!r._texture.useMipMaps,r._useSRGBBuffer=r._texture._useSRGBBuffer),this._textures.push(r)}}setInternalTexture(e,t,i=!0){var r;if(this.renderTarget&&(t===0&&(this._texture=e),this.renderTarget.setTexture(e,t,i),this.textures[t]||(this.textures[t]=new $(null,this.getScene()),this.textures[t].name=((r=this._textureNames)==null?void 0:r[t])??this.textures[t].name),this.textures[t]._texture=e,this.textures[t]._noMipmap=!e.useMipMaps,this.textures[t]._useSRGBBuffer=e._useSRGBBuffer,this._count=this.renderTarget.textures?this.renderTarget.textures.length:0,this._multiRenderTargetOptions.types&&(this._multiRenderTargetOptions.types[t]=e.type),this._multiRenderTargetOptions.samplingModes&&(this._multiRenderTargetOptions.samplingModes[t]=e.samplingMode),this._multiRenderTargetOptions.useSRGBBuffers&&(this._multiRenderTargetOptions.useSRGBBuffers[t]=e._useSRGBBuffer),this._multiRenderTargetOptions.targetTypes&&this._multiRenderTargetOptions.targetTypes[t]!==-1)){let n=0;e.is2DArray?n=35866:e.isCube?n=34067:e.is3D?n=32879:n=3553,this._multiRenderTargetOptions.targetTypes[t]=n}}setLayerAndFaceIndex(e,t=-1,i=-1){!this.textures[e]||!this.renderTarget||(this._multiRenderTargetOptions.layerIndex&&(this._multiRenderTargetOptions.layerIndex[e]=t),this._multiRenderTargetOptions.faceIndex&&(this._multiRenderTargetOptions.faceIndex[e]=i),this.renderTarget.setLayerAndFaceIndex(e,t,i))}setLayerAndFaceIndices(e,t){this.renderTarget&&(this._multiRenderTargetOptions.layerIndex=e,this._multiRenderTargetOptions.faceIndex=t,this.renderTarget.setLayerAndFaceIndices(e,t))}get samples(){return this._samples}set samples(e){this._renderTarget?this._samples=this._renderTarget.setSamples(e):this._samples=e}resize(e){this._processSizeParameter(e),this._rebuild(!1,void 0,this._textureNames)}updateCount(e,t,i){this._multiRenderTargetOptions.textureCount=e,this._count=e;const r=[],n=[],a=[],o=[],l=[],c=[],u=[],h=[];this._textureNames=i,this._initTypes(e,r,n,a,o,l,c,u,h,t),this._multiRenderTargetOptions.types=r,this._multiRenderTargetOptions.samplingModes=n,this._multiRenderTargetOptions.useSRGBBuffers=a,this._multiRenderTargetOptions.formats=o,this._multiRenderTargetOptions.targetTypes=l,this._multiRenderTargetOptions.faceIndex=c,this._multiRenderTargetOptions.layerIndex=u,this._multiRenderTargetOptions.layerCounts=h,this._multiRenderTargetOptions.labels=i,this._rebuild(!1,!0,i)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindMultiColorAttachmentFramebuffer(this._renderTarget,this.isCube,()=>{this.onAfterRenderObservable.notifyObservers(t)})}dispose(e=!1){this._releaseTextures(),e?this._texture=null:this.releaseInternalTextures(),super.dispose()}releaseInternalTextures(){var t,i;const e=(t=this._renderTarget)==null?void 0:t.textures;if(e){for(let r=e.length-1;r>=0;r--)this._textures[r]._texture=null;(i=this._renderTarget)==null||i.dispose(),this._renderTarget=null}}}const bT="noisePixelShader",xG=`uniform float brightness;uniform float persistence;uniform float timeScale;varying vec2 vUV;vec2 hash22(vec2 p)
{p=p*mat2(127.1,311.7,269.5,183.3);p=-1.0+2.0*fract(sin(p)*43758.5453123);return sin(p*6.283+timeScale);}
float interpolationNoise(vec2 p)
{vec2 pi=floor(p);vec2 pf=p-pi;vec2 w=pf*pf*(3.-2.*pf);float f00=dot(hash22(pi+vec2(.0,.0)),pf-vec2(.0,.0));float f01=dot(hash22(pi+vec2(.0,1.)),pf-vec2(.0,1.));float f10=dot(hash22(pi+vec2(1.0,0.)),pf-vec2(1.0,0.));float f11=dot(hash22(pi+vec2(1.0,1.)),pf-vec2(1.0,1.));float xm1=mix(f00,f10,w.x);float xm2=mix(f01,f11,w.x);float ym=mix(xm1,xm2,w.y); 
return ym;}
float perlinNoise2D(float x,float y)
{float sum=0.0;float frequency=0.0;float amplitude=0.0;for(int i=0; i<OCTAVES; i++)
{frequency=pow(2.0,float(i));amplitude=pow(persistence,float(i));sum=sum+interpolationNoise(vec2(x*frequency,y*frequency))*amplitude;}
return sum;}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{float x=abs(vUV.x);float y=abs(vUV.y);float noise=brightness+(1.0-brightness)*perlinNoise2D(x,y);gl_FragColor=vec4(noise,noise,noise,1.0);}
`;S.ShadersStore[bT]||(S.ShadersStore[bT]=xG);class cu extends sr{constructor(e,t=256,i=De.LastCreatedScene,r,n){super(e,t,"noise",i,r,n),this.time=0,this.brightness=.2,this.octaves=3,this.persistence=.8,this.animationSpeedFactor=1,this.autoClear=!1,this._updateShaderUniforms()}_updateShaderUniforms(){const e=this.getScene();e&&(this.time+=e.getAnimationRatio()*this.animationSpeedFactor*.01,this.setFloat("brightness",this.brightness),this.setFloat("persistence",this.persistence),this.setFloat("timeScale",this.time))}_getDefines(){return"#define OCTAVES "+(this.octaves|0)}render(e){this._updateShaderUniforms(),super.render(e)}serialize(){const e={};return e.customType="BABYLON.NoiseProceduralTexture",e.brightness=this.brightness,e.octaves=this.octaves,e.persistence=this.persistence,e.animationSpeedFactor=this.animationSpeedFactor,e.size=this.getSize().width,e.generateMipMaps=this._generateMipMaps,e.time=this.time,e}clone(){const e=this.getSize(),t=new cu(this.name,e.width,this.getScene(),this._fallbackTexture?this._fallbackTexture:void 0,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t.brightness=this.brightness,t.octaves=this.octaves,t.persistence=this.persistence,t.animationSpeedFactor=this.animationSpeedFactor,t.time=this.time,t}static Parse(e,t){const i=new cu(e.name,e.size,t,void 0,e.generateMipMaps);return i.brightness=e.brightness,i.octaves=e.octaves,i.persistence=e.persistence,i.animationSpeedFactor=e.animationSpeedFactor,i.time=e.time??0,i}}y("BABYLON.NoiseProceduralTexture",cu);const tf="proceduralVertexShader",FA=`attribute position: vec2f;varying vPosition: vec2f;varying vUV: vec2f;const madd: vec2f= vec2f(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
vertexOutputs.vPosition=input.position;vertexOutputs.vUV=input.position*madd+madd;vertexOutputs.position= vec4f(input.position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;S.ShadersStoreWGSL[tf]||(S.ShadersStoreWGSL[tf]=FA);const EG={name:tf,shader:FA},CT=Object.freeze(Object.defineProperty({__proto__:null,proceduralVertexShaderWGSL:EG},Symbol.toStringTag,{value:"Module"})),rf="proceduralVertexShader",LA=`attribute vec2 position;varying vec2 vPosition;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vPosition=position;vUV=position*madd+madd;gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;S.ShadersStore[rf]||(S.ShadersStore[rf]=LA);const TG={name:rf,shader:LA},yT=Object.freeze(Object.defineProperty({__proto__:null,proceduralVertexShader:TG},Symbol.toStringTag,{value:"Module"})),sf="hdrFilteringVertexShader",wA=`attribute vec2 position;varying vec3 direction;uniform vec3 up;uniform vec3 right;uniform vec3 front;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
mat3 view=mat3(up,right,front);direction=view*vec3(position,1.0);gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;S.ShadersStore[sf]||(S.ShadersStore[sf]=wA);const bG={name:sf,shader:wA},CG=Object.freeze(Object.defineProperty({__proto__:null,hdrFilteringVertexShader:bG},Symbol.toStringTag,{value:"Module"})),nf="hdrFilteringPixelShader",BA=`#include<helperFunctions>
#include<importanceSampling>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
uniform float alphaG;uniform samplerCube inputTexture;uniform vec2 vFilteringInfo;uniform float hdrScale;varying vec3 direction;void main() {vec3 color=radiance(alphaG,inputTexture,direction,vFilteringInfo);gl_FragColor=vec4(color*hdrScale,1.0);}`;S.ShadersStore[nf]||(S.ShadersStore[nf]=BA);const yG={name:nf,shader:BA},IG=Object.freeze(Object.defineProperty({__proto__:null,hdrFilteringPixelShader:yG},Symbol.toStringTag,{value:"Module"})),af="hdrFilteringVertexShader",VA=`attribute position: vec2f;varying direction: vec3f;uniform up: vec3f;uniform right: vec3f;uniform front: vec3f;
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
var view: mat3x3f= mat3x3f(uniforms.up,uniforms.right,uniforms.front);vertexOutputs.direction=view*vec3f(input.position,1.0);vertexOutputs.position= vec4f(input.position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;S.ShadersStoreWGSL[af]||(S.ShadersStoreWGSL[af]=VA);const RG={name:af,shader:VA},AG=Object.freeze(Object.defineProperty({__proto__:null,hdrFilteringVertexShaderWGSL:RG},Symbol.toStringTag,{value:"Module"})),of="hdrFilteringPixelShader",UA=`#include<helperFunctions>
#include<importanceSampling>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
uniform alphaG: f32;var inputTextureSampler: sampler;var inputTexture: texture_cube<f32>;uniform vFilteringInfo: vec2f;uniform hdrScale: f32;varying direction: vec3f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var color: vec3f=radiance(uniforms.alphaG,inputTexture,inputTextureSampler,input.direction,uniforms.vFilteringInfo);fragmentOutputs.color= vec4f(color*uniforms.hdrScale,1.0);}`;S.ShadersStoreWGSL[of]||(S.ShadersStoreWGSL[of]=UA);const PG={name:of,shader:UA},OG=Object.freeze(Object.defineProperty({__proto__:null,hdrFilteringPixelShaderWGSL:PG},Symbol.toStringTag,{value:"Module"})),lf="hdrIrradianceFilteringVertexShader",kA=`attribute vec2 position;varying vec3 direction;uniform vec3 up;uniform vec3 right;uniform vec3 front;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
mat3 view=mat3(up,right,front);direction=view*vec3(position,1.0);gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;S.ShadersStore[lf]||(S.ShadersStore[lf]=kA);const NG={name:lf,shader:kA},DG=Object.freeze(Object.defineProperty({__proto__:null,hdrIrradianceFilteringVertexShader:NG},Symbol.toStringTag,{value:"Module"})),cf="hdrIrradianceFilteringPixelShader",GA=`#include<helperFunctions>
#include<importanceSampling>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
uniform samplerCube inputTexture;
#ifdef IBL_CDF_FILTERING
uniform sampler2D icdfTexture;
#endif
uniform vec2 vFilteringInfo;uniform float hdrScale;varying vec3 direction;void main() {vec3 color=irradiance(inputTexture,direction,vFilteringInfo,0.0,vec3(1.0),direction
#ifdef IBL_CDF_FILTERING
,icdfTexture
#endif
);gl_FragColor=vec4(color*hdrScale,1.0);}`;S.ShadersStore[cf]||(S.ShadersStore[cf]=GA);const MG={name:cf,shader:GA},FG=Object.freeze(Object.defineProperty({__proto__:null,hdrIrradianceFilteringPixelShader:MG},Symbol.toStringTag,{value:"Module"})),uf="hdrIrradianceFilteringVertexShader",zA=`attribute position: vec2f;varying direction: vec3f;uniform up: vec3f;uniform right: vec3f;uniform front: vec3f;
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
var view: mat3x3f= mat3x3f(uniforms.up,uniforms.right,uniforms.front);vertexOutputs.direction=view*vec3f(input.position,1.0);vertexOutputs.position= vec4f(input.position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;S.ShadersStoreWGSL[uf]||(S.ShadersStoreWGSL[uf]=zA);const LG={name:uf,shader:zA},wG=Object.freeze(Object.defineProperty({__proto__:null,hdrIrradianceFilteringVertexShaderWGSL:LG},Symbol.toStringTag,{value:"Module"})),hf="hdrIrradianceFilteringPixelShader",WA=`#include<helperFunctions>
#include<importanceSampling>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
var inputTextureSampler: sampler;var inputTexture: texture_cube<f32>;
#ifdef IBL_CDF_FILTERING
var icdfTextureSampler: sampler;var icdfTexture: texture_2d<f32>;
#endif
uniform vFilteringInfo: vec2f;uniform hdrScale: f32;varying direction: vec3f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var color: vec3f=irradiance(inputTexture,inputTextureSampler,input.direction,uniforms.vFilteringInfo,0.0,vec3f(1.0),input.direction
#ifdef IBL_CDF_FILTERING
,icdfTexture,icdfTextureSampler
#endif
);fragmentOutputs.color= vec4f(color*uniforms.hdrScale,1.0);}`;S.ShadersStoreWGSL[hf]||(S.ShadersStoreWGSL[hf]=WA);const BG={name:hf,shader:WA},VG=Object.freeze(Object.defineProperty({__proto__:null,hdrIrradianceFilteringPixelShaderWGSL:BG},Symbol.toStringTag,{value:"Module"}));var IT;(function(s){s[s.Uniform=0]="Uniform",s[s.Attribute=1]="Attribute",s[s.Varying=2]="Varying",s[s.Undefined=3]="Undefined"})(IT||(IT={}));class at extends Ao{constructor(e,t,i,r,n){super(e,t,i),this._blockType=r,this._blockName=n,this.needDualDirectionValidation=!0}checkCompatibilityState(e){return e instanceof at&&e._blockName===this._blockName?0:1}createCustomInputBlock(){return[new this._blockType(this._blockName),this.name]}}class UG extends ie{constructor(e){super(e,P.Vertex),this._isUnique=!0,this.registerInput("splatPosition",p.Vector3,!1,P.Vertex),this.registerInput("splatScale",p.Vector2,!0,P.Vertex),this.registerInput("world",p.Matrix,!1,P.Vertex),this.registerInput("view",p.Matrix,!1,P.Vertex),this.registerInput("projection",p.Matrix,!1,P.Vertex),this.registerOutput("splatVertex",p.Vector4,P.Vertex),this.registerOutput("SH",p.Color3,P.Vertex)}getClassName(){return"GaussianSplattingBlock"}get splatPosition(){return this._inputs[0]}get splatScale(){return this._inputs[1]}get world(){return this._inputs[2]}get view(){return this._inputs[3]}get projection(){return this._inputs[4]}get splatVertex(){return this._outputs[0]}get SH(){return this._outputs[1]}initialize(e){e._excludeVariableName("focal"),e._excludeVariableName("invViewport"),e._excludeVariableName("kernelSize"),e._excludeVariableName("eyePosition")}prepareDefines(e,t,i){i&&i.getClassName()=="GaussianSplattingMesh"&&e.setValue("SH_DEGREE",i.shDegree,!0)}_buildBlock(e){if(super._buildBlock(e),e.target===P.Fragment)return;e.sharedData.blocksWithDefines.push(this);const t=`//${this.name}`;e._emitFunctionFromInclude("gaussianSplattingVertexDeclaration",t),e._emitFunctionFromInclude("gaussianSplatting",t),e._emitFunctionFromInclude("helperFunctions",t),e._emitUniformFromString("focal",p.Vector2),e._emitUniformFromString("invViewport",p.Vector2),e._emitUniformFromString("kernelSize",p.Float),e._emitUniformFromString("eyePosition",p.Vector3),e._emitUniformFromString("viewDirectionFactor",p.Vector3),e.attributes.push(M.PositionKind),e.sharedData.nodeMaterial.backFaceCulling=!1;const i=this.splatPosition,r=this.splatScale,n=this.world,a=this.view,o=this.projection,l=this.splatVertex,c=this.SH,u=e.fSuffix;let h=`vec2${u}(1.,1.)`;r.isConnected&&(h=r.associatedVariableName);let d="position",f="";return e.shaderLanguage===1&&(d="input.position",f=", uniforms.focal, uniforms.invViewport, uniforms.kernelSize"),this.SH.isConnected?(e.compilationString+=`#if SH_DEGREE > 0
`,e.shaderLanguage===1?(e.compilationString+=`let worldRot: mat3x3f =  mat3x3f(${n.associatedVariableName}[0].xyz, ${n.associatedVariableName}[1].xyz, ${n.associatedVariableName}[2].xyz);`,e.compilationString+="let normWorldRot: mat3x3f = inverseMat3(worldRot);",e.compilationString+=`var dir: vec3f = normalize(normWorldRot * (${i.associatedVariableName}.xyz - uniforms.eyePosition));
`,e.compilationString+=`dir *= uniforms.viewDirectionFactor;
`):(e.compilationString+=`mat3 worldRot = mat3(${n.associatedVariableName});`,e.compilationString+="mat3 normWorldRot = inverseMat3(worldRot);",e.compilationString+=`vec3 dir = normalize(normWorldRot * (${i.associatedVariableName}.xyz - eyePosition));
`,e.compilationString+=`dir *= viewDirectionFactor;
`),e.compilationString+=`${e._declareOutput(c)} = computeSH(splat, dir);
`,e.compilationString+=`#else
`,e.compilationString+=`${e._declareOutput(c)} = vec3${u}(0.,0.,0.);
`,e.compilationString+=`#endif;
`):e.compilationString+=`${e._declareOutput(c)} = vec3${u}(0.,0.,0.);`,e.compilationString+=`${e._declareOutput(l)} = gaussianSplatting(${d}, ${i.associatedVariableName}, ${h}, covA, covB, ${n.associatedVariableName}, ${a.associatedVariableName}, ${o.associatedVariableName}${f});
`,this}}y("BABYLON.GaussianSplattingBlock",UG);class kG extends ie{constructor(e){super(e,P.Fragment),this._isUnique=!1,this.registerInput("splatColor",p.Color4,!1,P.Fragment),this.registerOutput("rgba",p.Color4,P.Fragment),this.registerOutput("rgb",p.Color3,P.Fragment),this.registerOutput("alpha",p.Float,P.Fragment)}getClassName(){return"GaussianBlock"}get splatColor(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get alpha(){return this._outputs[2]}initialize(e){e._excludeVariableName("vPosition")}_buildBlock(e){if(super._buildBlock(e),e.target===P.Vertex)return;const t=`//${this.name}`;e._emitFunctionFromInclude("clipPlaneFragmentDeclaration",t),e._emitFunctionFromInclude("logDepthDeclaration",t),e._emitFunctionFromInclude("fogFragmentDeclaration",t),e._emitFunctionFromInclude("gaussianSplattingFragmentDeclaration",t),e._emitVaryingFromString("vPosition",p.Vector2);const i=e._getFreeVariableName("tempSplatColor"),r=this.splatColor,n=this._outputs[0],a=this._outputs[1],o=this._outputs[2];return e.shaderLanguage===1?e.compilationString+=`let ${i}:vec4f = gaussianColor(${r.associatedVariableName}, input.vPosition);
`:e.compilationString+=`vec4 ${i} = gaussianColor(${r.associatedVariableName});
`,e.compilationString+=`${e._declareOutput(n)} = ${i}.rgba;`,e.compilationString+=`${e._declareOutput(a)} = ${i}.rgb;`,e.compilationString+=`${e._declareOutput(o)} = ${i}.a;`,this}}y("BABYLON.GaussianBlock",kG);const RT="gaussianSplattingFragmentDeclaration",GG=`vec4 gaussianColor(vec4 inColor)
{float A=-dot(vPosition,vPosition);if (A<-4.0) discard;float B=exp(A)*inColor.a;
#include<logDepthFragment>
vec3 color=inColor.rgb;
#ifdef FOG
#include<fogFragment>
#endif
return vec4(color,B);}
`;S.IncludesShadersStore[RT]||(S.IncludesShadersStore[RT]=GG);const df="gaussianSplattingPixelShader",HA=`#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
varying vec4 vColor;varying vec2 vPosition;
#include<gaussianSplattingFragmentDeclaration>
void main () { 
#include<clipPlaneFragment>
gl_FragColor=gaussianColor(vColor);}
`;S.ShadersStore[df]||(S.ShadersStore[df]=HA);const zG={name:df,shader:HA},WG=Object.freeze(Object.defineProperty({__proto__:null,gaussianSplattingPixelShader:zG},Symbol.toStringTag,{value:"Module"})),AT="gaussianSplattingVertexDeclaration",HG="attribute vec2 position;uniform mat4 view;uniform mat4 projection;uniform mat4 world;uniform vec4 vEyePosition;";S.IncludesShadersStore[AT]||(S.IncludesShadersStore[AT]=HG);const PT="gaussianSplattingUboDeclaration",$G=`#include<sceneUboDeclaration>
#include<meshUboDeclaration>
attribute vec2 position;`;S.IncludesShadersStore[PT]||(S.IncludesShadersStore[PT]=$G);const OT="gaussianSplatting",XG=`#if !defined(WEBGL2) && !defined(WEBGPU) && !defined(NATIVE)
mat3 transpose(mat3 matrix) {return mat3(matrix[0][0],matrix[1][0],matrix[2][0],
matrix[0][1],matrix[1][1],matrix[2][1],
matrix[0][2],matrix[1][2],matrix[2][2]);}
#endif
vec2 getDataUV(float index,vec2 textureSize) {float y=floor(index/textureSize.x);float x=index-y*textureSize.x;return vec2((x+0.5)/textureSize.x,(y+0.5)/textureSize.y);}
#if SH_DEGREE>0
ivec2 getDataUVint(float index,vec2 textureSize) {float y=floor(index/textureSize.x);float x=index-y*textureSize.x;return ivec2(uint(x+0.5),uint(y+0.5));}
#endif
struct Splat {vec4 center;vec4 color;vec4 covA;vec4 covB;
#if SH_DEGREE>0
uvec4 sh0; 
#endif
#if SH_DEGREE>1
uvec4 sh1;
#endif
#if SH_DEGREE>2
uvec4 sh2;
#endif
};Splat readSplat(float splatIndex)
{Splat splat;vec2 splatUV=getDataUV(splatIndex,dataTextureSize);splat.center=texture2D(centersTexture,splatUV);splat.color=texture2D(colorsTexture,splatUV);splat.covA=texture2D(covariancesATexture,splatUV)*splat.center.w;splat.covB=texture2D(covariancesBTexture,splatUV)*splat.center.w;
#if SH_DEGREE>0
ivec2 splatUVint=getDataUVint(splatIndex,dataTextureSize);splat.sh0=texelFetch(shTexture0,splatUVint,0);
#endif
#if SH_DEGREE>1
splat.sh1=texelFetch(shTexture1,splatUVint,0);
#endif
#if SH_DEGREE>2
splat.sh2=texelFetch(shTexture2,splatUVint,0);
#endif
return splat;}
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
vec3 computeColorFromSHDegree(vec3 dir,const vec3 sh[16])
{const float SH_C0=0.28209479;const float SH_C1=0.48860251;float SH_C2[5];SH_C2[0]=1.092548430;SH_C2[1]=-1.09254843;SH_C2[2]=0.315391565;SH_C2[3]=-1.09254843;SH_C2[4]=0.546274215;float SH_C3[7];SH_C3[0]=-0.59004358;SH_C3[1]=2.890611442;SH_C3[2]=-0.45704579;SH_C3[3]=0.373176332;SH_C3[4]=-0.45704579;SH_C3[5]=1.445305721;SH_C3[6]=-0.59004358;vec3 result=/*SH_C0**/sh[0];
#if SH_DEGREE>0
float x=dir.x;float y=dir.y;float z=dir.z;result+=- SH_C1*y*sh[1]+SH_C1*z*sh[2]-SH_C1*x*sh[3];
#if SH_DEGREE>1
float xx=x*x,yy=y*y,zz=z*z;float xy=x*y,yz=y*z,xz=x*z;result+=
SH_C2[0]*xy*sh[4] +
SH_C2[1]*yz*sh[5] +
SH_C2[2]*(2.0*zz-xx-yy)*sh[6] +
SH_C2[3]*xz*sh[7] +
SH_C2[4]*(xx-yy)*sh[8];
#if SH_DEGREE>2
result+=
SH_C3[0]*y*(3.0*xx-yy)*sh[9] +
SH_C3[1]*xy*z*sh[10] +
SH_C3[2]*y*(4.0*zz-xx-yy)*sh[11] +
SH_C3[3]*z*(2.0*zz-3.0*xx-3.0*yy)*sh[12] +
SH_C3[4]*x*(4.0*zz-xx-yy)*sh[13] +
SH_C3[5]*z*(xx-yy)*sh[14] +
SH_C3[6]*x*(xx-3.0*yy)*sh[15];
#endif
#endif
#endif
return result;}
vec4 decompose(uint value)
{vec4 components=vec4(
float((value ) & 255u),
float((value>>uint( 8)) & 255u),
float((value>>uint(16)) & 255u),
float((value>>uint(24)) & 255u));return components*vec4(2./255.)-vec4(1.);}
vec3 computeSH(Splat splat,vec3 dir)
{vec3 sh[16];sh[0]=vec3(0.,0.,0.);
#if SH_DEGREE>0
vec4 sh00=decompose(splat.sh0.x);vec4 sh01=decompose(splat.sh0.y);vec4 sh02=decompose(splat.sh0.z);sh[1]=vec3(sh00.x,sh00.y,sh00.z);sh[2]=vec3(sh00.w,sh01.x,sh01.y);sh[3]=vec3(sh01.z,sh01.w,sh02.x);
#endif
#if SH_DEGREE>1
vec4 sh03=decompose(splat.sh0.w);vec4 sh04=decompose(splat.sh1.x);vec4 sh05=decompose(splat.sh1.y);sh[4]=vec3(sh02.y,sh02.z,sh02.w);sh[5]=vec3(sh03.x,sh03.y,sh03.z);sh[6]=vec3(sh03.w,sh04.x,sh04.y);sh[7]=vec3(sh04.z,sh04.w,sh05.x);sh[8]=vec3(sh05.y,sh05.z,sh05.w);
#endif
#if SH_DEGREE>2
vec4 sh06=decompose(splat.sh1.z);vec4 sh07=decompose(splat.sh1.w);vec4 sh08=decompose(splat.sh2.x);vec4 sh09=decompose(splat.sh2.y);vec4 sh10=decompose(splat.sh2.z);vec4 sh11=decompose(splat.sh2.w);sh[9]=vec3(sh06.x,sh06.y,sh06.z);sh[10]=vec3(sh06.w,sh07.x,sh07.y);sh[11]=vec3(sh07.z,sh07.w,sh08.x);sh[12]=vec3(sh08.y,sh08.z,sh08.w);sh[13]=vec3(sh09.x,sh09.y,sh09.z);sh[14]=vec3(sh09.w,sh10.x,sh10.y);sh[15]=vec3(sh10.z,sh10.w,sh11.x); 
#endif
return computeColorFromSHDegree(dir,sh);}
#else
vec3 computeSH(Splat splat,vec3 dir)
{return vec3(0.,0.,0.);}
#endif
vec4 gaussianSplatting(vec2 meshPos,vec3 worldPos,vec2 scale,vec3 covA,vec3 covB,mat4 worldMatrix,mat4 viewMatrix,mat4 projectionMatrix)
{mat4 modelView=viewMatrix*worldMatrix;vec4 camspace=viewMatrix*vec4(worldPos,1.);vec4 pos2d=projectionMatrix*camspace;float bounds=1.2*pos2d.w;if (pos2d.z<-pos2d.w || pos2d.x<-bounds || pos2d.x>bounds
|| pos2d.y<-bounds || pos2d.y>bounds) {return vec4(0.0,0.0,2.0,1.0);}
mat3 Vrk=mat3(
covA.x,covA.y,covA.z,
covA.y,covB.x,covB.y,
covA.z,covB.y,covB.z
);bool isOrtho=abs(projectionMatrix[3][3]-1.0)<0.001;mat3 J;if (isOrtho) {J=mat3(
focal.x,0.,0.,
0.,focal.y,0.,
0.,0.,0.
);} else {J=mat3(
focal.x/camspace.z,0.,-(focal.x*camspace.x)/(camspace.z*camspace.z),
0.,focal.y/camspace.z,-(focal.y*camspace.y)/(camspace.z*camspace.z),
0.,0.,0.
);}
mat3 invy=mat3(1,0,0,0,-1,0,0,0,1);mat3 T=invy*transpose(mat3(modelView))*J;mat3 cov2d=transpose(T)*Vrk*T;
#if COMPENSATION
float c00=cov2d[0][0];float c11=cov2d[1][1];float c01=cov2d[0][1];float detOrig=c00*c11-c01*c01;
#endif
cov2d[0][0]+=kernelSize;cov2d[1][1]+=kernelSize;
#if COMPENSATION
vec3 c2d=vec3(cov2d[0][0],c01,cov2d[1][1]);float detBlur=c2d.x*c2d.z-c2d.y*c2d.y;float compensation=sqrt(max(0.,detOrig/detBlur));vColor.w*=compensation;
#endif
float mid=(cov2d[0][0]+cov2d[1][1])/2.0;float radius=length(vec2((cov2d[0][0]-cov2d[1][1])/2.0,cov2d[0][1]));float epsilon=0.0001;float lambda1=mid+radius+epsilon,lambda2=mid-radius+epsilon;if (lambda2<0.0)
{return vec4(0.0,0.0,2.0,1.0);}
vec2 diagonalVector=normalize(vec2(cov2d[0][1],lambda1-cov2d[0][0]));vec2 majorAxis=min(sqrt(2.0*lambda1),1024.0)*diagonalVector;vec2 minorAxis=min(sqrt(2.0*lambda2),1024.0)*vec2(diagonalVector.y,-diagonalVector.x);vec2 vCenter=vec2(pos2d);float scaleFactor=isOrtho ? 1.0 : pos2d.w;return vec4(
vCenter 
+ ((meshPos.x*majorAxis
+ meshPos.y*minorAxis)*invViewport*scaleFactor)*scale,pos2d.zw);}`;S.IncludesShadersStore[OT]||(S.IncludesShadersStore[OT]=XG);const ff="gaussianSplattingVertexShader",$A=`#include<__decl__gaussianSplattingVertex>
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
#include<helperFunctions>
attribute float splatIndex;uniform vec2 invViewport;uniform vec2 dataTextureSize;uniform vec2 focal;uniform float kernelSize;uniform vec3 eyePosition;uniform vec3 viewDirectionFactor;uniform sampler2D covariancesATexture;uniform sampler2D covariancesBTexture;uniform sampler2D centersTexture;uniform sampler2D colorsTexture;
#if SH_DEGREE>0
uniform highp usampler2D shTexture0;
#endif
#if SH_DEGREE>1
uniform highp usampler2D shTexture1;
#endif
#if SH_DEGREE>2
uniform highp usampler2D shTexture2;
#endif
varying vec4 vColor;varying vec2 vPosition;
#include<gaussianSplatting>
void main () {Splat splat=readSplat(splatIndex);vec3 covA=splat.covA.xyz;vec3 covB=vec3(splat.covA.w,splat.covB.xy);vec4 worldPos=world*vec4(splat.center.xyz,1.0);vColor=splat.color;vPosition=position;
#if SH_DEGREE>0
mat3 worldRot=mat3(world);mat3 normWorldRot=inverseMat3(worldRot);vec3 dir=normalize(normWorldRot*(worldPos.xyz-eyePosition));dir*=viewDirectionFactor;vColor.xyz=splat.color.xyz+computeSH(splat,dir);
#endif
gl_Position=gaussianSplatting(position,worldPos.xyz,vec2(1.,1.),covA,covB,world,view,projection);
#include<clipPlaneVertex>
#include<fogVertex>
#include<logDepthVertex>
}
`;S.ShadersStore[ff]||(S.ShadersStore[ff]=$A);const YG={name:ff,shader:$A},jG=Object.freeze(Object.defineProperty({__proto__:null,gaussianSplattingVertexShader:YG},Symbol.toStringTag,{value:"Module"})),NT="gaussianSplattingFragmentDeclaration",qG=`fn gaussianColor(inColor: vec4f,inPosition: vec2f)->vec4f
{var A : f32=-dot(inPosition,inPosition);if (A>-4.0)
{var B: f32=exp(A)*inColor.a;
#include<logDepthFragment>
var color: vec3f=inColor.rgb;
#ifdef FOG
#include<fogFragment>
#endif
return vec4f(color,B);} else {return vec4f(0.0);}}
`;S.IncludesShadersStoreWGSL[NT]||(S.IncludesShadersStoreWGSL[NT]=qG);const pf="gaussianSplattingPixelShader",XA=`#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
varying vColor: vec4f;varying vPosition: vec2f;
#include<gaussianSplattingFragmentDeclaration>
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#include<clipPlaneFragment>
fragmentOutputs.color=gaussianColor(input.vColor,input.vPosition);}
`;S.ShadersStoreWGSL[pf]||(S.ShadersStoreWGSL[pf]=XA);const ZG={name:pf,shader:XA},QG=Object.freeze(Object.defineProperty({__proto__:null,gaussianSplattingPixelShaderWGSL:ZG},Symbol.toStringTag,{value:"Module"})),DT="gaussianSplatting",KG=`fn getDataUV(index: f32,dataTextureSize: vec2f)->vec2<f32> {let y: f32=floor(index/dataTextureSize.x);let x: f32=index-y*dataTextureSize.x;return vec2f((x+0.5),(y+0.5));}
struct Splat {center: vec4f,
color: vec4f,
covA: vec4f,
covB: vec4f,
#if SH_DEGREE>0
sh0: vec4<u32>,
#endif
#if SH_DEGREE>1
sh1: vec4<u32>,
#endif
#if SH_DEGREE>2
sh2: vec4<u32>,
#endif
};fn readSplat(splatIndex: f32,dataTextureSize: vec2f)->Splat {var splat: Splat;let splatUV=getDataUV(splatIndex,dataTextureSize);let splatUVi32=vec2<i32>(i32(splatUV.x),i32(splatUV.y));splat.center=textureLoad(centersTexture,splatUVi32,0);splat.color=textureLoad(colorsTexture,splatUVi32,0);splat.covA=textureLoad(covariancesATexture,splatUVi32,0)*splat.center.w;splat.covB=textureLoad(covariancesBTexture,splatUVi32,0)*splat.center.w;
#if SH_DEGREE>0
splat.sh0=textureLoad(shTexture0,splatUVi32,0);
#endif
#if SH_DEGREE>1
splat.sh1=textureLoad(shTexture1,splatUVi32,0);
#endif
#if SH_DEGREE>2
splat.sh2=textureLoad(shTexture2,splatUVi32,0);
#endif
return splat;}
fn computeColorFromSHDegree(dir: vec3f,sh: array<vec3<f32>,16>)->vec3f
{let SH_C0: f32=0.28209479;let SH_C1: f32=0.48860251;var SH_C2: array<f32,5>=array<f32,5>(
1.092548430,
-1.09254843,
0.315391565,
-1.09254843,
0.546274215
);var SH_C3: array<f32,7>=array<f32,7>(
-0.59004358,
2.890611442,
-0.45704579,
0.373176332,
-0.45704579,
1.445305721,
-0.59004358
);var result: vec3f=/*SH_C0**/sh[0];
#if SH_DEGREE>0
let x: f32=dir.x;let y: f32=dir.y;let z: f32=dir.z;result+=-SH_C1*y*sh[1]+SH_C1*z*sh[2]-SH_C1*x*sh[3];
#if SH_DEGREE>1
let xx: f32=x*x;let yy: f32=y*y;let zz: f32=z*z;let xy: f32=x*y;let yz: f32=y*z;let xz: f32=x*z;result+=
SH_C2[0]*xy*sh[4] +
SH_C2[1]*yz*sh[5] +
SH_C2[2]*(2.0f*zz-xx-yy)*sh[6] +
SH_C2[3]*xz*sh[7] +
SH_C2[4]*(xx-yy)*sh[8];
#if SH_DEGREE>2
result+=
SH_C3[0]*y*(3.0f*xx-yy)*sh[9] +
SH_C3[1]*xy*z*sh[10] +
SH_C3[2]*y*(4.0f*zz-xx-yy)*sh[11] +
SH_C3[3]*z*(2.0f*zz-3.0f*xx-3.0f*yy)*sh[12] +
SH_C3[4]*x*(4.0f*zz-xx-yy)*sh[13] +
SH_C3[5]*z*(xx-yy)*sh[14] +
SH_C3[6]*x*(xx-3.0f*yy)*sh[15];
#endif
#endif
#endif
return result;}
fn decompose(value: u32)->vec4f
{let components : vec4f=vec4f(
f32((value ) & 255u),
f32((value>>u32( 8)) & 255u),
f32((value>>u32(16)) & 255u),
f32((value>>u32(24)) & 255u));return components*vec4f(2./255.)-vec4f(1.);}
fn computeSH(splat: Splat,dir: vec3f)->vec3f
{var sh: array<vec3<f32>,16>;sh[0]=vec3f(0.,0.,0.);
#if SH_DEGREE>0
let sh00: vec4f=decompose(splat.sh0.x);let sh01: vec4f=decompose(splat.sh0.y);let sh02: vec4f=decompose(splat.sh0.z);sh[1]=vec3f(sh00.x,sh00.y,sh00.z);sh[2]=vec3f(sh00.w,sh01.x,sh01.y);sh[3]=vec3f(sh01.z,sh01.w,sh02.x);
#endif
#if SH_DEGREE>1
let sh03: vec4f=decompose(splat.sh0.w);let sh04: vec4f=decompose(splat.sh1.x);let sh05: vec4f=decompose(splat.sh1.y);sh[4]=vec3f(sh02.y,sh02.z,sh02.w);sh[5]=vec3f(sh03.x,sh03.y,sh03.z);sh[6]=vec3f(sh03.w,sh04.x,sh04.y);sh[7]=vec3f(sh04.z,sh04.w,sh05.x);sh[8]=vec3f(sh05.y,sh05.z,sh05.w);
#endif
#if SH_DEGREE>2
let sh06: vec4f=decompose(splat.sh1.z);let sh07: vec4f=decompose(splat.sh1.w);let sh08: vec4f=decompose(splat.sh2.x);let sh09: vec4f=decompose(splat.sh2.y);let sh10: vec4f=decompose(splat.sh2.z);let sh11: vec4f=decompose(splat.sh2.w);sh[9]=vec3f(sh06.x,sh06.y,sh06.z);sh[10]=vec3f(sh06.w,sh07.x,sh07.y);sh[11]=vec3f(sh07.z,sh07.w,sh08.x);sh[12]=vec3f(sh08.y,sh08.z,sh08.w);sh[13]=vec3f(sh09.x,sh09.y,sh09.z);sh[14]=vec3f(sh09.w,sh10.x,sh10.y);sh[15]=vec3f(sh10.z,sh10.w,sh11.x); 
#endif
return computeColorFromSHDegree(dir,sh);}
fn gaussianSplatting(
meshPos: vec2<f32>,
worldPos: vec3<f32>,
scale: vec2<f32>,
covA: vec3<f32>,
covB: vec3<f32>,
worldMatrix: mat4x4<f32>,
viewMatrix: mat4x4<f32>,
projectionMatrix: mat4x4<f32>,
focal: vec2f,
invViewport: vec2f,
kernelSize: f32
)->vec4f {let modelView=viewMatrix*worldMatrix;let camspace=viewMatrix*vec4f(worldPos,1.0);let pos2d=projectionMatrix*camspace;let bounds=1.2*pos2d.w;if (pos2d.z<0. || pos2d.x<-bounds || pos2d.x>bounds || pos2d.y<-bounds || pos2d.y>bounds) {return vec4f(0.0,0.0,2.0,1.0);}
let Vrk=mat3x3<f32>(
covA.x,covA.y,covA.z,
covA.y,covB.x,covB.y,
covA.z,covB.y,covB.z
);let isOrtho=abs(projectionMatrix[3][3]-1.0)<0.001;var J: mat3x3<f32>;if (isOrtho) {J=mat3x3<f32>(
focal.x,0.0,0.0,
0.0,focal.y,0.0,
0.0,0.0,0.0
);} else {J=mat3x3<f32>(
focal.x/camspace.z,0.0,-(focal.x*camspace.x)/(camspace.z*camspace.z),
0.0,focal.y/camspace.z,-(focal.y*camspace.y)/(camspace.z*camspace.z),
0.0,0.0,0.0
);}
let invy=mat3x3<f32>(
1.0,0.0,0.0,
0.0,-1.0,0.0,
0.0,0.0,1.0
);let T=invy*transpose(mat3x3<f32>(
modelView[0].xyz,
modelView[1].xyz,
modelView[2].xyz))*J;var cov2d=transpose(T)*Vrk*T;
#if COMPENSATION
let c00: f32=cov2d[0][0];let c11: f32=cov2d[1][1];let c01: f32=cov2d[0][1];let detOrig: f32=c00*c11-c01*c01;
#endif
cov2d[0][0]+=kernelSize;cov2d[1][1]+=kernelSize;
#if COMPENSATION
let c2d: vec3f=vec3f(cov2d[0][0],c01,cov2d[1][1]);let detBlur: f32=c2d.x*c2d.z-c2d.y*c2d.y;let compensation: f32=sqrt(max(0.,detOrig/detBlur));vertexOutputs.vColor.w*=compensation;
#endif
let mid=(cov2d[0][0]+cov2d[1][1])/2.0;let radius=length(vec2<f32>((cov2d[0][0]-cov2d[1][1])/2.0,cov2d[0][1]));let lambda1=mid+radius;let lambda2=mid-radius;if (lambda2<0.0) {return vec4f(0.0,0.0,2.0,1.0);}
let diagonalVector=normalize(vec2<f32>(cov2d[0][1],lambda1-cov2d[0][0]));let majorAxis=min(sqrt(2.0*lambda1),1024.0)*diagonalVector;let minorAxis=min(sqrt(2.0*lambda2),1024.0)*vec2<f32>(diagonalVector.y,-diagonalVector.x);let vCenter=vec2<f32>(pos2d.x,pos2d.y);let scaleFactor=select(pos2d.w,1.0,isOrtho);return vec4f(
vCenter+((meshPos.x*majorAxis+meshPos.y*minorAxis)*invViewport*scaleFactor)*scale,
pos2d.z,
pos2d.w
);}`;S.IncludesShadersStoreWGSL[DT]||(S.IncludesShadersStoreWGSL[DT]=KG);const mf="gaussianSplattingVertexShader",YA=`#include<sceneUboDeclaration>
#include<meshUboDeclaration>
#include<helperFunctions>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
attribute splatIndex: f32;attribute position: vec2f;uniform invViewport: vec2f;uniform dataTextureSize: vec2f;uniform focal: vec2f;uniform kernelSize: f32;uniform eyePosition: vec3f;uniform viewDirectionFactor: vec3f;var covariancesATexture: texture_2d<f32>;var covariancesBTexture: texture_2d<f32>;var centersTexture: texture_2d<f32>;var colorsTexture: texture_2d<f32>;
#if SH_DEGREE>0
var shTexture0: texture_2d<u32>;
#endif
#if SH_DEGREE>1
var shTexture1: texture_2d<u32>;
#endif
#if SH_DEGREE>2
var shTexture2: texture_2d<u32>;
#endif
varying vColor: vec4f;varying vPosition: vec2f;
#include<gaussianSplatting>
@vertex
fn main(input : VertexInputs)->FragmentInputs {var splat: Splat=readSplat(input.splatIndex,uniforms.dataTextureSize);var covA: vec3f=splat.covA.xyz;var covB: vec3f=vec3f(splat.covA.w,splat.covB.xy);let worldPos: vec4f=mesh.world*vec4f(splat.center.xyz,1.0);vertexOutputs.vPosition=input.position;
#if SH_DEGREE>0
let worldRot: mat3x3f= mat3x3f(mesh.world[0].xyz,mesh.world[1].xyz,mesh.world[2].xyz);let normWorldRot: mat3x3f=inverseMat3(worldRot);var dir: vec3f=normalize(normWorldRot*(worldPos.xyz-uniforms.eyePosition.xyz));dir*=uniforms.viewDirectionFactor;vertexOutputs.vColor=vec4f(splat.color.xyz+computeSH(splat,dir),splat.color.w);
#else
vertexOutputs.vColor=splat.color;
#endif
vertexOutputs.position=gaussianSplatting(input.position,worldPos.xyz,vec2f(1.0,1.0),covA,covB,mesh.world,scene.view,scene.projection,uniforms.focal,uniforms.invViewport,uniforms.kernelSize);
#include<clipPlaneVertex>
#include<fogVertex>
#include<logDepthVertex>
}
`;S.ShadersStoreWGSL[mf]||(S.ShadersStoreWGSL[mf]=YA);const JG={name:mf,shader:YA},ez=Object.freeze(Object.defineProperty({__proto__:null,gaussianSplattingVertexShaderWGSL:JG},Symbol.toStringTag,{value:"Module"}));class tz extends Oi{constructor(){super(),this.FOG=!1,this.THIN_INSTANCES=!0,this.LOGARITHMICDEPTH=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.SH_DEGREE=0,this.COMPENSATION=!1,this.rebuild()}}class tr extends Zl{constructor(e,t){super(e,t),this.kernelSize=tr.KernelSize,this._compensation=tr.Compensation,this._isDirty=!1,this.backFaceCulling=!1}set compensation(e){this._isDirty=this._isDirty!=e,this._compensation=e}get compensation(){return this._compensation}get hasRenderTargetTextures(){return!1}needAlphaTesting(){return!1}needAlphaBlending(){return!0}isReadyForSubMesh(e,t){const r=t._drawWrapper;let n=t.materialDefines;if(n&&this._isDirty&&n.markAsUnprocessed(),r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===!0)return!0;t.materialDefines||(n=t.materialDefines=new tz);const a=this.getScene();if(this._isReadyForSubMesh(t))return!0;const o=a.getEngine(),l=e;Cu(e,a,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,!1,n,void 0,void 0,void 0,this._setVertexOutputInvariant),yu(a,o,this,n,!0,null,!0),Iu(e,n,!1,!1),(o.version>1||o.isWebGPU)&&(n.SH_DEGREE=l.shDegree);const c=l.material;if(n.COMPENSATION=c&&c.compensation?c.compensation:tr.Compensation,n.isDirty){n.markAsProcessed(),a.resetCachedMaterial();const u=[M.PositionKind,"splatIndex"];Ru(u,n);const h=["world","view","projection","vFogInfos","vFogColor","logarithmicDepthConstant","invViewport","dataTextureSize","focal","eyePosition","kernelSize","viewDirectionFactor"],d=["covariancesATexture","covariancesBTexture","centersTexture","colorsTexture","shTexture0","shTexture1","shTexture2"],f=["Scene","Mesh"];Au({uniformsNames:h,uniformBuffersNames:f,samplers:d,defines:n}),Na(h);const m=n.toString(),g=a.getEngine().createEffect("gaussianSplatting",{attributes:u,uniformsNames:h,uniformBuffersNames:f,samplers:d,defines:m,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{},shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{this._shaderLanguage===1?await Promise.all([U(()=>Promise.resolve().then(()=>QG),void 0),U(()=>Promise.resolve().then(()=>ez),void 0)]):await Promise.all([U(()=>Promise.resolve().then(()=>WG),void 0),U(()=>Promise.resolve().then(()=>jG),void 0)])}},o);t.setEffect(g,n,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(n._renderId=a.getRenderId(),r._wasPreviouslyReady=!0,r._wasPreviouslyUsingInstances=!0,this._isDirty=!1,!0)}static BindEffect(e,t,i){var d,f;const r=i.getEngine(),n=i.activeCamera,a=r.getRenderWidth(),o=r.getRenderHeight(),l=e,c=l.material,u=((d=n==null?void 0:n.rigParent)==null?void 0:d.rigCameras.length)||1;t.setFloat2("invViewport",1/(a/u),1/o);let h=1e3;if(n){const m=n.getProjectionMatrix().m[5];n.fovMode==dt.FOVMODE_VERTICAL_FIXED?h=o*m/2:h=a*m/2}if(t.setFloat2("focal",h,h),t.setVector3("viewDirectionFactor",l.viewDirectionFactor),t.setFloat("kernelSize",c&&c.kernelSize?c.kernelSize:tr.KernelSize),i.bindEyePosition(t,"eyePosition",!0),l.covariancesATexture){const m=l.covariancesATexture.getSize();if(t.setFloat2("dataTextureSize",m.width,m.height),t.setTexture("covariancesATexture",l.covariancesATexture),t.setTexture("covariancesBTexture",l.covariancesBTexture),t.setTexture("centersTexture",l.centersTexture),t.setTexture("colorsTexture",l.colorsTexture),l.shTextures)for(let g=0;g<((f=l.shTextures)==null?void 0:f.length);g++)t.setTexture(`shTexture${g}`,l.shTextures[g])}}bindForSubMesh(e,t,i){const r=this.getScene(),n=i.materialDefines;if(!n)return;const a=i.effect;if(!a)return;this._activeEffect=a,t.getMeshUniformBuffer().bindToEffect(a,"Mesh"),t.transferToEffect(e),this._mustRebind(r,a,i,t.visibility)?(this.bindView(a),this.bindViewProjection(a),tr.BindEffect(t,this._activeEffect,r),jn(a,this,r)):r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0),Pu(r,t,a),this.useLogarithmicDepth&&Vo(n,a,r),this._afterBind(t,this._activeEffect,i)}clone(e){return me.Clone(()=>new tr(e,this.getScene()),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.GaussianSplattingMaterial",e}getClassName(){return"GaussianSplattingMaterial"}static Parse(e,t,i){return me.Parse(()=>new tr(e.name,t),e,t,i)}}tr.KernelSize=.3;tr.Compensation=!1;y("BABYLON.GaussianSplattingMaterial",tr);class iz extends ie{constructor(e){super(e,P.Vertex),this._isUnique=!0,this.registerInput("splatIndex",p.Float,!1,P.Vertex),this.registerOutput("splatPosition",p.Vector3,P.Vertex),this.registerOutput("splatColor",p.Color4,P.Vertex)}getClassName(){return"SplatReaderBlock"}get splatIndex(){return this._inputs[0]}get splatPosition(){return this._outputs[0]}get splatColor(){return this._outputs[1]}initialize(e){e._excludeVariableName("covA"),e._excludeVariableName("covB"),e._excludeVariableName("vPosition"),e._excludeVariableName("covariancesATexture"),e._excludeVariableName("covariancesBTexture"),e._excludeVariableName("centersTexture"),e._excludeVariableName("colorsTexture"),e._excludeVariableName("dataTextureSize")}bind(e,t,i){if(!i)return;const r=i.getScene();tr.BindEffect(i,e,r)}_buildBlock(e){if(super._buildBlock(e),e.target===P.Fragment)return;e.sharedData.bindableBlocks.push(this);const t=`//${this.name}`;e._emit2DSampler("covariancesATexture"),e._emit2DSampler("covariancesBTexture"),e._emit2DSampler("centersTexture"),e._emit2DSampler("colorsTexture"),e._emit2DSampler("shTexture0","SH_DEGREE > 0",void 0,void 0,!0,"highp"),e._emit2DSampler("shTexture1","SH_DEGREE > 0",void 0,void 0,!0,"highp"),e._emit2DSampler("shTexture2","SH_DEGREE > 0",void 0,void 0,!0,"highp"),e._emitFunctionFromInclude("gaussianSplattingVertexDeclaration",t),e._emitFunctionFromInclude("gaussianSplatting",t),e._emitVaryingFromString("vPosition",p.Vector2),e._emitUniformFromString("dataTextureSize",p.Vector2);const i=this.splatIndex,r=this.splatPosition,n=this.splatColor,a=e._getFreeVariableName("splat");return e.shaderLanguage===1?(e.compilationString+=`var ${a}: Splat = readSplat(${i.associatedVariableName}, uniforms.dataTextureSize);
`,e.compilationString+=`var covA: vec3f = splat.covA.xyz; var covB: vec3f = vec3f(splat.covA.w, splat.covB.xy);
`,e.compilationString+=`vertexOutputs.vPosition = input.position;
`):(e.compilationString+=`Splat ${a} = readSplat(${i.associatedVariableName});
`,e.compilationString+=`vec3 covA = splat.covA.xyz; vec3 covB = vec3(splat.covA.w, splat.covB.xy);
`,e.compilationString+=`vPosition = position;
`),e.compilationString+=`${e._declareOutput(r)} = ${a}.center.xyz;
`,e.compilationString+=`${e._declareOutput(n)} = ${a}.color;
`,this}}y("BABYLON.SplatReaderBlock",iz);class Bi extends ie{get texture(){return this._texture}set texture(e){if(this._texture===e)return;const t=(e==null?void 0:e.getScene())??De.LastCreatedScene;!e&&t&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this._texture)),this._texture=e,e&&t&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(e))}get samplerName(){return this._samplerName}constructor(e){super(e,P.VertexAndFragment),this.registerOutput("source",p.Object,P.VertexAndFragment,new at("source",this,1,Bi,"ImageSourceBlock")),this.registerOutput("dimensions",p.Vector2)}bind(e,t){this.texture&&e.setTexture(this._samplerName,this.texture)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}getClassName(){return"ImageSourceBlock"}get source(){return this._outputs[0]}get dimensions(){return this._outputs[1]}_buildBlock(e){var t,i;if(super._buildBlock(e),e.target===P.Vertex&&(this._samplerName=e._getFreeVariableName(this.name),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.bindableBlocks.push(this)),this.dimensions.isConnected){let r="";e.shaderLanguage===1?r=`vec2f(textureDimensions(${this._samplerName}, 0).xy)`:r=`vec2(textureSize(${this._samplerName}, 0).xy)`,e.compilationString+=`${e._declareOutput(this.dimensions)} = ${r};
`}return(i=(t=this._texture)==null?void 0:t._texture)!=null&&i.is2DArray?e._emit2DArraySampler(this._samplerName):e._emit2DSampler(this._samplerName),this}_dumpPropertiesCode(e=!1){let t=super._dumpPropertiesCode();return!this.texture||e||(t+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});
`,t+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};
`,t+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};
`,t+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};
`,t+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};
`,t+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};
`,t+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};
`,t+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};
`,t+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};
`,t+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};
`,t+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};
`),t}serialize(e=!1){const t=super.serialize();return!e&&this.texture&&(it.AllowSerializationOfRenderTargetTextures||!this.texture.isRenderTarget)&&this.texture.getClassName()!=="VideoTexture"&&(t.texture=this.texture.serialize()),t}_deserialize(e,t,i,r){super._deserialize(e,t,i,r),e.texture&&!it.IgnoreTexturesAtLoadTime&&(e.texture.url!==void 0&&(e.texture.url.indexOf("data:")===0?i="":r&&(e.texture.url=r(e.texture.url),e.texture.name=e.texture.url)),(e.texture.base64String||e.texture.url!==void 0)&&(this.texture=$.Parse(e.texture,t,i)))}}y("BABYLON.ImageSourceBlock",Bi);class rz extends A_{get samplerName(){return this.source.connectedPoint?this.source.connectedPoint.ownerBlock.samplerName:this._samplerName}get texture(){return this.source.connectedPoint?this.source.connectedPoint.ownerBlock.texture:this._texture}set texture(e){this._texture=e}constructor(e){super(e),this._firstInit=!0,this.isMainInput=!1,this.registerInput("source",p.Object,!0,P.VertexAndFragment,new at("source",this,0,Bi,"ImageSourceBlock"))}get source(){return this._inputs[1]}get hasImageSource(){return this.source.isConnected}getClassName(){return"SmartFilterTextureBlock"}initialize(e){this._firstInit&&(this._samplerName=e._getFreeVariableName(this.name),this._firstInit=!1)}_getMainUvName(e){const t=e.sharedData.nodeMaterial.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="postprocess_uv");return!t||!t.isAnAncestorOf(this)?(e.sharedData.raiseBuildError("SmartFilterTextureBlock: 'postprocess_uv' attribute from ScreenUVBlock is required."),""):t.associatedVariableName}_emitUvAndSampler(e){if(e.target===P.Fragment&&(e._emitVaryingFromString(this._mainUVName,p.Vector2,ru,!0),!this.hasImageSource)){const t=this.isMainInput?"// main":void 0;e._emit2DSampler(this._samplerName,void 0,void 0,t)}}autoConfigure(e,t=()=>!0){if(!this.uv.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="postprocess_uv"&&t(r));i||(i=new ge("uv"),i.setAsAttribute("postprocess_uv")),i.output.connectTo(this.uv)}}_postBuildBlock(){this._firstInit=!0}serialize(){const e=super.serialize();return e.isMainInput=this.isMainInput,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.isMainInput=e.isMainInput}}y("BABYLON.SmartFilterTextureBlock",rz);class sz extends vh{constructor(e){super(e)}getClassName(){return"AddBlock"}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} + ${this.right.associatedVariableName};
`,this}}y("BABYLON.AddBlock",sz);class nz extends ie{constructor(e){super(e,P.Vertex),this.registerInput("matricesIndices",p.Vector4),this.registerInput("matricesWeights",p.Vector4),this.registerInput("matricesIndicesExtra",p.Vector4,!0),this.registerInput("matricesWeightsExtra",p.Vector4,!0),this.registerInput("world",p.Matrix),this.registerOutput("output",p.Matrix)}initialize(e){e._excludeVariableName("boneSampler"),e._excludeVariableName("boneTextureWidth"),e._excludeVariableName("mBones"),e._excludeVariableName("BonesPerMesh"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,e===1?await Promise.all([U(()=>import("./bakedVertexAnimation-f0d36139.js").then(t=>t.b),["assets/bakedVertexAnimation-f0d36139.js","assets/main-e8601b72.js","assets/index-ad665221.css"]),U(()=>import("./bakedVertexAnimation-f0d36139.js").then(t=>t.a),["assets/bakedVertexAnimation-f0d36139.js","assets/main-e8601b72.js","assets/index-ad665221.css"])]):await Promise.all([U(()=>import("./main-e8601b72.js").then(t=>t.dQ),["assets/main-e8601b72.js","assets/index-ad665221.css"]),U(()=>import("./main-e8601b72.js").then(t=>t.dW),["assets/main-e8601b72.js","assets/index-ad665221.css"])]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}getClassName(){return"BonesBlock"}get matricesIndices(){return this._inputs[0]}get matricesWeights(){return this._inputs[1]}get matricesIndicesExtra(){return this._inputs[2]}get matricesWeightsExtra(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}autoConfigure(e,t=()=>!0){if(!this.matricesIndices.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="matricesIndices"&&t(r));i||(i=new ge("matricesIndices"),i.setAsAttribute("matricesIndices")),i.output.connectTo(this.matricesIndices)}if(!this.matricesWeights.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="matricesWeights"&&t(r));i||(i=new ge("matricesWeights"),i.setAsAttribute("matricesWeights")),i.output.connectTo(this.matricesWeights)}if(!this.world.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===ve.World&&t(r));i||(i=new ge("world"),i.setAsSystemValue(ve.World)),i.output.connectTo(this.world)}}provideFallbacks(e,t){t&&t.useBones&&t.computeBonesUsingShaders&&t.skeleton&&e.addCPUSkinningFallback(0,t)}bind(e,t,i){Bo(i,e)}prepareDefines(e,t,i){!e._areAttributesDirty||!i||BD(i,e)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithFallbacks.push(this),e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.uniforms.push("boneTextureWidth"),e.uniforms.push("mBones"),e.samplers.push("boneSampler");const t=`//${this.name}`;e._emitFunctionFromInclude("bonesDeclaration",t,{removeAttributes:!0,removeUniforms:!1,removeVaryings:!0,removeIfDef:!1});const i=e._getFreeVariableName("influence");e.compilationString+=e._emitCodeFromInclude("bonesVertex",t,{replaceStrings:[{search:/finalWorld=finalWorld\*influence;/,replace:""},{search:/influence/gm,replace:i}]});const r=this._outputs[0],n=this.world;return e.compilationString+=`#if NUM_BONE_INFLUENCERS>0
`,e.compilationString+=e._declareOutput(r)+` = ${n.associatedVariableName} * ${i};
`,e.compilationString+=`#else
`,e.compilationString+=e._declareOutput(r)+` = ${n.associatedVariableName};
`,e.compilationString+=`#endif
`,this}}y("BABYLON.BonesBlock",nz);class az extends ie{constructor(e){super(e,P.Vertex),this.registerInput("world0",p.Vector4),this.registerInput("world1",p.Vector4),this.registerInput("world2",p.Vector4),this.registerInput("world3",p.Vector4),this.registerInput("world",p.Matrix,!0),this.registerOutput("output",p.Matrix),this.registerOutput("instanceID",p.Float)}getClassName(){return"InstancesBlock"}get world0(){return this._inputs[0]}get world1(){return this._inputs[1]}get world2(){return this._inputs[2]}get world3(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}get instanceID(){return this._outputs[1]}autoConfigure(e,t=()=>!0){if(!this.world0.connectedPoint){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="world0"&&t(r));i||(i=new ge("world0"),i.setAsAttribute("world0")),i.output.connectTo(this.world0)}if(!this.world1.connectedPoint){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="world1"&&t(r));i||(i=new ge("world1"),i.setAsAttribute("world1")),i.output.connectTo(this.world1)}if(!this.world2.connectedPoint){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="world2"&&t(r));i||(i=new ge("world2"),i.setAsAttribute("world2")),i.output.connectTo(this.world2)}if(!this.world3.connectedPoint){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="world3"&&t(r));i||(i=new ge("world3"),i.setAsAttribute("world3")),i.output.connectTo(this.world3)}if(!this.world.connectedPoint){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="world"&&t(r));i||(i=new ge("world"),i.setAsSystemValue(ve.World)),i.output.connectTo(this.world)}this.world.define="!INSTANCES || THIN_INSTANCES"}prepareDefines(e,t,i,r=!1,n){let a=!1;e.INSTANCES!==r&&(e.setValue("INSTANCES",r),a=!0),n&&e.THIN_INSTANCES!==!!(n!=null&&n.getRenderingMesh().hasThinInstances)&&(e.setValue("THIN_INSTANCES",!!(n!=null&&n.getRenderingMesh().hasThinInstances)),a=!0),a&&e.markAsUnprocessed()}_buildBlock(e){super._buildBlock(e);const t=e.sharedData.scene.getEngine();e.sharedData.blocksWithDefines.push(this);const i=this._outputs[0],r=this._outputs[1],n=this.world0,a=this.world1,o=this.world2,l=this.world3;let c="mat4",u="gl_InstanceID",h="float";return e.shaderLanguage===1&&(c="mat4x4f",u="vertexInputs.instanceIndex",h="f32"),e.compilationString+=`#ifdef INSTANCES
`,e.compilationString+=e._declareOutput(i)+` = ${c}(${n.associatedVariableName}, ${a.associatedVariableName}, ${o.associatedVariableName}, ${l.associatedVariableName});
`,e.compilationString+=`#ifdef THIN_INSTANCES
`,e.compilationString+=`${i.associatedVariableName} = ${this.world.associatedVariableName} * ${i.associatedVariableName};
`,e.compilationString+=`#endif
`,t._caps.canUseGLInstanceID?e.compilationString+=e._declareOutput(r)+` = ${h}(${u});
`:e.compilationString+=e._declareOutput(r)+` = 0.0;
`,e.compilationString+=`#else
`,e.compilationString+=e._declareOutput(i)+` = ${this.world.associatedVariableName};
`,e.compilationString+=e._declareOutput(r)+` = 0.0;
`,e.compilationString+=`#endif
`,this}}y("BABYLON.InstancesBlock",az);class jA extends ie{constructor(e){super(e,P.Vertex),this.registerInput("position",p.Vector3),this.registerInput("normal",p.Vector3),this.registerInput("tangent",p.AutoDetect),this.tangent.addExcludedConnectionPointFromAllowedTypes(p.Color4|p.Vector4|p.Vector3),this.registerInput("uv",p.Vector2),this.registerInput("uv2",p.Vector2),this.registerInput("color",p.Color4),this.registerOutput("positionOutput",p.Vector3),this.registerOutput("normalOutput",p.Vector3),this.registerOutput("tangentOutput",p.Vector4),this.registerOutput("uvOutput",p.Vector2),this.registerOutput("uv2Output",p.Vector2),this.registerOutput("colorOutput",p.Color4)}getClassName(){return"MorphTargetsBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get tangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get uv2(){return this._inputs[4]}get color(){return this._inputs[5]}get positionOutput(){return this._outputs[0]}get normalOutput(){return this._outputs[1]}get tangentOutput(){return this._outputs[2]}get uvOutput(){return this._outputs[3]}get uv2Output(){return this._outputs[4]}get colorOutput(){return this._outputs[5]}initialize(e){e._excludeVariableName("morphTargetInfluences"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,e===1?await Promise.all([U(()=>import("./morphTargetsVertex-8153f830.js").then(t=>t.c),["assets/morphTargetsVertex-8153f830.js","assets/main-e8601b72.js","assets/index-ad665221.css"]),U(()=>import("./morphTargetsVertex-8153f830.js").then(t=>t.a),["assets/morphTargetsVertex-8153f830.js","assets/main-e8601b72.js","assets/index-ad665221.css"]),U(()=>import("./morphTargetsVertex-8153f830.js").then(t=>t.b),["assets/morphTargetsVertex-8153f830.js","assets/main-e8601b72.js","assets/index-ad665221.css"]),U(()=>import("./morphTargetsVertex-8153f830.js").then(t=>t.m),["assets/morphTargetsVertex-8153f830.js","assets/main-e8601b72.js","assets/index-ad665221.css"])]):await Promise.all([U(()=>import("./main-e8601b72.js").then(t=>t.dV),["assets/main-e8601b72.js","assets/index-ad665221.css"]),U(()=>import("./main-e8601b72.js").then(t=>t.dS),["assets/main-e8601b72.js","assets/index-ad665221.css"]),U(()=>import("./main-e8601b72.js").then(t=>t.dU),["assets/main-e8601b72.js","assets/index-ad665221.css"]),U(()=>import("./main-e8601b72.js").then(t=>t.dR),["assets/main-e8601b72.js","assets/index-ad665221.css"])]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}autoConfigure(e,t=()=>!0){if(!this.position.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="position"&&t(r));i||(i=new ge("position"),i.setAsAttribute()),i.output.connectTo(this.position)}if(!this.normal.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="normal"&&t(r));i||(i=new ge("normal"),i.setAsAttribute("normal")),i.output.connectTo(this.normal)}if(!this.tangent.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="tangent"&&t(r));i||(i=new ge("tangent"),i.setAsAttribute("tangent")),i.output.connectTo(this.tangent)}if(!this.uv.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="uv"&&t(r));i||(i=new ge("uv"),i.setAsAttribute("uv")),i.output.connectTo(this.uv)}if(!this.uv2.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="uv2"&&t(r));i||(i=new ge("uv2"),i.setAsAttribute("uv2")),i.output.connectTo(this.uv2)}if(!this.color.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="color"&&t(r));i||(i=new ge("color"),i.setAsAttribute("color")),i.output.connectTo(this.color)}}prepareDefines(e,t,i){if(i){if(i.morphTargetManager){const r=i.morphTargetManager;r!=null&&r.isUsingTextureForTargets&&(r.numMaxInfluencers||r.numInfluencers)!==e.NUM_MORPH_INFLUENCERS&&e.markAsAttributesDirty()}e._areAttributesDirty&&VD(i,e)}}bind(e,t,i){i&&i.morphTargetManager&&i.morphTargetManager.numInfluencers>0&&(Da(i,e),i.morphTargetManager.isUsingTextureForTargets&&i.morphTargetManager._bind(e))}replaceRepeatableContent(e,t,i){if(!i)return;const r=this.position,n=this.normal,a=this.tangent,o=this.uv,l=this.uv2,c=this.color,u=this.positionOutput,h=this.normalOutput,d=this.tangentOutput,f=this.uvOutput,m=this.uv2Output,g=this.colorOutput,v=e,E=t.NUM_MORPH_INFLUENCERS,T=i.morphTargetManager,C=T&&T.supportsPositions,A=T&&T.supportsNormals,I=T&&T.supportsTangents,F=T&&T.supportsUVs,V=T&&T.supportsUV2s,D=T&&T.supportsColors;let w="";T!=null&&T.isUsingTextureForTargets&&E>0&&(w+=`${v._declareLocalVar("vertexID",p.Float)};
`),w+=`#ifdef MORPHTARGETS
`;const B=v.shaderLanguage===1,Q=B?"uniforms.":"";if(T!=null&&T.isUsingTextureForTargets)w+=`for (${B?"var":"int"} i = 0; i < NUM_MORPH_INFLUENCERS; i++) {
`,w+=`if (${B?"f32":"float"}(i) >= ${Q}morphTargetCount) { break; }
`,w+=`vertexID = ${B?"f32(vertexInputs.vertexIndex":"float(gl_VertexID"}) * ${Q}morphTargetTextureInfo.x;
`,C&&(w+=`#ifdef MORPHTARGETS_POSITION
`,w+=`${u.associatedVariableName} += (readVector3FromRawSampler(i, vertexID) - ${r.associatedVariableName}) * ${Q}morphTargetInfluences[i];
`,w+=`#endif
`),w+=`#ifdef MORPHTARGETTEXTURE_HASPOSITIONS
`,w+=`vertexID += 1.0;
`,w+=`#endif
`,A&&(w+=`#ifdef MORPHTARGETS_NORMAL
`,w+=`${h.associatedVariableName} += (readVector3FromRawSampler(i, vertexID) - ${n.associatedVariableName}) * ${Q}morphTargetInfluences[i];
`,w+=`#endif
`),w+=`#ifdef MORPHTARGETTEXTURE_HASNORMALS
`,w+=`vertexID += 1.0;
`,w+=`#endif
`,F&&(w+=`#ifdef MORPHTARGETS_UV
`,w+=`${f.associatedVariableName} += (readVector3FromRawSampler(i, vertexID).xy - ${o.associatedVariableName}) * ${Q}morphTargetInfluences[i];
`,w+=`#endif
`),w+=`#ifdef MORPHTARGETTEXTURE_HASUVS
`,w+=`vertexID += 1.0;
`,w+=`#endif
`,I&&(w+=`#ifdef MORPHTARGETS_TANGENT
`,w+=`${d.associatedVariableName}.xyz += (readVector3FromRawSampler(i, vertexID) - ${a.associatedVariableName}.xyz) * ${Q}morphTargetInfluences[i];
`,a.type===p.Vector4?w+=`${d.associatedVariableName}.w = ${a.associatedVariableName}.w;
`:w+=`${d.associatedVariableName}.w = 1.;
`,w+=`#endif
`),w+=`#ifdef MORPHTARGETTEXTURE_HASTANGENTS
`,w+=`vertexID += 1.0;
`,w+=`#endif
`,V&&(w+=`#ifdef MORPHTARGETS_UV2
`,w+=`${m.associatedVariableName} += (readVector3FromRawSampler(i, vertexID).xy - ${l.associatedVariableName}) * morphTargetInfluences[i];
`,w+=`#endif
`),w+=`#ifdef MORPHTARGETTEXTURE_HASUV2S
`,w+=`vertexID += 1.0;
`,w+=`#endif
`,D&&(w+=`#ifdef MORPHTARGETS_COLOR
`,w+=`${g.associatedVariableName} += (readVector4FromRawSampler(i, vertexID) - ${c.associatedVariableName}) * ${Q}morphTargetInfluences[i];
`,w+=`#endif
`),w+=`}
`;else for(let J=0;J<E;J++)C&&(w+=`#ifdef MORPHTARGETS_POSITION
`,w+=`${u.associatedVariableName} += (position${J} - ${r.associatedVariableName}) * ${Q}morphTargetInfluences[${J}];
`,w+=`#endif
`),A&&t.NORMAL&&(w+=`#ifdef MORPHTARGETS_NORMAL
`,w+=`${h.associatedVariableName} += (normal${J} - ${n.associatedVariableName}) * ${Q}morphTargetInfluences[${J}];
`,w+=`#endif
`),F&&t.UV1&&(w+=`#ifdef MORPHTARGETS_UV
`,w+=`${f.associatedVariableName}.xy += (uv_${J} - ${o.associatedVariableName}.xy) * ${Q}morphTargetInfluences[${J}];
`,w+=`#endif
`),I&&t.TANGENT&&(w+=`#ifdef MORPHTARGETS_TANGENT
`,w+=`${d.associatedVariableName}.xyz += (tangent${J} - ${a.associatedVariableName}.xyz) * ${Q}morphTargetInfluences[${J}];
`,a.type===p.Vector4?w+=`${d.associatedVariableName}.w = ${a.associatedVariableName}.w;
`:w+=`${d.associatedVariableName}.w = 1.;
`,w+=`#endif
`),V&&t.UV2&&(w+=`#ifdef MORPHTARGETS_UV2
`,w+=`${m.associatedVariableName}.xy += (uv2_${J} - ${l.associatedVariableName}.xy) * morphTargetInfluences[${J}];
`,w+=`#endif
`),D&&t.VERTEXCOLOR_NME&&(w+=`#ifdef MORPHTARGETS_COLOR
`,w+=`${g.associatedVariableName} += (color${J} - ${c.associatedVariableName}) * ${Q}morphTargetInfluences[${J}];
`,w+=`#endif
`);if(w+=`#endif
`,v.compilationString=v.compilationString.replace(this._repeatableContentAnchor,w),E>0)for(let J=0;J<E;J++)C&&v.attributes.push(M.PositionKind+J),A&&t.NORMAL&&v.attributes.push(M.NormalKind+J),I&&t.TANGENT&&v.attributes.push(M.TangentKind+J),F&&t.UV1&&v.attributes.push(M.UVKind+"_"+J),V&&t.UV2&&v.attributes.push(M.UV2Kind+"_"+J),D&&t.VERTEXCOLOR_NME&&v.attributes.push(M.ColorKind+J)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e.sharedData.repeatableContentBlocks.push(this);const t=this.position,i=this.normal,r=this.tangent,n=this.uv,a=this.uv2,o=this.color,l=this.positionOutput,c=this.normalOutput,u=this.tangentOutput,h=this.uvOutput,d=this.uv2Output,f=this.colorOutput,m=`//${this.name}`;return e.uniforms.push("morphTargetInfluences"),e.uniforms.push("morphTargetCount"),e.uniforms.push("morphTargetTextureInfo"),e.uniforms.push("morphTargetTextureIndices"),e.samplers.push("morphTargets"),e._emitFunctionFromInclude("morphTargetsVertexGlobalDeclaration",m),e._emitFunctionFromInclude("morphTargetsVertexDeclaration",m,{repeatKey:"maxSimultaneousMorphTargets"}),e.compilationString+=`${e._declareOutput(l)} = ${t.associatedVariableName};
`,e.compilationString+=`#ifdef NORMAL
`,e.compilationString+=`${e._declareOutput(c)} = ${i.associatedVariableName};
`,e.compilationString+=`#else
`,e.compilationString+=`${e._declareOutput(c)} = vec3(0., 0., 0.);
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef TANGENT
`,e.compilationString+=`${e._declareOutput(u)} = ${r.associatedVariableName};
`,e.compilationString+=`#else
`,e.compilationString+=`${e._declareOutput(u)} = vec4(0., 0., 0., 0.);
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef UV1
`,e.compilationString+=`${e._declareOutput(h)} = ${n.associatedVariableName};
`,e.compilationString+=`#else
`,e.compilationString+=`${e._declareOutput(h)} = vec2(0., 0.);
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef UV2
`,e.compilationString+=`${e._declareOutput(d)} = ${a.associatedVariableName};
`,e.compilationString+=`#else
`,e.compilationString+=`${e._declareOutput(d)} = vec2(0., 0.);
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef VERTEXCOLOR_NME
`,e.compilationString+=`${e._declareOutput(f)} = ${o.associatedVariableName};
`,e.compilationString+=`#else
`,e.compilationString+=`${e._declareOutput(f)} = vec4(0., 0., 0., 0.);
`,e.compilationString+=`#endif
`,this._repeatableContentAnchor=e._repeatableContentAnchor,e.compilationString+=this._repeatableContentAnchor,this}}y("BABYLON.MorphTargetsBlock",jA);class oz extends ie{constructor(e){super(e,P.Vertex),this.registerInput("worldPosition",p.Vector4,!1,P.Vertex),this.registerOutput("direction",p.Vector3),this.registerOutput("color",p.Color3),this.registerOutput("intensity",p.Float),this.registerOutput("shadowBias",p.Float),this.registerOutput("shadowNormalBias",p.Float),this.registerOutput("shadowDepthScale",p.Float),this.registerOutput("shadowDepthRange",p.Vector2)}getClassName(){return"LightInformationBlock"}get worldPosition(){return this._inputs[0]}get direction(){return this._outputs[0]}get color(){return this._outputs[1]}get intensity(){return this._outputs[2]}get shadowBias(){return this._outputs[3]}get shadowNormalBias(){return this._outputs[4]}get shadowDepthScale(){return this._outputs[5]}get shadowDepthRange(){return this._outputs[6]}bind(e,t,i){if(!i)return;this.light&&this.light.isDisposed()&&(this.light=null);let r=this.light;const n=t.getScene();if(!r&&n.lights.length&&(r=this.light=n.lights[0],this._forcePrepareDefines=!0),!r||!r.isEnabled){e.setFloat3(this._lightDataUniformName,0,0,0),e.setFloat4(this._lightColorUniformName,0,0,0,0);return}r.transferToNodeMaterialEffect(e,this._lightDataUniformName),e.setColor4(this._lightColorUniformName,r.diffuse,r.intensity);const a=r.getShadowGenerator();if((this.shadowBias.hasEndpoints||this.shadowNormalBias.hasEndpoints||this.shadowDepthScale.hasEndpoints)&&(a?e.setFloat3(this._lightShadowUniformName,a.bias,a.normalBias,a.depthScale):e.setFloat3(this._lightShadowUniformName,0,0,0)),this.shadowDepthRange)if(a&&n.activeCamera){const o=r;e.setFloat2(this._lightShadowExtraUniformName,o.getDepthMinZ(n.activeCamera),o.getDepthMinZ(n.activeCamera)+o.getDepthMaxZ(n.activeCamera))}else e.setFloat2(this._lightShadowExtraUniformName,0,0)}prepareDefines(e){if(!e._areLightsDirty&&!this._forcePrepareDefines)return;this._forcePrepareDefines=!1;const t=this.light;e.setValue(this._lightTypeDefineName,!!(t&&t instanceof UD),!0)}_buildBlock(e){super._buildBlock(e),e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);const t=this.direction,i=this.color,r=this.intensity,n=this.shadowBias,a=this.shadowNormalBias,o=this.shadowDepthScale,l=this.shadowDepthRange;this._lightDataUniformName=e._getFreeVariableName("lightData"),this._lightColorUniformName=e._getFreeVariableName("lightColor"),this._lightShadowUniformName=e._getFreeVariableName("shadowData"),this._lightShadowExtraUniformName=e._getFreeVariableName("shadowExtraData"),this._lightTypeDefineName=e._getFreeDefineName("LIGHTPOINTTYPE");const c=e.shaderLanguage===1?"uniforms.":"";return e._emitUniformFromString(this._lightDataUniformName,p.Vector3),e._emitUniformFromString(this._lightColorUniformName,p.Vector4),e.compilationString+=`#ifdef ${this._lightTypeDefineName}
`,e.compilationString+=e._declareOutput(t)+` = normalize(${this.worldPosition.associatedVariableName}.xyz - ${c}${this._lightDataUniformName});
`,e.compilationString+=`#else
`,e.compilationString+=e._declareOutput(t)+` = ${c}${this._lightDataUniformName};
`,e.compilationString+=`#endif
`,e.compilationString+=e._declareOutput(i)+` = ${c}${this._lightColorUniformName}.rgb;
`,e.compilationString+=e._declareOutput(r)+` = ${c}${this._lightColorUniformName}.a;
`,(n.hasEndpoints||a.hasEndpoints||o.hasEndpoints)&&(e._emitUniformFromString(this._lightShadowUniformName,p.Vector3),n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = ${c}${this._lightShadowUniformName}.x;
`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${c}${this._lightShadowUniformName}.y;
`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${c}${this._lightShadowUniformName}.z;
`)),l.hasEndpoints&&(e._emitUniformFromString(this._lightShadowExtraUniformName,p.Vector2),e.compilationString+=e._declareOutput(l)+` = ${this._lightShadowUniformName};
`),this}serialize(){const e=super.serialize();return this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId))}}y("BABYLON.LightInformationBlock",oz);class qA extends ie{constructor(e){super(e,P.Fragment),this.convertInputToLinearSpace=!0,this.registerInput("color",p.AutoDetect),this.registerOutput("output",p.Color4),this.registerOutput("rgb",p.Color3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(p.Color3|p.Color4|p.Vector3|p.Vector4)}getClassName(){return"ImageProcessingBlock"}get color(){return this._inputs[0]}get output(){return this._outputs[0]}get rgb(){return this._outputs[1]}initialize(e){e._excludeVariableName("exposureLinear"),e._excludeVariableName("contrast"),e._excludeVariableName("vInverseScreenSize"),e._excludeVariableName("vignetteSettings1"),e._excludeVariableName("vignetteSettings2"),e._excludeVariableName("vCameraColorCurveNegative"),e._excludeVariableName("vCameraColorCurveNeutral"),e._excludeVariableName("vCameraColorCurvePositive"),e._excludeVariableName("txColorTransform"),e._excludeVariableName("colorTransformSettings"),e._excludeVariableName("ditherIntensity"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,e===1?await Promise.all([U(()=>import("./helperFunctions-60ac609f.js"),["assets/helperFunctions-60ac609f.js","assets/main-e8601b72.js","assets/index-ad665221.css"]),U(()=>import("./logDepthFragment-1fbe4860.js").then(t=>t.i),["assets/logDepthFragment-1fbe4860.js","assets/main-e8601b72.js","assets/index-ad665221.css"]),U(()=>import("./logDepthFragment-1fbe4860.js").then(t=>t.a),["assets/logDepthFragment-1fbe4860.js","assets/main-e8601b72.js","assets/index-ad665221.css"])]):await Promise.all([U(()=>import("./main-e8601b72.js").then(t=>t.dZ),["assets/main-e8601b72.js","assets/index-ad665221.css"]),U(()=>import("./main-e8601b72.js").then(t=>t.dY),["assets/main-e8601b72.js","assets/index-ad665221.css"]),U(()=>import("./main-e8601b72.js").then(t=>t.d_),["assets/main-e8601b72.js","assets/index-ad665221.css"])]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}isReady(e,t,i){return!(i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())}prepareDefines(e,t){e._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(e)}bind(e,t,i){i&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}_buildBlock(e){var a;super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),e.sharedData.bindableBlocks.push(this),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity");const t=this.color,i=this._outputs[0],r=`//${this.name}`,n=e.shaderLanguage===1?"Vec3":"";return e._emitFunctionFromInclude("helperFunctions",r),e._emitFunctionFromInclude("imageProcessingDeclaration",r),e._emitFunctionFromInclude("imageProcessingFunctions",r),(a=t.connectedPoint)!=null&&a.isConnected&&(t.connectedPoint.type===p.Color4||t.connectedPoint.type===p.Vector4?e.compilationString+=`${e._declareOutput(i)} = ${t.associatedVariableName};
`:e.compilationString+=`${e._declareOutput(i)} = vec4${e.fSuffix}(${t.associatedVariableName}, 1.0);
`,e.compilationString+=`#ifdef IMAGEPROCESSINGPOSTPROCESS
`,this.convertInputToLinearSpace&&(e.compilationString+=`${i.associatedVariableName} = vec4${e.fSuffix}(toLinearSpace${n}(${t.associatedVariableName}.rgb), ${t.associatedVariableName}.a);
`),e.compilationString+=`#else
`,e.compilationString+=`#ifdef IMAGEPROCESSING
`,this.convertInputToLinearSpace&&(e.compilationString+=`${i.associatedVariableName} = vec4${e.fSuffix}(toLinearSpace${n}(${t.associatedVariableName}.rgb), ${t.associatedVariableName}.a);
`),e.compilationString+=`${i.associatedVariableName} = applyImageProcessing(${i.associatedVariableName});
`,e.compilationString+=`#endif
`,e.compilationString+=`#endif
`,this.rgb.hasEndpoints&&(e.compilationString+=e._declareOutput(this.rgb)+` = ${this.output.associatedVariableName}.xyz;
`)),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertInputToLinearSpace = ${this.convertInputToLinearSpace};
`,e}serialize(){const e=super.serialize();return e.convertInputToLinearSpace=this.convertInputToLinearSpace,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertInputToLinearSpace=e.convertInputToLinearSpace??!0}}_([O("Convert input to linear space",0,"ADVANCED")],qA.prototype,"convertInputToLinearSpace",void 0);y("BABYLON.ImageProcessingBlock",qA);class Zo extends ie{constructor(e){super(e,P.Fragment,!0),this.registerInput("normal",p.AutoDetect,!1),this.normal.addExcludedConnectionPointFromAllowedTypes(p.Color4|p.Vector4|p.Vector3),this.registerInput("tangent",p.Vector4,!1),this.registerInput("world",p.Matrix,!1),this.registerOutput("TBN",p.Object,P.Fragment,new at("TBN",this,1,Zo,"TBNBlock")),this.registerOutput("row0",p.Vector3,P.Fragment),this.registerOutput("row1",p.Vector3,P.Fragment),this.registerOutput("row2",p.Vector3,P.Fragment)}getClassName(){return"TBNBlock"}initialize(e){e._excludeVariableName("tbnNormal"),e._excludeVariableName("tbnTangent"),e._excludeVariableName("tbnBitangent"),e._excludeVariableName("TBN")}get normal(){return this._inputs[0]}get tangent(){return this._inputs[1]}get world(){return this._inputs[2]}get TBN(){return this._outputs[0]}get row0(){return this._outputs[1]}get row1(){return this._outputs[2]}get row2(){return this._outputs[3]}get target(){return P.Fragment}set target(e){}autoConfigure(e,t=()=>!0){if(!this.world.isConnected){let i=e.getInputBlockByPredicate(r=>r.isSystemValue&&r.systemValue===ve.World&&t(r));i||(i=new ge("world"),i.setAsSystemValue(ve.World)),i.output.connectTo(this.world)}if(!this.normal.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="normal"&&t(r));i||(i=new ge("normal"),i.setAsAttribute("normal")),i.output.connectTo(this.normal)}if(!this.tangent.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="tangent"&&r.type===p.Vector4&&t(r));i||(i=new ge("tangent"),i.setAsAttribute("tangent")),i.output.connectTo(this.tangent)}}prepareDefines(e,t,i){var c,u,h,d;if(!i)return;const r=this.normal,n=this.tangent;let a=r.isConnected;(c=r.connectInputBlock)!=null&&c.isAttribute&&!i.isVerticesDataPresent((u=r.connectInputBlock)==null?void 0:u.name)&&(a=!1);let o=n.isConnected;(h=n.connectInputBlock)!=null&&h.isAttribute&&!i.isVerticesDataPresent((d=n.connectInputBlock)==null?void 0:d.name)&&(o=!1);const l=a&&o;e.setValue("TBNBLOCK",l,!0)}_buildBlock(e){super._buildBlock(e);const t=this.normal,i=this.tangent,r=this.world,n=this.TBN,a=this.row0,o=this.row1,l=this.row2,c=e.shaderLanguage===1,u=c?"mat3x3f":"mat3",h=c?"f":"";return e.target===P.Fragment&&(e.compilationString+=`
                // ${this.name}
                ${e._declareLocalVar("tbnNormal",p.Vector3)} = normalize(${t.associatedVariableName}).xyz;
                ${e._declareLocalVar("tbnTangent",p.Vector3)} = normalize(${i.associatedVariableName}.xyz);
                ${e._declareLocalVar("tbnBitangent",p.Vector3)} = cross(tbnNormal, tbnTangent) * ${i.associatedVariableName}.w;
                ${c?"var":"mat3"} ${n.associatedVariableName} = ${u}(${r.associatedVariableName}[0].xyz, ${r.associatedVariableName}[1].xyz, ${r.associatedVariableName}[2].xyz) * ${u}(tbnTangent, tbnBitangent, tbnNormal);
            `,a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = vec3${h}(${n.associatedVariableName}[0][0], ${n.associatedVariableName}[0][1], ${n.associatedVariableName}[0][2]);
`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = vec3${h}(${n.associatedVariableName}[1[0], ${n.associatedVariableName}[1][1], ${n.associatedVariableName}[1][2]);
`),l.hasEndpoints&&(e.compilationString+=e._declareOutput(l)+` = vec3${h}(${n.associatedVariableName}[2][0], ${n.associatedVariableName}[2][1], ${n.associatedVariableName}[2][2]);
`),e.sharedData.blocksWithDefines.push(this)),this}}y("BABYLON.TBNBlock",Zo);class uc extends ie{constructor(e){super(e,P.Fragment),this._tangentSpaceParameterName="",this._tangentCorrectionFactorName="",this._worldMatrixName="",this.invertX=!1,this.invertY=!1,this.useParallaxOcclusion=!1,this.useObjectSpaceNormalMap=!1,this._isUnique=!0,this.registerInput("worldPosition",p.Vector4,!1),this.registerInput("worldNormal",p.Vector4,!1),this.registerInput("worldTangent",p.Vector4,!0),this.registerInput("uv",p.Vector2,!1),this.registerInput("normalMapColor",p.Color3,!1),this.registerInput("strength",p.Float,!1),this.registerInput("viewDirection",p.Vector3,!0),this.registerInput("parallaxScale",p.Float,!0),this.registerInput("parallaxHeight",p.Float,!0),this.registerInput("TBN",p.Object,!0,P.VertexAndFragment,new at("TBN",this,0,Zo,"TBNBlock")),this.registerInput("world",p.Matrix,!0),this.registerOutput("output",p.Vector4),this.registerOutput("uvOffset",p.Vector2)}getClassName(){return"PerturbNormalBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get worldTangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get normalMapColor(){return this._inputs[4]}get strength(){return this._inputs[5]}get viewDirection(){return this._inputs[6]}get parallaxScale(){return this._inputs[7]}get parallaxHeight(){return this._inputs[8]}get TBN(){return this._inputs[9]}get world(){return this._inputs[10]}get output(){return this._outputs[0]}get uvOffset(){return this._outputs[1]}initialize(e){this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,e===1?await Promise.all([U(()=>import("./default.fragment-d4022e5c.js").then(t=>t.d),["assets/default.fragment-d4022e5c.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/mainUVVaryingDeclaration-d7d129d5.js","assets/meshUboDeclaration-6df77899.js","assets/helperFunctions-60ac609f.js","assets/logDepthFragment-1fbe4860.js","assets/clipPlaneFragment-4ee9d5d8.js","assets/logDepthDeclaration-2a2324b6.js","assets/fogFragmentDeclaration-ab16d80d.js"]),U(()=>import("./default.fragment-d4022e5c.js").then(t=>t.b),["assets/default.fragment-d4022e5c.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/mainUVVaryingDeclaration-d7d129d5.js","assets/meshUboDeclaration-6df77899.js","assets/helperFunctions-60ac609f.js","assets/logDepthFragment-1fbe4860.js","assets/clipPlaneFragment-4ee9d5d8.js","assets/logDepthDeclaration-2a2324b6.js","assets/fogFragmentDeclaration-ab16d80d.js"]),U(()=>import("./default.fragment-d4022e5c.js").then(t=>t.c),["assets/default.fragment-d4022e5c.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/mainUVVaryingDeclaration-d7d129d5.js","assets/meshUboDeclaration-6df77899.js","assets/helperFunctions-60ac609f.js","assets/logDepthFragment-1fbe4860.js","assets/clipPlaneFragment-4ee9d5d8.js","assets/logDepthDeclaration-2a2324b6.js","assets/fogFragmentDeclaration-ab16d80d.js"])]):await Promise.all([U(()=>import("./default.fragment-24488752.js").then(t=>t.e),["assets/default.fragment-24488752.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/mainUVVaryingDeclaration-91e38cff.js","assets/meshUboDeclaration-ca609797.js"]),U(()=>import("./default.fragment-24488752.js").then(t=>t.c),["assets/default.fragment-24488752.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/mainUVVaryingDeclaration-91e38cff.js","assets/meshUboDeclaration-ca609797.js"]),U(()=>import("./default.fragment-24488752.js").then(t=>t.d),["assets/default.fragment-24488752.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/mainUVVaryingDeclaration-91e38cff.js","assets/meshUboDeclaration-ca609797.js"])]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}prepareDefines(e,t){const i=this.normalMapColor.connectedPoint._ownerBlock.samplerName,r=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&!!i||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected);e.setValue("BUMP",!0),e.setValue("PARALLAX",r,!0),e.setValue("PARALLAX_RHS",t.getScene().useRightHandedSystem,!0),e.setValue("PARALLAXOCCLUSION",this.useParallaxOcclusion,!0),e.setValue("OBJECTSPACE_NORMALMAP",this.useObjectSpaceNormalMap,!0)}bind(e,t,i){t.getScene()._mirroredCameraPosition?e.setFloat2(this._tangentSpaceParameterName,this.invertX?1:-1,this.invertY?1:-1):e.setFloat2(this._tangentSpaceParameterName,this.invertX?-1:1,this.invertY?-1:1),i&&(e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1),this.useObjectSpaceNormalMap&&!this.world.isConnected&&e.setMatrix(this._worldMatrixName,i.getWorldMatrix()))}autoConfigure(e,t=()=>!0){if(!this.uv.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="uv"&&t(r));i||(i=new ge("uv"),i.setAsAttribute()),i.output.connectTo(this.uv)}if(!this.strength.isConnected){const i=new ge("strength");i.value=1,i.output.connectTo(this.strength)}}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`,i=this.uv,r=this.worldPosition,n=this.worldNormal,a=this.worldTangent,o=e.shaderLanguage===1,l=o?"mat3x3f":"mat3",c=o?"f":"",u=o?"uniforms.":"",h=o?"fragmentInputs.":"";e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentSpaceParameterName=e._getFreeDefineName("tangentSpaceParameter"),e._emitUniformFromString(this._tangentSpaceParameterName,p.Vector2),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,p.Float),this._worldMatrixName=e._getFreeDefineName("perturbNormalWorldMatrix"),e._emitUniformFromString(this._worldMatrixName,p.Matrix);let d=null;this.normalMapColor.connectedPoint&&(d=this.normalMapColor.connectedPoint._ownerBlock.samplerName);const f=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&!!d||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected),m=this.parallaxScale.isConnectedToInputBlock?this.parallaxScale.connectInputBlock.isConstant?e._emitFloat(this.parallaxScale.connectInputBlock.value):this.parallaxScale.associatedVariableName:"0.05",g=this.strength.isConnectedToInputBlock&&this.strength.connectInputBlock.isConstant?`
#if !defined(NORMALXYSCALE)
1.0/
#endif
${e._emitFloat(this.strength.connectInputBlock.value)}`:`
#if !defined(NORMALXYSCALE)
1.0/
#endif
${this.strength.associatedVariableName}`;o||e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const v={search:/defined\(TANGENT\)/g,replace:a.isConnected?"defined(TANGENT)":"defined(IGNORE)"},E={search:/varying mat3 vTBN;/g,replace:""},T={search:o?/uniform normalMatrix: mat4x4f;/g:/uniform mat4 normalMatrix;/g,replace:""},C=this.TBN;C.isConnected?e.compilationString+=`
            #ifdef TBNBLOCK
            ${o?"var":"mat3"} vTBN = ${C.associatedVariableName};
            #endif
            `:a.isConnected&&(e.compilationString+=`${e._declareLocalVar("tbnNormal",p.Vector3)} = normalize(${n.associatedVariableName}.xyz);
`,e.compilationString+=`${e._declareLocalVar("tbnTangent",p.Vector3)} = normalize(${a.associatedVariableName}.xyz);
`,e.compilationString+=`${e._declareLocalVar("tbnBitangent",p.Vector3)} = cross(tbnNormal, tbnTangent) * ${u}${this._tangentCorrectionFactorName};
`,e.compilationString+=`${o?"var":"mat3"} vTBN = ${l}(tbnTangent, tbnBitangent, tbnNormal);
`);let A=[v,E,T];o&&(A.push({search:/varying vTBN0: vec3f;/g,replace:""}),A.push({search:/varying vTBN1: vec3f;/g,replace:""}),A.push({search:/varying vTBN2: vec3f;/g,replace:""})),e._emitFunctionFromInclude("bumpFragmentMainFunctions",t,{replaceStrings:A});const I=o?"fn parallaxOcclusion(vViewDirCoT: vec3f, vNormalCoT: vec3f, texCoord: vec2f, parallaxScale:f32, bumpSampler: texture_2d<f32>, bumpSamplerSampler: sampler)":`#define inline
vec2 parallaxOcclusion(vec3 vViewDirCoT, vec3 vNormalCoT, vec2 texCoord, float parallaxScale, sampler2D bumpSampler)`,F=o?/fn parallaxOcclusion\(vViewDirCoT: vec3f,vNormalCoT: vec3f,texCoord: vec2f,parallaxScale: f32\)/g:/vec2 parallaxOcclusion\(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale\)/g,V=o?"fn parallaxOffset(viewDir: vec3f, heightScale: f32, height_: f32)":"vec2 parallaxOffset(vec3 viewDir, float heightScale, float height_)",D=o?/fn parallaxOffset\(viewDir: vec3f,heightScale: f32\)/g:/vec2 parallaxOffset\(vec3 viewDir,float heightScale\)/g;e._emitFunctionFromInclude("bumpFragmentFunctions",t,{replaceStrings:[{search:/#include<samplerFragmentDeclaration>\(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump\)/g,replace:""},{search:/uniform sampler2D bumpSampler;/g,replace:""},{search:F,replace:I},{search:D,replace:V},{search:/texture.+?bumpSampler,.*?vBumpUV\)\.w/g,replace:"height_"}]});const w=o?`textureSample(${d}, ${d+"Sampler"}`:`texture2D(${d}`,B=!f||!d?this.normalMapColor.associatedVariableName:`${w}, ${i.associatedVariableName} + uvOffset).xyz`,Q=e._getFreeVariableName("tempOutput");return e.compilationString+=e._declareLocalVar(Q,p.Vector3)+` = vec3${c}(0.);
`,A=[{search:new RegExp(`texture.+?bumpSampler${o?"Sampler,fragmentInputs.":","}vBumpUV\\)`,"g"),replace:`${B}`},{search:/#define CUSTOM_FRAGMENT_BUMP_FRAGMENT/g,replace:`${e._declareLocalVar("normalMatrix",p.Matrix)} = toNormalMatrix(${this.world.isConnected?this.world.associatedVariableName:u+this._worldMatrixName});`},{search:new RegExp(`perturbNormal\\(TBN,texture.+?bumpSampler${o?"Sampler,fragmentInputs.":","}vBumpUV\\+uvOffset\\).xyz,${u}vBumpInfos.y\\)`,"g"),replace:`perturbNormal(TBN, ${B}, ${u}vBumpInfos.y)`},{search:/parallaxOcclusion\(invTBN\*-viewDirectionW,invTBN\*normalW,(fragmentInputs\.)?vBumpUV,(uniforms\.)?vBumpInfos.z\)/g,replace:`parallaxOcclusion((invTBN * -viewDirectionW), (invTBN * normalW), ${h}vBumpUV, ${u}vBumpInfos.z, ${o?f&&this.useParallaxOcclusion?`${d}, ${d+"Sampler"}`:"bump, bumpSampler":f&&this.useParallaxOcclusion?d:"bumpSampler"})`},{search:/parallaxOffset\(invTBN\*viewDirectionW,vBumpInfos\.z\)/g,replace:`parallaxOffset(invTBN * viewDirectionW, ${u}vBumpInfos.z, ${f?this.parallaxHeight.associatedVariableName:"0."})`},{search:o?/uniforms.vBumpInfos.y/g:/vBumpInfos.y/g,replace:g},{search:o?/uniforms.vBumpInfos.z/g:/vBumpInfos.z/g,replace:m},{search:/normalW=/g,replace:Q+" = "},o?{search:/mat3x3f\(uniforms\.normalMatrix\[0\].xyz,uniforms\.normalMatrix\[1\]\.xyz,uniforms\.normalMatrix\[2\].xyz\)\*normalW/g,replace:`${l}(normalMatrix[0].xyz, normalMatrix[1].xyz, normalMatrix[2].xyz) * `+Q}:{search:/mat3\(normalMatrix\)\*normalW/g,replace:`${l}(normalMatrix) * `+Q},{search:/normalW/g,replace:n.associatedVariableName+".xyz"},{search:/viewDirectionW/g,replace:f?this.viewDirection.associatedVariableName:`vec3${c}(0.)`},v],o?(A.push({search:/fragmentInputs.vBumpUV/g,replace:i.associatedVariableName}),A.push({search:/input.vPositionW/g,replace:r.associatedVariableName+".xyz"}),A.push({search:/uniforms.vTangentSpaceParams/g,replace:u+this._tangentSpaceParameterName}),A.push({search:/var TBN: mat3x3f=mat3x3<f32>\(input.vTBN0,input.vTBN1,input.vTBN2\);/g,replace:"var TBN = vTBN;"})):(A.push({search:/vBumpUV/g,replace:i.associatedVariableName}),A.push({search:/vPositionW/g,replace:r.associatedVariableName+".xyz"}),A.push({search:/vTangentSpaceParams/g,replace:u+this._tangentSpaceParameterName})),e.compilationString+=e._emitCodeFromInclude("bumpFragment",t,{replaceStrings:A}),e.compilationString+=e._declareOutput(this.output)+` = vec4${c}(${Q}, 0.);
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.invertX = ${this.invertX};
`;return e+=`${this._codeVariableName}.invertY = ${this.invertY};
`,e+=`${this._codeVariableName}.useParallaxOcclusion = ${this.useParallaxOcclusion};
`,e+=`${this._codeVariableName}.useObjectSpaceNormalMap = ${this.useObjectSpaceNormalMap};
`,e}serialize(){const e=super.serialize();return e.invertX=this.invertX,e.invertY=this.invertY,e.useParallaxOcclusion=this.useParallaxOcclusion,e.useObjectSpaceNormalMap=this.useObjectSpaceNormalMap,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.invertX=e.invertX,this.invertY=e.invertY,this.useParallaxOcclusion=!!e.useParallaxOcclusion,this.useObjectSpaceNormalMap=!!e.useObjectSpaceNormalMap,this.parallaxScale._isInactive=this.useParallaxOcclusion,this.parallaxHeight._isInactive=this.useParallaxOcclusion}}_([O("Invert X axis",0,"PROPERTIES",{embedded:!0,notifiers:{update:!0}})],uc.prototype,"invertX",void 0);_([O("Invert Y axis",0,"PROPERTIES",{embedded:!0,notifiers:{update:!0}})],uc.prototype,"invertY",void 0);_([O("Use parallax occlusion",0,void 0,{embedded:!0,notifiers:{update:!0,callback:(s,e)=>(e.parallaxScale._isInactive=e.useParallaxOcclusion,e.parallaxHeight._isInactive=e.useParallaxOcclusion,!0)}})],uc.prototype,"useParallaxOcclusion",void 0);_([O("Object Space Mode",0,"PROPERTIES",{embedded:!0,notifiers:{update:!0}})],uc.prototype,"useObjectSpaceNormalMap",void 0);y("BABYLON.PerturbNormalBlock",uc);class lz extends ie{constructor(e){super(e,P.Fragment,!0),this.registerInput("value",p.Float,!0),this.registerInput("cutoff",p.Float,!0)}getClassName(){return"DiscardBlock"}get value(){return this._inputs[0]}get cutoff(){return this._inputs[1]}_buildBlock(e){if(super._buildBlock(e),e.sharedData.hints.needAlphaTesting=!0,!(!this.cutoff.isConnected||!this.value.isConnected))return e.compilationString+=`if (${this.value.associatedVariableName} < ${this.cutoff.associatedVariableName}) { discard; }
`,this}}y("BABYLON.DiscardBlock",lz);class cz extends ie{constructor(e){super(e,P.Fragment),this.registerOutput("output",p.Float,P.Fragment)}getClassName(){return"FrontFacingBlock"}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),e.target===P.Vertex)return e.sharedData.raiseBuildError("FrontFacingBlock must only be used in a fragment shader"),this;const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary("1.0","0.0",e.shaderLanguage===0?"gl_FrontFacing":"fragmentInputs.frontFacing")};
`,this}}y("BABYLON.FrontFacingBlock",cz);class uz extends ie{constructor(e){super(e,P.Fragment),this.registerInput("input",p.AutoDetect,!1),this.registerOutput("dx",p.BasedOnInput),this.registerOutput("dy",p.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[1]._typeConnectionSource=this._inputs[0]}getClassName(){return"DerivativeBlock"}get input(){return this._inputs[0]}get dx(){return this._outputs[0]}get dy(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._outputs[1];e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");let r="dFdx",n="dFdy";return e.shaderLanguage===1&&(r="dpdx",n="dpdy"),t.hasEndpoints&&(e.compilationString+=e._declareOutput(t)+` = ${r}(${this.input.associatedVariableName});
`),i.hasEndpoints&&(e.compilationString+=e._declareOutput(i)+` = ${n}(${this.input.associatedVariableName});
`),this}}y("BABYLON.DerivativeBlock",uz);class hz extends ie{constructor(e){super(e,P.Fragment),this.registerOutput("xy",p.Vector2,P.Fragment),this.registerOutput("xyz",p.Vector3,P.Fragment),this.registerOutput("xyzw",p.Vector4,P.Fragment),this.registerOutput("x",p.Float,P.Fragment),this.registerOutput("y",p.Float,P.Fragment),this.registerOutput("z",p.Float,P.Fragment),this.registerOutput("w",p.Float,P.Fragment)}getClassName(){return"FragCoordBlock"}get xy(){return this._outputs[0]}get xyz(){return this._outputs[1]}get xyzw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get output(){return this._outputs[6]}writeOutputs(e){let t="";const i=e.shaderLanguage===1?"fragmentInputs.position":"gl_FragCoord";for(const r of this._outputs)r.hasEndpoints&&(t+=`${e._declareOutput(r)} = ${i}.${r.name};
`);return t}_buildBlock(e){return super._buildBlock(e),e.target===P.Vertex?(e.sharedData.raiseBuildError("FragCoordBlock must only be used in a fragment shader"),this):(e.compilationString+=this.writeOutputs(e),this)}}y("BABYLON.FragCoordBlock",hz);class dz extends ie{constructor(e){super(e,P.Fragment),this.registerInput("vector",p.AutoDetect),this.registerInput("worldViewProjection",p.Matrix),this.registerOutput("output",p.Vector2),this.registerOutput("x",p.Float),this.registerOutput("y",p.Float),this.inputs[0].addExcludedConnectionPointFromAllowedTypes(p.Color3|p.Vector3|p.Vector4)}getClassName(){return"ScreenSpaceBlock"}get vector(){return this._inputs[0]}get worldViewProjection(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(e,t=()=>!0){if(!this.worldViewProjection.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===ve.WorldViewProjection&&t(r));i||(i=new ge("worldViewProjection"),i.setAsSystemValue(ve.WorldViewProjection)),i.output.connectTo(this.worldViewProjection)}}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=this.worldViewProjection;if(!t.connectedPoint)return;const r=i.associatedVariableName,n=e._getFreeVariableName("screenSpaceTemp");switch(t.connectedPoint.type){case p.Vector3:e.compilationString+=`${e._declareLocalVar(n,p.Vector4)} = ${r} * vec4${e.fSuffix}(${t.associatedVariableName}, 1.0);
`;break;case p.Vector4:e.compilationString+=`${e._declareLocalVar(n,p.Vector4)} = ${r} * ${t.associatedVariableName};
`;break}return e.compilationString+=`${n} = vec4${e.fSuffix}(${n}.xy / ${n}.w, ${n}.zw);`,e.compilationString+=`${n} = vec4${e.fSuffix}(${n}.xy * 0.5 + vec2${e.fSuffix}(0.5, 0.5), ${n}.zw);`,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${n}.xy;
`),this.x.hasEndpoints&&(e.compilationString+=e._declareOutput(this.x)+` = ${n}.x;
`),this.y.hasEndpoints&&(e.compilationString+=e._declareOutput(this.y)+` = ${n}.y;
`),this}}y("BABYLON.ScreenSpaceBlock",dz);class fz extends ie{constructor(e){super(e,P.Fragment),this.registerInput("input",p.Vector2),this.registerInput("strength",p.Float),this.registerInput("center",p.Vector2),this.registerInput("offset",p.Vector2),this.registerOutput("output",p.Vector2),this.registerOutput("x",p.Float),this.registerOutput("y",p.Float)}getClassName(){return"TwirlBlock"}get input(){return this._inputs[0]}get strength(){return this._inputs[1]}get center(){return this._inputs[2]}get offset(){return this._inputs[3]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(){if(!this.center.isConnected){const e=new ge("center");e.value=new X(.5,.5),e.output.connectTo(this.center)}if(!this.strength.isConnected){const e=new ge("strength");e.value=1,e.output.connectTo(this.strength)}if(!this.offset.isConnected){const e=new ge("offset");e.value=new X(0,0),e.output.connectTo(this.offset)}}_buildBlock(e){super._buildBlock(e);const t=e._getFreeVariableName("delta"),i=e._getFreeVariableName("angle"),r=e._getFreeVariableName("x"),n=e._getFreeVariableName("y"),a=e._getFreeVariableName("result");return e.compilationString+=`        
            ${e._declareLocalVar(t,p.Vector2)} = ${this.input.associatedVariableName} - ${this.center.associatedVariableName};
            ${e._declareLocalVar(i,p.Float)} = ${this.strength.associatedVariableName} * length(${t});
            ${e._declareLocalVar(r,p.Float)} = cos(${i}) * ${t}.x - sin(${i}) * ${t}.y;
            ${e._declareLocalVar(n,p.Float)} = sin(${i}) * ${t}.x + cos(${i}) * ${t}.y;
            ${e._declareLocalVar(a,p.Vector2)} = vec2(${r} + ${this.center.associatedVariableName}.x + ${this.offset.associatedVariableName}.x, ${n} + ${this.center.associatedVariableName}.y + ${this.offset.associatedVariableName}.y);
        `,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${a};
`),this.x.hasEndpoints&&(e.compilationString+=e._declareOutput(this.x)+` = ${a}.x;
`),this.y.hasEndpoints&&(e.compilationString+=e._declareOutput(this.y)+` = ${a}.y;
`),this}}y("BABYLON.TwirlBlock",fz);class yh extends ie{constructor(e){super(e,P.Fragment),this.generateInWorldSpace=!1,this.automaticNormalizationNormal=!0,this.automaticNormalizationTangent=!0,this.registerInput("input",p.Float),this.registerInput("worldPosition",p.Vector3),this.registerInput("worldNormal",p.Vector3),this.registerInput("worldTangent",p.AutoDetect,!0),this.registerOutput("output",p.Vector4),this.registerOutput("xyz",p.Vector3),this._inputs[3].addExcludedConnectionPointFromAllowedTypes(p.Color3|p.Vector3|p.Vector4)}getClassName(){return"HeightToNormalBlock"}get input(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get worldTangent(){return this._inputs[3]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=e.shaderLanguage===1,r=e.fSuffix;!this.generateInWorldSpace&&!this.worldTangent.isConnected&&e.sharedData.raiseBuildError(`You must connect the 'worldTangent' input of the ${this.name} block!`);const n=this.generateInWorldSpace?"":`
            vec3 biTangent = cross(norm, tgt);
            mat3 TBN = mat3(tgt, biTangent, norm);
            `,a=this.generateInWorldSpace?"":`
            result = TBN * result;
            result = result * vec3(0.5) + vec3(0.5);
            `;let o=`
            vec4 heightToNormal(float height, vec3 position, vec3 tangent, vec3 normal) {
                vec3 tgt = ${this.automaticNormalizationTangent?"normalize(tangent);":"tangent;"}
                vec3 norm = ${this.automaticNormalizationNormal?"normalize(normal);":"normal;"}
                ${n}
                vec3 worlddX = dFdx(position);
                vec3 worlddY = dFdy(position);
                vec3 crossX = cross(norm, worlddX);
                vec3 crossY = cross(worlddY, norm);
                float d = abs(dot(crossY, worlddX));
                vec3 inToNormal = vec3(((((height + dFdx(height)) - height) * crossY) + (((height + dFdy(height)) - height) * crossX)) * sign(d));
                inToNormal.y *= -1.0;
                vec3 result = normalize((d * norm) - inToNormal);
                ${a}
                return vec4(result, 0.);
            }`;return i?o=e._babylonSLtoWGSL(o):e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitFunction("heightToNormal",o,"// heightToNormal"),e.compilationString+=e._declareOutput(t)+` = heightToNormal(${this.input.associatedVariableName}, ${this.worldPosition.associatedVariableName}, ${this.worldTangent.isConnected?this.worldTangent.associatedVariableName:`vec3${r}(0.)`}.xyz, ${this.worldNormal.associatedVariableName});
`,this.xyz.hasEndpoints&&(e.compilationString+=e._declareOutput(this.xyz)+` = ${this.output.associatedVariableName}.xyz;
`),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.generateInWorldSpace = ${this.generateInWorldSpace};
`,e+=`${this._codeVariableName}.automaticNormalizationNormal = ${this.automaticNormalizationNormal};
`,e+=`${this._codeVariableName}.automaticNormalizationTangent = ${this.automaticNormalizationTangent};
`,e}serialize(){const e=super.serialize();return e.generateInWorldSpace=this.generateInWorldSpace,e.automaticNormalizationNormal=this.automaticNormalizationNormal,e.automaticNormalizationTangent=this.automaticNormalizationTangent,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.generateInWorldSpace=e.generateInWorldSpace,this.automaticNormalizationNormal=e.automaticNormalizationNormal,this.automaticNormalizationTangent=e.automaticNormalizationTangent}}_([O("Generate in world space instead of tangent space",0,"PROPERTIES",{notifiers:{update:!0}})],yh.prototype,"generateInWorldSpace",void 0);_([O("Force normalization for the worldNormal input",0,"PROPERTIES",{notifiers:{update:!0}})],yh.prototype,"automaticNormalizationNormal",void 0);_([O("Force normalization for the worldTangent input",0,"PROPERTIES",{notifiers:{update:!0}})],yh.prototype,"automaticNormalizationTangent",void 0);y("BABYLON.HeightToNormalBlock",yh);class pz extends ie{constructor(e){super(e,P.Fragment,!0),this.registerInput("depth",p.Float,!0),this.registerInput("worldPos",p.Vector4,!0),this.registerInput("viewProjection",p.Matrix,!0)}getClassName(){return"FragDepthBlock"}get depth(){return this._inputs[0]}get worldPos(){return this._inputs[1]}get viewProjection(){return this._inputs[2]}_buildBlock(e){super._buildBlock(e);const t=e.shaderLanguage===0?"gl_FragDepth":"fragmentOutputs.fragDepth";return this.depth.isConnected?e.compilationString+=`${t} = ${this.depth.associatedVariableName};
`:this.worldPos.isConnected&&this.viewProjection.isConnected?e.compilationString+=`
                ${e._declareLocalVar("p",p.Vector4)} = ${this.viewProjection.associatedVariableName} * ${this.worldPos.associatedVariableName};
                ${e._declareLocalVar("v",p.Float)} = p.z / p.w;
                #ifndef IS_NDC_HALF_ZRANGE
                    v = v * 0.5 + 0.5;
                #endif
                ${t} = v;
    
            `:N.Warn("FragDepthBlock: either the depth input or both the worldPos and viewProjection inputs must be connected!"),this}}y("BABYLON.FragDepthBlock",pz);class mz extends ie{constructor(e){super(e,P.Fragment),this.registerInput("worldPosition",p.Vector4,!1),this.registerInput("viewProjection",p.Matrix,!1),this.registerInput("worldNormal",p.AutoDetect,!0),this.registerOutput("depth",p.Vector3),this.worldNormal.addExcludedConnectionPointFromAllowedTypes(p.Color3|p.Vector3|p.Vector4)}getClassName(){return"ShadowMapBlock"}initialize(e){e._excludeVariableName("vPositionWSM"),e._excludeVariableName("lightDataSM"),e._excludeVariableName("biasAndScaleSM"),e._excludeVariableName("depthValuesSM"),e._excludeVariableName("clipPos"),e._excludeVariableName("worldPos"),e._excludeVariableName("zSM"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,e===1?await Promise.all([U(()=>import("./shadowMap.vertex-ec63166c.js").then(t=>t.s),["assets/shadowMap.vertex-ec63166c.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/bakedVertexAnimation-f0d36139.js","assets/morphTargetsVertex-8153f830.js","assets/helperFunctions-60ac609f.js","assets/meshUboDeclaration-6df77899.js","assets/clipPlaneVertex-9e3b7044.js"]),U(()=>import("./packingFunctions-220d49df.js"),["assets/packingFunctions-220d49df.js","assets/main-e8601b72.js","assets/index-ad665221.css"]),U(()=>import("./shadowMap.fragment-53575f36.js").then(t=>t.s),["assets/shadowMap.fragment-53575f36.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/packingFunctions-220d49df.js","assets/clipPlaneFragment-4ee9d5d8.js"])]):await Promise.all([U(()=>import("./shadowMap.vertex-745324f3.js").then(t=>t.s),["assets/shadowMap.vertex-745324f3.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/meshUboDeclaration-ca609797.js"]),U(()=>import("./main-e8601b72.js").then(t=>t.dO),["assets/main-e8601b72.js","assets/index-ad665221.css"]),U(()=>import("./shadowMap.fragment-184b8421.js").then(t=>t.s),["assets/shadowMap.fragment-184b8421.js","assets/main-e8601b72.js","assets/index-ad665221.css"])]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}get worldPosition(){return this._inputs[0]}get viewProjection(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get depth(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`,i=e.shaderLanguage===1;e._emitUniformFromString("biasAndScaleSM",p.Vector3),e._emitUniformFromString("lightDataSM",p.Vector3),e._emitUniformFromString("depthValuesSM",p.Vector2),e._emitFunctionFromInclude("packingFunctions",t),e.compilationString+=`${e._declareLocalVar("worldPos",p.Vector4)} = ${this.worldPosition.associatedVariableName};
`,e.compilationString+=`${e._declareLocalVar("vPositionWSM",p.Vector3)};
`,e.compilationString+=`${e._declareLocalVar("vDepthMetricSM",p.Float)} = 0.0;
`,e.compilationString+=`${e._declareLocalVar("zSM",p.Float)};
`,this.worldNormal.isConnected&&(e.compilationString+=`${e._declareLocalVar("vNormalW",p.Vector3)} = ${this.worldNormal.associatedVariableName}.xyz;
`,e.compilationString+=e._emitCodeFromInclude("shadowMapVertexNormalBias",t)),e.compilationString+=`${e._declareLocalVar("clipPos",p.Vector4)} = ${this.viewProjection.associatedVariableName} * worldPos;
`,e.compilationString+=e._emitCodeFromInclude("shadowMapVertexMetric",t,{replaceStrings:[{search:/gl_Position/g,replace:"clipPos"},{search:/vertexOutputs.position/g,replace:"clipPos"},{search:/vertexOutputs\.vDepthMetricSM/g,replace:"vDepthMetricSM"}]}),e.compilationString+=e._emitCodeFromInclude("shadowMapFragment",t,{replaceStrings:[{search:/return;/g,replace:""},{search:/fragmentInputs\.vDepthMetricSM/g,replace:"vDepthMetricSM"}]});const r=i?"fragmentOutputs.fragDepth":"gl_FragDepth";return e.compilationString+=`
            #if SM_DEPTHTEXTURE == 1
                #ifdef IS_NDC_HALF_ZRANGE
                    ${r} = (clipPos.z / clipPos.w);
                #else
                    ${r} = (clipPos.z / clipPos.w) * 0.5 + 0.5;
                #endif
            #endif
        `,e.compilationString+=`${e._declareOutput(this.depth)} = vec3${e.fSuffix}(depthSM, 1., 1.);
`,this}}y("BABYLON.ShadowMapBlock",mz);class _z extends ie{constructor(e){super(e,P.Fragment,!0),this.registerInput("viewDepth",p.Float,!0),this.registerInput("screenDepth",p.Float,!0),this.registerInput("worldPosition",p.AutoDetect,!0),this.registerInput("localPosition",p.AutoDetect,!0),this.registerInput("viewNormal",p.AutoDetect,!0),this.registerInput("worldNormal",p.AutoDetect,!0),this.registerInput("reflectivity",p.AutoDetect,!0),this.registerInput("velocity",p.AutoDetect,!0),this.registerInput("velocityLinear",p.AutoDetect,!0),this.inputs[2].addExcludedConnectionPointFromAllowedTypes(p.Vector3|p.Vector4),this.inputs[3].addExcludedConnectionPointFromAllowedTypes(p.Vector3|p.Vector4),this.inputs[4].addExcludedConnectionPointFromAllowedTypes(p.Vector3|p.Vector4),this.inputs[5].addExcludedConnectionPointFromAllowedTypes(p.Vector3|p.Vector4),this.inputs[6].addExcludedConnectionPointFromAllowedTypes(p.Vector3|p.Vector4|p.Color3|p.Color4),this.inputs[7].addExcludedConnectionPointFromAllowedTypes(p.Vector3|p.Vector4),this.inputs[8].addExcludedConnectionPointFromAllowedTypes(p.Vector3|p.Vector4)}getClassName(){return"PrePassOutputBlock"}get viewDepth(){return this._inputs[0]}get screenDepth(){return this._inputs[1]}get worldPosition(){return this._inputs[2]}get localPosition(){return this._inputs[3]}get viewNormal(){return this._inputs[4]}get worldNormal(){return this._inputs[5]}get reflectivity(){return this._inputs[6]}get velocity(){return this._inputs[7]}get velocityLinear(){return this._inputs[8]}_getFragData(e,t){return e?`fragmentOutputs.fragData${t}`:`gl_FragData[${t}]`}_buildBlock(e){super._buildBlock(e);const t=this.worldPosition,i=this.localPosition,r=this.viewNormal,n=this.worldNormal,a=this.viewDepth,o=this.reflectivity,l=this.screenDepth,c=this.velocity,u=this.velocityLinear;e.sharedData.blocksWithDefines.push(this);const h=`//${this.name}`,d=e._getShaderType(p.Vector4),f=e.shaderLanguage===1;return e._emitFunctionFromInclude("helperFunctions",h),e.compilationString+=`#if defined(PREPASS)\r
`,e.compilationString+=f?`var fragData: array<vec4<f32>, SCENE_MRT_COUNT>;\r
`:`vec4 fragData[SCENE_MRT_COUNT];\r
`,e.compilationString+=`#ifdef PREPASS_DEPTH\r
`,a.connectedPoint?e.compilationString+=` fragData[PREPASS_DEPTH_INDEX] = ${d}(${a.associatedVariableName}, 0.0, 0.0, 1.0);\r
`:e.compilationString+=` fragData[PREPASS_DEPTH_INDEX] = ${d}(0.0, 0.0, 0.0, 0.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef PREPASS_SCREENSPACE_DEPTH\r
`,l.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX] = vec4(${l.associatedVariableName}, 0.0, 0.0, 1.0);\r
`:e.compilationString+=` gl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef PREPASS_POSITION\r
`,t.connectedPoint?e.compilationString+=`fragData[PREPASS_POSITION_INDEX] = ${d}(${t.associatedVariableName}.rgb, ${t.connectedPoint.type===p.Vector4?t.associatedVariableName+".a":"1.0"});\r
`:e.compilationString+=` fragData[PREPASS_POSITION_INDEX] = ${d}(0.0, 0.0, 0.0, 0.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef PREPASS_LOCAL_POSITION\r
`,i.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_LOCAL_POSITION_INDEX] = vec4(${i.associatedVariableName}.rgb, ${i.connectedPoint.type===p.Vector4?i.associatedVariableName+".a":"1.0"});\r
`:e.compilationString+=` gl_FragData[PREPASS_LOCAL_POSITION_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef PREPASS_NORMAL\r
`,r.connectedPoint?e.compilationString+=` fragData[PREPASS_NORMAL_INDEX] = ${d}(${r.associatedVariableName}.rgb, ${r.connectedPoint.type===p.Vector4?r.associatedVariableName+".a":"1.0"});\r
`:e.compilationString+=` fragData[PREPASS_NORMAL_INDEX] = ${d}(0.0, 0.0, 0.0, 0.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef PREPASS_WORLD_NORMAL\r
`,n.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_WORLD_NORMAL_INDEX] = vec4(${n.associatedVariableName}.rgb, ${n.connectedPoint.type===p.Vector4?n.associatedVariableName+".a":"1.0"});\r
`:e.compilationString+=` gl_FragData[PREPASS_WORLD_NORMAL_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef PREPASS_REFLECTIVITY\r
`,o.connectedPoint?e.compilationString+=` fragData[PREPASS_REFLECTIVITY_INDEX] = ${d}(${o.associatedVariableName}.rgb, ${o.connectedPoint.type===p.Vector4?o.associatedVariableName+".a":"1.0"});\r
`:e.compilationString+=` fragData[PREPASS_REFLECTIVITY_INDEX] = ${d}(0.0, 0.0, 0.0, 1.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef PREPASS_VELOCITY\r
`,c.connectedPoint?e.compilationString+=` fragData[PREPASS_VELOCITY_INDEX] = ${d}(${c.associatedVariableName}.rgb, ${c.connectedPoint.type===p.Vector4?c.associatedVariableName+".a":"1.0"});\r
`:e.compilationString+=` fragData[PREPASS_VELOCITY_INDEX] = ${d}(0.0, 0.0, 0.0, 1.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef PREPASS_VELOCITY_LINEAR\r
`,u.connectedPoint?e.compilationString+=` fragData[PREPASS_VELOCITY_LINEAR_INDEX] = ${d}(${u.associatedVariableName}.rgb, ${u.connectedPoint.type===p.Vector4?u.associatedVariableName+".a":"1.0"});\r
`:e.compilationString+=` fragData[PREPASS_VELOCITY_LINEAR_INDEX] = ${d}(0.0, 0.0, 0.0, 1.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#if SCENE_MRT_COUNT > 1\r
`,e.compilationString+=`${this._getFragData(f,1)} = fragData[1];\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#if SCENE_MRT_COUNT > 2\r
`,e.compilationString+=`${this._getFragData(f,2)} = fragData[2];\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#if SCENE_MRT_COUNT > 3\r
`,e.compilationString+=`${this._getFragData(f,3)} = fragData[3];\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#if SCENE_MRT_COUNT > 4\r
`,e.compilationString+=`${this._getFragData(f,4)} = fragData[4];\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#if SCENE_MRT_COUNT > 5\r
`,e.compilationString+=`${this._getFragData(f,5)} = fragData[5];\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#if SCENE_MRT_COUNT > 6\r
`,e.compilationString+=`${this._getFragData(f,6)} = fragData[6];\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#if SCENE_MRT_COUNT > 7\r
`,e.compilationString+=`${this._getFragData(f,7)} = fragData[7];\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#endif\r
`,this}}y("BABYLON.PrePassOutputBlock",_z);class Ih extends ie{constructor(e){super(e,P.Fragment),this.radius=1e-4,this.area=.0075,this.fallOff=1e-6,this.registerInput("source",p.Object,!0,P.VertexAndFragment,new at("source",this,0,Bi,"ImageSourceBlock")),this.registerInput("screenSize",p.Vector2),this.registerOutput("occlusion",p.Float)}getClassName(){return"AmbientOcclusionBlock"}get source(){return this._inputs[0]}get screenSize(){return this._inputs[1]}get occlusion(){return this._outputs[0]}bind(e){this._randomTexture||this._createRandomTexture(e.getEngine()),e.setTexture(this._randomSamplerName,this._randomTexture)}_createRandomTexture(e){const i=new Uint8Array(1048576);for(let n=0;n<i.length;)i[n++]=Math.floor(Math.max(0,It(-1,1))*255),i[n++]=Math.floor(Math.max(0,It(-1,1))*255),i[n++]=Math.floor(Math.max(0,It(-1,1))*255),i[n++]=255;const r=gi.CreateRGBATexture(i,512,512,e,!1,!1,2);r.name="SSAORandomTexture",r.wrapU=$.WRAP_ADDRESSMODE,r.wrapV=$.WRAP_ADDRESSMODE,this._randomTexture=r}_buildBlock(e){if(super._buildBlock(e),!this.source.connectedPoint)return this;e.sharedData.bindableBlocks.push(this);const t=this.source.connectedPoint.ownerBlock,i=this._outputs[0],r=this.screenSize;let n;return e.shaderLanguage===1?n=`fn normalFromDepth(depth: f32, coords: vec2f, radius: f32) -> vec3f {
                let offset1: vec2f = vec2f(0.0, radius);
                let offset2: vec2f = vec2f(radius, 0.0);

                let depth1: f32 = textureSampleLevel(${t.samplerName}, ${t.samplerName}Sampler, coords + offset1, 0.0).r;
                let depth2: f32 = textureSampleLevel(${t.samplerName}, ${t.samplerName}Sampler, coords + offset2, 0.0).r;

                let p1: vec3f = vec3f(offset1, depth1 - depth);
                let p2: vec3f = vec3f(offset2, depth2 - depth);

                var normal: vec3f = cross(p1, p2);
                normal.z = -normal.z;

                return normalize(normal);
            }
            `:n=`vec3 normalFromDepth(float depth, vec2 coords, float radius) {
                vec2 offset1 = vec2(0.0, radius);
                vec2 offset2 = vec2(radius, 0.0);

                float depth1 = textureLod(${t.samplerName}, coords + offset1, 0.0).r;
                float depth2 = textureLod(${t.samplerName}, coords + offset2, 0.0).r;

                vec3 p1 = vec3(offset1, depth1 - depth);
                vec3 p2 = vec3(offset2, depth2 - depth);

                vec3 normal = cross(p1, p2);
                normal.z = -normal.z;

                return normalize(normal);
            }
            `,e._emitFunction("normalFromDepth",n,"// normalFromDepth function"),this._randomSamplerName=e._getFreeVariableName("randomSampler"),e._emit2DSampler(this._randomSamplerName),e.shaderLanguage===1?n=`
            const sampleSphere: array<vec3f, 16> = array<vec3f, 16>(
                vec3f( 0.5381,  0.1856, -0.4319),
                vec3f( 0.1379,  0.2486,  0.4430),
                vec3f( 0.3371,  0.5679, -0.0057),
                vec3f(-0.6999, -0.0451, -0.0019),
                vec3f( 0.0689, -0.1598, -0.8547),
                vec3f( 0.0560,  0.0069, -0.1843),
                vec3f(-0.0146,  0.1402,  0.0762),
                vec3f( 0.0100, -0.1924, -0.0344),
                vec3f(-0.3577, -0.5301, -0.4358),
                vec3f(-0.3169,  0.1063,  0.0158),
                vec3f( 0.0103, -0.5869,  0.0046),
                vec3f(-0.0897, -0.4940,  0.3287),
                vec3f( 0.7119, -0.0154, -0.0918),
                vec3f(-0.0533,  0.0596, -0.5411),
                vec3f( 0.0352, -0.0631,  0.5460),
                vec3f(-0.4776,  0.2847, -0.0271)
            );

            fn computeOcclusion(screenSize: vec2f) -> f32 {
                let uv: vec2f = fragmentInputs.position.xy / screenSize;
                let random: vec3f = normalize(textureSampleLevel(${this._randomSamplerName}, ${this._randomSamplerName}Sampler, uv * 4.0, 0.0).rgb);
                let depth: f32 = textureSampleLevel(${t.samplerName}, ${t.samplerName}Sampler, uv, 0.0).r;
                let position: vec3f = vec3f(uv, depth);
                let normal: vec3f = normalFromDepth(depth, uv, ${this.radius}f);

                let radiusDepth: f32 = ${this.radius}f / depth;
                var occlusion: f32 = 0.0;

                var ray: vec3f;
                var hemiRay: vec3f;
                var occlusionDepth: f32;
                var difference: f32;

                for (var i: i32 = 0; i < 16; i++)
                {
                    ray = radiusDepth * reflect(sampleSphere[i], random);
                    hemiRay = position + sign(dot(ray, normal)) * ray;

                    occlusionDepth = textureSample(${t.samplerName}, ${t.samplerName}Sampler, clamp(hemiRay.xy, vec2f(0.001, 0.001), vec2f(0.999, 0.999))).r;
                    difference = depth - occlusionDepth;

                    occlusion += step(${this.fallOff}f, difference) * (1.0 - smoothstep(${this.fallOff}f, ${this.area}f, difference));
                }

                return clamp(1.0 - occlusion / 16.0, 0.0, 1.0);
            }
            `:n=`
            const vec3 sampleSphere[16] = vec3[](
                vec3( 0.5381,  0.1856, -0.4319),
                vec3( 0.1379,  0.2486,  0.4430),
                vec3( 0.3371,  0.5679, -0.0057),
                vec3(-0.6999, -0.0451, -0.0019),
                vec3( 0.0689, -0.1598, -0.8547),
                vec3( 0.0560,  0.0069, -0.1843),
                vec3(-0.0146,  0.1402,  0.0762),
                vec3( 0.0100, -0.1924, -0.0344),
                vec3(-0.3577, -0.5301, -0.4358),
                vec3(-0.3169,  0.1063,  0.0158),
                vec3( 0.0103, -0.5869,  0.0046),
                vec3(-0.0897, -0.4940,  0.3287),
                vec3( 0.7119, -0.0154, -0.0918),
                vec3(-0.0533,  0.0596, -0.5411),
                vec3( 0.0352, -0.0631,  0.5460),
                vec3(-0.4776,  0.2847, -0.0271)
            );

            float computeOcclusion(vec2 screenSize) {
                vec2 uv = gl_FragCoord.xy / screenSize;
                vec3 random = normalize(textureLod(${this._randomSamplerName}, uv * 4., 0.0).rgb);
                float depth = textureLod(${t.samplerName}, uv, 0.0).r;              
                vec3 position = vec3(uv, depth);
                vec3 normal = normalFromDepth(depth, uv, ${this.radius} );

                float radiusDepth = ${this.radius} / depth;
                float occlusion = 0.0;

                vec3 ray;
                vec3 hemiRay;
                float occlusionDepth;
                float difference;

                for (int i = 0; i < 16; i++)
                {
                    ray = radiusDepth * reflect(sampleSphere[i], random);
                    hemiRay = position + sign(dot(ray, normal)) * ray;

                    occlusionDepth = texture2D(${t.samplerName}, clamp(hemiRay.xy, vec2(0.001, 0.001), vec2(0.999, 0.999))).r;
                    difference = depth - occlusionDepth;

                    occlusion += step(${this.fallOff}, difference) * (1.0 - smoothstep(${this.fallOff}, ${this.area}, difference));
                }

                return clamp(1.0 - occlusion / 16.0, 0.0, 1.0);
            }
            `,e._emitFunction("computeOcclusion",n,"// computeOcclusion function"),e.compilationString+=e._declareOutput(i)+` = computeOcclusion(${r.associatedVariableName});`,this}dispose(){this._randomTexture&&(this._randomTexture.dispose(),this._randomTexture=null),super.dispose()}}_([O("radius",1,"ADVANCED",{min:1e-4})],Ih.prototype,"radius",void 0);_([O("area",1,"ADVANCED",{min:0})],Ih.prototype,"area",void 0);_([O("fallOff",1,"ADVANCED",{min:0})],Ih.prototype,"fallOff",void 0);y("BABYLON.AmbientOcclusionBlock",Ih);class gz extends ie{constructor(e){super(e,P.VertexAndFragment,!1),this.registerInput("worldPosition",p.Vector4,!1,P.Vertex),this.registerInput("view",p.Matrix,!1,P.Vertex),this.registerInput("input",p.AutoDetect,!1,P.Fragment),this.registerInput("fogColor",p.AutoDetect,!1,P.Fragment),this.registerOutput("output",p.Color3,P.Fragment),this.input.addExcludedConnectionPointFromAllowedTypes(p.Color3|p.Vector3|p.Color4),this.fogColor.addExcludedConnectionPointFromAllowedTypes(p.Color3|p.Vector3|p.Color4)}getClassName(){return"FogBlock"}get worldPosition(){return this._inputs[0]}get view(){return this._inputs[1]}get input(){return this._inputs[2]}get fogColor(){return this._inputs[3]}get output(){return this._outputs[0]}initialize(e){this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,e===1?await U(()=>import("./fogFragmentDeclaration-ab16d80d.js"),["assets/fogFragmentDeclaration-ab16d80d.js","assets/main-e8601b72.js","assets/index-ad665221.css"]):await U(()=>import("./main-e8601b72.js").then(t=>t.d$),["assets/main-e8601b72.js","assets/index-ad665221.css"]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}autoConfigure(e,t=()=>!0){if(!this.view.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===ve.View&&t(r));i||(i=new ge("view"),i.setAsSystemValue(ve.View)),i.output.connectTo(this.view)}if(!this.fogColor.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===ve.FogColor&&t(r));i||(i=new ge("fogColor",void 0,p.Color3),i.setAsSystemValue(ve.FogColor)),i.output.connectTo(this.fogColor)}}prepareDefines(e,t,i){if(!i)return;const r=i.getScene();e.setValue("FOG",t.fogEnabled&&kD(i,r))}bind(e,t,i){if(!i)return;const r=i.getScene();e.setFloat4(this._fogParameters,r.fogMode,r.fogStart,r.fogEnd,r.fogDensity)}_buildBlock(e){if(super._buildBlock(e),e.target===P.Fragment){e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);let t=[],i="",r="";e.shaderLanguage===1?(t=[{search:/fn CalcFogFactor\(\)/,replace:"fn CalcFogFactor(vFogDistance: vec3f, vFogInfos: vec4f)"},{search:/uniforms.vFogInfos/g,replace:"vFogInfos"},{search:/fragmentInputs.vFogDistance/g,replace:"vFogDistance"}],i="fragmentInputs.",r="uniforms."):t=[{search:/float CalcFogFactor\(\)/,replace:"float CalcFogFactor(vec3 vFogDistance, vec4 vFogInfos)"}],e._emitFunctionFromInclude("fogFragmentDeclaration",`//${this.name}`,{removeUniforms:!0,removeVaryings:!0,removeIfDef:!1,replaceStrings:t});const n=e._getFreeVariableName("fog"),a=this.input,o=this.fogColor;this._fogParameters=e._getFreeVariableName("fogParameters");const l=this._outputs[0];e._emitUniformFromString(this._fogParameters,p.Vector4),e.compilationString+=`#ifdef FOG
`,e.compilationString+=`${e._declareLocalVar(n,p.Float)} = CalcFogFactor(${i}${this._fogDistanceName}, ${r}${this._fogParameters});
`,e.compilationString+=e._declareOutput(l)+` = ${n} * ${a.associatedVariableName}.rgb + (1.0 - ${n}) * ${o.associatedVariableName}.rgb;
`,e.compilationString+=`#else
${e._declareOutput(l)} =  ${a.associatedVariableName}.rgb;
`,e.compilationString+=`#endif
`}else{const t=this.worldPosition,i=this.view;this._fogDistanceName=e._getFreeVariableName("vFogDistance"),e._emitVaryingFromString(this._fogDistanceName,p.Vector3);const r=e.shaderLanguage===1?"vertexOutputs.":"";e.compilationString+=`${r}${this._fogDistanceName} = (${i.associatedVariableName} * ${t.associatedVariableName}).xyz;
`}return this}}y("BABYLON.FogBlock",gz);class _f extends ie{static _OnGenerateOnlyFragmentCodeChanged(e,t){const i=e;return i.worldPosition.isConnected?(i.generateOnlyFragmentCode=!i.generateOnlyFragmentCode,N.Error("The worldPosition input must not be connected to be able to switch!"),!1):(i._setTarget(),!0)}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?P.Fragment:P.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?P.Fragment:P.Vertex}constructor(e){super(e,P.VertexAndFragment),this._lightId=0,this.generateOnlyFragmentCode=!1,this._isUnique=!0,this.registerInput("worldPosition",p.Vector4,!1,P.Vertex),this.registerInput("worldNormal",p.Vector4,!1,P.Fragment),this.registerInput("cameraPosition",p.Vector3,!1,P.Fragment),this.registerInput("glossiness",p.Float,!0,P.Fragment),this.registerInput("glossPower",p.Float,!0,P.Fragment),this.registerInput("diffuseColor",p.Color3,!0,P.Fragment),this.registerInput("specularColor",p.Color3,!0,P.Fragment),this.registerInput("view",p.Matrix,!0),this.registerOutput("diffuseOutput",p.Color3,P.Fragment),this.registerOutput("specularOutput",p.Color3,P.Fragment),this.registerOutput("shadow",p.Float,P.Fragment)}getClassName(){return"LightBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get cameraPosition(){return this._inputs[2]}get glossiness(){return this._inputs[3]}get glossPower(){return this._inputs[4]}get diffuseColor(){return this._inputs[5]}get specularColor(){return this._inputs[6]}get view(){return this._inputs[7]}get diffuseOutput(){return this._outputs[0]}get specularOutput(){return this._outputs[1]}get shadow(){return this._outputs[2]}initialize(e){this._initShaderSourceAsync(e.shaderLanguage),e._excludeVariableName("vViewDepth")}async _initShaderSourceAsync(e){this._codeIsReady=!1,e===1?await Promise.all([U(()=>import("./default.fragment-d4022e5c.js").then(t=>t.e),["assets/default.fragment-d4022e5c.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/mainUVVaryingDeclaration-d7d129d5.js","assets/meshUboDeclaration-6df77899.js","assets/helperFunctions-60ac609f.js","assets/logDepthFragment-1fbe4860.js","assets/clipPlaneFragment-4ee9d5d8.js","assets/logDepthDeclaration-2a2324b6.js","assets/fogFragmentDeclaration-ab16d80d.js"]),U(()=>import("./default.fragment-d4022e5c.js").then(t=>t.l),["assets/default.fragment-d4022e5c.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/mainUVVaryingDeclaration-d7d129d5.js","assets/meshUboDeclaration-6df77899.js","assets/helperFunctions-60ac609f.js","assets/logDepthFragment-1fbe4860.js","assets/clipPlaneFragment-4ee9d5d8.js","assets/logDepthDeclaration-2a2324b6.js","assets/fogFragmentDeclaration-ab16d80d.js"]),U(()=>import("./default.vertex-dd4788e9.js").then(t=>t.l),["assets/default.vertex-dd4788e9.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/mainUVVaryingDeclaration-d7d129d5.js","assets/meshUboDeclaration-6df77899.js","assets/helperFunctions-60ac609f.js","assets/bakedVertexAnimation-f0d36139.js","assets/instancesDeclaration-9dea1578.js","assets/clipPlaneVertex-9e3b7044.js","assets/fogVertex-63846594.js","assets/morphTargetsVertex-8153f830.js","assets/logDepthDeclaration-2a2324b6.js","assets/vertexColorMixing-e6b7420e.js","assets/logDepthVertex-50f013a0.js"]),U(()=>import("./helperFunctions-60ac609f.js"),["assets/helperFunctions-60ac609f.js","assets/main-e8601b72.js","assets/index-ad665221.css"]),U(()=>import("./default.fragment-d4022e5c.js").then(t=>t.a),["assets/default.fragment-d4022e5c.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/mainUVVaryingDeclaration-d7d129d5.js","assets/meshUboDeclaration-6df77899.js","assets/helperFunctions-60ac609f.js","assets/logDepthFragment-1fbe4860.js","assets/clipPlaneFragment-4ee9d5d8.js","assets/logDepthDeclaration-2a2324b6.js","assets/fogFragmentDeclaration-ab16d80d.js"]),U(()=>import("./default.fragment-d4022e5c.js").then(t=>t.s),["assets/default.fragment-d4022e5c.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/mainUVVaryingDeclaration-d7d129d5.js","assets/meshUboDeclaration-6df77899.js","assets/helperFunctions-60ac609f.js","assets/logDepthFragment-1fbe4860.js","assets/clipPlaneFragment-4ee9d5d8.js","assets/logDepthDeclaration-2a2324b6.js","assets/fogFragmentDeclaration-ab16d80d.js"]),U(()=>import("./default.vertex-dd4788e9.js").then(t=>t.s),["assets/default.vertex-dd4788e9.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/mainUVVaryingDeclaration-d7d129d5.js","assets/meshUboDeclaration-6df77899.js","assets/helperFunctions-60ac609f.js","assets/bakedVertexAnimation-f0d36139.js","assets/instancesDeclaration-9dea1578.js","assets/clipPlaneVertex-9e3b7044.js","assets/fogVertex-63846594.js","assets/morphTargetsVertex-8153f830.js","assets/logDepthDeclaration-2a2324b6.js","assets/vertexColorMixing-e6b7420e.js","assets/logDepthVertex-50f013a0.js"])]):await Promise.all([U(()=>import("./default.fragment-24488752.js").then(t=>t.l),["assets/default.fragment-24488752.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/mainUVVaryingDeclaration-91e38cff.js","assets/meshUboDeclaration-ca609797.js"]),U(()=>import("./default.fragment-24488752.js").then(t=>t.f),["assets/default.fragment-24488752.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/mainUVVaryingDeclaration-91e38cff.js","assets/meshUboDeclaration-ca609797.js"]),U(()=>import("./default.fragment-24488752.js").then(t=>t.a),["assets/default.fragment-24488752.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/mainUVVaryingDeclaration-91e38cff.js","assets/meshUboDeclaration-ca609797.js"]),U(()=>import("./default.vertex-5283776d.js").then(t=>t.a),["assets/default.vertex-5283776d.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/mainUVVaryingDeclaration-91e38cff.js","assets/meshUboDeclaration-ca609797.js","assets/vertexColorMixing-471c72c7.js"]),U(()=>import("./default.vertex-5283776d.js").then(t=>t.l),["assets/default.vertex-5283776d.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/mainUVVaryingDeclaration-91e38cff.js","assets/meshUboDeclaration-ca609797.js","assets/vertexColorMixing-471c72c7.js"]),U(()=>import("./main-e8601b72.js").then(t=>t.dZ),["assets/main-e8601b72.js","assets/index-ad665221.css"]),U(()=>import("./default.fragment-24488752.js").then(t=>t.b),["assets/default.fragment-24488752.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/mainUVVaryingDeclaration-91e38cff.js","assets/meshUboDeclaration-ca609797.js"]),U(()=>import("./default.fragment-24488752.js").then(t=>t.s),["assets/default.fragment-24488752.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/mainUVVaryingDeclaration-91e38cff.js","assets/meshUboDeclaration-ca609797.js"]),U(()=>import("./default.vertex-5283776d.js").then(t=>t.s),["assets/default.vertex-5283776d.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/mainUVVaryingDeclaration-91e38cff.js","assets/meshUboDeclaration-ca609797.js","assets/vertexColorMixing-471c72c7.js"])]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}autoConfigure(e,t=()=>!0){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===ve.CameraPosition&&t(r));i||(i=new ge("cameraPosition"),i.setAsSystemValue(ve.CameraPosition)),i.output.connectTo(this.cameraPosition)}}prepareDefines(e,t,i){if(!i||!e._areLightsDirty)return;const r=i.getScene();if(!this.light)jl(r,i,e,!0,t.maxSimultaneousLights);else{const n={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};gI(r,i,this.light,this._lightId,e,!0,n),n.needRebuild&&e.rebuild()}}updateUniformsAndSamples(e,t,i,r){e.samplers.push("areaLightsLTC1Sampler"),e.samplers.push("areaLightsLTC2Sampler");for(let n=0;n<t.maxSimultaneousLights&&i["LIGHT"+n];n++){const a=e.uniforms.indexOf("vLightData"+n)>=0;SI(n,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+n],r,a,i["IESLIGHTTEXTURE"+n],i["CLUSTLIGHT"+n])}}bind(e,t,i){if(!i)return;const r=i.getScene();this.light?vI(this.light,this._lightId,r,e,!0):ql(r,i,e,!0,t.maxSimultaneousLights)}_injectVertexCode(e){const t=this.worldPosition,i=`//${this.name}`;this.light?(this._lightId=(e.counters.lightCounter!==void 0?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));const r="v_"+t.associatedVariableName;e._emitVaryingFromString(r,p.Vector4)&&(e.compilationString+=(e.shaderLanguage===1?"vertexOutputs.":"")+`${r} = ${t.associatedVariableName};
`),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:t.associatedVariableName}]}):(e.compilationString+=`${e._declareLocalVar("worldPos",p.Vector4)} = ${t.associatedVariableName};
`,this.view.isConnected&&(e.compilationString+=`${e._declareLocalVar("view",p.Matrix)} = ${this.view.associatedVariableName};
`,e._emitVaryingFromString("vViewDepth",p.Float),e.compilationString+=(e.shaderLanguage===1?"vertexOutputs.":"")+`vViewDepth = (${this.view.associatedVariableName} * ${t.associatedVariableName}).z;
`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{repeatKey:"maxSimultaneousLights"}))}_injectUBODeclaration(e){const t=`//${this.name}`;this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0})}_buildBlock(e){super._buildBlock(e);const t=e.shaderLanguage===1,i=t?"f":"",r=`//${this.name}`;if(e.target!==P.Fragment){this._injectVertexCode(e);return}this.generateOnlyFragmentCode&&e.sharedData.dynamicUniformBlocks.push(this);const n=t?"fragmentInputs.":"";e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);const a=this.worldPosition;let o=a.associatedVariableName;this.generateOnlyFragmentCode?(o=e._getFreeVariableName("globalWorldPos"),e._emitFunction("light_globalworldpos",`${e._declareLocalVar(o,p.Vector3,!1,!0)};
`,r),e.compilationString+=`${o} = ${a.associatedVariableName}.xyz;
`,e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{repeatKey:"maxSimultaneousLights",substitutionVars:`worldPos,${a.associatedVariableName}`})):o=n+"v_"+o+".xyz",e._emitFunctionFromInclude("helperFunctions",r);let l={search:/vPositionW/g,replace:o};if(t&&(l={search:/fragmentInputs\.vPositionW/g,replace:o}),e._emitFunctionFromInclude("lightsFragmentFunctions",r,{replaceStrings:[l]}),e._emitFunctionFromInclude("shadowsFragmentFunctions",r,{replaceStrings:[l]}),this._injectUBODeclaration(e),this._lightId===0&&(e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`${e._declareLocalVar("viewDirectionW",p.Vector3)} = normalize(${this.cameraPosition.associatedVariableName} - ${o});
`),this.generateOnlyFragmentCode&&this.view.isConnected&&(e.compilationString+=`${e._declareLocalVar("vViewDepth",p.Float)} = (${this.view.associatedVariableName} * ${a.associatedVariableName}).z;
`),e.compilationString+=t?`var info: lightingInfo;
`:`lightingInfo info;
`,e.compilationString+=`${e._declareLocalVar("shadow",p.Float)} = 1.;
`,e.compilationString+=`${e._declareLocalVar("aggShadow",p.Float)} = 0.;
`,e.compilationString+=`${e._declareLocalVar("numLights",p.Float)} = 0.;
`,e.compilationString+=`${e._declareLocalVar("glossiness",p.Float)} = ${this.glossiness.isConnected?this.glossiness.associatedVariableName:"1.0"} * ${this.glossPower.isConnected?this.glossPower.associatedVariableName:"1024.0"};
`,e.compilationString+=`${e._declareLocalVar("diffuseBase",p.Vector3)} = vec3${i}(0., 0., 0.);
`,e.compilationString+=`${e._declareLocalVar("specularBase",p.Vector3)}  = vec3${i}(0., 0., 0.);
`,e.compilationString+=`${e._declareLocalVar("normalW",p.Vector3)} = ${this.worldNormal.associatedVariableName}.xyz;
`),this.light){let h=[{search:/vPositionW/g,replace:o+".xyz"}];t&&(h=[{search:/fragmentInputs\.vPositionW/g,replace:o+".xyz"},{search:/uniforms\.vReflectivityColor/g,replace:"vReflectivityColor"}]),e.compilationString+=e._emitCodeFromInclude("lightFragment",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},...h]})}else{let h=`vPositionW,${o}.xyz`;t&&(h=`fragmentInputs.vPositionW,${o}.xyz`,this.generateOnlyFragmentCode&&(h+=",fragmentInputs.vViewDepth,vViewDepth")),e.compilationString+=e._emitCodeFromInclude("lightFragment",r,{repeatKey:"maxSimultaneousLights",substitutionVars:h})}this._lightId===0&&(e.compilationString+=`aggShadow = aggShadow / numLights;
`);const c=this.diffuseOutput,u=this.specularOutput;return e.compilationString+=e._declareOutput(c)+` = diffuseBase${this.diffuseColor.isConnected?" * "+this.diffuseColor.associatedVariableName:""};
`,u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = specularBase${this.specularColor.isConnected?" * "+this.specularColor.associatedVariableName:""};
`),this.shadow.hasEndpoints&&(e.compilationString+=e._declareOutput(this.shadow)+` = aggShadow;
`),this}serialize(){const e=super.serialize();return e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.generateOnlyFragmentCode=e.generateOnlyFragmentCode,this._setTarget()}}_([O("Generate only fragment code",0,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:_f._OnGenerateOnlyFragmentCodeChanged}})],_f.prototype,"generateOnlyFragmentCode",void 0);y("BABYLON.LightBlock",_f);class uu extends ie{get texture(){var e;return this.source.isConnected?((e=this.source.connectedPoint)==null?void 0:e.ownerBlock).texture:this._texture}set texture(e){if(this._texture===e)return;const t=(e==null?void 0:e.getScene())??De.LastCreatedScene;!e&&t&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this._texture)),this._texture=e,e&&t&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(e))}static _IsPrePassTextureBlock(e){return(e==null?void 0:e.getClassName())==="PrePassTextureBlock"}get _isSourcePrePass(){return uu._IsPrePassTextureBlock(this._imageSource)}get samplerName(){if(this._imageSource){if(!uu._IsPrePassTextureBlock(this._imageSource))return this._imageSource.samplerName;if(this.source.connectedPoint)return this._imageSource.getSamplerName(this.source.connectedPoint)}return this._samplerName}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(e){if(e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)){const t=this.texture.getScene()??De.LastCreatedScene;t==null||t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this.texture))}}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){if(e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)){const t=this.texture.getScene()??De.LastCreatedScene;t==null||t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this.texture))}}get convertToLinearSpace(){return this._convertToLinearSpace}constructor(e,t=!1){super(e,t?P.Fragment:P.VertexAndFragment),this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this._fragmentOnly=t,this.registerInput("uv",p.AutoDetect,!1,P.VertexAndFragment),this.registerInput("source",p.Object,!0,P.VertexAndFragment,new at("source",this,0,Bi,"ImageSourceBlock")),this.registerInput("layer",p.Float,!0),this.registerInput("lod",p.Float,!0),this.registerOutput("rgba",p.Color4,P.Neutral),this.registerOutput("rgb",p.Color3,P.Neutral),this.registerOutput("r",p.Float,P.Neutral),this.registerOutput("g",p.Float,P.Neutral),this.registerOutput("b",p.Float,P.Neutral),this.registerOutput("a",p.Float,P.Neutral),this.registerOutput("level",p.Float,P.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(p.Vector2|p.Vector3|p.Vector4),this._inputs[0]._prioritizeVertex=!t}getClassName(){return"TextureBlock"}get uv(){return this._inputs[0]}get source(){return this._inputs[1]}get layer(){return this._inputs[2]}get lod(){return this._inputs[3]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}_isTiedToFragment(e){if(e.target===P.Fragment)return!0;if(e.target===P.Vertex)return!1;if(e.target===P.Neutral||e.target===P.VertexAndFragment){const t=e.ownerBlock;if(t.target===P.Fragment)return!0;for(const i of t.inputs)if(i.isConnected&&this._isTiedToFragment(i.connectedPoint))return!0}return!1}_getEffectiveTarget(){return this._fragmentOnly?P.Fragment:!this.uv.isConnected||this.uv.sourceBlock.isInput?P.VertexAndFragment:this._isTiedToFragment(this.uv.connectedPoint)?P.Fragment:P.VertexAndFragment}get target(){return this._getEffectiveTarget()}set target(e){}autoConfigure(e,t=()=>!0){if(!this.uv.isConnected){if(e.mode===mi.PostProcess){const i=e.getBlockByPredicate(r=>r.name==="uv"&&t(r));i&&i.connectTo(this)}else if(e.mode!==mi.ProceduralTexture){const i=e.mode===mi.Particle?"particle_uv":"uv";let r=e.getInputBlockByPredicate(n=>n.isAttribute&&n.name===i&&t(n));r||(r=new ge("uv"),r.setAsAttribute(i)),r.output.connectTo(this.uv)}}}initializeDefines(e){e._areTexturesDirty&&this._mainUVDefineName!==void 0&&e.setValue(this._mainUVDefineName,!1,!0)}prepareDefines(e){if(!e._areTexturesDirty)return;if(!this.texture||!this.texture.getTextureMatrix){this._isMixed&&(e.setValue(this._defineName,!1,!0),e.setValue(this._mainUVDefineName,!0,!0));return}const t=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,i=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;e.setValue(this._linearDefineName,t,!0),e.setValue(this._gammaDefineName,i,!0),this._isMixed&&(this.texture.getTextureMatrix().isIdentityAs3x2()?(e.setValue(this._defineName,!1,!0),e.setValue(this._mainUVDefineName,!0,!0)):(e.setValue(this._defineName,!0),e[this._mainUVDefineName]==null&&e.setValue(this._mainUVDefineName,!1,!0)))}isReady(){return this._isSourcePrePass?!0:!(this.texture&&!this.texture.isReadyOrNotBlocking())}bind(e){this._isSourcePrePass&&e.setFloat(this._textureInfoName,1),this.texture&&(this._isMixed&&(e.setFloat(this._textureInfoName,this.texture.level),e.setMatrix(this._textureTransformName,this.texture.getTextureMatrix())),this._imageSource||e.setTexture(this._samplerName,this.texture))}get _isMixed(){return this.target!==P.Fragment}_injectVertexCode(e){const t=this.uv;this._defineName=e._getFreeDefineName("UVTRANSFORM"),this._mainUVDefineName="VMAIN"+t.declarationVariableName.toUpperCase(),this._mainUVName="vMain"+t.declarationVariableName,this._transformedUVName=e._getFreeVariableName("transformedUV"),this._textureTransformName=e._getFreeVariableName("textureTransform"),this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=this._textureInfoName,e._emitVaryingFromString(this._transformedUVName,p.Vector2,this._defineName),e._emitVaryingFromString(this._mainUVName,p.Vector2,this._mainUVDefineName),e._emitUniformFromString(this._textureTransformName,p.Matrix,this._defineName);const i=e._getShaderType(p.Vector4),r=e._getShaderType(p.Vector2);e.compilationString+=`#ifdef ${this._defineName}
`,e.compilationString+=`${e._getVaryingName(this._transformedUVName)} = ${r}(${this._textureTransformName} * ${i}(${t.associatedVariableName}.xy, 1.0, 0.0));
`,e.compilationString+=`#elif defined(${this._mainUVDefineName})
`;let n="";if(e.shaderLanguage===1&&t.isConnectedToInputBlock&&t.associatedVariableName.indexOf("vertexInputs.")===-1&&(n="vertexInputs."),e.compilationString+=`${e._getVaryingName(this._mainUVName)} = ${n}${t.associatedVariableName}.xy;
`,e.compilationString+=`#endif
`,!!this._outputs.some(a=>a.isConnectedInVertexShader)){this._writeTextureRead(e,!0);for(const a of this._outputs)a.hasEndpoints&&a.name!=="level"&&this._writeOutput(e,a,a.name,!0)}}_getUVW(e){var n,a,o,l;let t=e;const i=((a=(n=this._texture)==null?void 0:n._texture)==null?void 0:a.is2DArray)??!1,r=((l=(o=this._texture)==null?void 0:o._texture)==null?void 0:l.is3D)??!1;if(i){const c=this.layer.isConnected?this.layer.associatedVariableName:"0";t=`vec3(${e}, ${c})`}else if(r){const c=this.layer.isConnected?this.layer.associatedVariableName:"0";t=`vec3(${e}, ${c})`}return t}_samplerFunc(e){return e.shaderLanguage===1?e.target===P.Vertex?"textureSampleLevel":"textureSample":this.lod.isConnected?"texture2DLodEXT":"texture2D"}get _samplerLodSuffix(){return this.lod.isConnected?`, ${this.lod.associatedVariableName}`:""}_generateTextureSample(e,t){if(t.shaderLanguage===1){const i=t.target===P.Vertex;return`${this._samplerFunc(t)}(${this.samplerName},${this.samplerName+"Sampler"}, ${this._getUVW(e)}${this._samplerLodSuffix}${i?", 0":""})`}return`${this._samplerFunc(t)}(${this.samplerName}, ${this._getUVW(e)}${this._samplerLodSuffix})`}_generateTextureLookup(e){e.compilationString+=`#ifdef ${this._defineName}
`,e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,p.Vector4)} = ${this._generateTextureSample(e._getVaryingName(this._transformedUVName),e)};
`,e.compilationString+=`#elif defined(${this._mainUVDefineName})
`,e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,p.Vector4)} = ${this._generateTextureSample(this._mainUVName?e._getVaryingName(this._mainUVName):this.uv.associatedVariableName,e)}${this._samplerLodSuffix};
`,e.compilationString+=`#endif
`}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===P.Fragment)return;this._generateTextureLookup(e);return}if(this.uv.ownerBlock.target===P.Fragment){e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,p.Vector4)} = ${this._generateTextureSample(i.associatedVariableName,e)}${this._samplerLodSuffix};
`;return}this._generateTextureLookup(e)}_generateConversionCode(e,t,i){i!=="a"&&((!this.texture||!this.texture.gammaSpace)&&(e.compilationString+=`#ifdef ${this._linearDefineName}
                    ${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});
                    #endif
                `),e.compilationString+=`#ifdef ${this._gammaDefineName}
                ${t.associatedVariableName} = ${e._toLinearSpace(t)};
                #endif
            `)}_writeOutput(e,t,i,r=!1){if(r){if(e.target===P.Fragment)return;e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`,this._generateConversionCode(e,t,i);return}if(this.uv.ownerBlock.target===P.Fragment){e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`,this._generateConversionCode(e,t,i);return}let n="";this.disableLevelMultiplication||(n=` * ${(e.shaderLanguage===1?"uniforms.":"")+this._textureInfoName}`),e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i}${n};
`,this._generateConversionCode(e,t,i)}_buildBlock(e){var i,r,n,a;if(super._buildBlock(e),this.source.isConnected?this._imageSource=this.source.connectedPoint.ownerBlock:this._imageSource=null,(e.target===P.Vertex||this._fragmentOnly||e.target===P.Fragment)&&(this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA")),!this._isMixed&&e.target===P.Fragment||this._isMixed&&e.target===P.Vertex){if(!this._imageSource){const o=e._getFreeVariableName(this.name);this._samplerName=o+"Texture",(r=(i=this._texture)==null?void 0:i._texture)!=null&&r.is2DArray?e._emit2DArraySampler(this._samplerName):e._emit2DSampler(this._samplerName)}e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this)}if(e.target!==P.Fragment){this._injectVertexCode(e);return}if(!this._outputs.some(o=>o.isConnectedInFragmentShader))return;this._isMixed&&!this._imageSource&&((a=(n=this._texture)==null?void 0:n._texture)!=null&&a.is2DArray?e._emit2DArraySampler(this._samplerName):e._emit2DSampler(this._samplerName));const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),this._isMixed&&e._emitUniformFromString(this._textureInfoName,p.Float),this._writeTextureRead(e);for(const o of this._outputs)o.hasEndpoints&&o.name!=="level"&&this._writeOutput(e,o,o.name);return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};
`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};
`,e+=`${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};
`,this.texture&&(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});
`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};
`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};
`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};
`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};
`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};
`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};
`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};
`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};
`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};
`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};
`),e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.fragmentOnly=this._fragmentOnly,e.disableLevelMultiplication=this.disableLevelMultiplication,!this.hasImageSource&&this.texture&&(it.AllowSerializationOfRenderTargetTextures||!this.texture.isRenderTarget)&&this.texture.getClassName()!=="VideoTexture"&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i,r){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this._fragmentOnly=!!e.fragmentOnly,this.disableLevelMultiplication=!!e.disableLevelMultiplication,e.texture&&!it.IgnoreTexturesAtLoadTime&&(e.texture.url!==void 0&&(e.texture.url.indexOf("data:")===0?i="":r&&(e.texture.url=r(e.texture.url),e.texture.name=e.texture.url)),(e.texture.base64String||e.texture.url!==void 0)&&(this.texture=$.Parse(e.texture,t,i)))}}y("BABYLON.TextureBlock",uu);class Ul extends ie{get texture(){return this._texture}set texture(e){if(this._texture===e)return;const t=(e==null?void 0:e.getScene())??De.LastCreatedScene;!e&&t&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this._texture)),this._texture=e,e&&t&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(e))}static _OnGenerateOnlyFragmentCodeChanged(e,t){return e._onGenerateOnlyFragmentCodeChanged()}_onGenerateOnlyFragmentCodeChanged(){return this._setTarget(),!0}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?P.Fragment:P.VertexAndFragment)}constructor(e){super(e,P.VertexAndFragment),this.generateOnlyFragmentCode=!1}getClassName(){return"ReflectionTextureBaseBlock"}_getTexture(){return this.texture}initialize(e){this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,e===1?await U(()=>import("./default.fragment-d4022e5c.js").then(t=>t.r),["assets/default.fragment-d4022e5c.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/mainUVVaryingDeclaration-d7d129d5.js","assets/meshUboDeclaration-6df77899.js","assets/helperFunctions-60ac609f.js","assets/logDepthFragment-1fbe4860.js","assets/clipPlaneFragment-4ee9d5d8.js","assets/logDepthDeclaration-2a2324b6.js","assets/fogFragmentDeclaration-ab16d80d.js"]):await U(()=>import("./default.fragment-24488752.js").then(t=>t.r),["assets/default.fragment-24488752.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/mainUVVaryingDeclaration-91e38cff.js","assets/meshUboDeclaration-ca609797.js"]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}autoConfigure(e,t=()=>!0){if(!this.position.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="position"&&t(r));i||(i=new ge("position"),i.setAsAttribute()),i.output.connectTo(this.position)}if(!this.world.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===ve.World&&t(r));i||(i=new ge("world"),i.setAsSystemValue(ve.World)),i.output.connectTo(this.world)}if(this.view&&!this.view.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===ve.View&&t(r));i||(i=new ge("view"),i.setAsSystemValue(ve.View)),i.output.connectTo(this.view)}}prepareDefines(e){if(!e._areTexturesDirty)return;const t=this._getTexture();!t||!t.getTextureMatrix||(e.setValue(this._define3DName,t.isCube,!0),e.setValue(this._defineLocalCubicName,!!t.boundingBoxSize,!0),e.setValue(this._defineExplicitName,t.coordinatesMode===0,!0),e.setValue(this._defineSkyboxName,t.coordinatesMode===5,!0),e.setValue(this._defineCubicName,t.coordinatesMode===3||t.coordinatesMode===6,!0),e.setValue("INVERTCUBICMAP",t.coordinatesMode===6,!0),e.setValue(this._defineSphericalName,t.coordinatesMode===1,!0),e.setValue(this._definePlanarName,t.coordinatesMode===2,!0),e.setValue(this._defineProjectionName,t.coordinatesMode===4,!0),e.setValue(this._defineEquirectangularName,t.coordinatesMode===7,!0),e.setValue(this._defineEquirectangularFixedName,t.coordinatesMode===8,!0),e.setValue(this._defineMirroredEquirectangularFixedName,t.coordinatesMode===9,!0))}isReady(){const e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())}bind(e,t,i,r){const n=this._getTexture();if(!(!i||!n)&&(e.setMatrix(this._reflectionMatrixName,n.getReflectionTextureMatrix()),n.isCube?e.setTexture(this._cubeSamplerName,n):e.setTexture(this._2DSamplerName,n),n.boundingBoxSize)){const a=n;e.setVector3(this._reflectionPositionName,a.boundingBoxPosition),e.setVector3(this._reflectionSizeName,a.boundingBoxSize)}}handleVertexSide(e){if(this.generateOnlyFragmentCode&&e.target===P.Vertex)return"";const t=e.shaderLanguage===1;this._define3DName=e._getFreeDefineName("REFLECTIONMAP_3D"),this._defineCubicName=e._getFreeDefineName("REFLECTIONMAP_CUBIC"),this._defineSphericalName=e._getFreeDefineName("REFLECTIONMAP_SPHERICAL"),this._definePlanarName=e._getFreeDefineName("REFLECTIONMAP_PLANAR"),this._defineProjectionName=e._getFreeDefineName("REFLECTIONMAP_PROJECTION"),this._defineExplicitName=e._getFreeDefineName("REFLECTIONMAP_EXPLICIT"),this._defineEquirectangularName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR"),this._defineLocalCubicName=e._getFreeDefineName("USE_LOCAL_REFLECTIONMAP_CUBIC"),this._defineMirroredEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"),this._defineEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR_FIXED"),this._defineSkyboxName=e._getFreeDefineName("REFLECTIONMAP_SKYBOX"),this._defineOppositeZ=e._getFreeDefineName("REFLECTIONMAP_OPPOSITEZ"),this._reflectionMatrixName=e._getFreeVariableName("reflectionMatrix"),e._emitUniformFromString(this._reflectionMatrixName,p.Matrix);let i="";this._worldPositionNameInFragmentOnlyMode=e._getFreeVariableName("worldPosition");const r=this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:"v_"+this.worldPosition.associatedVariableName;return(this.generateOnlyFragmentCode||e._emitVaryingFromString(r,p.Vector4))&&(this.generateOnlyFragmentCode?i+=`${e._declareLocalVar(r,p.Vector4)} = ${this.worldPosition.associatedVariableName};
`:i+=`${t?"vertexOutputs.":""}${r} = ${this.worldPosition.associatedVariableName};
`),this._positionUVWName=e._getFreeVariableName("positionUVW"),this._directionWname=e._getFreeVariableName("directionW"),(this.generateOnlyFragmentCode||e._emitVaryingFromString(this._positionUVWName,p.Vector3,this._defineSkyboxName))&&(i+=`#ifdef ${this._defineSkyboxName}
`,this.generateOnlyFragmentCode?i+=`${e._declareLocalVar(this._positionUVWName,p.Vector3)} = ${this.position.associatedVariableName}.xyz;
`:i+=`${t?"vertexOutputs.":""}${this._positionUVWName} = ${this.position.associatedVariableName}.xyz;
`,i+=`#endif
`),(this.generateOnlyFragmentCode||e._emitVaryingFromString(this._directionWname,p.Vector3,`defined(${this._defineEquirectangularFixedName}) || defined(${this._defineMirroredEquirectangularFixedName})`))&&(i+=`#if defined(${this._defineEquirectangularFixedName}) || defined(${this._defineMirroredEquirectangularFixedName})
`,this.generateOnlyFragmentCode?i+=`${e._declareLocalVar(this._directionWname,p.Vector3)} = normalize(vec3${e.fSuffix}(${this.world.associatedVariableName} * vec4${e.fSuffix}(${this.position.associatedVariableName}.xyz, 0.0)));
`:i+=`${t?"vertexOutputs.":""}${this._directionWname} = normalize(vec3${e.fSuffix}(${this.world.associatedVariableName} * vec4${e.fSuffix}(${this.position.associatedVariableName}.xyz, 0.0)));
`,i+=`#endif
`),i}handleFragmentSideInits(e){e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),e._samplerDeclaration+=`#ifdef ${this._define3DName}
`,e._emitCubeSampler(this._cubeSamplerName,"",!0),e._samplerDeclaration+=`#else
`,e._emit2DSampler(this._2DSamplerName,"",!0),e._samplerDeclaration+=`#endif
`,e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e._emitFunctionFromInclude("reflectionFunction",t,{replaceStrings:[{search:/vec3 computeReflectionCoords/g,replace:"void DUMMYFUNC"},{search:/fn computeReflectionCoords\(worldPos: vec4f,worldNormal: vec3f\)->vec3f/g,replace:"fn DUMMYFUNC()"}]}),this._reflectionColorName=e._getFreeVariableName("reflectionColor"),this._reflectionVectorName=e._getFreeVariableName("reflectionUVW"),this._reflectionCoordsName=e._getFreeVariableName("reflectionCoords"),this._reflectionPositionName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionPositionName,p.Vector3),this._reflectionSizeName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionSizeName,p.Vector3)}handleFragmentSideCodeReflectionCoords(e,t,i,r=!1,n=!1){const a=e.shaderLanguage===1,o=(a?"uniforms.":"")+this._reflectionMatrixName,l=`normalize(${this._directionWname})`,c=`${this._positionUVWName}`,u=`${this.cameraPosition.associatedVariableName}`,h=`${this.view.associatedVariableName}`,d=a?"fragmentInputs.":"";i||(i=this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:`${d}v_${this.worldPosition.associatedVariableName}`),t+=".xyz";let f=`
            #ifdef ${this._defineMirroredEquirectangularFixedName}
               ${e._declareLocalVar(this._reflectionVectorName,p.Vector3)} = computeMirroredFixedEquirectangularCoords(${i}, ${t}, ${l});
            #endif

            #ifdef ${this._defineEquirectangularFixedName}
                ${e._declareLocalVar(this._reflectionVectorName,p.Vector3)} = computeFixedEquirectangularCoords(${i}, ${t}, ${l});
            #endif

            #ifdef ${this._defineEquirectangularName}
                ${e._declareLocalVar(this._reflectionVectorName,p.Vector3)} = computeEquirectangularCoords(${i}, ${t}, ${u}.xyz, ${o});
            #endif

            #ifdef ${this._defineSphericalName}
                ${e._declareLocalVar(this._reflectionVectorName,p.Vector3)} = computeSphericalCoords(${i}, ${t}, ${h}, ${o});
            #endif

            #ifdef ${this._definePlanarName}
                ${e._declareLocalVar(this._reflectionVectorName,p.Vector3)} = computePlanarCoords(${i}, ${t}, ${u}.xyz, ${o});
            #endif

            #ifdef ${this._defineCubicName}
                #ifdef ${this._defineLocalCubicName}
                    ${e._declareLocalVar(this._reflectionVectorName,p.Vector3)} = computeCubicLocalCoords(${i}, ${t}, ${u}.xyz, ${o}, ${this._reflectionSizeName}, ${this._reflectionPositionName});
                #else
                ${e._declareLocalVar(this._reflectionVectorName,p.Vector3)} = computeCubicCoords(${i}, ${t}, ${u}.xyz, ${o});
                #endif
            #endif

            #ifdef ${this._defineProjectionName}
                ${e._declareLocalVar(this._reflectionVectorName,p.Vector3)} = computeProjectionCoords(${i}, ${h}, ${o});
            #endif

            #ifdef ${this._defineSkyboxName}
                ${e._declareLocalVar(this._reflectionVectorName,p.Vector3)} = computeSkyBoxCoords(${c}, ${o});
            #endif

            #ifdef ${this._defineExplicitName}
                ${e._declareLocalVar(this._reflectionVectorName,p.Vector3)} = vec3(0, 0, 0);
            #endif
`;return n||(f+=`#ifdef ${this._defineOppositeZ}
                ${this._reflectionVectorName}.z *= -1.0;
            #endif
`),r||(f+=`
                #ifdef ${this._define3DName}
                    ${e._declareLocalVar(this._reflectionCoordsName,p.Vector3)} = ${this._reflectionVectorName};
                #else
                    ${e._declareLocalVar(this._reflectionCoordsName,p.Vector2)} = ${this._reflectionVectorName}.xy;
                    #ifdef ${this._defineProjectionName}
                        ${this._reflectionCoordsName} /= ${this._reflectionVectorName}.z;
                    #endif
                    ${this._reflectionCoordsName}.y = 1.0 - ${this._reflectionCoordsName}.y;
                #endif
`),f}handleFragmentSideCodeReflectionColor(e,t,i=".rgb"){let r=p.Vector4;i.length===3&&(r=p.Vector3);let n=`${e._declareLocalVar(this._reflectionColorName,r)};
            #ifdef ${this._define3DName}
`;return t?n+=`${this._reflectionColorName} = ${e._generateTextureSampleCubeLOD(this._reflectionVectorName,this._cubeSamplerName,t)}${i};
`:n+=`${this._reflectionColorName} = ${e._generateTextureSampleCube(this._reflectionVectorName,this._cubeSamplerName)}${i};
`,n+=`
            #else
`,t?n+=`${this._reflectionColorName} =${e._generateTextureSampleLOD(this._reflectionCoordsName,this._2DSamplerName,t)}${i};
`:n+=`${this._reflectionColorName} = ${e._generateTextureSample(this._reflectionCoordsName,this._2DSamplerName)}${i};
`,n+=`#endif
`,n}writeOutputs(e,t){let i="";if(e.target===P.Fragment)for(const r of this._outputs)r.hasEndpoints&&(i+=`${e._declareOutput(r)} = ${t}.${r.name};
`);return i}_buildBlock(e){return super._buildBlock(e),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();if(!this.texture)return e;if(this.texture.isCube){const t=this.texture.forcedExtension;e+=`${this._codeVariableName}.texture = new BABYLON.CubeTexture("${this.texture.name}", undefined, undefined, ${this.texture.noMipmap}, null, undefined, undefined, undefined, ${this.texture._prefiltered}, ${t?'"'+t+'"':"null"});
`}else e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null);
`;return e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};
`,e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&!it.IgnoreTexturesAtLoadTime&&(i=e.texture.url.indexOf("data:")===0?"":i,e.texture.isCube?this.texture=ii.Parse(e.texture,t,i):this.texture=$.Parse(e.texture,t,i)),this.generateOnlyFragmentCode=e.generateOnlyFragmentCode,this._setTarget()}}_([O("Generate only fragment code",0,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:Ul._OnGenerateOnlyFragmentCodeChanged}})],Ul.prototype,"generateOnlyFragmentCode",void 0);y("BABYLON.ReflectionTextureBaseBlock",Ul);class Sz extends Ul{_onGenerateOnlyFragmentCodeChanged(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,N.Error("The position input must not be connected to be able to switch!"),!1):this.worldPosition.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,N.Error("The worldPosition input must not be connected to be able to switch!"),!1):(this._setTarget(),!0)}_setTarget(){super._setTarget(),this.getInputByName("position").target=this.generateOnlyFragmentCode?P.Fragment:P.Vertex,this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?P.Fragment:P.Vertex}constructor(e){super(e),this.registerInput("position",p.AutoDetect,!1,P.Vertex),this.registerInput("worldPosition",p.Vector4,!1,P.Vertex),this.registerInput("worldNormal",p.Vector4,!1,P.Fragment),this.registerInput("world",p.Matrix,!1,P.Vertex),this.registerInput("cameraPosition",p.Vector3,!1,P.Fragment),this.registerInput("view",p.Matrix,!1,P.Fragment),this.registerOutput("rgb",p.Color3,P.Fragment),this.registerOutput("rgba",p.Color4,P.Fragment),this.registerOutput("r",p.Float,P.Fragment),this.registerOutput("g",p.Float,P.Fragment),this.registerOutput("b",p.Float,P.Fragment),this.registerOutput("a",p.Float,P.Fragment),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(p.Color3|p.Vector3|p.Vector4)}getClassName(){return"ReflectionTextureBlock"}get position(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get world(){return this._inputs[3]}get cameraPosition(){return this._inputs[4]}get view(){return this._inputs[5]}get rgb(){return this._outputs[0]}get rgba(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}autoConfigure(e,t=()=>!0){if(super.autoConfigure(e),!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===ve.CameraPosition&&t(r));i||(i=new ge("cameraPosition"),i.setAsSystemValue(ve.CameraPosition)),i.output.connectTo(this.cameraPosition)}}_buildBlock(e){if(super._buildBlock(e),!this.texture)return e.compilationString+=this.writeOutputs(e,`vec4${e.fSuffix}(0.)`),this;if(e.target!==P.Fragment)return e.compilationString+=this.handleVertexSide(e),this;this.generateOnlyFragmentCode&&(e.compilationString+=this.handleVertexSide(e)),this.handleFragmentSideInits(e);const t=e._getFreeVariableName("normalWUnit");return e.compilationString+=`${e._declareLocalVar(t,p.Vector4)} = normalize(${this.worldNormal.associatedVariableName});
`,e.compilationString+=this.handleFragmentSideCodeReflectionCoords(e,t),e.compilationString+=this.handleFragmentSideCodeReflectionColor(e,void 0,""),e.compilationString+=this.writeOutputs(e,this._reflectionColorName),this}}y("BABYLON.ReflectionTextureBlock",Sz);class Rh extends ie{constructor(e){super(e,P.VertexAndFragment),this.useNonLinearDepth=!1,this.storeCameraSpaceZ=!1,this.force32itsFloat=!1,this._isUnique=!0,this.registerInput("uv",p.AutoDetect,!1,P.VertexAndFragment),this.registerOutput("depth",p.Float,P.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(p.Vector2|p.Vector3|p.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"SceneDepthBlock"}get uv(){return this._inputs[0]}get depth(){return this._outputs[0]}initialize(e){e._excludeVariableName("textureSampler")}get target(){return!this.uv.isConnected||this.uv.sourceBlock.isInput?P.VertexAndFragment:P.Fragment}_getTexture(e){return e.enableDepthRenderer(void 0,this.useNonLinearDepth,this.force32itsFloat,void 0,this.storeCameraSpaceZ).getDepthMap()}bind(e,t){const i=this._getTexture(t.getScene());e.setTexture(this._samplerName,i)}_injectVertexCode(e){const t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,t.type===p.Vector3?p.Vector3:t.type===p.Vector4?p.Vector4:p.Vector2)),this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,p.Vector2),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;
`,!!this._outputs.some(i=>i.isConnectedInVertexShader)){this._writeTextureRead(e,!0);for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,"r",!0)}}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===P.Fragment)return;const n=e.shaderLanguage===0?`texture2D(${this._samplerName},`:`textureSampleLevel(${this._samplerName}, ${this._samplerName+"Sampler"},`,a=e.shaderLanguage===0?"":", 0";e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,p.Vector4)}=  ${n} ${i.associatedVariableName}.xy${a});
`;return}const r=e.shaderLanguage===0?`texture2D(${this._samplerName},`:`textureSample(${this._samplerName}, ${this._samplerName+"Sampler"},`;if(this.uv.ownerBlock.target===P.Fragment){e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,p.Vector4)} = ${r} ${i.associatedVariableName}.xy);
`;return}e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,p.Vector4)} = ${r} ${this._mainUVName});
`}_writeOutput(e,t,i,r=!1){if(r){if(e.target===P.Fragment)return;e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`;return}if(this.uv.ownerBlock.target===P.Fragment){e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`;return}e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`}_buildBlock(e){if(super._buildBlock(e),this._samplerName=e._getFreeVariableName(this.name+"Sampler"),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.bindableBlocks.indexOf(this)<0&&e.sharedData.bindableBlocks.push(this),e.target!==P.Fragment){e._emit2DSampler(this._samplerName),this._injectVertexCode(e);return}if(this._outputs.some(t=>t.isConnectedInFragmentShader)){e._emit2DSampler(this._samplerName),this._writeTextureRead(e);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,"r");return this}}serialize(){const e=super.serialize();return e.useNonLinearDepth=this.useNonLinearDepth,e.storeCameraSpaceZ=this.storeCameraSpaceZ,e.force32itsFloat=this.force32itsFloat,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.useNonLinearDepth=e.useNonLinearDepth,this.storeCameraSpaceZ=!!e.storeCameraSpaceZ,this.force32itsFloat=e.force32itsFloat}}_([O("Use non linear depth",0,"ADVANCED",{embedded:!0,notifiers:{activatePreviewCommand:!0,callback:(s,e)=>{const t=e;let i=!1;return t.useNonLinearDepth&&(t.storeCameraSpaceZ=!1,i=!0),s&&s.disableDepthRenderer(),i}}})],Rh.prototype,"useNonLinearDepth",void 0);_([O("Store Camera space Z",0,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:(s,e)=>{const t=e;let i=!1;return t.storeCameraSpaceZ&&(t.useNonLinearDepth=!1,i=!0),s&&s.disableDepthRenderer(),i}}})],Rh.prototype,"storeCameraSpaceZ",void 0);_([O("Force 32 bits float",0,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:s=>s==null?void 0:s.disableDepthRenderer()}})],Rh.prototype,"force32itsFloat",void 0);y("BABYLON.SceneDepthBlock",Rh);class vz extends Bi{constructor(e){super(e)}get texture(){return this._texture}set texture(e){}bind(e,t){const r=t.getScene().enableDepthRenderer();this._texture=r.getDepthMap(),super.bind(e,t)}isReady(){return!0}getClassName(){return"DepthSourceBlock"}_dumpPropertiesCode(){return super._dumpPropertiesCode(!0)}serialize(){return super.serialize(!0)}}y("BABYLON.DepthSourceBlock",vz);class xz extends ie{constructor(e){super(e,P.VertexAndFragment,!0),this.registerInput("worldPosition",p.Vector4,!1)}getClassName(){return"ClipPlanesBlock"}initialize(e){e._excludeVariableName("vClipPlane"),e._excludeVariableName("fClipDistance"),e._excludeVariableName("vClipPlane2"),e._excludeVariableName("fClipDistance2"),e._excludeVariableName("vClipPlane3"),e._excludeVariableName("fClipDistance3"),e._excludeVariableName("vClipPlane4"),e._excludeVariableName("fClipDistance4"),e._excludeVariableName("vClipPlane5"),e._excludeVariableName("fClipDistance5"),e._excludeVariableName("vClipPlane6"),e._excludeVariableName("fClipDistance6"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,e===1?await Promise.all([U(()=>import("./clipPlaneFragment-4ee9d5d8.js").then(t=>t.a),["assets/clipPlaneFragment-4ee9d5d8.js","assets/main-e8601b72.js","assets/index-ad665221.css"]),U(()=>import("./clipPlaneFragment-4ee9d5d8.js").then(t=>t.c),["assets/clipPlaneFragment-4ee9d5d8.js","assets/main-e8601b72.js","assets/index-ad665221.css"]),U(()=>import("./clipPlaneVertex-9e3b7044.js").then(t=>t.a),["assets/clipPlaneVertex-9e3b7044.js","assets/main-e8601b72.js","assets/index-ad665221.css"]),U(()=>import("./clipPlaneVertex-9e3b7044.js").then(t=>t.c),["assets/clipPlaneVertex-9e3b7044.js","assets/main-e8601b72.js","assets/index-ad665221.css"])]):await Promise.all([U(()=>import("./main-e8601b72.js").then(t=>t.dP),["assets/main-e8601b72.js","assets/index-ad665221.css"]),U(()=>import("./main-e8601b72.js").then(t=>t.dN),["assets/main-e8601b72.js","assets/index-ad665221.css"]),U(()=>import("./main-e8601b72.js").then(t=>t.dX),["assets/main-e8601b72.js","assets/index-ad665221.css"]),U(()=>import("./main-e8601b72.js").then(t=>t.dT),["assets/main-e8601b72.js","assets/index-ad665221.css"])]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}get worldPosition(){return this._inputs[0]}get target(){return P.VertexAndFragment}set target(e){}prepareDefines(e,t,i){if(!i)return;const r=i.getScene(),n=!!(t.clipPlane??r.clipPlane),a=!!(t.clipPlane2??r.clipPlane2),o=!!(t.clipPlane3??r.clipPlane3),l=!!(t.clipPlane4??r.clipPlane4),c=!!(t.clipPlane5??r.clipPlane5),u=!!(t.clipPlane6??r.clipPlane6);e.setValue("CLIPPLANE",n,!0),e.setValue("CLIPPLANE2",a,!0),e.setValue("CLIPPLANE3",o,!0),e.setValue("CLIPPLANE4",l,!0),e.setValue("CLIPPLANE5",c,!0),e.setValue("CLIPPLANE6",u,!0)}bind(e,t,i){if(!i)return;const r=i.getScene();jn(e,t,r)}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;if(e.target!==P.Fragment){const i=this.worldPosition;e._emitFunctionFromInclude("clipPlaneVertexDeclaration",t,{replaceStrings:[{search:/uniform vec4 vClipPlane\d*;/g,replace:""}]}),e.compilationString+=e._emitCodeFromInclude("clipPlaneVertex",t,{replaceStrings:[{search:/worldPos/g,replace:i.associatedVariableName}]}),e._emitUniformFromString("vClipPlane",p.Vector4),e._emitUniformFromString("vClipPlane2",p.Vector4),e._emitUniformFromString("vClipPlane3",p.Vector4),e._emitUniformFromString("vClipPlane4",p.Vector4),e._emitUniformFromString("vClipPlane5",p.Vector4),e._emitUniformFromString("vClipPlane6",p.Vector4);return}return e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e._emitFunctionFromInclude("clipPlaneFragmentDeclaration",t),e.compilationString+=e._emitCodeFromInclude("clipPlaneFragment",t),this}}y("BABYLON.ClipPlanesBlock",xz);class Ez extends ie{get texture(){return null}set texture(e){}constructor(e,t=P.VertexAndFragment){super(e,t,!1),this.registerOutput("position",p.Object,P.VertexAndFragment,new at("position",this,1,Bi,"ImageSourceBlock")),this.registerOutput("localPosition",p.Object,P.VertexAndFragment,new at("localPosition",this,1,Bi,"ImageSourceBlock")),this.registerOutput("depth",p.Object,P.VertexAndFragment,new at("depth",this,1,Bi,"ImageSourceBlock")),this.registerOutput("screenDepth",p.Object,P.VertexAndFragment,new at("screenDepth",this,1,Bi,"ImageSourceBlock")),this.registerOutput("normal",p.Object,P.VertexAndFragment,new at("normal",this,1,Bi,"ImageSourceBlock")),this.registerOutput("worldNormal",p.Object,P.VertexAndFragment,new at("worldNormal",this,1,Bi,"ImageSourceBlock"))}getSamplerName(e){return e===this._outputs[0]?this._positionSamplerName:e===this._outputs[1]?this._localPositionSamplerName:e===this._outputs[2]?this._depthSamplerName:e===this._outputs[3]?this._screenSpaceDepthSamplerName:e===this._outputs[4]?this._normalSamplerName:e===this._outputs[5]?this._worldNormalSamplerName:""}get position(){return this._outputs[0]}get localPosition(){return this._outputs[1]}get depth(){return this._outputs[2]}get screenDepth(){return this._outputs[3]}get normal(){return this._outputs[4]}get worldNormal(){return this._outputs[5]}get positionSamplerName(){return this._positionSamplerName}get localPositionSamplerName(){return this._localPositionSamplerName}get normalSamplerName(){return this._normalSamplerName}get worldNormalSamplerName(){return this._worldNormalSamplerName}get depthSamplerName(){return this._depthSamplerName}get linearDepthSamplerName(){return this._screenSpaceDepthSamplerName}getClassName(){return"PrePassTextureBlock"}_buildBlock(e){if(super._buildBlock(e),e.target!==P.Vertex)return this._positionSamplerName="prepassPositionSampler",this._depthSamplerName="prepassDepthSampler",this._normalSamplerName="prepassNormalSampler",this._worldNormalSamplerName="prepassWorldNormalSampler",this._localPositionSamplerName="prepassLocalPositionSampler",this._screenSpaceDepthSamplerName="prepassScreenSpaceDepthSampler",e.sharedData.variableNames.prepassPositionSampler=0,e.sharedData.variableNames.prepassDepthSampler=0,e.sharedData.variableNames.prepassNormalSampler=0,e.sharedData.variableNames.prepassWorldNormalSampler=0,e.sharedData.variableNames.prepassLocalPositionSampler=0,e.sharedData.variableNames.prepassScreenSpaceDepthSampler=0,e.sharedData.textureBlocks.push(this),e.sharedData.bindableBlocks.push(this),this.position.isConnected&&e._emit2DSampler(this._positionSamplerName),this.depth.isConnected&&e._emit2DSampler(this._depthSamplerName),this.normal.isConnected&&e._emit2DSampler(this._normalSamplerName),this.worldNormal.isConnected&&e._emit2DSampler(this._worldNormalSamplerName),this.localPosition.isConnected&&e._emit2DSampler(this._localPositionSamplerName),this.screenDepth.isConnected&&e._emit2DSampler(this._screenSpaceDepthSamplerName),this}bind(e,t){const r=t.getScene().enablePrePassRenderer();if(!r)return;const n=r.defaultRT;n.textures&&(this.position.isConnected&&e.setTexture(this._positionSamplerName,n.textures[r.getIndex(1)]),this.localPosition.isConnected&&e.setTexture(this._localPositionSamplerName,n.textures[r.getIndex(9)]),this.depth.isConnected&&e.setTexture(this._depthSamplerName,n.textures[r.getIndex(5)]),this.screenDepth.isConnected&&e.setTexture(this._screenSpaceDepthSamplerName,n.textures[r.getIndex(10)]),this.normal.isConnected&&e.setTexture(this._normalSamplerName,n.textures[r.getIndex(6)]),this.worldNormal.isConnected&&e.setTexture(this._worldNormalSamplerName,n.textures[r.getIndex(8)]))}}y("BABYLON.PrePassTextureBlock",Ez);class Tz extends ie{get endpoints(){return this._endpoints}get target(){const e=this._inputs[0];if(e.isConnected){const t=e.connectedPoint.ownerBlock;if(t.target!==P.VertexAndFragment)return t.target;if(e.connectedPoint.target!==P.VertexAndFragment)return e.connectedPoint.target}return this._target}set target(e){this._target&e||(this._target=e)}constructor(e){super(e,P.Neutral),this._endpoints=[],this.registerInput("input",p.AutoDetect)}getClassName(){return"NodeMaterialTeleportInBlock"}get input(){return this._inputs[0]}isConnectedInFragmentShader(){return this.endpoints.some(e=>e.output.isConnectedInFragmentShader)}get isConnectedToUniform(){return this.input.isConnected&&this.input.connectedPoint.ownerBlock.isInput&&this.input.connectedPoint.ownerBlock.isUniform}_dumpCode(e,t){let i=super._dumpCode(e,t);for(const r of this.endpoints)t.indexOf(r)===-1&&(i+=r._dumpCode(e,t));return i}isAnAncestorOf(e){for(const t of this.endpoints)if(t===e||t.isAnAncestorOf(e))return!0;return!1}attachToEndpoint(e){e.detach(),this._endpoints.push(e),e._entryPoint=this,e._outputs[0]._typeConnectionSource=this._inputs[0],e._tempEntryPointUniqueId=null,e.name="> "+this.name,this._outputs=this._endpoints.map(t=>t.output)}detachFromEndpoint(e){const t=this._endpoints.indexOf(e);t!==-1&&(this._endpoints.splice(t,1),e._outputs[0]._typeConnectionSource=null,e._entryPoint=null,this._outputs=this._endpoints.map(i=>i.output))}dispose(){super.dispose();for(const e of this._endpoints)this.detachFromEndpoint(e);this._endpoints=[]}}y("BABYLON.NodeMaterialTeleportInBlock",Tz);class bz extends ie{constructor(e){super(e,P.Neutral),this._entryPoint=null,this._tempEntryPointUniqueId=null,this.registerOutput("output",p.BasedOnInput)}get entryPoint(){return this._entryPoint}getClassName(){return"NodeMaterialTeleportOutBlock"}get output(){return this._outputs[0]}get target(){return this._entryPoint?this._entryPoint.target:this._target}set target(e){this._target&e||(this._target=e)}detach(){this._entryPoint&&this._entryPoint.detachFromEndpoint(this)}_buildBlock(e){if(super._buildBlock(e),!!this.entryPoint){if(this.entryPoint.isConnectedToUniform){this.output.associatedVariableName=this.entryPoint.input.associatedVariableName;return}e.compilationString+=e._declareOutput(this.output)+` = ${this.entryPoint.input.associatedVariableName};
`}}clone(e,t=""){const i=super.clone(e,t);return this.entryPoint&&this.entryPoint.attachToEndpoint(i),i}_customBuildStep(e,t){this.entryPoint&&this.entryPoint.build(e,t)}_dumpCode(e,t){let i="";return this.entryPoint&&t.indexOf(this.entryPoint)===-1&&(i+=this.entryPoint._dumpCode(e,t)),i+super._dumpCode(e,t)}_dumpCodeForOutputConnections(e){let t=super._dumpCodeForOutputConnections(e);return this.entryPoint&&(t+=this.entryPoint._dumpCodeForOutputConnections(e)),t}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.entryPoint&&(e+=`${this.entryPoint._codeVariableName}.attachToEndpoint(${this._codeVariableName});
`),e}serialize(){var t;const e=super.serialize();return e.entryPoint=((t=this.entryPoint)==null?void 0:t.uniqueId)??"",e}_deserialize(e,t,i){super._deserialize(e,t,i),this._tempEntryPointUniqueId=e.entryPoint}}y("BABYLON.NodeMaterialTeleportOutBlock",bz);class Cz extends ie{constructor(e){super(e,P.Neutral),this.registerInput("input",p.AutoDetect),this.registerInput("factor",p.Float),this.registerOutput("output",p.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ScaleBlock"}get input(){return this._inputs[0]}get factor(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.input.associatedVariableName} * ${this.factor.associatedVariableName};
`,this}}y("BABYLON.ScaleBlock",Cz);class B_ extends ie{constructor(e){super(e,P.Neutral),this.minimum=0,this.maximum=1,this.registerInput("value",p.AutoDetect),this.registerOutput("output",p.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ClampBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=e.shaderLanguage===1?e._getShaderType(this.value.type):"";return e.compilationString+=e._declareOutput(t)+` = clamp(${this.value.associatedVariableName}, ${i}(${this._writeFloat(this.minimum)}), ${i}(${this._writeFloat(this.maximum)}));
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.minimum = ${this.minimum};
`;return e+=`${this._codeVariableName}.maximum = ${this.maximum};
`,e}serialize(){const e=super.serialize();return e.minimum=this.minimum,e.maximum=this.maximum,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.minimum=e.minimum,this.maximum=e.maximum}}_([O("Minimum",1,void 0,{embedded:!0})],B_.prototype,"minimum",void 0);_([O("Maximum",1,void 0,{embedded:!0})],B_.prototype,"maximum",void 0);y("BABYLON.ClampBlock",B_);class yz extends ie{constructor(e){super(e,P.Neutral),this.registerInput("left",p.AutoDetect),this.registerInput("right",p.AutoDetect),this.registerOutput("output",p.Vector3),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(p.Float),this._inputs[0].excludedConnectionPointTypes.push(p.Matrix),this._inputs[0].excludedConnectionPointTypes.push(p.Vector2),this._inputs[1].excludedConnectionPointTypes.push(p.Float),this._inputs[1].excludedConnectionPointTypes.push(p.Matrix),this._inputs[1].excludedConnectionPointTypes.push(p.Vector2)}getClassName(){return"CrossBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = cross(${this.left.associatedVariableName}.xyz, ${this.right.associatedVariableName}.xyz);
`,this}}y("BABYLON.CrossBlock",yz);class Iz extends ie{get options(){return this._options}set options(e){this._deserializeOptions(e)}constructor(e){super(e)}getClassName(){return"CustomBlock"}_buildBlock(e){var n,a;super._buildBlock(e);let t=this._code,i=this._options.functionName;for(const o of this._inputs){const l=new RegExp("\\{TYPE_"+o.name+"\\}","gm"),c=e._getGLType(o.type);t=t.replace(l,c),i=i.replace(l,c)}for(const o of this._outputs){const l=new RegExp("\\{TYPE_"+o.name+"\\}","gm"),c=e._getGLType(o.type);t=t.replace(l,c),i=i.replace(l,c)}e._emitFunction(i,t,"");for(const o of this._outputs)e.compilationString+=e._declareOutput(o)+`;
`;e.compilationString+=i+"(";let r=!1;for(let o=0;o<this._inputs.length;o++){const l=this._inputs[o];o>0&&(e.compilationString+=", "),this._inputSamplers&&this._inputSamplers.indexOf(l.name)!==-1?e.compilationString+=((a=(n=l.connectedPoint)==null?void 0:n.ownerBlock)==null?void 0:a.samplerName)??l.associatedVariableName:e.compilationString+=l.associatedVariableName,r=!0}for(let o=0;o<this._outputs.length;o++){const l=this._outputs[o];(o>0||r)&&(e.compilationString+=", "),e.compilationString+=l.associatedVariableName}return e.compilationString+=`);
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.options = ${JSON.stringify(this._options)};
`,e}serialize(){const e=super.serialize();return e.options=this._options,e}_deserialize(e,t,i){this._deserializeOptions(e.options),super._deserialize(e,t,i)}_deserializeOptions(e){if(this._options=e,this._code=e.code.join(`
`)+`
`,this.name=this.name||e.name,this.target=P[e.target],e.inParameters)for(let t=0;t<e.inParameters.length;t++){const i=e.inParameters[t],r=p[i.type];i.type==="sampler2D"||i.type==="samplerCube"||i.type==="sampler2DArray"?(this._inputSamplers=this._inputSamplers||[],this._inputSamplers.push(i.name),this.registerInput(i.name,p.Object,!0,P.VertexAndFragment,new at(i.name,this,0,Bi,"ImageSourceBlock"))):this.registerInput(i.name,r),Object.defineProperty(this,i.name,{get:function(){return this._inputs[t]},enumerable:!0,configurable:!0})}if(e.outParameters)for(let t=0;t<e.outParameters.length;t++){const i=e.outParameters[t];this.registerOutput(i.name,p[i.type]),Object.defineProperty(this,i.name,{get:function(){return this._outputs[t]},enumerable:!0,configurable:!0}),i.type==="BasedOnInput"&&(this._outputs[t]._typeConnectionSource=this._findInputByName(i.typeFromInput)[0])}if(e.inLinkedConnectionTypes)for(const t of e.inLinkedConnectionTypes)this._linkConnectionTypes(this._findInputByName(t.input1)[1],this._findInputByName(t.input2)[1])}_findInputByName(e){if(!e)return null;for(let t=0;t<this._inputs.length;t++)if(this._inputs[t].name===e)return[this._inputs[t],t];return null}}y("BABYLON.CustomBlock",Iz);class Rz extends ie{constructor(e){super(e,P.Neutral),this.registerInput("left",p.AutoDetect),this.registerInput("right",p.AutoDetect),this.registerOutput("output",p.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(p.Float),this._inputs[0].excludedConnectionPointTypes.push(p.Matrix),this._inputs[1].excludedConnectionPointTypes.push(p.Float),this._inputs[1].excludedConnectionPointTypes.push(p.Matrix)}getClassName(){return"DotBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = dot(${this.left.associatedVariableName}, ${this.right.associatedVariableName});
`,this}}y("BABYLON.DotBlock",Rz);class Az extends ie{constructor(e){super(e,P.Neutral),this.registerInput("input",p.AutoDetect),this.registerOutput("output",p.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(p.Float),this._inputs[0].excludedConnectionPointTypes.push(p.Matrix)}getClassName(){return"NormalizeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];return e.compilationString+=e._declareOutput(t)+` = normalize(${i.associatedVariableName});
`,this}}y("BABYLON.NormalizeBlock",Az);class Pz extends ie{constructor(e){super(e,P.Neutral),this.rSwizzle="r",this.gSwizzle="g",this.bSwizzle="b",this.aSwizzle="a",this.registerInput("rgb ",p.Color3,!0),this.registerInput("r",p.Float,!0),this.registerInput("g",p.Float,!0),this.registerInput("b",p.Float,!0),this.registerInput("a",p.Float,!0),this.registerOutput("rgba",p.Color4),this.registerOutput("rgb",p.Color3)}getClassName(){return"ColorMergerBlock"}get rgbIn(){return this._inputs[0]}get r(){return this._inputs[1]}get g(){return this._inputs[2]}get b(){return this._inputs[3]}get a(){return this._inputs[4]}get rgba(){return this._outputs[0]}get rgbOut(){return this._outputs[1]}get rgb(){return this.rgbOut}_inputRename(e){return e==="rgb "?"rgbIn":e}_outputRename(e){return e==="rgb"?"rgbOut":e}_buildSwizzle(e){return"."+(this.rSwizzle+this.gSwizzle+this.bSwizzle+this.aSwizzle).substring(0,e)}_buildBlock(e){super._buildBlock(e);const t=this.r,i=this.g,r=this.b,n=this.a,a=this.rgbIn,o=this._outputs[0],l=this._outputs[1],c=e._getShaderType(p.Vector4),u=e._getShaderType(p.Vector3);return a.isConnected?(o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${c}(${a.associatedVariableName}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(4)};
`),l.hasEndpoints&&(e.compilationString+=e._declareOutput(l)+` = ${a.associatedVariableName}${this._buildSwizzle(3)};
`)):(o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${c}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(4)};
`),l.hasEndpoints&&(e.compilationString+=e._declareOutput(l)+` = ${u}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};
`)),this}serialize(){const e=super.serialize();return e.rSwizzle=this.rSwizzle,e.gSwizzle=this.gSwizzle,e.bSwizzle=this.bSwizzle,e.aSwizzle=this.aSwizzle,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.rSwizzle=e.rSwizzle??"r",this.gSwizzle=e.gSwizzle??"g",this.bSwizzle=e.bSwizzle??"b",this.aSwizzle=e.aSwizzle??"a"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.rSwizzle = "${this.rSwizzle}";
`,e+=`${this._codeVariableName}.gSwizzle = "${this.gSwizzle}";
`,e+=`${this._codeVariableName}.bSwizzle = "${this.bSwizzle}";
`,e+=`${this._codeVariableName}.aSwizzle = "${this.aSwizzle}";
`,e}}y("BABYLON.ColorMergerBlock",Pz);class Oz extends ie{constructor(e){super(e,P.Neutral),this.registerInput("xyzw",p.Vector4,!0),this.registerInput("xyz ",p.Vector3,!0),this.registerInput("xy ",p.Vector2,!0),this.registerOutput("xyz",p.Vector3),this.registerOutput("xy",p.Vector2),this.registerOutput("zw",p.Vector2),this.registerOutput("x",p.Float),this.registerOutput("y",p.Float),this.registerOutput("z",p.Float),this.registerOutput("w",p.Float),this.inputsAreExclusive=!0}getClassName(){return"VectorSplitterBlock"}get xyzw(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get xyzOut(){return this._outputs[0]}get xyOut(){return this._outputs[1]}get zw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get w(){return this._outputs[6]}_inputRename(e){switch(e){case"xy ":return"xyIn";case"xyz ":return"xyzIn";default:return e}}_outputRename(e){switch(e){case"xy":return"xyOut";case"xyz":return"xyzOut";default:return e}}_buildBlock(e){super._buildBlock(e);const t=this.xyzw.isConnected?this.xyzw:this.xyzIn.isConnected?this.xyzIn:this.xyIn,i=this._outputs[0],r=this._outputs[1],n=this._outputs[2],a=this._outputs[3],o=this._outputs[4],l=this._outputs[5],c=this._outputs[6],u=e._getShaderType(p.Vector3);return i.hasEndpoints&&(t===this.xyIn?e.compilationString+=e._declareOutput(i)+` = ${u}(${t.associatedVariableName}, 0.0);
`:e.compilationString+=e._declareOutput(i)+` = ${t.associatedVariableName}.xyz;
`),n.hasEndpoints&&this.xyzw.isConnected&&(e.compilationString+=e._declareOutput(n)+` = ${this.xyzw.associatedVariableName}.zw;
`),r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = ${t.associatedVariableName}.xy;
`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${t.associatedVariableName}.x;
`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${t.associatedVariableName}.y;
`),l.hasEndpoints&&(e.compilationString+=e._declareOutput(l)+` = ${t.associatedVariableName}.z;
`),c.hasEndpoints&&(e.compilationString+=e._declareOutput(c)+` = ${t.associatedVariableName}.w;
`),this}}y("BABYLON.VectorSplitterBlock",Oz);class Nz extends ie{constructor(e){super(e,P.Neutral),this.registerInput("left",p.AutoDetect),this.registerInput("right",p.AutoDetect),this.registerInput("gradient",p.AutoDetect),this.registerOutput("output",p.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(p.Float)}getClassName(){return"LerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName});
`,this}}y("BABYLON.LerpBlock",Nz);class Dz extends vh{constructor(e){super(e)}getClassName(){return"DivideBlock"}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} / ${this.right.associatedVariableName};
`,this}}y("BABYLON.DivideBlock",Dz);class Mz extends vh{constructor(e){super(e)}getClassName(){return"SubtractBlock"}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} - ${this.right.associatedVariableName};
`,this}}y("BABYLON.SubtractBlock",Mz);class Fz extends ie{constructor(e){super(e,P.Neutral),this.registerInput("value",p.Float),this.registerInput("edge",p.Float),this.registerOutput("output",p.Float)}getClassName(){return"StepBlock"}get value(){return this._inputs[0]}get edge(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = step(${this.edge.associatedVariableName}, ${this.value.associatedVariableName});
`,this}}y("BABYLON.StepBlock",Fz);class ZA extends ie{constructor(e){super(e,P.Neutral),this.registerInput("input",p.AutoDetect),this.registerOutput("output",p.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[0].excludedConnectionPointTypes.push(p.Matrix)}getClassName(){return"OneMinusBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = 1. - ${this.input.associatedVariableName};
`,this}}y("BABYLON.OneMinusBlock",ZA);y("BABYLON.OppositeBlock",ZA);class QA extends ie{constructor(e){super(e,P.Neutral),this.registerInput("worldPosition",p.Vector4),this.registerInput("cameraPosition",p.Vector3),this.registerOutput("output",p.Vector3)}getClassName(){return"ViewDirectionBlock"}get worldPosition(){return this._inputs[0]}get cameraPosition(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(e,t=()=>!0){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===ve.CameraPosition&&t(r));i||(i=new ge("cameraPosition"),i.setAsSystemValue(ve.CameraPosition)),i.output.connectTo(this.cameraPosition)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = normalize(${this.cameraPosition.associatedVariableName} - ${this.worldPosition.associatedVariableName}.xyz);
`,this}}y("BABYLON.ViewDirectionBlock",QA);class Lz extends ie{constructor(e){super(e,P.Neutral),this.registerInput("worldNormal",p.Vector4),this.registerInput("viewDirection",p.Vector3),this.registerInput("bias",p.Float),this.registerInput("power",p.Float),this.registerOutput("fresnel",p.Float)}getClassName(){return"FresnelBlock"}get worldNormal(){return this._inputs[0]}get viewDirection(){return this._inputs[1]}get bias(){return this._inputs[2]}get power(){return this._inputs[3]}get fresnel(){return this._outputs[0]}autoConfigure(e){if(!this.viewDirection.isConnected){const t=new QA("View direction");t.output.connectTo(this.viewDirection),t.autoConfigure(e)}if(!this.bias.isConnected){const t=new ge("bias");t.value=0,t.output.connectTo(this.bias)}if(!this.power.isConnected){const t=new ge("power");t.value=1,t.output.connectTo(this.power)}}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;return e._emitFunctionFromInclude("fresnelFunction",t,{removeIfDef:!0}),e.compilationString+=e._declareOutput(this.fresnel)+` = computeFresnelTerm(${this.viewDirection.associatedVariableName}.xyz, ${this.worldNormal.associatedVariableName}.xyz, ${this.bias.associatedVariableName}, ${this.power.associatedVariableName});
`,this}}y("BABYLON.FresnelBlock",Lz);class wz extends ie{constructor(e){super(e,P.Neutral),this.registerInput("left",p.AutoDetect),this.registerInput("right",p.AutoDetect),this.registerOutput("output",p.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MaxBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = max(${this.left.associatedVariableName}, ${this.right.associatedVariableName});
`,this}}y("BABYLON.MaxBlock",wz);class Bz extends ie{constructor(e){super(e,P.Neutral),this.registerInput("left",p.AutoDetect),this.registerInput("right",p.AutoDetect),this.registerOutput("output",p.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MinBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = min(${this.left.associatedVariableName}, ${this.right.associatedVariableName});
`,this}}y("BABYLON.MinBlock",Bz);class Vz extends ie{constructor(e){super(e,P.Neutral),this.registerInput("left",p.AutoDetect),this.registerInput("right",p.AutoDetect),this.registerOutput("output",p.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(p.Float),this._inputs[0].excludedConnectionPointTypes.push(p.Matrix),this._inputs[1].excludedConnectionPointTypes.push(p.Float),this._inputs[1].excludedConnectionPointTypes.push(p.Matrix)}getClassName(){return"DistanceBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = length(${this.left.associatedVariableName} - ${this.right.associatedVariableName});
`,this}}y("BABYLON.DistanceBlock",Vz);class Uz extends ie{constructor(e){super(e,P.Neutral),this.registerInput("value",p.AutoDetect),this.registerOutput("output",p.Float),this._inputs[0].excludedConnectionPointTypes.push(p.Float),this._inputs[0].excludedConnectionPointTypes.push(p.Matrix)}getClassName(){return"LengthBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = length(${this.value.associatedVariableName});
`,this}}y("BABYLON.LengthBlock",Uz);class kz extends ie{constructor(e){super(e,P.Neutral),this.registerInput("value",p.AutoDetect),this.registerOutput("output",p.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"NegateBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = -1.0 * ${this.value.associatedVariableName};
`,this}}y("BABYLON.NegateBlock",kz);class Gz extends ie{constructor(e){super(e,P.Neutral),this.registerInput("value",p.AutoDetect),this.registerInput("power",p.AutoDetect),this.registerOutput("output",p.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"PowBlock"}get value(){return this._inputs[0]}get power(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = pow(max(${this.value.associatedVariableName}, 0.), ${this.power.associatedVariableName});
`,this}}y("BABYLON.PowBlock",Gz);class zz extends ie{constructor(e){super(e,P.Neutral),this.registerInput("seed",p.AutoDetect),this.registerOutput("output",p.Float),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(p.Vector2|p.Vector3|p.Vector4|p.Color3|p.Color4)}getClassName(){return"RandomNumberBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=`//${this.name}`;return e._emitFunctionFromInclude("helperFunctions",i),e.compilationString+=e._declareOutput(t)+` = getRand(${this.seed.associatedVariableName}.xy);
`,this}}y("BABYLON.RandomNumberBlock",zz);class Wz extends ie{constructor(e){super(e,P.Neutral),this.registerInput("x",p.Float),this.registerInput("y",p.Float),this.registerOutput("output",p.Float)}getClassName(){return"ArcTan2Block"}get x(){return this._inputs[0]}get y(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=e.shaderLanguage===1?"atan2":"atan";return e.compilationString+=e._declareOutput(t)+` = ${i}(${this.x.associatedVariableName}, ${this.y.associatedVariableName});
`,this}}y("BABYLON.ArcTan2Block",Wz);class Hz extends ie{constructor(e){super(e,P.Neutral),this.registerInput("value",p.AutoDetect),this.registerInput("edge0",p.Float),this.registerInput("edge1",p.Float),this.registerOutput("output",p.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"SmoothStepBlock"}get value(){return this._inputs[0]}get edge0(){return this._inputs[1]}get edge1(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=e._getShaderType(this.value.type);return e.compilationString+=e._declareOutput(t)+` = smoothstep(${i}(${this.edge0.associatedVariableName}), ${i}(${this.edge1.associatedVariableName}), ${this.value.associatedVariableName});
`,this}}y("BABYLON.SmoothStepBlock",Hz);class $z extends ie{constructor(e){super(e,P.Neutral),this.registerInput("input",p.AutoDetect),this.registerOutput("output",p.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ReciprocalBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return this.input.type===p.Matrix?e.compilationString+=e._declareOutput(t)+` = inverse(${this.input.associatedVariableName});
`:e.compilationString+=e._declareOutput(t)+` = 1. / ${this.input.associatedVariableName};
`,this}}y("BABYLON.ReciprocalBlock",$z);class Xz extends ie{constructor(e){super(e,P.Neutral),this.registerInput("value",p.AutoDetect),this.registerInput("reference",p.AutoDetect),this.registerInput("distance",p.Float),this.registerInput("replacement",p.AutoDetect),this.registerOutput("output",p.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(0,3),this._inputs[0].excludedConnectionPointTypes.push(p.Float),this._inputs[0].excludedConnectionPointTypes.push(p.Matrix),this._inputs[1].excludedConnectionPointTypes.push(p.Float),this._inputs[1].excludedConnectionPointTypes.push(p.Matrix),this._inputs[3].excludedConnectionPointTypes.push(p.Float),this._inputs[3].excludedConnectionPointTypes.push(p.Matrix)}getClassName(){return"ReplaceColorBlock"}get value(){return this._inputs[0]}get reference(){return this._inputs[1]}get distance(){return this._inputs[2]}get replacement(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+`;
`,e.compilationString+=`if (length(${this.value.associatedVariableName} - ${this.reference.associatedVariableName}) < ${this.distance.associatedVariableName}) {
`,e.compilationString+=`${t.associatedVariableName} = ${this.replacement.associatedVariableName};
`,e.compilationString+=`} else {
`,e.compilationString+=`${t.associatedVariableName} = ${this.value.associatedVariableName};
`,e.compilationString+=`}
`,this}}y("BABYLON.ReplaceColorBlock",Xz);class Yz extends ie{constructor(e){super(e,P.Neutral),this.registerInput("value",p.AutoDetect),this.registerInput("steps",p.AutoDetect),this.registerOutput("output",p.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(p.Matrix),this._inputs[1].excludedConnectionPointTypes.push(p.Matrix),this._inputs[1].acceptedConnectionPointTypes.push(p.Float)}getClassName(){return"PosterizeBlock"}get value(){return this._inputs[0]}get steps(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = floor(${this.value.associatedVariableName} / (1.0 / ${this.steps.associatedVariableName})) * (1.0 / ${this.steps.associatedVariableName});
`,this}}y("BABYLON.PosterizeBlock",Yz);var MT;(function(s){s[s.SawTooth=0]="SawTooth",s[s.Square=1]="Square",s[s.Triangle=2]="Triangle"})(MT||(MT={}));class KA extends ie{constructor(e){super(e,P.Neutral),this.kind=0,this.registerInput("input",p.AutoDetect),this.registerOutput("output",p.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(p.Matrix)}getClassName(){return"WaveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];switch(this.kind){case 0:{e.compilationString+=e._declareOutput(t)+` = ${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName});
`;break}case 1:{e.compilationString+=e._declareOutput(t)+` = 1.0 - 2.0 * round(fract(${this.input.associatedVariableName}));
`;break}case 2:{e.compilationString+=e._declareOutput(t)+` = 2.0 * abs(2.0 * (${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName}))) - 1.0;
`;break}}return this}serialize(){const e=super.serialize();return e.kind=this.kind,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.kind=e.kind}}_([O("Kind",5,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"SawTooth",value:0},{label:"Square",value:1},{label:"Triangle",value:2}]})],KA.prototype,"kind",void 0);y("BABYLON.WaveBlock",KA);class id{get step(){return this._step}set step(e){this._step=e}get color(){return this._color}set color(e){this._color=e}constructor(e,t){this.step=e,this.color=t}}class jz extends ie{colorStepsUpdated(){this.onValueChangedObservable.notifyObservers(this)}constructor(e){super(e,P.Neutral),this.colorSteps=[new id(0,q.Black()),new id(1,q.White())],this.onValueChangedObservable=new k,this.registerInput("gradient",p.AutoDetect),this.registerOutput("output",p.Color3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(p.Float|p.Vector2|p.Vector3|p.Vector4|p.Color3|p.Color4)}getClassName(){return"GradientBlock"}get gradient(){return this._inputs[0]}get output(){return this._outputs[0]}_writeColorConstant(e,t){const i=this.colorSteps[e];return`${t}(${i.color.r}, ${i.color.g}, ${i.color.b})`}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=e._getShaderType(p.Vector3);if(!this.colorSteps.length||!this.gradient.connectedPoint){e.compilationString+=e._declareOutput(t)+` = ${i}(0., 0., 0.);
`;return}const r=e._getFreeVariableName("gradientTempColor"),n=e._getFreeVariableName("gradientTempPosition");e.compilationString+=`${e._declareLocalVar(r,p.Vector3)} = ${this._writeColorConstant(0,i)};
`,e.compilationString+=`${e._declareLocalVar(n,p.Float)};
`;let a=this.gradient.associatedVariableName;this.gradient.connectedPoint.type!==p.Float&&(a+=".x");for(let o=1;o<this.colorSteps.length;o++){const l=this.colorSteps[o],c=this.colorSteps[o-1];e.compilationString+=`${n} = clamp((${a} - ${e._emitFloat(c.step)}) / (${e._emitFloat(l.step)} -  ${e._emitFloat(c.step)}), 0.0, 1.0) * step(${e._emitFloat(o)}, ${e._emitFloat(this.colorSteps.length-1)});
`,e.compilationString+=`${r} = mix(${r}, ${this._writeColorConstant(o,i)}, ${n});
`}return e.compilationString+=e._declareOutput(t)+` = ${r};
`,this}serialize(){const e=super.serialize();e.colorSteps=[];for(const t of this.colorSteps)e.colorSteps.push({step:t.step,color:{r:t.color.r,g:t.color.g,b:t.color.b}});return e}_deserialize(e,t,i){super._deserialize(e,t,i),this.colorSteps.length=0;for(const r of e.colorSteps)this.colorSteps.push(new id(r.step,new q(r.color.r,r.color.g,r.color.b)))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();e+=`${this._codeVariableName}.colorSteps = [];
`;for(const t of this.colorSteps)e+=`${this._codeVariableName}.colorSteps.push(new BABYLON.GradientBlockColorStep(${t.step}, new BABYLON.Color3(${t.color.r}, ${t.color.g}, ${t.color.b})));
`;return e}}y("BABYLON.GradientBlock",jz);class qz extends ie{constructor(e){super(e,P.Neutral),this.registerInput("left",p.AutoDetect),this.registerInput("right",p.AutoDetect),this.registerInput("gradient",p.AutoDetect),this.registerOutput("output",p.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(p.Float)}getClassName(){return"NLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = normalize(mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName}));
`,this}}y("BABYLON.NLerpBlock",qz);class JA extends ie{constructor(e){super(e,P.Neutral),this.manhattanDistance=!1,this.registerInput("seed",p.Vector3),this.registerInput("jitter",p.Float),this.registerOutput("output",p.Vector2),this.registerOutput("x",p.Float),this.registerOutput("y",p.Float)}getClassName(){return"WorleyNoise3DBlock"}get seed(){return this._inputs[0]}get jitter(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected||!this.output.hasEndpoints&&!this.x.hasEndpoints&&!this.y.hasEndpoints)return;let t=`vec3 permute(vec3 x){
`;t+=`    return mod((34.0 * x + 1.0) * x, 289.0);
`,t+=`}

`,t+=`vec3 dist(vec3 x, vec3 y, vec3 z,  bool manhattanDistance){
`,t+=`    return [manhattanDistance ?  abs(x) + abs(y) + abs(z) :  (x * x + y * y + z * z)];
`,t+=`}

`,t+=`vec2 worley(vec3 P, float jitter, bool manhattanDistance){
`,t+=`    float K = 0.142857142857; // 1/7
`,t+=`    float Ko = 0.428571428571; // 1/2-K/2
`,t+=`    float  K2 = 0.020408163265306; // 1/(7*7)
`,t+=`    float Kz = 0.166666666667; // 1/6
`,t+=`    float Kzo = 0.416666666667; // 1/2-1/6*2
`,t+=`
`,t+=`    vec3 Pi = mod(floor(P), 289.0);
`,t+=`    vec3 Pf = fract(P) - 0.5;
`,t+=`
`,t+=`    vec3 Pfx = Pf.x + vec3(1.0, 0.0, -1.0);
`,t+=`    vec3 Pfy = Pf.y + vec3(1.0, 0.0, -1.0);
`,t+=`    vec3 Pfz = Pf.z + vec3(1.0, 0.0, -1.0);
`,t+=`
`,t+=`    vec3 p = permute(Pi.x + vec3(-1.0, 0.0, 1.0));
`,t+=`    vec3 p1 = permute(p + Pi.y - 1.0);
`,t+=`    vec3 p2 = permute(p + Pi.y);
`,t+=`    vec3 p3 = permute(p + Pi.y + 1.0);
`,t+=`
`,t+=`    vec3 p11 = permute(p1 + Pi.z - 1.0);
`,t+=`    vec3 p12 = permute(p1 + Pi.z);
`,t+=`    vec3 p13 = permute(p1 + Pi.z + 1.0);
`,t+=`
`,t+=`    vec3 p21 = permute(p2 + Pi.z - 1.0);
`,t+=`    vec3 p22 = permute(p2 + Pi.z);
`,t+=`    vec3 p23 = permute(p2 + Pi.z + 1.0);
`,t+=`
`,t+=`    vec3 p31 = permute(p3 + Pi.z - 1.0);
`,t+=`    vec3 p32 = permute(p3 + Pi.z);
`,t+=`    vec3 p33 = permute(p3 + Pi.z + 1.0);
`,t+=`
`,t+=`    vec3 ox11 = fract(p11*K) - Ko;
`,t+=`    vec3 oy11 = mod(floor(p11*K), 7.0)*K - Ko;
`,t+=`    vec3 oz11 = floor(p11*K2)*Kz - Kzo; // p11 < 289 guaranteed
`,t+=`
`,t+=`    vec3 ox12 = fract(p12*K) - Ko;
`,t+=`    vec3 oy12 = mod(floor(p12*K), 7.0)*K - Ko;
`,t+=`    vec3 oz12 = floor(p12*K2)*Kz - Kzo;
`,t+=`
`,t+=`    vec3 ox13 = fract(p13*K) - Ko;
`,t+=`    vec3 oy13 = mod(floor(p13*K), 7.0)*K - Ko;
`,t+=`    vec3 oz13 = floor(p13*K2)*Kz - Kzo;
`,t+=`
`,t+=`    vec3 ox21 = fract(p21*K) - Ko;
`,t+=`    vec3 oy21 = mod(floor(p21*K), 7.0)*K - Ko;
`,t+=`    vec3 oz21 = floor(p21*K2)*Kz - Kzo;
`,t+=`
`,t+=`    vec3 ox22 = fract(p22*K) - Ko;
`,t+=`    vec3 oy22 = mod(floor(p22*K), 7.0)*K - Ko;
`,t+=`    vec3 oz22 = floor(p22*K2)*Kz - Kzo;
`,t+=`
`,t+=`    vec3 ox23 = fract(p23*K) - Ko;
`,t+=`    vec3 oy23 = mod(floor(p23*K), 7.0)*K - Ko;
`,t+=`    vec3 oz23 = floor(p23*K2)*Kz - Kzo;
`,t+=`
`,t+=`    vec3 ox31 = fract(p31*K) - Ko;
`,t+=`    vec3 oy31 = mod(floor(p31*K), 7.0)*K - Ko;
`,t+=`    vec3 oz31 = floor(p31*K2)*Kz - Kzo;
`,t+=`
`,t+=`    vec3 ox32 = fract(p32*K) - Ko;
`,t+=`    vec3 oy32 = mod(floor(p32*K), 7.0)*K - Ko;
`,t+=`    vec3 oz32 = floor(p32*K2)*Kz - Kzo;
`,t+=`
`,t+=`    vec3 ox33 = fract(p33*K) - Ko;
`,t+=`    vec3 oy33 = mod(floor(p33*K), 7.0)*K - Ko;
`,t+=`    vec3 oz33 = floor(p33*K2)*Kz - Kzo;
`,t+=`
`,t+=`    vec3 dx11 = Pfx + jitter*ox11;
`,t+=`    vec3 dy11 = Pfy.x + jitter*oy11;
`,t+=`    vec3 dz11 = Pfz.x + jitter*oz11;
`,t+=`
`,t+=`    vec3 dx12 = Pfx + jitter*ox12;
`,t+=`    vec3 dy12 = Pfy.x + jitter*oy12;
`,t+=`    vec3 dz12 = Pfz.y + jitter*oz12;
`,t+=`
`,t+=`    vec3 dx13 = Pfx + jitter*ox13;
`,t+=`    vec3 dy13 = Pfy.x + jitter*oy13;
`,t+=`    vec3 dz13 = Pfz.z + jitter*oz13;
`,t+=`
`,t+=`    vec3 dx21 = Pfx + jitter*ox21;
`,t+=`    vec3 dy21 = Pfy.y + jitter*oy21;
`,t+=`    vec3 dz21 = Pfz.x + jitter*oz21;
`,t+=`
`,t+=`    vec3 dx22 = Pfx + jitter*ox22;
`,t+=`    vec3 dy22 = Pfy.y + jitter*oy22;
`,t+=`    vec3 dz22 = Pfz.y + jitter*oz22;
`,t+=`
`,t+=`    vec3 dx23 = Pfx + jitter*ox23;
`,t+=`    vec3 dy23 = Pfy.y + jitter*oy23;
`,t+=`    vec3 dz23 = Pfz.z + jitter*oz23;
`,t+=`
`,t+=`    vec3 dx31 = Pfx + jitter*ox31;
`,t+=`    vec3 dy31 = Pfy.z + jitter*oy31;
`,t+=`    vec3 dz31 = Pfz.x + jitter*oz31;
`,t+=`
`,t+=`    vec3 dx32 = Pfx + jitter*ox32;
`,t+=`    vec3 dy32 = Pfy.z + jitter*oy32;
`,t+=`    vec3 dz32 = Pfz.y + jitter*oz32;
`,t+=`
`,t+=`    vec3 dx33 = Pfx + jitter*ox33;
`,t+=`    vec3 dy33 = Pfy.z + jitter*oy33;
`,t+=`    vec3 dz33 = Pfz.z + jitter*oz33;
`,t+=`
`,t+=`    vec3 d11 = dist(dx11, dy11, dz11, manhattanDistance);
`,t+=`    vec3 d12 = dist(dx12, dy12, dz12, manhattanDistance);
`,t+=`    vec3 d13 = dist(dx13, dy13, dz13, manhattanDistance);
`,t+=`    vec3 d21 = dist(dx21, dy21, dz21, manhattanDistance);
`,t+=`    vec3 d22 = dist(dx22, dy22, dz22, manhattanDistance);
`,t+=`    vec3 d23 = dist(dx23, dy23, dz23, manhattanDistance);
`,t+=`    vec3 d31 = dist(dx31, dy31, dz31, manhattanDistance);
`,t+=`    vec3 d32 = dist(dx32, dy32, dz32, manhattanDistance);
`,t+=`    vec3 d33 = dist(dx33, dy33, dz33, manhattanDistance);
`,t+=`
`,t+=`    vec3 d1a = min(d11, d12);
`,t+=`    d12 = max(d11, d12);
`,t+=`    d11 = min(d1a, d13); // Smallest now not in d12 or d13
`,t+=`    d13 = max(d1a, d13);
`,t+=`    d12 = min(d12, d13); // 2nd smallest now not in d13
`,t+=`    vec3 d2a = min(d21, d22);
`,t+=`    d22 = max(d21, d22);
`,t+=`    d21 = min(d2a, d23); // Smallest now not in d22 or d23
`,t+=`    d23 = max(d2a, d23);
`,t+=`    d22 = min(d22, d23); // 2nd smallest now not in d23
`,t+=`    vec3 d3a = min(d31, d32);
`,t+=`    d32 = max(d31, d32);
`,t+=`    d31 = min(d3a, d33); // Smallest now not in d32 or d33
`,t+=`    d33 = max(d3a, d33);
`,t+=`    d32 = min(d32, d33); // 2nd smallest now not in d33
`,t+=`    vec3 da = min(d11, d21);
`,t+=`    d21 = max(d11, d21);
`,t+=`    d11 = min(da, d31); // Smallest now in d11
`,t+=`    d31 = max(da, d31); // 2nd smallest now not in d31
`,t+=`    if (d11.x >= d11.y) { vec2 temp = d11.yx; d11.x = temp.x; d11.y = temp.y; }
`,t+=`    if (d11.x >= d11.z) { vec2 temp = d11.zx; d11.x = temp.x; d11.z = temp.y; }
`,t+=`    d12 = min(d12, d21); // 2nd smallest now not in d21
`,t+=`    d12 = min(d12, d22); // nor in d22
`,t+=`    d12 = min(d12, d31); // nor in d31
`,t+=`    d12 = min(d12, d32); // nor in d32
`,t+=`    vec2 temp2 = min(d11.yz, d12.xy); // nor in d12.yz
`,t+=`    d11.y = temp2.x;
`,t+=`    d11.z = temp2.y;
`,t+=`    d11.y = min(d11.y, d12.z); // Only two more to go
`,t+=`    d11.y = min(d11.y, d11.z); // Done! (Phew!)
`,t+=`    return sqrt(d11.xy); // F1, F2
`,t+=`}

`,e.shaderLanguage===1?t=e._babylonSLtoWGSL(t):t=e._babylonSLtoGLSL(t),e._emitFunction("worley3D",t,"// Worley3D");const i=e._getFreeVariableName("worleyTemp");return e.compilationString+=`${e._declareLocalVar(i,p.Vector2)} = worley(${this.seed.associatedVariableName}, ${this.jitter.associatedVariableName}, ${this.manhattanDistance});
`,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${i};
`),this.x.hasEndpoints&&(e.compilationString+=e._declareOutput(this.x)+` = ${i}.x;
`),this.y.hasEndpoints&&(e.compilationString+=e._declareOutput(this.y)+` = ${i}.y;
`),this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.manhattanDistance = ${this.manhattanDistance};
`}serialize(){const e=super.serialize();return e.manhattanDistance=this.manhattanDistance,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.manhattanDistance=e.manhattanDistance}}_([O("Use Manhattan Distance",0,"PROPERTIES",{embedded:!0,notifiers:{update:!1}})],JA.prototype,"manhattanDistance",void 0);y("BABYLON.WorleyNoise3DBlock",JA);class Zz extends ie{constructor(e){super(e,P.Neutral),this.registerInput("seed",p.Vector3),this.registerOutput("output",p.Float)}getClassName(){return"SimplexPerlin3DBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected||!this._outputs[0].hasEndpoints)return;let t=`const float SKEWFACTOR = 1.0/3.0;
`;return t+=`const float UNSKEWFACTOR = 1.0/6.0;
`,t+=`const float SIMPLEX_CORNER_POS = 0.5;
`,t+=`const float SIMPLEX_TETRAHADRON_HEIGHT = 0.70710678118654752440084436210485;
`,t+=`float SimplexPerlin3D( vec3 source ){
`,t+=`    vec3 P = source;
`,t+=`    P.x = [P.x == 0. && P.y == 0. && P.z == 0. ? 0.00001 : P.x];
`,t+=`    P *= SIMPLEX_TETRAHADRON_HEIGHT;
`,t+="    vec3 Pi = floor( P + dot( P, vec3( SKEWFACTOR) ) );",t+=`    vec3 x0 = P - Pi + dot(Pi, vec3( UNSKEWFACTOR ) );
`,t+=`    vec3 g = step(x0.yzx, x0.xyz);
`,t+=`    vec3 l = 1.0 - g;
`,t+=`    vec3 Pi_1 = min( g.xyz, l.zxy );
`,t+=`    vec3 Pi_2 = max( g.xyz, l.zxy );
`,t+=`    vec3 x1 = x0 - Pi_1 + UNSKEWFACTOR;
`,t+=`    vec3 x2 = x0 - Pi_2 + SKEWFACTOR;
`,t+=`    vec3 x3 = x0 - SIMPLEX_CORNER_POS;
`,t+=`    vec4 v1234_x = vec4( x0.x, x1.x, x2.x, x3.x );
`,t+=`    vec4 v1234_y = vec4( x0.y, x1.y, x2.y, x3.y );
`,t+=`    vec4 v1234_z = vec4( x0.z, x1.z, x2.z, x3.z );
`,t+=`    Pi = Pi.xyz - floor(Pi.xyz * ( 1.0 / 69.0 )) * 69.0;
`,t+=`    vec3 Pi_inc1 = step( Pi, vec3( 69.0 - 1.5 ) ) * ( Pi + 1.0 );
`,t+=`    vec4 Pt = vec4( Pi.xy, Pi_inc1.xy ) + vec2( 50.0, 161.0 ).xyxy;
`,t+=`    Pt *= Pt;
`,t+=`    vec4 V1xy_V2xy = mix( Pt.xyxy, Pt.zwzw, vec4( Pi_1.xy, Pi_2.xy ) );
`,t+=`    Pt = vec4( Pt.x, V1xy_V2xy.xz, Pt.z ) * vec4( Pt.y, V1xy_V2xy.yw, Pt.w );
`,t+=`    const vec3 SOMELARGEFLOATS = vec3( 635.298681, 682.357502, 668.926525 );
`,t+=`    const vec3 ZINC = vec3( 48.500388, 65.294118, 63.934599 );
`,t+=`    vec3 lowz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi.zzz * ZINC.xyz ) );
`,t+=`    vec3 highz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi_inc1.zzz * ZINC.xyz ) );
`,t+=`    Pi_1 = [( Pi_1.z < 0.5 ) ? lowz_mods : highz_mods];
`,t+=`    Pi_2 = [( Pi_2.z < 0.5 ) ? lowz_mods : highz_mods];
`,t+=`    vec4 hash_0 = fract( Pt * vec4( lowz_mods.x, Pi_1.x, Pi_2.x, highz_mods.x ) ) - 0.49999;
`,t+=`    vec4 hash_1 = fract( Pt * vec4( lowz_mods.y, Pi_1.y, Pi_2.y, highz_mods.y ) ) - 0.49999;
`,t+=`    vec4 hash_2 = fract( Pt * vec4( lowz_mods.z, Pi_1.z, Pi_2.z, highz_mods.z ) ) - 0.49999;
`,t+=`    vec4 grad_results = inversesqrt( hash_0 * hash_0 + hash_1 * hash_1 + hash_2 * hash_2 ) * ( hash_0 * v1234_x + hash_1 * v1234_y + hash_2 * v1234_z );
`,t+=`    const float FINAL_NORMALIZATION = 37.837227241611314102871574478976;
`,t+=`    vec4 kernel_weights = v1234_x * v1234_x + v1234_y * v1234_y + v1234_z * v1234_z;
`,t+=`    kernel_weights = max(0.5 - kernel_weights, vec4(0.));
`,t+=`    kernel_weights = kernel_weights*kernel_weights*kernel_weights;
`,t+=`    return dot( kernel_weights, grad_results ) * FINAL_NORMALIZATION;
`,t+=`}
`,e.shaderLanguage===1?t=e._babylonSLtoWGSL(t):t=e._babylonSLtoGLSL(t),e._emitFunction("SimplexPerlin3D",t,"// SimplexPerlin3D"),e.compilationString+=e._declareOutput(this._outputs[0])+` = SimplexPerlin3D(${this.seed.associatedVariableName});
`,this}}y("BABYLON.SimplexPerlin3DBlock",Zz);class Qz extends ie{constructor(e){super(e,P.Neutral),this.registerInput("normalMap0",p.AutoDetect),this.registerInput("normalMap1",p.AutoDetect),this.registerOutput("output",p.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(p.Color3|p.Color4|p.Vector3|p.Vector4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(p.Color3|p.Color4|p.Vector3|p.Vector4)}getClassName(){return"NormalBlendBlock"}get normalMap0(){return this._inputs[0]}get normalMap1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0],r=this._inputs[1],n=e._getFreeVariableName("stepR"),a=e._getFreeVariableName("stepG");return e.compilationString+=`${e._declareLocalVar(n,p.Float)} = step(0.5, ${i.associatedVariableName}.r);
`,e.compilationString+=`${e._declareLocalVar(a,p.Float)} = step(0.5, ${i.associatedVariableName}.g);
`,e.compilationString+=e._declareOutput(t)+`;
`,e.compilationString+=`${t.associatedVariableName}.r = (1.0 - ${n}) * ${i.associatedVariableName}.r * ${r.associatedVariableName}.r * 2.0 + ${n} * (1.0 - (1.0 - ${i.associatedVariableName}.r) * (1.0 - ${r.associatedVariableName}.r) * 2.0);
`,e.compilationString+=`${t.associatedVariableName}.g = (1.0 - ${a}) * ${i.associatedVariableName}.g * ${r.associatedVariableName}.g * 2.0 + ${a} * (1.0 - (1.0 - ${i.associatedVariableName}.g) * (1.0 - ${r.associatedVariableName}.g) * 2.0);
`,e.compilationString+=`${t.associatedVariableName}.b = ${i.associatedVariableName}.b * ${r.associatedVariableName}.b;
`,this}}y("BABYLON.NormalBlendBlock",Qz);class Kz extends ie{constructor(e){super(e,P.Neutral),this.registerInput("input",p.Vector2),this.registerInput("angle",p.Float),this.registerOutput("output",p.Vector2)}getClassName(){return"Rotate2dBlock"}get input(){return this._inputs[0]}get angle(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){const e=new ge("angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.angle,r=this.input;return e.compilationString+=e._declareOutput(t)+` = vec2(cos(${i.associatedVariableName}) * ${r.associatedVariableName}.x - sin(${i.associatedVariableName}) * ${r.associatedVariableName}.y, sin(${i.associatedVariableName}) * ${r.associatedVariableName}.x + cos(${i.associatedVariableName}) * ${r.associatedVariableName}.y);
`,this}}y("BABYLON.Rotate2dBlock",Kz);class Jz extends ie{constructor(e){super(e,P.Neutral),this.registerInput("incident",p.AutoDetect),this.registerInput("normal",p.AutoDetect),this.registerOutput("output",p.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(p.Vector3|p.Vector4|p.Color3|p.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(p.Vector3|p.Vector4|p.Color3|p.Color4)}getClassName(){return"ReflectBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = reflect(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz);
`,this}}y("BABYLON.ReflectBlock",Jz);class e4 extends ie{constructor(e){super(e,P.Neutral),this.registerInput("incident",p.AutoDetect),this.registerInput("normal",p.AutoDetect),this.registerInput("ior",p.Float),this.registerOutput("output",p.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(p.Vector3|p.Vector4|p.Color3|p.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(p.Vector3|p.Vector4|p.Color3|p.Color4)}getClassName(){return"RefractBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get ior(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = refract(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz, ${this.ior.associatedVariableName});
`,this}}y("BABYLON.RefractBlock",e4);class t4 extends ie{constructor(e){super(e,P.Neutral),this.registerInput("color",p.Color3),this.registerInput("level",p.Float),this.registerOutput("output",p.Color3)}getClassName(){return"DesaturateBlock"}get color(){return this._inputs[0]}get level(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],r=this.color.associatedVariableName,n=e._getFreeVariableName("colorMin"),a=e._getFreeVariableName("colorMax"),o=e._getFreeVariableName("colorMerge");return e.compilationString+=`${e._declareLocalVar(n,p.Float)} = min(min(${r}.x, ${r}.y), ${r}.z);
`,e.compilationString+=`${e._declareLocalVar(a,p.Float)} = max(max(${r}.x, ${r}.y), ${r}.z);
`,e.compilationString+=`${e._declareLocalVar(o,p.Float)} = 0.5 * (${n} + ${a});
`,e.compilationString+=e._declareOutput(t)+` = mix(${r}, ${e._getShaderType(p.Vector3)}(${o}, ${o}, ${o}), ${this.level.associatedVariableName});
`,this}}y("BABYLON.DesaturateBlock",t4);class Qo extends ie{constructor(e){super(e,P.Fragment),this.albedoScaling=!1,this.linkSheenWithAlbedo=!1,this._isUnique=!0,this.registerInput("intensity",p.Float,!0,P.Fragment),this.registerInput("color",p.Color3,!0,P.Fragment),this.registerInput("roughness",p.Float,!0,P.Fragment),this.registerOutput("sheen",p.Object,P.Fragment,new at("sheen",this,1,Qo,"SheenBlock"))}initialize(e){e._excludeVariableName("sheenOut"),e._excludeVariableName("sheenMapData"),e._excludeVariableName("vSheenColor"),e._excludeVariableName("vSheenRoughness")}getClassName(){return"SheenBlock"}get intensity(){return this._inputs[0]}get color(){return this._inputs[1]}get roughness(){return this._inputs[2]}get sheen(){return this._outputs[0]}prepareDefines(e){e.setValue("SHEEN",!0),e.setValue("SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),e.setValue("SHEEN_LINKWITHALBEDO",this.linkSheenWithAlbedo,!0),e.setValue("SHEEN_ROUGHNESS",this.roughness.isConnected,!0),e.setValue("SHEEN_ALBEDOSCALING",this.albedoScaling,!0)}getCode(e,t){let i="";const r=this.color.isConnected?this.color.associatedVariableName:`vec3${t.fSuffix}(1.)`,n=this.intensity.isConnected?this.intensity.associatedVariableName:"1.",a=this.roughness.isConnected?this.roughness.associatedVariableName:"0.",o=`vec4${t.fSuffix}(0.)`,l=t.shaderLanguage===1;return i=`#ifdef SHEEN
            ${l?"var sheenOut: sheenOutParams":"sheenOutParams sheenOut"};

            ${t._declareLocalVar("vSheenColor",p.Vector4)} = vec4${t.fSuffix}(${r}, ${n});

            sheenOut = sheenBlock(
                vSheenColor
            #ifdef SHEEN_ROUGHNESS
                , ${a}
            #endif
                , roughness
            #ifdef SHEEN_TEXTURE
                , ${o}
                ${l?`, ${o}Sampler`:""}
                , 1.0
            #endif
                , reflectanceF0
            #ifdef SHEEN_LINKWITHALBEDO
                , baseColor
                , surfaceAlbedo
            #endif
            #ifdef ENVIRONMENTBRDF
                , NdotV
                , environmentBrdf
            #endif
            #if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
                , AARoughnessFactors
                , ${l?"uniforms.":""}${e==null?void 0:e._vReflectionMicrosurfaceInfosName}
                , ${e==null?void 0:e._vReflectionInfosName}
                , ${e==null?void 0:e.reflectionColor}
                , ${l?"uniforms.":""}vLightingIntensity
                #ifdef ${e==null?void 0:e._define3DName}
                    , ${e==null?void 0:e._cubeSamplerName}                                      
                    ${l?`, ${e==null?void 0:e._cubeSamplerName}Sampler`:""}
                #else
                    , ${e==null?void 0:e._2DSamplerName}
                    ${l?`, ${e==null?void 0:e._2DSamplerName}Sampler`:""}
                #endif
                , reflectionOut.reflectionCoords
                , NdotVUnclamped
                #ifndef LODBASEDMICROSFURACE
                    #ifdef ${e==null?void 0:e._define3DName}
                        , ${e==null?void 0:e._cubeSamplerName}                        
                        ${l?`, ${e==null?void 0:e._cubeSamplerName}Sampler`:""}
                        , ${e==null?void 0:e._cubeSamplerName}
                        ${l?`, ${e==null?void 0:e._cubeSamplerName}Sampler`:""}
                    #else
                        , ${e==null?void 0:e._2DSamplerName}
                        ${l?`, ${e==null?void 0:e._2DSamplerName}Sampler`:""}
                        , ${e==null?void 0:e._2DSamplerName}
                        ${l?`, ${e==null?void 0:e._2DSamplerName}Sampler`:""}
                    #endif
                #endif
                #if !defined(${e==null?void 0:e._defineSkyboxName}) && defined(RADIANCEOCCLUSION)
                    , seo
                #endif
                #if !defined(${e==null?void 0:e._defineSkyboxName}) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(${e==null?void 0:e._define3DName})
                    , eho
                #endif
            #endif
            );

            #ifdef SHEEN_LINKWITHALBEDO
                surfaceAlbedo = sheenOut.surfaceAlbedo;
            #endif
        #endif
`,i}_buildBlock(e){return e.target===P.Fragment&&e.sharedData.blocksWithDefines.push(this),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.albedoScaling = ${this.albedoScaling};
`,e+=`${this._codeVariableName}.linkSheenWithAlbedo = ${this.linkSheenWithAlbedo};
`,e}serialize(){const e=super.serialize();return e.albedoScaling=this.albedoScaling,e.linkSheenWithAlbedo=this.linkSheenWithAlbedo,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.albedoScaling=e.albedoScaling,this.linkSheenWithAlbedo=e.linkSheenWithAlbedo}}_([O("Albedo scaling",0,"PROPERTIES",{embedded:!0,notifiers:{update:!0}})],Qo.prototype,"albedoScaling",void 0);_([O("Link sheen with albedo",0,"PROPERTIES",{embedded:!0,notifiers:{update:!0}})],Qo.prototype,"linkSheenWithAlbedo",void 0);y("BABYLON.SheenBlock",Qo);class Ah extends ie{constructor(e){super(e,P.Fragment),this._tangentCorrectionFactorName="",this._isUnique=!0,this.registerInput("intensity",p.Float,!0,P.Fragment),this.registerInput("direction",p.Vector2,!0,P.Fragment),this.registerInput("uv",p.Vector2,!0),this.registerInput("worldTangent",p.Vector4,!0),this.registerInput("TBN",p.Object,!0,P.VertexAndFragment,new at("TBN",this,0,Zo,"TBNBlock")),this.registerInput("roughness",p.Float,!0,P.Fragment),this.registerOutput("anisotropy",p.Object,P.Fragment,new at("anisotropy",this,1,Ah,"AnisotropyBlock"))}initialize(e){e._excludeVariableName("anisotropicOut"),e._excludeVariableName("TBN")}getClassName(){return"AnisotropyBlock"}get intensity(){return this._inputs[0]}get direction(){return this._inputs[1]}get uv(){return this._inputs[2]}get worldTangent(){return this._inputs[3]}get TBN(){return this._inputs[4]}get roughness(){return this._inputs[5]}get anisotropy(){return this._outputs[0]}_generateTBNSpace(e){let t="";const i=`//${this.name}`,r=this.uv,n=this.worldPositionConnectionPoint,a=this.worldNormalConnectionPoint,o=this.worldTangent,l=e.shaderLanguage===1;r.isConnected||e.sharedData.raiseBuildError(`You must connect the 'uv' input of the ${this.name} block!`),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const c={search:/defined\(TANGENT\)/g,replace:o.isConnected?"defined(TANGENT)":"defined(IGNORE)"},u=this.TBN;return u.isConnected?e.compilationString+=`
            #ifdef TBNBLOCK
            ${l?"var TBN":"mat3 TBN"} = ${u.associatedVariableName};
            #endif
            `:o.isConnected&&(t+=`${e._declareLocalVar("tbnNormal",p.Vector3)} = normalize(${a.associatedVariableName}.xyz);
`,t+=`${e._declareLocalVar("tbnTangent",p.Vector3)} = normalize(${o.associatedVariableName}.xyz);
`,t+=`${e._declareLocalVar("tbnBitangent",p.Vector3)} = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};
`,t+=`${l?"var vTBN":"mat3 vTBN"} = ${l?"mat3x3f":"mat3"}(tbnTangent, tbnBitangent, tbnNormal);
`),t+=`
            #if defined(${o.isConnected?"TANGENT":"IGNORE"}) && defined(NORMAL)
                ${l?"var TBN":"mat3 TBN"} = vTBN;
            #else
                ${l?"var TBN":"mat3 TBN"} = cotangent_frame(${a.associatedVariableName+".xyz"}, ${"v_"+n.associatedVariableName+".xyz"}, ${r.isConnected?r.associatedVariableName:"vec2(0.)"}, vec2${e.fSuffix}(1., 1.));
            #endif
`,e._emitFunctionFromInclude("bumpFragmentMainFunctions",i,{replaceStrings:[c]}),t}getCode(e,t=!1){let i="";t&&(i+=this._generateTBNSpace(e));const r=e.shaderLanguage===1,n=this.intensity.isConnected?this.intensity.associatedVariableName:"1.0",a=this.direction.isConnected?this.direction.associatedVariableName:"vec2(1., 0.)",o=this.roughness.isConnected?this.roughness.associatedVariableName:"0.";return i+=`${r?"var anisotropicOut: anisotropicOutParams":"anisotropicOutParams anisotropicOut"};
            anisotropicOut = anisotropicBlock(
                vec3(${a}, ${n}),
                ${o},
            #ifdef ANISOTROPIC_TEXTURE
                vec3(0.),
            #endif
                TBN,
                normalW,
                viewDirectionW
            );
`,i}prepareDefines(e){e.setValue("ANISOTROPIC",!0),e.setValue("ANISOTROPIC_TEXTURE",!1,!0),e.setValue("ANISOTROPIC_LEGACY",!this.roughness.isConnected)}bind(e,t,i){super.bind(e,t,i),i&&e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1)}_buildBlock(e){return e.target===P.Fragment&&(e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,p.Float)),this}}y("BABYLON.AnisotropyBlock",Ah);class Ko extends Ul{_onGenerateOnlyFragmentCodeChanged(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,N.Error("The position input must not be connected to be able to switch!"),!1):(this._setTarget(),!0)}_setTarget(){super._setTarget(),this.getInputByName("position").target=this.generateOnlyFragmentCode?P.Fragment:P.Vertex,this.generateOnlyFragmentCode&&(this.forceIrradianceInFragment=!0)}constructor(e){super(e),this.useSphericalHarmonics=!0,this.forceIrradianceInFragment=!1,this._isUnique=!0,this.registerInput("position",p.AutoDetect,!1,P.Vertex),this.registerInput("world",p.Matrix,!1,P.Vertex),this.registerInput("color",p.Color3,!0,P.Fragment),this.registerOutput("reflection",p.Object,P.Fragment,new at("reflection",this,1,Ko,"ReflectionBlock")),this.position.addExcludedConnectionPointFromAllowedTypes(p.Color3|p.Vector3|p.Vector4)}getClassName(){return"ReflectionBlock"}get position(){return this._inputs[0]}get worldPosition(){return this.worldPositionConnectionPoint}get worldNormal(){return this.worldNormalConnectionPoint}get world(){return this._inputs[1]}get cameraPosition(){return this.cameraPositionConnectionPoint}get view(){return this.viewConnectionPoint}get color(){return this._inputs[2]}get reflection(){return this._outputs[0]}get hasTexture(){return!!this._getTexture()}get reflectionColor(){return this.color.isConnected?this.color.associatedVariableName:"vec3(1., 1., 1.)"}_getTexture(){return this.texture?this.texture:this._scene.environmentTexture}prepareDefines(e){super.prepareDefines(e);const t=this._getTexture(),i=t&&t.getTextureMatrix;e.setValue("REFLECTION",i,!0),i&&(e.setValue(this._defineLODReflectionAlpha,t.lodLevelInAlpha,!0),e.setValue(this._defineLinearSpecularReflection,t.linearSpecularLOD,!0),e.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem?!t.invertZ:t.invertZ,!0),e.setValue("SPHERICAL_HARMONICS",this.useSphericalHarmonics,!0),e.setValue("GAMMAREFLECTION",t.gammaSpace,!0),e.setValue("RGBDREFLECTION",t.isRGBD,!0),t&&t.coordinatesMode!==$.SKYBOX_MODE&&t.isCube&&(e.setValue("USESPHERICALFROMREFLECTIONMAP",!0),e.setValue("USEIRRADIANCEMAP",!1),this.forceIrradianceInFragment||this._scene.getEngine().getCaps().maxVaryingVectors<=8?e.setValue("USESPHERICALINVERTEX",!1):e.setValue("USESPHERICALINVERTEX",!0)))}bind(e,t,i,r){super.bind(e,t,i);const n=this._getTexture();if(!n||!r)return;n.isCube?e.setTexture(this._cubeSamplerName,n):e.setTexture(this._2DSamplerName,n),e.setFloat(this._iblIntensityName,this._scene.iblIntensity*n.level);const a=n.getSize().width;e.setFloat3(this._vReflectionMicrosurfaceInfosName,a,n.lodGenerationScale,n.lodGenerationOffset),e.setFloat2(this._vReflectionFilteringInfoName,a,Math.log2(a));const o=r.materialDefines,l=n.sphericalPolynomial;if(o.USESPHERICALFROMREFLECTIONMAP&&l)if(o.SPHERICAL_HARMONICS){const c=l.preScaledHarmonics;e.setVector3("vSphericalL00",c.l00),e.setVector3("vSphericalL1_1",c.l1_1),e.setVector3("vSphericalL10",c.l10),e.setVector3("vSphericalL11",c.l11),e.setVector3("vSphericalL2_2",c.l2_2),e.setVector3("vSphericalL2_1",c.l2_1),e.setVector3("vSphericalL20",c.l20),e.setVector3("vSphericalL21",c.l21),e.setVector3("vSphericalL22",c.l22)}else e.setFloat3("vSphericalX",l.x.x,l.x.y,l.x.z),e.setFloat3("vSphericalY",l.y.x,l.y.y,l.y.z),e.setFloat3("vSphericalZ",l.z.x,l.z.y,l.z.z),e.setFloat3("vSphericalXX_ZZ",l.xx.x-l.zz.x,l.xx.y-l.zz.y,l.xx.z-l.zz.z),e.setFloat3("vSphericalYY_ZZ",l.yy.x-l.zz.x,l.yy.y-l.zz.y,l.yy.z-l.zz.z),e.setFloat3("vSphericalZZ",l.zz.x,l.zz.y,l.zz.z),e.setFloat3("vSphericalXY",l.xy.x,l.xy.y,l.xy.z),e.setFloat3("vSphericalYZ",l.yz.x,l.yz.y,l.yz.z),e.setFloat3("vSphericalZX",l.zx.x,l.zx.y,l.zx.z)}handleVertexSide(e){let t=super.handleVertexSide(e);const i=e.shaderLanguage===1;e._emitFunctionFromInclude("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]});const r=e._getFreeVariableName("reflectionVector");return this._vEnvironmentIrradianceName=e._getFreeVariableName("vEnvironmentIrradiance"),e._emitVaryingFromString(this._vEnvironmentIrradianceName,p.Vector3,"defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)"),e._emitUniformFromString("vSphericalL00",p.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL1_1",p.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL10",p.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL11",p.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_2",p.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_1",p.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL20",p.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL21",p.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL22",p.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalX",p.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalY",p.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZ",p.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXX_ZZ",p.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYY_ZZ",p.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZZ",p.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXY",p.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYZ",p.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZX",p.Vector3,"SPHERICAL_HARMONICS",!0),t+=`#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
                ${e._declareLocalVar(r,p.Vector3)} = (${(i?"uniforms.":"")+this._reflectionMatrixName} * vec4${e.fSuffix}(normalize(${this.worldNormal.associatedVariableName}).xyz, 0)).xyz;
                #ifdef ${this._defineOppositeZ}
                    ${r}.z *= -1.0;
                #endif
                ${i?"vertexOutputs.":""}${this._vEnvironmentIrradianceName} = computeEnvironmentIrradiance(${r});
            #endif
`,t}getCode(e,t){let i="";this.handleFragmentSideInits(e);const r=e.shaderLanguage===1;e._emitFunctionFromInclude("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]}),r||(e._emitFunction("sampleReflection",`
                #ifdef ${this._define3DName}
                    #define sampleReflection(s, c) textureCube(s, c)
                #else
                    #define sampleReflection(s, c) texture2D(s, c)
                #endif
`,`//${this.name}`),e._emitFunction("sampleReflectionLod",`
                #ifdef ${this._define3DName}
                    #define sampleReflectionLod(s, c, l) textureCubeLodEXT(s, c, l)
                #else
                    #define sampleReflectionLod(s, c, l) texture2DLodEXT(s, c, l)
                #endif
`,`//${this.name}`));const n=r?`
            fn computeReflectionCoordsPBR(worldPos: vec4f, worldNormal: vec3f) -> vec3f {
                ${this.handleFragmentSideCodeReflectionCoords(e,"worldNormal","worldPos",!0,!0)}
                return ${this._reflectionVectorName};
            }
`:`
            vec3 computeReflectionCoordsPBR(vec4 worldPos, vec3 worldNormal) {
                ${this.handleFragmentSideCodeReflectionCoords(e,"worldNormal","worldPos",!0,!0)}
                return ${this._reflectionVectorName};
            }
`;return e._emitFunction("computeReflectionCoordsPBR",n,`//${this.name}`),this._vReflectionMicrosurfaceInfosName=e._getFreeVariableName("vReflectionMicrosurfaceInfos"),e._emitUniformFromString(this._vReflectionMicrosurfaceInfosName,p.Vector3),this._vReflectionInfosName=e._getFreeVariableName("vReflectionInfos"),this._vReflectionFilteringInfoName=e._getFreeVariableName("vReflectionFilteringInfo"),e._emitUniformFromString(this._vReflectionFilteringInfoName,p.Vector2),this._iblIntensityName=e._getFreeVariableName("iblIntensity"),e._emitUniformFromString(this._iblIntensityName,p.Float),i+=`#ifdef REFLECTION
            ${e._declareLocalVar(this._vReflectionInfosName,p.Vector2)} = vec2${e.fSuffix}(${(r?"uniforms.":"")+this._iblIntensityName}, 0.);

            ${r?"var reflectionOut: reflectionOutParams":"reflectionOutParams reflectionOut"};

            reflectionOut = reflectionBlock(
                ${this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:(r?"input.":"")+"v_"+this.worldPosition.associatedVariableName}.xyz
                , ${t}
                , alphaG
                , ${(r?"uniforms.":"")+this._vReflectionMicrosurfaceInfosName}
                , ${this._vReflectionInfosName}
                , ${this.reflectionColor}
            #ifdef ANISOTROPIC
                ,anisotropicOut
            #endif
            #if defined(${this._defineLODReflectionAlpha}) && !defined(${this._defineSkyboxName})
                ,NdotVUnclamped
            #endif
            #ifdef ${this._defineLinearSpecularReflection}
                , roughness
            #endif
            #ifdef ${this._define3DName}
                , ${this._cubeSamplerName}
                ${r?`, ${this._cubeSamplerName}Sampler`:""}
            #else
                , ${this._2DSamplerName}
                ${r?`, ${this._2DSamplerName}Sampler`:""}
            #endif
            #if defined(NORMAL) && defined(USESPHERICALINVERTEX)
                , ${r?"input.":""}${this._vEnvironmentIrradianceName}
            #endif
            #if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
                    , ${this._reflectionMatrixName}
            #endif
            #ifdef USEIRRADIANCEMAP
                , irradianceSampler         // ** not handled **
                ${r?", irradianceSamplerSampler":""}
                #ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
                , vReflectionDominantDirection
                #endif
            #endif
            #ifndef LODBASEDMICROSFURACE
                #ifdef ${this._define3DName}
                    , ${this._cubeSamplerName}
                    ${r?`, ${this._cubeSamplerName}Sampler`:""}
                    , ${this._cubeSamplerName}
                    ${r?`, ${this._cubeSamplerName}Sampler`:""}
                #else
                    , ${this._2DSamplerName}
                    ${r?`, ${this._2DSamplerName}Sampler`:""}
                    , ${this._2DSamplerName}                    
                    ${r?`, ${this._2DSamplerName}Sampler`:""}
                #endif
            #endif
            #ifdef REALTIME_FILTERING
                , ${this._vReflectionFilteringInfoName}
                #ifdef IBL_CDF_FILTERING
                    , icdfSampler         // ** not handled **
                    ${r?", icdfSamplerSampler":""}
                #endif
            #endif
            , viewDirectionW
            , diffuseRoughness
            , surfaceAlbedo
            );
        #endif
`,i}_buildBlock(e){return this._scene=e.sharedData.scene,e.target!==P.Fragment&&(this._defineLODReflectionAlpha=e._getFreeDefineName("LODINREFLECTIONALPHA"),this._defineLinearSpecularReflection=e._getFreeDefineName("LINEARSPECULARREFLECTION")),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e+=`${this._codeVariableName}.texture.gammaSpace = ${this.texture.gammaSpace};
`),e+=`${this._codeVariableName}.useSphericalHarmonics = ${this.useSphericalHarmonics};
`,e+=`${this._codeVariableName}.forceIrradianceInFragment = ${this.forceIrradianceInFragment};
`,e}serialize(){var t;const e=super.serialize();return e.useSphericalHarmonics=this.useSphericalHarmonics,e.forceIrradianceInFragment=this.forceIrradianceInFragment,e.gammaSpace=((t=this.texture)==null?void 0:t.gammaSpace)??!0,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.useSphericalHarmonics=e.useSphericalHarmonics,this.forceIrradianceInFragment=e.forceIrradianceInFragment,this.texture&&(this.texture.gammaSpace=e.gammaSpace)}}_([O("Spherical Harmonics",0,"ADVANCED",{embedded:!0,notifiers:{update:!0}})],Ko.prototype,"useSphericalHarmonics",void 0);_([O("Force irradiance in fragment",0,"ADVANCED",{embedded:!0,notifiers:{update:!0}})],Ko.prototype,"forceIrradianceInFragment",void 0);y("BABYLON.ReflectionBlock",Ko);class xa extends ie{constructor(e){super(e,P.Fragment),this._tangentCorrectionFactorName="",this.remapF0OnInterfaceChange=!0,this._isUnique=!0,this.registerInput("intensity",p.Float,!1,P.Fragment),this.registerInput("roughness",p.Float,!0,P.Fragment),this.registerInput("indexOfRefraction",p.Float,!0,P.Fragment),this.registerInput("normalMapColor",p.Color3,!0,P.Fragment),this.registerInput("uv",p.Vector2,!0,P.Fragment),this.registerInput("tintColor",p.Color3,!0,P.Fragment),this.registerInput("tintAtDistance",p.Float,!0,P.Fragment),this.registerInput("tintThickness",p.Float,!0,P.Fragment),this.registerInput("worldTangent",p.Vector4,!0),this.registerInput("worldNormal",p.AutoDetect,!0),this.worldNormal.addExcludedConnectionPointFromAllowedTypes(p.Color4|p.Vector4|p.Vector3),this.registerInput("TBN",p.Object,!0,P.VertexAndFragment,new at("TBN",this,0,Zo,"TBNBlock")),this.registerOutput("clearcoat",p.Object,P.Fragment,new at("clearcoat",this,1,xa,"ClearCoatBlock"))}initialize(e){e._excludeVariableName("clearcoatOut"),e._excludeVariableName("vClearCoatParams"),e._excludeVariableName("vClearCoatTintParams"),e._excludeVariableName("vClearCoatRefractionParams"),e._excludeVariableName("vClearCoatTangentSpaceParams"),e._excludeVariableName("vGeometricNormaClearCoatW")}getClassName(){return"ClearCoatBlock"}get intensity(){return this._inputs[0]}get roughness(){return this._inputs[1]}get indexOfRefraction(){return this._inputs[2]}get normalMapColor(){return this._inputs[3]}get uv(){return this._inputs[4]}get tintColor(){return this._inputs[5]}get tintAtDistance(){return this._inputs[6]}get tintThickness(){return this._inputs[7]}get worldTangent(){return this._inputs[8]}get worldNormal(){return this._inputs[9]}get TBN(){return this._inputs[10]}get clearcoat(){return this._outputs[0]}autoConfigure(){if(!this.intensity.isConnected){const e=new ge("ClearCoat intensity",P.Fragment,p.Float);e.value=1,e.output.connectTo(this.intensity)}}prepareDefines(e){e.setValue("CLEARCOAT",!0),e.setValue("CLEARCOAT_TEXTURE",!1,!0),e.setValue("CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),e.setValue("CLEARCOAT_TINT",this.tintColor.isConnected||this.tintThickness.isConnected||this.tintAtDistance.isConnected,!0),e.setValue("CLEARCOAT_BUMP",this.normalMapColor.isConnected,!0),e.setValue("CLEARCOAT_DEFAULTIOR",this.indexOfRefraction.isConnected?this.indexOfRefraction.connectInputBlock.value===hi._DefaultIndexOfRefraction:!0,!0),e.setValue("CLEARCOAT_REMAP_F0",this.remapF0OnInterfaceChange,!0)}bind(e,t,i){var h;super.bind(e,t,i);const r=((h=this.indexOfRefraction.connectInputBlock)==null?void 0:h.value)??hi._DefaultIndexOfRefraction,n=1-r,a=1+r,o=Math.pow(-n/a,2),l=1/r;e.setFloat4("vClearCoatRefractionParams",o,l,n,a);const c=this.clearcoat.hasEndpoints?this.clearcoat.endpoints[0].ownerBlock:null,u=c!=null&&c.perturbedNormal.isConnected?c.perturbedNormal.connectedPoint.ownerBlock:null;this._scene._mirroredCameraPosition?e.setFloat2("vClearCoatTangentSpaceParams",u!=null&&u.invertX?1:-1,u!=null&&u.invertY?1:-1):e.setFloat2("vClearCoatTangentSpaceParams",u!=null&&u.invertX?-1:1,u!=null&&u.invertY?-1:1),i&&e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1)}_generateTBNSpace(e,t,i){let r="";const n=`//${this.name}`,a=this.worldTangent,o=e.shaderLanguage===1;o||e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const l={search:/defined\(TANGENT\)/g,replace:a.isConnected?"defined(TANGENT)":"defined(IGNORE)"},c=this.TBN;return c.isConnected?e.compilationString+=`
            #ifdef TBNBLOCK
                ${o?"var TBN":"mat3 TBN"} = ${c.associatedVariableName};
            #endif
            `:a.isConnected&&(r+=`${e._declareLocalVar("tbnNormal",p.Vector3)} = normalize(${i}.xyz);
`,r+=`${e._declareLocalVar("tbnTangent",p.Vector3)} = normalize(${a.associatedVariableName}.xyz);
`,r+=`${e._declareLocalVar("tbnBitangent",p.Vector3)} = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};
`,r+=`${o?"var vTBN":"mat3 vTBN"} = ${o?"mat3x3f":"mat3"}(tbnTangent, tbnBitangent, tbnNormal);
`),e._emitFunctionFromInclude("bumpFragmentMainFunctions",n,{replaceStrings:[l]}),r}static _GetInitializationCode(e,t){let i="";const r=t!=null&&t.intensity.isConnected?t.intensity.associatedVariableName:"1.",n=t!=null&&t.roughness.isConnected?t.roughness.associatedVariableName:"0.",a=t!=null&&t.tintColor.isConnected?t.tintColor.associatedVariableName:`vec3${e.fSuffix}(1.)`,o=t!=null&&t.tintThickness.isConnected?t.tintThickness.associatedVariableName:"1.";return i+=`
            #ifdef CLEARCOAT
                ${e._declareLocalVar("vClearCoatParams",p.Vector2)} = vec2${e.fSuffix}(${r}, ${n});
                ${e._declareLocalVar("vClearCoatTintParams",p.Vector4)} = vec4${e.fSuffix}(${a}, ${o});
            #endif
`,i}static GetCode(e,t,i,r,n,a,o){let l="";const c=t!=null&&t.normalMapColor.isConnected?t.normalMapColor.associatedVariableName:`vec3${e.fSuffix}(0.)`,u=t!=null&&t.uv.isConnected?t.uv.associatedVariableName:`vec2${e.fSuffix}(0.)`,h=t!=null&&t.tintAtDistance.isConnected?t.tintAtDistance.associatedVariableName:"1.",d=`vec4${e.fSuffix}(0.)`;if(t){e._emitUniformFromString("vClearCoatRefractionParams",p.Vector4),e._emitUniformFromString("vClearCoatTangentSpaceParams",p.Vector2);const m=t.worldNormal;l+=`${e._declareLocalVar("vGeometricNormaClearCoatW",p.Vector3)} = ${m.isConnected?"normalize("+m.associatedVariableName+".xyz)":"geometricNormalW"};
`}else l+=`${e._declareLocalVar("vGeometricNormaClearCoatW",p.Vector3)} = geometricNormalW;
`;n&&t&&(l+=t._generateTBNSpace(e,r,o),a=t.worldTangent.isConnected);const f=e.shaderLanguage===1;return l+=`${f?"var clearcoatOut: clearcoatOutParams":"clearcoatOutParams clearcoatOut"};

        #ifdef CLEARCOAT
            clearcoatOut = clearcoatBlock(
                ${r}.xyz
                , vGeometricNormaClearCoatW
                , viewDirectionW
                , vClearCoatParams
                , specularEnvironmentR0
            #ifdef CLEARCOAT_TEXTURE
                , vec2${e.fSuffix}(0.)
            #endif
            #ifdef CLEARCOAT_TINT
                , vClearCoatTintParams
                , ${h}
                , ${f?"uniforms.":""}vClearCoatRefractionParams
                #ifdef CLEARCOAT_TINT_TEXTURE
                    , ${d}
                #endif
            #endif
            #ifdef CLEARCOAT_BUMP
                , vec2${e.fSuffix}(0., 1.)
                , vec4${e.fSuffix}(${c}, 0.)
                , ${u}
                #if defined(${a?"TANGENT":"IGNORE"}) && defined(NORMAL)
                    , vTBN
                #else
                    , ${f?"uniforms.":""}vClearCoatTangentSpaceParams
                #endif
                #ifdef OBJECTSPACE_NORMALMAP
                    , normalMatrix
                #endif
            #endif
            #if defined(FORCENORMALFORWARD) && defined(NORMAL)
                , faceNormal
            #endif
            #ifdef REFLECTION
                , ${f?"uniforms.":""}${i==null?void 0:i._vReflectionMicrosurfaceInfosName}
                , ${i==null?void 0:i._vReflectionInfosName}
                , ${i==null?void 0:i.reflectionColor}
                , ${f?"uniforms.":""}vLightingIntensity
                #ifdef ${i==null?void 0:i._define3DName}
                    , ${i==null?void 0:i._cubeSamplerName}       
                    ${f?`, ${i==null?void 0:i._cubeSamplerName}Sampler`:""}
                #else
                    , ${i==null?void 0:i._2DSamplerName}       
                    ${f?`, ${i==null?void 0:i._2DSamplerName}Sampler`:""}
                #endif
                #ifndef LODBASEDMICROSFURACE
                    #ifdef ${i==null?void 0:i._define3DName}
                        , ${i==null?void 0:i._cubeSamplerName}       
                        ${f?`, ${i==null?void 0:i._cubeSamplerName}Sampler`:""}
                        , ${i==null?void 0:i._cubeSamplerName}
                        ${f?`, ${i==null?void 0:i._cubeSamplerName}Sampler`:""}
                    #else
                        , ${i==null?void 0:i._2DSamplerName}
                        ${f?`, ${i==null?void 0:i._2DSamplerName}Sampler`:""}
                        , ${i==null?void 0:i._2DSamplerName}
                        ${f?`, ${i==null?void 0:i._2DSamplerName}Sampler`:""}                        
                    #endif
                #endif
            #endif
            #if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
                , (${e._generateTernary("1.","-1.",f?"fragmentInputs.frontFacing":"gl_FrontFacing")})
            #endif
            );
        #else
            clearcoatOut.specularEnvironmentR0 = specularEnvironmentR0;
        #endif
`,l}_buildBlock(e){return this._scene=e.sharedData.scene,e.target===P.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,p.Float)),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.remapF0OnInterfaceChange = ${this.remapF0OnInterfaceChange};
`,e}serialize(){const e=super.serialize();return e.remapF0OnInterfaceChange=this.remapF0OnInterfaceChange,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.remapF0OnInterfaceChange=e.remapF0OnInterfaceChange??!0}}_([O("Remap F0 on interface change",0,"ADVANCED",{embedded:!0})],xa.prototype,"remapF0OnInterfaceChange",void 0);y("BABYLON.ClearCoatBlock",xa);class kl extends ie{constructor(e){super(e,P.Fragment),this._isUnique=!0,this.registerInput("intensity",p.Float,!0,P.Fragment),this.registerInput("indexOfRefraction",p.Float,!0,P.Fragment),this.registerInput("thickness",p.Float,!0,P.Fragment),this.registerOutput("iridescence",p.Object,P.Fragment,new at("iridescence",this,1,kl,"IridescenceBlock"))}initialize(e){e._excludeVariableName("iridescenceOut"),e._excludeVariableName("vIridescenceParams")}getClassName(){return"IridescenceBlock"}get intensity(){return this._inputs[0]}get indexOfRefraction(){return this._inputs[1]}get thickness(){return this._inputs[2]}get iridescence(){return this._outputs[0]}autoConfigure(){if(!this.intensity.isConnected){const e=new ge("Iridescence intensity",P.Fragment,p.Float);e.value=1,e.output.connectTo(this.intensity);const t=new ge("Iridescence ior",P.Fragment,p.Float);t.value=1.3,t.output.connectTo(this.indexOfRefraction);const i=new ge("Iridescence thickness",P.Fragment,p.Float);i.value=400,i.output.connectTo(this.thickness)}}prepareDefines(e){e.setValue("IRIDESCENCE",!0,!0),e.setValue("IRIDESCENCE_TEXTURE",!1,!0),e.setValue("IRIDESCENCE_THICKNESS_TEXTURE",!1,!0)}static GetCode(e,t){let i="";const r=e!=null&&e.intensity.isConnected?e.intensity.associatedVariableName:"1.",n=e!=null&&e.indexOfRefraction.isConnected?e.indexOfRefraction.associatedVariableName:Ui._DefaultIndexOfRefraction,a=e!=null&&e.thickness.isConnected?e.thickness.associatedVariableName:Ui._DefaultMaximumThickness,o=t.shaderLanguage===1;return i+=`${o?"var iridescenceOut: iridescenceOutParams":"iridescenceOutParams iridescenceOut"};

        #ifdef IRIDESCENCE
            iridescenceOut = iridescenceBlock(
                vec4(${r}, ${n}, 1., ${a})
                , NdotV
                , specularEnvironmentR0
                #ifdef CLEARCOAT
                    , NdotVUnclamped
                    , vClearCoatParams
                #endif                
            );

            ${o?"let":"float"} iridescenceIntensity = iridescenceOut.iridescenceIntensity;
            specularEnvironmentR0 = iridescenceOut.specularEnvironmentR0;
        #endif
`,i}_buildBlock(e){return e.target===P.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this)),this}serialize(){return super.serialize()}_deserialize(e,t,i){super._deserialize(e,t,i)}}y("BABYLON.IridescenceBlock",kl);class ka extends ie{constructor(e){super(e,P.Fragment),this.linkRefractionWithTransparency=!1,this.invertRefractionY=!1,this.useThicknessAsDepth=!1,this._isUnique=!0,this.registerInput("intensity",p.Float,!1,P.Fragment),this.registerInput("tintAtDistance",p.Float,!0,P.Fragment),this.registerInput("volumeIndexOfRefraction",p.Float,!0,P.Fragment),this.registerOutput("refraction",p.Object,P.Fragment,new at("refraction",this,1,ka,"RefractionBlock"))}initialize(e){e._excludeVariableName("vRefractionPosition"),e._excludeVariableName("vRefractionSize")}getClassName(){return"RefractionBlock"}get intensity(){return this._inputs[0]}get tintAtDistance(){return this._inputs[1]}get volumeIndexOfRefraction(){return this._inputs[2]}get view(){return this.viewConnectionPoint}get refraction(){return this._outputs[0]}get hasTexture(){return!!this._getTexture()}_getTexture(){return this.texture?this.texture:this._scene.environmentTexture}autoConfigure(e,t=()=>!0){if(!this.intensity.isConnected){const i=new ge("Refraction intensity",P.Fragment,p.Float);i.value=1,i.output.connectTo(this.intensity)}if(this.view&&!this.view.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===ve.View&&t(r));i||(i=new ge("view"),i.setAsSystemValue(ve.View)),i.output.connectTo(this.view)}}prepareDefines(e){const t=this._getTexture(),i=t&&t.getTextureMatrix;e.setValue("SS_REFRACTION",i,!0),i&&(e.setValue(this._define3DName,t.isCube,!0),e.setValue(this._defineLODRefractionAlpha,t.lodLevelInAlpha,!0),e.setValue(this._defineLinearSpecularRefraction,t.linearSpecularLOD,!0),e.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem&&t.isCube?!t.invertZ:t.invertZ,!0),e.setValue("SS_LINKREFRACTIONTOTRANSPARENCY",this.linkRefractionWithTransparency,!0),e.setValue("SS_GAMMAREFRACTION",t.gammaSpace,!0),e.setValue("SS_RGBDREFRACTION",t.isRGBD,!0),e.setValue("SS_USE_LOCAL_REFRACTIONMAP_CUBIC",!!t.boundingBoxSize,!0),e.setValue("SS_USE_THICKNESS_AS_DEPTH",this.useThicknessAsDepth,!0))}isReady(){const e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())}bind(e,t,i){var l,c;super.bind(e,t,i);const r=this._getTexture();if(!r)return;r.isCube?e.setTexture(this._cubeSamplerName,r):e.setTexture(this._2DSamplerName,r),e.setMatrix(this._refractionMatrixName,r.getRefractionTextureMatrix());let n=1;r.isCube||r.depth&&(n=r.depth);const a=((l=this.volumeIndexOfRefraction.connectInputBlock)==null?void 0:l.value)??((c=this.indexOfRefractionConnectionPoint.connectInputBlock)==null?void 0:c.value)??1.5;e.setFloat4(this._vRefractionInfosName,r.level,1/a,n,this.invertRefractionY?-1:1),e.setFloat4(this._vRefractionMicrosurfaceInfosName,r.getSize().width,r.lodGenerationScale,r.lodGenerationOffset,1/a);const o=r.getSize().width;if(e.setFloat2(this._vRefractionFilteringInfoName,o,Math.log2(o)),r.boundingBoxSize){const u=r;e.setVector3("vRefractionPosition",u.boundingBoxPosition),e.setVector3("vRefractionSize",u.boundingBoxSize)}}getCode(e){const t="";return e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),this._define3DName=e._getFreeDefineName("SS_REFRACTIONMAP_3D"),this._getTexture()&&(e._samplerDeclaration+=`#ifdef ${this._define3DName}
`,e._emitCubeSampler(this._cubeSamplerName,void 0,!0),e._samplerDeclaration+=`#else
`,e._emit2DSampler(this._2DSamplerName,void 0,!0),e._samplerDeclaration+=`#endif
`),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._defineLODRefractionAlpha=e._getFreeDefineName("SS_LODINREFRACTIONALPHA"),this._defineLinearSpecularRefraction=e._getFreeDefineName("SS_LINEARSPECULARREFRACTION"),this._defineOppositeZ=e._getFreeDefineName("SS_REFRACTIONMAP_OPPOSITEZ"),this._refractionMatrixName=e._getFreeVariableName("refractionMatrix"),e._emitUniformFromString(this._refractionMatrixName,p.Matrix),e.shaderLanguage!==1&&(e._emitFunction("sampleRefraction",`
                #ifdef ${this._define3DName}
                    #define sampleRefraction(s, c) textureCube(s, c)
                #else
                    #define sampleRefraction(s, c) texture2D(s, c)
                #endif
`,`//${this.name}`),e._emitFunction("sampleRefractionLod",`
                #ifdef ${this._define3DName}
                    #define sampleRefractionLod(s, c, l) textureCubeLodEXT(s, c, l)
                #else
                    #define sampleRefractionLod(s, c, l) texture2DLodEXT(s, c, l)
                #endif
`,`//${this.name}`)),this._vRefractionMicrosurfaceInfosName=e._getFreeVariableName("vRefractionMicrosurfaceInfos"),e._emitUniformFromString(this._vRefractionMicrosurfaceInfosName,p.Vector4),this._vRefractionInfosName=e._getFreeVariableName("vRefractionInfos"),e._emitUniformFromString(this._vRefractionInfosName,p.Vector4),this._vRefractionFilteringInfoName=e._getFreeVariableName("vRefractionFilteringInfo"),e._emitUniformFromString(this._vRefractionFilteringInfoName,p.Vector2),e._emitUniformFromString("vRefractionPosition",p.Vector3),e._emitUniformFromString("vRefractionSize",p.Vector3),t}_buildBlock(e){return this._scene=e.sharedData.scene,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(this.texture.isCube?e=`${this._codeVariableName}.texture = new BABYLON.CubeTexture("${this.texture.name}");
`:e=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}");
`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};
`),e+=`${this._codeVariableName}.linkRefractionWithTransparency = ${this.linkRefractionWithTransparency};
`,e+=`${this._codeVariableName}.invertRefractionY = ${this.invertRefractionY};
`,e+=`${this._codeVariableName}.useThicknessAsDepth = ${this.useThicknessAsDepth};
`,e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.linkRefractionWithTransparency=this.linkRefractionWithTransparency,e.invertRefractionY=this.invertRefractionY,e.useThicknessAsDepth=this.useThicknessAsDepth,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,e.texture.isCube?this.texture=ii.Parse(e.texture,t,i):this.texture=$.Parse(e.texture,t,i)),this.linkRefractionWithTransparency=e.linkRefractionWithTransparency,this.invertRefractionY=e.invertRefractionY,this.useThicknessAsDepth=!!e.useThicknessAsDepth}}_([O("Link refraction to transparency",0,"ADVANCED",{embedded:!0,notifiers:{update:!0}})],ka.prototype,"linkRefractionWithTransparency",void 0);_([O("Invert refraction Y",0,"ADVANCED",{embedded:!0,notifiers:{update:!0}})],ka.prototype,"invertRefractionY",void 0);_([O("Use thickness as depth",0,"ADVANCED",{embedded:!0,notifiers:{update:!0}})],ka.prototype,"useThicknessAsDepth",void 0);y("BABYLON.RefractionBlock",ka);class Po extends ie{constructor(e){super(e,P.Fragment),this.applyAlbedoAfterSubSurface=rt.DEFAULT_APPLY_ALBEDO_AFTERSUBSURFACE,this._isUnique=!0,this.registerInput("thickness",p.Float,!1,P.Fragment),this.registerInput("tintColor",p.Color3,!0,P.Fragment),this.registerInput("translucencyIntensity",p.Float,!0,P.Fragment),this.registerInput("translucencyDiffusionDist",p.Color3,!0,P.Fragment),this.registerInput("refraction",p.Object,!0,P.Fragment,new at("refraction",this,0,ka,"RefractionBlock")),this.registerInput("dispersion",p.Float,!0,P.Fragment),this.registerOutput("subsurface",p.Object,P.Fragment,new at("subsurface",this,1,Po,"SubSurfaceBlock"))}initialize(e){e._excludeVariableName("subSurfaceOut"),e._excludeVariableName("vThicknessParam"),e._excludeVariableName("vTintColor"),e._excludeVariableName("vTranslucencyColor"),e._excludeVariableName("vSubSurfaceIntensity"),e._excludeVariableName("dispersion")}getClassName(){return"SubSurfaceBlock"}get thickness(){return this._inputs[0]}get tintColor(){return this._inputs[1]}get translucencyIntensity(){return this._inputs[2]}get translucencyDiffusionDist(){return this._inputs[3]}get refraction(){return this._inputs[4]}get dispersion(){return this._inputs[5]}get subsurface(){return this._outputs[0]}autoConfigure(){if(!this.thickness.isConnected){const e=new ge("SubSurface thickness",P.Fragment,p.Float);e.value=0,e.output.connectTo(this.thickness)}}prepareDefines(e){const t=this.translucencyDiffusionDist.isConnected||this.translucencyIntensity.isConnected;e.setValue("SUBSURFACE",t||this.refraction.isConnected,!0),e.setValue("SS_TRANSLUCENCY",t,!0),e.setValue("SS_THICKNESSANDMASK_TEXTURE",!1,!0),e.setValue("SS_REFRACTIONINTENSITY_TEXTURE",!1,!0),e.setValue("SS_TRANSLUCENCYINTENSITY_TEXTURE",!1,!0),e.setValue("SS_USE_GLTF_TEXTURES",!1,!0),e.setValue("SS_DISPERSION",this.dispersion.isConnected,!0),e.setValue("SS_APPLY_ALBEDO_AFTER_SUBSURFACE",this.applyAlbedoAfterSubSurface,!0)}static GetCode(e,t,i,r){var v;let n="";const a=t!=null&&t.thickness.isConnected?t.thickness.associatedVariableName:"0.",o=t!=null&&t.tintColor.isConnected?t.tintColor.associatedVariableName:"vec3(1.)",l=t!=null&&t.translucencyIntensity.isConnected?t==null?void 0:t.translucencyIntensity.associatedVariableName:"1.",c=t!=null&&t.translucencyDiffusionDist.isConnected?t==null?void 0:t.translucencyDiffusionDist.associatedVariableName:"vec3(1.)",u=t!=null&&t.refraction.isConnected?(v=t==null?void 0:t.refraction.connectedPoint)==null?void 0:v.ownerBlock:null,h=u!=null&&u.tintAtDistance.isConnected?u.tintAtDistance.associatedVariableName:"1.",d=u!=null&&u.intensity.isConnected?u.intensity.associatedVariableName:"1.",f=u!=null&&u.view.isConnected?u.view.associatedVariableName:"",m=t!=null&&t.dispersion.isConnected?t==null?void 0:t.dispersion.associatedVariableName:"0.0",g=e.shaderLanguage===1;return n+=(u==null?void 0:u.getCode(e))??"",n+=`${g?"var subSurfaceOut: subSurfaceOutParams":"subSurfaceOutParams subSurfaceOut"};

        #ifdef SUBSURFACE
            ${e._declareLocalVar("vThicknessParam",p.Vector2)} = vec2${e.fSuffix}(0., ${a});
            ${e._declareLocalVar("vTintColor",p.Vector4)} = vec4${e.fSuffix}(${o}, ${h});
            ${e._declareLocalVar("vSubSurfaceIntensity",p.Vector3)} = vec3(${d}, ${l}, 0.);
            ${e._declareLocalVar("dispersion",p.Float)} = ${m};
            subSurfaceOut = subSurfaceBlock(
                vSubSurfaceIntensity
                , vThicknessParam
                , vTintColor
                , normalW
            #ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
        `,n+=g?", vec3f(max(colorSpecularEnvironmentReflectance.r, max(colorSpecularEnvironmentReflectance.g, colorSpecularEnvironmentReflectance.b)))/n":", vec3(max(colorSpecularEnvironmentReflectance.r, max(colorSpecularEnvironmentReflectance.g, colorSpecularEnvironmentReflectance.b)))/n",n+=`#else
                , baseSpecularEnvironmentReflectance
            #endif
            #ifdef SS_THICKNESSANDMASK_TEXTURE
                , vec4${e.fSuffix}(0.)
            #endif
            #ifdef REFLECTION
                #ifdef SS_TRANSLUCENCY
                    , ${(g?"uniforms.":"")+(i==null?void 0:i._reflectionMatrixName)}
                    #ifdef USESPHERICALFROMREFLECTIONMAP
                        #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
                            , reflectionOut.irradianceVector
                        #endif
                        #if defined(REALTIME_FILTERING)
                            , ${i==null?void 0:i._cubeSamplerName}
                            ${g?`, ${i==null?void 0:i._cubeSamplerName}Sampler`:""}
                            , ${i==null?void 0:i._vReflectionFilteringInfoName}
                        #endif
                        #endif
                    #ifdef USEIRRADIANCEMAP
                        , irradianceSampler
                        ${g?", irradianceSamplerSampler":""}
                    #endif
                #endif
            #endif
            #if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
                , surfaceAlbedo
            #endif
            #ifdef SS_REFRACTION
                , ${r}.xyz
                , viewDirectionW
                , ${f}
                , ${(g?"uniforms.":"")+((u==null?void 0:u._vRefractionInfosName)??"")}
                , ${(g?"uniforms.":"")+((u==null?void 0:u._refractionMatrixName)??"")}
                , ${(g?"uniforms.":"")+((u==null?void 0:u._vRefractionMicrosurfaceInfosName)??"")}
                , ${g?"uniforms.":""}vLightingIntensity
                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY
                    , alpha
                #endif
                #ifdef ${(u==null?void 0:u._defineLODRefractionAlpha)??"IGNORE"}
                    , NdotVUnclamped
                #endif
                #ifdef ${(u==null?void 0:u._defineLinearSpecularRefraction)??"IGNORE"}
                    , roughness
                #endif
                , alphaG
                #ifdef ${(u==null?void 0:u._define3DName)??"IGNORE"}
                    , ${(u==null?void 0:u._cubeSamplerName)??""}
                    ${g?`, ${u==null?void 0:u._cubeSamplerName}Sampler`:""}
                #else
                    , ${(u==null?void 0:u._2DSamplerName)??""}
                    ${g?`, ${u==null?void 0:u._2DSamplerName}Sampler`:""}
                #endif
                #ifndef LODBASEDMICROSFURACE
                    #ifdef ${(u==null?void 0:u._define3DName)??"IGNORE"}
                        , ${(u==null?void 0:u._cubeSamplerName)??""}                        
                        ${g?`, ${u==null?void 0:u._cubeSamplerName}Sampler`:""}
                        , ${(u==null?void 0:u._cubeSamplerName)??""}                        
                        ${g?`, ${u==null?void 0:u._cubeSamplerName}Sampler`:""}
                    #else
                        , ${(u==null?void 0:u._2DSamplerName)??""}
                        ${g?`, ${u==null?void 0:u._2DSamplerName}Sampler`:""}
                        , ${(u==null?void 0:u._2DSamplerName)??""}
                        ${g?`, ${u==null?void 0:u._2DSamplerName}Sampler`:""}
                    #endif
                #endif
                #ifdef ANISOTROPIC
                    , anisotropicOut
                #endif
                #ifdef REALTIME_FILTERING
                    , ${(u==null?void 0:u._vRefractionFilteringInfoName)??""}
                #endif
                #ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
                    , vRefractionPosition
                    , vRefractionSize
                #endif
                #ifdef SS_DISPERSION
                    , dispersion
                #endif
            #endif
            #ifdef SS_TRANSLUCENCY
                , ${c}
                , vTintColor
                #ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
                    , vec4${e.fSuffix}(0.)
                #endif
            #endif                
            );

            #ifdef SS_REFRACTION
                surfaceAlbedo = subSurfaceOut.surfaceAlbedo;
                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY
                    alpha = subSurfaceOut.alpha;
                #endif
            #endif
        #else
            subSurfaceOut.specularEnvironmentReflectance = colorSpecularEnvironmentReflectance;
        #endif
`,n}_buildBlock(e){return e.target===P.Fragment&&e.sharedData.blocksWithDefines.push(this),this}}_([O("Apply albedo after sub-surface",0,"ADVANCED")],Po.prototype,"applyAlbedoAfterSubSurface",void 0);y("BABYLON.SubSurfaceBlock",Po);const i4={ambientClr:["finalAmbient",""],diffuseDir:["finalDiffuse",""],specularDir:["finalSpecularScaled","!defined(UNLIT) && defined(SPECULARTERM)"],clearcoatDir:["finalClearCoatScaled","!defined(UNLIT) && defined(CLEARCOAT)"],sheenDir:["finalSheenScaled","!defined(UNLIT) && defined(SHEEN)"],diffuseInd:["finalIrradiance","!defined(UNLIT) && defined(REFLECTION)"],specularInd:["finalRadianceScaled","!defined(UNLIT) && defined(REFLECTION)"],clearcoatInd:["clearcoatOut.finalClearCoatRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(CLEARCOAT)"],sheenInd:["sheenOut.finalSheenRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(SHEEN) && defined(ENVIRONMENTBRDF)"],refraction:["subSurfaceOut.finalRefraction","!defined(UNLIT) && defined(SS_REFRACTION)"],lighting:["finalColor.rgb",""],shadow:["aggShadow",""],alpha:["alpha",""]};class Zt extends ie{static _OnGenerateOnlyFragmentCodeChanged(e,t){const i=e;return i.worldPosition.isConnected||i.worldNormal.isConnected?(i.generateOnlyFragmentCode=!i.generateOnlyFragmentCode,N.Error("The worldPosition and worldNormal inputs must not be connected to be able to switch!"),!1):(i._setTarget(),!0)}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?P.Fragment:P.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?P.Fragment:P.Vertex,this.getInputByName("worldNormal").target=this.generateOnlyFragmentCode?P.Fragment:P.Vertex}constructor(e){super(e,P.VertexAndFragment),this._environmentBRDFTexture=null,this._metallicReflectanceColor=q.White(),this._metallicF0Factor=1,this.directIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.lightFalloff=0,this.useAlphaTest=!1,this.alphaTestCutoff=.5,this.useAlphaBlending=!1,this.useRadianceOverAlpha=!0,this.useSpecularOverAlpha=!0,this.enableSpecularAntiAliasing=!1,this.realTimeFiltering=!1,this.realTimeFilteringQuality=8,this.baseDiffuseModel=0,this.useEnergyConservation=!0,this.useRadianceOcclusion=!0,this.useHorizonOcclusion=!0,this.unlit=!1,this.forceNormalForward=!1,this.generateOnlyFragmentCode=!1,this.debugMode=0,this.debugLimit=0,this.debugFactor=1,this._isUnique=!0,this.registerInput("worldPosition",p.Vector4,!1,P.Vertex),this.registerInput("worldNormal",p.Vector4,!1,P.Vertex),this.registerInput("view",p.Matrix,!1),this.registerInput("cameraPosition",p.Vector3,!1,P.Fragment),this.registerInput("perturbedNormal",p.Vector4,!0,P.Fragment),this.registerInput("baseColor",p.Color3,!0,P.Fragment),this.registerInput("metallic",p.Float,!1,P.Fragment),this.registerInput("roughness",p.Float,!1,P.Fragment),this.registerInput("ambientOcc",p.Float,!0,P.Fragment),this.registerInput("opacity",p.Float,!0,P.Fragment),this.registerInput("indexOfRefraction",p.Float,!0,P.Fragment),this.registerInput("ambientColor",p.Color3,!0,P.Fragment),this.registerInput("reflection",p.Object,!0,P.Fragment,new at("reflection",this,0,Ko,"ReflectionBlock")),this.registerInput("clearcoat",p.Object,!0,P.Fragment,new at("clearcoat",this,0,xa,"ClearCoatBlock")),this.registerInput("sheen",p.Object,!0,P.Fragment,new at("sheen",this,0,Qo,"SheenBlock")),this.registerInput("subsurface",p.Object,!0,P.Fragment,new at("subsurface",this,0,Po,"SubSurfaceBlock")),this.registerInput("anisotropy",p.Object,!0,P.Fragment,new at("anisotropy",this,0,Ah,"AnisotropyBlock")),this.registerInput("iridescence",p.Object,!0,P.Fragment,new at("iridescence",this,0,kl,"IridescenceBlock")),this.registerOutput("ambientClr",p.Color3,P.Fragment),this.registerOutput("diffuseDir",p.Color3,P.Fragment),this.registerOutput("specularDir",p.Color3,P.Fragment),this.registerOutput("clearcoatDir",p.Color3,P.Fragment),this.registerOutput("sheenDir",p.Color3,P.Fragment),this.registerOutput("diffuseInd",p.Color3,P.Fragment),this.registerOutput("specularInd",p.Color3,P.Fragment),this.registerOutput("clearcoatInd",p.Color3,P.Fragment),this.registerOutput("sheenInd",p.Color3,P.Fragment),this.registerOutput("refraction",p.Color3,P.Fragment),this.registerOutput("lighting",p.Color3,P.Fragment),this.registerOutput("shadow",p.Float,P.Fragment),this.registerOutput("alpha",p.Float,P.Fragment)}initialize(e){e._excludeVariableName("vLightingIntensity"),e._excludeVariableName("geometricNormalW"),e._excludeVariableName("normalW"),e._excludeVariableName("faceNormal"),e._excludeVariableName("albedoOpacityOut"),e._excludeVariableName("surfaceAlbedo"),e._excludeVariableName("alpha"),e._excludeVariableName("aoOut"),e._excludeVariableName("baseColor"),e._excludeVariableName("reflectivityOut"),e._excludeVariableName("microSurface"),e._excludeVariableName("roughness"),e._excludeVariableName("vReflectivityColor"),e._excludeVariableName("NdotVUnclamped"),e._excludeVariableName("NdotV"),e._excludeVariableName("alphaG"),e._excludeVariableName("AARoughnessFactors"),e._excludeVariableName("environmentBrdf"),e._excludeVariableName("ambientMonochrome"),e._excludeVariableName("seo"),e._excludeVariableName("eho"),e._excludeVariableName("environmentRadiance"),e._excludeVariableName("irradianceVector"),e._excludeVariableName("environmentIrradiance"),e._excludeVariableName("diffuseBase"),e._excludeVariableName("specularBase"),e._excludeVariableName("preInfo"),e._excludeVariableName("info"),e._excludeVariableName("shadow"),e._excludeVariableName("finalDiffuse"),e._excludeVariableName("finalAmbient"),e._excludeVariableName("ambientOcclusionForDirectDiffuse"),e._excludeVariableName("finalColor"),e._excludeVariableName("vClipSpacePosition"),e._excludeVariableName("vDebugMode"),e._excludeVariableName("vViewDepth"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,e===1?await Promise.all([U(()=>Promise.resolve().then(()=>bA),void 0),U(()=>Promise.resolve().then(()=>yA),void 0)]):await Promise.all([U(()=>Promise.resolve().then(()=>RA),void 0),U(()=>Promise.resolve().then(()=>PA),void 0)]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}getClassName(){return"PBRMetallicRoughnessBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get view(){return this._inputs[2]}get cameraPosition(){return this._inputs[3]}get perturbedNormal(){return this._inputs[4]}get baseColor(){return this._inputs[5]}get metallic(){return this._inputs[6]}get roughness(){return this._inputs[7]}get ambientOcc(){return this._inputs[8]}get opacity(){return this._inputs[9]}get indexOfRefraction(){return this._inputs[10]}get ambientColor(){return this._inputs[11]}get reflection(){return this._inputs[12]}get clearcoat(){return this._inputs[13]}get sheen(){return this._inputs[14]}get subsurface(){return this._inputs[15]}get anisotropy(){return this._inputs[16]}get iridescence(){return this._inputs[17]}get ambientClr(){return this._outputs[0]}get diffuseDir(){return this._outputs[1]}get specularDir(){return this._outputs[2]}get clearcoatDir(){return this._outputs[3]}get sheenDir(){return this._outputs[4]}get diffuseInd(){return this._outputs[5]}get specularInd(){return this._outputs[6]}get clearcoatInd(){return this._outputs[7]}get sheenInd(){return this._outputs[8]}get refraction(){return this._outputs[9]}get lighting(){return this._outputs[10]}get shadow(){return this._outputs[11]}get alpha(){return this._outputs[12]}autoConfigure(e,t=()=>!0){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===ve.CameraPosition&&t(r));i||(i=new ge("cameraPosition"),i.setAsSystemValue(ve.CameraPosition)),i.output.connectTo(this.cameraPosition)}if(!this.view.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===ve.View&&t(r));i||(i=new ge("view"),i.setAsSystemValue(ve.View)),i.output.connectTo(this.view)}}prepareDefines(e,t,i){if(!i)return;e.setValue("PBR",!0),e.setValue("METALLICWORKFLOW",!0),e.setValue("DEBUGMODE",this.debugMode,!0),e.setValue("DEBUGMODE_FORCERETURN",!0),e.setValue("NORMALXYSCALE",!0),e.setValue("BUMP",this.perturbedNormal.isConnected,!0),e.setValue("LODBASEDMICROSFURACE",this._scene.getEngine().getCaps().textureLOD),e.setValue("ALBEDO",!1,!0),e.setValue("OPACITY",this.opacity.isConnected,!0),e.setValue("AMBIENT",!0,!0),e.setValue("AMBIENTINGRAYSCALE",!1,!0),e.setValue("REFLECTIVITY",!1,!0),e.setValue("AOSTOREINMETALMAPRED",!1,!0),e.setValue("METALLNESSSTOREINMETALMAPBLUE",!1,!0),e.setValue("ROUGHNESSSTOREINMETALMAPALPHA",!1,!0),e.setValue("ROUGHNESSSTOREINMETALMAPGREEN",!1,!0),this.lightFalloff===Ve.LIGHTFALLOFF_STANDARD?(e.setValue("USEPHYSICALLIGHTFALLOFF",!1),e.setValue("USEGLTFLIGHTFALLOFF",!1)):this.lightFalloff===Ve.LIGHTFALLOFF_GLTF?(e.setValue("USEPHYSICALLIGHTFALLOFF",!1),e.setValue("USEGLTFLIGHTFALLOFF",!0)):(e.setValue("USEPHYSICALLIGHTFALLOFF",!0),e.setValue("USEGLTFLIGHTFALLOFF",!1));const r=this.alphaTestCutoff.toString();e.setValue("ALPHABLEND",this.useAlphaBlending,!0),e.setValue("ALPHAFROMALBEDO",!1,!0),e.setValue("ALPHATEST",this.useAlphaTest,!0),e.setValue("ALPHATESTVALUE",r.indexOf(".")<0?r+".":r,!0),e.setValue("OPACITYRGB",!1,!0),e.setValue("RADIANCEOVERALPHA",this.useRadianceOverAlpha,!0),e.setValue("SPECULAROVERALPHA",this.useSpecularOverAlpha,!0),e.setValue("SPECULARAA",this._scene.getEngine().getCaps().standardDerivatives&&this.enableSpecularAntiAliasing,!0),e.setValue("REALTIME_FILTERING",this.realTimeFiltering,!0);const n=i.getScene();if(n.getEngine()._features.needTypeSuffixInShaderConstants?e.setValue("NUM_SAMPLES",this.realTimeFilteringQuality+"u",!0):e.setValue("NUM_SAMPLES",""+this.realTimeFilteringQuality,!0),e.setValue("BASE_DIFFUSE_MODEL",this.baseDiffuseModel,!0),e.setValue("BRDF_V_HEIGHT_CORRELATED",!0),e.setValue("LEGACY_SPECULAR_ENERGY_CONSERVATION",!0),e.setValue("MS_BRDF_ENERGY_CONSERVATION",this.useEnergyConservation,!0),e.setValue("RADIANCEOCCLUSION",this.useRadianceOcclusion,!0),e.setValue("HORIZONOCCLUSION",this.useHorizonOcclusion,!0),e.setValue("UNLIT",this.unlit,!0),e.setValue("FORCENORMALFORWARD",this.forceNormalForward,!0),this._environmentBRDFTexture&&K.ReflectionTextureEnabled?(e.setValue("ENVIRONMENTBRDF",!0),e.setValue("ENVIRONMENTBRDF_RGBD",this._environmentBRDFTexture.isRGBD,!0)):(e.setValue("ENVIRONMENTBRDF",!1),e.setValue("ENVIRONMENTBRDF_RGBD",!1)),e._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(e),!!e._areLightsDirty)if(!this.light)jl(n,i,e,!0,t.maxSimultaneousLights),e._needNormals=!0,bu(n,e);else{const o={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};gI(n,i,this.light,this._lightId,e,!0,o),o.needRebuild&&e.rebuild()}}updateUniformsAndSamples(e,t,i,r){for(let n=0;n<t.maxSimultaneousLights&&i["LIGHT"+n];n++){const a=e.uniforms.indexOf("vLightData"+n)>=0;SI(n,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+n],r,a,i["IESLIGHTTEXTURE"+n],i["CLUSTLIGHT"+n])}}isReady(e,t,i){return!(this._environmentBRDFTexture&&!this._environmentBRDFTexture.isReady()||i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())}bind(e,t,i){if(!i)return;const r=i.getScene();this.light?vI(this.light,this._lightId,r,e,!0):ql(r,i,e,!0,t.maxSimultaneousLights),e.setTexture(this._environmentBrdfSamplerName,this._environmentBRDFTexture),e.setFloat2("vDebugMode",this.debugLimit,this.debugFactor);const n=this._scene.ambientColor;n&&e.setColor3("ambientFromScene",n);const a=r.useRightHandedSystem===(r._mirroredCameraPosition!=null);e.setFloat(this._invertNormalName,a?-1:1),e.setFloat4("vLightingIntensity",this.directIntensity,1,this.environmentIntensity*this._scene.environmentIntensity,this.specularIntensity);const o=this._metallicF0Factor;e.setColor4(this._vMetallicReflectanceFactorsName,this._metallicReflectanceColor,o),t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}_injectVertexCode(e){var c;const t=this.worldPosition,i=this.worldNormal,r=`//${this.name}`,n=e.shaderLanguage===1;this.light?(this._lightId=(e.counters.lightCounter!==void 0?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",r,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));const a="v_"+t.associatedVariableName;e._emitVaryingFromString(a,p.Vector4)&&(e.compilationString+=(n?"vertexOutputs.":"")+`${a} = ${t.associatedVariableName};
`);const o="v_"+i.associatedVariableName;e._emitVaryingFromString(o,p.Vector4)&&(e.compilationString+=(n?"vertexOutputs.":"")+`${o} = ${i.associatedVariableName};
`);const l=this.reflection.isConnected?(c=this.reflection.connectedPoint)==null?void 0:c.ownerBlock:null;l&&(l.viewConnectionPoint=this.view),e.compilationString+=(l==null?void 0:l.handleVertexSide(e))??"",e._emitVaryingFromString("vClipSpacePosition",p.Vector4,"defined(IGNORE) || DEBUGMODE > 0")&&(e._injectAtEnd+=`#if DEBUGMODE > 0
`,e._injectAtEnd+=(n?"vertexOutputs.":"")+`vClipSpacePosition = ${n?"vertexOutputs.position":"gl_Position"};
`,e._injectAtEnd+=`#endif
`),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:t.associatedVariableName}]}):(e.compilationString+=`${e._declareLocalVar("worldPos",p.Vector4)} = ${t.associatedVariableName};
`,this.view.isConnected&&(e.compilationString+=`${e._declareLocalVar("view",p.Matrix)} = ${this.view.associatedVariableName};
`,e._emitVaryingFromString("vViewDepth",p.Float),e.compilationString+=(e.shaderLanguage===1?"vertexOutputs.":"")+`vViewDepth = (${this.view.associatedVariableName} * ${t.associatedVariableName}).z;
`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{repeatKey:"maxSimultaneousLights"}))}_getAlbedoOpacityCode(e){let i=e.shaderLanguage===1?`var albedoOpacityOut: albedoOpacityOutParams;
`:`albedoOpacityOutParams albedoOpacityOut;
`;const r=this.baseColor.isConnected?this.baseColor.associatedVariableName:"vec3(1.)",n=this.opacity.isConnected?this.opacity.associatedVariableName:"1.";return i+=`albedoOpacityOut = albedoOpacityBlock(
                vec4${e.fSuffix}(${r}, 1.)
            #ifdef ALBEDO
                ,vec4${e.fSuffix}(1.)
                ,vec2${e.fSuffix}(1., 1.)
            #endif
                ,1. /* Base Weight */
            #ifdef OPACITY
                ,vec4${e.fSuffix}(${n})
                ,vec2${e.fSuffix}(1., 1.)
            #endif
            );

            ${e._declareLocalVar("surfaceAlbedo",p.Vector3)} = albedoOpacityOut.surfaceAlbedo;
            ${e._declareLocalVar("alpha",p.Float)} = albedoOpacityOut.alpha;
`,i}_getAmbientOcclusionCode(e){let i=e.shaderLanguage===1?`var aoOut: ambientOcclusionOutParams;
`:`ambientOcclusionOutParams aoOut;
`;const r=this.ambientOcc.isConnected?this.ambientOcc.associatedVariableName:"1.";return i+=`aoOut = ambientOcclusionBlock(
            #ifdef AMBIENT
                vec3${e.fSuffix}(${r}),
                vec4${e.fSuffix}(0., 1.0, 1.0, 0.)
            #endif
            );
`,i}_getReflectivityCode(e){var l;const t=e.shaderLanguage===1;let i=t?`var reflectivityOut: reflectivityOutParams;
`:`reflectivityOutParams reflectivityOut;
`;const r="1.";this._vMetallicReflectanceFactorsName=e._getFreeVariableName("vMetallicReflectanceFactors"),e._emitUniformFromString(this._vMetallicReflectanceFactorsName,p.Vector4),this._baseDiffuseRoughnessName=e._getFreeVariableName("baseDiffuseRoughness"),e._emitUniformFromString(this._baseDiffuseRoughnessName,p.Float);const n=1,a=((l=this.indexOfRefraction.connectInputBlock)==null?void 0:l.value)??1.5,o=Math.pow((a-n)/(a+n),2);return i+=`${e._declareLocalVar("baseColor",p.Vector3)} = surfaceAlbedo;
            ${t?"let":`vec4${e.fSuffix}`} vReflectivityColor = vec4${e.fSuffix}(${this.metallic.associatedVariableName}, ${this.roughness.associatedVariableName}, ${this.indexOfRefraction.associatedVariableName||"1.5"}, ${o});
            reflectivityOut = reflectivityBlock(
                vReflectivityColor
            #ifdef METALLICWORKFLOW
                , surfaceAlbedo
                , ${(t?"uniforms.":"")+this._vMetallicReflectanceFactorsName}
            #endif
                , ${(t?"uniforms.":"")+this._baseDiffuseRoughnessName}
            #ifdef BASE_DIFFUSE_ROUGHNESS
                , 0.
                , vec2${e.fSuffix}(0., 0.)
            #endif
            #ifdef REFLECTIVITY
                , vec3${e.fSuffix}(0., 0., ${r})
                , vec4${e.fSuffix}(1.)
            #endif
            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY)  && defined(AOSTOREINMETALMAPRED)
                , aoOut.ambientOcclusionColor
            #endif
            #ifdef MICROSURFACEMAP
                , microSurfaceTexel <== not handled!
            #endif
            );

            ${e._declareLocalVar("microSurface",p.Float)} = reflectivityOut.microSurface;
            ${e._declareLocalVar("roughness",p.Float)} = reflectivityOut.roughness;
            ${e._declareLocalVar("diffuseRoughness",p.Float)} = reflectivityOut.diffuseRoughness;

            #ifdef METALLICWORKFLOW
                surfaceAlbedo = reflectivityOut.surfaceAlbedo;
            #endif
            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
                aoOut.ambientOcclusionColor = reflectivityOut.ambientOcclusionColor;
            #endif
`,i}_buildBlock(e){var V,D,w,B,Q,J,re,ne,fe,be,Me;super._buildBlock(e),this._scene=e.sharedData.scene;const t=e.shaderLanguage===1;this._environmentBRDFTexture||(this._environmentBRDFTexture=gh(this._scene));const i=this.reflection.isConnected?(V=this.reflection.connectedPoint)==null?void 0:V.ownerBlock:null;if(i&&(i.worldPositionConnectionPoint=this.worldPosition,i.cameraPositionConnectionPoint=this.cameraPosition,i.worldNormalConnectionPoint=this.worldNormal,i.viewConnectionPoint=this.view),e.target!==P.Fragment)return this._injectVertexCode(e),this;e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),this.generateOnlyFragmentCode&&e.sharedData.dynamicUniformBlocks.push(this);const r=`//${this.name}`,n=this.perturbedNormal;let a=this.worldPosition.associatedVariableName,o=this.worldPosition.associatedVariableName,l=this.worldNormal.associatedVariableName;this.generateOnlyFragmentCode?(a=e._getFreeVariableName("globalWorldPos"),e._emitFunction("pbr_globalworldpos",`${e._declareLocalVar(a,p.Vector3,!1,!0)};
`,r),e.compilationString+=`${a} = ${this.worldPosition.associatedVariableName}.xyz;
`,o=e._getFreeVariableName("globalWorldPos4"),e._emitFunction("pbr_globalworldpos4",`${e._declareLocalVar(o,p.Vector4,!1,!0)};
`,r),e.compilationString+=`${o} = ${this.worldPosition.associatedVariableName};
`,l=e._getFreeVariableName("globalWorldNormal"),e._emitFunction("pbr_globalworldnorm",`${e._declareLocalVar(l,p.Vector4,!1,!0)};
`,r),e.compilationString+=`${l} = ${this.worldNormal.associatedVariableName};
`,e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{repeatKey:"maxSimultaneousLights",substitutionVars:`worldPos,${this.worldPosition.associatedVariableName}`}),e.compilationString+=`#if DEBUGMODE > 0
`,e.compilationString+=`${e._declareLocalVar("vClipSpacePosition",p.Vector4)} = vec4${e.fSuffix}((vec2${e.fSuffix}(${t?"fragmentInputs.position":"gl_FragCoord.xy"}) / vec2${e.fSuffix}(1.0)) * 2.0 - 1.0, 0.0, 1.0);
`,e.compilationString+=`#endif
`):(a=(t?"input.":"")+"v_"+a,l=(t?"input.":"")+"v_"+l),this._environmentBrdfSamplerName=e._getFreeVariableName("environmentBrdfSampler"),e._emit2DSampler(this._environmentBrdfSamplerName),e.sharedData.hints.needAlphaBlending=e.sharedData.hints.needAlphaBlending||this.useAlphaBlending,e.sharedData.hints.needAlphaTesting=e.sharedData.hints.needAlphaTesting||this.useAlphaTest,e._emitExtension("lod","#extension GL_EXT_shader_texture_lod : enable","defined(LODBASEDMICROSFURACE)"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitUniformFromString("vDebugMode",p.Vector2,"defined(IGNORE) || DEBUGMODE > 0"),e._emitUniformFromString("ambientFromScene",p.Vector3),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity"),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):(this.generateOnlyFragmentCode&&this.view.isConnected&&(e.compilationString+=`${e._declareLocalVar("vViewDepth",p.Float)} = (${this.view.associatedVariableName} * ${o}).z;
`),e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",r,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0})),e._emitFunctionFromInclude("helperFunctions",r),e._emitFunctionFromInclude("importanceSampling",r),e._emitFunctionFromInclude("pbrHelperFunctions",r),e._emitFunctionFromInclude("imageProcessingDeclaration",r),e._emitFunctionFromInclude("imageProcessingFunctions",r),e._emitFunctionFromInclude("shadowsFragmentFunctions",r),e._emitFunctionFromInclude("pbrDirectLightingSetupFunctions",r),e._emitFunctionFromInclude("pbrDirectLightingFalloffFunctions",r),e._emitFunctionFromInclude("pbrBRDFFunctions",r,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:(i==null?void 0:i._defineSkyboxName)??"REFLECTIONMAP_SKYBOX"}]}),e._emitFunctionFromInclude("hdrFilteringFunctions",r),e._emitFunctionFromInclude("pbrDirectLightingFunctions",r),e._emitFunctionFromInclude("pbrIBLFunctions",r),e._emitFunctionFromInclude("pbrBlockAlbedoOpacity",r),e._emitFunctionFromInclude("pbrBlockReflectivity",r),e._emitFunctionFromInclude("pbrBlockAmbientOcclusion",r),e._emitFunctionFromInclude("pbrBlockAlphaFresnel",r),e._emitFunctionFromInclude("pbrBlockAnisotropic",r),t||e._emitFunctionFromInclude("pbrClusteredLightingFunctions",r),e._emitUniformFromString("vLightingIntensity",p.Vector4),i!=null&&i.generateOnlyFragmentCode&&(e.compilationString+=i.handleVertexSide(e)),this._vNormalWName=e._getFreeVariableName("vNormalW"),e.compilationString+=`${e._declareLocalVar(this._vNormalWName,p.Vector4)} = normalize(${l});
`,e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`${e._declareLocalVar("viewDirectionW",p.Vector3)} = normalize(${this.cameraPosition.associatedVariableName} - ${a}.xyz);
`),e.compilationString+=`${e._declareLocalVar("geometricNormalW",p.Vector3)} = ${this._vNormalWName}.xyz;
`,e.compilationString+=`${e._declareLocalVar("normalW",p.Vector3)} = ${n.isConnected?"normalize("+n.associatedVariableName+".xyz)":"geometricNormalW"};
`,this._invertNormalName=e._getFreeVariableName("invertNormal"),e._emitUniformFromString(this._invertNormalName,p.Float),e.compilationString+=e._emitCodeFromInclude("pbrBlockNormalFinal",r,{replaceStrings:[{search:/vPositionW/g,replace:a+".xyz"},{search:/vEyePosition.w/g,replace:this._invertNormalName}]}),e.compilationString+=this._getAlbedoOpacityCode(e),e.compilationString+=e._emitCodeFromInclude("depthPrePass",r),e.compilationString+=this._getAmbientOcclusionCode(e),e.compilationString+=e._emitCodeFromInclude("pbrBlockLightmapInit",r),e.compilationString+=`#ifdef UNLIT
                ${e._declareLocalVar("diffuseBase",p.Vector3)} = vec3${e.fSuffix}(1., 1., 1.);
            #else
`,e.compilationString+=this._getReflectivityCode(e),e.compilationString+=e._emitCodeFromInclude("pbrBlockGeometryInfo",r,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:(i==null?void 0:i._defineSkyboxName)??"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:(i==null?void 0:i._define3DName)??"REFLECTIONMAP_3D"}]});const c=this.anisotropy.isConnected?(D=this.anisotropy.connectedPoint)==null?void 0:D.ownerBlock:null;c&&(c.worldPositionConnectionPoint=this.worldPosition,c.worldNormalConnectionPoint=this.worldNormal,e.compilationString+=c.getCode(e,!this.perturbedNormal.isConnected)),i&&i.hasTexture&&(e.compilationString+=i.getCode(e,c?"anisotropicOut.anisotropicNormal":"normalW")),e._emitFunctionFromInclude("pbrBlockReflection",r,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:(i==null?void 0:i._define3DName)??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:(i==null?void 0:i._defineOppositeZ)??"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:(i==null?void 0:i._defineProjectionName)??"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:(i==null?void 0:i._defineSkyboxName)??"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:(i==null?void 0:i._defineLODReflectionAlpha)??"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:(i==null?void 0:i._defineLinearSpecularReflection)??"LINEARSPECULARREFLECTION"},{search:/vReflectionFilteringInfo/g,replace:(i==null?void 0:i._vReflectionFilteringInfoName)??"vReflectionFilteringInfo"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance0",r,{replaceStrings:[{search:/metallicReflectanceFactors/g,replace:(t?"uniforms.":"")+this._vMetallicReflectanceFactorsName}]});const u=this.sheen.isConnected?(w=this.sheen.connectedPoint)==null?void 0:w.ownerBlock:null;u&&(e.compilationString+=u.getCode(i,e)),e._emitFunctionFromInclude("pbrBlockSheen",r,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:(i==null?void 0:i._define3DName)??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_SKYBOX/g,replace:(i==null?void 0:i._defineSkyboxName)??"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:(i==null?void 0:i._defineLODReflectionAlpha)??"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:(i==null?void 0:i._defineLinearSpecularReflection)??"LINEARSPECULARREFLECTION"}]});const h=this.clearcoat.isConnected?(B=this.clearcoat.connectedPoint)==null?void 0:B.ownerBlock:null;e.compilationString+=xa._GetInitializationCode(e,h);const d=this.iridescence.isConnected?(Q=this.iridescence.connectedPoint)==null?void 0:Q.ownerBlock:null;e.compilationString+=kl.GetCode(d,e),e._emitFunctionFromInclude("pbrBlockIridescence",r,{replaceStrings:[]});const f=!this.perturbedNormal.isConnected&&!this.anisotropy.isConnected,m=this.perturbedNormal.isConnected&&((re=((J=this.perturbedNormal.connectedPoint)==null?void 0:J.ownerBlock).worldTangent)==null?void 0:re.isConnected),g=this.anisotropy.isConnected&&((ne=this.anisotropy.connectedPoint)==null?void 0:ne.ownerBlock).worldTangent.isConnected;let v=m||!this.perturbedNormal.isConnected&&g;e.compilationString+=xa.GetCode(e,h,i,a,f,v,l),f&&(v=(h==null?void 0:h.worldTangent.isConnected)??!1),e._emitFunctionFromInclude("pbrBlockClearcoat",r,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:(i==null?void 0:i._define3DName)??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:(i==null?void 0:i._defineOppositeZ)??"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:(i==null?void 0:i._defineProjectionName)??"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:(i==null?void 0:i._defineSkyboxName)??"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:(i==null?void 0:i._defineLODReflectionAlpha)??"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:(i==null?void 0:i._defineLinearSpecularReflection)??"LINEARSPECULARREFLECTION"},{search:/defined\(TANGENT\)/g,replace:v?"defined(TANGENT)":"defined(IGNORE)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance",r,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:(i==null?void 0:i._defineSkyboxName)??"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:(i==null?void 0:i._define3DName)??"REFLECTIONMAP_3D"},{search:/uniforms\.vReflectivityColor/g,replace:"vReflectivityColor"}]});const E=this.subsurface.isConnected?(fe=this.subsurface.connectedPoint)==null?void 0:fe.ownerBlock:null,T=this.subsurface.isConnected?(Me=((be=this.subsurface.connectedPoint)==null?void 0:be.ownerBlock).refraction.connectedPoint)==null?void 0:Me.ownerBlock:null;if(T&&(T.viewConnectionPoint=this.view,T.indexOfRefractionConnectionPoint=this.indexOfRefraction),e.compilationString+=Po.GetCode(e,E,i,a),e._emitFunctionFromInclude("pbrBlockSubSurface",r,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:(i==null?void 0:i._define3DName)??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:(i==null?void 0:i._defineOppositeZ)??"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:(i==null?void 0:i._defineProjectionName)??"REFLECTIONMAP_PROJECTION"},{search:/SS_REFRACTIONMAP_3D/g,replace:(T==null?void 0:T._define3DName)??"SS_REFRACTIONMAP_3D"},{search:/SS_LODINREFRACTIONALPHA/g,replace:(T==null?void 0:T._defineLODRefractionAlpha)??"SS_LODINREFRACTIONALPHA"},{search:/SS_LINEARSPECULARREFRACTION/g,replace:(T==null?void 0:T._defineLinearSpecularRefraction)??"SS_LINEARSPECULARREFRACTION"},{search:/SS_REFRACTIONMAP_OPPOSITEZ/g,replace:(T==null?void 0:T._defineOppositeZ)??"SS_REFRACTIONMAP_OPPOSITEZ"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockDirectLighting",r),this.light)e.compilationString+=e._emitCodeFromInclude("lightFragment",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:new RegExp(`${t?"fragmentInputs.":""}vPositionW`,"g"),replace:a+".xyz"},{search:/uniforms\.vReflectivityColor/g,replace:"vReflectivityColor"}]});else{let ce=`vPositionW,${a}.xyz`;t&&(ce="fragmentInputs."+ce,this.generateOnlyFragmentCode&&(ce+=",fragmentInputs.vViewDepth,vViewDepth")),e.compilationString+=e._emitCodeFromInclude("lightFragment",r,{repeatKey:"maxSimultaneousLights",substitutionVars:ce+",uniforms.vReflectivityColor,vReflectivityColor"})}e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalLitComponents",r),e.compilationString+=`#endif
`;const C=this.ambientColor.isConnected?this.ambientColor.associatedVariableName:`vec3${e.fSuffix}(0., 0., 0.)`;let A=Ve.DEFAULT_AO_ON_ANALYTICAL_LIGHTS.toString();A.indexOf(".")===-1&&(A+=".");let I=[{search:/vec3 finalEmissive[\s\S]*?finalEmissive\*=vLightingIntensity\.y;/g,replace:""},{search:new RegExp(`${t?"uniforms.":""}vAmbientColor`,"g"),replace:C+` * ${t?"uniforms.":""}ambientFromScene`},{search:new RegExp(`${t?"uniforms.":""}vAmbientInfos.w`,"g"),replace:A}];t&&(I[0]={search:/var finalEmissive[\s\S]*?finalEmissive\*=uniforms.vLightingIntensity\.y;/g,replace:""}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalUnlitComponents",r,{replaceStrings:I}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalColorComposition",r,{replaceStrings:[{search:/finalEmissive/g,replace:`vec3${e.fSuffix}(0.)`}]}),t?I=[{search:/mesh.visibility/g,replace:"1."}]:I=[{search:/visibility/g,replace:"1."}],e.compilationString+=e._emitCodeFromInclude("pbrBlockImageProcessing",r,{replaceStrings:I});const F=t?"fragmentOutputs.color":"gl_FragColor";I=[{search:new RegExp(`${t?"fragmentInputs.":""}vNormalW`,"g"),replace:this._vNormalWName},{search:new RegExp(`${t?"fragmentInputs.":""}vPositionW`,"g"),replace:a},{search:/uniforms\.vReflectivityColor/g,replace:"vReflectivityColor"},{search:/albedoTexture\.rgb;/g,replace:`vec3${e.fSuffix}(1.);
${F}.rgb = toGammaSpace(${F}.rgb);
`}],e.compilationString+=e._emitCodeFromInclude("pbrDebug",r,{replaceStrings:I});for(const ce of this._outputs)if(ce.hasEndpoints){const bt=i4[ce.name];if(bt){const[Pt,Yt]=bt;Yt&&(e.compilationString+=`#if ${Yt}
`),e.compilationString+=`${e._declareOutput(ce)} = ${Pt};
`,Yt&&(e.compilationString+=`#else
`,e.compilationString+=`${e._declareOutput(ce)} = vec3${e.fSuffix}(0.);
`,e.compilationString+=`#endif
`)}else e.sharedData.raiseBuildError(`There's no remapping for the ${ce.name} end point! No code generated`)}return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.lightFalloff = ${this.lightFalloff};
`,e+=`${this._codeVariableName}.useAlphaTest = ${this.useAlphaTest};
`,e+=`${this._codeVariableName}.alphaTestCutoff = ${this.alphaTestCutoff};
`,e+=`${this._codeVariableName}.useAlphaBlending = ${this.useAlphaBlending};
`,e+=`${this._codeVariableName}.useRadianceOverAlpha = ${this.useRadianceOverAlpha};
`,e+=`${this._codeVariableName}.useSpecularOverAlpha = ${this.useSpecularOverAlpha};
`,e+=`${this._codeVariableName}.enableSpecularAntiAliasing = ${this.enableSpecularAntiAliasing};
`,e+=`${this._codeVariableName}.realTimeFiltering = ${this.realTimeFiltering};
`,e+=`${this._codeVariableName}.realTimeFilteringQuality = ${this.realTimeFilteringQuality};
`,e+=`${this._codeVariableName}.useEnergyConservation = ${this.useEnergyConservation};
`,e+=`${this._codeVariableName}.useRadianceOcclusion = ${this.useRadianceOcclusion};
`,e+=`${this._codeVariableName}.useHorizonOcclusion = ${this.useHorizonOcclusion};
`,e+=`${this._codeVariableName}.unlit = ${this.unlit};
`,e+=`${this._codeVariableName}.forceNormalForward = ${this.forceNormalForward};
`,e+=`${this._codeVariableName}.debugMode = ${this.debugMode};
`,e+=`${this._codeVariableName}.debugLimit = ${this.debugLimit};
`,e+=`${this._codeVariableName}.debugFactor = ${this.debugFactor};
`,e}serialize(){const e=super.serialize();return this.light&&(e.lightId=this.light.id),e.lightFalloff=this.lightFalloff,e.useAlphaTest=this.useAlphaTest,e.alphaTestCutoff=this.alphaTestCutoff,e.useAlphaBlending=this.useAlphaBlending,e.useRadianceOverAlpha=this.useRadianceOverAlpha,e.useSpecularOverAlpha=this.useSpecularOverAlpha,e.enableSpecularAntiAliasing=this.enableSpecularAntiAliasing,e.realTimeFiltering=this.realTimeFiltering,e.realTimeFilteringQuality=this.realTimeFilteringQuality,e.useEnergyConservation=this.useEnergyConservation,e.useRadianceOcclusion=this.useRadianceOcclusion,e.useHorizonOcclusion=this.useHorizonOcclusion,e.unlit=this.unlit,e.forceNormalForward=this.forceNormalForward,e.debugMode=this.debugMode,e.debugLimit=this.debugLimit,e.debugFactor=this.debugFactor,e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.lightFalloff=e.lightFalloff??0,this.useAlphaTest=e.useAlphaTest,this.alphaTestCutoff=e.alphaTestCutoff,this.useAlphaBlending=e.useAlphaBlending,this.useRadianceOverAlpha=e.useRadianceOverAlpha,this.useSpecularOverAlpha=e.useSpecularOverAlpha,this.enableSpecularAntiAliasing=e.enableSpecularAntiAliasing,this.realTimeFiltering=!!e.realTimeFiltering,this.realTimeFilteringQuality=e.realTimeFilteringQuality??8,this.useEnergyConservation=e.useEnergyConservation,this.useRadianceOcclusion=e.useRadianceOcclusion,this.useHorizonOcclusion=e.useHorizonOcclusion,this.unlit=e.unlit,this.forceNormalForward=!!e.forceNormalForward,this.debugMode=e.debugMode,this.debugLimit=e.debugLimit,this.debugFactor=e.debugFactor,this.generateOnlyFragmentCode=!!e.generateOnlyFragmentCode,this._setTarget()}}_([O("Direct lights",1,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],Zt.prototype,"directIntensity",void 0);_([O("Environment lights",1,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],Zt.prototype,"environmentIntensity",void 0);_([O("Specular highlights",1,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],Zt.prototype,"specularIntensity",void 0);_([O("Light falloff",5,"LIGHTING & COLORS",{notifiers:{update:!0},options:[{label:"Physical",value:Ve.LIGHTFALLOFF_PHYSICAL},{label:"GLTF",value:Ve.LIGHTFALLOFF_GLTF},{label:"Standard",value:Ve.LIGHTFALLOFF_STANDARD}]})],Zt.prototype,"lightFalloff",void 0);_([O("Alpha Testing",0,"OPACITY")],Zt.prototype,"useAlphaTest",void 0);_([O("Alpha CutOff",1,"OPACITY",{min:0,max:1,notifiers:{update:!0}})],Zt.prototype,"alphaTestCutoff",void 0);_([O("Alpha blending",0,"OPACITY")],Zt.prototype,"useAlphaBlending",void 0);_([O("Radiance over alpha",0,"RENDERING",{notifiers:{update:!0}})],Zt.prototype,"useRadianceOverAlpha",void 0);_([O("Specular over alpha",0,"RENDERING",{notifiers:{update:!0}})],Zt.prototype,"useSpecularOverAlpha",void 0);_([O("Specular anti-aliasing",0,"RENDERING",{notifiers:{update:!0}})],Zt.prototype,"enableSpecularAntiAliasing",void 0);_([O("Realtime filtering",0,"RENDERING",{notifiers:{update:!0}})],Zt.prototype,"realTimeFiltering",void 0);_([O("Realtime filtering quality",5,"RENDERING",{notifiers:{update:!0},options:[{label:"Low",value:8},{label:"Medium",value:16},{label:"High",value:64}]})],Zt.prototype,"realTimeFilteringQuality",void 0);_([O("Diffuse Model",5,"RENDERING",{notifiers:{update:!0},options:[{label:"Lambert",value:2},{label:"Burley",value:1},{label:"Oren-Nayar",value:0},{label:"Legacy",value:3}]})],Zt.prototype,"baseDiffuseModel",void 0);_([O("Energy Conservation",0,"ADVANCED",{notifiers:{update:!0}})],Zt.prototype,"useEnergyConservation",void 0);_([O("Radiance occlusion",0,"ADVANCED",{notifiers:{update:!0}})],Zt.prototype,"useRadianceOcclusion",void 0);_([O("Horizon occlusion",0,"ADVANCED",{notifiers:{update:!0}})],Zt.prototype,"useHorizonOcclusion",void 0);_([O("Unlit",0,"ADVANCED",{notifiers:{update:!0}})],Zt.prototype,"unlit",void 0);_([O("Force normal forward",0,"ADVANCED",{notifiers:{update:!0}})],Zt.prototype,"forceNormalForward",void 0);_([O("Generate only fragment code",0,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:Zt._OnGenerateOnlyFragmentCodeChanged}})],Zt.prototype,"generateOnlyFragmentCode",void 0);_([O("Debug mode",5,"DEBUG",{notifiers:{update:!0},options:[{label:"None",value:0},{label:"Normalized position",value:1},{label:"Normals",value:2},{label:"Tangents",value:3},{label:"Bitangents",value:4},{label:"Bump Normals",value:5},{label:"ClearCoat Normals",value:8},{label:"ClearCoat Tangents",value:9},{label:"ClearCoat Bitangents",value:10},{label:"Anisotropic Normals",value:11},{label:"Anisotropic Tangents",value:12},{label:"Anisotropic Bitangents",value:13},{label:"Env Refraction",value:40},{label:"Env Reflection",value:41},{label:"Env Clear Coat",value:42},{label:"Direct Diffuse",value:50},{label:"Direct Specular",value:51},{label:"Direct Clear Coat",value:52},{label:"Direct Sheen",value:53},{label:"Env Irradiance",value:54},{label:"Surface Albedo",value:60},{label:"Reflectance 0",value:61},{label:"Metallic",value:62},{label:"Metallic F0",value:71},{label:"Roughness",value:63},{label:"AlphaG",value:64},{label:"NdotV",value:65},{label:"ClearCoat Color",value:66},{label:"ClearCoat Roughness",value:67},{label:"ClearCoat NdotV",value:68},{label:"Transmittance",value:69},{label:"Refraction Transmittance",value:70},{label:"SEO",value:80},{label:"EHO",value:81},{label:"Energy Factor",value:82},{label:"Specular Reflectance",value:83},{label:"Clear Coat Reflectance",value:84},{label:"Sheen Reflectance",value:85},{label:"Luminance Over Alpha",value:86},{label:"Alpha",value:87},{label:"Albedo color",value:88},{label:"Ambient occlusion color",value:89}]})],Zt.prototype,"debugMode",void 0);_([O("Split position",1,"DEBUG",{min:-1,max:1,notifiers:{update:!0}})],Zt.prototype,"debugLimit",void 0);_([O("Output factor",1,"DEBUG",{min:0,max:5,notifiers:{update:!0}})],Zt.prototype,"debugFactor",void 0);y("BABYLON.PBRMetallicRoughnessBlock",Zt);class r4 extends ie{constructor(e){super(e,P.Neutral),this.registerInput("left",p.AutoDetect),this.registerInput("right",p.AutoDetect),this.registerOutput("output",p.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[1].acceptedConnectionPointTypes.push(p.Float)}getClassName(){return"ModBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.shaderLanguage===0?e.compilationString+=e._declareOutput(t)+` = mod(${this.left.associatedVariableName}, ${this.right.associatedVariableName});
`:e.compilationString+=e._declareOutput(t)+` = (${this.left.associatedVariableName} % ${this.right.associatedVariableName});
`,this}}y("BABYLON.ModBlock",r4);class s4 extends ie{constructor(e){super(e,P.Neutral),this.registerInput("row0",p.Vector4),this.registerInput("row1",p.Vector4),this.registerInput("row2",p.Vector4),this.registerInput("row3",p.Vector4),this.registerOutput("output",p.Matrix)}getClassName(){return"MatrixBuilder"}get row0(){return this._inputs[0]}get row1(){return this._inputs[1]}get row2(){return this._inputs[2]}get row3(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(){if(!this.row0.isConnected){const e=new ge("row0");e.value=new Ee(1,0,0,0),e.output.connectTo(this.row0)}if(!this.row1.isConnected){const e=new ge("row1");e.value=new Ee(0,1,0,0),e.output.connectTo(this.row1)}if(!this.row2.isConnected){const e=new ge("row2");e.value=new Ee(0,0,1,0),e.output.connectTo(this.row2)}if(!this.row3.isConnected){const e=new ge("row3");e.value=new Ee(0,0,0,1),e.output.connectTo(this.row3)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.row0,r=this.row1,n=this.row2,a=this.row3,o=e.shaderLanguage===1?"mat4x4f":"mat4";return e.compilationString+=e._declareOutput(t)+` = ${o}(${i.associatedVariableName}, ${r.associatedVariableName}, ${n.associatedVariableName}, ${a.associatedVariableName});
`,this}}y("BABYLON.MatrixBuilder",s4);var ai;(function(s){s[s.Equal=0]="Equal",s[s.NotEqual=1]="NotEqual",s[s.LessThan=2]="LessThan",s[s.GreaterThan=3]="GreaterThan",s[s.LessOrEqual=4]="LessOrEqual",s[s.GreaterOrEqual=5]="GreaterOrEqual",s[s.Xor=6]="Xor",s[s.Or=7]="Or",s[s.And=8]="And"})(ai||(ai={}));class e0 extends ie{constructor(e){super(e,P.Neutral),this.condition=ai.LessThan,this.registerInput("a",p.Float),this.registerInput("b",p.Float),this.registerInput("true",p.AutoDetect,!0),this.registerInput("false",p.AutoDetect,!0),this.registerOutput("output",p.BasedOnInput),this._linkConnectionTypes(2,3),this._outputs[0]._typeConnectionSource=this._inputs[2],this._outputs[0]._defaultConnectionPointType=p.Float}getClassName(){return"ConditionalBlock"}get a(){return this._inputs[0]}get b(){return this._inputs[1]}get true(){return this._inputs[2]}get false(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(e){if(!this.true.isConnected){const t=e.getBlockByPredicate(i=>i.isInput&&i.value===1&&i.name==="True")||new ge("True");t.value=1,t.output.connectTo(this.true)}if(!this.false.isConnected){const t=e.getBlockByPredicate(i=>i.isInput&&i.value===0&&i.name==="False")||new ge("False");t.value=0,t.output.connectTo(this.false)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.true.isConnected?this.true.associatedVariableName:"1.0",r=this.false.isConnected?this.false.associatedVariableName:"0.0";switch(this.condition){case ai.Equal:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} == ${this.b.associatedVariableName}`)};
`;break}case ai.NotEqual:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} != ${this.b.associatedVariableName}`)};
`;break}case ai.LessThan:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} < ${this.b.associatedVariableName}`)};
`;break}case ai.LessOrEqual:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} <= ${this.b.associatedVariableName}`)};
`;break}case ai.GreaterThan:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} > ${this.b.associatedVariableName}`)};
`;break}case ai.GreaterOrEqual:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} >= ${this.b.associatedVariableName}`)};
`;break}case ai.Xor:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`(((${this.a.associatedVariableName} + ${this.b.associatedVariableName}) % 2.0) > 0.0)`)};
`;break}case ai.Or:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`(min(${this.a.associatedVariableName} + ${this.b.associatedVariableName}, 1.0) > 0.0)`)};
`;break}case ai.And:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`(${this.a.associatedVariableName} * ${this.b.associatedVariableName} > 0.0)`)};
`;break}}return this}serialize(){const e=super.serialize();return e.condition=this.condition,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.condition=e.condition}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.condition = BABYLON.ConditionalBlockConditions.${ai[this.condition]};
`}}_([O("Condition",5,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Equal",value:ai.Equal},{label:"NotEqual",value:ai.NotEqual},{label:"LessThan",value:ai.LessThan},{label:"GreaterThan",value:ai.GreaterThan},{label:"LessOrEqual",value:ai.LessOrEqual},{label:"GreaterOrEqual",value:ai.GreaterOrEqual},{label:"Xor",value:ai.Xor},{label:"And",value:ai.And},{label:"Or",value:ai.Or}]})],e0.prototype,"condition",void 0);y("BABYLON.ConditionalBlock",e0);class t0 extends ie{constructor(e){super(e,P.Neutral),this.octaves=6,this.registerInput("seed",p.AutoDetect),this.registerInput("chaos",p.AutoDetect,!0),this.registerInput("offsetX",p.Float,!0),this.registerInput("offsetY",p.Float,!0),this.registerInput("offsetZ",p.Float,!0),this.registerOutput("output",p.Float),this._inputs[0].acceptedConnectionPointTypes.push(p.Vector2),this._inputs[0].acceptedConnectionPointTypes.push(p.Vector3),this._linkConnectionTypes(0,1)}getClassName(){return"CloudBlock"}get seed(){return this._inputs[0]}get chaos(){return this._inputs[1]}get offsetX(){return this._inputs[2]}get offsetY(){return this._inputs[3]}get offsetZ(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){var l,c,u;if(super._buildBlock(e),!this.seed.isConnected||!this._outputs[0].hasEndpoints)return;let t=`

        float cloudRandom(float p) { 
            float temp = fract(p * 0.011); 
            temp *= temp + 7.5; 
            temp *= temp + temp; 
            return fract(temp); 
        }

        // Based on Morgan McGuire @morgan3d
        // https://www.shadertoy.com/view/4dS3Wd
        float cloudNoise2(vec2 x, vec2 chaos) {
            vec2 step = chaos * vec2(75., 120.) + vec2(75., 120.);

            vec2 i = floor(x);
            vec2 f = fract(x);

            float n = dot(i, step);

            vec2 u = f * f * (3.0 - 2.0 * f);
            return mix(
                    mix(cloudRandom(n + dot(step, vec2(0, 0))), cloudRandom(n + dot(step, vec2(1, 0))), u.x),
                    mix(cloudRandom(n + dot(step, vec2(0, 1))), cloudRandom(n + dot(step, vec2(1, 1))), u.x),
                    u.y
                );
        }

        float cloudNoise3(vec3 x, vec3 chaos) {
            vec3 step = chaos * vec3(60., 120., 75.) + vec3(60., 120., 75.);

            vec3 i = floor(x);
            vec3 f = fract(x);

            float n = dot(i, step);

            vec3 u = f * f * (3.0 - 2.0 * f);
            return mix(mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 0))), cloudRandom(n + dot(step, vec3(1, 0, 0))), u.x),
                           mix( cloudRandom(n + dot(step, vec3(0, 1, 0))), cloudRandom(n + dot(step, vec3(1, 1, 0))), u.x), u.y),
                       mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 1))), cloudRandom(n + dot(step, vec3(1, 0, 1))), u.x),
                           mix( cloudRandom(n + dot(step, vec3(0, 1, 1))), cloudRandom(n + dot(step, vec3(1, 1, 1))), u.x), u.y), u.z);
        }`,i=`
        float fbm2(vec2 st, vec2 chaos) {
            // Initial values
            float value = 0.0;
            float amplitude = .5;
            float frequency = 0.;

            // Loop of octaves
            vec2 tempST = st;
            for (int i = 0; i < OCTAVES; i++) {
                value += amplitude * cloudNoise2(tempST, chaos);
                tempST *= 2.0;
                amplitude *= 0.5;
            }
            return value;
        }

        float fbm3(vec3 x, vec3 chaos) {
            // Initial values
            float value = 0.0;
            float amplitude = 0.5;
            vec3 tempX = x;
            for (int i = 0; i < OCTAVES; i++) {
                value += amplitude * cloudNoise3(tempX, chaos);
                tempX = tempX * 2.0;
                amplitude *= 0.5;
            }
            return value;
        }`;e.shaderLanguage===1&&(t=e._babylonSLtoWGSL(t),i=e._babylonSLtoWGSL(i));const r=`fbm${this.octaves}`;e._emitFunction("CloudBlockCode",t,"// CloudBlockCode"),e._emitFunction("CloudBlockCodeFBM"+this.octaves,i.replace(/fbm/gi,r).replace(/OCTAVES/gi,(this.octaves|0).toString()),"// CloudBlockCode FBM");const n=e._getFreeVariableName("st"),a=((l=this.seed.connectedPoint)==null?void 0:l.type)||p.Vector3;e.compilationString+=`${e._declareLocalVar(n,a)} = ${this.seed.associatedVariableName};
`,this.offsetX.isConnected&&(e.compilationString+=`${n}.x += 0.1 * ${this.offsetX.associatedVariableName};
`),this.offsetY.isConnected&&(e.compilationString+=`${n}.y += 0.1 * ${this.offsetY.associatedVariableName};
`),this.offsetZ.isConnected&&a===p.Vector3&&(e.compilationString+=`${n}.z += 0.1 * ${this.offsetZ.associatedVariableName};
`);let o="";if(this.chaos.isConnected)o=this.chaos.associatedVariableName;else{const h=e.fSuffix;o=((c=this.seed.connectedPoint)==null?void 0:c.type)===p.Vector2?`vec2${h}(0., 0.)`:`vec3${h}(0., 0., 0.)`}return e.compilationString+=e._declareOutput(this._outputs[0])+` = ${r}${((u=this.seed.connectedPoint)==null?void 0:u.type)===p.Vector2?"2":"3"}(${n}, ${o});
`,this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.octaves = ${this.octaves};
`}serialize(){const e=super.serialize();return e.octaves=this.octaves,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.octaves=e.octaves}}_([O("Octaves",2,void 0,{embedded:!0})],t0.prototype,"octaves",void 0);y("BABYLON.CloudBlock",t0);class n4 extends ie{constructor(e){super(e,P.Neutral),this.registerInput("seed",p.Vector2),this.registerInput("offset",p.Float),this.registerInput("density",p.Float),this.registerOutput("output",p.Float),this.registerOutput("cells",p.Float)}getClassName(){return"VoronoiNoiseBlock"}get seed(){return this._inputs[0]}get offset(){return this._inputs[1]}get density(){return this._inputs[2]}get output(){return this._outputs[0]}get cells(){return this._outputs[1]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;let t=`vec2 voronoiRandom(vec2 p){
            p = vec2(dot(p,vec2(127.1,311.7)),dot(p,vec2(269.5,183.3)));
            return fract(sin(p)*18.5453);
        }
        `;e.shaderLanguage===1&&(t=e._babylonSLtoWGSL(t)),e._emitFunction("voronoiRandom",t,"// Voronoi random generator"),t=`void voronoi(vec2 seed, float offset, float density, out float outValue, out float cells){
            vec2 n = floor(seed * density);
            vec2 f = fract(seed * density);
            vec3 m = vec3( 8.0 );
            for( int j=-1; j<=1; j++ ){
                for( int i=-1; i<=1; i++ ){
                    vec2  g = vec2( float(i), float(j) );
                    vec2  o = voronoiRandom( n + g);
                    vec2  r = g - f + (0.5+0.5*sin(offset+6.2831*o));
                    float d = dot( r, r );
                    if( d<m.x ){
                        m = vec3( d, o );
                        outValue = m.x;
                        cells = m.y;
                    }
                }
			}
        }
        `,e.shaderLanguage===1?t=e._babylonSLtoWGSL(t):t=e._babylonSLtoGLSL(t),e._emitFunction("voronoi",t,"// Voronoi");const i=e._getFreeVariableName("tempOutput"),r=e._getFreeVariableName("tempCells"),n=e.shaderLanguage===1?"&":"";return e.compilationString+=`${e._declareLocalVar(i,p.Float)} = 0.0;
`,e.compilationString+=`${e._declareLocalVar(r,p.Float)} = 0.0;
`,e.compilationString+=`voronoi(${this.seed.associatedVariableName}, ${this.offset.associatedVariableName}, ${this.density.associatedVariableName}, ${n}${i}, ${n}${r});
`,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${i};
`),this.cells.hasEndpoints&&(e.compilationString+=e._declareOutput(this.cells)+` = ${r};
`),this}}y("BABYLON.VoronoiNoiseBlock",n4);class a4 extends ie{constructor(e){super(e,P.Neutral),this.registerInput("input",p.AutoDetect),this.registerOutput("output",p.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ElbowBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}get target(){const e=this._inputs[0];if(e.isConnected){const t=e.connectedPoint.ownerBlock;if(t.target!==P.VertexAndFragment)return t.target;if(e.connectedPoint.target!==P.VertexAndFragment)return e.connectedPoint.target}return this._target}set target(e){this._target&e||(this._target=e)}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];return e.compilationString+=e._declareOutput(t)+` = ${i.associatedVariableName};
`,this}}y("BABYLON.ElbowBlock",a4);class V_ extends ie{get texture(){var e;return this.source.isConnected?((e=this.source.connectedPoint)==null?void 0:e.ownerBlock).texture:this._texture}set texture(e){if(this._texture===e)return;const t=(e==null?void 0:e.getScene())??De.LastCreatedScene;!e&&t&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this._texture)),this._texture=e,e&&t&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(e))}get textureY(){var e;return this.sourceY.isConnected?((e=this.sourceY.connectedPoint)==null?void 0:e.ownerBlock).texture:null}get textureZ(){var e,t;return(e=this.sourceZ)!=null&&e.isConnected?((t=this.sourceY.connectedPoint)==null?void 0:t.ownerBlock).texture:null}_getImageSourceBlock(e){return e!=null&&e.isConnected?e.connectedPoint.ownerBlock:null}get samplerName(){const e=this._getImageSourceBlock(this.source);return e?e.samplerName:this._samplerName}get samplerYName(){var e;return((e=this._getImageSourceBlock(this.sourceY))==null?void 0:e.samplerName)??null}get samplerZName(){var e;return((e=this._getImageSourceBlock(this.sourceZ))==null?void 0:e.samplerName)??null}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(e){if(e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)){const t=this.texture.getScene()??De.LastCreatedScene;t==null||t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this.texture))}}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){if(e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)){const t=this.texture.getScene()??De.LastCreatedScene;t==null||t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this.texture))}}get convertToLinearSpace(){return this._convertToLinearSpace}constructor(e,t=!1){super(e,P.Neutral),this.projectAsCube=!1,this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this.registerInput("position",p.AutoDetect,!1),this.registerInput("normal",p.AutoDetect,!1),this.registerInput("sharpness",p.Float,!0),this.registerInput("source",p.Object,!0,P.VertexAndFragment,new at("source",this,0,Bi,"ImageSourceBlock")),this.registerInput("sourceY",p.Object,!0,P.VertexAndFragment,new at("sourceY",this,0,Bi,"ImageSourceBlock")),t||this.registerInput("sourceZ",p.Object,!0,P.VertexAndFragment,new at("sourceZ",this,0,Bi,"ImageSourceBlock")),this.registerOutput("rgba",p.Color4,P.Neutral),this.registerOutput("rgb",p.Color3,P.Neutral),this.registerOutput("r",p.Float,P.Neutral),this.registerOutput("g",p.Float,P.Neutral),this.registerOutput("b",p.Float,P.Neutral),this.registerOutput("a",p.Float,P.Neutral),this.registerOutput("level",p.Float,P.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(p.Color3|p.Vector3|p.Vector4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(p.Color3|p.Vector3|p.Vector4)}getClassName(){return"TriPlanarBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get sharpness(){return this._inputs[2]}get source(){return this._inputs[3]}get sourceY(){return this._inputs[4]}get sourceZ(){return this._inputs[5]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}prepareDefines(e){if(!e._areTexturesDirty)return;const t=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,i=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;e.setValue(this._linearDefineName,t,!0),e.setValue(this._gammaDefineName,i,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}bind(e){this.texture&&(e.setFloat(this._textureInfoName,this.texture.level),this._imageSource||e.setTexture(this._samplerName,this.texture))}_samplerFunc(e){return e.shaderLanguage===1?"textureSample":"texture2D"}_generateTextureSample(e,t,i){return i.shaderLanguage===1?`${this._samplerFunc(i)}(${e},${e+"Sampler"}, ${t})`:`${this._samplerFunc(i)}(${e}, ${t})`}_generateTextureLookup(e){const t=this.samplerName,i=this.samplerYName??t,r=this.samplerZName??t,n=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",a=e._getFreeVariableName("x"),o=e._getFreeVariableName("y"),l=e._getFreeVariableName("z"),c=e._getFreeVariableName("w"),u=e._getFreeVariableName("n"),h=e._getFreeVariableName("uvx"),d=e._getFreeVariableName("uvy"),f=e._getFreeVariableName("uvz");e.compilationString+=`
            ${e._declareLocalVar(u,p.Vector3)} = ${this.normal.associatedVariableName}.xyz;

            ${e._declareLocalVar(h,p.Vector2)} = ${this.position.associatedVariableName}.yz;
            ${e._declareLocalVar(d,p.Vector2)} = ${this.position.associatedVariableName}.zx;
            ${e._declareLocalVar(f,p.Vector2)} = ${this.position.associatedVariableName}.xy;
        `,this.projectAsCube&&(e.compilationString+=`
                ${h}.xy = ${h}.yx;

                if (${u}.x >= 0.0) {
                    ${h}.x = -${h}.x;
                }
                if (${u}.y < 0.0) {
                    ${d}.y = -${d}.y;
                }
                if (${u}.z < 0.0) {
                    ${f}.x = -${f}.x;
                }
            `);const m=e.fSuffix;e.compilationString+=`
            ${e._declareLocalVar(a,p.Vector4)} = ${this._generateTextureSample(t,h,e)};
            ${e._declareLocalVar(o,p.Vector4)} = ${this._generateTextureSample(i,d,e)};
            ${e._declareLocalVar(l,p.Vector4)} = ${this._generateTextureSample(r,f,e)};
           
            // blend weights
            ${e._declareLocalVar(c,p.Vector3)} = pow(abs(${u}), vec3${m}(${n}));

            // blend and return
            ${e._declareLocalVar(this._tempTextureRead,p.Vector4)} = (${a}*${c}.x + ${o}*${c}.y + ${l}*${c}.z) / (${c}.x + ${c}.y + ${c}.z);        
        `}_generateConversionCode(e,t,i){let r="";e.shaderLanguage===1&&(t.type===p.Vector3||t.type===p.Color3)&&(r="Vec3"),i!=="a"&&((!this.texture||!this.texture.gammaSpace)&&(e.compilationString+=`#ifdef ${this._linearDefineName}
                    ${t.associatedVariableName} = toGammaSpace${r}(${t.associatedVariableName});
                    #endif
                `),e.compilationString+=`#ifdef ${this._gammaDefineName}
                ${t.associatedVariableName} = toLinearSpace${r}(${t.associatedVariableName});
                #endif
            `)}_writeOutput(e,t,i){let r="";this.disableLevelMultiplication||(r=` * ${e.shaderLanguage===1?"uniforms.":""}${this._textureInfoName}`),e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i}${r};
`,this._generateConversionCode(e,t,i)}_buildBlock(e){super._buildBlock(e),this.source.isConnected?this._imageSource=this.source.connectedPoint.ownerBlock:this._imageSource=null,this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=(e.shaderLanguage===1?"uniforms.":"")+this._textureInfoName,this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA"),this._imageSource||(this._samplerName=e._getFreeVariableName(this.name+"Texture"),e._emit2DSampler(this._samplerName)),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e._emitUniformFromString(this._textureInfoName,p.Float),this._generateTextureLookup(e);for(const i of this._outputs)i.hasEndpoints&&i.name!=="level"&&this._writeOutput(e,i,i.name);return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};
`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};
`,e+=`${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};
`,e+=`${this._codeVariableName}.projectAsCube = ${this.projectAsCube};
`,this.texture&&(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});
`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};
`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};
`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};
`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};
`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};
`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};
`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};
`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};
`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};
`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};
`),e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.disableLevelMultiplication=this.disableLevelMultiplication,e.projectAsCube=this.projectAsCube,!this.hasImageSource&&this.texture&&!this.texture.isRenderTarget&&this.texture.getClassName()!=="VideoTexture"&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this.disableLevelMultiplication=!!e.disableLevelMultiplication,this.projectAsCube=!!e.projectAsCube,e.texture&&!it.IgnoreTexturesAtLoadTime&&e.texture.url!==void 0&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=$.Parse(e.texture,t,i))}}_([O("Project as cube",0,"ADVANCED",{embedded:!0,notifiers:{update:!0}})],V_.prototype,"projectAsCube",void 0);y("BABYLON.TriPlanarBlock",V_);class o4 extends V_{constructor(e){super(e,!0)}getClassName(){return"BiPlanarBlock"}_declareLocalVarAsVec3I(e,t){return t.shaderLanguage===1?`var ${e}: vec3<i32>`:`ivec3 ${e}`}_getTextureGrad(e,t){return e.shaderLanguage===1?`textureSampleGrad(${t},${t+"Sampler"}`:`textureGrad(${t}`}_generateTextureLookup(e){const t=this.samplerName,i=this.samplerYName??this.samplerName,r=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",n=e._getFreeVariableName("dxValue"),a=e._getFreeVariableName("dyValue"),o=e._getFreeVariableName("n"),l=e._getFreeVariableName("ma"),c=e._getFreeVariableName("mi"),u=e._getFreeVariableName("me"),h=e._getFreeVariableName("x"),d=e._getFreeVariableName("y"),f=e._getFreeVariableName("w");let m="ivec3",g="dFdx",v="dFdy";const E=e.fSuffix;e.shaderLanguage===1&&(m="vec3<i32>",g="dpdx",v="dpdy"),e.compilationString+=`
            // grab coord derivatives for texturing
            ${e._declareLocalVar(n,p.Vector3)} = ${g}(${this.position.associatedVariableName}.xyz);
            ${e._declareLocalVar(a,p.Vector3)} = ${v}(${this.position.associatedVariableName}.xyz);
            ${e._declareLocalVar(o,p.Vector3)} = abs(${this.normal.associatedVariableName}.xyz);
        
            // determine major axis (in x; yz are following axis)
            ${this._declareLocalVarAsVec3I(l,e)} = ${e._generateTernary(`${m}(0,1,2)`,`${e._generateTernary(`${m}(1,2,0)`,`${m}(2,0,1)`,`(${o}.y>${o}.z)`)}`,`(${o}.x>${o}.y && ${o}.x>${o}.z)`)};                    

            // determine minor axis (in x; yz are following axis)
            ${this._declareLocalVarAsVec3I(c,e)} =  ${e._generateTernary(`${m}(0,1,2)`,`${e._generateTernary(`${m}(1,2,0)`,`${m}(2,0,1)`,`(${o}.y<${o}.z)`)}`,`(${o}.x<${o}.y && ${o}.x<${o}.z)`)};  
                              
            // determine median axis (in x;  yz are following axis)
            ${this._declareLocalVarAsVec3I(u,e)} = ${m}(3) - ${c} - ${l};
            
            // project+fetch
            ${e._declareLocalVar(h,p.Vector4)} = ${this._getTextureGrad(e,t)}, vec2${E}(${this.position.associatedVariableName}[${l}.y], ${this.position.associatedVariableName}[${l}.z]), 
                                    vec2${E}(${n}[${l}.y],${n}[${l}.z]), 
                                    vec2${E}(${a}[${l}.y],${a}[${l}.z]));
            ${e._declareLocalVar(d,p.Vector4)} = ${this._getTextureGrad(e,i)}, vec2${E}(${this.position.associatedVariableName}[${u}.y], ${this.position.associatedVariableName}[${u}.z]), 
                                    vec2${E}(${n}[${u}.y],${n}[${u}.z]),
                                    vec2${E}(${a}[${u}.y],${a}[${u}.z]));
            
            // blend factors
            ${e._declareLocalVar(f,p.Vector2)} = vec2${E}(${o}[${l}.x],${o}[${u}.x]);
            // make local support
            ${f} = clamp( (${f}-0.5773)/(1.0-0.5773), vec2${E}(0.0), vec2${E}(1.0) );
            // shape transition
            ${f} = pow( ${f}, vec2${E}(${r}/8.0) );
            // blend and return
            ${e._declareLocalVar(this._tempTextureRead,p.Vector4)} = (${h}*${f}.x + ${d}*${f}.y) / (${f}.x + ${f}.y);
        `}}y("BABYLON.BiPlanarBlock",o4);class l4 extends ie{constructor(e){super(e,P.Neutral),this.registerInput("input",p.Matrix),this.registerOutput("output",p.Float)}getClassName(){return"MatrixDeterminantBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.output,i=this.input;return e.compilationString+=e._declareOutput(t)+` = determinant(${i.associatedVariableName});
`,this}}y("BABYLON.MatrixDeterminantBlock",l4);class c4 extends ie{constructor(e){super(e,P.Neutral),this.registerInput("input",p.Matrix),this.registerOutput("output",p.Matrix)}getClassName(){return"MatrixTransposeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.output,i=this.input;return e.compilationString+=e._declareOutput(t)+` = transpose(${i.associatedVariableName});
`,this}}y("BABYLON.MatrixTransposeBlock",c4);var FT;(function(s){s[s.None=0]="None",s[s.Normal=1]="Normal",s[s.Tangent=2]="Tangent",s[s.VertexColor=3]="VertexColor",s[s.UV1=4]="UV1",s[s.UV2=5]="UV2",s[s.UV3=6]="UV3",s[s.UV4=7]="UV4",s[s.UV5=8]="UV5",s[s.UV6=9]="UV6"})(FT||(FT={}));class i0 extends ie{constructor(e){super(e,P.Neutral),this.attributeType=0,this.registerInput("input",p.AutoDetect),this.registerInput("fallback",p.AutoDetect),this.registerOutput("output",p.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].onConnectionObservable.add(t=>{var r;if(this.attributeType)return;const i=t.ownerBlock;if(i instanceof ge&&i.isAttribute)switch(i.name){case"color":this.attributeType=3;break;case"normal":this.attributeType=1;break;case"tangent":this.attributeType=2;break;case"uv":this.attributeType=4;break;case"uv2":this.attributeType=5;break;case"uv3":this.attributeType=6;break;case"uv4":this.attributeType=7;break;case"uv5":this.attributeType=8;break;case"uv6":this.attributeType=9;break}else if(i instanceof jA)switch((r=this.input.connectedPoint)==null?void 0:r.name){case"normalOutput":this.attributeType=1;break;case"tangentOutput":this.attributeType=2;break;case"uvOutput":this.attributeType=4;break;case"uv2Output":this.attributeType=5;break}})}getClassName(){return"MeshAttributeExistsBlock"}get input(){return this._inputs[0]}get fallback(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=null;switch(this.attributeType){case 3:t="VERTEXCOLOR_NME";break;case 1:t="NORMAL";break;case 2:t="TANGENT";break;case 4:t="UV1";break;case 5:t="UV2";break;case 6:t="UV3";break;case 7:t="UV4";break;case 8:t="UV5";break;case 9:t="UV6";break}const i=e._declareOutput(this.output);return t&&(e.compilationString+=`#ifdef ${t}
`),e.compilationString+=`${i} = ${this.input.associatedVariableName};
`,t&&(e.compilationString+=`#else
`,e.compilationString+=`${i} = ${this.fallback.associatedVariableName};
`,e.compilationString+=`#endif
`),this}serialize(){const e=super.serialize();return e.attributeType=this.attributeType,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.attributeType=e.attributeType??0}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.attributeType = ${this.attributeType};
`,e}}_([O("Attribute lookup",5,void 0,{notifiers:{update:!0},embedded:!0,options:[{label:"(None)",value:0},{label:"Normal",value:1},{label:"Tangent",value:2},{label:"Vertex Color",value:3},{label:"UV1",value:4},{label:"UV2",value:5},{label:"UV3",value:6},{label:"UV4",value:7},{label:"UV5",value:8},{label:"UV6",value:9}]})],i0.prototype,"attributeType",void 0);y("BABYLON.MeshAttributeExistsBlock",i0);var Ce;(function(s){s[s.EaseInSine=0]="EaseInSine",s[s.EaseOutSine=1]="EaseOutSine",s[s.EaseInOutSine=2]="EaseInOutSine",s[s.EaseInQuad=3]="EaseInQuad",s[s.EaseOutQuad=4]="EaseOutQuad",s[s.EaseInOutQuad=5]="EaseInOutQuad",s[s.EaseInCubic=6]="EaseInCubic",s[s.EaseOutCubic=7]="EaseOutCubic",s[s.EaseInOutCubic=8]="EaseInOutCubic",s[s.EaseInQuart=9]="EaseInQuart",s[s.EaseOutQuart=10]="EaseOutQuart",s[s.EaseInOutQuart=11]="EaseInOutQuart",s[s.EaseInQuint=12]="EaseInQuint",s[s.EaseOutQuint=13]="EaseOutQuint",s[s.EaseInOutQuint=14]="EaseInOutQuint",s[s.EaseInExpo=15]="EaseInExpo",s[s.EaseOutExpo=16]="EaseOutExpo",s[s.EaseInOutExpo=17]="EaseInOutExpo",s[s.EaseInCirc=18]="EaseInCirc",s[s.EaseOutCirc=19]="EaseOutCirc",s[s.EaseInOutCirc=20]="EaseInOutCirc",s[s.EaseInBack=21]="EaseInBack",s[s.EaseOutBack=22]="EaseOutBack",s[s.EaseInOutBack=23]="EaseInOutBack",s[s.EaseInElastic=24]="EaseInElastic",s[s.EaseOutElastic=25]="EaseOutElastic",s[s.EaseInOutElastic=26]="EaseInOutElastic"})(Ce||(Ce={}));class r0 extends ie{constructor(e){super(e,P.Neutral),this.type=Ce.EaseInOutSine,this.registerInput("input",p.AutoDetect),this.registerOutput("output",p.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(p.Matrix),this._inputs[0].excludedConnectionPointTypes.push(p.Object),this._inputs[0].excludedConnectionPointTypes.push(p.Int)}getClassName(){return"CurveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_duplicateEntry(e,t){return`ret.${t} = ${e.replace(/VAL/g,"v."+t)}`}_duplicateEntryDirect(e){return`return ${e.replace(/VAL/g,"v")}`}_duplicateVector(e,t,i){if(t==="float"||t==="f32")return this._duplicateEntryDirect(e);const r=parseInt(t.replace("vec",""));let n=i?`
            var ret: vec${r}f = vec${r}f(0.0);
        `:`
            vec${r} ret = vec${r}(0.0);
        `;for(let a=1;a<=r;a++)n+=this._duplicateEntry(e,a===1?"x":a===2?"y":a===3?"z":"w")+`;
`;return n+=`return ret;
`,n}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];let i="",r="";const n=e._getShaderType(this.input.type),a=e.shaderLanguage===1;switch(r=Ce[this.type]+"_"+n.replace("<","").replace(">",""),this.type){case Ce.EaseInSine:i="return 1.0 - cos((v * 3.1415) / 2.0)";break;case Ce.EaseOutSine:i="return sin((v * 3.1415) / 2.0)";break;case Ce.EaseInOutSine:i="return -(cos(v * 3.1415) - 1.0) / 2.0";break;case Ce.EaseInQuad:i="return v * v";break;case Ce.EaseOutQuad:i="return (1.0 - v) * (1.0 - v)";break;case Ce.EaseInOutQuad:{const o=e._generateTernary("2.0 * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 2.0) / 2.0","VAL < 0.5");i=this._duplicateVector(o,n,a);break}case Ce.EaseInCubic:i="return v * v * v";break;case Ce.EaseOutCubic:{const o="1.0 - pow(1.0 - VAL, 3.0)";i=this._duplicateVector(o,n,a);break}case Ce.EaseInOutCubic:{const o=e._generateTernary("4.0 * VAL * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 3.0) / 2.0","VAL < 0.5");i=this._duplicateVector(o,n,a);break}case Ce.EaseInQuart:i="return v * v * v * v";break;case Ce.EaseOutQuart:{const o="1.0 - pow(1.0 - VAL, 4.0)";i=this._duplicateVector(o,n,a);break}case Ce.EaseInOutQuart:{const o=e._generateTernary("8.0 * VAL * VAL * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 4.0) / 2.0","VAL < 0.5");i=this._duplicateVector(o,n,a);break}case Ce.EaseInQuint:i="return v * v * v * v * v";break;case Ce.EaseOutQuint:{const o="1.0 - pow(1.0 - VAL, 5.0)";i=this._duplicateVector(o,n,a);break}case Ce.EaseInOutQuint:{const o=e._generateTernary("16.0 * VAL * VAL * VAL * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 5.0) / 2.0","VAL < 0.5");i=this._duplicateVector(o,n,a);break}case Ce.EaseInExpo:{const o=e._generateTernary("0.0","pow(2.0, 10.0 * VAL - 10.0)","VAL == 0.0");i=this._duplicateVector(o,n,a);break}case Ce.EaseOutExpo:{const o=e._generateTernary("1.0","1.0 - pow(2.0, -10.0 * VAL)","VAL == 1.0");i=this._duplicateVector(o,n,a);break}case Ce.EaseInOutExpo:{const o=e._generateTernary("0.0",e._generateTernary("1.0",e._generateTernary("pow(2.0, 20.0 * VAL - 10.0) / 2.0","(2.0 - pow(2.0, -20.0 * VAL + 10.0)) / 2.0","VAL < 0.5"),"VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(o,n,a);break}case Ce.EaseInCirc:{const o="1.0 - sqrt(1.0 - pow(VAL, 2.0))";i=this._duplicateVector(o,n,a);break}case Ce.EaseOutCirc:{const o="sqrt(1.0 - pow(VAL - 1.0, 2.0))";i=this._duplicateVector(o,n,a);break}case Ce.EaseInOutCirc:{const o=e._generateTernary("(1.0 - sqrt(1.0 - pow(2.0 * VAL, 2.0))) / 2.0","(sqrt(1.0 - pow(-2.0 * VAL + 2.0, 2.0)) + 1.0) / 2.0","VAL < 0.5");i=this._duplicateVector(o,n,a);break}case Ce.EaseInBack:{i="return 2.70158 * v * v * v - 1.70158 * v * v";break}case Ce.EaseOutBack:{const o="2.70158 * pow(VAL - 1.0, 3.0) + 1.70158 * pow(VAL - 1.0, 2.0)";i=this._duplicateVector(o,n,a);break}case Ce.EaseInOutBack:{const o=e._generateTernary("(pow(2.0 * VAL, 2.0) * ((3.5949095) * 2.0 * VAL - 2.5949095)) / 2.0","(pow(2.0 * VAL - 2.0, 2.0) * (3.5949095 * (VAL * 2.0 - 2.0) + 3.5949095) + 2.0) / 2.0","VAL < 0.5");i=this._duplicateVector(o,n,a);break}case Ce.EaseInElastic:{const o=e._generateTernary("0.0",e._generateTernary("1.0","-pow(2.0, 10.0 * VAL - 10.0) * sin((VAL * 10.0 - 10.75) * ((2.0 * 3.1415) / 3.0))","VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(o,n,a);break}case Ce.EaseOutElastic:{const o=e._generateTernary("0.0",e._generateTernary("1.0","pow(2.0, -10.0 * VAL) * sin((VAL * 10.0 - 0.75) * ((2.0 * 3.1415) / 3.0)) + 1.0","VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(o,n,a);break}case Ce.EaseInOutElastic:{const o=e._generateTernary("0.0",e._generateTernary("1.0",e._generateTernary("-(pow(2.0, 20.0 * VAL - 10.0) * sin((20.0 * VAL - 11.125) * ((2.0 * 3.1415) / 4.5))) / 2.0","(pow(2.0, -20.0 * VAL + 10.0) * sin((20.0 * VAL - 11.125) * ((2.0 * 3.1415) / 4.5))) / 2.0 + 1.0","VAL < 0.5"),"VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(o,n,a);break}}return a?e._emitFunction(r,`fn ${r}(v: ${n}) -> ${n}  {${i};}
`,""):e._emitFunction(r,`${n} ${r}(${n} v) {${i};}
`,""),e.compilationString+=e._declareOutput(t)+` = ${r}(${this.input.associatedVariableName});
`,this}serialize(){const e=super.serialize();return e.curveType=this.type,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.type=e.curveType}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.type = BABYLON.CurveBlockTypes.${Ce[this.type]};
`}}_([O("Type",5,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"EaseInSine",value:Ce.EaseInSine},{label:"EaseOutSine",value:Ce.EaseOutSine},{label:"EaseInOutSine",value:Ce.EaseInOutSine},{label:"EaseInQuad",value:Ce.EaseInQuad},{label:"EaseOutQuad",value:Ce.EaseOutQuad},{label:"EaseInOutQuad",value:Ce.EaseInOutQuad},{label:"EaseInCubic",value:Ce.EaseInCubic},{label:"EaseOutCubic",value:Ce.EaseOutCubic},{label:"EaseInOutCubic",value:Ce.EaseInOutCubic},{label:"EaseInQuart",value:Ce.EaseInQuart},{label:"EaseOutQuart",value:Ce.EaseOutQuart},{label:"EaseInOutQuart",value:Ce.EaseInOutQuart},{label:"EaseInQuint",value:Ce.EaseInQuint},{label:"EaseOutQuint",value:Ce.EaseOutQuint},{label:"EaseInOutQuint",value:Ce.EaseInOutQuint},{label:"EaseInExpo",value:Ce.EaseInExpo},{label:"EaseOutExpo",value:Ce.EaseOutExpo},{label:"EaseInOutExpo",value:Ce.EaseInOutExpo},{label:"EaseInCirc",value:Ce.EaseInCirc},{label:"EaseOutCirc",value:Ce.EaseOutCirc},{label:"EaseInOutCirc",value:Ce.EaseInOutCirc},{label:"EaseInBack",value:Ce.EaseInBack},{label:"EaseOutBack",value:Ce.EaseOutBack},{label:"EaseInOutBack",value:Ce.EaseInOutBack},{label:"EaseInElastic",value:Ce.EaseInElastic},{label:"EaseOutElastic",value:Ce.EaseOutElastic},{label:"EaseInOutElastic",value:Ce.EaseInOutElastic}]})],r0.prototype,"type",void 0);y("BABYLON.CurveBlock",r0);class u4 extends ie{constructor(e){super(e,P.Neutral),this.registerInput("rgb ",p.Color3,!0),this.registerInput("hsl ",p.Color3,!0),this.registerOutput("rgb",p.Color3),this.registerOutput("hsl",p.Color3)}getClassName(){return"ColorConverterBlock"}get rgbIn(){return this._inputs[0]}get hslIn(){return this._inputs[1]}get rgbOut(){return this._outputs[0]}get hslOut(){return this._outputs[1]}_inputRename(e){return e==="rgb "?"rgbIn":e==="hsl "?"hslIn":e}_outputRename(e){return e==="rgb"?"rgbOut":e==="hsl"?"hslOut":e}_buildBlock(e){super._buildBlock(e);const t=this.rgbIn,i=this.hslIn,r=this._outputs[0],n=this._outputs[1],a=e._getShaderType(p.Vector3);let o=`
            vec3 rgb2hsl(vec3 color) {
                float r = color.r;
                float g = color.g;
                float b = color.b;

                float maxc = max(r, max(g, b));
                float minc = min(r, min(g, b));
                float h = 0.0;
                float s = 0.0;
                float l = (maxc + minc) / 2.0;

                if (maxc != minc) {
                    float d = maxc - minc;
                    if (l > 0.5) {
                        s = d / (2.0 - maxc - minc);
                    } else {
                        s = d / (maxc + minc);
                    }

                    if (maxc == r) {
                        float add = 0.0;
                        if (g < b) {
                            add = 6.0;
                        }
                        h = (g - b) / d + add;
                    } else if (maxc == g) {
                        h = (b - r) / d + 2.0;
                    } else if (maxc == b) {
                        h = (r - g) / d + 4.0;
                    }
                    h /= 6.0;
                }

                return vec3(h, s, l);
            }`,l=`
            float hue2rgb(float p, float q, float tt) {
                float t = tt;
                if (t < 0.0) {
                    t += 1.0;
                }
                if (t > 1.0) {
                    t -= 1.0;
                }
                if (t < 1.0/6.0) {
                    return p + (q - p) * 6.0 * t;
                }
                if (t < 1.0/2.0) {
                    return q;
                }
                if (t < 2.0/3.0) {
                    return p + (q - p) * (2.0/3.0 - t) * 6.0;
                }
                return p;
            }`,c=`
            vec3 hsl2rgb(vec3 hsl) {
                float h = hsl.x;
                float s = hsl.y;
                float l = hsl.z;

                float r;
                float g;
                float b;

                if (s == 0.0) {
                    // Achromatic (grey)
                    r = l;
                    g = l;
                    b = l; 
                } else {
                    float q;
                
                    if (l < 0.5) {
                        q = l * (1.0 + s);
                    } else {
                        q = (l + s - l * s);
                    }

                    float p = 2.0 * l - q;

                    r = hue2rgb(p, q, h + 1.0/3.0);
                    g = hue2rgb(p, q, h);
                    b = hue2rgb(p, q, h - 1.0/3.0);
                }

                return vec3(r, g, b);
            }`;return e.shaderLanguage===1&&(o=e._babylonSLtoWGSL(o),l=e._babylonSLtoWGSL(l),c=e._babylonSLtoWGSL(c)),e._emitFunction("rgb2hsl",o,""),e._emitFunction("hue2rgb",l,""),e._emitFunction("hsl2rgb",c,""),t.isConnected?(r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = ${t.associatedVariableName};
`),n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = rgb2hsl(${t.associatedVariableName});
`)):i.isConnected?(r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = hsl2rgb(${i.associatedVariableName});
`),n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = ${i.associatedVariableName};
`)):(r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` =  ${a}(0.);
`),n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` =  ${a}(0.);
`)),this}}y("BABYLON.ColorConverterBlock",u4);class Jo extends ie{constructor(e){super(e,P.Neutral),this.iterations=4,this.registerInput("input",p.AutoDetect),this.registerInput("iterations",p.Float,!0),this.registerOutput("output",p.BasedOnInput),this.registerOutput("index",p.Float,P.Fragment),this.registerOutput("loopID",p.Object,void 0,new at("loopID",this,1,Jo,"LoopBlock")),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[0]._forPostBuild=!0,this._outputs[2]._redirectedSource=this._inputs[0],this._outputs[1]._preventBubbleUp=!0,this._outputs[2]._preventBubbleUp=!0}getClassName(){return"LoopBlock"}get input(){return this._inputs[0]}get iterationsInput(){return this._inputs[1]}get output(){return this._outputs[0]}get index(){return this._outputs[1]}get loopID(){return this._outputs[2]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._outputs[1],r=e._getFreeVariableName("index"),n=e.shaderLanguage===1?"var":"int",a=e.shaderLanguage===1?"f32":"float",o=e.shaderLanguage===1?"i32":"int";e.compilationString+=e._declareOutput(t)+` = ${this.input.associatedVariableName};
`;const l=this.iterationsInput.isConnected?`${o}(${this.iterationsInput.associatedVariableName})`:this.iterations;return e.compilationString+=`for (${n} ${r} = 0; ${r} < ${l}; ${r}++){
`,e.compilationString+=`${e._declareOutput(i)} = ${a}(${r});
`,this}_postBuildBlock(e){return super._postBuildBlock(e),e.compilationString+=`}
`,this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.iterations = ${this.iterations};
`}serialize(){const e=super.serialize();return e.iterations=this.iterations,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.iterations=e.iterations}}_([O("Iterations",2,void 0,{embedded:!0})],Jo.prototype,"iterations",void 0);y("BABYLON.LoopBlock",Jo);class h4 extends ie{constructor(e){super(e,P.Neutral),this.registerInput("loopID",p.Object,!1,void 0,new at("loopID",this,0,Jo,"LoopBlock")),this.registerOutput("value",p.AutoDetect),this._outputs[0]._linkedConnectionSource=this._inputs[0]}getClassName(){return"StorageReadBlock"}get loopID(){return this._inputs[0]}get value(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.value;if(!this.loopID.isConnected)return this;const i=this.loopID.connectedPoint.ownerBlock;return e.compilationString+=e._declareOutput(t)+` = ${i.output.associatedVariableName};
`,this}}y("BABYLON.StorageReadBlock",h4);class d4 extends ie{constructor(e){super(e,P.Neutral),this.registerInput("loopID",p.Object,!1,void 0,new at("loopID",this,0,Jo,"LoopBlock")),this.registerInput("value",p.AutoDetect),this._linkConnectionTypes(0,1)}getClassName(){return"StorageWriteBlock"}get loopID(){return this._inputs[0]}get value(){return this._inputs[1]}isConnectedInFragmentShader(){return this.loopID.isConnected?this.loopID.connectedPoint.ownerBlock.output.isConnectedInFragmentShader:!1}_buildBlock(e){super._buildBlock(e);const t=this.value;if(!this.loopID.isConnected)return this;const i=this.loopID.connectedPoint.ownerBlock;return e.compilationString+=`${i.output.associatedVariableName} = ${t.associatedVariableName};
`,this}}y("BABYLON.StorageWriteBlock",d4);class f4 extends ie{constructor(e){super(e,P.Neutral),this.registerInput("input",p.Matrix),this.registerOutput("row0",p.Vector4),this.registerOutput("row1",p.Vector4),this.registerOutput("row2",p.Vector4),this.registerOutput("row3",p.Vector4),this.registerOutput("col0",p.Vector4),this.registerOutput("col1",p.Vector4),this.registerOutput("col2",p.Vector4),this.registerOutput("col3",p.Vector4)}getClassName(){return"MatrixSplitterBlock"}get input(){return this._inputs[0]}get row0(){return this._outputs[0]}get row1(){return this._outputs[1]}get row2(){return this._outputs[2]}get row3(){return this._outputs[3]}get col0(){return this._outputs[4]}get col1(){return this._outputs[5]}get col2(){return this._outputs[6]}get col3(){return this._outputs[7]}_exportColumn(e,t,i,r){const n=e.shaderLanguage===1?"vec4f":"vec4";e.compilationString+=e._declareOutput(t)+` = ${n}(${i}[0][${r}], ${i}[1][${r}], ${i}[2][${r}], ${i}[3][${r}]);
`}_buildBlock(e){super._buildBlock(e);const t=this._inputs[0].associatedVariableName,i=this.row0,r=this.row1,n=this.row2,a=this.row3,o=this.col0,l=this.col1,c=this.col2,u=this.col3;return i.hasEndpoints&&(e.compilationString+=e._declareOutput(i)+` = ${t}[0];
`),r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = ${t}[1];
`),n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = ${t}[2];
`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${t}[3];
`),o.hasEndpoints&&this._exportColumn(e,o,t,0),l.hasEndpoints&&this._exportColumn(e,l,t,1),c.hasEndpoints&&this._exportColumn(e,c,t,2),u.hasEndpoints&&this._exportColumn(e,u,t,3),this}}y("BABYLON.MatrixSplitterBlock",f4);const LT="gaussianSplattingVertexDeclaration",p4=`attribute position: vec2f;
`;S.IncludesShadersStoreWGSL[LT]||(S.IncludesShadersStoreWGSL[LT]=p4);class s0 extends ie{get isActive(){return this._isActive&&this.debug.isConnected}set isActive(e){this._isActive!==e&&(this._isActive=e)}constructor(e){super(e,P.Fragment,!0,!0),this._isActive=!1,this.renderAlpha=!1,this.registerInput("debug",p.AutoDetect,!0),this.debug.excludedConnectionPointTypes.push(p.Matrix)}get _isFinalOutputAndActive(){return this.isActive}get _hasPrecedence(){return!0}get debug(){return this._inputs[0]}getClassName(){return"NodeMaterialDebugBlock"}_buildBlock(e){if(super._buildBlock(e),!this._isActive)return this;let t="gl_FragColor";e.shaderLanguage===1&&(t="fragmentOutputs.color");const i=this.debug;return i.connectedPoint?(i.connectedPoint.type===p.Float?e.compilationString+=`${t}  = vec4${e.fSuffix}(${i.associatedVariableName}, ${i.associatedVariableName}, ${i.associatedVariableName}, 1.0);
`:i.connectedPoint.type===p.Vector2?e.compilationString+=`${t}  = vec4${e.fSuffix}(${i.associatedVariableName}, 0., 1.0);
`:i.connectedPoint.type===p.Color3||i.connectedPoint.type===p.Vector3?e.compilationString+=`${t}  = vec4${e.fSuffix}(${i.associatedVariableName}, 1.0);
`:this.renderAlpha?e.compilationString+=`${t}  =${i.associatedVariableName};
`:e.compilationString+=`${t}  = vec4${e.fSuffix}(${i.associatedVariableName}.rgb, 1.0);
`,this):this}serialize(){const e=super.serialize();return e.isActive=this._isActive,e.renderAlpha=this.renderAlpha,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.isActive=e.isActive,this.renderAlpha=e.renderAlpha}}_([O("Render Alpha",0,void 0)],s0.prototype,"renderAlpha",void 0);y("BABYLON.NodeMaterialDebugBlock",s0);var wT;(function(s){s[s.Created=1]="Created",s[s.Disposed=2]="Disposed",s[s.GetDefineNames=4]="GetDefineNames",s[s.PrepareUniformBuffer=8]="PrepareUniformBuffer",s[s.IsReadyForSubMesh=16]="IsReadyForSubMesh",s[s.PrepareDefines=32]="PrepareDefines",s[s.BindForSubMesh=64]="BindForSubMesh",s[s.PrepareEffect=128]="PrepareEffect",s[s.GetAnimatables=256]="GetAnimatables",s[s.GetActiveTextures=512]="GetActiveTextures",s[s.HasTexture=1024]="HasTexture",s[s.FillRenderTargetTextures=2048]="FillRenderTargetTextures",s[s.HasRenderTargetTextures=4096]="HasRenderTargetTextures",s[s.HardBindForSubMesh=8192]="HardBindForSubMesh"})(wT||(wT={}));class m4 extends Oi{constructor(){super(...arguments),this.DECAL=!1,this.DECALDIRECTUV=0,this.DECAL_SMOOTHALPHA=!1,this.GAMMADECAL=!1}}class hc extends Er{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"DecalMap",150,new m4,t),this._isEnabled=!1,this.isEnabled=!1,this._smoothAlpha=!1,this.smoothAlpha=!1,this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i,r){const n=r.getMesh().decalMap;return!this._isEnabled||!(n!=null&&n.texture)||!K.DecalMapEnabled||!t.texturesEnabled?!0:n.isReady()}prepareDefinesBeforeAttributes(e,t,i){const r=i.decalMap;!this._isEnabled||!(r!=null&&r.texture)||!K.DecalMapEnabled||!t.texturesEnabled?(e.DECAL&&e.markAsTexturesDirty(),e.DECAL=!1):((!e.DECAL||e.GAMMADECAL!==r.texture.gammaSpace)&&e.markAsTexturesDirty(),e.DECAL=!0,e.GAMMADECAL=r.texture.gammaSpace,e.DECAL_SMOOTHALPHA=this._smoothAlpha,Nt(r.texture,e,"DECAL"))}hardBindForSubMesh(e,t,i,r){const n=r.getMesh().decalMap;if(!this._isEnabled||!(n!=null&&n.texture)||!K.DecalMapEnabled||!t.texturesEnabled)return;const a=this._material.isFrozen,o=n.texture;(!e.useUbo||!a||!e.isSync)&&(e.updateFloat4("vDecalInfos",o.coordinatesIndex,0,0,0),Dt(o,e,"decal")),e.setTexture("decalSampler",o)}getClassName(){return"DecalMapConfiguration"}getSamplers(e){e.push("decalSampler")}getUniforms(){return{ubo:[{name:"vDecalInfos",size:4,type:"vec4"},{name:"decalMatrix",size:16,type:"mat4"}]}}}_([R(),W("_markAllSubMeshesAsTexturesDirty")],hc.prototype,"isEnabled",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],hc.prototype,"smoothAlpha",void 0);y("BABYLON.DecalMapConfiguration",hc);class Pi{}Pi.DEFAULT_COLOR=q.White();Pi.DEFAULT_WIDTH_ATTENUATED=1;Pi.DEFAULT_WIDTH=.1;class Ke{static ConvertPoints(e,t){if(e.length&&Array.isArray(e)&&typeof e[0]=="number")return[e];if(e.length&&Array.isArray(e[0])&&typeof e[0][0]=="number")return e;if(e.length&&!Array.isArray(e[0])&&e[0]instanceof x){const i=[];for(let r=0;r<e.length;r++){const n=e[r];i.push(n.x,n.y,n.z)}return[i]}else if(e.length>0&&Array.isArray(e[0])&&e[0].length>0&&e[0][0]instanceof x){const i=[],r=e;for(const n of r)i.push(n.flatMap(a=>[a.x,a.y,a.z]));return i}else if(e instanceof Float32Array)if(t!=null&&t.floatArrayStride){const i=[],r=t.floatArrayStride*3;for(let n=0;n<e.length;n+=r){const a=new Array(r);for(let o=0;o<r;o++)a[o]=e[n+o];i.push(a)}return i}else return[Array.from(e)];else if(e.length&&e[0]instanceof Float32Array){const i=[];for(const r of e)i.push(Array.from(r));return i}return[]}static OmitZeroLengthPredicate(e,t,i){const r=[];return t.subtract(e).lengthSquared()>0&&r.push([e,t]),i.subtract(t).lengthSquared()>0&&r.push([t,i]),e.subtract(i).lengthSquared()>0&&r.push([i,e]),r.length===0?null:r}static OmitDuplicatesPredicate(e,t,i,r){const n=[];return Ke._SearchInPoints(e,t,r)||n.push([e,t]),Ke._SearchInPoints(t,i,r)||n.push([t,i]),Ke._SearchInPoints(i,e,r)||n.push([i,e]),n.length===0?null:n}static _SearchInPoints(e,t,i){var r,n,a;for(const o of i)for(let l=0;l<o.length;l++)if((r=o[l])!=null&&r.equals(e)&&((n=o[l+1])!=null&&n.equals(t)||(a=o[l-1])!=null&&a.equals(t)))return!0;return!1}static MeshesToLines(e,t){const i=[];for(let r=0;r<e.length;r++){const n=e[r],a=n.getVerticesData(M.PositionKind),o=n.getIndices();if(a&&o)for(let l=0,c=0;l<o.length;l++){const u=o[c++]*3,h=o[c++]*3,d=o[c++]*3,f=new x(a[u],a[u+1],a[u+2]),m=new x(a[h],a[h+1],a[h+2]),g=new x(a[d],a[d+1],a[d+2]);if(t){const v=t(f,m,g,i,l,u,n,r,a,o);if(v)for(const E of v)i.push(E)}else i.push([f,m],[m,g],[g,f])}}return i}static ToVector3Array(e){if(Array.isArray(e[0])){const r=[],n=e;for(const a of n){const o=[];for(let l=0;l<a.length;l+=3)o.push(new x(a[l],a[l+1],a[l+2]));r.push(o)}return r}const t=e,i=[];for(let r=0;r<t.length;r+=3)i.push(new x(t[r],t[r+1],t[r+2]));return i}static ToNumberArray(e){return e.flatMap(t=>[t.x,t.y,t.z])}static GetPointsCountInfo(e){const t=new Array(e.length);let i=0;for(let r=e.length;r--;)t[r]=e[r].length/3,i+=t[r];return{total:i,counts:t}}static GetLineLength(e){if(e.length===0)return 0;let t;typeof e[0]=="number"?t=Ke.ToVector3Array(e):t=e;const i=G.Vector3[0];let r=0;for(let n=0;n<t.length-1;n++){const a=t[n],o=t[n+1];r+=o.subtractToRef(a,i).length()}return r}static GetLineLengthArray(e,t){const i=t?new Float32Array(t,0,e.length/3):new Float32Array(e.length/3);let r=0;for(let n=0,a=e.length/3-1;n<a;n++){let o=e[n*3+0],l=e[n*3+1],c=e[n*3+2];o-=e[n*3+3],l-=e[n*3+4],c-=e[n*3+5];const u=Math.sqrt(o*o+l*l+c*c);r+=u,i[n+1]=r}return i}static SegmentizeSegmentByCount(e,t,i){const r=[],n=t.subtract(e),a=G.Vector3[0];a.setAll(i);const o=G.Vector3[1];n.divideToRef(a,o);let l=e.clone();r.push(l);for(let c=0;c<i;c++)l=l.clone(),r.push(l.addInPlace(o));return r}static SegmentizeLineBySegmentLength(e,t){const i=e[0]instanceof x?Ke.GetLineSegments(e):typeof e[0]=="number"?Ke.GetLineSegments(Ke.ToVector3Array(e)):e,r=[];for(const n of i)if(n.length>t){const a=Ke.SegmentizeSegmentByCount(n.point1,n.point2,Math.ceil(n.length/t));for(const o of a)r.push(o)}else r.push(n.point1),r.push(n.point2);return r}static SegmentizeLineBySegmentCount(e,t){const i=typeof e[0]=="number"?Ke.ToVector3Array(e):e,r=Ke.GetLineLength(i)/t;return Ke.SegmentizeLineBySegmentLength(i,r)}static GetLineSegments(e){const t=[];for(let i=0;i<e.length-1;i++){const r=e[i],n=e[i+1],a=n.subtract(r).length();t.push({point1:r,point2:n,length:a})}return t}static GetMinMaxSegmentLength(e){const i=Ke.GetLineSegments(e).sort(r=>r.length);return{min:i[0].length,max:i[i.length-1].length}}static GetPositionOnLineByVisibility(e,t,i,r=!1){const n=t*i;let a=0,o=0;const l=e.length;for(let u=0;u<l;u++){if(n<=a+e[u].length){o=u;break}a+=e[u].length}const c=(n-a)/e[o].length;return e[o].point2.subtractToRef(e[o].point1,G.Vector3[0]),G.Vector3[1]=G.Vector3[0].multiplyByFloats(c,c,c),r||G.Vector3[1].addInPlace(e[o].point1),G.Vector3[1].clone()}static GetCircleLinePoints(e,t,i=0,r=e,n=Math.PI*2/t){const a=[];for(let o=0;o<=t;o++)a.push(new x(Math.cos(o*n)*e,Math.sin(o*n)*r,i));return a}static GetBezierLinePoints(e,t,i,r){return pI.CreateQuadraticBezier(e,t,i,r).getPoints().flatMap(n=>[n.x,n.y,n.z])}static GetArrowCap(e,t,i,r,n,a=0,o=0){return{points:[e.clone(),e.add(t.multiplyByFloats(i,i,i))],widths:[r,n,a,o]}}static GetPointsFromText(e,t,i,r,n=0,a=!0){const o=[],l=GD(e,t,i,r);for(const c of l){for(const u of c.paths){const h=[],d=u.getPoints();for(const f of d)h.push(f.x,f.y,n);o.push(h)}if(a)for(const u of c.holes){const h=[],d=u.getPoints();for(const f of d)h.push(f.x,f.y,n);o.push(h)}}return o}static Color3toRGBAUint8(e){const t=new Uint8Array(e.length*4);for(let i=0,r=0;i<e.length;i++)t[r++]=e[i].r*255,t[r++]=e[i].g*255,t[r++]=e[i].b*255,t[r++]=255;return t}static CreateColorsTexture(e,t,i,r){const n=r.getEngine().getCaps().maxTextureSize??1,a=t.length>n?n:t.length,o=Math.ceil(t.length/n);o>1&&(t=[...t,...Array(a*o-t.length).fill(t[0])]);const l=Ke.Color3toRGBAUint8(t),c=new gi(l,a,o,ft.TEXTUREFORMAT_RGBA,r,!1,!0,i);return c.name=e,c}static PrepareEmptyColorsTexture(e){if(!Pi.EmptyColorsTexture){const t=new Uint8Array(4);Pi.EmptyColorsTexture=new gi(t,1,1,ft.TEXTUREFORMAT_RGBA,e,!1,!1,gi.NEAREST_NEAREST),Pi.EmptyColorsTexture.name="grlEmptyColorsTexture"}return Pi.EmptyColorsTexture}static DisposeEmptyColorsTexture(){var e;(e=Pi.EmptyColorsTexture)==null||e.dispose(),Pi.EmptyColorsTexture=null}static BooleanToNumber(e){return e?1:0}}function _4(s,e){if(s==="vertex"){const t={CUSTOM_VERTEX_DEFINITIONS:`
                attribute float grl_widths;
                attribute vec3 grl_offsets;
                attribute float grl_colorPointers;
                varying float grlCounters;
                varying float grlColorPointer;

                #ifdef GREASED_LINE_CAMERA_FACING
                    attribute vec4 grl_previousAndSide;
                    attribute vec4 grl_nextAndCounters;

                    vec2 grlFix( vec4 i, float aspect ) {
                        vec2 res = i.xy / i.w;
                        res.x *= aspect;
                        return res;
                    }
                #else
                    attribute vec3 grl_slopes;
                    attribute float grl_counters;
                #endif
                `,CUSTOM_VERTEX_UPDATE_POSITION:`
                #ifdef GREASED_LINE_CAMERA_FACING
                    vec3 grlPositionOffset = grl_offsets;
                    positionUpdated += grlPositionOffset;
                #else
                    positionUpdated = (positionUpdated + grl_offsets) + (grl_slopes * grl_widths);
                #endif
                `,CUSTOM_VERTEX_MAIN_END:`
                grlColorPointer = grl_colorPointers;

                #ifdef GREASED_LINE_CAMERA_FACING

                    float grlAspect = grl_aspect_resolution_lineWidth.x;
                    float grlBaseWidth = grl_aspect_resolution_lineWidth.w;

                    vec3 grlPrevious = grl_previousAndSide.xyz;
                    float grlSide = grl_previousAndSide.w;

                    vec3 grlNext = grl_nextAndCounters.xyz;
                    grlCounters = grl_nextAndCounters.w;
                    float grlWidth = grlBaseWidth * grl_widths;
                    
                    vec3 worldDir = normalize(grlNext - grlPrevious);
                    vec3 nearPosition = positionUpdated + (worldDir * 0.01);
                    mat4 grlMatrix = viewProjection * finalWorld;
                    vec4 grlFinalPosition = grlMatrix * vec4(positionUpdated , 1.0);
                    vec4 screenNearPos = grlMatrix * vec4(nearPosition, 1.0);
                    vec2 grlLinePosition = grlFix(grlFinalPosition, grlAspect);
                    vec2 grlLineNearPosition = grlFix(screenNearPos, grlAspect);
                    vec2 grlDir = normalize(grlLineNearPosition - grlLinePosition);

                    vec4 grlNormal = vec4(-grlDir.y, grlDir.x, 0., 1.);

                    #ifdef GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM
                        grlNormal.xy *= -.5 * grlWidth;
                    #else
                        grlNormal.xy *= .5 * grlWidth;
                    #endif

                    grlNormal *= grl_projection;

                    #ifdef GREASED_LINE_SIZE_ATTENUATION
                        grlNormal.xy *= grlFinalPosition.w;
                        grlNormal.xy /= (vec4(grl_aspect_resolution_lineWidth.yz, 0., 1.) * grl_projection).xy;
                    #endif

                    grlFinalPosition.xy += grlNormal.xy * grlSide;
                    gl_Position = grlFinalPosition;

                    vPositionW = vec3(grlFinalPosition);
                #else
                    grlCounters = grl_counters;
                #endif
                `};return e&&(t["!gl_Position\\=viewProjection\\*worldPos;"]="//"),t}return s==="fragment"?{CUSTOM_FRAGMENT_DEFINITIONS:`
                    #ifdef PBR
                         #define grlFinalColor finalColor
                    #else
                         #define grlFinalColor color
                    #endif

                    varying float grlCounters;
                    varying float grlColorPointer;
                    uniform sampler2D grl_colors;
                `,CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR:`
                    float grlColorMode = grl_colorMode_visibility_colorsWidth_useColors.x;
                    float grlVisibility = grl_colorMode_visibility_colorsWidth_useColors.y;
                    float grlColorsWidth = grl_colorMode_visibility_colorsWidth_useColors.z;
                    float grlUseColors = grl_colorMode_visibility_colorsWidth_useColors.w;

                    float grlUseDash = grl_dashOptions.x;
                    float grlDashArray = grl_dashOptions.y;
                    float grlDashOffset = grl_dashOptions.z;
                    float grlDashRatio = grl_dashOptions.w;

                    grlFinalColor.a *= step(grlCounters, grlVisibility);
                    if(grlFinalColor.a == 0.) discard;

                    if(grlUseDash == 1.){
                        grlFinalColor.a *= ceil(mod(grlCounters + grlDashOffset, grlDashArray) - (grlDashArray * grlDashRatio));
                        if (grlFinalColor.a == 0.) discard;
                    }

                    #ifdef GREASED_LINE_HAS_COLOR
                        if (grlColorMode == 0.) {
                            grlFinalColor.rgb = grl_singleColor;
                        } else if (grlColorMode == 1.) {
                            grlFinalColor.rgb += grl_singleColor;
                        } else if (grlColorMode == 2.) {
                            grlFinalColor.rgb *= grl_singleColor;
                        }
                    #else
                        if (grlUseColors == 1.) {
                            #ifdef GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE
                                vec4 grlColor = texture2D(grl_colors, vec2(grlCounters, 0.), 0.);
                            #else
                                vec2 lookup = vec2(fract(grlColorPointer / grl_textureSize.x), 1.0 - floor(grlColorPointer / grl_textureSize.x) / max(grl_textureSize.y - 1.0, 1.0));
                                vec4 grlColor = texture2D(grl_colors, lookup, 0.0);
                            #endif
                            if (grlColorMode == 0.) {
                                grlFinalColor = grlColor;
                            } else if (grlColorMode == 1.) {
                                grlFinalColor += grlColor;
                            } else if (grlColorMode == 2.) {
                                grlFinalColor *= grlColor;
                            }
                        }
                    #endif
                `}:null}function g4(s,e){if(s==="vertex"){const t={CUSTOM_VERTEX_DEFINITIONS:`
                attribute grl_widths: f32;
                attribute grl_colorPointers: f32;
                varying grlCounters: f32;
                varying grlColorPointer: f32;

                #ifdef GREASED_LINE_USE_OFFSETS
                    attribute grl_offsets: vec3f;   
                #endif

                #ifdef GREASED_LINE_CAMERA_FACING
                    attribute grl_previousAndSide : vec4f;
                    attribute grl_nextAndCounters : vec4f;

                    fn grlFix(i: vec4f, aspect: f32) -> vec2f {
                        var res = i.xy / i.w;
                        res.x *= aspect;
                        return res;
                    }
                #else
                    attribute grl_slopes: f32;
                    attribute grl_counters: f32;
                #endif


                `,CUSTOM_VERTEX_UPDATE_POSITION:`
                #ifdef GREASED_LINE_USE_OFFSETS
                    var grlPositionOffset: vec3f = input.grl_offsets;
                #else
                    var grlPositionOffset = vec3f(0.);
                #endif

                #ifdef GREASED_LINE_CAMERA_FACING
                    positionUpdated += grlPositionOffset;
                #else
                    positionUpdated = (positionUpdated + grlPositionOffset) + (input.grl_slopes * input.grl_widths);
                #endif
                `,CUSTOM_VERTEX_MAIN_END:`
                vertexOutputs.grlColorPointer = input.grl_colorPointers;

                #ifdef GREASED_LINE_CAMERA_FACING

                    let grlAspect: f32 = uniforms.grl_aspect_resolution_lineWidth.x;
                    let grlBaseWidth: f32 = uniforms.grl_aspect_resolution_lineWidth.w;

                    let grlPrevious: vec3f = input.grl_previousAndSide.xyz;
                    let grlSide: f32 = input.grl_previousAndSide.w;

                    let grlNext: vec3f = input.grl_nextAndCounters.xyz;
                    vertexOutputs.grlCounters = input.grl_nextAndCounters.w;

                    let grlWidth: f32 = grlBaseWidth * input.grl_widths;

                    let worldDir: vec3f = normalize(grlNext - grlPrevious);
                    let nearPosition: vec3f = positionUpdated + (worldDir * 0.01);
                    let grlMatrix: mat4x4f = uniforms.viewProjection * finalWorld;
                    let grlFinalPosition: vec4f = grlMatrix * vec4f(positionUpdated, 1.0); 
                    let screenNearPos: vec4f = grlMatrix * vec4(nearPosition, 1.0);
                    let grlLinePosition: vec2f = grlFix(grlFinalPosition, grlAspect);
                    let grlLineNearPosition: vec2f = grlFix(screenNearPos, grlAspect);
                    let grlDir: vec2f = normalize(grlLineNearPosition - grlLinePosition);

                    var grlNormal: vec4f = vec4f(-grlDir.y, grlDir.x, 0.0, 1.0);

                    let grlHalfWidth: f32 = 0.5 * grlWidth;
                    #if defined(GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM)
                        grlNormal.x *= -grlHalfWidth;
                        grlNormal.y *= -grlHalfWidth;
                    #else
                        grlNormal.x *= grlHalfWidth;
                        grlNormal.y *= grlHalfWidth;
                    #endif

                    grlNormal *= uniforms.grl_projection;

                    #if defined(GREASED_LINE_SIZE_ATTENUATION)
                        grlNormal.x *= grlFinalPosition.w;
                        grlNormal.y *= grlFinalPosition.w;

                        let pr = vec4f(uniforms.grl_aspect_resolution_lineWidth.yz, 0.0, 1.0) * uniforms.grl_projection;
                        grlNormal.x /= pr.x;
                        grlNormal.y /= pr.y;
                    #endif

                    vertexOutputs.position = vec4f(grlFinalPosition.xy + grlNormal.xy * grlSide, grlFinalPosition.z, grlFinalPosition.w);
                    vertexOutputs.vPositionW = vertexOutputs.position.xyz;
                
                #else
                    vertexOutputs.grlCounters = input.grl_counters;
                #endif
                `};return e&&(t["!vertexOutputs\\.position\\s=\\sscene\\.viewProjection\\s\\*\\sworldPos;"]="//"),t}return s==="fragment"?{CUSTOM_FRAGMENT_DEFINITIONS:`
                    #ifdef PBR
                         #define grlFinalColor finalColor
                    #else
                         #define grlFinalColor color
                    #endif

                    varying grlCounters: f32;
                    varying grlColorPointer: 32;

                    var grl_colors: texture_2d<f32>;
                    var grl_colorsSampler: sampler;
                `,CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR:`
                    let grlColorMode: f32 = uniforms.grl_colorMode_visibility_colorsWidth_useColors.x;
                    let grlVisibility: f32 = uniforms.grl_colorMode_visibility_colorsWidth_useColors.y;
                    let grlColorsWidth: f32 = uniforms.grl_colorMode_visibility_colorsWidth_useColors.z;
                    let grlUseColors: f32 = uniforms.grl_colorMode_visibility_colorsWidth_useColors.w;

                    let grlUseDash: f32 = uniforms.grl_dashOptions.x;
                    let grlDashArray: f32 = uniforms.grl_dashOptions.y;
                    let grlDashOffset: f32 = uniforms.grl_dashOptions.z;
                    let grlDashRatio: f32 = uniforms.grl_dashOptions.w;

                    grlFinalColor.a *= step(fragmentInputs.grlCounters, grlVisibility);
                    if (grlFinalColor.a == 0.0) {
                        discard;
                    }

                    if (grlUseDash == 1.0) {
                        let dashPosition = (fragmentInputs.grlCounters + grlDashOffset) % grlDashArray;
                        grlFinalColor.a *= ceil(dashPosition - (grlDashArray * grlDashRatio));

                        if (grlFinalColor.a == 0.0) {
                            discard;
                        }
                    }

                    #ifdef GREASED_LINE_HAS_COLOR
                        if (grlColorMode == 0.) {
                            grlFinalColor = vec4f(uniforms.grl_singleColor, grlFinalColor.a);
                        } else if (grlColorMode == 1.) {
                            grlFinalColor += vec4f(uniforms.grl_singleColor, grlFinalColor.a);
                        } else if (grlColorMode == 2.) {
                            grlFinalColor *= vec4f(uniforms.grl_singleColor, grlFinalColor.a);
                        }
                    #else
                        if (grlUseColors == 1.) {
                            #ifdef GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE
                                let grlColor: vec4f = textureSample(grl_colors, grl_colorsSampler, vec2f(fragmentInputs.grlCounters, 0.));
                            #else
                                let lookup: vec2f = vec2(fract(fragmentInputs.grlColorPointer / uniforms.grl_textureSize.x), 1.0 - floor(fragmentInputs.grlColorPointer / uniforms.grl_textureSize.x) / max(uniforms.grl_textureSize.y - 1.0, 1.0));
                                let grlColor: vec4f = textureSample(grl_colors, grl_colorsSampler, lookup);
                            #endif
                            if (grlColorMode == 0.) {
                                grlFinalColor = grlColor;
                            } else if (grlColorMode == 1.) {
                                grlFinalColor += grlColor;
                            } else if (grlColorMode == 2.) {
                                grlFinalColor *= grlColor;
                            }
                        }
                    #endif


                `}:null}class S4 extends Oi{constructor(){super(...arguments),this.GREASED_LINE_HAS_COLOR=!1,this.GREASED_LINE_SIZE_ATTENUATION=!1,this.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=!1,this.GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM=!1,this.GREASED_LINE_CAMERA_FACING=!0,this.GREASED_LINE_USE_OFFSETS=!1}}class _n extends Er{isCompatible(e){return!0}constructor(e,t,i){i=i||{color:Pi.DEFAULT_COLOR};const r=new S4;r.GREASED_LINE_HAS_COLOR=!!i.color&&!i.useColors,r.GREASED_LINE_SIZE_ATTENUATION=i.sizeAttenuation??!1,r.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=i.colorDistributionType===1,r.GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM=(t??e.getScene()).useRightHandedSystem,r.GREASED_LINE_CAMERA_FACING=i.cameraFacing??!0,super(e,_n.GREASED_LINE_MATERIAL_NAME,200,r,!0,!0),this.colorsTexture=null,this._forceGLSL=!1,this._forceGLSL=(i==null?void 0:i.forceGLSL)||_n.ForceGLSL,this._scene=t??e.getScene(),this._engine=this._scene.getEngine(),this._cameraFacing=i.cameraFacing??!0,this.visibility=i.visibility??1,this.useDash=i.useDash??!1,this.dashRatio=i.dashRatio??.5,this.dashOffset=i.dashOffset??0,this.width=i.width?i.width:i.sizeAttenuation?Pi.DEFAULT_WIDTH_ATTENUATED:Pi.DEFAULT_WIDTH,this._sizeAttenuation=i.sizeAttenuation??!1,this.colorMode=i.colorMode??0,this._color=i.color??null,this.useColors=i.useColors??!1,this._colorsDistributionType=i.colorDistributionType??0,this.colorsSampling=i.colorsSampling??gi.NEAREST_NEAREST,this._colors=i.colors??null,this.dashCount=i.dashCount??1,this.resolution=i.resolution??new X(this._engine.getRenderWidth(),this._engine.getRenderHeight()),i.colorsTexture?this.colorsTexture=i.colorsTexture:this._colors?this.colorsTexture=Ke.CreateColorsTexture(`${e.name}-colors-texture`,this._colors,this.colorsSampling,this._scene):(this._color=this._color??Pi.DEFAULT_COLOR,Ke.PrepareEmptyColorsTexture(this._scene)),this._engine.onDisposeObservable.add(()=>{Ke.DisposeEmptyColorsTexture()})}getAttributes(e){e.push("grl_offsets"),e.push("grl_widths"),e.push("grl_colorPointers"),e.push("grl_counters"),this._cameraFacing?(e.push("grl_previousAndSide"),e.push("grl_nextAndCounters")):e.push("grl_slopes")}getSamplers(e){e.push("grl_colors")}getActiveTextures(e){this.colorsTexture&&e.push(this.colorsTexture)}getUniforms(e=0){const t=[{name:"grl_singleColor",size:3,type:"vec3"},{name:"grl_textureSize",size:2,type:"vec2"},{name:"grl_dashOptions",size:4,type:"vec4"},{name:"grl_colorMode_visibility_colorsWidth_useColors",size:4,type:"vec4"}];return this._cameraFacing&&t.push({name:"grl_projection",size:16,type:"mat4"},{name:"grl_aspect_resolution_lineWidth",size:4,type:"vec4"}),e===1&&t.push({name:"viewProjection",size:16,type:"mat4"}),{ubo:t,vertex:this._cameraFacing&&this._isGLSL(e)?`
                    uniform vec4 grl_aspect_resolution_lineWidth;
                    uniform mat4 grl_projection;
    `:"",fragment:this._isGLSL(e)?`
                    uniform vec4 grl_dashOptions;
                    uniform vec2 grl_textureSize;
                    uniform vec4 grl_colorMode_visibility_colorsWidth_useColors;
                    uniform vec3 grl_singleColor;
    `:""}}get isEnabled(){return!0}bindForSubMesh(e){if(this._cameraFacing){e.updateMatrix("grl_projection",this._scene.getProjectionMatrix()),this._isGLSL(this._material.shaderLanguage)||e.updateMatrix("viewProjection",this._scene.getTransformMatrix());const n=G.Vector4[0];n.x=this._aspect,n.y=this._resolution.x,n.z=this._resolution.y,n.w=this.width,e.updateVector4("grl_aspect_resolution_lineWidth",n)}const t=G.Vector4[0];t.x=Ke.BooleanToNumber(this.useDash),t.y=this._dashArray,t.z=this.dashOffset,t.w=this.dashRatio,e.updateVector4("grl_dashOptions",t);const i=G.Vector4[1];i.x=this.colorMode,i.y=this.visibility,i.z=this.colorsTexture?this.colorsTexture.getSize().width:0,i.w=Ke.BooleanToNumber(this.useColors),e.updateVector4("grl_colorMode_visibility_colorsWidth_useColors",i),this._color&&e.updateColor3("grl_singleColor",this._color);const r=this.colorsTexture??Pi.EmptyColorsTexture;e.setTexture("grl_colors",r),e.updateFloat2("grl_textureSize",(r==null?void 0:r.getSize().width)??1,(r==null?void 0:r.getSize().height)??1)}prepareDefines(e,t,i){e.GREASED_LINE_HAS_COLOR=!!this.color&&!this.useColors,e.GREASED_LINE_SIZE_ATTENUATION=this._sizeAttenuation,e.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=this._colorsDistributionType===1,e.GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM=t.useRightHandedSystem,e.GREASED_LINE_CAMERA_FACING=this._cameraFacing,e.GREASED_LINE_USE_OFFSETS=!!i.offsets}getClassName(){return _n.GREASED_LINE_MATERIAL_NAME}getCustomCode(e,t=0){return this._isGLSL(t)?_4(e,this._cameraFacing):g4(e,this._cameraFacing)}dispose(){var e;(e=this.colorsTexture)==null||e.dispose(),super.dispose()}get colors(){return this._colors}set colors(e){this.setColors(e)}setColors(e,t=!1,i=!1){var n,a,o;const r=((n=this._colors)==null?void 0:n.length)??0;if(this._colors=e,e===null||e.length===0){(a=this.colorsTexture)==null||a.dispose();return}if(!(t&&!i))if(this.colorsTexture&&r===e.length&&!i){const l=Ke.Color3toRGBAUint8(e);this.colorsTexture.update(l)}else(o=this.colorsTexture)==null||o.dispose(),this.colorsTexture=Ke.CreateColorsTexture(`${this._material.name}-colors-texture`,e,this.colorsSampling,this._scene)}updateLazy(){this._colors&&this.setColors(this._colors,!1,!0)}get dashCount(){return this._dashCount}set dashCount(e){this._dashCount=e,this._dashArray=1/e}get sizeAttenuation(){return this._sizeAttenuation}set sizeAttenuation(e){this._sizeAttenuation=e,this.markAllDefinesAsDirty()}get color(){return this._color}set color(e){this.setColor(e)}setColor(e,t=!1){this._color===null&&e!==null||this._color!==null&&e===null?(this._color=e,t||this.markAllDefinesAsDirty()):this._color=e}get colorsDistributionType(){return this._colorsDistributionType}set colorsDistributionType(e){this._colorsDistributionType=e,this.markAllDefinesAsDirty()}get resolution(){return this._resolution}set resolution(e){this._aspect=e.x/e.y,this._resolution=e}serialize(){const e=super.serialize(),t={colorDistributionType:this._colorsDistributionType,colorsSampling:this.colorsSampling,colorMode:this.colorMode,dashCount:this._dashCount,dashOffset:this.dashOffset,dashRatio:this.dashRatio,resolution:this._resolution,sizeAttenuation:this._sizeAttenuation,useColors:this.useColors,useDash:this.useDash,visibility:this.visibility,width:this.width};return this._colors&&(t.colors=this._colors),this._color&&(t.color=this._color),e.greasedLineMaterialOptions=t,e}parse(e,t,i){var n;super.parse(e,t,i);const r=e.greasedLineMaterialOptions;(n=this.colorsTexture)==null||n.dispose(),r.color&&this.setColor(r.color,!0),r.colorDistributionType&&(this.colorsDistributionType=r.colorDistributionType),r.colors&&(this.colors=r.colors),r.colorsSampling&&(this.colorsSampling=r.colorsSampling),r.colorMode&&(this.colorMode=r.colorMode),r.useColors&&(this.useColors=r.useColors),r.visibility&&(this.visibility=r.visibility),r.useDash&&(this.useDash=r.useDash),r.dashCount&&(this.dashCount=r.dashCount),r.dashRatio&&(this.dashRatio=r.dashRatio),r.dashOffset&&(this.dashOffset=r.dashOffset),r.width&&(this.width=r.width),r.sizeAttenuation&&(this.sizeAttenuation=r.sizeAttenuation),r.resolution&&(this.resolution=r.resolution),this.colors?this.colorsTexture=Ke.CreateColorsTexture(`${this._material.name}-colors-texture`,this.colors,this.colorsSampling,t):Ke.PrepareEmptyColorsTexture(t),this.markAllDefinesAsDirty()}copyTo(e){var i;const t=e;(i=t.colorsTexture)==null||i.dispose(),this._colors&&(t.colorsTexture=Ke.CreateColorsTexture(`${t._material.name}-colors-texture`,this._colors,t.colorsSampling,this._scene)),t.setColor(this.color,!0),t.colorsDistributionType=this.colorsDistributionType,t.colorsSampling=this.colorsSampling,t.colorMode=this.colorMode,t.useColors=this.useColors,t.visibility=this.visibility,t.useDash=this.useDash,t.dashCount=this.dashCount,t.dashRatio=this.dashRatio,t.dashOffset=this.dashOffset,t.width=this.width,t.sizeAttenuation=this.sizeAttenuation,t.resolution=this.resolution,t.markAllDefinesAsDirty()}_isGLSL(e){return e===0||this._forceGLSL}}_n.GREASED_LINE_MATERIAL_NAME="GreasedLinePluginMaterial";_n.ForceGLSL=!1;y(`BABYLON.${_n.GREASED_LINE_MATERIAL_NAME}`,_n);const v4="GREASED_LINE_USE_OFFSETS";class Gl extends Ta{constructor(e,t,i){const r=t.getEngine(),n=r.isWebGPU&&!(i.forceGLSL||Gl.ForceGLSL),a=["COLOR_DISTRIBUTION_TYPE_LINE 1.","COLOR_DISTRIBUTION_TYPE_SEGMENT 0.","COLOR_MODE_SET 0.","COLOR_MODE_ADD 1.","COLOR_MODE_MULTIPLY 2."];t.useRightHandedSystem&&a.push("GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM");const o=["position","grl_widths","grl_offsets","grl_colorPointers"];i.cameraFacing?(a.push("GREASED_LINE_CAMERA_FACING"),o.push("grl_previousAndSide","grl_nextAndCounters")):(o.push("grl_slopes"),o.push("grl_counters"));const l=["grlColorsWidth","grlUseColors","grlWidth","grlColor","grl_colorModeAndColorDistributionType","grlResolution","grlAspect","grlAizeAttenuation","grlDashArray","grlDashOffset","grlDashRatio","grlUseDash","grlVisibility","grlColors"];if(n||l.push("world","viewProjection","view","projection"),super(e,t,{vertex:"greasedLine",fragment:"greasedLine"},{uniformBuffers:n?["Scene","Mesh"]:void 0,attributes:o,uniforms:l,samplers:n?[]:["grlColors"],defines:a,extraInitializationsAsync:async()=>{n?await Promise.all([U(()=>Promise.resolve().then(()=>V4),void 0),U(()=>Promise.resolve().then(()=>w4),void 0)]):await Promise.all([U(()=>Promise.resolve().then(()=>F4),void 0),U(()=>Promise.resolve().then(()=>D4),void 0)])},shaderLanguage:n?1:0}),this._color=q.White(),this._colorsDistributionType=0,this._colorsTexture=null,i=i||{color:Pi.DEFAULT_COLOR},this.visibility=i.visibility??1,this.useDash=i.useDash??!1,this.dashRatio=i.dashRatio??.5,this.dashOffset=i.dashOffset??0,this.dashCount=i.dashCount??1,this.width=i.width?i.width:i.sizeAttenuation&&i.cameraFacing?Pi.DEFAULT_WIDTH_ATTENUATED:Pi.DEFAULT_WIDTH,this.sizeAttenuation=i.sizeAttenuation??!1,this.color=i.color??q.White(),this.useColors=i.useColors??!1,this.colorsDistributionType=i.colorDistributionType??0,this.colorsSampling=i.colorsSampling??gi.NEAREST_NEAREST,this.colorMode=i.colorMode??0,this._colors=i.colors??null,this._cameraFacing=i.cameraFacing??!0,this.resolution=i.resolution??new X(r.getRenderWidth(),r.getRenderHeight()),i.colorsTexture?this.colorsTexture=i.colorsTexture:this._colors?this.colorsTexture=Ke.CreateColorsTexture(`${this.name}-colors-texture`,this._colors,this.colorsSampling,t):(this._color=this._color??Pi.DEFAULT_COLOR,this.colorsTexture=Ke.PrepareEmptyColorsTexture(t)),n){const c=new tI;c.setParameters(),c.samplingMode=this.colorsSampling,this.setTextureSampler("grlColorsSampler",c)}r.onDisposeObservable.add(()=>{Ke.DisposeEmptyColorsTexture()})}dispose(){var e;(e=this._colorsTexture)==null||e.dispose(),super.dispose()}_setColorModeAndColorDistributionType(){this.setVector2("grl_colorModeAndColorDistributionType",new X(this._colorMode,this._colorsDistributionType))}updateLazy(){this._colors&&this.setColors(this._colors,!1,!0)}get colors(){return this._colors}set colors(e){this.setColors(e)}setColors(e,t=!1,i=!1){var n,a,o;const r=((n=this._colors)==null?void 0:n.length)??0;if(this._colors=e,e===null||e.length===0){(a=this._colorsTexture)==null||a.dispose();return}if(!(t&&!i))if(this._colorsTexture&&r===e.length&&!i){const l=Ke.Color3toRGBAUint8(e);this._colorsTexture.update(l)}else(o=this._colorsTexture)==null||o.dispose(),this.colorsTexture=Ke.CreateColorsTexture(`${this.name}-colors-texture`,e,this.colorsSampling,this.getScene())}get colorsTexture(){return this._colorsTexture??null}set colorsTexture(e){this._colorsTexture=e,this.setFloat("grlColorsWidth",this._colorsTexture.getSize().width),this.setTexture("grlColors",this._colorsTexture)}get width(){return this._width}set width(e){this._width=e,this.setFloat("grlWidth",e)}get useColors(){return this._useColors}set useColors(e){this._useColors=e,this.setFloat("grlUseColors",Ke.BooleanToNumber(e))}get colorsSampling(){return this._colorsSampling}set colorsSampling(e){this._colorsSampling=e}get visibility(){return this._visibility}set visibility(e){this._visibility=e,this.setFloat("grlVisibility",e)}get useDash(){return this._useDash}set useDash(e){this._useDash=e,this.setFloat("grlUseDash",Ke.BooleanToNumber(e))}get dashOffset(){return this._dashOffset}set dashOffset(e){this._dashOffset=e,this.setFloat("grlDashOffset",e)}get dashRatio(){return this._dashRatio}set dashRatio(e){this._dashRatio=e,this.setFloat("grlDashRatio",e)}get dashCount(){return this._dashCount}set dashCount(e){this._dashCount=e,this._dashArray=1/e,this.setFloat("grlDashArray",this._dashArray)}get sizeAttenuation(){return this._sizeAttenuation}set sizeAttenuation(e){this._sizeAttenuation=e,this.setFloat("grlSizeAttenuation",Ke.BooleanToNumber(e))}get color(){return this._color}set color(e){this.setColor(e)}setColor(e){e=e??Pi.DEFAULT_COLOR,this._color=e,this.setColor3("grlColor",e)}get colorsDistributionType(){return this._colorsDistributionType}set colorsDistributionType(e){this._colorsDistributionType=e,this._setColorModeAndColorDistributionType()}get colorMode(){return this._colorMode}set colorMode(e){this._colorMode=e,this._setColorModeAndColorDistributionType()}get resolution(){return this._resolution}set resolution(e){this._resolution=e,this.setVector2("grlResolution",e),this.setFloat("grlAspect",e.x/e.y)}serialize(){const e=super.serialize(),t={colorDistributionType:this._colorsDistributionType,colorsSampling:this._colorsSampling,colorMode:this._colorMode,color:this._color,dashCount:this._dashCount,dashOffset:this._dashOffset,dashRatio:this._dashRatio,resolution:this._resolution,sizeAttenuation:this._sizeAttenuation,useColors:this._useColors,useDash:this._useDash,visibility:this._visibility,width:this._width,cameraFacing:this._cameraFacing};return this._colors&&(t.colors=this._colors),e.greasedLineMaterialOptions=t,e}parse(e,t,i){var n;const r=e.greasedLineMaterialOptions;(n=this._colorsTexture)==null||n.dispose(),r.color&&(this.color=r.color),r.colorDistributionType&&(this.colorsDistributionType=r.colorDistributionType),r.colorsSampling&&(this.colorsSampling=r.colorsSampling),r.colorMode&&(this.colorMode=r.colorMode),r.useColors&&(this.useColors=r.useColors),r.visibility&&(this.visibility=r.visibility),r.useDash&&(this.useDash=r.useDash),r.dashCount&&(this.dashCount=r.dashCount),r.dashRatio&&(this.dashRatio=r.dashRatio),r.dashOffset&&(this.dashOffset=r.dashOffset),r.width&&(this.width=r.width),r.sizeAttenuation&&(this.sizeAttenuation=r.sizeAttenuation),r.resolution&&(this.resolution=r.resolution),r.colors?this.colorsTexture=Ke.CreateColorsTexture(`${this.name}-colors-texture`,r.colors,this.colorsSampling,this.getScene()):this.colorsTexture=Ke.PrepareEmptyColorsTexture(t),this._cameraFacing=r.cameraFacing??!0,this.setDefine("GREASED_LINE_CAMERA_FACING",this._cameraFacing)}}Gl.ForceGLSL=!1;var BT;(function(s){s[s.MATERIAL_TYPE_STANDARD=0]="MATERIAL_TYPE_STANDARD",s[s.MATERIAL_TYPE_PBR=1]="MATERIAL_TYPE_PBR",s[s.MATERIAL_TYPE_SIMPLE=2]="MATERIAL_TYPE_SIMPLE"})(BT||(BT={}));var VT;(function(s){s[s.COLOR_MODE_SET=0]="COLOR_MODE_SET",s[s.COLOR_MODE_ADD=1]="COLOR_MODE_ADD",s[s.COLOR_MODE_MULTIPLY=2]="COLOR_MODE_MULTIPLY"})(VT||(VT={}));var UT;(function(s){s[s.COLOR_DISTRIBUTION_TYPE_SEGMENT=0]="COLOR_DISTRIBUTION_TYPE_SEGMENT",s[s.COLOR_DISTRIBUTION_TYPE_LINE=1]="COLOR_DISTRIBUTION_TYPE_LINE"})(UT||(UT={}));const x4=`#if defined(DBG_ENABLED)
attribute float dbg_initialPass;
varying vec3 dbg_vBarycentric;
flat varying vec3 dbg_vVertexWorldPos;
flat varying float dbg_vPass;
#endif`,E4=`#if defined(DBG_ENABLED)
attribute dbg_initialPass: f32;
varying dbg_vBarycentric: vec3f;
varying dbg_vVertexWorldPos: vec3f;
varying dbg_vPass: f32;
#endif`,T4=`#if defined(DBG_ENABLED)
float dbg_vertexIndex = mod(float(gl_VertexID), 3.);
if (dbg_vertexIndex == 0.0) { 
    dbg_vBarycentric = vec3(1.,0.,0.); 
}
else if (dbg_vertexIndex == 1.0) { 
    dbg_vBarycentric = vec3(0.,1.,0.); 
}
else { 
    dbg_vBarycentric = vec3(0.,0.,1.); 
}

dbg_vVertexWorldPos = vPositionW;
dbg_vPass = dbg_initialPass;
#endif`,b4=`#if defined(DBG_ENABLED)
var dbg_vertexIndex = f32(input.vertexIndex) % 3.;
if (dbg_vertexIndex == 0.0) { 
    vertexOutputs.dbg_vBarycentric = vec3f(1.,0.,0.); 
}
else if (dbg_vertexIndex == 1.0) { 
    vertexOutputs.dbg_vBarycentric = vec3f(0.,1.,0.); 
}
else { 
    vertexOutputs.dbg_vBarycentric = vec3f(0.,0.,1.); 
}

vertexOutputs.dbg_vVertexWorldPos = vertexOutputs.vPositionW;
vertexOutputs.dbg_vPass = input.dbg_initialPass;
#endif`,C4=`#if defined(DBG_ENABLED)
uniform vec3 dbg_shadedDiffuseColor;
uniform vec4 dbg_shadedSpecularColorPower;
uniform vec3 dbg_thicknessRadiusScale;

#if DBG_MODE == 2 || DBG_MODE == 3
    uniform vec3 dbg_vertexColor;
#endif

#if DBG_MODE == 1
    uniform vec3 dbg_wireframeTrianglesColor;
#elif DBG_MODE == 3
    uniform vec3 dbg_wireframeVerticesColor;
#elif DBG_MODE == 4 || DBG_MODE == 5
    uniform vec3 dbg_uvPrimaryColor;
    uniform vec3 dbg_uvSecondaryColor;
#elif DBG_MODE == 7
    uniform vec3 dbg_materialColor;
#endif
#endif`,y4=`#if defined(DBG_ENABLED)
uniform dbg_shadedDiffuseColor: vec3f;
uniform dbg_shadedSpecularColorPower: vec4f;
uniform dbg_thicknessRadiusScale: vec3f;

#if DBG_MODE == 2 || DBG_MODE == 3
    uniform dbg_vertexColor: vec3f;
#endif

#if DBG_MODE == 1
    uniform dbg_wireframeTrianglesColor: vec3f;
#elif DBG_MODE == 3
    uniform  dbg_wireframeVerticesColor: vec3f;
#elif DBG_MODE == 4 || DBG_MODE == 5
    uniform dbg_uvPrimaryColor: vec3f;
    uniform dbg_uvSecondaryColor: vec3f;
#elif DBG_MODE == 7
    uniform dbg_materialColor: vec3f;
#endif
#endif`,I4=`#if defined(DBG_ENABLED)
varying vec3 dbg_vBarycentric;
flat varying vec3 dbg_vVertexWorldPos;
flat varying float dbg_vPass;

#if !defined(DBG_MULTIPLY)
    vec3 dbg_applyShading(vec3 color) {
        vec3 N = vNormalW.xyz;
        vec3 L = normalize(vEyePosition.xyz - vPositionW.xyz);
        vec3 H = normalize(L + L);
        float LdotN = clamp(dot(L,N), 0., 1.);
        float HdotN = clamp(dot(H,N), 0., 1.);
        float specTerm = pow(HdotN, dbg_shadedSpecularColorPower.w);
        color *= (LdotN / PI);
        color += dbg_shadedSpecularColorPower.rgb * (specTerm / PI);
        return color;
    }
#endif

#if DBG_MODE == 1 || DBG_MODE == 3
    float dbg_edgeFactor() {
        vec3 d = fwidth(dbg_vBarycentric);
        vec3 a3 = smoothstep(vec3(0.), d * dbg_thicknessRadiusScale.x, dbg_vBarycentric);
        return min(min(a3.x, a3.y), a3.z);
    }
#endif

#if DBG_MODE == 2 || DBG_MODE == 3
    float dbg_cornerFactor() {
        vec3 worldPos = vPositionW;
        float dist = length(worldPos - dbg_vVertexWorldPos);
        float camDist = length(worldPos - vEyePosition.xyz);
        float d = sqrt(camDist) * .001;
        return smoothstep((dbg_thicknessRadiusScale.y * d), ((dbg_thicknessRadiusScale.y * 1.01) * d), dist);
    }
#endif

#if (DBG_MODE == 4 && defined(UV1)) || (DBG_MODE == 5 && defined(UV2))
    float dbg_checkerboardFactor(vec2 uv) {
        vec2 f = fract(uv * dbg_thicknessRadiusScale.z);
        f -= .5;
        return (f.x * f.y) > 0. ? 1. : 0.;
    }
#endif
#endif`,R4=`#if defined(DBG_ENABLED)
varying dbg_vBarycentric: vec3f;
varying dbg_vVertexWorldPos: vec3f;
varying dbg_vPass: f32;

#if !defined(DBG_MULTIPLY)
    fn dbg_applyShading(color: vec3f) -> vec3f {
        var N = fragmentInputs.vNormalW.xyz;
        var L = normalize(scene.vEyePosition.xyz - fragmentInputs.vPositionW.xyz);
        var H = normalize(L + L);
        var LdotN = clamp(dot(L,N), 0., 1.);
        var HdotN = clamp(dot(H,N), 0., 1.);
        var specTerm = pow(HdotN, uniforms.dbg_shadedSpecularColorPower.w);
        var result = color * (LdotN / PI);
        result += uniforms.dbg_shadedSpecularColorPower.rgb * (specTerm / PI);
        return result;
    }
#endif

#if DBG_MODE == 1 || DBG_MODE == 3
    fn dbg_edgeFactor() -> f32 {
        var d = fwidth(fragmentInputs.dbg_vBarycentric);
        var a3 = smoothstep(vec3f(0.), d * uniforms.dbg_thicknessRadiusScale.x, fragmentInputs.dbg_vBarycentric);
        return min(min(a3.x, a3.y), a3.z);
    }
#endif

#if DBG_MODE == 2 || DBG_MODE == 3
    fn dbg_cornerFactor() -> f32 {
        var worldPos = fragmentInputs.vPositionW;
        float dist = length(worldPos - fragmentInputs.dbg_vVertexWorldPos);
        float camDist = length(worldPos - scene.vEyePosition.xyz);
        float d = sqrt(camDist) * .001;
        return smoothstep((uniforms.dbg_thicknessRadiusScale.y * d), ((uniforms.dbg_thicknessRadiusScale.y * 1.01) * d), dist);
    }
#endif

#if (DBG_MODE == 4 && defined(UV1)) || (DBG_MODE == 5 && defined(UV2))
    fn dbg_checkerboardFactor(uv: vec2f) -> f32 {
        var f = fract(uv * uniforms.dbg_thicknessRadiusScale.z);
        f -= .5;
        return (f.x * f.y) > 0. ? 1. : 0.;
    }
#endif
#endif`,A4=`#if defined(DBG_ENABLED)
vec3 dbg_color = vec3(1.);
#if DBG_MODE == 1
    dbg_color = mix(dbg_wireframeTrianglesColor, vec3(1.), dbg_edgeFactor());
#elif DBG_MODE == 2 || DBG_MODE == 3
    float dbg_cornerFactor = dbg_cornerFactor();
    if (dbg_vPass == 0. && dbg_cornerFactor == 1.) discard;
    dbg_color = mix(dbg_vertexColor, vec3(1.), dbg_cornerFactor);
    #if DBG_MODE == 3
        dbg_color *= mix(dbg_wireframeVerticesColor, vec3(1.), dbg_edgeFactor());
    #endif
#elif DBG_MODE == 4 && defined(MAINUV1)
    dbg_color = mix(dbg_uvPrimaryColor, dbg_uvSecondaryColor, dbg_checkerboardFactor(vMainUV1));
#elif DBG_MODE == 5 && defined(MAINUV2)
    dbg_color = mix(dbg_uvPrimaryColor, dbg_uvSecondaryColor, dbg_checkerboardFactor(vMainUV2));
#elif DBG_MODE == 6 && defined(VERTEXCOLOR)
    dbg_color = vColor.rgb;
#elif DBG_MODE == 7
    dbg_color = dbg_materialColor;
#endif

#if defined(DBG_MULTIPLY)
    gl_FragColor *= vec4(dbg_color, 1.);
#else
    #if DBG_MODE != 6
        gl_FragColor = vec4(dbg_applyShading(dbg_shadedDiffuseColor) * dbg_color, 1.);
    #else
        gl_FragColor = vec4(dbg_color, 1.);
    #endif
#endif
#endif`,P4=`#if defined(DBG_ENABLED)
var dbg_color = vec3f(1.);
#if DBG_MODE == 1
    dbg_color = mix(uniforms.dbg_wireframeTrianglesColor, vec3f(1.), dbg_edgeFactor());
#elif DBG_MODE == 2 || DBG_MODE == 3
    var dbg_cornerFactor = dbg_cornerFactor();
    if (fragmentInputs.dbg_vPass == 0. && dbg_cornerFactor == 1.) discard;
    dbg_color = mix(uniforms.dbg_vertexColor, vec3(1.), dbg_cornerFactor);
    #if DBG_MODE == 3
        dbg_color *= mix(uniforms.dbg_wireframeVerticesColor, vec3f(1.), dbg_edgeFactor());
    #endif
#elif DBG_MODE == 4 && defined(MAINUV1)
    dbg_color = mix(uniforms.dbg_uvPrimaryColor, uniforms.dbg_uvSecondaryColor, dbg_checkerboardFactor(fragmentInputs.vMainUV1));
#elif DBG_MODE == 5 && defined(MAINUV2)
    dbg_color = mix(uniforms.dbg_uvPrimaryColor, uniforms.dbg_uvSecondaryColor, dbg_checkerboardFactor(fragmentInputs.vMainUV2));
#elif DBG_MODE == 6 && defined(VERTEXCOLOR)
    dbg_color = fragmentInputs.vColor.rgb;
#elif DBG_MODE == 7
    dbg_color = uniforms.dbg_materialColor;
#endif

#if defined(DBG_MULTIPLY)
    fragmentOutputs.color *= vec4f(dbg_color, 1.);
#else
    #if DBG_MODE != 6
        fragmentOutputs.color = vec4f(dbg_applyShading(dbg_shadedDiffuseColor) * dbg_color, 1.);
    #else
        fragmentOutputs.color = vec4f(dbg_color, 1.);
    #endif
#endif
#endif`,n0=[new q(.98,.26,.38),new q(.47,.75,.3),new q(0,.26,.77),new q(.97,.6,.76),new q(.19,.63,.78),new q(.98,.8,.6),new q(.65,.43,.15),new q(.15,.47,.22),new q(.67,.71,.86),new q(.09,.46,.56),new q(.8,.98,.02),new q(.39,.29,.13),new q(.53,.63,.06),new q(.95,.96,.41),new q(1,.72,.94),new q(.63,.08,.31),new q(.66,.96,.95),new q(.22,.14,.19),new q(.14,.65,.59),new q(.93,1,.68),new q(.93,.14,.44),new q(.47,.86,.67),new q(.85,.07,.78),new q(.53,.64,.98),new q(.43,.37,.56),new q(.71,.65,.25),new q(.66,.19,.01),new q(.94,.53,.12),new q(.41,.44,.44),new q(.24,.71,.96),new q(.57,.28,.56),new q(.44,.98,.42)];var kT;(function(s){s[s.NONE=0]="NONE",s[s.TRIANGLES=1]="TRIANGLES",s[s.VERTICES=2]="VERTICES",s[s.TRIANGLES_VERTICES=3]="TRIANGLES_VERTICES",s[s.UV0=4]="UV0",s[s.UV1=5]="UV1",s[s.VERTEXCOLORS=6]="VERTEXCOLORS",s[s.MATERIALIDS=7]="MATERIALIDS"})(kT||(kT={}));class O4 extends Oi{constructor(){super(...arguments),this.DBG_MODE=0,this.DBG_MULTIPLY=!0,this.DBG_ENABLED=!0}}class di extends Er{_markAllDefinesAsDirty(){this._enable(this._isEnabled),this.markAllDefinesAsDirty()}isCompatible(e){switch(e){case 0:case 1:return!0;default:return!1}}constructor(e,t={}){const i=new O4;i.DBG_MODE=t.mode??i.DBG_MODE,i.DBG_MULTIPLY=t.multiply??i.DBG_MULTIPLY,super(e,"MeshDebug",200,i,!0,!0),this._mode=i.DBG_MODE,this._multiply=i.DBG_MULTIPLY,this.shadedDiffuseColor=t.shadedDiffuseColor??new q(1,1,1),this.shadedSpecularColor=t.shadedSpecularColor??new q(.8,.8,.8),this.shadedSpecularPower=t.shadedSpecularPower??10,this.wireframeThickness=t.wireframeThickness??.7,this.wireframeTrianglesColor=t.wireframeTrianglesColor??new q(0,0,0),this.wireframeVerticesColor=t.wireframeVerticesColor??new q(.8,.8,.8),this.vertexColor=t.vertexColor??new q(0,0,0),this.vertexRadius=t.vertexRadius??1.2,this.uvScale=t.uvScale??20,this.uvPrimaryColor=t.uvPrimaryColor??new q(1,1,1),this.uvSecondaryColor=t.uvSecondaryColor??new q(.5,.5,.5),this._materialColor=di.MaterialColors[di._PluginCount++%di.MaterialColors.length],this.isEnabled=!0}getClassName(){return"MeshDebugPluginMaterial"}get isEnabled(){return this._isEnabled}set isEnabled(e){if(this._isEnabled!==e){if(!this._material.getScene().getEngine().isWebGPU&&this._material.getScene().getEngine().version==1){N.Error("MeshDebugPluginMaterial is not supported on WebGL 1.0."),this._isEnabled=!1;return}this._isEnabled=e,this._markAllDefinesAsDirty()}}prepareDefines(e,t,i){(this._mode==2||this._mode==1||this._mode==3)&&!i.isVerticesDataPresent("dbg_initialPass")&&N.Warn("For best results with TRIANGLES, TRIANGLES_VERTICES, or VERTICES modes, please use MeshDebugPluginMaterial.PrepareMeshForTrianglesAndVerticesMode() on mesh.",1),e.DBG_MODE=this._mode,e.DBG_MULTIPLY=this._multiply,e.DBG_ENABLED=this._isEnabled}getAttributes(e){e.push("dbg_initialPass")}getUniforms(e=0){return{ubo:[{name:"dbg_shadedDiffuseColor",size:3,type:"vec3"},{name:"dbg_shadedSpecularColorPower",size:4,type:"vec4"},{name:"dbg_thicknessRadiusScale",size:3,type:"vec3"},{name:"dbg_wireframeTrianglesColor",size:3,type:"vec3"},{name:"dbg_wireframeVerticesColor",size:3,type:"vec3"},{name:"dbg_vertexColor",size:3,type:"vec3"},{name:"dbg_uvPrimaryColor",size:3,type:"vec3"},{name:"dbg_uvSecondaryColor",size:3,type:"vec3"},{name:"dbg_materialColor",size:3,type:"vec3"}],fragment:e===0?C4:y4}}bindForSubMesh(e){this._isEnabled&&(e.updateFloat3("dbg_shadedDiffuseColor",this.shadedDiffuseColor.r,this.shadedDiffuseColor.g,this.shadedDiffuseColor.b),e.updateFloat4("dbg_shadedSpecularColorPower",this.shadedSpecularColor.r,this.shadedSpecularColor.g,this.shadedSpecularColor.b,this.shadedSpecularPower),e.updateFloat3("dbg_thicknessRadiusScale",this.wireframeThickness,this.vertexRadius,this.uvScale),e.updateColor3("dbg_wireframeTrianglesColor",this.wireframeTrianglesColor),e.updateColor3("dbg_wireframeVerticesColor",this.wireframeVerticesColor),e.updateColor3("dbg_vertexColor",this.vertexColor),e.updateColor3("dbg_uvPrimaryColor",this.uvPrimaryColor),e.updateColor3("dbg_uvSecondaryColor",this.uvSecondaryColor),e.updateColor3("dbg_materialColor",this._materialColor))}getCustomCode(e,t=0){return t===1?e==="vertex"?{CUSTOM_VERTEX_DEFINITIONS:E4,CUSTOM_VERTEX_MAIN_END:b4}:{CUSTOM_FRAGMENT_DEFINITIONS:R4,CUSTOM_FRAGMENT_MAIN_END:P4}:e==="vertex"?{CUSTOM_VERTEX_DEFINITIONS:x4,CUSTOM_VERTEX_MAIN_END:T4}:{CUSTOM_FRAGMENT_DEFINITIONS:I4,CUSTOM_FRAGMENT_MAIN_END:A4}}static Reset(){this._PluginCount=0,this.MaterialColors=n0}static PrepareMeshForTrianglesAndVerticesMode(e,t=!1){let i=()=>{};if(e.getTotalIndices()==0)return i;if(t){const u=e.getVerticesDataKinds(),h=e.getIndices(),d={};for(const f of u)d[f]=e.getVerticesData(f);i=function(){e.setIndices(h);for(const f of u){const m=e.getVertexBuffer(f).getStrideSize();e.setVerticesData(f,d[f],void 0,m)}e.removeVerticesData("dbg_initialPass")}}let r=Array.from(e.getIndices());const n=[];for(let u=0;u<r.length;u+=3)n.push(r[u+1],r[u+2],r[u+0]);e.setIndices(r.concat(n)),e.convertToUnIndexedMesh(),e.isUnIndexed=!1,r=Array.from(e.getIndices());const a=[];for(let u=r.length/2;u<r.length;u+=3)a.push(r[u+1],r[u+2],r[u+0]);e.setIndices(r.concat(a));const o=e.getTotalVertices(),l=o/2,c=new Array(o).fill(1,0,l).fill(0,l,o);return e.setVerticesData("dbg_initialPass",c,!1,1),i}}di._PluginCount=0;di.MaterialColors=n0;_([Xt()],di.prototype,"_materialColor",void 0);_([R()],di.prototype,"_isEnabled",void 0);_([R(),W("_markAllDefinesAsDirty")],di.prototype,"mode",void 0);_([R(),W("_markAllDefinesAsDirty")],di.prototype,"multiply",void 0);_([Xt()],di.prototype,"shadedDiffuseColor",void 0);_([Xt()],di.prototype,"shadedSpecularColor",void 0);_([R()],di.prototype,"shadedSpecularPower",void 0);_([R()],di.prototype,"wireframeThickness",void 0);_([Xt()],di.prototype,"wireframeTrianglesColor",void 0);_([Xt()],di.prototype,"wireframeVerticesColor",void 0);_([Xt()],di.prototype,"vertexColor",void 0);_([R()],di.prototype,"vertexRadius",void 0);_([R()],di.prototype,"uvScale",void 0);_([Xt()],di.prototype,"uvPrimaryColor",void 0);_([Xt()],di.prototype,"uvSecondaryColor",void 0);y("BABYLON.MeshDebugPluginMaterial",di);Object.defineProperty(Lr.prototype,"decalMap",{get:function(){return this._decalMap||(this._decalMap=new hc(this)),this._decalMap},enumerable:!0,configurable:!0});Object.defineProperty(Ve.prototype,"decalMap",{get:function(){return this._decalMap||(this._decalMap=new hc(this)),this._decalMap},enumerable:!0,configurable:!0});Object.defineProperty(Mt.prototype,"decalMap",{get:function(){return this._decalMap},set:function(s){this._decalMap=s},enumerable:!0,configurable:!0});const gf="greasedLinePixelShader",a0=`precision highp float;uniform sampler2D grlColors;uniform float grlUseColors;uniform float grlUseDash;uniform float grlDashArray;uniform float grlDashOffset;uniform float grlDashRatio;uniform float grlVisibility;uniform float grlColorsWidth;uniform vec2 grl_colorModeAndColorDistributionType;uniform vec3 grlColor;varying float grlCounters;varying float grlColorPointer;void main() {float grlColorMode=grl_colorModeAndColorDistributionType.x;float grlColorDistributionType=grl_colorModeAndColorDistributionType.y;gl_FragColor=vec4(grlColor,1.);gl_FragColor.a=step(grlCounters,grlVisibility);if (gl_FragColor.a==0.) discard;if( grlUseDash==1. ){gl_FragColor.a=ceil(mod(grlCounters+grlDashOffset,grlDashArray)-(grlDashArray*grlDashRatio));if (gl_FragColor.a==0.) discard;}
if (grlUseColors==1.) {vec4 textureColor;if (grlColorDistributionType==COLOR_DISTRIBUTION_TYPE_LINE) { 
textureColor=texture2D(grlColors,vec2(grlCounters,0.),0.);} else {textureColor=texture2D(grlColors,vec2(grlColorPointer/grlColorsWidth,0.),0.);}
if (grlColorMode==COLOR_MODE_SET) {gl_FragColor=textureColor;} else if (grlColorMode==COLOR_MODE_ADD) {gl_FragColor+=textureColor;} else if (grlColorMode==COLOR_MODE_MULTIPLY) {gl_FragColor*=textureColor;}}}
`;S.ShadersStore[gf]||(S.ShadersStore[gf]=a0);const N4={name:gf,shader:a0},D4=Object.freeze(Object.defineProperty({__proto__:null,greasedLinePixelShader:N4},Symbol.toStringTag,{value:"Module"})),Sf="greasedLineVertexShader",o0=`precision highp float;
#include<instancesDeclaration>
attribute float grl_widths;attribute vec3 grl_offsets;attribute float grl_colorPointers;attribute vec3 position;uniform mat4 viewProjection;uniform mat4 projection;varying float grlCounters;varying float grlColorPointer;
#ifdef GREASED_LINE_CAMERA_FACING
attribute vec4 grl_nextAndCounters;attribute vec4 grl_previousAndSide;uniform vec2 grlResolution;uniform float grlAspect;uniform float grlWidth;uniform float grlSizeAttenuation;vec2 grlFix( vec4 i,float aspect ) {vec2 res=i.xy/i.w;res.x*=aspect;return res;}
#else
attribute vec3 grl_slopes;attribute float grl_counters;
#endif
void main() {
#include<instancesVertex>
grlColorPointer=grl_colorPointers;mat4 grlMatrix=viewProjection*finalWorld ;
#ifdef GREASED_LINE_CAMERA_FACING
float grlBaseWidth=grlWidth;vec3 grlPrevious=grl_previousAndSide.xyz;float grlSide=grl_previousAndSide.w;vec3 grlNext=grl_nextAndCounters.xyz;grlCounters=grl_nextAndCounters.w;float grlWidth=grlBaseWidth*grl_widths;vec3 positionUpdated=position+grl_offsets;vec3 worldDir=normalize(grlNext-grlPrevious);vec3 nearPosition=positionUpdated+(worldDir*0.01);vec4 grlFinalPosition=grlMatrix*vec4( positionUpdated ,1.0);vec4 screenNearPos=grlMatrix*vec4(nearPosition,1.0);vec2 grlLinePosition=grlFix(grlFinalPosition,grlAspect);vec2 grlLineNearPosition=grlFix(screenNearPos,grlAspect);vec2 grlDir=normalize(grlLineNearPosition-grlLinePosition);vec4 grlNormal=vec4( -grlDir.y,grlDir.x,0.,1. );
#ifdef GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM
grlNormal.xy*=-.5*grlWidth;
#else
grlNormal.xy*=.5*grlWidth;
#endif
grlNormal*=projection;if (grlSizeAttenuation==1.) {grlNormal.xy*=grlFinalPosition.w;grlNormal.xy/=( vec4( grlResolution,0.,1. )*projection ).xy;}
grlFinalPosition.xy+=grlNormal.xy*grlSide;gl_Position=grlFinalPosition;
#else
grlCounters=grl_counters;vec4 grlFinalPosition=grlMatrix*vec4( (position+grl_offsets)+grl_slopes*grl_widths ,1.0 ) ;gl_Position=grlFinalPosition;
#endif
}
`;S.ShadersStore[Sf]||(S.ShadersStore[Sf]=o0);const M4={name:Sf,shader:o0},F4=Object.freeze(Object.defineProperty({__proto__:null,greasedLineVertexShader:M4},Symbol.toStringTag,{value:"Module"})),vf="greasedLinePixelShader",l0=`var grlColors: texture_2d<f32>;var grlColorsSampler: sampler;uniform grlUseColors: f32;uniform grlUseDash: f32;uniform grlDashArray: f32;uniform grlDashOffset: f32;uniform grlDashRatio: f32;uniform grlVisibility: f32;uniform grlColorsWidth: f32;uniform grl_colorModeAndColorDistributionType: vec2f;uniform grlColor: vec3f;varying grlCounters: f32;varying grlColorPointer: f32;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
let grlColorMode: f32=uniforms.grl_colorModeAndColorDistributionType.x;let grlColorDistributionType: f32=uniforms.grl_colorModeAndColorDistributionType.y;var outColor=vec4(uniforms.grlColor,1.);outColor.a=step(fragmentInputs.grlCounters,uniforms.grlVisibility);if (outColor.a==0.0) {discard;}
if (uniforms.grlUseDash==1.0) {let dashPosition=(fragmentInputs.grlCounters+uniforms.grlDashOffset) % uniforms.grlDashArray;outColor.a*=ceil(dashPosition-(uniforms.grlDashArray*uniforms.grlDashRatio));if (outColor.a==0.0) {discard;}}
if (uniforms.grlUseColors==1.) {
#ifdef GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE
let grlColor: vec4f=textureSample(grlColors,grlColorsSampler,vec2f(fragmentInputs.grlCounters,0.));
#else
let lookup: vec2f=vec2(fract(fragmentInputs.grlColorPointer/uniforms.grlColorsWidth),1.0-floor(fragmentInputs.grlColorPointer/uniforms.grlColorsWidth));let grlColor: vec4f=textureSample(grlColors,grlColorsSampler,lookup);
#endif
if (grlColorMode==COLOR_MODE_SET) {outColor=grlColor;} else if (grlColorMode==COLOR_MODE_ADD) {outColor+=grlColor;} else if (grlColorMode==COLOR_MODE_MULTIPLY) {outColor*=grlColor;}}
#if !defined(PREPASS) && !defined(ORDER_INDEPENDENT_TRANSPARENCY)
fragmentOutputs.color=outColor;
#endif
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {fragmentOutputs.frontColor=vec4f(fragmentOutputs.frontColor.rgb+outColor.rgb*outColor.a*alphaMultiplier,1.0-alphaMultiplier*(1.0-outColor.a));} else {fragmentOutputs.backColor+=outColor;}
#endif
#define CUSTOM_FRAGMENT_MAIN_END
}
`;S.ShadersStoreWGSL[vf]||(S.ShadersStoreWGSL[vf]=l0);const L4={name:vf,shader:l0},w4=Object.freeze(Object.defineProperty({__proto__:null,greasedLinePixelShaderWGSL:L4},Symbol.toStringTag,{value:"Module"})),xf="greasedLineVertexShader",c0=`#include<instancesDeclaration>
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
attribute grl_widths: f32;
#ifdef GREASED_LINE_USE_OFFSETS
attribute grl_offsets: vec3f; 
#endif
attribute grl_colorPointers: f32;attribute position: vec3f;varying grlCounters: f32;varying grlColorPointer: f32;
#ifdef GREASED_LINE_CAMERA_FACING
attribute grl_nextAndCounters: vec4f;attribute grl_previousAndSide: vec4f;uniform grlResolution: vec2f;uniform grlAspect: f32;uniform grlWidth: f32;uniform grlSizeAttenuation: f32;fn grlFix(i: vec4f,aspect: f32)->vec2f {var res=i.xy/i.w;res.x*=aspect;return res;}
#else
attribute grl_slopes: vec3f;attribute grl_counters: f32;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
vertexOutputs.grlColorPointer=input.grl_colorPointers;let grlMatrix: mat4x4f=scene.viewProjection*mesh.world ;
#ifdef GREASED_LINE_CAMERA_FACING
let grlBaseWidth: f32=uniforms.grlWidth;let grlPrevious: vec3f=input.grl_previousAndSide.xyz;let grlSide: f32=input.grl_previousAndSide.w;let grlNext: vec3f=input.grl_nextAndCounters.xyz;vertexOutputs.grlCounters=input.grl_nextAndCounters.w;let grlWidth:f32=grlBaseWidth*input.grl_widths;
#ifdef GREASED_LINE_USE_OFFSETS
var grlPositionOffset: vec3f=input.grl_offsets;
#else
var grlPositionOffset=vec3f(0.);
#endif
let positionUpdated: vec3f=vertexInputs.position+grlPositionOffset;let worldDir: vec3f=normalize(grlNext-grlPrevious);let nearPosition: vec3f=positionUpdated+(worldDir*0.001);let grlFinalPosition: vec4f=grlMatrix*vec4f(positionUpdated,1.0);let screenNearPos: vec4f=grlMatrix*vec4(nearPosition,1.0);let grlLinePosition: vec2f=grlFix(grlFinalPosition,uniforms.grlAspect);let grlLineNearPosition: vec2f=grlFix(screenNearPos,uniforms.grlAspect);let grlDir: vec2f=normalize(grlLineNearPosition-grlLinePosition);var grlNormal: vec4f=vec4f(-grlDir.y,grlDir.x,0.0,1.0);let grlHalfWidth: f32=0.5*grlWidth;
#if defined(GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM)
grlNormal.x*=-grlHalfWidth;grlNormal.y*=-grlHalfWidth;
#else
grlNormal.x*=grlHalfWidth;grlNormal.y*=grlHalfWidth;
#endif
grlNormal*=scene.projection;if (uniforms.grlSizeAttenuation==1.) {grlNormal.x*=grlFinalPosition.w;grlNormal.y*=grlFinalPosition.w;let pr=vec4f(uniforms.grlResolution,0.0,1.0)*scene.projection;grlNormal.x/=pr.x;grlNormal.y/=pr.y;}
vertexOutputs.position=vec4f(grlFinalPosition.xy+grlNormal.xy*grlSide,grlFinalPosition.z,grlFinalPosition.w);
#else
vertexOutputs.grlCounters=input.grl_counters;vertexOutputs.position=grlMatrix*vec4f((vertexInputs.position+input.grl_offsets)+input.grl_slopes*input.grl_widths,1.0) ;
#endif
#define CUSTOM_VERTEX_MAIN_END
}
`;S.ShadersStoreWGSL[xf]||(S.ShadersStoreWGSL[xf]=c0);const B4={name:xf,shader:c0},V4=Object.freeze(Object.defineProperty({__proto__:null,greasedLineVertexShaderWGSL:B4},Symbol.toStringTag,{value:"Module"}));`${j._DefaultCdnUrl}`,`${j._DefaultCdnUrl}`,`${j._DefaultCdnUrl}`;`${j._DefaultCdnUrl}`;`${j._DefaultCdnUrl}`,`${j._DefaultCdnUrl}`,`${j._DefaultCdnUrl}`;let Pc=0;class zl{constructor(e,t,i,r){this.pos=e,this.normal=t,this.uv=i,this.vertColor=r}clone(){var e,t;return new zl(this.pos.clone(),this.normal.clone(),(e=this.uv)==null?void 0:e.clone(),(t=this.vertColor)==null?void 0:t.clone())}flip(){this.normal=this.normal.scale(-1)}interpolate(e,t){return new zl(x.Lerp(this.pos,e.pos,t),x.Lerp(this.normal,e.normal,t),this.uv&&e.uv?X.Lerp(this.uv,e.uv,t):void 0,this.vertColor&&e.vertColor?Te.Lerp(this.vertColor,e.vertColor,t):void 0)}}class ma{constructor(e,t){this.normal=e,this.w=t}static FromPoints(e,t,i){const r=i.subtract(e),n=t.subtract(e);if(r.lengthSquared()===0||n.lengthSquared()===0)return null;const a=x.Normalize(x.Cross(r,n));return new ma(a,x.Dot(a,e))}clone(){return new ma(this.normal.clone(),this.w)}flip(){this.normal.scaleInPlace(-1),this.w=-this.w}splitPolygon(e,t,i,r,n){let u=0;const h=[];let d,f;for(d=0;d<e.vertices.length;d++){f=x.Dot(this.normal,e.vertices[d].pos)-this.w;const m=f<-ma.EPSILON?2:f>ma.EPSILON?1:0;u|=m,h.push(m)}switch(u){case 0:(x.Dot(this.normal,e.plane.normal)>0?t:i).push(e);break;case 1:r.push(e);break;case 2:n.push(e);break;case 3:{const m=[],g=[];for(d=0;d<e.vertices.length;d++){const E=(d+1)%e.vertices.length,T=h[d],C=h[E],A=e.vertices[d],I=e.vertices[E];if(T!==2&&m.push(A),T!==1&&g.push(T!==2?A.clone():A),(T|C)===3){f=(this.w-x.Dot(this.normal,A.pos))/x.Dot(this.normal,I.pos.subtract(A.pos));const F=A.interpolate(I,f);m.push(F),g.push(F.clone())}}let v;m.length>=3&&(v=new Oo(m,e.shared),v.plane&&r.push(v)),g.length>=3&&(v=new Oo(g,e.shared),v.plane&&n.push(v));break}}}}ma.EPSILON=1e-5;class Oo{constructor(e,t){this.vertices=e,this.shared=t,this.plane=ma.FromPoints(e[0].pos,e[1].pos,e[2].pos)}clone(){const e=this.vertices.map(t=>t.clone());return new Oo(e,this.shared)}flip(){this.vertices.reverse().map(e=>{e.flip()}),this.plane.flip()}}let Xr=class $c{constructor(e){this._plane=null,this._front=null,this._back=null,this._polygons=new Array,e&&this.build(e)}clone(){const e=new $c;return e._plane=this._plane&&this._plane.clone(),e._front=this._front&&this._front.clone(),e._back=this._back&&this._back.clone(),e._polygons=this._polygons.map(t=>t.clone()),e}invert(){for(let t=0;t<this._polygons.length;t++)this._polygons[t].flip();this._plane&&this._plane.flip(),this._front&&this._front.invert(),this._back&&this._back.invert();const e=this._front;this._front=this._back,this._back=e}clipPolygons(e){if(!this._plane)return e.slice();let t=[],i=[];for(let r=0;r<e.length;r++)this._plane.splitPolygon(e[r],t,i,t,i);return this._front&&(t=this._front.clipPolygons(t)),this._back?i=this._back.clipPolygons(i):i=[],t.concat(i)}clipTo(e){this._polygons=e.clipPolygons(this._polygons),this._front&&this._front.clipTo(e),this._back&&this._back.clipTo(e)}allPolygons(){let e=this._polygons.slice();return this._front&&(e=e.concat(this._front.allPolygons())),this._back&&(e=e.concat(this._back.allPolygons())),e}build(e){if(!e.length)return;this._plane||(this._plane=e[0].plane.clone());const t=[],i=[];for(let r=0;r<e.length;r++)this._plane.splitPolygon(e[r],this._polygons,this._polygons,t,i);t.length&&(this._front||(this._front=new $c),this._front.build(t)),i.length&&(this._back||(this._back=new $c),this._back.build(i))}};class As{constructor(){this._polygons=new Array}static FromVertexData(e){let t,i,r;const n=[],a=e.indices,o=e.positions,l=e.normals,c=e.uvs,u=e.colors;if(!a||!o)throw"BABYLON.CSG: VertexData must at least contain positions and indices";for(let d=0;d<a.length;d+=3){r=[];for(let f=0;f<3;f++){const m=d+f,g=a[m],v=l?x.FromArray(l,g*3):x.Zero(),E=c?X.FromArray(c,g*2):void 0,T=u?Te.FromArray(u,g*4):void 0,C=x.FromArray(o,g*3);t=new zl(C,v,E,T),r.push(t)}i=new Oo(r,{subMeshId:0,meshId:Pc,materialIndex:0}),i.plane&&n.push(i)}const h=As._FromPolygons(n);return h.matrix=z.Identity(),h.position=x.Zero(),h.rotation=x.Zero(),h.scaling=x.One(),h.rotationQuaternion=Z.Identity(),Pc++,h}static FromMesh(e,t=!1){let i,r,n,a,o,l,c;const u=[];let h,d,f,m=null,g,v=!1;if(e instanceof Oe)e.computeWorldMatrix(!0),h=e.getWorldMatrix(),d=e.position.clone(),f=e.rotation.clone(),e.rotationQuaternion&&(m=e.rotationQuaternion.clone()),g=e.scaling.clone(),e.material&&t&&(v=e.material.sideOrientation===0);else throw"BABYLON.CSG: Wrong Mesh type, must be BABYLON.Mesh";const E=e.getIndices(),T=e.getVerticesData(M.PositionKind),C=e.getVerticesData(M.NormalKind),A=e.getVerticesData(M.UVKind),I=e.getVerticesData(M.ColorKind);if(E===null)throw"BABYLON.CSG: Mesh has no indices";if(T===null)throw"BABYLON.CSG: Mesh has no positions";if(C===null)throw"BABYLON.CSG: Mesh has no normals";const F=e.subMeshes;if(!F)throw"BABYLON.CSG: Mesh has no submeshes";for(let D=0,w=F.length;D<w;D++)for(let B=F[D].indexStart,Q=F[D].indexCount+F[D].indexStart;B<Q;B+=3){c=[];for(let J=0;J<3;J++){const re=J===0?B+J:v?B+3-J:B+J,ne=new x(C[E[re]*3],C[E[re]*3+1],C[E[re]*3+2]);A&&(n=new X(A[E[re]*2],A[E[re]*2+1])),I&&(o=new Te(I[E[re]*4],I[E[re]*4+1],I[E[re]*4+2],I[E[re]*4+3]));const fe=new x(T[E[re]*3],T[E[re]*3+1],T[E[re]*3+2]);a=x.TransformCoordinates(fe,h),r=x.TransformNormal(ne,h),i=new zl(a,r,n,o),c.push(i)}l=new Oo(c,{subMeshId:D,meshId:Pc,materialIndex:F[D].materialIndex}),l.plane&&u.push(l)}const V=As._FromPolygons(u);return V.matrix=t?z.Identity():h,V.position=t?x.Zero():d,V.rotation=t?x.Zero():f,V.scaling=t?x.One():g,V.rotationQuaternion=t&&m?Z.Identity():m,Pc++,V}static _FromPolygons(e){const t=new As;return t._polygons=e,t}clone(){const e=new As;return e._polygons=this._polygons.map(t=>t.clone()),e.copyTransformAttributes(this),e}union(e){const t=new Xr(this.clone()._polygons),i=new Xr(e.clone()._polygons);return t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),As._FromPolygons(t.allPolygons()).copyTransformAttributes(this)}unionInPlace(e){const t=new Xr(this._polygons),i=new Xr(e._polygons);t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),this._polygons=t.allPolygons()}subtract(e){const t=new Xr(this.clone()._polygons),i=new Xr(e.clone()._polygons);return t.invert(),t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),t.invert(),As._FromPolygons(t.allPolygons()).copyTransformAttributes(this)}subtractInPlace(e){const t=new Xr(this._polygons),i=new Xr(e._polygons);t.invert(),t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),t.invert(),this._polygons=t.allPolygons()}intersect(e){const t=new Xr(this.clone()._polygons),i=new Xr(e.clone()._polygons);return t.invert(),i.clipTo(t),i.invert(),t.clipTo(i),i.clipTo(t),t.build(i.allPolygons()),t.invert(),As._FromPolygons(t.allPolygons()).copyTransformAttributes(this)}intersectInPlace(e){const t=new Xr(this._polygons),i=new Xr(e._polygons);t.invert(),i.clipTo(t),i.invert(),t.clipTo(i),i.clipTo(t),t.build(i.allPolygons()),t.invert(),this._polygons=t.allPolygons()}inverse(){const e=this.clone();return e.inverseInPlace(),e}inverseInPlace(){this._polygons.map(e=>{e.flip()})}copyTransformAttributes(e){return this.matrix=e.matrix,this.position=e.position,this.rotation=e.rotation,this.scaling=e.scaling,this.rotationQuaternion=e.rotationQuaternion,this}toVertexData(e=null,t=null){const i=this.matrix.clone();i.invert();const r=this._polygons,n=[],a=[],o=[];let l=null,c=null;const u=x.Zero(),h=x.Zero(),d=X.Zero(),f=new Te(0,0,0,0),m=[0,0,0],g={};let v;for(let T=0,C=r.length;T<C;T++){const A=r[T];e&&e(A);for(let I=2,F=A.vertices.length;I<F;I++){m[0]=0,m[1]=I-1,m[2]=I;for(let V=0;V<3;V++){u.copyFrom(A.vertices[m[V]].pos),h.copyFrom(A.vertices[m[V]].normal),A.vertices[m[V]].uv&&(l||(l=[]),d.copyFrom(A.vertices[m[V]].uv)),A.vertices[m[V]].vertColor&&(c||(c=[]),f.copyFrom(A.vertices[m[V]].vertColor));const D=x.TransformCoordinates(u,i),w=x.TransformNormal(h,i);v=g[D.x+","+D.y+","+D.z];let B=!1;l&&!(l[v*2]===d.x||l[v*2+1]===d.y)&&(B=!0);let Q=!1;c&&!(c[v*4]===f.r||c[v*4+1]===f.g||c[v*4+2]===f.b||c[v*4+3]===f.a)&&(Q=!0),(!(typeof v<"u"&&o[v*3]===w.x&&o[v*3+1]===w.y&&o[v*3+2]===w.z)||B||Q)&&(n.push(D.x,D.y,D.z),l&&l.push(d.x,d.y),o.push(h.x,h.y,h.z),c&&c.push(f.r,f.g,f.b,f.a),v=g[D.x+","+D.y+","+D.z]=n.length/3-1),a.push(v),t&&t()}}}const E=new li;return E.positions=n,E.normals=o,l&&(E.uvs=l),c&&(E.colors=c),E.indices=a,E}buildMeshGeometry(e,t,i){const r=new Oe(e,t),n=this._polygons;let a=0;const o={};let l;if(i&&n.sort((u,h)=>u.shared.meshId===h.shared.meshId?u.shared.subMeshId-h.shared.subMeshId:u.shared.meshId-h.shared.meshId),this.toVertexData(u=>{o[u.shared.meshId]||(o[u.shared.meshId]={}),o[u.shared.meshId][u.shared.subMeshId]||(o[u.shared.meshId][u.shared.subMeshId]={indexStart:1/0,indexEnd:-1/0,materialIndex:u.shared.materialIndex}),l=o[u.shared.meshId][u.shared.subMeshId]},()=>{l.indexStart=Math.min(a,l.indexStart),l.indexEnd=Math.max(a,l.indexEnd),a++}).applyToMesh(r),i){let u=0,h;r.subMeshes=[];for(const d in o){h=-1;for(const f in o[d])l=o[d][f],Yn.CreateFromIndices(l.materialIndex+u,l.indexStart,l.indexEnd-l.indexStart+1,r),h=Math.max(l.materialIndex,h);u+=++h}}return r}toMesh(e,t=null,i,r){const n=this.buildMeshGeometry(e,i,r);return n.material=t,n.position.copyFrom(this.position),n.rotation.copyFrom(this.rotation),this.rotationQuaternion&&(n.rotationQuaternion=this.rotationQuaternion.clone()),n.scaling.copyFrom(this.scaling),n.computeWorldMatrix(!0),n}}Oe._TrailMeshParser=(s,e)=>hu.Parse(s,e);class hu extends Oe{constructor(e,t,i,r,n=60,a=!0){super(e,i),this._sectionPolygonPointsCount=4,this._running=!1,this._generator=t,typeof r=="object"&&r!==null?(this.diameter=r.diameter||1,this._length=r.length||60,this._segments=r.segments?r.segments>this._length?this._length:r.segments:this._length,this._sectionPolygonPointsCount=r.sections||4,this._doNotTaper=r.doNotTaper??!1,this._autoStart=r.autoStart??!0):(this.diameter=r||1,this._length=n,this._segments=this._length,this._doNotTaper=!1,this._autoStart=a),this._sectionVectors=[],this._sectionNormalVectors=[];for(let o=0;o<=this._sectionPolygonPointsCount;o++)this._sectionVectors[o]=x.Zero(),this._sectionNormalVectors[o]=x.Zero();this._createMesh()}getClassName(){return"TrailMesh"}_createMesh(){const e=new li,t=[],i=[],r=[],n=[];let a=x.Zero();this._generator instanceof Mt&&this._generator.hasBoundingInfo?a=this._generator.getBoundingInfo().boundingBox.centerWorld:a=this._generator.absolutePosition;const o=2*Math.PI/this._sectionPolygonPointsCount;for(let l=0;l<=this._sectionPolygonPointsCount;l++){const c=l!==this._sectionPolygonPointsCount?l*o:0;t.push(a.x+Math.cos(c)*this.diameter,a.y+Math.sin(c)*this.diameter,a.z),n.push(l/this._sectionPolygonPointsCount,0)}for(let l=1;l<=this._segments;l++){for(let u=0;u<=this._sectionPolygonPointsCount;u++){const h=u!==this._sectionPolygonPointsCount?u*o:0;t.push(a.x+Math.cos(h)*this.diameter,a.y+Math.sin(h)*this.diameter,a.z),n.push(u/this._sectionPolygonPointsCount,l/this._segments)}const c=t.length/3-2*(this._sectionPolygonPointsCount+1);for(let u=0;u<=this._sectionPolygonPointsCount;u++)r.push(c+u,c+u+this._sectionPolygonPointsCount,c+u+this._sectionPolygonPointsCount+1),r.push(c+u,c+u+this._sectionPolygonPointsCount+1,c+u+1)}li.ComputeNormals(t,r,i),e.positions=t,e.normals=i,e.indices=r,e.uvs=n,e.applyToMesh(this,!0),this._autoStart&&this.start()}_updateSectionVectors(){const e=this._generator.getWorldMatrix(),t=2*Math.PI/this._sectionPolygonPointsCount;for(let i=0;i<=this._sectionPolygonPointsCount;i++){const r=i!==this._sectionPolygonPointsCount?i*t:0;this._sectionVectors[i].copyFromFloats(Math.cos(r)*this.diameter,Math.sin(r)*this.diameter,0),this._sectionNormalVectors[i].copyFromFloats(Math.cos(r),Math.sin(r),0),x.TransformCoordinatesToRef(this._sectionVectors[i],e,this._sectionVectors[i]),x.TransformNormalToRef(this._sectionNormalVectors[i],e,this._sectionNormalVectors[i])}}start(){this._running||(this._running=!0,this._beforeRenderObserver=this.getScene().onBeforeRenderObservable.add(()=>{this.update()}))}stop(){this._beforeRenderObserver&&this._running&&(this._running=!1,this.getScene().onBeforeRenderObservable.remove(this._beforeRenderObserver))}update(){const e=this.getVerticesData(M.PositionKind),t=this.getVerticesData(M.NormalKind),i=3*(this._sectionPolygonPointsCount+1);if(e&&t){if(this._doNotTaper)for(let n=i;n<e.length;n++)e[n-i]=Vc(e[n-i],e[n],this._segments/this._length);else for(let n=i;n<e.length;n++)e[n-i]=Vc(e[n-i],e[n],this._segments/this._length)-t[n]/this._length*this.diameter;for(let n=i;n<t.length;n++)t[n-i]=Vc(t[n-i],t[n],this._segments/this._length);this._updateSectionVectors();const r=e.length-3*(this._sectionPolygonPointsCount+1);for(let n=0;n<=this._sectionPolygonPointsCount;n++)e[r+3*n]=this._sectionVectors[n].x,e[r+3*n+1]=this._sectionVectors[n].y,e[r+3*n+2]=this._sectionVectors[n].z,t[r+3*n]=this._sectionNormalVectors[n].x,t[r+3*n+1]=this._sectionNormalVectors[n].y,t[r+3*n+2]=this._sectionNormalVectors[n].z;this.updateVerticesData(M.PositionKind,e,!0,!1),this.updateVerticesData(M.NormalKind,t,!0,!1)}}reset(){const e=this.getVerticesData(M.PositionKind),t=this.getVerticesData(M.NormalKind);if(e&&t){this._updateSectionVectors();for(let i=0;i<=this._segments;i++){const r=3*i*(this._sectionPolygonPointsCount+1);for(let n=0;n<=this._sectionPolygonPointsCount;n++)e[r+3*n]=this._sectionVectors[n].x,e[r+3*n+1]=this._sectionVectors[n].y,e[r+3*n+2]=this._sectionVectors[n].z,t[r+3*n]=this._sectionNormalVectors[n].x,t[r+3*n+1]=this._sectionNormalVectors[n].y,t[r+3*n+2]=this._sectionNormalVectors[n].z}this.updateVerticesData(M.PositionKind,e,!0,!1),this.updateVerticesData(M.NormalKind,t,!0,!1)}}clone(e="",t){const i={diameter:this.diameter,length:this._length,segments:this._segments,sections:this._sectionPolygonPointsCount,doNotTaper:this._doNotTaper,autoStart:this._autoStart};return new hu(e,t??this._generator,this.getScene(),i)}serialize(e){super.serialize(e),e.generatorId=this._generator.id}static Parse(e,t){const i=t.getLastMeshById(e.generatorId)??t.getLastTransformNodeById(e.generatorId);if(!i)throw new Error("TrailMesh: generator not found with ID "+e.generatorId);const r={diameter:e.diameter??e._diameter,length:e._length,segments:e._segments,sections:e._sectionPolygonPointsCount,doNotTaper:e._doNotTaper,autoStart:e._autoStart};return new hu(e.name,i,t,r)}}class U4{constructor(){this.running=!1,this._simplificationArray=[]}addTask(e){this._simplificationArray.push(e)}executeNext(){const e=this._simplificationArray.pop();e?(this.running=!0,this.runSimplification(e)):this.running=!1}runSimplification(e){if(e.parallelProcessing)for(const t of e.settings)this._getSimplifier(e).simplify(t,r=>{t.distance!==void 0&&e.mesh.addLODLevel(t.distance,r),r.isVisible=!0,t.quality===e.settings[e.settings.length-1].quality&&e.successCallback&&e.successCallback(),this.executeNext()});else{const t=this._getSimplifier(e),i=(r,n)=>{t.simplify(r,a=>{r.distance!==void 0&&e.mesh.addLODLevel(r.distance,a),a.isVisible=!0,n()})};An.Run(e.settings.length,r=>{i(e.settings[r.index],()=>{r.executeNext()})},()=>{e.successCallback&&e.successCallback(),this.executeNext()})}}_getSimplifier(e){switch(e.simplificationType){case 0:default:return new W4(e.mesh)}}}var GT;(function(s){s[s.QUADRATIC=0]="QUADRATIC"})(GT||(GT={}));class k4{constructor(e){this._vertices=e,this.error=new Array(4),this.deleted=!1,this.isDirty=!1,this.deletePending=!1,this.borderFactor=0}}class G4{constructor(e,t){this.position=e,this.id=t,this.isBorder=!0,this.q=new mo,this.triangleCount=0,this.triangleStart=0,this.originalOffsets=[]}updatePosition(e){this.position.copyFrom(e)}}class mo{constructor(e){this.data=new Array(10);for(let t=0;t<10;++t)e&&e[t]?this.data[t]=e[t]:this.data[t]=0}det(e,t,i,r,n,a,o,l,c){return this.data[e]*this.data[n]*this.data[c]+this.data[i]*this.data[r]*this.data[l]+this.data[t]*this.data[a]*this.data[o]-this.data[i]*this.data[n]*this.data[o]-this.data[e]*this.data[a]*this.data[l]-this.data[t]*this.data[r]*this.data[c]}addInPlace(e){for(let t=0;t<10;++t)this.data[t]+=e.data[t]}addArrayInPlace(e){for(let t=0;t<10;++t)this.data[t]+=e[t]}add(e){const t=new mo;for(let i=0;i<10;++i)t.data[i]=this.data[i]+e.data[i];return t}static FromData(e,t,i,r){return new mo(mo.DataFromNumbers(e,t,i,r))}static DataFromNumbers(e,t,i,r){return[e*e,e*t,e*i,e*r,t*t,t*i,t*r,i*i,i*r,r*r]}}class z4{constructor(e,t){this.vertexId=e,this.triangleId=t}}class W4{constructor(e){this._mesh=e,this.syncIterations=5e3,this.aggressiveness=7,this.decimationIterations=100,this.boundingBoxEpsilon=Ai}simplify(e,t){this._initDecimatedMesh(),An.Run(this._mesh.subMeshes.length,i=>{this._initWithMesh(i.index,()=>{this._runDecimation(e,i.index,()=>{i.executeNext()})},e.optimizeMesh)},()=>{setTimeout(()=>{t(this._reconstructedMesh)},0)})}_runDecimation(e,t,i){const r=~~(this._triangles.length*e.quality);let n=0;const a=this._triangles.length,o=(l,c)=>{setTimeout(()=>{l%5===0&&this._updateMesh(l===0);for(let d=0;d<this._triangles.length;++d)this._triangles[d].isDirty=!1;const u=1e-9*Math.pow(l+3,this.aggressiveness),h=d=>{const f=~~((this._triangles.length/2+d)%this._triangles.length),m=this._triangles[f];if(m&&!(m.error[3]>u||m.deleted||m.isDirty)){for(let g=0;g<3;++g)if(m.error[g]<u){const v=[],E=[],T=m._vertices[g],C=m._vertices[(g+1)%3];if(T.isBorder||C.isBorder)continue;const A=x.Zero();this._calculateError(T,C,A);const I=[];if(this._isFlipped(T,C,A,v,I)||this._isFlipped(C,T,A,E,I)||v.indexOf(!0)<0||E.indexOf(!0)<0)continue;const F=[];for(const w of I)F.indexOf(w)===-1&&(w.deletePending=!0,F.push(w));if(F.length%2!==0)continue;T.q=C.q.add(T.q),T.updatePosition(A);const V=this._references.length;n=this._updateTriangles(T,T,v,n),n=this._updateTriangles(T,C,E,n);const D=this._references.length-V;if(D<=T.triangleCount){if(D)for(let w=0;w<D;w++)this._references[T.triangleStart+w]=this._references[V+w]}else T.triangleStart=V;T.triangleCount=D;break}}};An.SyncAsyncForLoop(this._triangles.length,this.syncIterations,h,c,()=>a-n<=r)},0)};An.Run(this.decimationIterations,l=>{a-n<=r?l.breakLoop():o(l.index,()=>{l.executeNext()})},()=>{setTimeout(()=>{this._reconstructMesh(t),i()},0)})}_initWithMesh(e,t,i){this._vertices=[],this._triangles=[];const r=this._mesh.getVerticesData(M.PositionKind),n=this._mesh.getIndices(),a=this._mesh.subMeshes[e],o=h=>{if(i){for(let d=0;d<this._vertices.length;++d)if(this._vertices[d].position.equalsWithEpsilon(h,1e-4))return this._vertices[d]}return null},l=[],c=h=>{if(!r)return;const d=h+a.verticesStart,f=x.FromArray(r,d*3),m=o(f)||new G4(f,this._vertices.length);m.originalOffsets.push(d),m.id===this._vertices.length&&this._vertices.push(m),l.push(m.id)},u=a.verticesCount;An.SyncAsyncForLoop(u,this.syncIterations/4>>0,c,()=>{const h=d=>{if(!n)return;const m=(a.indexStart/3+d)*3,g=n[m+0],v=n[m+1],E=n[m+2],T=this._vertices[l[g-a.verticesStart]],C=this._vertices[l[v-a.verticesStart]],A=this._vertices[l[E-a.verticesStart]],I=new k4([T,C,A]);I.originalOffset=m,this._triangles.push(I)};An.SyncAsyncForLoop(a.indexCount/3,this.syncIterations,h,()=>{this._init(t)})})}_init(e){const t=i=>{const r=this._triangles[i];r.normal=x.Cross(r._vertices[1].position.subtract(r._vertices[0].position),r._vertices[2].position.subtract(r._vertices[0].position)).normalize();for(let n=0;n<3;n++)r._vertices[n].q.addArrayInPlace(mo.DataFromNumbers(r.normal.x,r.normal.y,r.normal.z,-x.Dot(r.normal,r._vertices[0].position)))};An.SyncAsyncForLoop(this._triangles.length,this.syncIterations,t,()=>{const i=r=>{const n=this._triangles[r];for(let a=0;a<3;++a)n.error[a]=this._calculateError(n._vertices[a],n._vertices[(a+1)%3]);n.error[3]=Math.min(n.error[0],n.error[1],n.error[2])};An.SyncAsyncForLoop(this._triangles.length,this.syncIterations,i,()=>{e()})})}_reconstructMesh(e){const t=[];let i;for(i=0;i<this._vertices.length;++i)this._vertices[i].triangleCount=0;let r,n;for(i=0;i<this._triangles.length;++i)if(!this._triangles[i].deleted){for(r=this._triangles[i],n=0;n<3;++n)r._vertices[n].triangleCount=1;t.push(r)}const a=this._reconstructedMesh.getVerticesData(M.PositionKind)||[],o=this._reconstructedMesh.getVerticesData(M.NormalKind)||[],l=this._reconstructedMesh.getVerticesData(M.UVKind)||[],c=this._reconstructedMesh.getVerticesData(M.ColorKind)||[],u=this._mesh.getVerticesData(M.NormalKind),h=this._mesh.getVerticesData(M.UVKind),d=this._mesh.getVerticesData(M.ColorKind);let f=0;for(i=0;i<this._vertices.length;++i){const A=this._vertices[i];if(A.id=f,A.triangleCount)for(const I of A.originalOffsets)a.push(A.position.x),a.push(A.position.y),a.push(A.position.z),u&&u.length&&(o.push(u[I*3]),o.push(u[I*3+1]),o.push(u[I*3+2])),h&&h.length&&(l.push(h[I*2]),l.push(h[I*2+1])),d&&d.length&&(c.push(d[I*4]),c.push(d[I*4+1]),c.push(d[I*4+2]),c.push(d[I*4+3])),++f}const m=this._reconstructedMesh.getTotalIndices(),g=this._reconstructedMesh.getTotalVertices(),v=this._reconstructedMesh.subMeshes;this._reconstructedMesh.subMeshes=[];const E=this._reconstructedMesh.getIndices(),T=this._mesh.getIndices();for(i=0;i<t.length;++i){r=t[i];for(let A=0;A<3;++A){const I=T[r.originalOffset+A];let F=r._vertices[A].originalOffsets.indexOf(I);F<0&&(F=0),E.push(r._vertices[A].id+F+g)}}this._reconstructedMesh.setIndices(E),this._reconstructedMesh.setVerticesData(M.PositionKind,a),o.length>0&&this._reconstructedMesh.setVerticesData(M.NormalKind,o),l.length>0&&this._reconstructedMesh.setVerticesData(M.UVKind,l),c.length>0&&this._reconstructedMesh.setVerticesData(M.ColorKind,c);const C=this._mesh.subMeshes[e];if(e>0){this._reconstructedMesh.subMeshes=[];for(const A of v)Yn.AddToMesh(A.materialIndex,A.verticesStart,A.verticesCount,A.indexStart,A.indexCount,A.getMesh());Yn.AddToMesh(C.materialIndex,g,f,m,t.length*3,this._reconstructedMesh)}}_initDecimatedMesh(){this._reconstructedMesh=new Oe(this._mesh.name+"Decimated",this._mesh.getScene()),this._reconstructedMesh.material=this._mesh.material,this._reconstructedMesh.parent=this._mesh.parent,this._reconstructedMesh.isVisible=!1,this._reconstructedMesh.renderingGroupId=this._mesh.renderingGroupId}_isFlipped(e,t,i,r,n){for(let a=0;a<e.triangleCount;++a){const o=this._triangles[this._references[e.triangleStart+a].triangleId];if(o.deleted)continue;const l=this._references[e.triangleStart+a].vertexId,c=o._vertices[(l+1)%3],u=o._vertices[(l+2)%3];if(c===t||u===t){r[a]=!0,n.push(o);continue}let h=c.position.subtract(i);h=h.normalize();let d=u.position.subtract(i);if(d=d.normalize(),Math.abs(x.Dot(h,d))>.999)return!0;const f=x.Cross(h,d).normalize();if(r[a]=!1,x.Dot(f,o.normal)<.2)return!0}return!1}_updateTriangles(e,t,i,r){let n=r;for(let a=0;a<t.triangleCount;++a){const o=this._references[t.triangleStart+a],l=this._triangles[o.triangleId];if(!l.deleted){if(i[a]&&l.deletePending){l.deleted=!0,n++;continue}l._vertices[o.vertexId]=e,l.isDirty=!0,l.error[0]=this._calculateError(l._vertices[0],l._vertices[1])+l.borderFactor/2,l.error[1]=this._calculateError(l._vertices[1],l._vertices[2])+l.borderFactor/2,l.error[2]=this._calculateError(l._vertices[2],l._vertices[0])+l.borderFactor/2,l.error[3]=Math.min(l.error[0],l.error[1],l.error[2]),this._references.push(o)}}return n}_identifyBorder(){for(let e=0;e<this._vertices.length;++e){const t=[],i=[],r=this._vertices[e];let n;for(n=0;n<r.triangleCount;++n){const a=this._triangles[this._references[r.triangleStart+n].triangleId];for(let o=0;o<3;o++){let l=0;const c=a._vertices[o];for(;l<t.length&&i[l]!==c.id;)++l;l===t.length?(t.push(1),i.push(c.id)):t[l]++}}for(n=0;n<t.length;++n)t[n]===1?this._vertices[i[n]].isBorder=!0:this._vertices[i[n]].isBorder=!1}}_updateMesh(e=!1){let t;if(!e){const l=[];for(t=0;t<this._triangles.length;++t)this._triangles[t].deleted||l.push(this._triangles[t]);this._triangles=l}for(t=0;t<this._vertices.length;++t)this._vertices[t].triangleCount=0,this._vertices[t].triangleStart=0;let i,r,n;for(t=0;t<this._triangles.length;++t)for(i=this._triangles[t],r=0;r<3;++r)n=i._vertices[r],n.triangleCount++;let a=0;for(t=0;t<this._vertices.length;++t)this._vertices[t].triangleStart=a,a+=this._vertices[t].triangleCount,this._vertices[t].triangleCount=0;const o=new Array(this._triangles.length*3);for(t=0;t<this._triangles.length;++t)for(i=this._triangles[t],r=0;r<3;++r)n=i._vertices[r],o[n.triangleStart+n.triangleCount]=new z4(r,t),n.triangleCount++;this._references=o,e&&this._identifyBorder()}_vertexError(e,t){const i=t.x,r=t.y,n=t.z;return e.data[0]*i*i+2*e.data[1]*i*r+2*e.data[2]*i*n+2*e.data[3]*i+e.data[4]*r*r+2*e.data[5]*r*n+2*e.data[6]*r+e.data[7]*n*n+2*e.data[8]*n+e.data[9]}_calculateError(e,t,i){const r=e.q.add(t.q),n=e.isBorder&&t.isBorder;let a=0;const o=r.det(0,1,2,1,4,5,2,5,7);if(o!==0&&!n)i||(i=x.Zero()),i.x=-1/o*r.det(1,2,3,4,5,6,5,7,8),i.y=1/o*r.det(0,2,3,1,5,6,2,7,8),i.z=-1/o*r.det(0,1,3,1,4,6,2,5,8),a=this._vertexError(r,i);else{const l=e.position.add(t.position).divide(new x(2,2,2)),c=this._vertexError(r,e.position),u=this._vertexError(r,t.position),h=this._vertexError(r,l);a=Math.min(c,u,h),a===c?i&&i.copyFrom(e.position):a===u?i&&i.copyFrom(t.position):i&&i.copyFrom(l)}return a}}Object.defineProperty(le.prototype,"simplificationQueue",{get:function(){if(!this._simplificationQueue){this._simplificationQueue=new U4;let s=this._getComponent(se.NAME_SIMPLIFICATIONQUEUE);s||(s=new H4(this),this._addComponent(s))}return this._simplificationQueue},set:function(s){this._simplificationQueue=s},enumerable:!0,configurable:!0});Oe.prototype.simplify=function(s,e=!0,t=0,i){return this.getScene().simplificationQueue.addTask({settings:s,parallelProcessing:e,mesh:this,simplificationType:t,successCallback:i}),this};class H4{constructor(e){this.name=se.NAME_SIMPLIFICATIONQUEUE,this.scene=e}register(){this.scene._beforeCameraUpdateStage.registerStep(se.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE,this,this._beforeCameraUpdate)}rebuild(){}dispose(){}_beforeCameraUpdate(){this.scene._simplificationQueue&&!this.scene._simplificationQueue.running&&this.scene._simplificationQueue.executeNext()}}class $4{getClassName(){return"Lattice"}get resolutionX(){return this._resolutionX}get resolutionY(){return this._resolutionY}get resolutionZ(){return this._resolutionZ}get size(){return this._size}get position(){return this._position}get data(){return this._data}get cellSize(){return this._cellSize}get min(){return this._min}get max(){return this._max}constructor(e){this._cellSize=new x,this._min=new x(-.5,-.5,-.5),this._max=new x(.5,.5,.5),this._localPos=new x,this._tmpVector=new x,this._lerpVector0=new x,this._lerpVector1=new x,this._lerpVector2=new x,this._lerpVector3=new x,this._lerpVector4=new x,this._lerpVector5=new x;const t={resolutionX:3,resolutionY:3,resolutionZ:3,position:x.Zero(),size:x.One(),...e};this._resolutionX=t.resolutionX,this._resolutionY=t.resolutionY,this._resolutionZ=t.resolutionZ,this._position=t.position,this._size=t.autoAdaptToMesh?t.autoAdaptToMesh.getBoundingInfo().boundingBox.extendSize.scale(2):t.size,this._allocateData(),this.update()}_allocateData(){this._data=new Array(this.resolutionX);for(let e=0;e<this.resolutionX;e++){this._data[e]=new Array(this.resolutionY);for(let t=0;t<this.resolutionY;t++){this._data[e][t]=new Array(this.resolutionZ);for(let i=0;i<this.resolutionZ;i++)this._data[e][t][i]=x.Zero()}}}update(){for(let e=0;e<this.resolutionX;e++)for(let t=0;t<this.resolutionY;t++)for(let i=0;i<this.resolutionZ;i++){const r=-this.size.x/2+this.size.x*(e/(this.resolutionX-1)),n=-this.size.y/2+this.size.y*(t/(this.resolutionY-1)),a=-this.size.z/2+this.size.z*(i/(this.resolutionZ-1));this._data[e][t][i].set(r,n,a)}}deformMesh(e){const t=e.getVerticesData(M.PositionKind);t&&(this.deform(t),e.setVerticesData(M.PositionKind,t,!0))}updateInternals(){const e=this._resolutionX,t=this._resolutionY,i=this._resolutionZ;this._cellSize.set(this.size.x/(e-1),this.size.y/(t-1),this.size.z/(i-1)),this._min.set(this.position.x-this.size.x/2,this.position.y-this.size.y/2,this.position.z-this.size.z/2),this._min.addToRef(this._size,this._max)}deform(e,t){const i=this._resolutionX,r=this._resolutionY,n=this._resolutionZ;this.updateInternals();const a=this._min,o=this._max;for(let l=0;l<e.length;l+=3){const c=this._tmpVector.fromArray(e,l);if(Gh(c.x,a.x,o.x,Ai)||Gh(c.y,a.y,o.y,Ai)||Gh(c.z,a.z,o.z,Ai)){t&&c.toArray(t,l);continue}const u=this._localPos.set((c.x-a.x)/this._cellSize.x,(c.y-a.y)/this._cellSize.y,(c.z-a.z)/this._cellSize.z),h=Math.floor(u.x),d=Math.floor(u.y),f=Math.floor(u.z),m=Math.min(h+1,i-1),g=Math.min(d+1,r-1),v=Math.min(f+1,n-1),E=u.x-h,T=u.y-d,C=u.z-f,A=ls(h,0,i-1),I=ls(d,0,r-1),F=ls(f,0,n-1),V=ls(m,0,i-1),D=ls(g,0,r-1),w=ls(v,0,n-1),B=this._data[A][I][F],Q=this._data[V][I][F],J=this._data[A][D][F],re=this._data[V][D][F],ne=this._data[A][I][w],fe=this._data[V][I][w],be=this._data[A][D][w],Me=this._data[V][D][w],ce=x.LerpToRef(B,Q,E,this._lerpVector0),bt=x.LerpToRef(ne,fe,E,this._lerpVector1),Pt=x.LerpToRef(J,re,E,this._lerpVector2),Yt=x.LerpToRef(be,Me,E,this._lerpVector3),mt=x.LerpToRef(ce,Pt,T,this._lerpVector4),Ot=x.LerpToRef(bt,Yt,T,this._lerpVector5),Wi=x.LerpToRef(mt,Ot,C,this._lerpVector0);Wi.addInPlace(this.position),Wi.toArray(t||e,l)}}}var zT;(function(s){s[s.POINTS_MODE_POINTS=0]="POINTS_MODE_POINTS",s[s.POINTS_MODE_PATHS=1]="POINTS_MODE_PATHS"})(zT||(zT={}));var WT;(function(s){s[s.FACES_MODE_SINGLE_SIDED=0]="FACES_MODE_SINGLE_SIDED",s[s.FACES_MODE_SINGLE_SIDED_NO_BACKFACE_CULLING=1]="FACES_MODE_SINGLE_SIDED_NO_BACKFACE_CULLING",s[s.FACES_MODE_DOUBLE_SIDED=2]="FACES_MODE_DOUBLE_SIDED"})(WT||(WT={}));var HT;(function(s){s[s.AUTO_DIRECTIONS_FROM_FIRST_SEGMENT=0]="AUTO_DIRECTIONS_FROM_FIRST_SEGMENT",s[s.AUTO_DIRECTIONS_FROM_ALL_SEGMENTS=1]="AUTO_DIRECTIONS_FROM_ALL_SEGMENTS",s[s.AUTO_DIRECTIONS_ENHANCED=2]="AUTO_DIRECTIONS_ENHANCED",s[s.AUTO_DIRECTIONS_FACE_TO=3]="AUTO_DIRECTIONS_FACE_TO",s[s.AUTO_DIRECTIONS_NONE=99]="AUTO_DIRECTIONS_NONE"})(HT||(HT={}));class u0 extends Oe{constructor(e,t,i){super(e,t,null,null,!1,!1),this.name=e,this._options=i,this._lazy=!1,this._updatable=!1,this._engine=t.getEngine(),this._lazy=i.lazy??!1,this._updatable=i.updatable??!1,this._vertexPositions=[],this._indices=[],this._uvs=[],this._points=[],this._colorPointers=i.colorPointers??[],this._widths=i.widths??new Array(i.points.length).fill(1)}getClassName(){return"GreasedLineMesh"}_updateWidthsWithValue(e){let t=0;for(const r of this._points)t+=r.length;const i=t/3*2-this._widths.length;for(let r=0;r<i;r++)this._widths.push(e)}updateLazy(){var e,t;this._setPoints(this._points),this._options.colorPointers||this._updateColorPointers(),this._createVertexBuffers((e=this._options.ribbonOptions)==null?void 0:e.smoothShading),!this.doNotSyncBoundingInfo&&this.refreshBoundingInfo(),(t=this.greasedLineMaterial)==null||t.updateLazy()}addPoints(e,t){for(const i of e)this._points.push(i);this._lazy||this.setPoints(this._points,t)}dispose(e,t=!1){super.dispose(e,t)}isLazy(){return this._lazy}get uvs(){return this._uvs}set uvs(e){this._uvs=e instanceof Float32Array?e:new Float32Array(e),this._createVertexBuffers()}get offsets(){return this._offsets}set offsets(e){this.material instanceof Gl&&this.material.setDefine(v4,(e==null?void 0:e.length)>0),this._offsets=e,this._offsetsBuffer?this._offsetsBuffer.update(e):this._createOffsetsBuffer(e)}get widths(){return this._widths}set widths(e){this._widths=e,this._lazy||this._widthsBuffer&&this._widthsBuffer.update(e)}get colorPointers(){return this._colorPointers}set colorPointers(e){this._colorPointers=e,this._lazy||this._colorPointersBuffer&&this._colorPointersBuffer.update(e)}get greasedLineMaterial(){var t,i;if(this.material&&this.material instanceof Gl)return this.material;const e=(i=(t=this.material)==null?void 0:t.pluginManager)==null?void 0:i.getPlugin(_n.GREASED_LINE_MATERIAL_NAME);if(e)return e}get points(){const e=[];return Ea.DeepCopy(this._points,e),e}setPoints(e,t){this._points=Ke.ConvertPoints(e,(t==null?void 0:t.pointsOptions)??this._options.pointsOptions),this._updateWidths(),t!=null&&t.colorPointers||this._updateColorPointers(),this._setPoints(this._points,t)}_initGreasedLine(){this._vertexPositions=[],this._indices=[],this._uvs=[]}_createLineOptions(){return{points:this._points,colorPointers:this._colorPointers,lazy:this._lazy,updatable:this._updatable,uvs:this._uvs,widths:this._widths,ribbonOptions:this._options.ribbonOptions}}serialize(e){super.serialize(e),e.type=this.getClassName(),e.lineOptions=this._createLineOptions()}_createVertexBuffers(e=!1){const t=new li;return t.positions=this._vertexPositions,t.indices=this._indices,t.uvs=this._uvs,e&&(t.normals=[],li.ComputeNormals(this._vertexPositions,this._indices,t.normals)),t.applyToMesh(this,this._options.updatable),t}_createOffsetsBuffer(e){const t=this._scene.getEngine(),i=new gr(t,e,this._updatable,3);this.setVerticesBuffer(i.createVertexBuffer("grl_offsets",0,3)),this._offsetsBuffer=i}}Oe._GreasedLineMeshParser=(s,e)=>xi.Parse(s,e);class xi extends u0{constructor(e,t,i){super(e,t,i),this.name=e,this.intersectionThreshold=.1,this._previousAndSide=[],this._nextAndCounters=[],i.points&&this.addPoints(Ke.ConvertPoints(i.points))}getClassName(){return"GreasedLineMesh"}_updateColorPointers(){if(this._options.colorPointers)return;let e=0;this._colorPointers=[];for(const t of this._points)for(let i=0;i<t.length;i+=3)this._colorPointers.push(e),this._colorPointers.push(e++)}_updateWidths(){}_setPoints(e){this._points=e,this._options.points=e,this._initGreasedLine();let t=0,i=0,r=0,n=0,a=0,o=0;for(const I of e)o=Math.max(I.length,o),i+=I.length*2,r+=(I.length-3)*2,n+=I.length*4/3,a+=I.length*8/3;const l=new ArrayBuffer(i*4+r*(i>65535?4:2)+n*4+a*4*2),c=new ArrayBuffer((o/3+o*4)*4);let u=0;const h=new Float32Array(l,u,i);u+=h.byteLength;const d=i>65535?new Uint32Array(l,u,r):new Uint16Array(l,u,r);u+=d.byteLength;const f=new Float32Array(l,u,n);u+=f.byteLength;const m=new Float32Array(l,u,a);u+=m.byteLength;const g=new Float32Array(l,u,a);let v=0,E=0,T=0,C=0,A=0;for(const I of e){const F=Ke.GetLineLengthArray(I,c),V=F[F.length-1];for(let fe=0,be=0;be<I.length;fe++,be+=3){const Me=v+be*2;if(h[Me+0]=I[be+0],h[Me+1]=I[be+1],h[Me+2]=I[be+2],h[Me+3]=I[be+0],h[Me+4]=I[be+1],h[Me+5]=I[be+2],be<I.length-3){const ce=fe*2+t,bt=E+be*2;d[bt+0]=ce,d[bt+1]=ce+1,d[bt+2]=ce+2,d[bt+3]=ce+2,d[bt+4]=ce+1,d[bt+5]=ce+3}}t+=I.length/3*2;const D=I.length*2,w=h.subarray(v,v+D);v+=D,E+=(I.length-3)*2;let B=F.byteLength;const Q=new Float32Array(c,B,w.length);B+=Q.byteLength;const J=new Float32Array(c,B,w.length),re=w.length/6;let ne;xi._CompareV3(0,re-1,w)?ne=w.subarray((re-2)*6,(re-1)*6):ne=w.subarray(0,6),Q.set(ne),Q.set(w.subarray(0,w.length-6),6),J.set(w.subarray(6)),xi._CompareV3(re-1,0,w)?ne=w.subarray(6,12):ne=w.subarray((re-1)*6,re*6),J.set(ne,J.length-6);for(let fe=0,be=w.length/3;fe<be;fe++)m[C++]=Q[fe*3],m[C++]=Q[fe*3+1],m[C++]=Q[fe*3+2],m[C++]=1-((fe&1)<<1),g[A++]=J[fe*3],g[A++]=J[fe*3+1],g[A++]=J[fe*3+2],g[A++]=F[fe>>1]/V;if(this._options.uvs)for(let fe=0;fe<this._options.uvs.length;fe++)f[T++]=this._options.uvs[fe];else for(let fe=0;fe<re;fe++){const be=F[fe]/V,Me=T+fe*4;f[Me+0]=be,f[Me+1]=0,f[Me+2]=be,f[Me+3]=1}}this._vertexPositions=h,this._indices=d,this._uvs=f,this._previousAndSide=m,this._nextAndCounters=g,this._lazy||(this._options.colorPointers||this._updateColorPointers(),this._createVertexBuffers(),!this.doNotSyncBoundingInfo&&this.refreshBoundingInfo())}clone(e=`${this.name}-cloned`,t){const i=this._createLineOptions(),r={};Ea.DeepCopy(i,r,["instance"],void 0,!0);const n=new xi(e,this._scene,r);return t&&(n.parent=t),n.material=this.material,n}serialize(e){super.serialize(e),e.type=this.getClassName(),e.lineOptions=this._createLineOptions()}static Parse(e,t){const i=e.lineOptions,r=e.name;return new xi(r,t,i)}_initGreasedLine(){super._initGreasedLine(),this._previousAndSide=[],this._nextAndCounters=[]}intersects(e,t,i,r=!1,n,a=!1){const o=new Li,l=this.findAllIntersections(e,t,i,r,n,a,!0);if((l==null?void 0:l.length)===1){const c=l[0];o.hit=!0,o.distance=c.distance,o.ray=e,o.pickedMesh=this,o.pickedPoint=c.point}return o}findAllIntersections(e,t,i,r=!1,n,a=!1,o=!1){var f;if(r&&!a&&e.intersectsSphere(this._boundingSphere,this.intersectionThreshold)===!1)return;const l=this.getIndices(),c=this.getVerticesData(M.PositionKind),u=this._widths,h=((f=this.greasedLineMaterial)==null?void 0:f.width)??1,d=[];if(l&&c&&u){let m=0,g=0;for(m=0,g=l.length-1;m<g;m+=3){const v=l[m],E=l[m+1];xi._V_START.fromArray(c,v*3),xi._V_END.fromArray(c,E*3),this._offsets&&(xi._V_OFFSET_START.fromArray(this._offsets,v*3),xi._V_OFFSET_END.fromArray(this._offsets,E*3),xi._V_START.addInPlace(xi._V_OFFSET_START),xi._V_END.addInPlace(xi._V_OFFSET_END));const T=Math.floor(m/3),C=u[T]!==void 0?u[T]:1,A=this.intersectionThreshold*(h*C)/2,I=e.intersectionSegment(xi._V_START,xi._V_END,A);if(I!==-1&&(d.push({distance:I,point:e.direction.normalize().multiplyByFloats(I,I,I).add(e.origin)}),o))return d}m=g}return d}get _boundingSphere(){return this.getBoundingInfo().boundingSphere}static _CompareV3(e,t,i){const r=e*6,n=t*6;return i[r]===i[n]&&i[r+1]===i[n+1]&&i[r+2]===i[n+2]}_createVertexBuffers(){const e=super._createVertexBuffers(),t=this._scene.getEngine(),i=new gr(t,this._previousAndSide,!1,4);this.setVerticesBuffer(i.createVertexBuffer("grl_previousAndSide",0,4));const r=new gr(t,this._nextAndCounters,!1,4);this.setVerticesBuffer(r.createVertexBuffer("grl_nextAndCounters",0,4));const n=new gr(t,this._widths,this._updatable,1);this.setVerticesBuffer(n.createVertexBuffer("grl_widths",0,1)),this._widthsBuffer=n;const a=new gr(t,this._colorPointers,this._updatable,1);return this.setVerticesBuffer(a.createVertexBuffer("grl_colorPointers",0,1)),this._colorPointersBuffer=a,e}}xi._V_START=new x;xi._V_END=new x;xi._V_OFFSET_START=new x;xi._V_OFFSET_END=new x;Oe._GreasedLineRibbonMeshParser=(s,e)=>Ht.Parse(s,e);class Ht extends u0{constructor(e,t,i,r){if(super(e,t,i),this.name=e,!i.ribbonOptions)throw"'GreasedLineMeshOptions.ribbonOptions' is not set.";this._paths=[],this._counters=[],this._slopes=[],this._widths=i.widths??[],this._ribbonWidths=[],this._pathsOptions=r??[],i.points&&this.addPoints(Ke.ConvertPoints(i.points),i,!!r)}addPoints(e,t,i=!1){if(!t.ribbonOptions)throw"addPoints() on GreasedLineRibbonMesh instance requires 'GreasedLineMeshOptions.ribbonOptions'.";i||this._pathsOptions.push({options:t,pathCount:e.length}),super.addPoints(e,t)}getClassName(){return"GreasedLineRibbonMesh"}get isFlatLine(){return this._paths.length<3}get slopes(){return this._slopes}set slopes(e){this._slopes=e}_updateColorPointers(){if(this._options.colorPointers)return;let e=0;this._colorPointers=[];for(let t=0;t<this._pathsOptions.length;t++){const{options:i,pathCount:r}=this._pathsOptions[t],n=this._points[t];if(i.ribbonOptions.pointsMode===0)for(let a=0;a<r;a++)for(let o=0;o<n.length;o+=3)this._colorPointers.push(e),this._colorPointers.push(e++);else for(let a=0;a<n.length;a+=3){for(let o=0;o<r;o++)this._colorPointers.push(e);e++}}}_updateWidths(){super._updateWidthsWithValue(1)}_setPoints(e,t){var n,a;if(!this._options.ribbonOptions)throw"No 'GreasedLineMeshOptions.ribbonOptions' provided.";this._points=e,this._options.points=e,this._initGreasedLine();let i=0,r;for(let o=0,l=0;o<this._pathsOptions.length;o++){const{options:c,pathCount:u}=this._pathsOptions[o],h=e.slice(l,l+u);if(l+=u,((n=c.ribbonOptions)==null?void 0:n.pointsMode)===1)i=this._preprocess(Ke.ToVector3Array(h),i,c);else{if(((a=c.ribbonOptions)==null?void 0:a.directionsAutoMode)===99){if(!c.ribbonOptions.directions)throw"In GreasedLineRibbonAutoDirectionMode.AUTO_DIRECTIONS_NONE 'GreasedLineMeshOptions.ribbonOptions.directions' must be defined.";r=Ht._GetDirectionPlanesFromDirectionsOption(h.length,c.ribbonOptions.directions)}for(let d=0;d<h.length;d++){const f=h[d],m=Ht._ConvertToRibbonPath(f,c.ribbonOptions,this._scene.useRightHandedSystem,r&&r[d]);i=this._preprocess(m,i,c)}}}this._lazy||(this._createVertexBuffers(),!this.doNotSyncBoundingInfo&&this.refreshBoundingInfo())}static _GetDirectionPlanesFromDirectionsOption(e,t){return Array.isArray(t)?t:new Array(e).fill(t)}static _CreateRibbonVertexData(e,t){var u,h;const i=e.length;if(i<2)throw"Minimum of two paths are required to create a GreasedLineRibbonMesh.";const r=[],n=[],a=e[0];for(let d=0;d<a.length;d++)for(let f=0;f<e.length;f++){const m=e[f][d];r.push(m.x,m.y,m.z)}const o=[1,0,i],l=((u=t.ribbonOptions)==null?void 0:u.facesMode)===2,c=((h=t.ribbonOptions)==null?void 0:h.pointsMode)===1&&t.ribbonOptions.closePath;if(i>2)for(let d=0;d<a.length-1;d++){o[0]=1+i*d,o[1]=i*d,o[2]=(d+1)*i;for(let f=0;f<(i-1)*2;f++)f%2!==0&&(o[2]+=1),f%2===0&&f>0&&(o[0]+=1,o[1]+=1),n.push(o[1]+(f%2!==0?i:0),o[0],o[2]),l&&n.push(o[0],o[1]+(f%2!==0?i:0),o[2])}else for(let d=0;d<r.length/3-3;d+=2)n.push(d,d+1,d+2),n.push(d+2,d+1,d+3),l&&(n.push(d+1,d,d+2),n.push(d+1,d+2,d+3));if(c){let d=i*(a.length-1);for(let f=0;f<i-1;f++)n.push(d,f+1,f),n.push(d+1,f+1,d),l&&(n.push(f,f+1,d),n.push(d,f+1,d+1)),d++}return{positions:r,indices:n}}_preprocess(e,t,i){var f,m;this._paths=e;const r=Ht._CreateRibbonVertexData(e,i),n=r.positions;if(!this._options.widths)throw"No 'GreasedLineMeshOptions.widths' table is specified.";const a=Array.isArray(this._vertexPositions)?this._vertexPositions:Array.from(this._vertexPositions);this._vertexPositions=a;const o=Array.isArray(this._uvs)?this._uvs:Array.from(this._uvs);this._uvs=o;const l=Array.isArray(this._indices)?this._indices:Array.from(this._indices);this._indices=l;for(const g of n)a.push(g);let c=e;if(((f=i.ribbonOptions)==null?void 0:f.pointsMode)===1&&i.ribbonOptions.closePath){c=[];for(let g=0;g<e.length;g++){const v=e[g].slice();v.push(e[g][0].clone()),c.push(v)}}this._calculateSegmentLengths(c);const u=c.length,h=new Array(u).fill(0);for(let g=0;g<c[0].length;g++){let v=0;for(let E=0;E<u;E++){const T=h[E]+this._vSegmentLengths[E][g]/this._vTotalLengths[E];this._counters.push(T),o.push(T,v),h[E]=T,v+=this._uSegmentLengths[g][E]/this._uTotalLengths[g]}}for(let g=0,v=0;g<c[0].length;g++){const E=this._uSegmentLengths[g][0]/2,T=this._uSegmentLengths[g][u-1]/2;this._ribbonWidths.push(((this._widths[v++]??1)-1)*E);for(let C=0;C<u-2;C++)this._ribbonWidths.push(0);this._ribbonWidths.push(((this._widths[v++]??1)-1)*T)}const d=((m=i.ribbonOptions)==null?void 0:m.pointsMode)===1?new Array(c[0].length*c.length*6).fill(0):Ht._CalculateSlopes(c);for(const g of d)this._slopes.push(g);if(r.indices)for(let g=0;g<r.indices.length;g++)l.push(r.indices[g]+t);return t+=n.length/3,t}static _ConvertToRibbonPath(e,t,i,r){if(t.pointsMode===0&&!t.width)throw"'GreasedLineMeshOptions.ribbonOptiosn.width' must be specified in GreasedLineRibbonPointsMode.POINTS_MODE_POINTS.";const n=[],a=[];if(t.pointsMode===0){const o=t.width/2,l=Ke.ToVector3Array(e);let c=null,u=null;if(t.directionsAutoMode===0&&(r=Ht._GetDirectionFromPoints(l[0],l[1],null)),t.directionsAutoMode===3&&!(t.directions instanceof x))throw"In GreasedLineRibbonAutoDirectionMode.AUTO_DIRECTIONS_FACE_TO 'GreasedLineMeshOptions.ribbonOptions.directions' must be a Vector3.";G.Vector3[1]=t.directions instanceof x?t.directions:Ht.DIRECTION_XZ;for(let h=0;h<l.length-(r?0:1);h++){const d=l[h],f=l[h+1];if(r)c=r;else if(t.directionsAutoMode===3)f.subtractToRef(d,G.Vector3[0]),c=x.CrossToRef(G.Vector3[0],G.Vector3[1],G.Vector3[2]).normalize();else if(t.directionsAutoMode===1)c=Ht._GetDirectionFromPoints(d,f,c);else{const m=f.subtract(d);m.applyRotationQuaternionInPlace(m.x>m.y&&m.x>m.z?i?Ht._RightHandedForwardReadOnlyQuaternion:Ht._LeftHandedForwardReadOnlyQuaternion:Ht._LeftReadOnlyQuaternion),c=m.normalize()}u=c.multiplyByFloats(o,o,o),n.push(d.add(u)),a.push(d.subtract(u))}r||(n.push(l[l.length-1].add(u)),a.push(l[l.length-1].subtract(u)))}return[n,a]}static _GetDirectionFromPoints(e,t,i){return e.x===t.x&&(!i||(i==null?void 0:i.x)===1)?Ht.DIRECTION_YZ:e.y===t.y?Ht.DIRECTION_XZ:e.z===t.z?Ht.DIRECTION_XY:Ht.DIRECTION_XZ}clone(e=`${this.name}-cloned`,t){const i=this._createLineOptions(),r={},n=[];Ea.DeepCopy(this._pathsOptions,n,void 0,void 0,!0),Ea.DeepCopy(i,r,["instance"],void 0,!0);const a=new Ht(e,this._scene,r,n);return t&&(a.parent=t),a.material=this.material,a}serialize(e){super.serialize(e),e.type=this.getClassName(),e.lineOptions=this._createLineOptions(),e.pathsOptions=this._pathsOptions}static Parse(e,t){const i=e.lineOptions,r=e.name,n=e.pathOptions;return new Ht(r,t,i,n)}_initGreasedLine(){super._initGreasedLine(),this._paths=[],this._counters=[],this._slopes=[],this._ribbonWidths=[]}_calculateSegmentLengths(e){const t=e.length;this._vSegmentLengths=new Array(t),this._vTotalLengths=new Array(t);let i=0;for(let a=0;a<t;a++){const o=e[a];this._vSegmentLengths[a]=[0],i=0;for(let l=0;l<o.length-1;l++){const c=Math.abs(o[l].subtract(o[l+1]).lengthSquared());i+=c,this._vSegmentLengths[a].push(c)}this._vTotalLengths[a]=i}const r=e[0].length;this._uSegmentLengths=new Array(r).fill([]),this._uTotalLengths=new Array(r).fill([]);const n=new x;for(let a=0;a<r;a++){i=0;for(let o=1;o<t;o++){e[o][a].subtractToRef(e[o-1][a],n);const l=n.length();i+=l,this._uSegmentLengths[a].push(l)}this._uTotalLengths[a]=i}}static _CalculateSlopes(e){const t=e[0],i=e.length===2?e[1]:e[e.length-1],r=[],n=new x;for(let a=0;a<t.length;a++)for(let o=0;o<e.length;o++)o===0||o===e.length-1?(t[a].subtract(i[a]).normalizeToRef(n),r.push(n.x,n.y,n.z),r.push(-n.x,-n.y,-n.z)):r.push(0,0,0,0,0,0);return r}_createVertexBuffers(){var a;this._uvs=this._options.uvs??this._uvs;const e=super._createVertexBuffers((a=this._options.ribbonOptions)==null?void 0:a.smoothShading),t=new gr(this._engine,this._counters,this._updatable,1);this.setVerticesBuffer(t.createVertexBuffer("grl_counters",0,1));const i=new gr(this._engine,this._colorPointers,this._updatable,1);this.setVerticesBuffer(i.createVertexBuffer("grl_colorPointers",0,1));const r=new gr(this._engine,this._slopes,this._updatable,3);this.setVerticesBuffer(r.createVertexBuffer("grl_slopes",0,3));const n=new gr(this._engine,this._ribbonWidths,this._updatable,1);return this.setVerticesBuffer(n.createVertexBuffer("grl_widths",0,1)),this._widthsBuffer=n,e}}Ht.DEFAULT_WIDTH=.1;Ht._RightHandedForwardReadOnlyQuaternion=Z.RotationAxis(x.RightHandedForwardReadOnly,Math.PI/2);Ht._LeftHandedForwardReadOnlyQuaternion=Z.RotationAxis(x.LeftHandedForwardReadOnly,Math.PI/2);Ht._LeftReadOnlyQuaternion=Z.RotationAxis(x.LeftReadOnly,Math.PI/2);Ht.DIRECTION_XY=x.LeftHandedForwardReadOnly;Ht.DIRECTION_XZ=x.UpReadOnly;Ht.DIRECTION_YZ=x.LeftReadOnly;var $T;(function(s){s[s.COLOR_DISTRIBUTION_NONE=0]="COLOR_DISTRIBUTION_NONE",s[s.COLOR_DISTRIBUTION_REPEAT=1]="COLOR_DISTRIBUTION_REPEAT",s[s.COLOR_DISTRIBUTION_EVEN=2]="COLOR_DISTRIBUTION_EVEN",s[s.COLOR_DISTRIBUTION_START=3]="COLOR_DISTRIBUTION_START",s[s.COLOR_DISTRIBUTION_END=4]="COLOR_DISTRIBUTION_END",s[s.COLOR_DISTRIBUTION_START_END=5]="COLOR_DISTRIBUTION_START_END"})($T||($T={}));var XT;(function(s){s[s.WIDTH_DISTRIBUTION_NONE=0]="WIDTH_DISTRIBUTION_NONE",s[s.WIDTH_DISTRIBUTION_REPEAT=1]="WIDTH_DISTRIBUTION_REPEAT",s[s.WIDTH_DISTRIBUTION_EVEN=2]="WIDTH_DISTRIBUTION_EVEN",s[s.WIDTH_DISTRIBUTION_START=3]="WIDTH_DISTRIBUTION_START",s[s.WIDTH_DISTRIBUTION_END=4]="WIDTH_DISTRIBUTION_END",s[s.WIDTH_DISTRIBUTION_START_END=5]="WIDTH_DISTRIBUTION_START_END"})(XT||(XT={}));let Oc=0;async function X4(s,e){return await new Promise((t,i)=>{let r,n;if(Fm())r=window,n="window";else if(typeof self<"u")r=self,n="self";else{i(new Error("Cannot load script module outside of a window or a worker"));return}r._LoadScriptModuleResolve||(r._LoadScriptModuleResolve={}),r._LoadScriptModuleResolve[Oc]=t,s+=`
            ${n}._LoadScriptModuleResolve[${Oc}](returnedValue);
            ${n}._LoadScriptModuleResolve[${Oc}] = undefined;
        `,Oc++,j.LoadScript(s,void 0,(a,o)=>{i(o||new Error(a))},e,!0)})}let _a,Nc,Ef,Xc;class Wl{get numProp(){return this._numProp}constructor(e,t,i){this._manifold=e,this._numProp=t,this._vertexStructure=i}_process(e,t){if(this.numProp!==t.numProp)throw new Error("CSG must be used with geometries having the same number of properties");return new Wl(_a[e](this._manifold,t._manifold),this.numProp,this._vertexStructure)}subtract(e){return this._process("difference",e)}intersect(e){return this._process("intersection",e)}add(e){return this._process("union",e)}printDebug(){N.Log("Genus:"+this._manifold.genus()),N.Log("Volume:"+this._manifold.volume()),N.Log("surface area:"+this._manifold.surfaceArea())}toVertexData(e){const t={rebuildNormals:!1,...e},i=new li,r=this._vertexStructure.find(l=>l.kind===M.NormalKind),n=this._manifold.getMesh(t.rebuildNormals&&r?[3,4,5]:void 0);i.indices=n.triVerts.length>65535?new Uint32Array(n.triVerts):new Uint16Array(n.triVerts);for(let l=0;l<n.triVerts.length;l+=3)i.indices[l]=n.triVerts[l+2],i.indices[l+1]=n.triVerts[l+1],i.indices[l+2]=n.triVerts[l];const a=n.vertProperties.length/n.numProp;let o=0;for(let l=0;l<this._vertexStructure.length;l++){const c=this._vertexStructure[l],u=new Float32Array(a*c.stride);for(let h=0;h<a;h++)for(let d=0;d<c.stride;d++)u[h*c.stride+d]=n.vertProperties[h*n.numProp+o+d];i.set(u,c.kind),o+=c.stride}return i}toMesh(e,t,i){const r={rebuildNormals:!1,centerMesh:!0,...i},n=this.toVertexData({rebuildNormals:r.rebuildNormals}),a=this._vertexStructure.find(m=>m.kind===M.NormalKind),o=this._manifold.getMesh(r.rebuildNormals&&a?[3,4,5]:void 0),l=o.vertProperties.length/o.numProp,c=new Oe(e,t);if(n.applyToMesh(c),!l)throw new Error("Unable to build a mesh. Manifold has 0 vertex");if(r.centerMesh){const m=c.getBoundingInfo().boundingSphere.center;c.position.set(-m.x,-m.y,-m.z),c.bakeCurrentTransformIntoVertices()}let u=o.runOriginalID[0],h=o.runIndex[0],d=0;const f=[];t=c.getScene();for(let m=0;m<o.numRun;++m){const g=o.runOriginalID[m+1];if(g!==u){const v=o.runIndex[m+1];new Yn(d,0,l,h,v-h,c),f.push(t.getMaterialByUniqueID(u-Xc)||t.defaultMaterial),u=g,h=v,d++}}if(r.materialToUse)c.material=r.materialToUse;else if(f.length>1){const m=new Zm(e,t);m.subMaterials=f,c.material=m}else c.subMeshes.length>1&&c._createGlobalSubMesh(!0),c.material=f[0];return c}dispose(){this._manifold&&(this._manifold.delete(),this._manifold=null)}static _ProcessData(e,t,i,r,n,a){const o=new Float32Array(e*i.reduce((u,h)=>u+h.stride,0));for(let u=0;u<e;u++){let h=0;for(let d=0;d<i.length;d++){const f=i[d];for(let m=0;m<f.stride;m++)o[u*r+h+m]=f.data[u*f.stride+m];h+=f.stride}}const l=new Ef({numProp:r,vertProperties:o,triVerts:t,runIndex:n,runOriginalID:a});l.merge();let c;try{c=new Wl(new _a(l),r,i)}catch(u){throw new Error("Error while creating the CSG: "+u.message)}return c}static _Construct(e,t,i,r){const n=new Uint32Array(e.indices.length);for(let h=0;h<e.indices.length;h+=3)n[h]=e.indices[h+2],n[h+1]=e.indices[h+1],n[h+2]=e.indices[h];const a=new x;let o=3;const l=[{stride:3,kind:M.PositionKind}];if(!t)l[0].data=e.positions;else{const h=new Float32Array(e.positions.length);for(let d=0;d<e.positions.length;d+=3)x.TransformCoordinatesFromFloatsToRef(e.positions[d],e.positions[d+1],e.positions[d+2],t,a),a.toArray(h,d);l[0].data=h}const c=e.normals;if(c)if(o+=3,l.push({stride:3,kind:M.NormalKind}),!t)l[1].data=c;else{const h=new Float32Array(c.length);for(let d=0;d<c.length;d+=3)x.TransformNormalFromFloatsToRef(c[d],c[d+1],c[d+2],t,a),a.toArray(h,d);l[1].data=h}for(const h of[M.UVKind,M.UV2Kind,M.UV3Kind,M.UV4Kind,M.UV5Kind,M.UV6Kind]){const d=e[h===M.UVKind?"uvs":h];d&&(o+=2,l.push({stride:2,kind:h,data:d}))}const u=e.colors;return u&&(o+=4,l.push({stride:4,kind:M.ColorKind,data:u})),this._ProcessData(e.positions.length/3,n,l,o,i,r)}static FromVertexData(e){const t=e.positions,i=e.indices;if(!t||!i)throw new Error("The vertexData must at least have positions and indices");return this._Construct(e,null)}static FromMesh(e,t=!1){const i=e.getVerticesData(M.PositionKind),r=e.getIndices(),n=e.computeWorldMatrix(!0);if(!i||!r)throw new Error("The mesh must at least have positions and indices");const a=[...Array(e.subMeshes.length)].map((m,g)=>e.subMeshes[g].indexStart),o=e.material||e.getScene().defaultMaterial,l=o.getClassName()==="MultiMaterial",c=[...Array(e.subMeshes.length)].map((m,g)=>l?Xc+o.subMaterials[e.subMeshes[g].materialIndex].uniqueId:Xc+o.uniqueId),u=Array.from(a.keys());u.sort((m,g)=>a[m]-a[g]);const h=new Uint32Array(u.map(m=>a[m])),d=new Uint32Array(u.map(m=>c[m])),f={positions:i,indices:r,normals:e.getVerticesData(M.NormalKind),colors:e.getVerticesData(M.ColorKind),uvs:e.getVerticesData(M.UVKind),uvs2:e.getVerticesData(M.UV2Kind),uvs3:e.getVerticesData(M.UV3Kind),uvs4:e.getVerticesData(M.UV4Kind),uvs5:e.getVerticesData(M.UV5Kind),uvs6:e.getVerticesData(M.UV6Kind)};return this._Construct(f,t?null:n,h,d)}}function Y4(){return _a!==void 0}async function j4(s){const e={manifoldUrl:"https://unpkg.com/manifold-3d@3.2.1",...s};if(!_a){if(Nc){await Nc;return}if(e.manifoldInstance)_a=e.manifoldInstance,Ef=e.manifoldMeshInstance;else{Nc=X4(`
            import Module from '${e.manifoldUrl}/manifold.js';
            const wasm = await Module();
            wasm.setup();
            const {Manifold, Mesh} = wasm;
            const returnedValue =  {Manifold, Mesh};
        `);const t=await Nc;_a=t.Manifold,Ef=t.Mesh}Xc=_a.reserveIDs(65536)}}const h0=Math.pow(10,4);function q4(s){return s+(s>0?.5:-.5)<<0}function rd(s,e=h0){let t=q4(s*e);return t===0&&(t=0),`${t}`}function Ki(s,e=h0){return`${rd(s.x,e)},${rd(s.y,e)},${rd(s.z,e)}`}function Z4(s){const e=["positions","normals","uvs"],t=Object.keys(s).filter(i=>Array.isArray(s[i]));return Array.from(new Set([...e,...t]))}function Q4(s,e,t,i,r,n){for(let a=0;a<t;a++)s[e+a]=i[a],s[e+t+a]=r[a],s[e+2*t+a]=n[a]}function d0(s){if(!s.indices||s.indices.length===0)return s;const e=[],t=[],i=[],r=s.indices,n=s.positions,a=s.normals,o=s.uvs;for(let c=0;c<r.length;c++){const u=r[c];e.push(n[3*u],n[3*u+1],n[3*u+2]),a&&t.push(a[3*u],a[3*u+1],a[3*u+2]),o&&i.push(o[2*u],o[2*u+1])}const l=new li;return l.positions=e,t.length&&(l.normals=t),i.length&&(l.uvs=i),l}function Yr(s,e,t,i){if(i===3){s.fromArray(e,t*3);return}s.set(e[t*2],e[t*2+1],0)}function YT(s,e,t){const i=new x,r=new x,n=new x,a=new x,o=new x,l=new x;for(let c=0;c<e;c+=3){const u=c*3;i.set(s[u],s[u+1],s[u+2]),r.set(s[u+3],s[u+4],s[u+5]),n.set(s[u+6],s[u+7],s[u+8]),i.addToRef(r,a),a.scaleInPlace(.5),r.addToRef(n,o),o.scaleInPlace(.5),n.addToRef(i,l),l.scaleInPlace(.5),t.push(i.x,i.y,i.z,a.x,a.y,a.z,l.x,l.y,l.z),t.push(r.x,r.y,r.z,o.x,o.y,o.z,a.x,a.y,a.z),t.push(n.x,n.y,n.z,l.x,l.y,l.z,o.x,o.y,o.z),t.push(a.x,a.y,a.z,o.x,o.y,o.z,l.x,l.y,l.z)}}function f0(s){const e=d0(s),t=e.positions,i=e.normals,r=e.uvs,n=t.length/3,a=[],o=[],l=[];if(YT(t,n,a),i&&i.length&&YT(i,n,o),r&&r.length)for(let d=0;d<n;d+=3){const f=d*2,m=[r[f],r[f+1]],g=[r[f+2],r[f+3]],v=[r[f+4],r[f+5]],E=[(m[0]+g[0])/2,(m[1]+g[1])/2],T=[(g[0]+v[0])/2,(g[1]+v[1])/2],C=[(v[0]+m[0])/2,(v[1]+m[1])/2];l.push(...m,...E,...C),l.push(...g,...T,...E),l.push(...v,...C,...T),l.push(...E,...T,...C)}const c=a.length/3,u=[];for(let d=0;d<c;d++)u.push(d);const h=new li;return h.positions=a,o.length&&(h.normals=o),l.length&&(h.uvs=l),h.indices=u,h}function K4(s,e){const t=d0(s),i=f0(t),r=Z4(t),n=t.positions,a=i.positions,o=n.length/3,l={},c={},u={},h={};function d(ne,fe,be){c[ne]||(c[ne]={}),c[ne][fe]||(c[ne][fe]=[]),c[ne][fe].push(be)}function f(ne,fe){u[ne]||(u[ne]=[]),u[ne].push(fe)}function m(ne,fe){h[ne]||(h[ne]=new Set),h[ne].add(fe)}const g=new x,v=new x,E=new x,T=new x,C=new x,A=new x,I=new x;for(let ne=0;ne<o;ne+=3){Yr(v,n,ne,3),Yr(E,n,ne+1,3),Yr(T,n,ne+2,3);const fe=Ki(v),be=Ki(E),Me=Ki(T);d(fe,be,ne+1),d(fe,Me,ne+2),d(be,fe,ne),d(be,Me,ne+2),d(Me,fe,ne),d(Me,be,ne+1),v.addToRef(E,C),C.scaleInPlace(.5),E.addToRef(T,A),A.scaleInPlace(.5),T.addToRef(v,I),I.scaleInPlace(.5),f(Ki(C),ne+2),f(Ki(A),ne),f(Ki(I),ne+1),m(fe,Ki(C)),m(fe,Ki(I)),m(be,Ki(C)),m(be,Ki(A)),m(Me,Ki(A)),m(Me,Ki(I))}for(let ne=0;ne<a.length/3;ne++){Yr(g,a,ne,3);const fe=Ki(g);l[fe]||(l[fe]=[]),l[fe].push(ne)}const F=[new x,new x,new x],V=[new x,new x,new x],D=new x,w=new x;function B(ne,fe,be){const Me=ne==="uvs"?2:3,ce=a.length/3,bt=new Array(ce*Me);let Pt=0;for(let Yt=0;Yt<ce;Yt+=3){for(let mt=0;mt<3;mt++)if(ne==="uvs"&&!e.uvSmooth)Yr(F[mt],be,Yt+mt,2);else if(ne==="normals"){Yr(V[mt],a,Yt+mt,3);const Ot=Ki(V[mt]),Wi=l[Ot]||[],zr=Wi.length,ut=.75/zr,Wr=1-ut*zr;Yr(F[mt],be,Yt+mt,3),F[mt].scaleInPlace(Wr);for(const Vt of Wi)Yr(D,be,Vt,3),D.scaleInPlace(ut),F[mt].addInPlace(D)}else{Yr(F[mt],be,Yt+mt,Me),Yr(V[mt],a,Yt+mt,3);const Ot=Ki(V[mt]),Wi=c[Ot],zr=u[Ot];if(Wi){if(e.preserveEdges){const ia=h[Ot];let ol=!0;if(ia.forEach(vc=>{u[vc]&&u[vc].length%2!==0&&(ol=!1)}),!ol)continue}const Wr=Object.keys(Wi).length,Vt=1/Wr*(5/8-Math.pow(3/8+1/4*Math.cos(2*Math.PI/Wr),2)),ta=1/Wr/Wr,Ya=rs.Lerp(ta,Vt,e.weight),al=1-Ya*Wr;F[mt].scaleInPlace(al);for(const ia in Wi){const ol=Wi[ia];D.set(0,0,0);for(const vc of ol)Yr(w,fe,vc,Me),D.addInPlace(w);D.scaleInPlace(1/ol.length),D.scaleInPlace(Ya),F[mt].addInPlace(D)}}else if(zr&&zr.length===2){const ut=zr.length,Wr=.125,Vt=1-Wr*ut;F[mt].scaleInPlace(Vt);for(const ta of zr)Yr(D,fe,ta,Me),D.scaleInPlace(Wr),F[mt].addInPlace(D)}}Q4(bt,Pt,Me,F[0].asArray(),F[1].asArray(),F[2].asArray()),Pt+=Me*3}return bt}const Q=new li;for(const ne of r){if(ne==="indices")continue;const fe=t[ne],be=i[ne];if(!fe||!be)continue;const Me=B(ne,fe,be);Q[ne]=Me}const J=Q.positions,re=[];for(let ne=0;ne<J.length/3;ne++)re.push(ne);return Q.indices=re,Q}function J4(s,e,t){if(t={flatOnly:!1,uvSmooth:!1,preserveEdges:!1,weight:1,...t},!s.positions||s.positions.length===0||e<=0)return s;let i=s.clone();for(let r=0;r<e;r++)t.flatOnly?i=f0(i):i=K4(i,t);return i}var b;(function(s){s[s.Int=1]="Int",s[s.Float=2]="Float",s[s.Vector2=4]="Vector2",s[s.Vector3=8]="Vector3",s[s.Vector4=16]="Vector4",s[s.Matrix=32]="Matrix",s[s.Geometry=64]="Geometry",s[s.Texture=128]="Texture",s[s.AutoDetect=1024]="AutoDetect",s[s.BasedOnInput=2048]="BasedOnInput",s[s.Undefined=4096]="Undefined",s[s.All=4095]="All"})(b||(b={}));var jT;(function(s){s[s.Compatible=0]="Compatible",s[s.TypeIncompatible=1]="TypeIncompatible",s[s.HierarchyIssue=2]="HierarchyIssue"})(jT||(jT={}));var qT;(function(s){s[s.Input=0]="Input",s[s.Output=1]="Output"})(qT||(qT={}));class ZT{get direction(){return this._direction}get type(){if(this._type===b.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource){if(this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.type;if(this._linkedConnectionSource._defaultConnectionPointType)return this._linkedConnectionSource._defaultConnectionPointType}if(this._defaultConnectionPointType)return this._defaultConnectionPointType}if(this._type===b.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._type=e}get isConnected(){return this.connectedPoint!==null||this.hasEndpoints}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return this._endpoints.length===0?[]:this._endpoints.map(e=>e.ownerBlock)}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get innerType(){return this._linkedConnectionSource&&!this._isMainLinkSource&&this._linkedConnectionSource.isConnected?this.type:this._type}_resetCounters(){this._callCount=0,this._executionCount=0}get callCount(){return this._callCount}get executionCount(){return this._executionCount}getConnectedValue(e){var t;return this.isConnected?(t=this._connectedPoint)!=null&&t._storedFunction?(this._connectedPoint._callCount++,this._connectedPoint._executionCount++,this._connectedPoint._storedFunction(e)):(this._connectedPoint._callCount++,this._connectedPoint._executionCount=1,this._connectedPoint._storedValue):(this._callCount++,this._executionCount=1,this.value)}constructor(e,t,i){this._connectedPoint=null,this._storedValue=null,this._storedFunction=null,this._acceptedConnectionPointType=null,this._endpoints=new Array,this._type=b.Geometry,this._linkedConnectionSource=null,this._typeConnectionSource=null,this._defaultConnectionPointType=null,this._isMainLinkSource=!1,this.acceptedConnectionPointTypes=[],this.excludedConnectionPointTypes=[],this.onConnectionObservable=new k,this.onDisconnectionObservable=new k,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this.defaultValue=null,this.value=null,this.valueMin=null,this.valueMax=null,this._callCount=0,this._executionCount=0,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeGeometryConnectionPoint"}canConnectTo(e){return this.checkCompatibilityState(e)===0}checkCompatibilityState(e){const t=this._ownerBlock,i=e.ownerBlock;if(this.type!==e.type&&e.innerType!==b.AutoDetect)return e.acceptedConnectionPointTypes&&e.acceptedConnectionPointTypes.indexOf(this.type)!==-1?0:1;if(e.excludedConnectionPointTypes&&e.excludedConnectionPointTypes.indexOf(this.type)!==-1)return 1;let r=i,n=t;return this.direction===0&&(r=t,n=i),r.isAnAncestorOf(n)?2:0}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw`Cannot connect these two connectors. source: "${this.ownerBlock.name}".${this.name}, target: "${e.ownerBlock.name}".${e.name}`;return this._endpoints.push(e),e._connectedPoint=this,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){const t=this._endpoints.indexOf(e);return t===-1?this:(this._endpoints.splice(t,1),e._connectedPoint=null,this.onDisconnectionObservable.notifyObservers(e),e.onDisconnectionObservable.notifyObservers(this),this)}addExcludedConnectionPointFromAllowedTypes(e){let t=1;for(;t<b.All;)e&t||this.excludedConnectionPointTypes.push(t),t=t<<1}serialize(e=!0){const t={};return t.name=this.name,t.displayName=this.displayName,this.value!==void 0&&this.value!==null&&(this.value.asArray?(t.valueType="BABYLON."+this.value.getClassName(),t.value=this.value.asArray()):(t.valueType="number",t.value=this.value)),e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear(),this.onDisconnectionObservable.clear()}}class de{get buildExecutionTime(){return this._buildExecutionTime}get inputs(){return this._inputs}get outputs(){return this._outputs}get name(){return this._name}set name(e){this._name=e}get isInput(){return this._isInput}get isTeleportOut(){return this._isTeleportOut}get isTeleportIn(){return this._isTeleportIn}get isDebug(){return this._isDebug}get isUnique(){return this._isUnique}getClassName(){return"NodeGeometryBlock"}_inputRename(e){return e}_outputRename(e){return e}isAnAncestorOf(e){for(const t of this._outputs)if(t.hasEndpoints){for(const i of t.endpoints)if(i.ownerBlock===e||i.ownerBlock.isAnAncestorOf(e))return!0}return!1}isAnAncestorOfType(e){if(this.getClassName()===e)return!0;for(const t of this._outputs)if(t.hasEndpoints){for(const i of t.endpoints)if(i.ownerBlock.isAnAncestorOfType(e))return!0}return!1}getDescendantOfPredicate(e){if(e(this))return this;for(const t of this._outputs)if(t.hasEndpoints)for(const i of t.endpoints){const r=i.ownerBlock.getDescendantOfPredicate(e);if(r)return r}return null}get _isReadyState(){return null}constructor(e){this._name="",this._isInput=!1,this._isTeleportOut=!1,this._isTeleportIn=!1,this._isDebug=!1,this._isUnique=!1,this._buildExecutionTime=0,this.onBuildObservable=new k,this._inputs=new Array,this._outputs=new Array,this._codeVariableName="",this.visibleOnFrame=!1,this._name=e,this.uniqueId=bn.UniqueId}registerInput(e,t,i=!1,r,n,a){const o=new ZT(e,this,0);return o.type=t,o.isOptional=i,o.defaultValue=r,o.value=r,o.valueMin=n,o.valueMax=a,this._inputs.push(o),this}registerOutput(e,t,i){return i=i??new ZT(e,this,1),i.type=t,this._outputs.push(i),this}_buildBlock(e){}_customBuildStep(e){}build(e){if(this._buildId===e.buildId)return!0;if(this._outputs.length>0){if(!this._outputs.some(i=>i.hasEndpoints)&&!this.isDebug)return!1;for(const i of this.outputs)i._resetCounters()}this._buildId=e.buildId;for(const i of this._inputs){if(!i.connectedPoint){i.isOptional||e.notConnectedNonOptionalInputs.push(i);continue}const r=i.connectedPoint.ownerBlock;r&&r!==this&&r.build(e)}this._customBuildStep(e),e.verbose&&N.Log(`Building ${this.name} [${this.getClassName()}]`);const t=Qr.Now;return this._buildBlock(e),this._buildExecutionTime=Qr.Now-t,this.onBuildObservable.notifyObservers(this),!1}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:(this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[e]._isMainLinkSource=!0),this._inputs[t]._linkedConnectionSource=this._inputs[e]}initialize(){}autoConfigure(e){}getInputByName(e){const t=this._inputs.filter(i=>i.name===e);return t.length?t[0]:null}getOutputByName(e){const t=this._outputs.filter(i=>i.name===e);return t.length?t[0]:null}serialize(){const e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.visibleOnFrame=this.visibleOnFrame,e.comments=this.comments,e.inputs=[],e.outputs=[];for(const t of this.inputs)e.inputs.push(t.serialize());for(const t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e){this._name=e.name,this.comments=e.comments,this.visibleOnFrame=!!e.visibleOnFrame,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){const t=e.inputs,i=e.outputs;if(t)for(const r of t){const n=this.inputs.find(a=>a.name===r.name);if(!n)return;if(r.displayName&&(n.displayName=r.displayName),r.isExposedOnFrame&&(n.isExposedOnFrame=r.isExposedOnFrame,n.exposedPortPosition=r.exposedPortPosition),r.value!==void 0&&r.value!==null)if(r.valueType==="number")n.value=r.value;else{const a=ki(r.valueType);a&&(n.value=a.FromArray(r.value))}}if(i)for(let r=0;r<i.length;r++){const n=i[r];n.displayName&&(this.outputs[r].displayName=n.displayName),n.isExposedOnFrame&&(this.outputs[r].isExposedOnFrame=n.isExposedOnFrame,this.outputs[r].exposedPortPosition=n.exposedPortPosition)}}_dumpPropertiesCode(){return`${this._codeVariableName}.visibleOnFrame = ${this.visibleOnFrame};
`}_dumpCodeForOutputConnections(e){let t="";if(e.indexOf(this)!==-1)return t;e.push(this);for(const i of this.inputs){if(!i.isConnected)continue;const r=i.connectedPoint,n=r.ownerBlock;t+=n._dumpCodeForOutputConnections(e),t+=`${n._codeVariableName}.${n._outputRename(r.name)}.connectTo(${this._codeVariableName}.${this._inputRename(i.name)});
`}return t}_dumpCode(e,t){t.push(this);const i=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=i||`${this.getClassName()}_${this.uniqueId}`,e.indexOf(this._codeVariableName)!==-1){let a=0;do a++,this._codeVariableName=i+a;while(e.indexOf(this._codeVariableName)!==-1)}e.push(this._codeVariableName);let r=`
// ${this.getClassName()}
`;this.comments&&(r+=`// ${this.comments}
`);const n=this.getClassName();if(n==="GeometryInputBlock"){const o=this.type;r+=`var ${this._codeVariableName} = new BABYLON.GeometryInputBlock("${this.name}", ${o});
`}else r+=`var ${this._codeVariableName} = new BABYLON.${n}("${this.name}");
`;r+=this._dumpPropertiesCode();for(const a of this.inputs){if(!a.isConnected)continue;const l=a.connectedPoint.ownerBlock;t.indexOf(l)===-1&&(r+=l._dumpCode(e,t))}for(const a of this.outputs)if(a.hasEndpoints)for(const o of a.endpoints){const l=o.ownerBlock;l&&t.indexOf(l)===-1&&(r+=l._dumpCode(e,t))}return r}clone(){const e=this.serialize(),t=ki(e.customType);if(t){const i=new t;return i._deserialize(e),i}return null}dispose(){for(const e of this.inputs)e.dispose();for(const e of this.outputs)e.dispose();this.onBuildObservable.clear()}}_([R("comment")],de.prototype,"comments",void 0);class p0 extends de{get currentVertexData(){return this._vertexData}constructor(e){super(e),this._vertexData=null,this._isUnique=!0,this.registerInput("geometry",b.Geometry)}getClassName(){return"GeometryOutputBlock"}get geometry(){return this._inputs[0]}_buildBlock(e){e.vertexData=this.geometry.getConnectedValue(e),this._vertexData=e.vertexData}}y("BABYLON.GeometryOutputBlock",p0);var Be;(function(s){s[s.None=0]="None",s[s.Positions=1]="Positions",s[s.Normals=2]="Normals",s[s.Tangents=3]="Tangents",s[s.UV=4]="UV",s[s.UV2=5]="UV2",s[s.UV3=6]="UV3",s[s.UV4=7]="UV4",s[s.UV5=8]="UV5",s[s.UV6=9]="UV6",s[s.Colors=10]="Colors",s[s.VertexID=11]="VertexID",s[s.FaceID=12]="FaceID",s[s.GeometryID=13]="GeometryID",s[s.CollectionID=14]="CollectionID",s[s.LoopID=15]="LoopID",s[s.InstanceID=16]="InstanceID",s[s.LatticeID=17]="LatticeID",s[s.LatticeControl=18]="LatticeControl"})(Be||(Be={}));class eW{constructor(){this._rotationMatrix=new z,this._scalingMatrix=new z,this._positionMatrix=new z,this._scalingRotationMatrix=new z,this._transformMatrix=new z,this._tempVector3=new x,this.notConnectedNonOptionalInputs=[],this.noContextualData=[],this.vertexData=null,this._geometryContext=null,this._executionContext=null,this._instancingContext=null,this._geometryContextStack=[],this._executionContextStack=[],this._instancingContextStack=[]}get geometryContext(){return this._geometryContext}get executionContext(){return this._executionContext}get instancingContext(){return this._instancingContext}pushGeometryContext(e){this._geometryContext=e,this._geometryContextStack.push(this._geometryContext)}pushExecutionContext(e){this._executionContext=e,this._executionContextStack.push(this._executionContext)}pushInstancingContext(e){this._instancingContext=e,this._instancingContextStack.push(this._instancingContext)}restoreGeometryContext(){this._geometryContextStack.pop(),this._geometryContext=this._geometryContextStack.length>0?this._geometryContextStack[this._geometryContextStack.length-1]:null}restoreExecutionContext(){this._executionContextStack.pop(),this._executionContext=this._executionContextStack.length>0?this._executionContextStack[this._executionContextStack.length-1]:null}restoreInstancingContext(){this._instancingContextStack.pop(),this._instancingContext=this._instancingContextStack.length>0?this._instancingContextStack[this._instancingContextStack.length-1]:null}getContextualValue(e,t=!1){if(!this.executionContext)return t||this.noContextualData.push(e),null;const i=this.executionContext.getExecutionIndex();switch(e){case Be.Positions:return this.executionContext.getOverridePositionsContextualValue?this.executionContext.getOverridePositionsContextualValue():!this.geometryContext||!this.geometryContext.positions?x.Zero():x.FromArray(this.geometryContext.positions,i*3);case Be.Normals:return this.executionContext.getOverrideNormalsContextualValue?this.executionContext.getOverrideNormalsContextualValue():!this.geometryContext||!this.geometryContext.normals?x.Zero():x.FromArray(this.geometryContext.normals,i*3);case Be.Colors:return!this.geometryContext||!this.geometryContext.colors?Ee.Zero():Ee.FromArray(this.geometryContext.colors,i*4);case Be.Tangents:return!this.geometryContext||!this.geometryContext.tangents?Ee.Zero():Ee.FromArray(this.geometryContext.tangents,i*4);case Be.UV:return this.executionContext.getOverrideUVs1ContextualValue?this.executionContext.getOverrideUVs1ContextualValue():!this.geometryContext||!this.geometryContext.uvs?X.Zero():X.FromArray(this.geometryContext.uvs,i*2);case Be.UV2:return!this.geometryContext||!this.geometryContext.uvs2?X.Zero():X.FromArray(this.geometryContext.uvs2,i*2);case Be.UV3:return!this.geometryContext||!this.geometryContext.uvs3?X.Zero():X.FromArray(this.geometryContext.uvs3,i*2);case Be.UV4:return!this.geometryContext||!this.geometryContext.uvs4?X.Zero():X.FromArray(this.geometryContext.uvs4,i*2);case Be.UV5:return!this.geometryContext||!this.geometryContext.uvs5?X.Zero():X.FromArray(this.geometryContext.uvs5,i*2);case Be.UV6:return!this.geometryContext||!this.geometryContext.uvs6?X.Zero():X.FromArray(this.geometryContext.uvs6,i*2);case Be.VertexID:return i;case Be.FaceID:return this.executionContext.getExecutionFaceIndex();case Be.LoopID:return this.executionContext.getExecutionLoopIndex();case Be.InstanceID:return this.instancingContext?this.instancingContext.getInstanceIndex():0;case Be.GeometryID:return this.geometryContext?this.geometryContext.uniqueId:0;case Be.CollectionID:return!this.geometryContext||!this.geometryContext.metadata?0:this.geometryContext.metadata.collectionId||0;case Be.LatticeID:return this.executionContext.getOverridePositionsContextualValue?this.executionContext.getOverridePositionsContextualValue():x.Zero();case Be.LatticeControl:return this.executionContext.getOverrideNormalsContextualValue?this.executionContext.getOverrideNormalsContextualValue():x.Zero()}return null}adapt(e,t){const i=e.getConnectedValue(this)||0;if(e.type===t)return i;switch(t){case b.Vector2:return new X(i,i);case b.Vector3:return new x(i,i,i);case b.Vector4:return new Ee(i,i,i,i)}return null}adaptInput(e,t,i){var n;if(!e.isConnected)return e.value||i;const r=e.getConnectedValue(this);if(((n=e._connectedPoint)==null?void 0:n.type)===t)return r;switch(t){case b.Vector2:return new X(r,r);case b.Vector3:return new x(r,r,r);case b.Vector4:return new Ee(r,r,r,r)}return null}emitErrors(){let e="";for(const t of this.notConnectedNonOptionalInputs)e+=`input ${t.name} from block ${t.ownerBlock.name}[${t.ownerBlock.getClassName()}] is not connected and is not optional.
`;for(const t of this.noContextualData)e+=`Contextual input ${Be[t]} has no context to pull data from (must be connected to a setXXX block or a instantiateXXX block).
`;if(e)throw`Build of NodeGeometry failed:
`+e}_instantiate(e,t,i,r,n){z.ScalingToRef(r.x,r.y,r.z,this._scalingMatrix),z.RotationYawPitchRollToRef(i.y,i.x,i.z,this._rotationMatrix),z.TranslationToRef(t.x,t.y,t.z,this._positionMatrix),this._scalingMatrix.multiplyToRef(this._rotationMatrix,this._scalingRotationMatrix),this._scalingRotationMatrix.multiplyToRef(this._positionMatrix,this._transformMatrix);for(let a=0;a<e.positions.length;a+=3)this._tempVector3.fromArray(e.positions,a),x.TransformCoordinatesToRef(this._tempVector3,this._transformMatrix,this._tempVector3),this._tempVector3.toArray(e.positions,a),e.normals&&(this._tempVector3.fromArray(e.normals,a),x.TransformNormalToRef(this._tempVector3,this._scalingRotationMatrix,this._tempVector3),this._tempVector3.toArray(e.normals,a));n.push(e)}_instantiateWithMatrix(e,t,i){for(let r=0;r<e.positions.length;r+=3)this._tempVector3.fromArray(e.positions,r),x.TransformCoordinatesToRef(this._tempVector3,t,this._tempVector3),this._tempVector3.toArray(e.positions,r),e.normals&&(this._tempVector3.fromArray(e.normals,r),x.TransformNormalToRef(this._tempVector3,t,this._tempVector3),this._tempVector3.toArray(e.normals,r));i.push(e)}_instantiateWithPositionAndMatrix(e,t,i,r){z.TranslationToRef(t.x,t.y,t.z,this._positionMatrix),i.multiplyToRef(this._positionMatrix,this._transformMatrix);for(let n=0;n<e.positions.length;n+=3)this._tempVector3.fromArray(e.positions,n),x.TransformCoordinatesToRef(this._tempVector3,this._transformMatrix,this._tempVector3),this._tempVector3.toArray(e.positions,n),e.normals&&(this._tempVector3.fromArray(e.normals,n),x.TransformNormalToRef(this._tempVector3,this._transformMatrix,this._tempVector3),this._tempVector3.toArray(e.normals,n));r.push(e)}}class qt extends de{get type(){if(this._type===b.AutoDetect&&this.value!=null){if(!isNaN(this.value))return this._type=b.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=b.Vector2,this._type;case"Vector3":return this._type=b.Vector3,this._type;case"Vector4":return this._type=b.Vector4,this._type;case"Matrix":return this._type=b.Matrix,this._type}}return this._type}get isContextual(){return this._contextualSource!==Be.None}get contextualValue(){return this._contextualSource}set contextualValue(e){switch(this._contextualSource=e,e){case Be.Positions:case Be.Normals:case Be.LatticeID:case Be.LatticeControl:this._type=b.Vector3;break;case Be.Colors:case Be.Tangents:this._type=b.Vector4;break;case Be.UV:case Be.UV2:case Be.UV3:case Be.UV4:case Be.UV5:case Be.UV6:this._type=b.Vector2;break;case Be.VertexID:case Be.GeometryID:case Be.CollectionID:case Be.FaceID:case Be.LoopID:case Be.InstanceID:this._type=b.Int;break}this.output&&(this.output.type=this._type)}constructor(e,t=b.AutoDetect){super(e),this._type=b.Undefined,this._contextualSource=Be.None,this.min=0,this.max=0,this.groupInInspector="",this.displayInInspector=!0,this.onValueChangedObservable=new k,this._type=t,this._isInput=!0,this.setDefaultValue(),this.registerOutput("output",t)}get value(){return this._storedValue}set value(e){this.type===b.Float&&this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e)),this._storedValue=e,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this._valueCallback}set valueCallback(e){this._valueCallback=e}getClassName(){return"GeometryInputBlock"}get output(){return this._outputs[0]}setDefaultValue(){switch(this.contextualValue=Be.None,this.type){case b.Int:case b.Float:this.value=0;break;case b.Vector2:this.value=X.Zero();break;case b.Vector3:this.value=x.Zero();break;case b.Vector4:this.value=Ee.Zero();break;case b.Matrix:this.value=z.Identity();break}}_buildBlock(e){super._buildBlock(e),this.isContextual?(this.output._storedValue=null,this.output._storedFunction=t=>t.getContextualValue(this._contextualSource)):(this.output._storedFunction=null,this.output._storedValue=this.value)}dispose(){this.onValueChangedObservable.clear(),super.dispose()}_dumpPropertiesCode(){const e=this._codeVariableName;if(this.isContextual)return super._dumpPropertiesCode()+`${e}.contextualValue = BABYLON.NodeGeometryContextualSources.${Be[this._contextualSource]};
`;const t=[];let i="";switch(this.type){case b.Float:case b.Int:i=`${this.value}`;break;case b.Vector2:i=`new BABYLON.Vector2(${this.value.x}, ${this.value.y})`;break;case b.Vector3:i=`new BABYLON.Vector3(${this.value.x}, ${this.value.y}, ${this.value.z})`;break;case b.Vector4:i=`new BABYLON.Vector4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;break}return t.push(`${e}.value = ${i}`),(this.type===b.Float||this.type===b.Int)&&t.push(`${e}.min = ${this.min}`,`${e}.max = ${this.max}`),t.push(""),super._dumpPropertiesCode()+t.join(`;
`)}serialize(){const e=super.serialize();return e.type=this.type,e.contextualValue=this.contextualValue,e.min=this.min,e.max=this.max,e.groupInInspector=this.groupInInspector,e.displayInInspector=this.displayInInspector,this._storedValue!==null&&!this.isContextual&&(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e}_deserialize(e){if(super._deserialize(e),this._type=e.type,this.contextualValue=e.contextualValue,this.min=e.min||0,this.max=e.max||0,this.groupInInspector=e.groupInInspector||"",e.displayInInspector!==void 0&&(this.displayInInspector=e.displayInInspector),!!e.valueType)if(e.valueType==="number")this._storedValue=e.value;else{const t=ki(e.valueType);t&&(this._storedValue=t.FromArray(e.value))}}}y("BABYLON.GeometryInputBlock",qt);class U_ extends de{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("size",b.Float,!0,1),this.registerInput("width",b.Float,!0,0),this.registerInput("height",b.Float,!0,0),this.registerInput("depth",b.Float,!0,0),this.registerInput("subdivisions",b.Int,!0,1,0),this.registerInput("subdivisionsX",b.Int,!0,0,0),this.registerInput("subdivisionsY",b.Int,!0,0,0),this.registerInput("subdivisionsZ",b.Int,!0,0,0),this.registerOutput("geometry",b.Geometry)}getClassName(){return"BoxBlock"}get size(){return this._inputs[0]}get width(){return this._inputs[1]}get height(){return this._inputs[2]}get depth(){return this._inputs[3]}get subdivisions(){return this._inputs[4]}get subdivisionsX(){return this._inputs[5]}get subdivisionsY(){return this._inputs[6]}get subdivisionsZ(){return this._inputs[7]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.size.isConnected){if(!this.width.isConnected&&!this.height.isConnected&&!this.depth.isConnected){const e=new qt("Size");e.value=1,e.output.connectTo(this.size);return}if(!this.width.isConnected){const e=new qt("Width");e.value=1,e.output.connectTo(this.width)}if(!this.height.isConnected){const e=new qt("Height");e.value=1,e.output.connectTo(this.height)}if(!this.depth.isConnected){const e=new qt("Depth");e.value=1,e.output.connectTo(this.depth)}}}_buildBlock(e){const t={},i=r=>{t.size=this.size.getConnectedValue(r),t.width=this.width.getConnectedValue(r),t.height=this.height.getConnectedValue(r),t.depth=this.depth.getConnectedValue(r);const n=this.subdivisions.getConnectedValue(r),a=this.subdivisionsX.getConnectedValue(r),o=this.subdivisionsY.getConnectedValue(r),l=this.subdivisionsZ.getConnectedValue(r);return n&&(t.segments=n),a&&(t.widthSegments=a),o&&(t.heightSegments=o),l&&(t.depthSegments=l),zD(t)};if(this.evaluateContext)this.geometry._storedFunction=i;else{const r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}_([O("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],U_.prototype,"evaluateContext",void 0);y("BABYLON.BoxBlock",U_);class mr{_getGlobalNodeGeometryEditor(){if(typeof NODEGEOMETRYEDITOR<"u")return NODEGEOMETRYEDITOR;if(typeof BABYLON<"u"&&typeof BABYLON.NodeGeometryEditor<"u")return BABYLON}get buildExecutionTime(){return this._buildExecutionTime}constructor(e){this._buildId=mr._BuildIdGenerator++,this._buildWasSuccessful=!1,this._vertexData=null,this._buildExecutionTime=0,this.BJSNODEGEOMETRYEDITOR=this._getGlobalNodeGeometryEditor(),this.editorData=null,this.attachedBlocks=[],this.onBuildObservable=new k,this.outputBlock=null,this.name=e}getClassName(){return"NodeGeometry"}get vertexData(){return this._vertexData}getBlockByName(e){let t=null;for(const i of this.attachedBlocks)if(i.name===e)if(!t)t=i;else return j.Warn("More than one block was found with the name `"+e+"`"),t;return t}getBlockByPredicate(e){for(const t of this.attachedBlocks)if(e(t))return t;return null}getInputBlocks(){const e=[];for(const t of this.attachedBlocks)t.isInput&&e.push(t);return e}async edit(e){return await new Promise(t=>{if(this.BJSNODEGEOMETRYEDITOR=this.BJSNODEGEOMETRYEDITOR||this._getGlobalNodeGeometryEditor(),typeof this.BJSNODEGEOMETRYEDITOR>"u"){const i=e&&e.editorURL?e.editorURL:mr.EditorURL;j.LoadBabylonScript(i,()=>{this.BJSNODEGEOMETRYEDITOR=this.BJSNODEGEOMETRYEDITOR||this._getGlobalNodeGeometryEditor(),this._createNodeEditor(e==null?void 0:e.nodeGeometryEditorConfig),t()})}else this._createNodeEditor(e==null?void 0:e.nodeGeometryEditorConfig),t()})}_createNodeEditor(e){const t={nodeGeometry:this,...e};this.BJSNODEGEOMETRYEDITOR.NodeGeometryEditor.Show(t)}build(e=!1,t=!0,i=!1){if(this._buildWasSuccessful=!1,!this.outputBlock)throw"You must define the outputBlock property before building the geometry";const r=Qr.Now;this._initializeBlock(this.outputBlock,i);const n=[];for(const o of this.attachedBlocks)o._isReadyState&&n.push(o._isReadyState);if(n.length){Promise.all(n).then(()=>{this.build(e,t,i)});return}const a=new eW;a.buildId=this._buildId,a.verbose=e;try{this.outputBlock.build(a)}finally{t&&(this._buildId=mr._BuildIdGenerator++)}this._buildExecutionTime=Qr.Now-r,a.emitErrors(),this._buildWasSuccessful=!0,this._vertexData=a.vertexData,this.onBuildObservable.notifyObservers(this)}createMesh(e,t=null){if(this._buildWasSuccessful||this.build(),!this._vertexData)return null;const i=new Oe(e,t);return this._vertexData.applyToMesh(i),i._internalMetadata=i._internalMetadata||{},i._internalMetadata.nodeGeometry=this,i}updateMesh(e){return this._buildWasSuccessful||this.build(),this._vertexData?(this._vertexData.applyToMesh(e),e._internalMetadata=e._internalMetadata||{},e._internalMetadata.nodeGeometry=this,e):!1}_initializeBlock(e,t=!0){e.initialize(),t&&e.autoConfigure(this),e._preparationId=this._buildId,this.attachedBlocks.indexOf(e)===-1&&this.attachedBlocks.push(e);for(const i of e.inputs){const r=i.connectedPoint;if(r){const n=r.ownerBlock;n!==e&&this._initializeBlock(n,t)}}}clear(){this.outputBlock=null,this.attachedBlocks.length=0}removeBlock(e){const t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e===this.outputBlock&&(this.outputBlock=null)}parseSerializedObject(e,t=!1){t||this.clear();const i={};for(const r of e.blocks){const n=ki(r.customType);if(n){const a=new n;a._deserialize(r),i[r.id]=a,this.attachedBlocks.push(a)}}for(const r of this.attachedBlocks)if(r.isTeleportOut){const n=r,a=n._tempEntryPointUniqueId;if(a){const o=i[a];o&&o.attachToEndpoint(n)}}for(let r=0;r<e.blocks.length;r++){const n=e.blocks[r],a=i[n.id];a&&(a.inputs.length&&n.inputs.some(o=>o.targetConnectionName)&&!t||this._restoreConnections(a,e,i))}if(e.outputNodeId&&(this.outputBlock=i[e.outputNodeId]),e.locations||e.editorData&&e.editorData.locations){const r=e.locations||e.editorData.locations;for(const a of r)i[a.blockId]&&(a.blockId=i[a.blockId].uniqueId);t&&this.editorData&&this.editorData.locations&&r.concat(this.editorData.locations),e.locations?this.editorData={locations:r}:(this.editorData=e.editorData,this.editorData.locations=r);const n={};for(const a in i)n[a]=i[a].uniqueId;this.editorData.map=n}this.comment=e.comment}_restoreConnections(e,t,i){for(const r of e.outputs)for(const n of t.blocks){const a=i[n.id];if(a){for(const o of n.inputs)if(i[o.targetBlockId]===e&&o.targetConnectionName===r.name){const l=a.getInputByName(o.inputName);if(!l||l.isConnected)continue;r.connectTo(l,!0),this._restoreConnections(a,t,i);continue}}}}generateCode(){let e=[];const t=[],i=["const","var","let"];this.outputBlock&&this._gatherBlocks(this.outputBlock,t);let r=`let nodeGeometry = new BABYLON.NodeGeometry("${this.name||"node geometry"}");
`;for(const n of t)n.isInput&&e.indexOf(n)===-1&&(r+=n._dumpCode(i,e));return this.outputBlock&&(e=[],r+=`// Connections
`,r+=this.outputBlock._dumpCodeForOutputConnections(e),r+=`// Output nodes
`,r+=`nodeGeometry.outputBlock = ${this.outputBlock._codeVariableName};
`,r+=`nodeGeometry.build();
`),r}_gatherBlocks(e,t){if(t.indexOf(e)===-1){t.push(e);for(const i of e.inputs){const r=i.connectedPoint;if(r){const n=r.ownerBlock;n!==e&&this._gatherBlocks(n,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._gatherBlocks(i.entryPoint,t)}}}setToDefault(){this.clear(),this.editorData=null;const e=new U_("Box");e.autoConfigure();const t=new p0("Geometry Output");e.geometry.connectTo(t.geometry),this.outputBlock=t}clone(e){const t=this.serialize(),i=me.Clone(()=>new mr(e),this);return i.name=e,i.parseSerializedObject(t),i._buildId=this._buildId,i.build(!1),i}serialize(e){const t=e?{}:me.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];e?i=e:(t.customType="BABYLON.NodeGeometry",this.outputBlock&&(t.outputNodeId=this.outputBlock.uniqueId)),t.blocks=[];for(const r of i)t.blocks.push(r.serialize());if(!e)for(const r of this.attachedBlocks)i.indexOf(r)===-1&&t.blocks.push(r.serialize());return t}dispose(){for(const e of this.attachedBlocks)e.dispose();this.attachedBlocks.length=0,this.onBuildObservable.clear()}static CreateDefault(e){const t=new mr(e);return t.setToDefault(),t.build(),t}static Parse(e){const t=me.Parse(()=>new mr(e.name),e,null);return t.parseSerializedObject(e),t.build(),t}static ParseFromSnippetAsync(e,t,i=!1){return e==="_BLANK"?Promise.resolve(mr.CreateDefault("blank")):new Promise((r,n)=>{const a=new dn;a.addEventListener("readystatechange",()=>{if(a.readyState==4)if(a.status==200){const o=JSON.parse(JSON.parse(a.responseText).jsonPayload),l=JSON.parse(o.nodeGeometry);t||(t=me.Parse(()=>new mr(e),l,null)),t.parseSerializedObject(l),t.snippetId=e;try{i||t.build(),r(t)}catch(c){n(c)}}else n("Unable to load the snippet "+e)}),a.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),a.send()})}}mr._BuildIdGenerator=0;mr.EditorURL=`${j._DefaultCdnUrl}/v${te.Version}/nodeGeometryEditor/babylon.nodeGeometryEditor.js`;mr.SnippetUrl="https://snippet.babylonjs.com";_([R()],mr.prototype,"name",void 0);_([R("comment")],mr.prototype,"comment",void 0);class Ph extends de{getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}constructor(e){super(e),this.evaluateContext=!0,this.epsilon=Ai,this.optimizeFaces=!1,this.registerInput("geometry",b.Geometry),this.registerInput("selector",b.Int,!0),this.registerOutput("output",b.Geometry)}getClassName(){return"GeometryOptimizeBlock"}get geometry(){return this._inputs[0]}get selector(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=i=>{if(!this.geometry.isConnected)return null;const r=this.geometry.getConnectedValue(i),n=[],a={},o=[];i.pushExecutionContext(this),i.pushGeometryContext(r);for(let h=0;h<r.positions.length;h+=3){if(this._currentIndex=h/3,this.selector.isConnected&&!this.selector.getConnectedValue(i))continue;const d=r.positions[h],f=r.positions[h+1],m=r.positions[h+2],g=h/3*2,v=r.uvs?r.uvs[g]:0,E=r.uvs?r.uvs[g+1]:0;let T=!1;for(let C=0;C<n.length;C+=3)if(fn(d,n[C],this.epsilon)&&fn(f,n[C+1],this.epsilon)&&fn(m,n[C+2],this.epsilon)){a[h/3]=C/3,T=!0;continue}T||(a[h/3]=n.length/3,n.push(d,f,m),o.push(v,E))}const l=new li;l.positions=n,r.uvs&&(l.uvs=o);const c=r.indices.map(h=>a[h]),u=[];if(this.optimizeFaces){for(let h=0;h<c.length;h+=3){const d=c[h],f=c[h+1],m=c[h+2];if(d===f||f==m||m===d)continue;let g=!1;for(let v=0;v<u.length;v+=3){if(d===u[v]&&f===u[v+1]&&m===u[v+2]){g=!0;continue}if(d===u[v+1]&&f===u[v+2]&&m===u[v]){g=!0;continue}if(d===u[v+2]&&f===u[v]&&m===u[v+1]){g=!0;continue}}g||u.push(d,f,m)}l.indices=u}else l.indices=c;return l};e.restoreGeometryContext(),e.restoreExecutionContext(),this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`;return e+=`${this._codeVariableName}.epsilon = ${this.epsilon};
`,e+=`${this._codeVariableName}.optimizeFaces = ${this.optimizeFaces?"true":"false"};
`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.epsilon=this.epsilon,e.optimizeFaces=this.optimizeFaces,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext,this.epsilon=e.epsilon,this.optimizeFaces=e.optimizeFaces}}_([O("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Ph.prototype,"evaluateContext",void 0);_([O("Epsilon",1,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Ph.prototype,"epsilon",void 0);_([O("Optimize faces",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Ph.prototype,"optimizeFaces",void 0);y("BABYLON.GeometryOptimizeBlock",Ph);class m0 extends de{constructor(e){super(e),this._rotationMatrix=new z,this.evaluateContext=!1,this.registerInput("size",b.Float,!0,1),this.registerInput("width",b.Float,!0,0),this.registerInput("height",b.Float,!0,0),this.registerInput("subdivisions",b.Int,!0,1,0),this.registerInput("subdivisionsX",b.Int,!0,0,0),this.registerInput("subdivisionsY",b.Int,!0,0,0),this.registerOutput("geometry",b.Geometry)}getClassName(){return"PlaneBlock"}get size(){return this._inputs[0]}get width(){return this._inputs[1]}get height(){return this._inputs[2]}get subdivisions(){return this._inputs[3]}get subdivisionsX(){return this._inputs[4]}get subdivisionsY(){return this._inputs[5]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.size.isConnected){if(!this.width.isConnected&&!this.height.isConnected){const e=new qt("Size");e.value=1,e.output.connectTo(this.size);return}if(!this.width.isConnected){const e=new qt("Width");e.value=1,e.output.connectTo(this.width)}if(!this.height.isConnected){const e=new qt("Height");e.value=1,e.output.connectTo(this.height)}}}_buildBlock(e){const t={},i=r=>{t.size=this.size.getConnectedValue(r),t.width=this.width.getConnectedValue(r),t.height=this.height.getConnectedValue(r);const n=this.subdivisions.getConnectedValue(r),a=this.subdivisionsX.getConnectedValue(r),o=this.subdivisionsY.getConnectedValue(r);n&&(t.subdivisions=n),a&&(t.subdivisionsX=a),o&&(t.subdivisionsY=o);const l=xI(t);return z.RotationYawPitchRollToRef(-Math.PI/2,0,Math.PI/2,this._rotationMatrix),l.transform(this._rotationMatrix),l};if(this.evaluateContext)this.geometry._storedFunction=i;else{const r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}_([O("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],m0.prototype,"evaluateContext",void 0);y("BABYLON.PlaneBlock",m0);class _0 extends de{get mesh(){return this._mesh}set mesh(e){this._mesh=e}constructor(e){super(e),this._cachedVertexData=null,this.reverseWindingOrder=!1,this.serializedCachedData=!1,this.registerOutput("geometry",b.Geometry)}getClassName(){return"MeshBlock"}get isUsingCachedData(){return!this.mesh&&!!this._cachedVertexData}get geometry(){return this._outputs[0]}cleanData(){this._mesh=null,this._cachedVertexData=null}_buildBlock(){if(!this._mesh){this._cachedVertexData?this.geometry._storedValue=this._cachedVertexData.clone():this.geometry._storedValue=null;return}const e=li.ExtractFromMesh(this._mesh,!1,!0);if(this._cachedVertexData=null,this.reverseWindingOrder&&e.indices)for(let t=0;t<e.indices.length;t+=3){const i=e.indices[t];e.indices[t]=e.indices[t+2],e.indices[t+2]=i}this.geometry._storedFunction=()=>e.clone()}serialize(){const e=super.serialize();return e.serializedCachedData=this.serializedCachedData,this.serializedCachedData&&(this._mesh?e.cachedVertexData=li.ExtractFromMesh(this._mesh,!1,!0).serialize():this._cachedVertexData&&(e.cachedVertexData=this._cachedVertexData.serialize())),e.reverseWindingOrder=this.reverseWindingOrder,e}_deserialize(e){super._deserialize(e),e.cachedVertexData&&(this._cachedVertexData=li.Parse(e.cachedVertexData)),this.serializedCachedData=!!e.serializedCachedData,this.reverseWindingOrder=e.reverseWindingOrder}}_([O("Serialize cached data",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],_0.prototype,"serializedCachedData",void 0);y("BABYLON.MeshBlock",_0);class g0 extends de{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("radius",b.Float,!0,1),this.registerInput("radiusX",b.Float,!0,0),this.registerInput("radiusY",b.Float,!0,0),this.registerInput("radiusZ",b.Float,!0,0),this.registerInput("subdivisions",b.Int,!0,4),this.registerOutput("geometry",b.Geometry)}getClassName(){return"IcoSphereBlock"}get radius(){return this._inputs[0]}get radiusX(){return this._inputs[1]}get radiusY(){return this._inputs[2]}get radiusZ(){return this._inputs[3]}get subdivisions(){return this._inputs[4]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.radius.isConnected){const e=new qt("Radius");e.value=.2,e.output.connectTo(this.radius)}}_buildBlock(e){const t={},i=r=>(t.radius=this.radius.getConnectedValue(r),t.subdivisions=this.subdivisions.getConnectedValue(r),t.radiusX=this.radiusX.getConnectedValue(r),t.radiusY=this.radiusY.getConnectedValue(r),t.radiusZ=this.radiusZ.getConnectedValue(r),WD(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}_([O("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],g0.prototype,"evaluateContext",void 0);y("BABYLON.IcoSphereBlock",g0);class S0 extends de{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("segments",b.Int,!0,32),this.registerInput("diameter",b.Float,!0,1),this.registerInput("diameterX",b.Float,!0,0),this.registerInput("diameterY",b.Float,!0,0),this.registerInput("diameterZ",b.Float,!0,0),this.registerInput("arc",b.Float,!0,1),this.registerInput("slice",b.Float,!0,1),this.registerOutput("geometry",b.Geometry)}getClassName(){return"SphereBlock"}get segments(){return this._inputs[0]}get diameter(){return this._inputs[1]}get diameterX(){return this._inputs[2]}get diameterY(){return this._inputs[3]}get diameterZ(){return this._inputs[4]}get arc(){return this._inputs[5]}get slice(){return this._inputs[6]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.diameter.isConnected){const e=new qt("Diameter");e.value=1,e.output.connectTo(this.diameter)}}_buildBlock(e){const t={},i=r=>(t.segments=this.segments.getConnectedValue(r),t.diameter=this.diameter.getConnectedValue(r),t.diameterX=this.diameterX.getConnectedValue(r),t.diameterY=this.diameterY.getConnectedValue(r),t.diameterZ=this.diameterZ.getConnectedValue(r),t.arc=this.arc.getConnectedValue(r),t.slice=this.slice.getConnectedValue(r),HD(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}_([O("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],S0.prototype,"evaluateContext",void 0);y("BABYLON.SphereBlock",S0);class v0 extends de{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("width",b.Float,!0,1),this.registerInput("height",b.Float,!0,1),this.registerInput("subdivisions",b.Int,!0,1,0),this.registerInput("subdivisionsX",b.Int,!0,0,0),this.registerInput("subdivisionsY",b.Int,!0,0,0),this.registerOutput("geometry",b.Geometry)}getClassName(){return"GridBlock"}get width(){return this._inputs[0]}get height(){return this._inputs[1]}get subdivisions(){return this._inputs[2]}get subdivisionsX(){return this._inputs[3]}get subdivisionsY(){return this._inputs[4]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.width.isConnected){const e=new qt("Width");e.value=1,e.output.connectTo(this.width)}if(!this.height.isConnected){const e=new qt("Height");e.value=1,e.output.connectTo(this.height)}}_buildBlock(e){const t={},i=r=>(t.width=this.width.getConnectedValue(r),t.height=this.height.getConnectedValue(r),t.subdivisions=this.subdivisions.getConnectedValue(r),t.subdivisionsX=this.subdivisionsX.getConnectedValue(r),t.subdivisionsY=this.subdivisionsY.getConnectedValue(r),xI(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}_([O("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],v0.prototype,"evaluateContext",void 0);y("BABYLON.GridBlock",v0);class x0 extends de{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("diameter",b.Float,!0,1),this.registerInput("thickness",b.Float,!0,.5),this.registerInput("tessellation",b.Int,!0,16),this.registerOutput("geometry",b.Geometry)}getClassName(){return"TorusBlock"}get diameter(){return this._inputs[0]}get thickness(){return this._inputs[1]}get tessellation(){return this._inputs[2]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.diameter.isConnected){const e=new qt("Diameter");e.value=1,e.output.connectTo(this.diameter)}}_buildBlock(e){const t={},i=r=>(t.thickness=this.thickness.getConnectedValue(r),t.diameter=this.diameter.getConnectedValue(r),t.tessellation=this.tessellation.getConnectedValue(r),$D(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}_([O("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],x0.prototype,"evaluateContext",void 0);y("BABYLON.TorusBlock",x0);class E0 extends de{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("height",b.Float,!0,25),this.registerInput("diameter",b.Float,!0,1),this.registerInput("diameterTop",b.Float,!0,-1),this.registerInput("diameterBottom",b.Float,!0,-1),this.registerInput("subdivisions",b.Int,!0,1),this.registerInput("tessellation",b.Int,!0,24),this.registerInput("arc",b.Float,!0,1),this.registerOutput("geometry",b.Geometry)}getClassName(){return"CylinderBlock"}get height(){return this._inputs[0]}get diameter(){return this._inputs[1]}get diameterTop(){return this._inputs[2]}get diameterBottom(){return this._inputs[3]}get subdivisions(){return this._inputs[4]}get tessellation(){return this._inputs[5]}get arc(){return this._inputs[6]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.diameter.isConnected){const e=new qt("Diameter");e.value=1,e.output.connectTo(this.diameter)}if(!this.height.isConnected){const e=new qt("Height");e.value=1,e.output.connectTo(this.height)}}_buildBlock(e){const t={},i=r=>(t.height=this.height.getConnectedValue(r),t.diameter=this.diameter.getConnectedValue(r),t.diameterTop=this.diameterTop.getConnectedValue(r),t.diameterBottom=this.diameterBottom.getConnectedValue(r),t.diameterTop===-1&&(t.diameterTop=t.diameter),t.diameterBottom===-1&&(t.diameterBottom=t.diameter),t.tessellation=this.tessellation.getConnectedValue(r),t.subdivisions=this.subdivisions.getConnectedValue(r),t.arc=this.arc.getConnectedValue(r),XD(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}_([O("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],E0.prototype,"evaluateContext",void 0);y("BABYLON.CylinderBlock",E0);class T0 extends de{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("height",b.Float,!0,1),this.registerInput("radius",b.Float,!0,.25),this.registerInput("tessellation",b.Int,!0,16),this.registerInput("subdivisions",b.Int,!0,2),this.registerOutput("geometry",b.Geometry)}getClassName(){return"CapsuleBlock"}get height(){return this._inputs[0]}get radius(){return this._inputs[1]}get tessellation(){return this._inputs[2]}get subdivisions(){return this._inputs[3]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.height.isConnected){const e=new qt("Height");e.value=1,e.output.connectTo(this.height)}if(!this.radius.isConnected){const e=new qt("Radius");e.value=.2,e.output.connectTo(this.radius)}}_buildBlock(e){const t={},i=r=>(t.height=this.height.getConnectedValue(r),t.radius=this.radius.getConnectedValue(r),t.tessellation=this.tessellation.getConnectedValue(r),t.subdivisions=this.subdivisions.getConnectedValue(r),YD(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}_([O("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],T0.prototype,"evaluateContext",void 0);y("BABYLON.CapsuleBlock",T0);class b0 extends de{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("radius",b.Float,!0,.5),this.registerInput("tessellation",b.Int,!0,64),this.registerInput("arc",b.Float,!0,1),this.registerOutput("geometry",b.Geometry)}getClassName(){return"DiscBlock"}get radius(){return this._inputs[0]}get tessellation(){return this._inputs[1]}get arc(){return this._inputs[2]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.radius.isConnected){const e=new qt("Radius");e.value=.2,e.output.connectTo(this.radius)}}_buildBlock(e){const t={},i=r=>(t.radius=this.radius.getConnectedValue(r),t.tessellation=this.tessellation.getConnectedValue(r),t.arc=this.arc.getConnectedValue(r),jD(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}_([O("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],b0.prototype,"evaluateContext",void 0);y("BABYLON.DiscBlock",b0);class tW extends de{constructor(e){super(e),this.registerOutput("geometry",b.Geometry),this.registerOutput("vector",b.Vector3)}getClassName(){return"NullBlock"}get geometry(){return this._outputs[0]}get vector(){return this._outputs[1]}_buildBlock(){this.geometry._storedValue=null,this.vector._storedValue=null}}y("BABYLON.NullBlock",tW);class iW extends de{constructor(e){super(e),this.points=[],this.registerOutput("geometry",b.Geometry)}getClassName(){return"PointListBlock"}get geometry(){return this._outputs[0]}_buildBlock(e){this.geometry._storedFunction=()=>{if(this.geometry._executionCount=1,this.points.length===0)return null;const t=new li;return t.positions=this.points.reduce((i,r)=>(i.push(r.x,r.y,r.z),i),[]),t}}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.points = [];
`;for(let t=0;t<this.points.length;t++){const i=this.points[t];e+=`${this._codeVariableName}.points.push(new BABYLON.Vector3(${i.x}, ${i.y}, ${i.z}));
`}return e}serialize(){const e=super.serialize();return e.points=this.points.map(t=>t.asArray()),e}_deserialize(e){super._deserialize(e),this.points=e.points.map(t=>x.FromArray(t))}}y("BABYLON.PointListBlock",iW);class C0 extends de{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",b.Geometry),this.registerInput("positions",b.Vector3),this.registerOutput("output",b.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetPositionsBlock"}get geometry(){return this._inputs[0]}get positions(){return this._inputs[1]}get output(){return this._outputs[0]}_remapVector3Data(e,t){const i=[];for(let r=0;r<e.length;r+=3)t[r/3]!==void 0&&i.push(e[r],e[r+1],e[r+2]);return i}_remapVector4Data(e,t){const i=[];for(let r=0;r<e.length;r+=4)t[r/4]!==void 0&&i.push(e[r],e[r+1],e[r+2],e[r+3]);return i}_remapVector2Data(e,t){const i=[];for(let r=0;r<e.length;r+=2)t[r/2]!==void 0&&i.push(e[r],e[r+1]);return i}_buildBlock(e){const t=i=>{if(i.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(i),this._vertexData&&(this._vertexData=this._vertexData.clone()),i.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions||!this.positions.isConnected){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=null;return}const r={},n=this._vertexData.positions.length/3,a=[];let o=0,l=!1;for(this._currentIndex=0;this._currentIndex<n;this._currentIndex++){const c=this.positions.getConnectedValue(i);c?(c.toArray(a,o*3),r[this._currentIndex]=o,o++):l=!0}if(l){if(this._vertexData.indices){const c=[];for(let u=0;u<this._vertexData.indices.length;u+=3){const h=this._vertexData.indices[u],d=this._vertexData.indices[u+1],f=this._vertexData.indices[u+2],m=r[h],g=r[d],v=r[f];m!==void 0&&g!==void 0&&v!==void 0&&(c.push(m),c.push(g),c.push(v))}this._vertexData.indices=c}this._vertexData.normals&&(this._vertexData.normals=this._remapVector3Data(this._vertexData.normals,r)),this._vertexData.tangents&&(this._vertexData.tangents=this._remapVector4Data(this._vertexData.tangents,r)),this._vertexData.colors&&(this._vertexData.colors=this._remapVector4Data(this._vertexData.colors,r)),this._vertexData.uvs&&(this._vertexData.uvs=this._remapVector2Data(this._vertexData.uvs,r)),this._vertexData.uvs2&&(this._vertexData.uvs2=this._remapVector2Data(this._vertexData.uvs2,r)),this._vertexData.uvs3&&(this._vertexData.uvs3=this._remapVector2Data(this._vertexData.uvs3,r)),this._vertexData.uvs4&&(this._vertexData.uvs4=this._remapVector2Data(this._vertexData.uvs4,r)),this._vertexData.uvs5&&(this._vertexData.uvs5=this._remapVector2Data(this._vertexData.uvs5,r)),this._vertexData.uvs6&&(this._vertexData.uvs6=this._remapVector2Data(this._vertexData.uvs6,r))}return this._vertexData.positions=a,i.restoreGeometryContext(),i.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}}_([O("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],C0.prototype,"evaluateContext",void 0);y("BABYLON.SetPositionsBlock",C0);class y0 extends de{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",b.Geometry),this.registerInput("normals",b.Vector3),this.registerOutput("output",b.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetNormalsBlock"}get geometry(){return this._inputs[0]}get normals(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=i=>{if(i.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(i),this._vertexData&&(this._vertexData=this._vertexData.clone()),i.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=null;return}if(!this.normals.isConnected){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=this._vertexData;return}this._vertexData.normals||(this._vertexData.normals=[]);const r=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<r;this._currentIndex++){const n=this.normals.getConnectedValue(i);n&&n.toArray(this._vertexData.normals,this._currentIndex*3)}return i.restoreGeometryContext(),i.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}}_([O("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],y0.prototype,"evaluateContext",void 0);y("BABYLON.SetNormalsBlock",y0);class k_ extends de{constructor(e){super(e),this.evaluateContext=!0,this.textureCoordinateIndex=0,this.registerInput("geometry",b.Geometry),this.registerInput("uvs",b.Vector2),this.registerOutput("output",b.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetUVsBlock"}get geometry(){return this._inputs[0]}get uvs(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=i=>{if(i.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(i),this._vertexData&&(this._vertexData=this._vertexData.clone()),i.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=null;return}if(!this.uvs.isConnected){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=this._vertexData;return}const r=[],n=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<n;this._currentIndex++){const a=this.uvs.getConnectedValue(i);a&&a.toArray(r,this._currentIndex*2)}switch(this.textureCoordinateIndex){case 0:this._vertexData.uvs=r;break;case 1:this._vertexData.uvs2=r;break;case 2:this._vertexData.uvs3=r;break;case 3:this._vertexData.uvs4=r;break;case 4:this._vertexData.uvs5=r;break;case 5:this._vertexData.uvs6=r;break}return i.restoreGeometryContext(),i.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.textureCoordinateIndex};
`;return e+=`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.textureCoordinateIndex=this.textureCoordinateIndex,e}_deserialize(e){super._deserialize(e),this.textureCoordinateIndex=e.textureCoordinateIndex,e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}}_([O("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],k_.prototype,"evaluateContext",void 0);_([O("Texture coordinates index",5,"ADVANCED",{notifiers:{update:!0},embedded:!0,options:[{label:"UV1",value:0},{label:"UV2",value:1},{label:"UV3",value:2},{label:"UV4",value:3},{label:"UV5",value:4},{label:"UV6",value:5}]})],k_.prototype,"textureCoordinateIndex",void 0);y("BABYLON.SetUVsBlock",k_);class I0 extends de{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",b.Geometry),this.registerInput("colors",b.AutoDetect),this.registerOutput("output",b.Geometry),this._inputs[1].excludedConnectionPointTypes.push(b.Int),this._inputs[1].excludedConnectionPointTypes.push(b.Float),this._inputs[1].excludedConnectionPointTypes.push(b.Vector2),this._inputs[1].excludedConnectionPointTypes.push(b.Texture),this._inputs[1].excludedConnectionPointTypes.push(b.Texture)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetColorsBlock"}get geometry(){return this._inputs[0]}get colors(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=i=>{var n;if(i.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(i),this._vertexData&&(this._vertexData=this._vertexData.clone()),i.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=null;return}if(!this.colors.isConnected){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=this._vertexData;return}this._vertexData.colors||(this._vertexData.colors=[]);const r=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<r;this._currentIndex++)if(((n=this.colors.connectedPoint)==null?void 0:n.type)===b.Vector3){const a=this.colors.getConnectedValue(i);a&&(a.toArray(this._vertexData.colors,this._currentIndex*4),this._vertexData.colors[this._currentIndex*4+3]=1,this._vertexData.hasVertexAlpha=!1)}else{const a=this.colors.getConnectedValue(i);a&&(a.toArray(this._vertexData.colors,this._currentIndex*4),this._vertexData.hasVertexAlpha=!0)}return i.restoreGeometryContext(),i.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}}_([O("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],I0.prototype,"evaluateContext",void 0);y("BABYLON.SetColorsBlock",I0);class R0 extends de{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",b.Geometry),this.registerInput("tangents",b.Vector4),this.registerOutput("output",b.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetTangentsBlock"}get geometry(){return this._inputs[0]}get tangents(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=i=>{if(i.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(i),this._vertexData&&(this._vertexData=this._vertexData.clone()),i.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=null;return}if(!this.tangents.isConnected){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=this._vertexData;return}this._vertexData.tangents||(this._vertexData.tangents=[]);const r=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<r;this._currentIndex++){const n=this.tangents.getConnectedValue(i);n&&n.toArray(this._vertexData.tangents,this._currentIndex*4)}return i.restoreGeometryContext(),i.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}}_([O("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],R0.prototype,"evaluateContext",void 0);y("BABYLON.SetTangentsBlock",R0);var $i;(function(s){s[s.Add=0]="Add",s[s.Subtract=1]="Subtract",s[s.Multiply=2]="Multiply",s[s.Divide=3]="Divide",s[s.Max=4]="Max",s[s.Min=5]="Min"})($i||($i={}));class A0 extends de{constructor(e){super(e),this.operation=$i.Add,this.registerInput("left",b.AutoDetect),this.registerInput("right",b.AutoDetect),this.registerOutput("output",b.BasedOnInput),this.output._typeConnectionSource=this.left;const t=[b.Matrix,b.Geometry,b.Texture];this.left.excludedConnectionPointTypes.push(...t),this.right.excludedConnectionPointTypes.push(...t),this._linkConnectionTypes(0,1),this._connectionObservers=[this.left.onConnectionObservable.add(()=>this._updateInputOutputTypes()),this.left.onDisconnectionObservable.add(()=>this._updateInputOutputTypes()),this.right.onConnectionObservable.add(()=>this._updateInputOutputTypes()),this.right.onDisconnectionObservable.add(()=>this._updateInputOutputTypes())]}getClassName(){return"MathBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){let e;const t=this.left,i=this.right;if(!t.isConnected||!i.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}const r=t.type===b.Float||t.type===b.Int,n=i.type===b.Float||i.type===b.Int,a=r&&n;switch(this.operation){case $i.Add:{a?e=o=>t.getConnectedValue(o)+i.getConnectedValue(o):r?e=o=>o.adapt(t,i.type).add(i.getConnectedValue(o)):e=o=>t.getConnectedValue(o).add(o.adapt(i,t.type));break}case $i.Subtract:{a?e=o=>t.getConnectedValue(o)-i.getConnectedValue(o):r?e=o=>o.adapt(t,i.type).subtract(i.getConnectedValue(o)):e=o=>t.getConnectedValue(o).subtract(o.adapt(i,t.type));break}case $i.Multiply:{a?e=o=>t.getConnectedValue(o)*i.getConnectedValue(o):r?e=o=>o.adapt(t,i.type).multiply(i.getConnectedValue(o)):e=o=>t.getConnectedValue(o).multiply(o.adapt(i,t.type));break}case $i.Divide:{a?e=o=>t.getConnectedValue(o)/i.getConnectedValue(o):r?e=o=>o.adapt(t,i.type).divide(i.getConnectedValue(o)):e=o=>t.getConnectedValue(o).divide(o.adapt(i,t.type));break}case $i.Min:{if(a)e=o=>Math.min(t.getConnectedValue(o),i.getConnectedValue(o));else{const[o,l]=r?[i,t]:[t,i];switch(o.type){case b.Vector2:{e=c=>X.Minimize(o.getConnectedValue(c),c.adapt(l,o.type));break}case b.Vector3:{e=c=>x.Minimize(o.getConnectedValue(c),c.adapt(l,o.type));break}case b.Vector4:{e=c=>Ee.Minimize(o.getConnectedValue(c),c.adapt(l,o.type));break}}}break}case $i.Max:if(a)e=o=>Math.max(t.getConnectedValue(o),i.getConnectedValue(o));else{const[o,l]=r?[i,t]:[t,i];switch(o.type){case b.Vector2:{e=c=>X.Maximize(o.getConnectedValue(c),c.adapt(l,o.type));break}case b.Vector3:{e=c=>x.Maximize(o.getConnectedValue(c),c.adapt(l,o.type));break}case b.Vector4:{e=c=>Ee.Maximize(o.getConnectedValue(c),c.adapt(l,o.type));break}}break}}this.output._storedFunction=o=>t.type===b.Int?e(o)|0:e(o)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.MathBlockOperations.${$i[this.operation]};
`}_updateInputOutputTypes(){if(this.output._typeConnectionSource=this.left,this.left.isConnected&&this.right.isConnected?(this.left.type===b.Int||this.left.type===b.Float&&this.right.type!==b.Int)&&(this.output._typeConnectionSource=this.right):this.left.isConnected!==this.right.isConnected&&(this.output._typeConnectionSource=this.left.isConnected?this.left:this.right),this.left.isConnected||this.right.isConnected)for(const[e,t]of[[this.left,this.right],[this.right,this.left]])e.acceptedConnectionPointTypes=[b.Int,b.Float],t.isConnected&&(e.acceptedConnectionPointTypes.push(t.type),(t.type===b.Int||t.type===b.Float)&&e.acceptedConnectionPointTypes.push(b.Vector2,b.Vector3,b.Vector4))}dispose(){super.dispose();for(const e of this._connectionObservers)e.remove();this._connectionObservers.length=0}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e){super._deserialize(e),this.operation=e.operation}}_([O("Operation",5,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Add",value:$i.Add},{label:"Subtract",value:$i.Subtract},{label:"Multiply",value:$i.Multiply},{label:"Divide",value:$i.Divide},{label:"Max",value:$i.Max},{label:"Min",value:$i.Min}]})],A0.prototype,"operation",void 0);y("BABYLON.MathBlock",A0);class rW extends de{constructor(e){super(e),this.registerInput("value",b.AutoDetect),this.registerInput("fromMin",b.Float,!0,0),this.registerInput("fromMax",b.Float,!0,1),this.registerInput("toMin",b.Float,!0,0),this.registerInput("toMax",b.Float,!0,1),this.registerOutput("output",b.BasedOnInput),this._inputs[0].excludedConnectionPointTypes.push(b.Vector2),this._inputs[0].excludedConnectionPointTypes.push(b.Vector3),this._inputs[0].excludedConnectionPointTypes.push(b.Vector4),this._inputs[0].excludedConnectionPointTypes.push(b.Matrix),this._inputs[0].excludedConnectionPointTypes.push(b.Geometry),this._inputs[0].excludedConnectionPointTypes.push(b.Texture),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"MapRangeBlock"}get value(){return this._inputs[0]}get fromMin(){return this._inputs[1]}get fromMax(){return this._inputs[2]}get toMin(){return this._inputs[3]}get toMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}this.output._storedFunction=e=>{const t=this.value.getConnectedValue(e),i=this.fromMin.getConnectedValue(e),r=this.fromMax.getConnectedValue(e),n=this.toMin.getConnectedValue(e),a=this.toMax.getConnectedValue(e),o=(t-i)/(r-i)*(a-n)+n;return this.output.type===b.Int?Math.floor(o):o}}}y("BABYLON.MapRangeBlock",rW);var oi;(function(s){s[s.Equal=0]="Equal",s[s.NotEqual=1]="NotEqual",s[s.LessThan=2]="LessThan",s[s.GreaterThan=3]="GreaterThan",s[s.LessOrEqual=4]="LessOrEqual",s[s.GreaterOrEqual=5]="GreaterOrEqual",s[s.Xor=6]="Xor",s[s.Or=7]="Or",s[s.And=8]="And"})(oi||(oi={}));class G_ extends de{constructor(e){super(e),this.test=oi.Equal,this.epsilon=0,this.registerInput("left",b.Float),this.registerInput("right",b.Float,!0,0),this.registerInput("ifTrue",b.AutoDetect,!0,1),this.registerInput("ifFalse",b.AutoDetect,!0,0),this.registerOutput("output",b.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[2],this._outputs[0]._defaultConnectionPointType=b.Float,this._inputs[0].acceptedConnectionPointTypes.push(b.Int),this._inputs[1].acceptedConnectionPointTypes.push(b.Int),this._linkConnectionTypes(2,3)}getClassName(){return"ConditionBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get ifTrue(){return this._inputs[2]}get ifFalse(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(e){if(!this.ifTrue.isConnected){const t=e.getBlockByPredicate(i=>i.isInput&&i.value===1&&i.name==="True")||new qt("True");t.value=1,t.output.connectTo(this.ifTrue)}if(!this.ifFalse.isConnected){const t=e.getBlockByPredicate(i=>i.isInput&&i.value===0&&i.name==="False")||new qt("False");t.value=0,t.output.connectTo(this.ifFalse)}}_buildBlock(){if(!this.left.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}const e=t=>{const i=this.left.getConnectedValue(t),r=this.right.getConnectedValue(t);let n=!1;switch(this.test){case oi.Equal:n=fn(i,r,this.epsilon);break;case oi.NotEqual:n=!fn(i,r,this.epsilon);break;case oi.LessThan:n=i<r+this.epsilon;break;case oi.GreaterThan:n=i>r-this.epsilon;break;case oi.LessOrEqual:n=i<=r+this.epsilon;break;case oi.GreaterOrEqual:n=i>=r-this.epsilon;break;case oi.Xor:n=!!i&&!r||!i&&!!r;break;case oi.Or:n=!!i||!!r;break;case oi.And:n=!!i&&!!r;break}return n};this.output._storedFunction=t=>e(t)?this.ifTrue.getConnectedValue(t):this.ifFalse.getConnectedValue(t)}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.test = BABYLON.ConditionBlockTests.${oi[this.test]};
`;return e+=`${this._codeVariableName}.epsilon = ${this.epsilon};
`,e}serialize(){const e=super.serialize();return e.test=this.test,e.epsilon=this.epsilon,e}_deserialize(e){super._deserialize(e),this.test=e.test,e.epsilon!==void 0&&(this.epsilon=e.epsilon)}}_([O("Test",5,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Equal",value:oi.Equal},{label:"NotEqual",value:oi.NotEqual},{label:"LessThan",value:oi.LessThan},{label:"GreaterThan",value:oi.GreaterThan},{label:"LessOrEqual",value:oi.LessOrEqual},{label:"GreaterOrEqual",value:oi.GreaterOrEqual},{label:"Xor",value:oi.Xor},{label:"Or",value:oi.Or},{label:"And",value:oi.And}]})],G_.prototype,"test",void 0);_([O("Epsilon",1,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],G_.prototype,"epsilon",void 0);y("BABYLON.ConditionBlock",G_);var Or;(function(s){s[s.None=0]="None",s[s.LoopID=1]="LoopID",s[s.InstanceID=2]="InstanceID",s[s.Once=3]="Once"})(Or||(Or={}));class P0 extends de{constructor(e){super(e),this._currentLockId=-1,this.lockMode=Or.None,this.registerInput("min",b.AutoDetect),this.registerInput("max",b.AutoDetect),this.registerOutput("output",b.BasedOnInput),this._inputs[0].excludedConnectionPointTypes.push(b.Matrix),this._inputs[0].excludedConnectionPointTypes.push(b.Geometry),this._inputs[0].excludedConnectionPointTypes.push(b.Texture),this._inputs[1].excludedConnectionPointTypes.push(b.Matrix),this._inputs[1].excludedConnectionPointTypes.push(b.Geometry),this._inputs[1].excludedConnectionPointTypes.push(b.Texture),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"RandomBlock"}get min(){return this._inputs[0]}get max(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(){if(!this.min.isConnected){const e=new qt("Min");e.value=0,e.output.connectTo(this.min)}if(!this.max.isConnected){const e=new qt("Max");e.value=1,e.output.connectTo(this.max)}}_buildBlock(){let e=null;switch(this._currentLockId=-1,this.min.type){case b.Int:case b.Float:{e=t=>{const i=this.min.getConnectedValue(t)||0,r=this.max.getConnectedValue(t)||0;return i+Math.random()*(r-i)};break}case b.Vector2:{e=t=>{const i=this.min.getConnectedValue(t)||X.Zero(),r=this.max.getConnectedValue(t)||X.Zero();return new X(i.x+Math.random()*(r.x-i.x),i.y+Math.random()*(r.y-i.y))};break}case b.Vector3:{e=t=>{const i=this.min.getConnectedValue(t)||x.Zero(),r=this.max.getConnectedValue(t)||x.Zero();return new x(i.x+Math.random()*(r.x-i.x),i.y+Math.random()*(r.y-i.y),i.z+Math.random()*(r.z-i.z))};break}case b.Vector4:{e=t=>{const i=this.min.getConnectedValue(t)||Ee.Zero(),r=this.max.getConnectedValue(t)||Ee.Zero();return new Ee(i.x+Math.random()*(r.x-i.x),i.y+Math.random()*(r.y-i.y),i.z+Math.random()*(r.z-i.z),i.w+Math.random()*(r.w-i.w))};break}}this.lockMode===Or.None||!e?this.output._storedFunction=e:this.output._storedFunction=t=>{let i=0;switch(this.lockMode){case Or.InstanceID:i=t.getContextualValue(Be.InstanceID,!0)||0;break;case Or.LoopID:i=t.getContextualValue(Be.LoopID,!0)||0;break;case Or.Once:i=t.buildId||0;break}return(this._currentLockId!==i||this.lockMode===Or.None)&&(this._currentLockId=i,this.output._storedValue=e(t)),this.output._storedValue}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.lockMode = BABYLON.RandomBlockLocks.${Or[this.lockMode]};
`}serialize(){const e=super.serialize();return e.lockMode=this.lockMode,e}_deserialize(e){super._deserialize(e),this.lockMode=e.lockMode}}_([O("LockMode",5,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"None",value:Or.None},{label:"LoopID",value:Or.LoopID},{label:"InstanceID",value:Or.InstanceID},{label:"Once",value:Or.Once}]})],P0.prototype,"lockMode",void 0);y("BABYLON.RandomBlock",P0);class sW extends de{constructor(e){super(e),this.registerInput("offset",b.Vector3,!0,x.Zero()),this.registerInput("scale",b.Float,!0,1),this.registerInput("octaves",b.Float,!0,2,0,16),this.registerInput("roughness",b.Float,!0,.5,0,1),this.registerOutput("output",b.Float)}getClassName(){return"NoiseBlock"}get offset(){return this._inputs[0]}get scale(){return this._inputs[1]}get octaves(){return this._inputs[2]}get roughness(){return this._inputs[3]}get output(){return this._outputs[0]}_negateIf(e,t){return t!==0?-e:e}_noiseGrad(e,t,i,r){const n=e&15,a=n<8?t:i,o=n===12||n==14?t:r,l=n<4?i:o;return this._negateIf(a,n&a)+this._negateIf(l,n&2)}_fade(e){return e*e*e*(e*(e*6-15)+10)}_hashBitRotate(e,t){return e<<t|e>>32-t}_hash(e,t,i){let r,n,a;return r=n=a=3735928559+12+13,a+=i,n+=t,r+=e,a^=n,a-=this._hashBitRotate(n,14),r^=a,r-=this._hashBitRotate(a,11),n^=r,n-=this._hashBitRotate(r,25),a^=n,a-=this._hashBitRotate(n,16),r^=a,r-=this._hashBitRotate(a,4),n^=r,n-=this._hashBitRotate(r,14),a^=n,a-=this._hashBitRotate(n,24),a}_mix(e,t,i,r,n,a,o,l,c,u,h){const d=1-c,f=1-u;return(1-h)*(f*(e*d+t*c)+u*(i*d+r*c))+h*(f*(n*d+a*c)+u*(o*d+l*c))}_perlinNoise(e){const t=(e.x|0)-(e.x<0?1:0),i=(e.y|0)-(e.y<0?1:0),r=(e.z|0)-(e.z<0?1:0),n=e.x-t,a=e.y-i,o=e.z-r,l=this._fade(n),c=this._fade(a),u=this._fade(o);return this._mix(this._noiseGrad(this._hash(t,i,r),n,a,o),this._noiseGrad(this._hash(t+1,i,r),n-1,a,o),this._noiseGrad(this._hash(t,i+1,r),n,a-1,o),this._noiseGrad(this._hash(t+1,i+1,r),n-1,a-1,o),this._noiseGrad(this._hash(t,i,r+1),n,a,o-1),this._noiseGrad(this._hash(t+1,i,r+1),n-1,a,o-1),this._noiseGrad(this._hash(t,i+1,r+1),n,a-1,o-1),this._noiseGrad(this._hash(t+1,i+1,r+1),n-1,a-1,o-1),l,c,u)}_perlinSigned(e){return this._perlinNoise(e)*.982}_perlin(e){return this._perlinSigned(e)/2+.5}noise(e,t,i,r,n){const a=new x(i.x*n+r.x,i.y*n+r.y,i.z*n+r.z);let o=1,l=1,c=0,u=0;e=ls(e,0,15);const h=e|0;for(let g=0;g<=h;g++){const v=this._perlin(a.scale(o));u+=v*l,c+=l,l*=ls(t,0,1),o*=2}const d=e-Math.floor(e);if(d==0)return u/c;const f=this._perlin(a.scale(o));let m=u+f*l;return u/=c,m/=c+l,(1-d)*u+d*m}_buildBlock(){this.output._storedFunction=e=>{const t=e.getContextualValue(Be.Positions),i=this.octaves.getConnectedValue(e),r=this.roughness.getConnectedValue(e),n=this.offset.getConnectedValue(e),a=this.scale.getConnectedValue(e);return this.noise(i,r,t,n,a)}}}y("BABYLON.NoiseBlock",sW);class O0 extends de{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("geometry0",b.Geometry),this.registerInput("geometry1",b.Geometry,!0),this.registerInput("geometry2",b.Geometry,!0),this.registerInput("geometry3",b.Geometry,!0),this.registerInput("geometry4",b.Geometry,!0),this.registerOutput("output",b.Geometry)}getClassName(){return"MergeGeometryBlock"}get geometry0(){return this._inputs[0]}get geometry1(){return this._inputs[1]}get geometry2(){return this._inputs[2]}get geometry3(){return this._inputs[3]}get geometry4(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){const t=i=>{const r=[];if(this.geometry0.isConnected){const o=this.geometry0.getConnectedValue(i);o&&r.push(o)}if(this.geometry1.isConnected){const o=this.geometry1.getConnectedValue(i);o&&r.push(o)}if(this.geometry2.isConnected){const o=this.geometry2.getConnectedValue(i);o&&r.push(o)}if(this.geometry3.isConnected){const o=this.geometry3.getConnectedValue(i);o&&r.push(o)}if(this.geometry4.isConnected){const o=this.geometry4.getConnectedValue(i);o&&r.push(o)}if(r.length===0)return null;let n=r[0].clone();const a=r.slice(1);return a.length&&n&&(n=n.merge(a,!0,!1,!0,!0)),n};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}_([O("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],O0.prototype,"evaluateContext",void 0);y("BABYLON.MergeGeometryBlock",O0);class N0 extends de{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry0",b.Geometry,!0),this.registerInput("geometry1",b.Geometry,!0),this.registerInput("geometry2",b.Geometry,!0),this.registerInput("geometry3",b.Geometry,!0),this.registerInput("geometry4",b.Geometry,!0),this.registerInput("geometry5",b.Geometry,!0),this.registerInput("geometry6",b.Geometry,!0),this.registerInput("geometry7",b.Geometry,!0),this.registerInput("geometry8",b.Geometry,!0),this.registerInput("geometry9",b.Geometry,!0),this.registerOutput("output",b.Geometry),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"GeometryCollectionBlock"}get geometry0(){return this._inputs[0]}get geometry1(){return this._inputs[1]}get geometry2(){return this._inputs[2]}get geometry3(){return this._inputs[3]}get geometry4(){return this._inputs[4]}get geometry5(){return this._inputs[5]}get geometry6(){return this._inputs[6]}get geometry7(){return this._inputs[7]}get geometry8(){return this._inputs[8]}get geometry9(){return this._inputs[9]}get output(){return this._outputs[0]}_storeGeometry(e,t,i,r){if(e.isConnected){const n=e.getConnectedValue(t);if(!n)return;n.metadata=n.metadata||{},n.metadata.collectionId=i,r.push(n)}}_buildBlock(e){const t=i=>{const r=[];return this._storeGeometry(this.geometry0,i,0,r),this._storeGeometry(this.geometry1,i,1,r),this._storeGeometry(this.geometry2,i,2,r),this._storeGeometry(this.geometry3,i,3,r),this._storeGeometry(this.geometry4,i,4,r),this._storeGeometry(this.geometry5,i,5,r),this._storeGeometry(this.geometry6,i,6,r),this._storeGeometry(this.geometry7,i,7,r),this._storeGeometry(this.geometry8,i,8,r),this._storeGeometry(this.geometry9,i,9,r),r.length?r[Math.round(Math.random()*(r.length-1))]:null};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}_([O("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],N0.prototype,"evaluateContext",void 0);y("BABYLON.GeometryCollectionBlock",N0);class D0 extends de{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",b.Geometry),this.registerOutput("output",b.Geometry)}getClassName(){return"CleanGeometryBlock"}get geometry(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){const t=i=>{if(!this.geometry.isConnected)return null;const r=this.geometry.getConnectedValue(i).clone();if(!r.positions||!r.indices||!r.normals)return r;const n=r.indices,a=r.positions;return qD(a,n),r};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}_([O("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],D0.prototype,"evaluateContext",void 0);y("BABYLON.CleanGeometryBlock",D0);class nW extends de{constructor(e){super(e),this.registerInput("input",b.AutoDetect),this.registerOutput("output",b.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}get buildExecutionTime(){return-1}getClassName(){return"GeometryElbowBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];t._storedFunction=r=>i.getConnectedValue(r)}}y("BABYLON.GeometryElbowBlock",nW);class aW extends de{constructor(e){super(e),this.registerInput("geometry",b.Geometry),this.registerOutput("output",b.Geometry)}getClassName(){return"ComputeNormalsBlock"}get geometry(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(){this.output._storedFunction=e=>{if(!this.geometry.isConnected)return null;const t=this.geometry.getConnectedValue(e);return t?(t.normals||(t.normals=[]),li.ComputeNormals(t.positions,t.indices,t.normals),t):null}}}y("BABYLON.ComputeNormalsBlock",aW);class oW extends de{constructor(e){super(e),this.registerInput("xyzw ",b.Vector4,!0),this.registerInput("xyz ",b.Vector3,!0),this.registerInput("xy ",b.Vector2,!0),this.registerInput("zw ",b.Vector2,!0),this.registerInput("x ",b.Float,!0),this.registerInput("y ",b.Float,!0),this.registerInput("z ",b.Float,!0),this.registerInput("w ",b.Float,!0),this.registerOutput("xyzw",b.Vector4),this.registerOutput("xyz",b.Vector3),this.registerOutput("xy",b.Vector2),this.registerOutput("zw",b.Vector2),this.registerOutput("x",b.Float),this.registerOutput("y",b.Float),this.registerOutput("z",b.Float),this.registerOutput("w",b.Float)}getClassName(){return"VectorConverterBlock"}get xyzwIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get xIn(){return this._inputs[4]}get yIn(){return this._inputs[5]}get zIn(){return this._inputs[6]}get wIn(){return this._inputs[7]}get xyzwOut(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xOut(){return this._outputs[4]}get yOut(){return this._outputs[5]}get zOut(){return this._outputs[6]}get wOut(){return this._outputs[7]}_inputRename(e){return e==="xyzw "?"xyzwIn":e==="xyz "?"xyzIn":e==="xy "?"xyIn":e==="zw "?"zwIn":e==="x "?"xIn":e==="y "?"yIn":e==="z "?"zIn":e==="w "?"wIn":e}_outputRename(e){switch(e){case"x":return"xOut";case"y":return"yOut";case"z":return"zOut";case"w":return"wOut";case"xy":return"xyOut";case"zw":return"zwOut";case"xyz":return"xyzOut";case"xyzw":return"xyzwOut";default:return e}}_buildBlock(e){super._buildBlock(e);const t=this.xIn,i=this.yIn,r=this.zIn,n=this.wIn,a=this.xyIn,o=this.zwIn,l=this.xyzIn,c=this.xyzwIn,u=this.xyzwOut,h=this.xyzOut,d=this.xyOut,f=this.zwOut,m=this.xOut,g=this.yOut,v=this.zOut,E=this.wOut,T=C=>{if(c.isConnected)return c.getConnectedValue(C);let A=0,I=0,F=0,V=0;if(t.isConnected&&(A=t.getConnectedValue(C)),i.isConnected&&(I=i.getConnectedValue(C)),r.isConnected&&(F=r.getConnectedValue(C)),n.isConnected&&(V=n.getConnectedValue(C)),a.isConnected){const D=a.getConnectedValue(C);D&&(A=D.x,I=D.y)}if(o.isConnected){const D=o.getConnectedValue(C);D&&(F=D.x,V=D.y)}if(l.isConnected){const D=l.getConnectedValue(C);D&&(A=D.x,I=D.y,F=D.z)}return new Ee(A,I,F,V)};u._storedFunction=C=>T(C),h._storedFunction=C=>{const A=T(C);return new x(A.x,A.y,A.z)},d._storedFunction=C=>{const A=T(C);return new X(A.x,A.y)},f._storedFunction=C=>{const A=T(C);return new X(A.z,A.w)},m._storedFunction=C=>T(C).x,g._storedFunction=C=>T(C).y,v._storedFunction=C=>T(C).z,E._storedFunction=C=>T(C).w}}y("BABYLON.VectorConverterBlock",oW);class lW extends de{constructor(e){super(e),this.registerInput("input",b.AutoDetect),this.registerOutput("output",b.BasedOnInput),this._inputs[0].excludedConnectionPointTypes.push(b.Float),this._inputs[0].excludedConnectionPointTypes.push(b.Matrix),this._inputs[0].excludedConnectionPointTypes.push(b.Geometry),this._inputs[0].excludedConnectionPointTypes.push(b.Texture),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"NormalizeVectorBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),this.output._storedFunction=null,!this.input.isConnected){this.output._storedValue=null;return}this.output._storedFunction=t=>this.input.getConnectedValue(t).normalize()}}y("BABYLON.NormalizeVectorBlock",lW);class M0 extends de{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",b.Geometry),this.registerInput("id",b.Int,!0,0),this.registerOutput("output",b.Geometry),this.id.acceptedConnectionPointTypes.push(b.Float)}getClassName(){return"SetMaterialIDBlock"}get geometry(){return this._inputs[0]}get id(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){if(!this.geometry.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}const t=i=>{const r=this.geometry.getConnectedValue(i);if(!r||!r.indices||!r.positions)return r;const n=new ZD;return n.materialIndex=this.id.getConnectedValue(i)|0,n.indexStart=0,n.indexCount=r.indices.length,n.verticesStart=0,n.verticesCount=r.positions.length/3,r.materialInfos=[n],r};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}}_([O("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],M0.prototype,"evaluateContext",void 0);y("BABYLON.SetMaterialIDBlock",M0);class dc extends de{constructor(e){super(e),this._indexVector3=new x,this._currentControl=new x,this.evaluateContext=!0,this.resolutionX=3,this.resolutionY=3,this.resolutionZ=3,this.registerInput("geometry",b.Geometry),this.registerInput("controls",b.Vector3),this.registerOutput("output",b.Geometry)}getExecutionIndex(){return this._currentIndexX+this.resolutionX*(this._currentIndexY+this.resolutionY*this._currentIndexZ)}getExecutionLoopIndex(){return this.getExecutionIndex()}getExecutionFaceIndex(){return 0}getClassName(){return"LatticeBlock"}get geometry(){return this._inputs[0]}get controls(){return this._inputs[1]}get output(){return this._outputs[0]}getOverridePositionsContextualValue(){return this._indexVector3}getOverrideNormalsContextualValue(){return this._currentControl}_buildBlock(e){const t=i=>{if(i.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(i),this._vertexData&&(this._vertexData=this._vertexData.clone()),!this._vertexData||!this._vertexData.positions){i.restoreExecutionContext(),this.output._storedValue=null;return}const r=this._vertexData.positions,n=Qc(r,0,r.length/3),a=n.maximum.subtract(n.minimum);for(this._lattice=new $4({resolutionX:this.resolutionX,resolutionY:this.resolutionY,resolutionZ:this.resolutionZ,size:a,position:n.minimum.add(a.scale(.5))}),this._currentIndexX=0;this._currentIndexX<this.resolutionX;this._currentIndexX++)for(this._currentIndexY=0;this._currentIndexY<this.resolutionY;this._currentIndexY++)for(this._currentIndexZ=0;this._currentIndexZ<this.resolutionZ;this._currentIndexZ++){this._indexVector3.set(this._currentIndexX,this._currentIndexY,this._currentIndexZ);const o=this._lattice.data[this._currentIndexX][this._currentIndexY][this._currentIndexZ];this._currentControl.copyFrom(o);const l=this.controls.getConnectedValue(i);l&&o.set(l.x,l.y,l.z)}return this._lattice.deform(r),i.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`;return e+=`${this._codeVariableName}.resolutionX = ${this.resolutionX};
`,e+=`${this._codeVariableName}.resolutionY = ${this.resolutionY};
`,e+=`${this._codeVariableName}.resolutionZ = ${this.resolutionZ};
`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.resolutionX=this.resolutionX,e.resolutionY=this.resolutionY,e.resolutionZ=this.resolutionZ,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext,this.resolutionX=e.resolutionX,this.resolutionY=e.resolutionY,this.resolutionZ=e.resolutionZ)}}_([O("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],dc.prototype,"evaluateContext",void 0);_([O("resolutionX",2,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},min:1,max:10})],dc.prototype,"resolutionX",void 0);_([O("resolutionY",2,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},min:1,max:10})],dc.prototype,"resolutionY",void 0);_([O("resolutionZ",2,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},min:1,max:10})],dc.prototype,"resolutionZ",void 0);y("BABYLON.LatticeBlock",dc);var we;(function(s){s[s.Cos=0]="Cos",s[s.Sin=1]="Sin",s[s.Abs=2]="Abs",s[s.Exp=3]="Exp",s[s.Round=4]="Round",s[s.Floor=5]="Floor",s[s.Ceiling=6]="Ceiling",s[s.Sqrt=7]="Sqrt",s[s.Log=8]="Log",s[s.Tan=9]="Tan",s[s.ArcTan=10]="ArcTan",s[s.ArcCos=11]="ArcCos",s[s.ArcSin=12]="ArcSin",s[s.Sign=13]="Sign",s[s.Negate=14]="Negate",s[s.OneMinus=15]="OneMinus",s[s.Reciprocal=16]="Reciprocal",s[s.ToDegrees=17]="ToDegrees",s[s.ToRadians=18]="ToRadians",s[s.Fract=19]="Fract",s[s.Exp2=20]="Exp2"})(we||(we={}));class F0 extends de{constructor(e){super(e),this.operation=we.Cos,this.registerInput("input",b.AutoDetect),this.registerOutput("output",b.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(b.Matrix),this._inputs[0].excludedConnectionPointTypes.push(b.Geometry),this._inputs[0].excludedConnectionPointTypes.push(b.Texture)}getClassName(){return"GeometryTrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=null;switch(this.operation){case we.Cos:{t=i=>Math.cos(i);break}case we.Sin:{t=i=>Math.sin(i);break}case we.Abs:{t=i=>Math.abs(i);break}case we.Exp:{t=i=>Math.exp(i);break}case we.Exp2:{t=i=>Math.pow(2,i);break}case we.Round:{t=i=>Math.round(i);break}case we.Floor:{t=i=>Math.floor(i);break}case we.Ceiling:{t=i=>Math.ceil(i);break}case we.Sqrt:{t=i=>Math.sqrt(i);break}case we.Log:{t=i=>Math.log(i);break}case we.Tan:{t=i=>Math.tan(i);break}case we.ArcTan:{t=i=>Math.atan(i);break}case we.ArcCos:{t=i=>Math.acos(i);break}case we.ArcSin:{t=i=>Math.asin(i);break}case we.Sign:{t=i=>Math.sign(i);break}case we.Negate:{t=i=>-i;break}case we.OneMinus:{t=i=>1-i;break}case we.Reciprocal:{t=i=>1/i;break}case we.ToRadians:{t=i=>i*Math.PI/180;break}case we.ToDegrees:{t=i=>i*180/Math.PI;break}case we.Fract:{t=i=>i>=0?i-Math.floor(i):i-Math.ceil(i);break}}if(!t){this.output._storedFunction=null,this.output._storedValue=null;return}switch(this.input.type){case b.Int:case b.Float:{this.output._storedFunction=i=>{const r=this.input.getConnectedValue(i);return t(r)};break}case b.Vector2:{this.output._storedFunction=i=>{const r=this.input.getConnectedValue(i);return new X(t(r.x),t(r.y))};break}case b.Vector3:{this.output._storedFunction=i=>{const r=this.input.getConnectedValue(i);return new x(t(r.x),t(r.y),t(r.z))};break}case b.Vector4:{this.output._storedFunction=i=>{const r=this.input.getConnectedValue(i);return new Ee(t(r.x),t(r.y),t(r.z),t(r.w))};break}}return this}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e){super._deserialize(e),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.GeometryTrigonometryBlockOperations.${we[this.operation]};
`}}_([O("Operation",5,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},options:[{label:"Cos",value:we.Cos},{label:"Sin",value:we.Sin},{label:"Abs",value:we.Abs},{label:"Exp",value:we.Exp},{label:"Exp2",value:we.Exp2},{label:"Round",value:we.Round},{label:"Floor",value:we.Floor},{label:"Ceiling",value:we.Ceiling},{label:"Sqrt",value:we.Sqrt},{label:"Log",value:we.Log},{label:"Tan",value:we.Tan},{label:"ArcTan",value:we.ArcTan},{label:"ArcCos",value:we.ArcCos},{label:"ArcSin",value:we.ArcSin},{label:"Sign",value:we.Sign},{label:"Negate",value:we.Negate},{label:"OneMinus",value:we.OneMinus},{label:"Reciprocal",value:we.Reciprocal},{label:"ToDegrees",value:we.ToDegrees},{label:"ToRadians",value:we.ToRadians},{label:"Fract",value:we.Fract}]})],F0.prototype,"operation",void 0);y("BABYLON.GeometryTrigonometryBlock",F0);class L0 extends de{constructor(e){super(e),this._rotationMatrix=new z,this._scalingMatrix=new z,this._translationMatrix=new z,this._scalingRotationMatrix=new z,this._pivotMatrix=new z,this._backPivotMatrix=new z,this._transformMatrix=new z,this.evaluateContext=!0,this.registerInput("value",b.AutoDetect),this.registerInput("matrix",b.Matrix,!0),this.registerInput("translation",b.Vector3,!0,x.Zero()),this.registerInput("rotation",b.Vector3,!0,x.Zero()),this.registerInput("scaling",b.Vector3,!0,x.One()),this.registerInput("pivot",b.Vector3,!0,x.Zero()),this.registerOutput("output",b.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(b.Float),this._inputs[0].excludedConnectionPointTypes.push(b.Matrix),this._inputs[0].excludedConnectionPointTypes.push(b.Texture)}getClassName(){return"GeometryTransformBlock"}get value(){return this._inputs[0]}get matrix(){return this._inputs[1]}get translation(){return this._inputs[2]}get rotation(){return this._inputs[3]}get scaling(){return this._inputs[4]}get pivot(){return this._inputs[5]}get output(){return this._outputs[0]}_buildBlock(e){if(!this.value.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}const t=i=>{const r=this.value.getConnectedValue(i);if(!r)return null;let n;if(this.matrix.isConnected)n=this.matrix.getConnectedValue(i);else{const a=this.scaling.getConnectedValue(i)||x.OneReadOnly,o=this.rotation.getConnectedValue(i)||x.ZeroReadOnly,l=this.translation.getConnectedValue(i)||x.ZeroReadOnly,c=this.pivot.getConnectedValue(i)||x.ZeroReadOnly;z.TranslationToRef(-c.x,-c.y,-c.z,this._pivotMatrix),z.ScalingToRef(a.x,a.y,a.z,this._scalingMatrix),z.RotationYawPitchRollToRef(o.y,o.x,o.z,this._rotationMatrix),z.TranslationToRef(l.x+c.x,l.y+c.y,l.z+c.z,this._translationMatrix),this._pivotMatrix.multiplyToRef(this._scalingMatrix,this._backPivotMatrix),this._backPivotMatrix.multiplyToRef(this._rotationMatrix,this._scalingRotationMatrix),this._scalingRotationMatrix.multiplyToRef(this._translationMatrix,this._transformMatrix),n=this._transformMatrix}switch(this.value.type){case b.Geometry:{const a=r.clone();return a.transform(n),a}case b.Vector2:return X.Transform(r,n);case b.Vector3:return x.TransformCoordinates(r,n);case b.Vector4:return Ee.TransformCoordinates(r,n)}return null};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}}_([O("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],L0.prototype,"evaluateContext",void 0);y("BABYLON.GeometryTransformBlock",L0);class cW extends de{constructor(e){super(e),this.registerInput("angle",b.Float,!0,0),this.registerOutput("matrix",b.Matrix)}getClassName(){return"RotationXBlock"}get angle(){return this._inputs[0]}get matrix(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=t=>z.RotationX(this.angle.getConnectedValue(t))}}y("BABYLON.RotationXBlock",cW);class uW extends de{constructor(e){super(e),this.registerInput("angle",b.Float,!0,0),this.registerOutput("matrix",b.Matrix)}getClassName(){return"RotationYBlock"}get angle(){return this._inputs[0]}get matrix(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=t=>z.RotationY(this.angle.getConnectedValue(t))}}y("BABYLON.RotationYBlock",uW);class hW extends de{constructor(e){super(e),this.registerInput("angle",b.Float,!0,0),this.registerOutput("matrix",b.Matrix)}getClassName(){return"RotationZBlock"}get angle(){return this._inputs[0]}get matrix(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=t=>z.RotationZ(this.angle.getConnectedValue(t))}}y("BABYLON.RotationZBlock",hW);class dW extends de{constructor(e){super(e),this.registerInput("scale",b.Vector3,!1,x.One()),this.registerOutput("matrix",b.Matrix)}getClassName(){return"ScalingBlock"}get scale(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.scale.isConnected){const e=new qt("Scale");e.value=new x(1,1,1),e.output.connectTo(this.scale)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=t=>{const i=this.scale.getConnectedValue(t);return z.Scaling(i.x,i.y,i.z)}}}y("BABYLON.ScalingBlock",dW);class fW extends de{constructor(e){super(e),this.registerInput("source",b.Vector3,!0,x.Up()),this.registerInput("target",b.Vector3,!0,x.Left()),this.registerOutput("matrix",b.Matrix)}getClassName(){return"AlignBlock"}get source(){return this._inputs[0]}get target(){return this._inputs[1]}get matrix(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=t=>{const i=this.source.getConnectedValue(t).clone(),r=this.target.getConnectedValue(t).clone(),n=new z;return i.normalize(),r.normalize(),z.RotationAlignToRef(i,r,n,!0),n}}}y("BABYLON.AlignBlock",fW);class pW extends de{constructor(e){super(e),this.registerInput("translation",b.Vector3,!1,x.Zero()),this.registerOutput("matrix",b.Matrix)}getClassName(){return"TranslationBlock"}get translation(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.translation.isConnected){const e=new qt("Translation");e.value=new x(0,0,0),e.output.connectTo(this.translation)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=t=>{const i=this.translation.getConnectedValue(t);return z.Translation(i.x,i.y,i.z)}}}y("BABYLON.TranslationBlock",pW);class z_ extends de{constructor(e){super(e),this._indexTranslation=null,this.evaluateContext=!0,this.removeDuplicatedPositions=!0,this.registerInput("geometry",b.Geometry),this.registerInput("instance",b.Geometry,!0),this.registerInput("density",b.Float,!0,1,0,1),this.registerInput("matrix",b.Matrix,!0),this.registerInput("offset",b.Vector3,!0,x.Zero()),this.registerInput("rotation",b.Vector3,!0,x.Zero()),this.registerInput("scaling",b.Vector3,!0,x.One()),this.scaling.acceptedConnectionPointTypes.push(b.Float),this.registerOutput("output",b.Geometry)}getInstanceIndex(){return this._currentLoopIndex}getExecutionIndex(){return this._indexTranslation?this._indexTranslation[this._currentIndex]:this._currentIndex}getExecutionLoopIndex(){return this._currentLoopIndex}getExecutionFaceIndex(){return 0}getClassName(){return"InstantiateOnVerticesBlock"}get geometry(){return this._inputs[0]}get instance(){return this._inputs[1]}get density(){return this._inputs[2]}get matrix(){return this._inputs[3]}get offset(){return this._inputs[4]}get rotation(){return this._inputs[5]}get scaling(){return this._inputs[6]}get output(){return this._outputs[0]}_buildBlock(e){const t=i=>{if(i.pushExecutionContext(this),i.pushInstancingContext(this),this._vertexData=this.geometry.getConnectedValue(i),i.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions||!this.instance.isConnected){i.restoreExecutionContext(),i.restoreInstancingContext(),i.restoreGeometryContext(),this.output._storedValue=null;return}let r=this._vertexData.positions.length/3;const n=[],a=new x,o=[];let l=this._vertexData.positions;if(this._currentLoopIndex=0,this.removeDuplicatedPositions){for(this._indexTranslation={},this._currentIndex=0;this._currentIndex<r;this._currentIndex++){const c=l[this._currentIndex*3],u=l[this._currentIndex*3+1],h=l[this._currentIndex*3+2];let d=!1;for(let f=0;f<o.length;f+=3)if(Math.abs(o[f]-c)<Ai&&Math.abs(o[f+1]-u)<Ai&&Math.abs(o[f+2]-h)<Ai){d=!0;break}d||(this._indexTranslation[o.length/3]=this._currentIndex,o.push(c,u,h))}l=o,r=l.length/3}else this._indexTranslation=null;for(this._currentIndex=0;this._currentIndex<r;this._currentIndex++){const c=this.instance.getConnectedValue(i);if(!c||!c.positions||c.positions.length===0)continue;const u=this.density.getConnectedValue(i);if(u<1&&Math.random()>u)continue;a.fromArray(l,this._currentIndex*3);const h=c.clone();if(this.matrix.isConnected){const d=this.matrix.getConnectedValue(i);i._instantiateWithPositionAndMatrix(h,a,d,n)}else{const d=i.adaptInput(this.offset,b.Vector3,x.ZeroReadOnly),f=i.adaptInput(this.scaling,b.Vector3,x.OneReadOnly),m=this.rotation.getConnectedValue(i)||x.ZeroReadOnly;a.addInPlace(d),i._instantiate(h,a,m,f,n)}this._currentLoopIndex++}if(i.restoreGeometryContext(),i.restoreExecutionContext(),i.restoreInstancingContext(),n.length)if(n.length===1)this._vertexData=n[0];else{const c=n.splice(0,1)[0];this._vertexData=c.merge(n,!0,!1,!0,!0)}else return null;return this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.removeDuplicatedPositions = ${this.removeDuplicatedPositions?"true":"false"};
`;return e+=`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`,e}serialize(){const e=super.serialize();return e.removeDuplicatedPositions=this.removeDuplicatedPositions,e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.removeDuplicatedPositions=e.removeDuplicatedPositions,e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}}_([O("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],z_.prototype,"evaluateContext",void 0);_([O("Remove duplicated positions",0,"ADVANCED",{notifiers:{update:!0}})],z_.prototype,"removeDuplicatedPositions",void 0);y("BABYLON.InstantiateOnVerticesBlock",z_);class w0 extends de{constructor(e){super(e),this._currentPosition=new x,this._currentUV=new X,this._vertex0=new x,this._vertex1=new x,this._vertex2=new x,this._tempVector0=new x,this._tempVector1=new x,this._uv0=new X,this._uv1=new X,this._uv2=new X,this.evaluateContext=!0,this.registerInput("geometry",b.Geometry),this.registerInput("instance",b.Geometry,!0),this.registerInput("count",b.Int,!0,256),this.registerInput("matrix",b.Matrix,!0),this.registerInput("offset",b.Vector3,!0,x.Zero()),this.registerInput("rotation",b.Vector3,!0,x.Zero()),this.registerInput("scaling",b.Vector3,!0,x.One()),this.scaling.acceptedConnectionPointTypes.push(b.Float),this.registerOutput("output",b.Geometry)}getInstanceIndex(){return this._currentLoopIndex}getExecutionIndex(){return 0}getExecutionFaceIndex(){return this._currentFaceIndex}getExecutionLoopIndex(){return this._currentLoopIndex}getOverridePositionsContextualValue(){return this._currentPosition}getOverrideNormalsContextualValue(){return this._vertex1.subtractToRef(this._vertex0,this._tempVector0),this._vertex2.subtractToRef(this._vertex1,this._tempVector1),this._tempVector0.normalize(),this._tempVector1.normalize(),x.Cross(this._tempVector1,this._tempVector0)}getOverrideUVs1ContextualValue(){return this._currentUV}getClassName(){return"InstantiateOnFacesBlock"}get geometry(){return this._inputs[0]}get instance(){return this._inputs[1]}get count(){return this._inputs[2]}get matrix(){return this._inputs[3]}get offset(){return this._inputs[4]}get rotation(){return this._inputs[5]}get scaling(){return this._inputs[6]}get output(){return this._outputs[0]}_buildBlock(e){const t=i=>{if(i.pushExecutionContext(this),i.pushInstancingContext(this),this._vertexData=this.geometry.getConnectedValue(i),i.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions||!this._vertexData.indices||!this.instance.isConnected){i.restoreExecutionContext(),i.restoreInstancingContext(),i.restoreGeometryContext(),this.output._storedValue=null;return}let r=null;const n=this.count.getConnectedValue(i),a=this._vertexData.indices.length/3,o=n/a;let l=0;const c=[];let u=0;for(this._currentLoopIndex=0,this._currentFaceIndex=0;this._currentFaceIndex<a;this._currentFaceIndex++){l+=o;const h=(l|0)-u;if(h<1)continue;const d=this._vertexData.indices[this._currentFaceIndex*3],f=this._vertexData.indices[this._currentFaceIndex*3+1],m=this._vertexData.indices[this._currentFaceIndex*3+2];this._vertex0.fromArray(this._vertexData.positions,d*3),this._vertex1.fromArray(this._vertexData.positions,f*3),this._vertex2.fromArray(this._vertexData.positions,m*3),this._vertexData.uvs&&(this._uv0.fromArray(this._vertexData.uvs,d*2),this._uv1.fromArray(this._vertexData.uvs,f*2),this._uv2.fromArray(this._vertexData.uvs,m*2));for(let g=0;g<h&&!(u>=n);g++){let v=Math.random(),E=Math.random();if(v>E){const F=v;v=E,E=F}const T=v,C=E-v,A=1-T-C;if(this._currentPosition.set(T*this._vertex0.x+C*this._vertex1.x+A*this._vertex2.x,T*this._vertex0.y+C*this._vertex1.y+A*this._vertex2.y,T*this._vertex0.z+C*this._vertex1.z+A*this._vertex2.z),this._vertexData.uvs&&this._currentUV.set(T*this._uv0.x+C*this._uv1.x+A*this._uv2.x,T*this._uv0.y+C*this._uv1.y+A*this._uv2.y),r=this.instance.getConnectedValue(i),!r||!r.positions||r.positions.length===0){l-=o;continue}const I=r.clone();if(this.matrix.isConnected){const F=this.matrix.getConnectedValue(i);i._instantiateWithPositionAndMatrix(I,this._currentPosition,F,c)}else{const F=i.adaptInput(this.offset,b.Vector3,x.ZeroReadOnly),V=i.adaptInput(this.scaling,b.Vector3,x.OneReadOnly),D=this.rotation.getConnectedValue(i)||x.ZeroReadOnly;this._currentPosition.addInPlace(F),i._instantiate(I,this._currentPosition,D,V,c)}u++,this._currentLoopIndex++}}if(c.length)if(c.length===1)this._vertexData=c[0];else{const h=c.splice(0,1)[0];this._vertexData=h.merge(c,!0,!1,!0,!0)}return i.restoreExecutionContext(),i.restoreInstancingContext(),i.restoreGeometryContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}}_([O("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],w0.prototype,"evaluateContext",void 0);y("BABYLON.InstantiateOnFacesBlock",w0);class W_ extends de{constructor(e){super(e),this._currentPosition=new x,this._vertex0=new x,this._vertex1=new x,this._vertex2=new x,this.evaluateContext=!0,this.gridMode=!1,this.registerInput("geometry",b.Geometry),this.registerInput("instance",b.Geometry,!0),this.registerInput("count",b.Int,!0,256),this.registerInput("matrix",b.Matrix,!0),this.registerInput("offset",b.Vector3,!0,x.Zero()),this.registerInput("rotation",b.Vector3,!0,x.Zero()),this.registerInput("scaling",b.Vector3,!0,x.One()),this.registerInput("gridSize",b.Int,!0,10),this.scaling.acceptedConnectionPointTypes.push(b.Float),this.registerOutput("output",b.Geometry)}getInstanceIndex(){return this._currentLoopIndex}getExecutionIndex(){return 0}getExecutionFaceIndex(){return 0}getExecutionLoopIndex(){return this._currentLoopIndex}getOverridePositionsContextualValue(){return this._currentPosition}getClassName(){return"InstantiateOnVolumeBlock"}get geometry(){return this._inputs[0]}get instance(){return this._inputs[1]}get count(){return this._inputs[2]}get matrix(){return this._inputs[3]}get offset(){return this._inputs[4]}get rotation(){return this._inputs[5]}get scaling(){return this._inputs[6]}get gridSize(){return this._inputs[6]}get output(){return this._outputs[0]}_getValueOnGrid(e,t,i,r){const n=(r-i)/t;return i+n/2+e*n}_getIndexinGrid(e,t,i,r){return e+t*r+i*r*r}_buildBlock(e){const t=i=>{if(i.pushExecutionContext(this),i.pushInstancingContext(this),this._vertexData=this.geometry.getConnectedValue(i),i.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions||!this._vertexData.indices||!this.instance.isConnected){i.restoreExecutionContext(),i.restoreInstancingContext(),i.restoreGeometryContext(),this.output._storedValue=null;return}let r=null;const n=this.count.getConnectedValue(i),a=[],o=Qc(this._vertexData.positions,0,this._vertexData.positions.length/3),l=o.minimum,c=o.maximum,u=new x(.5,.8,.2),h=this._vertexData.indices.length/3,d=this.gridSize.getConnectedValue(i);this._currentLoopIndex=0;let f;if(this.gridMode){f=[];for(let m=0;m<d*d*d;m++)f[m]=!1}for(let m=0;m<n;m++){if(this.gridMode){let T=Math.floor(Math.random()*d),C=Math.floor(Math.random()*d),A=Math.floor(Math.random()*d),I=this._getIndexinGrid(T,C,A,d);if(f[I]){let F=!1;for(let V=0;V<d*d*d;V++)if(!f[V]){A=Math.floor(V/(d*d)),C=Math.floor((V-A*d*d)/d),T=V-A*d*d-C*d,I=this._getIndexinGrid(T,C,A,d),F=!0;break}if(!F)break}if(!f[I]){const F=this._getValueOnGrid(T,d,l.x,c.x),V=this._getValueOnGrid(C,d,l.y,c.y),D=this._getValueOnGrid(A,d,l.z,c.z);this._currentPosition.set(F,V,D),f[I]=!0}}else this._currentPosition.set(Math.random()*(c.x-l.x)+l.x,Math.random()*(c.y-l.y)+l.y,Math.random()*(c.z-l.z)+l.z);const g=new xe(this._currentPosition,u);let v=0;for(let T=0;T<h;T++){this._vertex0.fromArray(this._vertexData.positions,this._vertexData.indices[T*3]*3),this._vertex1.fromArray(this._vertexData.positions,this._vertexData.indices[T*3+1]*3),this._vertex2.fromArray(this._vertexData.positions,this._vertexData.indices[T*3+2]*3);const C=g.intersectsTriangle(this._vertex0,this._vertex1,this._vertex2);C&&C.distance>0&&v++}if(v%2===0){m--;continue}if(r=this.instance.getConnectedValue(i),!r||!r.positions||r.positions.length===0)continue;const E=r.clone();if(this.matrix.isConnected){const T=this.matrix.getConnectedValue(i);i._instantiateWithPositionAndMatrix(E,this._currentPosition,T,a)}else{const T=i.adaptInput(this.offset,b.Vector3,x.ZeroReadOnly),C=i.adaptInput(this.scaling,b.Vector3,x.OneReadOnly),A=this.rotation.getConnectedValue(i)||x.ZeroReadOnly;this._currentPosition.addInPlace(T),i._instantiate(E,this._currentPosition,A,C,a)}this._currentLoopIndex++}if(a.length)if(a.length===1)this._vertexData=a[0];else{const m=a.splice(0,1)[0];this._vertexData=m.merge(a,!0,!1,!0,!0)}return i.restoreGeometryContext(),i.restoreExecutionContext(),i.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`;return e+=`${this._codeVariableName}.gridMode = ${this.gridMode?"true":"false"};
`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.gridMode=this.gridMode,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext),e.gridMode!==void 0&&(this.gridMode=e.gridMode)}}_([O("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],W_.prototype,"evaluateContext",void 0);_([O("Grid mode",0,"MODES",{notifiers:{rebuild:!0}})],W_.prototype,"gridMode",void 0);y("BABYLON.InstantiateOnVolumeBlock",W_);class Oh extends de{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("instance",b.Geometry,!0),this.registerInput("count",b.Int,!0,1),this.registerOutput("output",b.Geometry)}getInstanceIndex(){return this._currentIndex}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"InstantiateBaseBlock"}get instance(){return this._inputs[0]}get count(){return this._inputs[1]}get output(){return this._outputs[0]}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}}_([O("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Oh.prototype,"evaluateContext",void 0);class mW extends Oh{constructor(e){super(e),this.registerInput("matrix",b.Matrix,!0),this.registerInput("position",b.Vector3,!0,x.Zero()),this.registerInput("rotation",b.Vector3,!0,x.Zero()),this.registerInput("scaling",b.Vector3,!0,x.One()),this.scaling.acceptedConnectionPointTypes.push(b.Float)}getInstanceIndex(){return this._currentIndex}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"InstantiateBlock"}get matrix(){return this._inputs[2]}get position(){return this._inputs[3]}get rotation(){return this._inputs[4]}get scaling(){return this._inputs[5]}_buildBlock(e){const t=i=>{i.pushExecutionContext(this),i.pushInstancingContext(this);const r=this.count.getConnectedValue(i),n=[];for(this._currentIndex=0;this._currentIndex<r;this._currentIndex++){const a=this.instance.getConnectedValue(i);if(!a||!a.positions||a.positions.length===0)continue;const o=a.clone();if(this.matrix.isConnected){const l=this.matrix.getConnectedValue(i);i._instantiateWithMatrix(o,l,n)}else{const l=this.position.getConnectedValue(i)||x.ZeroReadOnly,c=i.adaptInput(this.scaling,b.Vector3,x.OneReadOnly),u=this.rotation.getConnectedValue(i)||x.ZeroReadOnly;i._instantiate(o,l,u,c,n)}}if(n.length)if(n.length===1)this._vertexData=n[0];else{const a=n.splice(0,1)[0];this._vertexData=a.merge(n,!0,!1,!0,!0)}return i.restoreExecutionContext(),i.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}}y("BABYLON.InstantiateBlock",mW);class _W extends Oh{constructor(e){super(e),this.registerInput("direction",b.Vector3,!0,new x(1,0,0)),this.registerInput("rotation",b.Vector3,!0,new x(0,0,0)),this.registerInput("scaling",b.Vector3,!0,new x(0,0,0)),this.scaling.acceptedConnectionPointTypes.push(b.Float)}getClassName(){return"InstantiateLinearBlock"}get direction(){return this._inputs[2]}get rotation(){return this._inputs[3]}get scaling(){return this._inputs[4]}_buildBlock(e){const t=i=>{i.pushExecutionContext(this),i.pushInstancingContext(this);const r=this.count.getConnectedValue(i),n=[],a=z.Identity(),o=x.Zero(),l=x.Zero(),c=x.Zero();for(this._currentIndex=0;this._currentIndex<r;this._currentIndex++){const u=this.instance.getConnectedValue(i);if(!u||!u.positions||u.positions.length===0)continue;const h=u.clone(),d=this.direction.getConnectedValue(i),f=this.rotation.getConnectedValue(i),m=i.adaptInput(this.scaling,b.Vector3,x.OneReadOnly);o.copyFrom(d.clone().scale(this._currentIndex)),l.copyFrom(f.clone().scale(this._currentIndex)),c.copyFrom(m.clone().scale(this._currentIndex)),c.addInPlaceFromFloats(1,1,1),z.ComposeToRef(c,Z.FromEulerAngles(l.x,l.y,l.z),o,a),i._instantiateWithMatrix(h,a,n)}if(n.length)if(n.length===1)this._vertexData=n[0];else{const u=n.splice(0,1)[0];this._vertexData=u.merge(n,!0,!1,!0,!0)}return i.restoreExecutionContext(),i.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}}y("BABYLON.InstantiateLinearBlock",_W);class gW extends Oh{constructor(e){super(e),this.registerInput("radius",b.Int,!0,0,0),this.registerInput("angleStart",b.Float,!0,0),this.registerInput("angleEnd",b.Float,!0,Math.PI*2),this.registerInput("transform",b.Vector3,!0,new x(0,0,0)),this.registerInput("rotation",b.Vector3,!0,new x(0,0,0)),this.registerInput("scaling",b.Vector3,!0,new x(0,0,0)),this.scaling.acceptedConnectionPointTypes.push(b.Float)}getClassName(){return"InstantiateRadialBlock"}get radius(){return this._inputs[2]}get angleStart(){return this._inputs[3]}get angleEnd(){return this._inputs[4]}get transform(){return this._inputs[5]}get rotation(){return this._inputs[6]}get scaling(){return this._inputs[7]}_buildBlock(e){const t=i=>{i.pushExecutionContext(this),i.pushInstancingContext(this);const r=this.count.getConnectedValue(i),n=[],a=z.Identity(),o=z.Identity(),l=z.Identity(),c=x.Zero(),u=x.Zero(),h=x.Zero();for(this._currentIndex=0;this._currentIndex<r;this._currentIndex++){const d=this.instance.getConnectedValue(i);if(!d||!d.positions||d.positions.length===0)continue;const f=d.clone(),m=this.radius.getConnectedValue(i),g=this.angleStart.getConnectedValue(i),v=this.angleEnd.getConnectedValue(i),E=this.transform.getConnectedValue(i),T=this.rotation.getConnectedValue(i),C=i.adaptInput(this.scaling,b.Vector3,x.OneReadOnly),I=(v-g)/r,F=g+I*this._currentIndex,V=Z.FromEulerAngles(0,F,0);c.copyFrom(E.clone().scale(this._currentIndex)),u.copyFrom(T.clone().scale(this._currentIndex)),h.copyFrom(C.clone().scale(this._currentIndex)),h.addInPlaceFromFloats(1,1,1),z.RotationYawPitchRollToRef(u.y,u.x,u.z,a),o.setTranslationFromFloats(0,0,m),z.ComposeToRef(h,V,c,l),a.multiplyToRef(o,o),o.multiplyToRef(l,l),i._instantiateWithMatrix(f,l,n)}if(n.length)if(n.length===1)this._vertexData=n[0];else{const d=n.splice(0,1)[0];this._vertexData=d.merge(n,!0,!1,!0,!0)}return i.restoreExecutionContext(),i.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}}y("BABYLON.InstantiateRadialBlock",gW);class SW extends de{constructor(e){super(e),this.registerInput("float ",b.Float,!0),this.registerInput("int ",b.Int,!0),this.registerOutput("float",b.Float),this.registerOutput("int",b.Int)}getClassName(){return"IntFloatConverterBlock"}get floatIn(){return this._inputs[0]}get intIn(){return this._inputs[1]}get floatOut(){return this._outputs[0]}get intOut(){return this._outputs[1]}_inputRename(e){return e==="float "?"floatIn":e==="int "?"intIn":e}_buildBlock(){this.floatOut._storedFunction=e=>this.floatIn.isConnected?this.floatIn.getConnectedValue(e):this.intIn.isConnected?this.intIn.getConnectedValue(e):0,this.intOut._storedFunction=e=>this.floatIn.isConnected?Math.floor(this.floatIn.getConnectedValue(e)):this.intIn.isConnected?Math.floor(this.intIn.getConnectedValue(e)):0}}y("BABYLON.IntFloatConverterBlock",SW);class vW extends de{constructor(e){super(e),this.log=[],this._isDebug=!0,this.registerInput("input",b.AutoDetect),this.registerOutput("output",b.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(b.Geometry),this._inputs[0].excludedConnectionPointTypes.push(b.Texture)}get buildExecutionTime(){return-1}getClassName(){return"DebugBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(!this.input.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}this.log=[];const t=i=>{const r=this.input.getConnectedValue(i);if(r==null)return this.log.push(["null",""]),r;switch(this.input.type){case b.Vector2:this.log.push([SR(r,4),r.toString()]);break;case b.Vector3:this.log.push([vR(r,4),r.toString()]);break;case b.Vector4:this.log.push([t1(r,4),r.toString()]);break;default:this.log.push([r.toString(),r.toString()]);break}return r};this.output.isConnected?this.output._storedFunction=t:this.output._storedValue=t(e)}}y("BABYLON.DebugBlock",vW);class xW extends de{constructor(e){super(e),this.registerInput("geometry",b.Geometry),this.registerOutput("output",b.Geometry),this.registerOutput("id",b.Int),this.registerOutput("collectionId",b.Int),this.registerOutput("verticesCount",b.Int),this.registerOutput("facesCount",b.Int)}getClassName(){return"GeometryInfoBlock"}get geometry(){return this._inputs[0]}get output(){return this._outputs[0]}get id(){return this._outputs[1]}get collectionId(){return this._outputs[2]}get verticesCount(){return this._outputs[3]}get facesCount(){return this._outputs[4]}_buildBlock(){if(!this.geometry.isConnected){this.id._storedValue=0,this.collectionId._storedValue=0,this.verticesCount._storedValue=0,this.facesCount._storedValue=0,this.output._storedValue=0,this.id._storedFunction=null,this.collectionId._storedFunction=null,this.verticesCount._storedFunction=null,this.facesCount._storedFunction=null,this.output._storedFunction=null;return}this.output._storedFunction=e=>(this._currentVertexData=this.geometry.getConnectedValue(e),this._currentVertexData),this.id._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.uniqueId),this.collectionId._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.metadata?this._currentVertexData.metadata.collectionId:0),this.verticesCount._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.positions?this._currentVertexData.positions.length/3:0),this.facesCount._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.indices?this._currentVertexData.indices.length/3:0)}}y("BABYLON.GeometryInfoBlock",xW);var Ns;(function(s){s[s.Spherical=0]="Spherical",s[s.Cylindrical=1]="Cylindrical",s[s.Cubic=2]="Cubic"})(Ns||(Ns={}));class B0 extends de{constructor(e){super(e),this.mapping=Ns.Spherical,this.registerInput("position",b.Vector3),this.registerInput("normal",b.Vector3),this.registerInput("center",b.Vector3,!0,x.Zero()),this.registerOutput("uv",b.Vector2)}getClassName(){return"MappingBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get center(){return this._inputs[2]}get uv(){return this._outputs[0]}_buildBlock(){if(!this.position.isConnected){this.uv._storedFunction=null,this.uv._storedValue=null;return}const e=x.Zero(),t=i=>{const r=this.position.getConnectedValue(i)||x.Zero(),n=this.normal.getConnectedValue(i)||x.Zero(),a=this.center.getConnectedValue(i),o=X.Zero();switch(this.mapping){case Ns.Spherical:{r.subtractToRef(a,e);const l=e.length();l>0&&(o.x=Math.acos(e.y/l)/Math.PI,(e.x!==0||e.z!==0)&&(o.y=Math.atan2(e.x,e.z)/(Math.PI*2)));break}case Ns.Cylindrical:{r.subtractToRef(a,e);const l=e.length();l>0&&(o.x=Math.atan2(e.x/l,e.z/l)/(Math.PI*2),o.y=(e.y+1)/2);break}case Ns.Cubic:{const l=Math.abs(n.x),c=Math.abs(n.y),u=Math.abs(n.z),h=Math.max(Math.abs(r.x),Math.abs(r.y),Math.abs(r.z));let d=0,f=0;l>=c&&l>=u?(d=r.y/h-a.y,f=r.z/h-a.z):c>=l&&c>=u?(d=r.x/h-a.x,f=r.z/h-a.z):(d=r.x/h-a.x,f=r.y/h-a.y),o.x=(d+1)/2,o.y=(f+1)/2}}return o};this.uv._storedFunction=i=>t(i)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.mapping = BABYLON.MappingTypes.${Ns[this.mapping]};
`}serialize(){const e=super.serialize();return e.mapping=this.mapping,e}_deserialize(e){super._deserialize(e),this.mapping=e.mapping}}_([O("Mapping",5,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Spherical",value:Ns.Spherical},{label:"Cylindrical",value:Ns.Cylindrical},{label:"Cubic",value:Ns.Cubic}]})],B0.prototype,"mapping",void 0);y("BABYLON.MappingBlock",B0);class EW extends de{constructor(e){super(e),this.registerInput("matrix0",b.Matrix),this.registerInput("matrix1",b.Matrix),this.registerOutput("output",b.Matrix)}getClassName(){return"MatrixComposeBlock"}get matrix0(){return this._inputs[0]}get matrix1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){this.output._storedFunction=e=>{if(!this.matrix0.isConnected||!this.matrix1.isConnected)return null;const t=this.matrix0.getConnectedValue(e),i=this.matrix1.getConnectedValue(e);return!t||!i?null:t.multiply(i)}}}y("BABYLON.MatrixComposeBlock",EW);class TW extends de{get endpoints(){return this._endpoints}constructor(e){super(e),this._endpoints=[],this._isTeleportIn=!0,this.registerInput("input",b.AutoDetect)}getClassName(){return"TeleportInBlock"}get input(){return this._inputs[0]}_dumpCode(e,t){let i=super._dumpCode(e,t);for(const r of this.endpoints)t.indexOf(r)===-1&&(i+=r._dumpCode(e,t));return i}isAnAncestorOfType(e){if(this.getClassName()===e)return!0;for(const t of this.endpoints)if(t.isAnAncestorOfType(e))return!0;return!1}isAnAncestorOf(e){for(const t of this.endpoints)if(t===e||t.isAnAncestorOf(e))return!0;return!1}getDescendantOfPredicate(e){if(e(this))return this;for(const t of this.endpoints){const i=t.getDescendantOfPredicate(e);if(i)return i}return null}attachToEndpoint(e){e.detach(),this._endpoints.push(e),e._entryPoint=this,e._outputs[0]._typeConnectionSource=this._inputs[0],e._tempEntryPointUniqueId=null,e.name="> "+this.name}detachFromEndpoint(e){const t=this._endpoints.indexOf(e);t!==-1&&(this._endpoints.splice(t,1),e._outputs[0]._typeConnectionSource=null,e._entryPoint=null)}_buildBlock(){for(const e of this._endpoints)e.output._storedFunction=t=>this.input.getConnectedValue(t)}}y("BABYLON.TeleportInBlock",TW);class bW extends de{constructor(e){super(e),this._entryPoint=null,this._tempEntryPointUniqueId=null,this._isTeleportOut=!0,this.registerOutput("output",b.BasedOnInput)}get entryPoint(){return this._entryPoint}getClassName(){return"TeleportOutBlock"}get output(){return this._outputs[0]}detach(){this._entryPoint&&this._entryPoint.detachFromEndpoint(this)}_buildBlock(){}_customBuildStep(e){this.entryPoint&&this.entryPoint.build(e)}_dumpCode(e,t){let i="";return this.entryPoint&&t.indexOf(this.entryPoint)===-1&&(i+=this.entryPoint._dumpCode(e,t)),i+super._dumpCode(e,t)}_dumpCodeForOutputConnections(e){let t=super._dumpCodeForOutputConnections(e);return this.entryPoint&&(t+=this.entryPoint._dumpCodeForOutputConnections(e)),t}clone(){const e=super.clone();return this.entryPoint&&this.entryPoint.attachToEndpoint(e),e}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.entryPoint&&(e+=`${this.entryPoint._codeVariableName}.attachToEndpoint(${this._codeVariableName});
`),e}serialize(){var t;const e=super.serialize();return e.entryPoint=((t=this.entryPoint)==null?void 0:t.uniqueId)??"",e}_deserialize(e){super._deserialize(e),this._tempEntryPointUniqueId=e.entryPoint}}y("BABYLON.TeleportOutBlock",bW);class CW extends de{get textureData(){return this._data}get textureWidth(){return this._width}get textureHeight(){return this._height}constructor(e){super(e),this._data=null,this.serializedCachedData=!1,this.registerOutput("texture",b.Texture)}getClassName(){return"GeometryTextureBlock"}get texture(){return this._outputs[0]}async _prepareImgToLoadAsync(e){return await new Promise((t,i)=>{const r=new Image,n=document.createElement("canvas"),a=n.getContext("2d");r.onload=()=>{n.width=r.width,n.height=r.height,a.drawImage(r,0,0);const l=a.getImageData(0,0,r.width,r.height).data,c=new Float32Array(l.length);for(let u=0;u<l.length;u++)c[u]=l[u]/255;this._data=c,this._width=r.width,this._height=r.height,t()},r.onerror=()=>{this._data=null,i(new Error("Failed to load image"))},r.src=e})}cleanData(){this._data=null}loadTextureFromData(e,t,i){this._data=e,this._width=t,this._height=i}async loadTextureFromFileAsync(e){return await this._prepareImgToLoadAsync(URL.createObjectURL(e))}async loadTextureFromUrlAsync(e){return await this._prepareImgToLoadAsync(e)}async extractFromTextureAsync(e){return await new Promise((t,i)=>{if(!e.isReady()){e.onLoadObservable.addOnce(async()=>{try{await this.extractFromTextureAsync(e),t()}catch(n){i(n)}});return}const r=e.getSize();Jm.GetTextureDataAsync(e,r.width,r.height).then(n=>{const a=new Float32Array(n.length);for(let o=0;o<n.length;o++)a[o]=n[o]/255;this._data=a,this._width=r.width,this._height=r.height,t()}).catch(i)})}_buildBlock(){if(!this._data){this.texture._storedValue=null;return}const e={data:this._data,width:this._width,height:this._height};this.texture._storedValue=e}serialize(){const e=super.serialize();return e.width=this._width,e.height=this._height,e.serializedCachedData=this.serializedCachedData,this._data&&this.serializedCachedData&&(e.data=Array.from(this._data)),e}_deserialize(e){super._deserialize(e),this._width=e.width,this._height=e.height,e.data?(this._data=new Float32Array(e.data),this.serializedCachedData=!0):this.serializedCachedData=!!e.serializedCachedData}}y("BABYLON.GeometryTextureBlock",CW);class H_ extends de{constructor(e){super(e),this.clampCoordinates=!0,this.interpolation=!0,this.registerInput("texture",b.Texture),this.registerInput("coordinates",b.Vector2),this.registerOutput("rgba",b.Vector4),this.registerOutput("rgb",b.Vector3),this.registerOutput("r",b.Float),this.registerOutput("g",b.Float),this.registerOutput("b",b.Float),this.registerOutput("a",b.Float)}getClassName(){return"GeometryTextureFetchBlock"}get texture(){return this.inputs[0]}get coordinates(){return this.inputs[1]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}_repeatClamp(e){return e>=0?e%1:1-Math.abs(e)%1}_lerp(e,t,i){return new Ee(e.x*(1-i)+t.x*i,e.y*(1-i)+t.y*i,e.z*(1-i)+t.z*i,e.w*(1-i)+t.w*i)}_getPixel(e,t,i,r){const n=(t*r+e)*4;return new Ee(i[n],i[n+1],i[n+2],i[n+3])}_buildBlock(){const e=t=>{const i=this.texture.getConnectedValue(t);if(!i||!i.data)return null;const r=this.coordinates.getConnectedValue(t);if(!r)return null;const n=this.clampCoordinates?Math.max(0,Math.min(r.x,1)):this._repeatClamp(r.x),a=this.clampCoordinates?Math.max(0,Math.min(r.y,1)):this._repeatClamp(r.y),o=i.width,l=i.height,c=i.data,u=n*(o-1),h=a*(l-1);if(this.interpolation){const d=Math.floor(u),f=Math.floor(h),m=Math.min(d+1,o-1),g=Math.min(f+1,l-1),v=u-d,E=h-f,T=this._getPixel(d,f,c,o),C=this._getPixel(m,f,c,o),A=this._getPixel(d,g,c,o),I=this._getPixel(m,g,c,o),F=this._lerp(T,C,v),V=this._lerp(A,I,v);return this._lerp(F,V,E)}return this._getPixel(Math.floor(u),Math.floor(h),c,o)};this.rgba._storedFunction=t=>e(t),this.rgb._storedFunction=t=>{const i=e(t);return i?i.toVector3():null},this.r._storedFunction=t=>{const i=e(t);return i?i.x:null},this.g._storedFunction=t=>{const i=e(t);return i?i.y:null},this.b._storedFunction=t=>{const i=e(t);return i?i.z:null},this.a._storedFunction=t=>{const i=e(t);return i?i.w:null}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.clampCoordinates = ${this.clampCoordinates};
`}serialize(){const e=super.serialize();return e.clampCoordinates=this.clampCoordinates,e.interpolation=this.interpolation,e}_deserialize(e){super._deserialize(e),this.clampCoordinates=e.clampCoordinates,e.clampCoordinates===void 0&&(this.interpolation=e.interpolation)}}_([O("Clamp Coordinates",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],H_.prototype,"clampCoordinates",void 0);_([O("Interpolation",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],H_.prototype,"interpolation",void 0);y("BABYLON.GeometryTextureFetchBlock",H_);class yW extends de{constructor(e){super(e),this.registerInput("geometry",b.Geometry),this.registerOutput("min",b.Vector3),this.registerOutput("max",b.Vector3)}getClassName(){return"BoundingBlock"}get geometry(){return this._inputs[0]}get min(){return this._outputs[0]}get max(){return this._outputs[1]}_buildBlock(){this.min._storedFunction=e=>{const t=this.geometry.getConnectedValue(e);return t?Qc(t.positions,0,t.positions.length/3).minimum:null},this.max._storedFunction=e=>{const t=this.geometry.getConnectedValue(e);return t?Qc(t.positions,0,t.positions.length/3).maximum:null}}}y("BABYLON.BoundingBlock",yW);var Pr;(function(s){s[s.Intersect=0]="Intersect",s[s.Subtract=1]="Subtract",s[s.Union=2]="Union"})(Pr||(Pr={}));class Nh extends de{get _isReadyState(){return Y4()?null:(this._csg2LoadingPromise||(this._csg2LoadingPromise=j4()),this._csg2LoadingPromise)}constructor(e){super(e),this.evaluateContext=!1,this.operation=Pr.Intersect,this.useOldCSGEngine=!1,this.registerInput("geometry0",b.Geometry),this.registerInput("geometry1",b.Geometry),this.registerOutput("output",b.Geometry)}getClassName(){return"BooleanGeometryBlock"}get geometry0(){return this._inputs[0]}get geometry1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=i=>{const r=this.geometry0.getConnectedValue(i),n=this.geometry1.getConnectedValue(i);if(!r||!n)return null;const a=r.positions.length/3;!r.normals&&n.normals&&(r.normals=new Array(r.positions.length)),!n.normals&&r.normals&&(n.normals=new Array(n.positions.length)),!r.uvs&&n.uvs&&(r.uvs=new Array(a*2)),!n.uvs&&r.uvs&&(n.uvs=new Array(a*2)),!r.colors&&n.colors&&(r.colors=new Array(a*4)),!n.colors&&r.colors&&(n.colors=new Array(a*4));let o;if(this.useOldCSGEngine){const l=As.FromVertexData(r),c=As.FromVertexData(n);switch(this.operation){case Pr.Intersect:o=l.intersect(c);break;case Pr.Subtract:o=l.subtract(c);break;case Pr.Union:o=l.union(c);break}}else{const l=Wl.FromVertexData(r),c=Wl.FromVertexData(n);switch(this.operation){case Pr.Intersect:o=l.intersect(c);break;case Pr.Subtract:o=l.subtract(c);break;case Pr.Union:o=l.add(c);break}}return o.toVertexData()};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`;return e+=`${this._codeVariableName}.operation = BABYLON.BooleanGeometryOperations.${Pr[this.operation]};
`,e+=`${this._codeVariableName}.useOldCSGEngine = ${this.useOldCSGEngine?"true":"false"};
`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.operation=this.operation,e.useOldCSGEngine=this.useOldCSGEngine,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext,e.operation&&(this.operation=e.operation),this.useOldCSGEngine=!!e.useOldCSGEngine}}_([O("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Nh.prototype,"evaluateContext",void 0);_([O("Operation",5,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Intersect",value:Pr.Intersect},{label:"Subtract",value:Pr.Subtract},{label:"Union",value:Pr.Union}]})],Nh.prototype,"operation",void 0);_([O("Use old CSG engine",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Nh.prototype,"useOldCSGEngine",void 0);y("BABYLON.BooleanGeometryBlock",Nh);class IW extends de{constructor(e){super(e),this.registerInput("x",b.AutoDetect),this.registerInput("y",b.AutoDetect),this.registerOutput("output",b.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(b.Matrix),this._inputs[0].excludedConnectionPointTypes.push(b.Geometry),this._inputs[0].excludedConnectionPointTypes.push(b.Texture)}getClassName(){return"GeometryArcTan2Block"}get x(){return this._inputs[0]}get y(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.x.isConnected||!this.y.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}const e=(t,i)=>Math.atan2(t,i);this.output._storedFunction=t=>{const i=this.x.getConnectedValue(t),r=this.y.getConnectedValue(t);switch(this.x.type){case b.Int:case b.Float:return e(i,r);case b.Vector2:return new X(e(i.x,r.x),e(i.y,r.y));case b.Vector3:return new x(e(i.x,r.x),e(i.y,r.y),e(i.z,r.z));case b.Vector4:return new Ee(e(i.x,r.x),e(i.y,r.y),e(i.z,r.z),e(i.w,r.w))}return 0}}}y("BABYLON.GeometryArcTan2Block",IW);class RW extends de{constructor(e){super(e),this.registerInput("left",b.AutoDetect),this.registerInput("right",b.AutoDetect),this.registerInput("gradient",b.Float,!0,0,0,1),this.registerOutput("output",b.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(b.Matrix),this._inputs[0].excludedConnectionPointTypes.push(b.Geometry),this._inputs[0].excludedConnectionPointTypes.push(b.Texture)}getClassName(){return"GeometryLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}const e=(t,i,r)=>(1-t)*i+t*r;return this.output._storedFunction=t=>{const i=this.left.getConnectedValue(t),r=this.right.getConnectedValue(t),n=this.gradient.getConnectedValue(t);switch(this.left.type){case b.Int:case b.Float:return e(n,i,r);case b.Vector2:return new X(e(n,i.x,r.x),e(n,i.y,r.y));case b.Vector3:return new x(e(n,i.x,r.x),e(n,i.y,r.y),e(n,i.z,r.z));case b.Vector4:return new Ee(e(n,i.x,r.x),e(n,i.y,r.y),e(n,i.z,r.z),e(n,i.w,r.w))}return 0},this}}y("BABYLON.GeometryLerpBlock",RW);class AW extends de{constructor(e){super(e),this.registerInput("left",b.AutoDetect),this.registerInput("right",b.AutoDetect),this.registerInput("gradient",b.Float,!0,0,0,1),this.registerOutput("output",b.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(b.Matrix),this._inputs[0].excludedConnectionPointTypes.push(b.Geometry),this._inputs[0].excludedConnectionPointTypes.push(b.Texture)}getClassName(){return"GeometryNLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}const e=(t,i,r)=>(1-t)*i+t*r;return this.output._storedFunction=t=>{const i=this.left.getConnectedValue(t),r=this.right.getConnectedValue(t),n=this.gradient.getConnectedValue(t);switch(this.left.type){case b.Int:case b.Float:return e(n,i,r);case b.Vector2:{const a=new X(e(n,i.x,r.x),e(n,i.y,r.y));return a.normalize(),a}case b.Vector3:{const a=new x(e(n,i.x,r.x),e(n,i.y,r.y),e(n,i.z,r.z));return a.normalize(),a}case b.Vector4:{const a=new Ee(e(n,i.x,r.x),e(n,i.y,r.y),e(n,i.z,r.z),e(n,i.w,r.w));return a.normalize(),a}}return 0},this}}y("BABYLON.GeometryNLerpBlock",AW);class PW extends de{constructor(e){super(e),this.registerInput("value",b.AutoDetect),this.registerInput("edge",b.Float,!0,0),this.registerOutput("output",b.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(b.Matrix),this._inputs[0].excludedConnectionPointTypes.push(b.Geometry),this._inputs[0].excludedConnectionPointTypes.push(b.Texture)}getClassName(){return"GeometryStepBlock"}get value(){return this._inputs[0]}get edge(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}const e=(t,i)=>t<i?0:1;return this.output._storedFunction=t=>{const i=this.value.getConnectedValue(t),r=this.edge.getConnectedValue(t);switch(this.value.type){case b.Int:case b.Float:return e(i,r);case b.Vector2:return new X(e(i.x,r),e(i.y,r));case b.Vector3:return new x(e(i.x,r),e(i.y,r),e(i.z,r));case b.Vector4:return new Ee(e(i.x,r),e(i.y,r),e(i.z,r),e(i.w,r))}return 0},this}}y("BABYLON.GeometryStepBlock",PW);class OW extends de{constructor(e){super(e),this.registerInput("value",b.AutoDetect),this.registerInput("edge0",b.Float,!0,0),this.registerInput("edge1",b.Float,!0,1),this.registerOutput("output",b.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(b.Matrix),this._inputs[0].excludedConnectionPointTypes.push(b.Geometry),this._inputs[0].excludedConnectionPointTypes.push(b.Texture)}getClassName(){return"GeometrySmoothStepBlock"}get value(){return this._inputs[0]}get edge0(){return this._inputs[1]}get edge1(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}const e=(t,i,r)=>{const n=Math.max(0,Math.min((t-i)/(r-i),1));return n*n*(3-2*n)};return this.output._storedFunction=t=>{const i=this.value.getConnectedValue(t),r=this.edge0.getConnectedValue(t),n=this.edge1.getConnectedValue(t);switch(this.value.type){case b.Int:case b.Float:return e(i,r,n);case b.Vector2:return new X(e(i.x,r,n),e(i.y,r,n));case b.Vector3:return new x(e(i.x,r,n),e(i.y,r,n),e(i.z,r,n));case b.Vector4:return new Ee(e(i.x,r,n),e(i.y,r,n),e(i.z,r,n),e(i.w,r,n))}return 0},this}}y("BABYLON.GeometrySmoothStepBlock",OW);class NW extends de{constructor(e){super(e),this.registerInput("left",b.AutoDetect),this.registerInput("right",b.AutoDetect),this.registerOutput("output",b.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(b.Matrix),this._inputs[0].excludedConnectionPointTypes.push(b.Geometry),this._inputs[0].excludedConnectionPointTypes.push(b.Texture)}getClassName(){return"GeometryModBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}const e=(t,i)=>t-Math.floor(t/i)*i;return this.output._storedFunction=t=>{const i=this.left.getConnectedValue(t),r=this.right.getConnectedValue(t);switch(this.left.type){case b.Int:case b.Float:return e(i,r);case b.Vector2:return new X(e(i.x,r.x),e(i.y,r.y));case b.Vector3:return new x(e(i.x,r.x),e(i.y,r.y),e(i.z,r.z));case b.Vector4:return new Ee(e(i.x,r.x),e(i.y,r.y),e(i.z,r.z),e(i.w,r.w))}return 0},this}}y("BABYLON.GeometryModBlock",NW);class DW extends de{constructor(e){super(e),this.registerInput("value",b.AutoDetect),this.registerInput("power",b.AutoDetect),this.registerOutput("output",b.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(b.Matrix),this._inputs[0].excludedConnectionPointTypes.push(b.Geometry),this._inputs[0].excludedConnectionPointTypes.push(b.Texture)}getClassName(){return"GeometryPowBlock"}get value(){return this._inputs[0]}get power(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected||!this.power.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}const e=(t,i)=>Math.pow(t,i);return this.output._storedFunction=t=>{const i=this.value.getConnectedValue(t),r=this.power.getConnectedValue(t);switch(this.value.type){case b.Int:case b.Float:return e(i,r);case b.Vector2:return new X(e(i.x,r),e(i.y,r));case b.Vector3:return new x(e(i.x,r),e(i.y,r),e(i.z,r));case b.Vector4:return new Ee(e(i.x,r),e(i.y,r),e(i.z,r),e(i.w,r))}return 0},this}}y("BABYLON.GeometryPowBlock",DW);class MW extends de{get minimum(){return this.min.value}set minimum(e){this.min.value=e}get maximum(){return this.max.value}set maximum(e){this.max.value=e}constructor(e){super(e),this.registerInput("value",b.AutoDetect),this.registerInput("min",b.Float,!0,0),this.registerInput("max",b.Float,!0,1),this.registerOutput("output",b.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(b.Matrix),this._inputs[0].excludedConnectionPointTypes.push(b.Geometry),this._inputs[0].excludedConnectionPointTypes.push(b.Texture)}getClassName(){return"GeometryClampBlock"}get value(){return this._inputs[0]}get min(){return this._inputs[1]}get max(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}const e=(t,i,r)=>Math.max(i,Math.min(t,r));return this.output._storedFunction=t=>{const i=this.value.getConnectedValue(t),r=this.min.isConnected?this.min.getConnectedValue(t):this.minimum,n=this.max.isConnected?this.max.getConnectedValue(t):this.maximum;switch(this.value.type){case b.Int:case b.Float:return e(i,r,n);case b.Vector2:return new X(e(i.x,r,n),e(i.y,r,n));case b.Vector3:return new x(e(i.x,r,n),e(i.y,r,n),e(i.z,r,n));case b.Vector4:return new Ee(e(i.x,r,n),e(i.y,r,n),e(i.z,r,n),e(i.w,r,n))}return 0},this}_deserialize(e){super._deserialize(e),this.minimum=e.minimum,this.maximum=e.maximum}}y("BABYLON.GeometryClampBlock",MW);class FW extends de{constructor(e){super(e),this.registerInput("left",b.AutoDetect),this.registerInput("right",b.AutoDetect),this.registerOutput("output",b.Vector3),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(b.Int),this._inputs[0].excludedConnectionPointTypes.push(b.Float),this._inputs[0].excludedConnectionPointTypes.push(b.Matrix),this._inputs[0].excludedConnectionPointTypes.push(b.Vector2),this._inputs[1].excludedConnectionPointTypes.push(b.Int),this._inputs[1].excludedConnectionPointTypes.push(b.Float),this._inputs[1].excludedConnectionPointTypes.push(b.Matrix),this._inputs[1].excludedConnectionPointTypes.push(b.Vector2)}getClassName(){return"GeometryCrossBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{const t=this.left.getConnectedValue(e),i=this.right.getConnectedValue(e);switch(this.left.type){case b.Vector3:return x.Cross(t,i);case b.Vector4:return x.Cross(t.toVector3(),i.toVector3())}return 0},this}}y("BABYLON.GeometryCrossBlock",FW);var ye;(function(s){s[s.EaseInSine=0]="EaseInSine",s[s.EaseOutSine=1]="EaseOutSine",s[s.EaseInOutSine=2]="EaseInOutSine",s[s.EaseInQuad=3]="EaseInQuad",s[s.EaseOutQuad=4]="EaseOutQuad",s[s.EaseInOutQuad=5]="EaseInOutQuad",s[s.EaseInCubic=6]="EaseInCubic",s[s.EaseOutCubic=7]="EaseOutCubic",s[s.EaseInOutCubic=8]="EaseInOutCubic",s[s.EaseInQuart=9]="EaseInQuart",s[s.EaseOutQuart=10]="EaseOutQuart",s[s.EaseInOutQuart=11]="EaseInOutQuart",s[s.EaseInQuint=12]="EaseInQuint",s[s.EaseOutQuint=13]="EaseOutQuint",s[s.EaseInOutQuint=14]="EaseInOutQuint",s[s.EaseInExpo=15]="EaseInExpo",s[s.EaseOutExpo=16]="EaseOutExpo",s[s.EaseInOutExpo=17]="EaseInOutExpo",s[s.EaseInCirc=18]="EaseInCirc",s[s.EaseOutCirc=19]="EaseOutCirc",s[s.EaseInOutCirc=20]="EaseInOutCirc",s[s.EaseInBack=21]="EaseInBack",s[s.EaseOutBack=22]="EaseOutBack",s[s.EaseInOutBack=23]="EaseInOutBack",s[s.EaseInElastic=24]="EaseInElastic",s[s.EaseOutElastic=25]="EaseOutElastic",s[s.EaseInOutElastic=26]="EaseInOutElastic"})(ye||(ye={}));class V0 extends de{constructor(e){super(e),this.type=ye.EaseInOutSine,this.registerInput("input",b.AutoDetect),this.registerOutput("output",b.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(b.Matrix),this._inputs[0].excludedConnectionPointTypes.push(b.Int)}getClassName(){return"GeometryCurveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(){if(!this.input.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let e;switch(this.type){case ye.EaseInSine:e=t=>1-Math.cos(t*3.1415/2);break;case ye.EaseOutSine:e=t=>Math.sin(t*3.1415/2);break;case ye.EaseInOutSine:e=t=>-(Math.cos(t*3.1415)-1)/2;break;case ye.EaseInQuad:e=t=>t*t;break;case ye.EaseOutQuad:e=t=>(1-t)*(1-t);break;case ye.EaseInOutQuad:{e=t=>t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2;break}case ye.EaseInCubic:e=t=>t*t*t;break;case ye.EaseOutCubic:{e=t=>1-Math.pow(1-t,3);break}case ye.EaseInOutCubic:{e=t=>t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2;break}case ye.EaseInQuart:e=t=>t*t*t*t;break;case ye.EaseOutQuart:{e=t=>1-Math.pow(1-t,4);break}case ye.EaseInOutQuart:{e=t=>t<.5?8*t*t*t*t:1-Math.pow(-2*t+2,4)/2;break}case ye.EaseInQuint:e=t=>t*t*t*t*t;break;case ye.EaseOutQuint:{e=t=>1-Math.pow(1-t,5);break}case ye.EaseInOutQuint:{e=t=>t<.5?16*t*t*t*t*t:1-Math.pow(-2*t+2,5)/2;break}case ye.EaseInExpo:{e=t=>t===0?0:Math.pow(2,10*t-10);break}case ye.EaseOutExpo:{e=t=>t===1?1:1-Math.pow(2,-10*t);break}case ye.EaseInOutExpo:{e=t=>t===0?0:t===1?1:t<.5?Math.pow(2,20*t-10)/2:(2-Math.pow(2,-20*t+10))/2;break}case ye.EaseInCirc:{e=t=>1-Math.sqrt(1-Math.pow(t,2));break}case ye.EaseOutCirc:{e=t=>Math.sqrt(1-Math.pow(t-1,2));break}case ye.EaseInOutCirc:{e=t=>t<.5?(1-Math.sqrt(1-Math.pow(2*t,2)))/2:(Math.sqrt(1-Math.pow(-2*t+2,2))+1)/2;break}case ye.EaseInBack:{e=t=>2.70158*t*t*t-1.70158*t*t;break}case ye.EaseOutBack:{e=t=>2.70158*Math.pow(t-1,3)+1.70158*Math.pow(t-1,2);break}case ye.EaseInOutBack:{e=t=>t<.5?Math.pow(2*t,2)*(3.5949095*2*t-2.5949095)/2:(Math.pow(2*t-2,2)*(3.5949095*(t*2-2)+3.5949095)+2)/2;break}case ye.EaseInElastic:{e=t=>t===0?0:t===1?1:-Math.pow(2,10*t-10)*Math.sin((t*10-10.75)*(2*3.1415/3));break}case ye.EaseOutElastic:{e=t=>t===0?0:t===1?1:Math.pow(2,-10*t)*Math.sin((t*10-.75)*(2*3.1415/3))+1;break}case ye.EaseInOutElastic:{e=t=>t===0?0:t==1?1:t<.5?-(Math.pow(2,20*t-10)*Math.sin((20*t-11.125)*(2*3.1415/4.5)))/2:Math.pow(2,-20*t+10)*Math.sin((20*t-11.125)*(2*3.1415/4.5))/2+1;break}}return this.output._storedFunction=t=>{const i=this.input.getConnectedValue(t);switch(this.input.type){case b.Float:return e(i);case b.Vector2:return new X(e(i.x),e(i.y));case b.Vector3:return new x(e(i.x),e(i.y),e(i.z));case b.Vector4:return new Ee(e(i.x),e(i.y),e(i.z),e(i.w))}return 0},this}serialize(){const e=super.serialize();return e.curveType=this.type,e}_deserialize(e){super._deserialize(e),this.type=e.curveType}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.type = BABYLON.GeometryCurveBlockTypes.${ye[this.type]};
`}}_([O("Type",5,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"EaseInSine",value:ye.EaseInSine},{label:"EaseOutSine",value:ye.EaseOutSine},{label:"EaseInOutSine",value:ye.EaseInOutSine},{label:"EaseInQuad",value:ye.EaseInQuad},{label:"EaseOutQuad",value:ye.EaseOutQuad},{label:"EaseInOutQuad",value:ye.EaseInOutQuad},{label:"EaseInCubic",value:ye.EaseInCubic},{label:"EaseOutCubic",value:ye.EaseOutCubic},{label:"EaseInOutCubic",value:ye.EaseInOutCubic},{label:"EaseInQuart",value:ye.EaseInQuart},{label:"EaseOutQuart",value:ye.EaseOutQuart},{label:"EaseInOutQuart",value:ye.EaseInOutQuart},{label:"EaseInQuint",value:ye.EaseInQuint},{label:"EaseOutQuint",value:ye.EaseOutQuint},{label:"EaseInOutQuint",value:ye.EaseInOutQuint},{label:"EaseInExpo",value:ye.EaseInExpo},{label:"EaseOutExpo",value:ye.EaseOutExpo},{label:"EaseInOutExpo",value:ye.EaseInOutExpo},{label:"EaseInCirc",value:ye.EaseInCirc},{label:"EaseOutCirc",value:ye.EaseOutCirc},{label:"EaseInOutCirc",value:ye.EaseInOutCirc},{label:"EaseInBack",value:ye.EaseInBack},{label:"EaseOutBack",value:ye.EaseOutBack},{label:"EaseInOutBack",value:ye.EaseInOutBack},{label:"EaseInElastic",value:ye.EaseInElastic},{label:"EaseOutElastic",value:ye.EaseOutElastic},{label:"EaseInOutElastic",value:ye.EaseInOutElastic}]})],V0.prototype,"type",void 0);y("BABYLON.GeometryCurveBlock",V0);class LW extends de{constructor(e){super(e),this.registerInput("color",b.Vector3),this.registerInput("level",b.Float,!0,0),this.registerOutput("output",b.Vector3)}getClassName(){return"GeometryDesaturateBlock"}get color(){return this._inputs[0]}get level(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.color.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{const t=this.color.getConnectedValue(e),i=this.level.getConnectedValue(e),r=Math.min(t.x,t.y,t.z),n=Math.max(t.x,t.y,t.z),a=.5*(r+n);return new x(t.x*(1-i)+a*i,t.y*(1-i)+a*i,t.z*(1-i)+a*i)},this}}y("BABYLON.GeometryDesaturateBlock",LW);class wW extends de{constructor(e){super(e),this.registerInput("value",b.AutoDetect),this.registerInput("steps",b.AutoDetect),this.registerOutput("output",b.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(b.Matrix),this._inputs[1].excludedConnectionPointTypes.push(b.Matrix),this._inputs[1].acceptedConnectionPointTypes.push(b.Float)}getClassName(){return"GeometryPosterizeBlock"}get value(){return this._inputs[0]}get steps(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected||!this.steps.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{const t=this.value.getConnectedValue(e),i=this.steps.getConnectedValue(e);let r=i;if(this.steps.type===b.Float)switch(this.value.type){case b.Vector2:r=new X(i,i);break;case b.Vector3:r=new x(i,i,i);break;case b.Vector4:r=new Ee(i,i,i,i);break}switch(this.value.type){case b.Vector2:return new X(t.x/(1/r.x)*(1/r.x),t.y/(1/r.y)*(1/r.y));case b.Vector3:return new x(t.x/(1/r.x)*(1/r.x),t.y/(1/r.y)*(1/r.y),t.z/(1/r.z)*(1/r.z));case b.Vector4:return new Ee(t.x/(1/r.x)*(1/r.x),t.y/(1/r.y)*(1/r.y),t.z/(1/r.z)*(1/r.z),t.w/(1/r.w)*(1/r.w));default:return Math.floor(t/(1/i)*(1/i))}},this}}y("BABYLON.GeometryPosterizeBlock",wW);class BW extends de{constructor(e){super(e),this.registerInput("value",b.AutoDetect),this.registerInput("reference",b.AutoDetect),this.registerInput("distance",b.Float,!0,0),this.registerInput("replacement",b.AutoDetect),this.registerOutput("output",b.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(0,3),this._inputs[0].excludedConnectionPointTypes.push(b.Float),this._inputs[0].excludedConnectionPointTypes.push(b.Matrix),this._inputs[1].excludedConnectionPointTypes.push(b.Float),this._inputs[1].excludedConnectionPointTypes.push(b.Matrix),this._inputs[3].excludedConnectionPointTypes.push(b.Float),this._inputs[3].excludedConnectionPointTypes.push(b.Matrix)}getClassName(){return"GeometryReplaceColorBlock"}get value(){return this._inputs[0]}get reference(){return this._inputs[1]}get distance(){return this._inputs[2]}get replacement(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected||!this.reference.isConnected||!this.replacement.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{const t=this.value.getConnectedValue(e),i=this.reference.getConnectedValue(e),r=this.distance.getConnectedValue(e),n=this.replacement.getConnectedValue(e);return t.subtract(i).length()<r?n:t},this}}y("BABYLON.GeometryReplaceColorBlock",BW);class VW extends de{constructor(e){super(e),this.registerInput("left",b.AutoDetect),this.registerInput("right",b.AutoDetect),this.registerOutput("output",b.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(b.Int),this._inputs[0].excludedConnectionPointTypes.push(b.Float),this._inputs[0].excludedConnectionPointTypes.push(b.Matrix),this._inputs[1].excludedConnectionPointTypes.push(b.Float),this._inputs[1].excludedConnectionPointTypes.push(b.Matrix)}getClassName(){return"GeometryDistanceBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{const t=this.left.getConnectedValue(e),i=this.right.getConnectedValue(e);return t.subtract(i).length()},this}}y("BABYLON.GeometryDistanceBlock",VW);class UW extends de{constructor(e){super(e),this.registerInput("left",b.AutoDetect),this.registerInput("right",b.AutoDetect),this.registerOutput("output",b.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(b.Int),this._inputs[0].excludedConnectionPointTypes.push(b.Float),this._inputs[0].excludedConnectionPointTypes.push(b.Matrix),this._inputs[1].excludedConnectionPointTypes.push(b.Float),this._inputs[1].excludedConnectionPointTypes.push(b.Matrix)}getClassName(){return"GeometryDotBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{const t=this.left.getConnectedValue(e),i=this.right.getConnectedValue(e);return t.dot(i)},this}}y("BABYLON.GeometryDotBlock",UW);class kW extends de{constructor(e){super(e),this.registerInput("value",b.AutoDetect),this.registerOutput("output",b.Float),this._inputs[0].excludedConnectionPointTypes.push(b.Int),this._inputs[0].excludedConnectionPointTypes.push(b.Float),this._inputs[0].excludedConnectionPointTypes.push(b.Matrix)}getClassName(){return"GeometryLengthBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>this.value.getConnectedValue(e).length(),this}}y("BABYLON.GeometryLengthBlock",kW);class GW extends de{constructor(e){super(e),this.registerInput("input",b.Vector2),this.registerInput("angle",b.Float,!0,0),this.registerOutput("output",b.Vector2)}getClassName(){return"GeometryRotate2dBlock"}get input(){return this._inputs[0]}get angle(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.input.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{const t=this.input.getConnectedValue(e),i=this.angle.getConnectedValue(e);return new X(Math.cos(i)*t.x-Math.sin(i)*t.y,Math.sin(i)*t.x+Math.cos(i)*t.y)},this}}y("BABYLON.GeometryRotate2dBlock",GW);class zW extends de{constructor(e){super(e),this.onInterceptionObservable=new k(void 0,!0),this.registerInput("input",b.AutoDetect),this.registerOutput("output",b.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}get buildExecutionTime(){return-1}getClassName(){return"GeometryInterceptorBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];t._storedFunction=r=>{let n=i.getConnectedValue(r);return this.customFunction&&(n=this.customFunction(n,r)),this.onInterceptionObservable.notifyObservers(n),n}}}y("BABYLON.GeometryInterceptorBlock",zW);var Ie;(function(s){s[s.EaseInSine=0]="EaseInSine",s[s.EaseOutSine=1]="EaseOutSine",s[s.EaseInOutSine=2]="EaseInOutSine",s[s.EaseInQuad=3]="EaseInQuad",s[s.EaseOutQuad=4]="EaseOutQuad",s[s.EaseInOutQuad=5]="EaseInOutQuad",s[s.EaseInCubic=6]="EaseInCubic",s[s.EaseOutCubic=7]="EaseOutCubic",s[s.EaseInOutCubic=8]="EaseInOutCubic",s[s.EaseInQuart=9]="EaseInQuart",s[s.EaseOutQuart=10]="EaseOutQuart",s[s.EaseInOutQuart=11]="EaseInOutQuart",s[s.EaseInQuint=12]="EaseInQuint",s[s.EaseOutQuint=13]="EaseOutQuint",s[s.EaseInOutQuint=14]="EaseInOutQuint",s[s.EaseInExpo=15]="EaseInExpo",s[s.EaseOutExpo=16]="EaseOutExpo",s[s.EaseInOutExpo=17]="EaseInOutExpo",s[s.EaseInCirc=18]="EaseInCirc",s[s.EaseOutCirc=19]="EaseOutCirc",s[s.EaseInOutCirc=20]="EaseInOutCirc",s[s.EaseInBack=21]="EaseInBack",s[s.EaseOutBack=22]="EaseOutBack",s[s.EaseInOutBack=23]="EaseInOutBack",s[s.EaseInElastic=24]="EaseInElastic",s[s.EaseOutElastic=25]="EaseOutElastic",s[s.EaseInOutElastic=26]="EaseInOutElastic"})(Ie||(Ie={}));class U0 extends de{get type(){return this._type}set type(e){if(this._type!==e)switch(this._type=e,this._type){case Ie.EaseInSine:this._easingFunction=new en,this._easingFunction.setEasingMode(en.EASINGMODE_EASEIN);break;case Ie.EaseOutSine:this._easingFunction=new en,this._easingFunction.setEasingMode(en.EASINGMODE_EASEOUT);break;case Ie.EaseInOutSine:this._easingFunction=new en,this._easingFunction.setEasingMode(en.EASINGMODE_EASEINOUT);break;case Ie.EaseInQuad:this._easingFunction=new la,this._easingFunction.setEasingMode(la.EASINGMODE_EASEIN);break;case Ie.EaseOutQuad:this._easingFunction=new la,this._easingFunction.setEasingMode(la.EASINGMODE_EASEOUT);break;case Ie.EaseInOutQuad:this._easingFunction=new la,this._easingFunction.setEasingMode(la.EASINGMODE_EASEINOUT);break;case Ie.EaseInCubic:this._easingFunction=new aa,this._easingFunction.setEasingMode(aa.EASINGMODE_EASEIN);break;case Ie.EaseOutCubic:this._easingFunction=new aa,this._easingFunction.setEasingMode(aa.EASINGMODE_EASEOUT);break;case Ie.EaseInOutCubic:this._easingFunction=new aa,this._easingFunction.setEasingMode(aa.EASINGMODE_EASEINOUT);break;case Ie.EaseInQuart:this._easingFunction=new Za,this._easingFunction.setEasingMode(Za.EASINGMODE_EASEIN);break;case Ie.EaseOutQuart:this._easingFunction=new Za,this._easingFunction.setEasingMode(Za.EASINGMODE_EASEOUT);break;case Ie.EaseInOutQuart:this._easingFunction=new Za,this._easingFunction.setEasingMode(Za.EASINGMODE_EASEINOUT);break;case Ie.EaseInQuint:this._easingFunction=new qa,this._easingFunction.setEasingMode(qa.EASINGMODE_EASEIN);break;case Ie.EaseOutQuint:this._easingFunction=new qa,this._easingFunction.setEasingMode(qa.EASINGMODE_EASEOUT);break;case Ie.EaseInOutQuint:this._easingFunction=new qa,this._easingFunction.setEasingMode(qa.EASINGMODE_EASEINOUT);break;case Ie.EaseInExpo:this._easingFunction=new sa,this._easingFunction.setEasingMode(sa.EASINGMODE_EASEIN);break;case Ie.EaseOutExpo:this._easingFunction=new sa,this._easingFunction.setEasingMode(sa.EASINGMODE_EASEOUT);break;case Ie.EaseInOutExpo:this._easingFunction=new sa,this._easingFunction.setEasingMode(sa.EASINGMODE_EASEINOUT);break;case Ie.EaseInCirc:this._easingFunction=new Pn,this._easingFunction.setEasingMode(Pn.EASINGMODE_EASEIN);break;case Ie.EaseOutCirc:this._easingFunction=new Pn,this._easingFunction.setEasingMode(Pn.EASINGMODE_EASEOUT);break;case Ie.EaseInOutCirc:this._easingFunction=new Pn,this._easingFunction.setEasingMode(Pn.EASINGMODE_EASEINOUT);break;case Ie.EaseInBack:this._easingFunction=new oa,this._easingFunction.setEasingMode(oa.EASINGMODE_EASEIN);break;case Ie.EaseOutBack:this._easingFunction=new oa,this._easingFunction.setEasingMode(oa.EASINGMODE_EASEOUT);break;case Ie.EaseInOutBack:this._easingFunction=new oa,this._easingFunction.setEasingMode(oa.EASINGMODE_EASEINOUT);break;case Ie.EaseInElastic:this._easingFunction=new na,this._easingFunction.setEasingMode(na.EASINGMODE_EASEIN);break;case Ie.EaseOutElastic:this._easingFunction=new na,this._easingFunction.setEasingMode(na.EASINGMODE_EASEOUT);break;case Ie.EaseInOutElastic:this._easingFunction=new na,this._easingFunction.setEasingMode(na.EASINGMODE_EASEINOUT);break}}constructor(e){super(e),this._easingFunction=new en,this._type=Ie.EaseInOutSine,this.registerInput("input",b.AutoDetect),this.registerOutput("output",b.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(b.Matrix),this._inputs[0].excludedConnectionPointTypes.push(b.Geometry),this._inputs[0].excludedConnectionPointTypes.push(b.Texture)}getClassName(){return"GeometryEaseBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),!this._easingFunction){this.output._storedFunction=null,this.output._storedValue=null;return}switch(this.input.type){case b.Int:case b.Float:{this.output._storedFunction=t=>{const i=this.input.getConnectedValue(t);return this._easingFunction.ease(i)};break}case b.Vector2:{this.output._storedFunction=t=>{const i=this.input.getConnectedValue(t);return new X(this._easingFunction.ease(i.x),this._easingFunction.ease(i.y))};break}case b.Vector3:{this.output._storedFunction=t=>{const i=this.input.getConnectedValue(t);return new x(this._easingFunction.ease(i.x),this._easingFunction.ease(i.y),this._easingFunction.ease(i.z))};break}case b.Vector4:{this.output._storedFunction=t=>{const i=this.input.getConnectedValue(t);return new Ee(this._easingFunction.ease(i.x),this._easingFunction.ease(i.y),this._easingFunction.ease(i.z),this._easingFunction.ease(i.w))};break}}return this}serialize(){const e=super.serialize();return e.type=this.type,e}_deserialize(e){super._deserialize(e),this.type=e.type}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.type = BABYLON.GeometryEaseBlockTypes.${Ie[this.type]};
`}}_([O("Type",5,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"EaseInSine",value:Ie.EaseInSine},{label:"EaseOutSine",value:Ie.EaseOutSine},{label:"EaseInOutSine",value:Ie.EaseInOutSine},{label:"EaseInQuad",value:Ie.EaseInQuad},{label:"EaseOutQuad",value:Ie.EaseOutQuad},{label:"EaseInOutQuad",value:Ie.EaseInOutQuad},{label:"EaseInCubic",value:Ie.EaseInCubic},{label:"EaseOutCubic",value:Ie.EaseOutCubic},{label:"EaseInOutCubic",value:Ie.EaseInOutCubic},{label:"EaseInQuart",value:Ie.EaseInQuart},{label:"EaseOutQuart",value:Ie.EaseOutQuart},{label:"EaseInOutQuart",value:Ie.EaseInOutQuart},{label:"EaseInQuint",value:Ie.EaseInQuint},{label:"EaseOutQuint",value:Ie.EaseOutQuint},{label:"EaseInOutQuint",value:Ie.EaseInOutQuint},{label:"EaseInExpo",value:Ie.EaseInExpo},{label:"EaseOutExpo",value:Ie.EaseOutExpo},{label:"EaseInOutExpo",value:Ie.EaseInOutExpo},{label:"EaseInCirc",value:Ie.EaseInCirc},{label:"EaseOutCirc",value:Ie.EaseOutCirc},{label:"EaseInOutCirc",value:Ie.EaseInOutCirc},{label:"EaseInBack",value:Ie.EaseInBack},{label:"EaseOutBack",value:Ie.EaseOutBack},{label:"EaseInOutBack",value:Ie.EaseInOutBack},{label:"EaseInElastic",value:Ie.EaseInElastic},{label:"EaseOutElastic",value:Ie.EaseOutElastic},{label:"EaseInOutElastic",value:Ie.EaseInOutElastic}]})],U0.prototype,"type",null);y("BABYLON.GeometryEaseBlock",U0);var Ds;(function(s){s[s.Max=0]="Max",s[s.Min=1]="Min",s[s.Sum=2]="Sum"})(Ds||(Ds={}));class $_ extends de{constructor(e){super(e),this.aggregation=Ds.Sum,this.evaluateContext=!0,this.registerInput("geometry",b.Geometry),this.registerInput("source",b.AutoDetect),this.registerOutput("output",b.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[1]}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"AggregatorBlock"}get geometry(){return this._inputs[0]}get source(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=i=>{if(i.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(i),i.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions||!this.source.isConnected){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=null;return}const r=this._vertexData.positions.length/3,n=[];for(this._currentIndex=0;this._currentIndex<r;this._currentIndex++)n.push(this.source.getConnectedValue(i));let a=null;switch(this.aggregation){case Ds.Max:{a=(l,c)=>Math.max(l,c);break}case Ds.Min:{a=(l,c)=>Math.min(l,c);break}case Ds.Sum:{a=(l,c)=>l+c;break}}if(!a){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedFunction=null,this.output._storedValue=null;return}let o;switch(this.source.type){case b.Int:case b.Float:{o=n.reduce(a);break}case b.Vector2:{const l=n.map(u=>u.x).reduce(a),c=n.map(u=>u.y).reduce(a);o=new X(l,c);break}case b.Vector3:{const l=n.map(h=>h.x).reduce(a),c=n.map(h=>h.y).reduce(a),u=n.map(h=>h.z).reduce(a);o=new x(l,c,u);break}case b.Vector4:{const l=n.map(d=>d.x).reduce(a),c=n.map(d=>d.y).reduce(a),u=n.map(d=>d.z).reduce(a),h=n.map(d=>d.w).reduce(a);o=new Ee(l,c,u,h);break}}return i.restoreGeometryContext(),i.restoreExecutionContext(),o};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`;return e+=`${this._codeVariableName}.aggregation = BABYLON.Aggregations.${Ds[this.aggregation]};
`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.aggregation=this.aggregation,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext),e.aggregation!==void 0&&(this.aggregation=e.aggregation)}}_([O("Aggregation",5,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Max",value:Ds.Max},{label:"Min",value:Ds.Min},{label:"Sum",value:Ds.Sum}]})],$_.prototype,"aggregation",void 0);_([O("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],$_.prototype,"evaluateContext",void 0);y("BABYLON.AggregatorBlock",$_);class X_ extends de{constructor(e){super(e),this.flatOnly=!1,this.loopWeight=1,this.registerInput("geometry",b.Geometry),this.registerInput("level",b.Int,!0,1,0,8),this.registerOutput("output",b.Geometry)}getClassName(){return"SubdivideBlock"}get geometry(){return this._inputs[0]}get level(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){this.output._storedFunction=e=>{if(!this.geometry.isConnected)return null;const t=this.geometry.getConnectedValue(e);if(!t)return null;const i=this.level.getConnectedValue(e);return J4(t,i,{flatOnly:this.flatOnly,weight:this.loopWeight})}}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.flatOnly = ${this.flatOnly?"true":"false"};
`;return e+=`${this._codeVariableName}.loopWeight = ${this.loopWeight};
`,e}serialize(){const e=super.serialize();return e.flatOnly=this.flatOnly,e.loopWeight=this.loopWeight,e}_deserialize(e){super._deserialize(e),this.flatOnly=e.flatOnly,this.loopWeight=e.loopWeight}}_([O("Flat Only",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],X_.prototype,"flatOnly",void 0);_([O("Loop weight",1,"ADVANCED",{embedded:!0,min:0,max:1,notifiers:{rebuild:!0}})],X_.prototype,"loopWeight",void 0);y("BABYLON.SubdivideBlock",X_);const ws=(s,e)=>{const t=(1<<e)-1;return(s&t)/t},QT=(s,e)=>{e.x=ws(s>>>21,11),e.y=ws(s>>>11,10),e.z=ws(s,11)},WW=(s,e)=>{e[0]=ws(s>>>24,8)*255,e[1]=ws(s>>>16,8)*255,e[2]=ws(s>>>8,8)*255,e[3]=ws(s,8)*255},HW=(s,e)=>{const t=1/(Math.sqrt(2)*.5),i=(ws(s>>>20,10)-.5)*t,r=(ws(s>>>10,10)-.5)*t,n=(ws(s,10)-.5)*t,a=Math.sqrt(1-(i*i+r*r+n*n));switch(s>>>30){case 0:e.set(a,i,r,n);break;case 1:e.set(i,a,r,n);break;case 2:e.set(i,r,a,n);break;case 3:e.set(i,r,n,a);break}};var KT;(function(s){s[s.FLOAT=0]="FLOAT",s[s.INT=1]="INT",s[s.UINT=2]="UINT",s[s.DOUBLE=3]="DOUBLE",s[s.UCHAR=4]="UCHAR",s[s.UNDEFINED=5]="UNDEFINED"})(KT||(KT={}));var JT;(function(s){s[s.MIN_X=0]="MIN_X",s[s.MIN_Y=1]="MIN_Y",s[s.MIN_Z=2]="MIN_Z",s[s.MAX_X=3]="MAX_X",s[s.MAX_Y=4]="MAX_Y",s[s.MAX_Z=5]="MAX_Z",s[s.MIN_SCALE_X=6]="MIN_SCALE_X",s[s.MIN_SCALE_Y=7]="MIN_SCALE_Y",s[s.MIN_SCALE_Z=8]="MIN_SCALE_Z",s[s.MAX_SCALE_X=9]="MAX_SCALE_X",s[s.MAX_SCALE_Y=10]="MAX_SCALE_Y",s[s.MAX_SCALE_Z=11]="MAX_SCALE_Z",s[s.PACKED_POSITION=12]="PACKED_POSITION",s[s.PACKED_ROTATION=13]="PACKED_ROTATION",s[s.PACKED_SCALE=14]="PACKED_SCALE",s[s.PACKED_COLOR=15]="PACKED_COLOR",s[s.X=16]="X",s[s.Y=17]="Y",s[s.Z=18]="Z",s[s.SCALE_0=19]="SCALE_0",s[s.SCALE_1=20]="SCALE_1",s[s.SCALE_2=21]="SCALE_2",s[s.DIFFUSE_RED=22]="DIFFUSE_RED",s[s.DIFFUSE_GREEN=23]="DIFFUSE_GREEN",s[s.DIFFUSE_BLUE=24]="DIFFUSE_BLUE",s[s.OPACITY=25]="OPACITY",s[s.F_DC_0=26]="F_DC_0",s[s.F_DC_1=27]="F_DC_1",s[s.F_DC_2=28]="F_DC_2",s[s.F_DC_3=29]="F_DC_3",s[s.ROT_0=30]="ROT_0",s[s.ROT_1=31]="ROT_1",s[s.ROT_2=32]="ROT_2",s[s.ROT_3=33]="ROT_3",s[s.MIN_COLOR_R=34]="MIN_COLOR_R",s[s.MIN_COLOR_G=35]="MIN_COLOR_G",s[s.MIN_COLOR_B=36]="MIN_COLOR_B",s[s.MAX_COLOR_R=37]="MAX_COLOR_R",s[s.MAX_COLOR_G=38]="MAX_COLOR_G",s[s.MAX_COLOR_B=39]="MAX_COLOR_B",s[s.SH_0=40]="SH_0",s[s.SH_1=41]="SH_1",s[s.SH_2=42]="SH_2",s[s.SH_3=43]="SH_3",s[s.SH_4=44]="SH_4",s[s.SH_5=45]="SH_5",s[s.SH_6=46]="SH_6",s[s.SH_7=47]="SH_7",s[s.SH_8=48]="SH_8",s[s.SH_9=49]="SH_9",s[s.SH_10=50]="SH_10",s[s.SH_11=51]="SH_11",s[s.SH_12=52]="SH_12",s[s.SH_13=53]="SH_13",s[s.SH_14=54]="SH_14",s[s.SH_15=55]="SH_15",s[s.SH_16=56]="SH_16",s[s.SH_17=57]="SH_17",s[s.SH_18=58]="SH_18",s[s.SH_19=59]="SH_19",s[s.SH_20=60]="SH_20",s[s.SH_21=61]="SH_21",s[s.SH_22=62]="SH_22",s[s.SH_23=63]="SH_23",s[s.SH_24=64]="SH_24",s[s.SH_25=65]="SH_25",s[s.SH_26=66]="SH_26",s[s.SH_27=67]="SH_27",s[s.SH_28=68]="SH_28",s[s.SH_29=69]="SH_29",s[s.SH_30=70]="SH_30",s[s.SH_31=71]="SH_31",s[s.SH_32=72]="SH_32",s[s.SH_33=73]="SH_33",s[s.SH_34=74]="SH_34",s[s.SH_35=75]="SH_35",s[s.SH_36=76]="SH_36",s[s.SH_37=77]="SH_37",s[s.SH_38=78]="SH_38",s[s.SH_39=79]="SH_39",s[s.SH_40=80]="SH_40",s[s.SH_41=81]="SH_41",s[s.SH_42=82]="SH_42",s[s.SH_43=83]="SH_43",s[s.SH_44=84]="SH_44",s[s.UNDEFINED=85]="UNDEFINED"})(JT||(JT={}));class yt extends Oe{get viewDirectionFactor(){return this._viewDirectionFactor}get shDegree(){return this._shDegree}get splatCount(){var e;return(e=this._splatIndex)==null?void 0:e.length}get splatsData(){return this._splatsData}get covariancesATexture(){return this._covariancesATexture}get covariancesBTexture(){return this._covariancesBTexture}get centersTexture(){return this._centersTexture}get colorsTexture(){return this._colorsTexture}get shTextures(){return this._shTextures}get kernelSize(){return this._material instanceof tr?this._material.kernelSize:0}get compensation(){return this._material instanceof tr?this._material.compensation:!1}set material(e){this._material=e,this._material.backFaceCulling=!0,this._material.cullBackFaces=!1,e.resetDrawCache()}get material(){return this._material}constructor(e,t=null,i=null,r=!1){super(e,i),this._vertexCount=0,this._worker=null,this._frameIdLastUpdate=-1,this._modelViewMatrix=z.Identity(),this._canPostToWorker=!0,this._readyToDisplay=!1,this._covariancesATexture=null,this._covariancesBTexture=null,this._centersTexture=null,this._colorsTexture=null,this._splatPositions=null,this._splatIndex=null,this._shTextures=null,this._splatsData=null,this._sh=null,this._keepInRam=!1,this._delayedTextureUpdate=null,this._oldDirection=new x,this._useRGBACovariants=!1,this._material=null,this._tmpCovariances=[0,0,0,0,0,0],this._sortIsDirty=!1,this._shDegree=0,this._viewDirectionFactor=new x(1,1,-1);const n=new li;n.positions=[-2,-2,0,2,-2,0,2,2,0,-2,2,0],n.indices=[0,1,2,0,2,3],n.applyToMesh(this),this.subMeshes=[],new Yn(0,0,4,0,6,this),this.setEnabled(!1),this._useRGBACovariants=!this.getEngine().isWebGPU&&this.getEngine().version===1,this._keepInRam=r,t&&this.loadFileAsync(t),this._material=new tr(this.name+"_material",this._scene)}getClassName(){return"GaussianSplattingMesh"}getTotalVertices(){return this._vertexCount}isReady(e=!1){return super.isReady(e,!0)?this._readyToDisplay?!0:(this._postToWorker(!0),!1):!1}_postToWorker(e=!1){const t=this.getScene().getFrameId();if((e||t!==this._frameIdLastUpdate)&&this._worker&&this._scene.activeCamera&&this._canPostToWorker){const i=this._scene.activeCamera.getViewMatrix();this.getWorldMatrix().multiplyToRef(i,this._modelViewMatrix),i.invertToRef(G.Matrix[0]),this.getWorldMatrix().multiplyToRef(G.Matrix[0],G.Matrix[1]),x.TransformNormalToRef(x.Forward(this._scene.useRightHandedSystem),G.Matrix[1],G.Vector3[2]),G.Vector3[2].normalize();const r=x.Dot(G.Vector3[2],this._oldDirection);(e||Math.abs(r-1)>=.01)&&(this._oldDirection.copyFrom(G.Vector3[2]),this._frameIdLastUpdate=t,this._canPostToWorker=!1,this._worker.postMessage({view:this._modelViewMatrix.m,depthMix:this._depthMix,useRightHandedSystem:this._scene.useRightHandedSystem},[this._depthMix.buffer]))}}render(e,t,i){return this._postToWorker(),super.render(e,t,i)}static _TypeNameToEnum(e){switch(e){case"float":return 0;case"int":return 1;case"uint":return 2;case"double":return 3;case"uchar":return 4}return 5}static _ValueNameToEnum(e){switch(e){case"min_x":return 0;case"min_y":return 1;case"min_z":return 2;case"max_x":return 3;case"max_y":return 4;case"max_z":return 5;case"min_scale_x":return 6;case"min_scale_y":return 7;case"min_scale_z":return 8;case"max_scale_x":return 9;case"max_scale_y":return 10;case"max_scale_z":return 11;case"packed_position":return 12;case"packed_rotation":return 13;case"packed_scale":return 14;case"packed_color":return 15;case"x":return 16;case"y":return 17;case"z":return 18;case"scale_0":return 19;case"scale_1":return 20;case"scale_2":return 21;case"diffuse_red":case"red":return 22;case"diffuse_green":case"green":return 23;case"diffuse_blue":case"blue":return 24;case"f_dc_0":return 26;case"f_dc_1":return 27;case"f_dc_2":return 28;case"f_dc_3":return 29;case"opacity":return 25;case"rot_0":return 30;case"rot_1":return 31;case"rot_2":return 32;case"rot_3":return 33;case"min_r":return 34;case"min_g":return 35;case"min_b":return 36;case"max_r":return 37;case"max_g":return 38;case"max_b":return 39;case"f_rest_0":return 40;case"f_rest_1":return 41;case"f_rest_2":return 42;case"f_rest_3":return 43;case"f_rest_4":return 44;case"f_rest_5":return 45;case"f_rest_6":return 46;case"f_rest_7":return 47;case"f_rest_8":return 48;case"f_rest_9":return 49;case"f_rest_10":return 50;case"f_rest_11":return 51;case"f_rest_12":return 52;case"f_rest_13":return 53;case"f_rest_14":return 54;case"f_rest_15":return 55;case"f_rest_16":return 56;case"f_rest_17":return 57;case"f_rest_18":return 58;case"f_rest_19":return 59;case"f_rest_20":return 60;case"f_rest_21":return 61;case"f_rest_22":return 62;case"f_rest_23":return 63;case"f_rest_24":return 64;case"f_rest_25":return 65;case"f_rest_26":return 66;case"f_rest_27":return 67;case"f_rest_28":return 68;case"f_rest_29":return 69;case"f_rest_30":return 70;case"f_rest_31":return 71;case"f_rest_32":return 72;case"f_rest_33":return 73;case"f_rest_34":return 74;case"f_rest_35":return 75;case"f_rest_36":return 76;case"f_rest_37":return 77;case"f_rest_38":return 78;case"f_rest_39":return 79;case"f_rest_40":return 80;case"f_rest_41":return 81;case"f_rest_42":return 82;case"f_rest_43":return 83;case"f_rest_44":return 84}return 85}static ParseHeader(e){const t=new Uint8Array(e),i=new TextDecoder().decode(t.slice(0,1024*10)),r=`end_header
`,n=i.indexOf(r);if(n<0||!i)return null;const a=parseInt(/element vertex (\d+)\n/.exec(i)[1]),o=/element chunk (\d+)\n/.exec(i);let l=0;o&&(l=parseInt(o[1]));let c=0,u=0;const h={double:8,int:4,uint:4,float:4,short:2,ushort:2,uchar:1,list:0};let d;(function(F){F[F.Vertex=0]="Vertex",F[F.Chunk=1]="Chunk",F[F.SH=2]="SH"})(d||(d={}));let f=1;const m=[],g=[],v=i.slice(0,n).split(`
`);let E=0;for(const F of v)if(F.startsWith("property ")){const[,V,D]=F.split(" "),w=yt._ValueNameToEnum(D);w!=85&&(w>=84?E=3:w>=64?E=2:w>=48&&(E=1));const B=yt._TypeNameToEnum(V);f==1?(g.push({value:w,type:B,offset:u}),u+=h[V]):f==0?(m.push({value:w,type:B,offset:c}),c+=h[V]):f==2&&m.push({value:w,type:B,offset:c}),h[V]||N.Warn(`Unsupported property type: ${V}.`)}else if(F.startsWith("element ")){const[,V]=F.split(" ");V=="chunk"?f=1:V=="vertex"?f=0:V=="sh"&&(f=2)}const T=new DataView(e,n+r.length),C=new ArrayBuffer(yt._RowOutputLength*a);let A=null,I=0;return E&&(I=((E+1)*(E+1)-1)*3,A=new ArrayBuffer(I*a)),{vertexCount:a,chunkCount:l,rowVertexLength:c,rowChunkLength:u,vertexProperties:m,chunkProperties:g,dataView:T,buffer:C,shDegree:E,shCoefficientCount:I,shBuffer:A}}static _GetCompressedChunks(e,t){if(!e.chunkCount)return null;const i=e.dataView,r=new Array(e.chunkCount);for(let n=0;n<e.chunkCount;n++){const a={min:new x,max:new x,minScale:new x,maxScale:new x,minColor:new x(0,0,0),maxColor:new x(1,1,1)};r[n]=a;for(let o=0;o<e.chunkProperties.length;o++){const l=e.chunkProperties[o];let c;switch(l.type){case 0:c=i.getFloat32(l.offset+t.value,!0);break;default:continue}switch(l.value){case 0:a.min.x=c;break;case 1:a.min.y=c;break;case 2:a.min.z=c;break;case 3:a.max.x=c;break;case 4:a.max.y=c;break;case 5:a.max.z=c;break;case 6:a.minScale.x=c;break;case 7:a.minScale.y=c;break;case 8:a.minScale.z=c;break;case 9:a.maxScale.x=c;break;case 10:a.maxScale.y=c;break;case 11:a.maxScale.z=c;break;case 34:a.minColor.x=c;break;case 35:a.minColor.y=c;break;case 36:a.minColor.z=c;break;case 37:a.maxColor.x=c;break;case 38:a.maxColor.y=c;break;case 39:a.maxColor.z=c;break}}t.value+=e.rowChunkLength}return r}static _GetSplat(e,t,i,r){const n=G.Quaternion[0],a=G.Vector3[0],o=yt._RowOutputLength,l=e.buffer,c=e.dataView,u=new Float32Array(l,t*o,3),h=new Float32Array(l,t*o+12,3),d=new Uint8ClampedArray(l,t*o+24,4),f=new Uint8ClampedArray(l,t*o+28,4);let m=null;e.shBuffer&&(m=new Uint8ClampedArray(e.shBuffer,t*e.shCoefficientCount,e.shCoefficientCount));const g=t>>8;let v=255,E=0,T=0,C=0;const A=[];for(let I=0;I<e.vertexProperties.length;I++){const F=e.vertexProperties[I];let V;switch(F.type){case 0:V=c.getFloat32(r.value+F.offset,!0);break;case 1:V=c.getInt32(r.value+F.offset,!0);break;case 2:V=c.getUint32(r.value+F.offset,!0);break;case 3:V=c.getFloat64(r.value+F.offset,!0);break;case 4:V=c.getUint8(r.value+F.offset);break;default:continue}switch(F.value){case 12:{const D=i[g];QT(V,a),u[0]=rs.Lerp(D.min.x,D.max.x,a.x),u[1]=rs.Lerp(D.min.y,D.max.y,a.y),u[2]=rs.Lerp(D.min.z,D.max.z,a.z)}break;case 13:HW(V,n),v=n.x,E=n.y,T=n.z,C=n.w;break;case 14:{const D=i[g];QT(V,a),h[0]=Math.exp(rs.Lerp(D.minScale.x,D.maxScale.x,a.x)),h[1]=Math.exp(rs.Lerp(D.minScale.y,D.maxScale.y,a.y)),h[2]=Math.exp(rs.Lerp(D.minScale.z,D.maxScale.z,a.z))}break;case 15:{const D=i[g];WW(V,d),d[0]=rs.Lerp(D.minColor.x,D.maxColor.x,d[0]/255)*255,d[1]=rs.Lerp(D.minColor.y,D.maxColor.y,d[1]/255)*255,d[2]=rs.Lerp(D.minColor.z,D.maxColor.z,d[2]/255)*255}break;case 16:u[0]=V;break;case 17:u[1]=V;break;case 18:u[2]=V;break;case 19:h[0]=Math.exp(V);break;case 20:h[1]=Math.exp(V);break;case 21:h[2]=Math.exp(V);break;case 22:d[0]=V;break;case 23:d[1]=V;break;case 24:d[2]=V;break;case 26:d[0]=(.5+yt._SH_C0*V)*255;break;case 27:d[1]=(.5+yt._SH_C0*V)*255;break;case 28:d[2]=(.5+yt._SH_C0*V)*255;break;case 29:d[3]=(.5+yt._SH_C0*V)*255;break;case 25:d[3]=1/(1+Math.exp(-V))*255;break;case 30:v=V;break;case 31:E=V;break;case 32:T=V;break;case 33:C=V;break}if(m&&F.value>=40&&F.value<=84){const D=F.value-40;if(F.type==4&&e.chunkCount){const w=c.getUint8(e.rowChunkLength*e.chunkCount+e.vertexCount*e.rowVertexLength+t*e.shCoefficientCount+D);A[D]=(w*(8/255)-4)*127.5+127.5}else{const w=rs.Clamp(V*127.5+127.5,0,255);A[D]=w}}}if(m){const I=e.shDegree==1?3:e.shDegree==2?8:15;for(let F=0;F<I;F++)m[F*3+0]=A[F],m[F*3+1]=A[F+I],m[F*3+2]=A[F+I*2]}n.set(E,T,C,v),n.normalize(),f[0]=n.w*127.5+127.5,f[1]=n.x*127.5+127.5,f[2]=n.y*127.5+127.5,f[3]=n.z*127.5+127.5,r.value+=e.rowVertexLength}static*ConvertPLYWithSHToSplat(e,t=!1){const i=yt.ParseHeader(e);if(!i)return{buffer:e};const r={value:0},n=yt._GetCompressedChunks(i,r);for(let o=0;o<i.vertexCount;o++)yt._GetSplat(i,o,n,r),o%yt._PlyConversionBatchSize===0&&t&&(yield);let a=null;if(i.shDegree&&i.shBuffer){const o=Math.ceil(i.shCoefficientCount/16);let l=0;const c=new Uint8Array(i.shBuffer);a=[];const u=i.vertexCount,h=De.LastCreatedEngine;if(h){const d=h.getCaps().maxTextureSize,f=Math.ceil(u/d);for(let m=0;m<o;m++){const g=new Uint8Array(f*d*4*4);a.push(g)}for(let m=0;m<u;m++)for(let g=0;g<i.shCoefficientCount;g++){const v=c[l++],E=Math.floor(g/16),T=a[E],C=g%16,A=m*16;T[C+A]=v}}}return{buffer:i.buffer,sh:a}}static*ConvertPLYToSplat(e,t=!1){const i=yt.ParseHeader(e);if(!i)return e;const r={value:0},n=yt._GetCompressedChunks(i,r);for(let a=0;a<i.vertexCount;a++)yt._GetSplat(i,a,n,r),a%yt._PlyConversionBatchSize===0&&t&&(yield);return i.buffer}static async ConvertPLYToSplatAsync(e){return await Uc(yt.ConvertPLYToSplat(e,!0),zh())}static async ConvertPLYWithSHToSplatAsync(e){return await Uc(yt.ConvertPLYWithSHToSplat(e,!0),zh())}async loadDataAsync(e){return await this.updateDataAsync(e)}async loadFileAsync(e){const t=await j.LoadFileAsync(e,!0),i=await yt.ConvertPLYWithSHToSplatAsync(t);await this.updateDataAsync(i.buffer,i.sh)}dispose(e){var t,i,r,n,a;if((t=this._covariancesATexture)==null||t.dispose(),(i=this._covariancesBTexture)==null||i.dispose(),(r=this._centersTexture)==null||r.dispose(),(n=this._colorsTexture)==null||n.dispose(),this._shTextures)for(const o of this._shTextures)o.dispose();this._covariancesATexture=null,this._covariancesBTexture=null,this._centersTexture=null,this._colorsTexture=null,this._shTextures=null,(a=this._worker)==null||a.terminate(),this._worker=null,super.dispose(e,!0)}_copyTextures(e){var t,i,r,n,a;if(this._covariancesATexture=(t=e.covariancesATexture)==null?void 0:t.clone(),this._covariancesBTexture=(i=e.covariancesBTexture)==null?void 0:i.clone(),this._centersTexture=(r=e.centersTexture)==null?void 0:r.clone(),this._colorsTexture=(n=e.colorsTexture)==null?void 0:n.clone(),e._shTextures){this._shTextures=[];for(const o of this._shTextures)(a=this._shTextures)==null||a.push(o.clone())}}clone(e=""){const t=new yt(e,void 0,this.getScene());t._copySource(this),t.makeGeometryUnique(),t._vertexCount=this._vertexCount,t._copyTextures(this),t._modelViewMatrix=z.Identity(),t._splatPositions=this._splatPositions,t._readyToDisplay=!1,t._instanciateWorker();const i=this.getBoundingInfo();return t.getBoundingInfo().reConstruct(i.minimum,i.maximum,this.getWorldMatrix()),t.forcedInstanceCount=t._vertexCount,t.setEnabled(!0),t}_makeSplat(e,t,i,r,n,a,o,l){const c=G.Matrix[0],u=G.Matrix[1],h=G.Quaternion[0],d=this._useRGBACovariants?4:2,f=t[8*e+0],m=-t[8*e+1],g=t[8*e+2];this._splatPositions[4*e+0]=f,this._splatPositions[4*e+1]=m,this._splatPositions[4*e+2]=g,o.minimizeInPlaceFromFloats(f,m,g),l.maximizeInPlaceFromFloats(f,m,g),h.set((i[32*e+28+1]-127.5)/127.5,(i[32*e+28+2]-127.5)/127.5,(i[32*e+28+3]-127.5)/127.5,-(i[32*e+28+0]-127.5)/127.5),h.normalize(),h.toRotationMatrix(c),z.ScalingToRef(t[8*e+3+0]*2,t[8*e+3+1]*2,t[8*e+3+2]*2,u);const v=c.multiplyToRef(u,G.Matrix[0]).m,E=this._tmpCovariances;E[0]=v[0]*v[0]+v[1]*v[1]+v[2]*v[2],E[1]=v[0]*v[4]+v[1]*v[5]+v[2]*v[6],E[2]=v[0]*v[8]+v[1]*v[9]+v[2]*v[10],E[3]=v[4]*v[4]+v[5]*v[5]+v[6]*v[6],E[4]=v[4]*v[8]+v[5]*v[9]+v[6]*v[10],E[5]=v[8]*v[8]+v[9]*v[9]+v[10]*v[10];let T=-1e4;for(let A=0;A<6;A++)T=Math.max(T,Math.abs(E[A]));this._splatPositions[4*e+3]=T;const C=T;r[e*4+0]=rn(E[0]/C),r[e*4+1]=rn(E[1]/C),r[e*4+2]=rn(E[2]/C),r[e*4+3]=rn(E[3]/C),n[e*d+0]=rn(E[4]/C),n[e*d+1]=rn(E[5]/C),a[e*4+0]=i[32*e+24+0],a[e*4+1]=i[32*e+24+1],a[e*4+2]=i[32*e+24+2],a[e*4+3]=i[32*e+24+3]}_updateTextures(e,t,i,r){const n=this._getTextureSize(this._vertexCount),a=(u,h,d,f)=>new gi(u,h,d,f,this._scene,!1,!1,2,1),o=(u,h,d,f)=>new gi(u,h,d,f,this._scene,!1,!1,2,0),l=(u,h,d,f)=>new gi(u,h,d,f,this._scene,!1,!1,1,7),c=(u,h,d,f)=>new gi(u,h,d,f,this._scene,!1,!1,2,2);if(this._covariancesATexture){this._delayedTextureUpdate={covA:e,covB:t,colors:i,centers:this._splatPositions,sh:r};const u=Float32Array.from(this._splatPositions),h=this._vertexCount;this._worker.postMessage({positions:u,vertexCount:h},[u.buffer]),this._postToWorker(!0)}else{if(this._covariancesATexture=c(e,n.x,n.y,5),this._covariancesBTexture=c(t,n.x,n.y,this._useRGBACovariants?5:7),this._centersTexture=a(this._splatPositions,n.x,n.y,5),this._colorsTexture=o(i,n.x,n.y,5),r){this._shTextures=[];for(const u of r){const h=new Uint32Array(u.buffer),d=l(h,n.x,n.y,11);d.wrapU=0,d.wrapV=0,this._shTextures.push(d)}}this._instanciateWorker()}}*_updateData(e,t,i){this._covariancesATexture||(this._readyToDisplay=!1);const r=new Uint8Array(e),n=new Float32Array(r.buffer);this._keepInRam&&(this._splatsData=e,i&&(this._sh=i));const a=r.length/yt._RowOutputLength;a!=this._vertexCount&&this._updateSplatIndexBuffer(a),this._vertexCount=a,this._shDegree=i?i.length:0;const o=this._getTextureSize(a),l=o.x*o.y,c=yt.ProgressiveUpdateAmount??o.y,u=o.x*c;this._splatPositions=new Float32Array(4*l);const h=new Uint16Array(l*4),d=new Uint16Array((this._useRGBACovariants?4:2)*l),f=new Uint8Array(l*4),m=new x(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),g=new x(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(yt.ProgressiveUpdateAmount){this._updateTextures(h,d,f,i),this.setEnabled(!0);const v=Math.ceil(o.y/c);for(let C=0;C<v;C++){const A=C*c,I=A*o.x;for(let F=0;F<u;F++)this._makeSplat(I+F,n,r,h,d,f,m,g);this._updateSubTextures(this._splatPositions,h,d,f,A,Math.min(c,o.y-A)),this.getBoundingInfo().reConstruct(m,g,this.getWorldMatrix()),t&&(yield)}const E=Float32Array.from(this._splatPositions),T=this._vertexCount;this._worker.postMessage({positions:E,vertexCount:T},[E.buffer]),this._sortIsDirty=!0}else{for(let v=0;v<a;v++)this._makeSplat(v,n,r,h,d,f,m,g),t&&v%yt._SplatBatchSize===0&&(yield);this._updateTextures(h,d,f,i),this.getBoundingInfo().reConstruct(m,g,this.getWorldMatrix()),this.setEnabled(!0)}this._postToWorker(!0)}async updateDataAsync(e,t){return await Uc(this._updateData(e,!0,t),zh())}updateData(e,t){QD(this._updateData(e,!1,t))}refreshBoundingInfo(){return this.thinInstanceRefreshBoundingInfo(!1),this}_updateSplatIndexBuffer(e){(!this._splatIndex||e>this._splatIndex.length)&&(this._splatIndex=new Float32Array(e),this.thinInstanceSetBuffer("splatIndex",this._splatIndex,1,!1)),this.forcedInstanceCount=e}_updateSubTextures(e,t,i,r,n,a,o){const l=(E,T,C,A,I)=>{this.getEngine().updateTextureData(E.getInternalTexture(),T,0,A,C,I,0,0,!1)},c=this._getTextureSize(this._vertexCount),u=this._useRGBACovariants?4:2,h=n*c.x,d=a*c.x,f=new Uint16Array(t.buffer,h*4*Uint16Array.BYTES_PER_ELEMENT,d*4),m=new Uint16Array(i.buffer,h*u*Uint16Array.BYTES_PER_ELEMENT,d*u),g=new Uint8Array(r.buffer,h*4,d*4),v=new Float32Array(e.buffer,h*4*Float32Array.BYTES_PER_ELEMENT,d*4);if(l(this._covariancesATexture,f,c.x,n,a),l(this._covariancesBTexture,m,c.x,n,a),l(this._centersTexture,v,c.x,n,a),l(this._colorsTexture,g,c.x,n,a),o)for(let E=0;E<o.length;E++){const C=new Uint8Array(this._sh[E].buffer,h*4,d*4);l(this._shTextures[E],C,c.x,n,a)}}_instanciateWorker(){var i;if(!this._vertexCount)return;this._updateSplatIndexBuffer(this._vertexCount),(i=this._worker)==null||i.terminate(),this._worker=new Worker(URL.createObjectURL(new Blob(["(",yt._CreateWorker.toString(),")(self)"],{type:"application/javascript"}))),this._depthMix=new BigInt64Array(this._vertexCount);const e=Float32Array.from(this._splatPositions),t=this._vertexCount;this._worker.postMessage({positions:e,vertexCount:t},[e.buffer]),this._worker.onmessage=r=>{this._depthMix=r.data.depthMix;const n=new Uint32Array(r.data.depthMix.buffer);if(this._splatIndex)for(let a=0;a<this._vertexCount;a++)this._splatIndex[a]=n[2*a];if(this._delayedTextureUpdate){const a=this._getTextureSize(t);this._updateSubTextures(this._delayedTextureUpdate.centers,this._delayedTextureUpdate.covA,this._delayedTextureUpdate.covB,this._delayedTextureUpdate.colors,0,a.y,this._delayedTextureUpdate.sh),this._delayedTextureUpdate=null}this.thinInstanceBufferUpdated("splatIndex"),this._canPostToWorker=!0,this._readyToDisplay=!0,this._sortIsDirty&&(this._postToWorker(!0),this._sortIsDirty=!1)}}_getTextureSize(e){const t=this._scene.getEngine(),i=t.getCaps().maxTextureSize;let r=1;if(t.version===1&&!t.isWebGPU)for(;i*r<e;)r*=2;else r=Math.ceil(e/i);return r>i&&(N.Error("GaussianSplatting texture size: ("+i+", "+r+"), maxTextureSize: "+i),r=i),new X(i,r)}}yt._RowOutputLength=3*4+3*4+4+4;yt._SH_C0=.28209479177387814;yt._SplatBatchSize=327680;yt._PlyConversionBatchSize=32768;yt.ProgressiveUpdateAmount=0;yt._CreateWorker=function(s){let e=0,t,i,r,n;s.onmessage=a=>{if(a.data.positions)t=a.data.positions,e=a.data.vertexCount;else{const o=a.data.view;if(!t||!o)throw new Error("positions or view is not defined!");i=a.data.depthMix,r=new Uint32Array(i.buffer),n=new Float32Array(i.buffer);for(let c=0;c<e;c++)r[2*c]=c;let l=-1;a.data.useRightHandedSystem&&(l=1);for(let c=0;c<e;c++)n[2*c+1]=1e4+(o[2]*t[4*c+0]+o[6]*t[4*c+1]+o[10]*t[4*c+2])*l;i.sort(),s.postMessage({depthMix:i},[i.buffer])}}};const eb="meshUVSpaceRendererVertexShader",$W=`precision highp float;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;uniform mat4 projMatrix;varying vec2 vDecalTC;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
void main(void) {vec3 positionUpdated=position;vec3 normalUpdated=normal;
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);mat3 normWorldSM=mat3(finalWorld);vec3 vNormalW;
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normWorldSM=transposeMat3(inverseMat3(normWorldSM));
#endif
vNormalW=normalize(normWorldSM*normalUpdated);
#endif
vec3 normalView=normalize((projMatrix*vec4(vNormalW,0.0)).xyz);vec3 decalTC=(projMatrix*worldPos).xyz;vDecalTC=decalTC.xy;gl_Position=vec4(uv*2.0-1.0,normalView.z>0.0 ? 2. : decalTC.z,1.0);}`;S.ShadersStore[eb]||(S.ShadersStore[eb]=$W);const tb="meshUVSpaceRendererPixelShader",XW=`precision highp float;varying vec2 vDecalTC;uniform sampler2D textureSampler;void main(void) {if (vDecalTC.x<0. || vDecalTC.x>1. || vDecalTC.y<0. || vDecalTC.y>1.) {discard;}
gl_FragColor=texture2D(textureSampler,vDecalTC);}
`;S.ShadersStore[tb]||(S.ShadersStore[tb]=XW);const ib="meshUVSpaceRendererMaskerVertexShader",YW="attribute vec2 uv;varying vec2 vUV;void main(void) {gl_Position=vec4(vec2(uv.x,uv.y)*2.0-1.0,0.,1.0);vUV=uv;}";S.ShadersStore[ib]||(S.ShadersStore[ib]=YW);const rb="meshUVSpaceRendererMaskerPixelShader",jW=`varying vec2 vUV;void main(void) {gl_FragColor=vec4(1.0,1.0,1.0,1.0);}
`;S.ShadersStore[rb]||(S.ShadersStore[rb]=jW);const sb="meshUVSpaceRendererFinaliserPixelShader",qW=`precision highp float;varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D maskTextureSampler;uniform vec2 textureSize;void main() {vec4 mask=texture2D(maskTextureSampler,vUV).rgba;if (mask.r>0.5) {gl_FragColor=texture2D(textureSampler,vUV);} else {vec2 texelSize=4.0/textureSize;vec2 uv_p01=vUV+vec2(-1.0,0.0)*texelSize;vec2 uv_p21=vUV+vec2(1.0,0.0)*texelSize;vec2 uv_p10=vUV+vec2(0.0,-1.0)*texelSize;vec2 uv_p12=vUV+vec2(0.0,1.0)*texelSize;float mask_p01=texture2D(maskTextureSampler,uv_p01).r;float mask_p21=texture2D(maskTextureSampler,uv_p21).r;float mask_p10=texture2D(maskTextureSampler,uv_p10).r;float mask_p12=texture2D(maskTextureSampler,uv_p12).r;vec4 col=vec4(0.0,0.0,0.0,0.0);float total_weight=0.0;if (mask_p01>0.5) {col+=texture2D(textureSampler,uv_p01);total_weight+=1.0;}
if (mask_p21>0.5) {col+=texture2D(textureSampler,uv_p21);total_weight+=1.0;}
if (mask_p10>0.5) {col+=texture2D(textureSampler,uv_p10);total_weight+=1.0;}
if (mask_p12>0.5) {col+=texture2D(textureSampler,uv_p12);total_weight+=1.0;}
if (total_weight>0.0) {gl_FragColor=col/total_weight;} else {gl_FragColor=col;}}}
`;S.ShadersStore[sb]||(S.ShadersStore[sb]=qW);const nb="meshUVSpaceRendererFinaliserVertexShader",ZW=`precision highp float;attribute vec3 position;attribute vec2 uv;uniform mat4 worldViewProjection;varying vec2 vUV;void main() {gl_Position=worldViewProjection*vec4(position,1.0);vUV=uv;}
`;S.ShadersStore[nb]||(S.ShadersStore[nb]=ZW);const ab="meshUVSpaceRendererVertexShader",QW=`attribute position: vec3f;attribute normal: vec3f;attribute uv: vec2f;uniform projMatrix: mat4x4f;varying vDecalTC: vec2f;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
@vertex
fn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;var normalUpdated: vec3f=input.normal;
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);var normWorldSM: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);var vNormalW: vec3f;
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/ vec3f(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normWorldSM=transposeMat3(inverseMat3(normWorldSM));
#endif
vNormalW=normalize(normWorldSM*normalUpdated);
#endif
var normalView: vec3f=normalize((uniforms.projMatrix* vec4f(vNormalW,0.0)).xyz);var decalTC: vec3f=(uniforms.projMatrix*worldPos).xyz;vertexOutputs.vDecalTC=decalTC.xy;vertexOutputs.position=vec4f(input.uv*2.0-1.0,select(decalTC.z,2.,normalView.z>0.0),1.0);}`;S.ShadersStoreWGSL[ab]||(S.ShadersStoreWGSL[ab]=QW);const ob="meshUVSpaceRendererPixelShader",KW=`varying vDecalTC: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {if (input.vDecalTC.x<0. || input.vDecalTC.x>1. || input.vDecalTC.y<0. || input.vDecalTC.y>1.) {discard;}
fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vDecalTC);}
`;S.ShadersStoreWGSL[ob]||(S.ShadersStoreWGSL[ob]=KW);const lb="meshUVSpaceRendererMaskerVertexShader",JW=`attribute uv: vec2f;varying vUV: vec2f;@vertex
fn main(input : VertexInputs)->FragmentInputs {vertexOutputs.position= vec4f( vec2f(input.uv.x,input.uv.y)*2.0-1.0,0.,1.0);vertexOutputs.vUV=input.uv;}`;S.ShadersStoreWGSL[lb]||(S.ShadersStoreWGSL[lb]=JW);const cb="meshUVSpaceRendererMaskerPixelShader",eH=`varying vUV: vec2f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color= vec4f(1.0,1.0,1.0,1.0);}
`;S.ShadersStoreWGSL[cb]||(S.ShadersStoreWGSL[cb]=eH);const ub="meshUVSpaceRendererFinaliserPixelShader",tH=`#define DISABLE_UNIFORMITY_ANALYSIS
varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var maskTextureSamplerSampler: sampler;var maskTextureSampler: texture_2d<f32>;uniform textureSize: vec2f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var mask: vec4f=textureSample(maskTextureSampler,maskTextureSamplerSampler,input.vUV).rgba;if (mask.r>0.5) {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);} else {var texelSize: vec2f=4.0/uniforms.textureSize;var uv_p01: vec2f=input.vUV+ vec2f(-1.0,0.0)*texelSize;var uv_p21: vec2f=input.vUV+ vec2f(1.0,0.0)*texelSize;var uv_p10: vec2f=input.vUV+ vec2f(0.0,-1.0)*texelSize;var uv_p12: vec2f=input.vUV+ vec2f(0.0,1.0)*texelSize;var mask_p01: f32=textureSample(maskTextureSampler,maskTextureSamplerSampler,uv_p01).r;var mask_p21: f32=textureSample(maskTextureSampler,maskTextureSamplerSampler,uv_p21).r;var mask_p10: f32=textureSample(maskTextureSampler,maskTextureSamplerSampler,uv_p10).r;var mask_p12: f32=textureSample(maskTextureSampler,maskTextureSamplerSampler,uv_p12).r;var col: vec4f= vec4f(0.0,0.0,0.0,0.0);var total_weight: f32=0.0;if (mask_p01>0.5) {col+=textureSample(textureSampler,textureSamplerSampler,uv_p01);total_weight+=1.0;}
if (mask_p21>0.5) {col+=textureSample(textureSampler,textureSamplerSampler,uv_p21);total_weight+=1.0;}
if (mask_p10>0.5) {col+=textureSample(textureSampler,textureSamplerSampler,uv_p10);total_weight+=1.0;}
if (mask_p12>0.5) {col+=textureSample(textureSampler,textureSamplerSampler,uv_p12);total_weight+=1.0;}
if (total_weight>0.0) {fragmentOutputs.color=col/total_weight;} else {fragmentOutputs.color=col;}}}
`;S.ShadersStoreWGSL[ub]||(S.ShadersStoreWGSL[ub]=tH);const hb="meshUVSpaceRendererFinaliserVertexShader",iH=`attribute position: vec3f;attribute uv: vec2f;uniform worldViewProjection: mat4x4f;varying vUV: vec2f;@vertex
fn main(input : VertexInputs)->FragmentInputs {vertexOutputs.position=uniforms.worldViewProjection* vec4f(input.position,1.0);vertexOutputs.positionvUV=input.uv;}
`;S.ShadersStoreWGSL[hb]||(S.ShadersStoreWGSL[hb]=iH);var db;(function(s){s[s.INIT=0]="INIT",s[s.RUNNING=1]="RUNNING",s[s.DONE=2]="DONE",s[s.ERROR=3]="ERROR"})(db||(db={}));k.prototype.notifyObserversWithPromise=async function(s,e=-1,t,i,r){let n=Promise.resolve(s);if(!this.observers.length)return await n;const a=this._eventState;a.mask=e,a.target=t,a.currentTarget=i,a.skipNextObservers=!1,a.userInfo=r;for(const o of this.observers)a.skipNextObservers||o._willBeUnregistered||o.mask&e&&(o.scope?n=n.then(l=>(a.lastReturnValue=l,o.callback.apply(o.scope,[s,a]))):n=n.then(l=>(a.lastReturnValue=l,o.callback(s,a))),o.unregisterOnNextCall&&this._deferUnregister(o));return await n,s};class el extends Se{getClassName(){return"FxaaPostProcess"}constructor(e,t,i=null,r,n,a,o=0){const l={uniforms:Mr.Uniforms,size:typeof t=="number"?t:void 0,camera:i,samplingMode:r||$.BILINEAR_SAMPLINGMODE,engine:n,reusable:a,textureType:o,...t};super(e,Mr.FragmentUrl,{effectWrapper:typeof t=="number"||!t.effectWrapper?new Mr(e,n,l):void 0,...l}),this.onApplyObservable.add(c=>{this._effectWrapper.texelSize=this.texelSize})}static _Parse(e,t,i,r){return me.Parse(()=>new el(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}}y("BABYLON.FxaaPostProcess",el);let Js=null;function k0(s,e,t,i,r="image/png",n=!1,a,o=!1,l=!1){const{height:c,width:u}=j_(s,e,t);if(!(c&&u)){N.Error("Invalid 'size' parameter !");return}const h=e.getScene();let d=h.activeCamera!==e;if(h.frameGraph){const f=th.FindMainObjectRenderer(h.frameGraph);f&&(d=f.camera!==e)}if(d){Y_(s,e,t,f=>{if(n){const m=new Blob([f]);j.DownloadBlob(m),i&&i("")}else i&&i(f)},r,1,s.getCreationOptions().antialias,void 0,void 0,void 0,void 0,a);return}s.onEndFrameObservable.addOnce(()=>{Js||(Js=document.createElement("canvas")),Js.width=u,Js.height=c;const f=Js.getContext("2d"),m=s.getRenderingCanvas();if(!f||!m){N.Error("Failed to create screenshot. Rendering context or rendering canvas is not available.");return}const g=m.width,v=m.height,E=Js.width,T=Js.height,C=E/g,A=T/v,I=o?Math.max(C,A):Math.min(C,A),F=g*I,V=v*I,D=(E-F)/2,w=(T-V)/2;f.save(),f.fillStyle=l?h.clearColor.toHexString():"rgba(0, 0, 0, 0)",f.fillRect(0,0,u,c),f.restore(),f.drawImage(m,0,0,g,v,D,w,F,V),n?(j.EncodeScreenshotCanvasData(Js,void 0,r,void 0,a),i&&i("")):j.EncodeScreenshotCanvasData(Js,i,r,void 0,a)})}async function rH(s,e,t,i="image/png",r,n=!1,a=!1,o=!1){return await new Promise((l,c)=>{k0(s,e,t,u=>{typeof u<"u"?l(u):c(new Error("Data is undefined"))},i,o,r,n,a)})}function Y_(s,e,t,i,r="image/png",n=1,a=!1,o,l=!1,c=!1,u=!0,h,d,f){const m=e.getScene();if(m.frameGraph){nH(m.frameGraph,e,t,r,n,a,o,h,f,!i).then(B=>{i&&i(B)});return}const{height:g,width:v,finalWidth:E,finalHeight:T}=j_(s,e,t),C={width:v,height:g};if(!(g&&v)){N.Error("Invalid 'size' parameter !");return}s.skipFrameRender=!0;const A=s.getRenderWidth,I=s.getRenderHeight;s.getRenderWidth=(B=!1)=>!B&&s._currentRenderTarget?s._currentRenderTarget.width:v,s.getRenderHeight=(B=!1)=>!B&&s._currentRenderTarget?s._currentRenderTarget.height:g,s.onResizeObservable.hasObservers()&&s.onResizeObservable.notifyObservers(s);const F=new Zi("screenShot",C,m,!1,!1,0,!1,$.BILINEAR_SAMPLINGMODE,void 0,c,void 0,void 0,void 0,n);F.renderList=m.meshes.slice(),F.samples=n,F.renderSprites=l,F.activeCamera=e,F.forceLayerMaskCheck=u,d==null||d(F);const V=f||AI,D=()=>{Wn(()=>F.isReadyForRendering()&&e.isReady(!0),()=>{s.onEndFrameObservable.addOnce(()=>{E===v&&T===g?F.readPixels(void 0,void 0,void 0,!1).then(fe=>{V(v,g,fe,i,r,o,!0,void 0,h),F.dispose()}):(s.isWebGPU?U(()=>import("./pass.fragment-87b218c5.js"),["assets/pass.fragment-87b218c5.js","assets/main-e8601b72.js","assets/index-ad665221.css"]):U(()=>import("./pass.fragment-52eaea35.js"),["assets/pass.fragment-52eaea35.js","assets/main-e8601b72.js","assets/index-ad665221.css"])).then(async()=>await RI("pass",F.getInternalTexture(),m,void 0,void 0,void 0,E,T).then(be=>{s._readTexturePixels(be,E,T,-1,0,null,!0,!1,0,0).then(Me=>{V(E,T,Me,i,r,o,!0,void 0,h),be.dispose()})}))}),m.incrementRenderId(),m.resetCachedMaterial();const B=m.activeCamera,Q=m.activeCameras,J=e.outputRenderTarget,re=m.spritesEnabled;m.activeCamera=e,m.activeCameras=null,e.outputRenderTarget=F,m.spritesEnabled=l;const ne=m.meshes;m.meshes=F.renderList||m.meshes;try{m.render()}finally{m.activeCamera=B,m.activeCameras=Q,e.outputRenderTarget=J,m.spritesEnabled=re,m.meshes=ne,s.getRenderWidth=A,s.getRenderHeight=I,s.onResizeObservable.hasObservers()&&s.onResizeObservable.notifyObservers(s),e.getProjectionMatrix(!0),s.skipFrameRender=!1}},()=>{s.skipFrameRender=!1,s.getRenderWidth=A,s.getRenderHeight=I})},w=()=>{m.incrementRenderId(),m.resetCachedMaterial(),D()};if(a){const B=new el("antialiasing",1,m.activeCamera);F.addPostProcess(B),B.autoClear=!0,B.onEffectCreatedObservable.addOnce(Q=>{Q.isReady()?w():Q.onCompiled=()=>{w()}})}else w()}async function sH(s,e,t,i="image/png",r=1,n=!1,a,o=!1,l=!1,c=!0,u,h,d){return await new Promise((f,m)=>{Y_(s,e,t,g=>{typeof g<"u"?f(g):m(new Error("Data is undefined"))},i,r,n,a,o,l,c,u,h,d)})}async function nH(s,e,t,i="image/png",r=1,n=!1,a,o,l,c=!1,u){const h=s.engine,d=s.textureManager,{height:f,width:m,finalWidth:g,finalHeight:v}=j_(h,e,t),E={width:m,height:f},T=l||AI,C=s.tasks,A=C.length,I=s.pausedExecution,F=h.getCaps().parallelShaderCompile;d.setBackBufferTextures(0,0,{size:E,options:{createMipMaps:!1,samples:r,types:[0],formats:[5],useSRGBBuffers:[!1],creationFlags:[0],labels:["screenshot color"]},sizeIsPercentage:!1},{size:E,options:{createMipMaps:!1,samples:r,types:[0],formats:[h.isStencilEnable?13:14],useSRGBBuffers:[!1],creationFlags:[0],labels:["screenshot depth"]},sizeIsPercentage:!1});let V=Ji;if(n){const J=new wR("fxaa",s);J.sourceTexture=V,V=J.outputTexture,s.addTask(J)}if(g!==m||v!==f){const J=new BR("pass",s);J.sourceTexture=V,J.targetTexture=s.textureManager.createRenderTargetTexture("pass_output",{size:{width:g,height:v},options:{createMipMaps:!1,types:[0],formats:[5],samples:1,labels:["screenshot_final_texture"],useSRGBBuffers:[!1]},sizeIsPercentage:!1}),V=J.outputTexture,s.addTask(J)}const D=th.FindMainObjectRenderer(s);let w=null;D&&(w=D.camera,D.camera=e),h.getCaps().parallelShaderCompile=void 0,s.build(),s.pausedExecution=!0,await s.whenReadyAsync(),s.pausedExecution=!1;const B=u??(d.hasHistoryTextures?32:1);for(let J=0;J<B;++J)s.execute();s.pausedExecution=!0,h.getCaps().parallelShaderCompile=F;for(let J=A;J<C.length;++J)s.tasks[J].dispose();s.tasks.length=A,D&&w&&(D.camera=w);const Q=s.textureManager.getTextureFromHandle(V);return Q.incrementReferences(),d.resetBackBufferTextures(),s.build(),await s.whenReadyAsync(),s.pausedExecution=I,new Promise(J=>{h._readTexturePixels(Q,g,v,-1,0,null,!0,!1,0,0).then(async re=>{Q.dispose(),T(g,v,re,c?void 0:ne=>J(ne),i,a,!0,void 0,o),c&&J(null)})})}function j_(s,e,t){let i=0,r=0,n=0,a=0;if(typeof t=="object"){const o=t.precision?Math.abs(t.precision):1;t.width&&t.height?(i=t.height*o,r=t.width*o):t.width&&!t.height?(r=t.width*o,i=Math.round(r/s.getAspectRatio(e))):t.height&&!t.width?(i=t.height*o,r=Math.round(i*s.getAspectRatio(e))):(r=Math.round(s.getRenderWidth()*o),i=Math.round(r/s.getAspectRatio(e))),t.finalWidth&&t.finalHeight?(a=t.finalHeight,n=t.finalWidth):t.finalWidth&&!t.finalHeight?(n=t.finalWidth,a=Math.round(n/s.getAspectRatio(e))):t.finalHeight&&!t.finalWidth?(a=t.finalHeight,n=Math.round(a*s.getAspectRatio(e))):(n=r,a=i)}else isNaN(t)||(i=t,r=t,n=t,a=t);return r&&(r=Math.floor(r)),i&&(i=Math.floor(i)),n&&(n=Math.floor(n)),a&&(a=Math.floor(a)),{height:i|0,width:r|0,finalWidth:n|0,finalHeight:a|0}}const aH=()=>{j.CreateScreenshot=k0,j.CreateScreenshotAsync=rH,j.CreateScreenshotUsingRenderTarget=Y_,j.CreateScreenshotUsingRenderTargetAsync=sH};aH();var fb;(function(s){s[s.Checkbox=0]="Checkbox",s[s.Slider=1]="Slider",s[s.Vector3=2]="Vector3",s[s.Quaternion=3]="Quaternion",s[s.Color3=4]="Color3",s[s.String=5]="String",s[s.Button=6]="Button",s[s.Options=7]="Options",s[s.Tab=8]="Tab",s[s.FileButton=9]="FileButton",s[s.Vector2=10]="Vector2"})(fb||(fb={}));class pb{static _GetStorage(){try{return localStorage.setItem("test",""),localStorage.removeItem("test"),localStorage}catch{const e={};return{getItem:t=>{const i=e[t];return i===void 0?null:i},setItem:(t,i)=>{e[t]=i}}}}static ReadString(e,t){const i=this._Storage.getItem(e);return i!==null?i:t}static WriteString(e,t){this._Storage.setItem(e,t)}static ReadBoolean(e,t){const i=this._Storage.getItem(e);return i!==null?i==="true":t}static WriteBoolean(e,t){this._Storage.setItem(e,t?"true":"false")}static ReadNumber(e,t){const i=this._Storage.getItem(e);return i!==null?parseFloat(i):t}static WriteNumber(e,t){this._Storage.setItem(e,t.toString())}}pb._Storage=pb._GetStorage();var mb;(function(s){class e{serialize(){const r={},n=new Array(this._characterToIdx.size);return this._characterToIdx.forEach((a,o)=>{n[a]=o}),r.characters=n,r.insertionCosts=this._insertionCosts,r.deletionCosts=this._deletionCosts,r.substitutionCosts=this._substitutionCosts,JSON.stringify(r)}static Deserialize(r){const n=JSON.parse(r),a=new e(n.characters);return a._insertionCosts=n.insertionCosts,a._deletionCosts=n.deletionCosts,a._substitutionCosts=n.substitutionCosts,a}constructor(r,n=null,a=null,o=null){n=n??(()=>1),a=a??(()=>1),o=o??((c,u)=>c===u?0:1),this._characterToIdx=new Map,this._insertionCosts=new Array(r.length),this._deletionCosts=new Array(r.length),this._substitutionCosts=new Array(r.length);let l;for(let c=0;c<r.length;++c){l=r[c],this._characterToIdx.set(l,c),this._insertionCosts[c]=n(l),this._deletionCosts[c]=a(l),this._substitutionCosts[c]=new Array(r.length);for(let u=c;u<r.length;++u)this._substitutionCosts[c][u]=o(l,r[u])}}getCharacterIdx(r){return this._characterToIdx.get(r)}getInsertionCost(r){return this._insertionCosts[r]}getDeletionCost(r){return this._deletionCosts[r]}getSubstitutionCost(r,n){const a=Math.min(r,n),o=Math.max(r,n);return this._substitutionCosts[a][o]}}s.Alphabet=e;class t{serialize(){return JSON.stringify(this._characters)}static Deserialize(r,n){const a=new t([],n);return a._characters=JSON.parse(r),a}constructor(r,n){if(r.length>t._MAX_SEQUENCE_LENGTH)throw new Error("Sequences longer than "+t._MAX_SEQUENCE_LENGTH+" not supported.");this._alphabet=n,this._characters=r.map(a=>this._alphabet.getCharacterIdx(a))}distance(r){return t._Distance(this,r)}static _Distance(r,n){const a=r._alphabet;if(a!==n._alphabet)throw new Error("Cannot Levenshtein compare Sequences built from different alphabets.");const o=r._characters,l=n._characters,c=o.length,u=l.length,h=t._CostMatrix;h[0][0]=0;for(let d=0;d<c;++d)h[d+1][0]=h[d][0]+a.getInsertionCost(o[d]);for(let d=0;d<u;++d)h[0][d+1]=h[0][d]+a.getInsertionCost(l[d]);for(let d=0;d<c;++d)for(let f=0;f<u;++f)t._InsertionCost=h[d+1][f]+a.getInsertionCost(l[f]),t._DeletionCost=h[d][f+1]+a.getDeletionCost(o[d]),t._SubstitutionCost=h[d][f]+a.getSubstitutionCost(o[d],l[f]),h[d+1][f+1]=Math.min(t._InsertionCost,t._DeletionCost,t._SubstitutionCost);return h[c][u]}}t._MAX_SEQUENCE_LENGTH=256,t._CostMatrix=[...Array(t._MAX_SEQUENCE_LENGTH+1)].map(()=>new Array(t._MAX_SEQUENCE_LENGTH+1)),s.Sequence=t})(mb||(mb={}));new z;const oH=1.5;class In{constructor(e){this._view=new Float32Array(e),this._itemLength=0}get itemLength(){return this._itemLength}at(e){return e<0||e>=this._itemLength?NaN:this._view[e]}subarray(e,t){return e>=t||e<0?new Float32Array(0):(t>this._itemLength&&(t=this._itemLength),this._view.subarray(e,t))}push(e){this._view[this._itemLength]=e,this._itemLength++,this._itemLength>=this._view.length&&this._growArray()}_growArray(){const e=Math.floor(this._view.length*oH),t=new Float32Array(e);t.set(this._view),this._view=t}}const Rn=1800,lH=24,cH="0",_b="timestamp",gb="numPoints",uH=/\r/g,sd="@";class as{static get SliceDataOffset(){return 2}static get NumberOfPointsOffset(){return 1}constructor(e,t){this._scene=e,this._collectDataAtFrame=()=>{const i=Qr.Now-this._startingTimestamp,r=this.datasets.ids.length,n=this.datasets.startingIndices.itemLength;let a=0;if(n>0){const o=this.datasets.startingIndices.at(n-1);a=o+this.datasets.data.at(o+as.NumberOfPointsOffset)+as.SliceDataOffset}this.datasets.startingIndices.push(a),this.datasets.data.push(i),this.datasets.data.push(r);for(const o of this.datasets.ids){const l=this._strategies.get(o);if(!l)return;this.datasets.data.push(l.getData())}if(this.datasetObservable.hasObservers()){const o=[i,r];for(let l=0;l<r;l++)o.push(this.datasets.data.at(a+as.SliceDataOffset+l));this.datasetObservable.notifyObservers(o)}},this.datasets={ids:[],data:new In(Rn),startingIndices:new In(Rn)},this._strategies=new Map,this._datasetMeta=new Map,this._eventRestoreSet=new Set,this._customEventObservable=new k,this.datasetObservable=new k,this.metadataObservable=new k(i=>i.callback(this._datasetMeta,new KD(0))),t&&this.addCollectionStrategies(...t)}registerEvent(e,t,i){var a;if(this._strategies.has(e)&&!t)return;this._strategies.has(e)&&t&&((a=this._strategies.get(e))==null||a.dispose(),this._strategies.delete(e));const r=o=>{let l=0,c=0;const u=o.onAfterRenderObservable.add(()=>{c=l,l=0}),h=this._customEventObservable.add(d=>{e===d.name&&(d.value!==void 0?l=d.value:l++)});return{id:e,getData:()=>c,dispose:()=>{o.onAfterRenderObservable.remove(u),this._customEventObservable.remove(h)}}},n={name:e};return this._eventRestoreSet.add(e),this.addCollectionStrategies({strategyCallback:r,category:i}),n}sendEvent(e){this._customEventObservable.notifyObservers(e)}_restoreStringEvents(){this._eventRestoreSet.size!==this._customEventObservable.observers.length&&this._eventRestoreSet.forEach(e=>{this.registerEvent(e,!0)})}addCollectionStrategies(...e){for(let{strategyCallback:t,category:i,hidden:r}of e){const n=t(this._scene);if(this._strategies.has(n.id)){n.dispose();continue}this.datasets.ids.push(n.id),i&&(i=i.replace(new RegExp(sd,"g"),"")),this._datasetMeta.set(n.id,{color:this._getHexColorFromId(n.id),category:i,hidden:r}),this._strategies.set(n.id,n)}this.metadataObservable.notifyObservers(this._datasetMeta)}_getHexColorFromId(e){let t=0;for(let r=0;r<e.length;r++)t=e.charCodeAt(r)+((t<<5)-t);let i="#";for(let r=0;r<lH;r+=8){const n=t>>r&255,a=cH+n.toString(16);i+=a.substring(a.length-2)}return i}getCurrentSlice(){const e=Qr.Now-this._startingTimestamp,t=this.datasets.ids.length,i=[e,t];for(const r of this.datasets.ids){const n=this._strategies.get(r);if(!n)return;this.datasetObservable.hasObservers()&&i.push(n.getData())}this.datasetObservable.hasObservers()&&this.datasetObservable.notifyObservers(i)}updateMetadata(e,t,i){const r=this._datasetMeta.get(e);r&&(r[t]=i,this.metadataObservable.notifyObservers(this._datasetMeta))}clear(e){this.datasets.data=new In(Rn),this.datasets.ids.length=0,this.datasets.startingIndices=new In(Rn),this._datasetMeta.clear(),this._strategies.forEach(t=>t.dispose()),this._strategies.clear(),e||this._eventRestoreSet.clear(),this._hasLoadedData=!1}get hasLoadedData(){return this._hasLoadedData}loadFromFileData(e,t){const i=e.replace(uH,"").split(`
`).map(h=>h.split(",").filter(d=>d.length>0)).filter(h=>h.length>0),r=0,n=as.NumberOfPointsOffset;if(i.length<2)return!1;const a={ids:[],data:new In(Rn),startingIndices:new In(Rn)},[o,...l]=i;if(o.length<2||o[r]!==_b||o[n]!==gb)return!1;const c=new Map;for(let h=as.SliceDataOffset;h<o.length;h++){const[d,f]=o[h].split(sd);a.ids.push(d),c.set(d,f)}let u=0;for(const h of l){if(h.length<2)return!1;const d=parseFloat(h[r]),f=parseInt(h[n]);if(isNaN(f)||isNaN(d)||(a.data.push(d),a.data.push(f),f+as.SliceDataOffset!==h.length))return!1;for(let m=as.SliceDataOffset;m<h.length;m++){const g=parseFloat(h[m]);if(isNaN(g))return!1;a.data.push(g)}a.startingIndices.push(u),u+=h.length}if(this.datasets.ids=a.ids,this.datasets.data=a.data,this.datasets.startingIndices=a.startingIndices,t||this._datasetMeta.clear(),this._strategies.forEach(h=>h.dispose()),this._strategies.clear(),!t)for(const h of this.datasets.ids){const d=c.get(h);this._datasetMeta.set(h,{category:d,color:this._getHexColorFromId(h)})}return this.metadataObservable.notifyObservers(this._datasetMeta),this._hasLoadedData=!0,!0}exportDataToCsv(){let e="";e+=`${_b},${gb}`;for(let i=0;i<this.datasets.ids.length;i++)if(e+=`,${this.datasets.ids[i]}`,this._datasetMeta){const r=this._datasetMeta.get(this.datasets.ids[i]);r!=null&&r.category&&(e+=`${sd}${r.category}`)}e+=`
`;for(let i=0;i<this.datasets.startingIndices.itemLength;i++){const r=this.datasets.startingIndices.at(i),n=this.datasets.data.at(r),a=this.datasets.data.at(r+as.NumberOfPointsOffset);e+=`${n},${a}`;for(let o=0;o<a;o++)e+=`,${this.datasets.data.at(r+as.SliceDataOffset+o)}`;for(let o=0;o<this.datasets.ids.length-a;o++)e+=",";e+=`
`}const t=`${new Date().toISOString()}-perfdata.csv`;j.Download(new Blob([e],{type:"text/csv"}),t)}start(e){e?this._startingTimestamp===void 0&&(this._startingTimestamp=Qr.Now):(this.datasets.data=new In(Rn),this.datasets.startingIndices=new In(Rn),this._startingTimestamp=Qr.Now),this._scene.onAfterRenderObservable.add(this._collectDataAtFrame),this._restoreStringEvents(),this._isStarted=!0}stop(){this._scene.onAfterRenderObservable.removeCallback(this._collectDataAtFrame),this._isStarted=!1}get isStarted(){return this._isStarted}dispose(){this._scene.onAfterRenderObservable.removeCallback(this._collectDataAtFrame),this._datasetMeta.clear(),this._strategies.forEach(e=>{e.dispose()}),this.datasetObservable.clear(),this.metadataObservable.clear(),this._isStarted=!1,this.datasets=null}}le.prototype.getPerfCollector=function(){return this._perfCollector||(this._perfCollector=new as(this)),this._perfCollector};function hH(s){const e=new Array,t=new Array,i=new Array,r=s.add(()=>{const a=e.length;for(let o=0;o<a;o++)JD(e.shift(),t.shift(),i.shift())});return{scheduler:(a,o,l)=>{e.push(a),t.push(o),i.push(l)},dispose:()=>{s.remove(r)}}}k.prototype.runCoroutineAsync=function(s){if(!this._coroutineScheduler){const e=hH(this);this._coroutineScheduler=e.scheduler,this._coroutineSchedulerDispose=e.dispose}return Uc(s,this._coroutineScheduler)};k.prototype.cancelAllCoroutines=function(){this._coroutineSchedulerDispose&&this._coroutineSchedulerDispose(),this._coroutineScheduler=void 0,this._coroutineSchedulerDispose=void 0};const Sb="equirectangularPanoramaPixelShader",dH=`#ifdef GL_ES
precision highp float;
#endif
#define M_PI 3.1415926535897932384626433832795
varying vec2 vUV;uniform samplerCube cubeMap;void main(void) {vec2 uv=vUV;float longitude=uv.x*2.*M_PI-M_PI+M_PI/2.;float latitude=(1.-uv.y)*M_PI;vec3 dir=vec3(
- sin( longitude )*sin( latitude ),
cos( latitude ),
- cos( longitude )*sin( latitude )
);normalize( dir );gl_FragColor=textureCube( cubeMap,dir );}`;S.ShadersStore[Sb]||(S.ShadersStore[Sb]=dH);const Tf="rgbdEncodePixelShader",G0=`varying vec2 vUV;uniform sampler2D textureSampler;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{gl_FragColor=toRGBD(texture2D(textureSampler,vUV).rgb);}`;S.ShadersStore[Tf]||(S.ShadersStore[Tf]=G0);const fH={name:Tf,shader:G0},pH=Object.freeze(Object.defineProperty({__proto__:null,rgbdEncodePixelShader:fH},Symbol.toStringTag,{value:"Module"})),bf="rgbdEncodePixelShader",z0=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=toRGBD(textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb);}`;S.ShadersStoreWGSL[bf]||(S.ShadersStoreWGSL[bf]=z0);const mH={name:bf,shader:z0},_H=Object.freeze(Object.defineProperty({__proto__:null,rgbdEncodePixelShaderWGSL:mH},Symbol.toStringTag,{value:"Module"})),Cf="copyTextureToTexturePixelShader",W0=`uniform float conversion;uniform sampler2D textureSampler;varying vec2 vUV;
#include<helperFunctions>
void main(void) 
{
#ifdef NO_SAMPLER
vec4 color=texelFetch(textureSampler,ivec2(gl_FragCoord.xy),0);
#else
vec4 color=texture2D(textureSampler,vUV);
#endif
#ifdef DEPTH_TEXTURE
gl_FragDepth=color.r;
#else
if (conversion==1.) {color=toLinearSpace(color);} else if (conversion==2.) {color=toGammaSpace(color);}
gl_FragColor=color;
#endif
}
`;S.ShadersStore[Cf]||(S.ShadersStore[Cf]=W0);const gH={name:Cf,shader:W0},SH=Object.freeze(Object.defineProperty({__proto__:null,copyTextureToTexturePixelShader:gH},Symbol.toStringTag,{value:"Module"})),yf="copyTextureToTexturePixelShader",H0=`uniform conversion: f32;
#ifndef NO_SAMPLER
var textureSamplerSampler: sampler;
#endif
var textureSampler: texture_2d<f32>;varying vUV: vec2f;
#include<helperFunctions>
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#ifdef NO_SAMPLER
var color: vec4f=textureLoad(textureSampler,vec2u(fragmentInputs.position.xy),0);
#else
var color: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);
#endif
#ifdef DEPTH_TEXTURE
fragmentOutputs.fragDepth=color.r;
#else
if (uniforms.conversion==1.) {color=toLinearSpaceVec4(color);} else if (uniforms.conversion==2.) {color=toGammaSpace(color);}
fragmentOutputs.color=color;
#endif
}
`;S.ShadersStoreWGSL[yf]||(S.ShadersStoreWGSL[yf]=H0);const vH={name:yf,shader:H0},xH=Object.freeze(Object.defineProperty({__proto__:null,copyTextureToTexturePixelShaderWGSL:vH},Symbol.toStringTag,{value:"Module"}));te.OfflineProviderFactory=(s,e,t=!1)=>new Hi(s,e,t);class Hi{get enableSceneOffline(){return this._enableSceneOffline}get enableTexturesOffline(){return this._enableTexturesOffline}constructor(e,t,i=!1){this._idbFactory=typeof indexedDB<"u"?indexedDB:void 0,this._currentSceneUrl=Hi._ReturnFullUrlLocation(e),this._db=null,this._enableSceneOffline=!1,this._enableTexturesOffline=!1,this._manifestVersionFound=0,this._mustUpdateResources=!1,this._hasReachedQuota=!1,Hi.IDBStorageEnabled?i?(this._enableSceneOffline=!0,this._enableTexturesOffline=!0,this._manifestVersionFound=1,j.SetImmediate(()=>{t(!0)})):this._checkManifestFile(t):t(!0)}_checkManifestFile(e){const t=()=>{this._enableSceneOffline=!1,this._enableTexturesOffline=!1,e(!1)},i=()=>{try{if(typeof URL=="function"&&this._currentSceneUrl.indexOf("http")===0){const o=new URL(this._currentSceneUrl);return o.pathname+=".manifest",o.toString()}}catch{}return`${this._currentSceneUrl}.manifest`};let r=!1,n=i();const a=new dn;navigator.onLine&&(r=!0,n=n+(n.match(/\?/)==null?"?":"&")+Date.now()),a.open("GET",n),a.addEventListener("load",()=>{if(a.status===200||Hi._ValidateXHRData(a,1))try{const o=JSON.parse(a.response);this._enableSceneOffline=o.enableSceneOffline,this._enableTexturesOffline=o.enableTexturesOffline&&Hi._IsUaSupportingBlobStorage,o.version&&!isNaN(parseInt(o.version))&&(this._manifestVersionFound=o.version),e(!0)}catch{t()}else t()},!1),a.addEventListener("error",()=>{if(r){r=!1;const o=i();a.open("GET",o),a.send()}else t()},!1);try{a.send()}catch{N.Error("Error on XHR send request."),e(!1)}}open(e,t){const i=()=>{this._isSupported=!1,t&&t()};if(!this._idbFactory||!(this._enableSceneOffline||this._enableTexturesOffline))this._isSupported=!1,t&&t();else if(this._db)e&&e();else{this._hasReachedQuota=!1,this._isSupported=!0;const r=this._idbFactory.open("babylonjs",1);r.onerror=()=>{i()},r.onblocked=()=>{N.Error("IDB request blocked. Please reload the page."),i()},r.onsuccess=()=>{this._db=r.result,e()},r.onupgradeneeded=n=>{if(this._db=n.target.result,this._db)try{this._db.createObjectStore("scenes",{keyPath:"sceneUrl"}),this._db.createObjectStore("versions",{keyPath:"sceneUrl"}),this._db.createObjectStore("textures",{keyPath:"textureUrl"})}catch(a){N.Error("Error while creating object stores. Exception: "+a.message),i()}}}}loadImage(e,t){const i=Hi._ReturnFullUrlLocation(e),r=()=>{!this._hasReachedQuota&&this._db!==null?this._saveImageIntoDB(i,t):t.src=e};this._mustUpdateResources?r():this._loadImageFromDB(i,t,r)}_loadImageFromDB(e,t,i){if(this._isSupported&&this._db!==null){let r;const n=this._db.transaction(["textures"]);n.onabort=()=>{t.src=e},n.oncomplete=()=>{let o;if(r&&typeof URL=="function"){let l=r.data;r.data instanceof ArrayBuffer&&(l=new Blob([r.data],{type:"image/png"})),o=URL.createObjectURL(l),t.onerror=()=>{N.Error("Error loading image from blob URL: "+o+" switching back to web url: "+e),t.src=e},t.src=o}else i()};const a=n.objectStore("textures").get(e);a.onsuccess=o=>{r=o.target.result},a.onerror=()=>{N.Error("Error loading texture "+e+" from DB."),t.src=e}}else N.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),t.src=e}_saveImageIntoDB(e,t){let i;if(this._isSupported){const r=()=>{let n;if(i&&typeof URL=="function")try{n=URL.createObjectURL(i)}catch{n=URL.createObjectURL(i)}n&&(t.src=n)};if(Hi._IsUaSupportingBlobStorage){const n=new dn;n.open("GET",e),n.responseType="blob",n.addEventListener("load",()=>{if(n.status===200&&this._db){i=n.response;const a=this._db.transaction(["textures"],"readwrite");a.onabort=l=>{try{const u=l.target.error;u&&u.name==="QuotaExceededError"&&(this._hasReachedQuota=!0)}catch{}r()},a.oncomplete=()=>{r()};const o={textureUrl:e,data:i};try{const l=a.objectStore("textures").put(o);l.onsuccess=()=>{},l.onerror=()=>{r()}}catch(l){l.code===25&&(Hi._IsUaSupportingBlobStorage=!1,this._enableTexturesOffline=!1),t.src=e}}else t.src=e},!1),n.addEventListener("error",()=>{N.Error("Error in XHR request in BABYLON.Database."),t.src=e},!1),n.send()}else t.src=e}else N.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),t.src=e}_checkVersionFromDB(e,t){const i=()=>{this._saveVersionIntoDB(e,t)};this._loadVersionFromDB(e,t,i)}_loadVersionFromDB(e,t,i){if(this._isSupported&&this._db){let r;try{const n=this._db.transaction(["versions"]);n.oncomplete=()=>{r?this._manifestVersionFound!==r.data?(this._mustUpdateResources=!0,i()):t(r.data):(this._mustUpdateResources=!0,i())},n.onabort=()=>{t(-1)};const a=n.objectStore("versions").get(e);a.onsuccess=o=>{r=o.target.result},a.onerror=()=>{N.Error("Error loading version for scene "+e+" from DB."),t(-1)}}catch(n){N.Error("Error while accessing 'versions' object store (READ OP). Exception: "+n.message),t(-1)}}else N.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),t(-1)}_saveVersionIntoDB(e,t){if(this._isSupported&&!this._hasReachedQuota&&this._db)try{const i=this._db.transaction(["versions"],"readwrite");i.onabort=a=>{try{const o=a.target.error;o&&o.name==="QuotaExceededError"&&(this._hasReachedQuota=!0)}catch{}t(-1)},i.oncomplete=()=>{t(this._manifestVersionFound)};const r={sceneUrl:e,data:this._manifestVersionFound},n=i.objectStore("versions").put(r);n.onsuccess=()=>{},n.onerror=()=>{N.Error("Error in DB add version request in BABYLON.Database.")}}catch(i){N.Error("Error while accessing 'versions' object store (WRITE OP). Exception: "+i.message),t(-1)}else t(-1)}loadFile(e,t,i,r,n){const a=Hi._ReturnFullUrlLocation(e),o=()=>{this._saveFile(a,t,i,n,r)};this._checkVersionFromDB(a,l=>{l!==-1?this._mustUpdateResources?this._saveFile(a,t,i,n,r):this._loadFile(a,t,o,i):r&&r()})}_loadFile(e,t,i,r){if(this._isSupported&&this._db){let n;e.split("?")[0].endsWith(".babylon")?n="scenes":n="textures";let a;const o=this._db.transaction([n]);o.oncomplete=()=>{function c(u){if(r){const h=u.byteLength||0;r({total:h,loaded:h,lengthComputable:!0})}t(u)}if(a)if(a.data instanceof Blob){const u=new FileReader;u.onload=h=>{var d;c((d=h.target)==null?void 0:d.result)},u.readAsArrayBuffer(a.data)}else c(a.data);else i()},o.onabort=()=>{i()};const l=o.objectStore(n).get(e);l.onsuccess=c=>{a=c.target.result},l.onerror=()=>{N.Error("Error loading file "+e+" from DB."),i()}}else N.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),t()}_saveFile(e,t,i,r,n){if(this._isSupported){let a;e.split("?")[0].endsWith(".babylon")?a="scenes":a="textures";const o=new dn;let l;o.open("GET",e+(e.match(/\?/)==null?"?":"&")+Date.now()),r&&(o.responseType="arraybuffer"),i&&(o.onprogress=i),o.addEventListener("load",()=>{if(o.status===200||o.status<400&&Hi._ValidateXHRData(o,r?6:1))if(l=r?o.response:o.responseText,!this._hasReachedQuota&&this._db){const c=this._db.transaction([a],"readwrite");c.onabort=h=>{try{const d=h.target.error;d&&d.name==="QuotaExceededError"&&(this._hasReachedQuota=!0)}catch{}t(l)},c.oncomplete=()=>{t(l)};let u;a==="scenes"?u={sceneUrl:e,data:l,version:this._manifestVersionFound}:u={textureUrl:e,data:l};try{const h=c.objectStore(a).put(u);h.onsuccess=()=>{},h.onerror=()=>{N.Error("Error in DB add file request in BABYLON.Database.")}}catch{t(l)}}else t(l);else o.status>=400&&n?n(o):t()},!1),o.addEventListener("error",()=>{N.Error("error on XHR request."),n&&n()},!1),o.send()}else N.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),n&&n()}static _ValidateXHRData(e,t=7){try{if(t&1){if(e.responseText&&e.responseText.length>0)return!0;if(t===1)return!1}if(t&2){const i=_M(e.response);if(i.width&&i.height&&i.width>0&&i.height>0)return!0;if(t===2)return!1}if(t&4){const i=new Uint8Array(e.response,0,3);return i[0]===68&&i[1]===68&&i[2]===83}}catch{}return!1}}Hi._IsUaSupportingBlobStorage=!0;Hi.IDBStorageEnabled=!1;Hi._ParseURL=s=>{const e=document.createElement("a");e.href=s;const t=s.substring(0,s.lastIndexOf("#")),i=s.substring(t.lastIndexOf("/")+1,s.length);return s.substring(0,s.indexOf(i,0))};Hi._ReturnFullUrlLocation=s=>s.indexOf("http:/")===-1&&s.indexOf("https:/")===-1&&typeof window<"u"?Hi._ParseURL(window.location.href)+s:s;const vb="gpuUpdateParticlesComputeShader",EH=`struct Particle {position : vec3<f32>,
age : f32,
size : vec3<f32>,
life : f32,
seed : vec4<f32>,
direction : vec3<f32>,
dummy0: f32,
#ifdef CUSTOMEMITTER
initialPosition : vec3<f32>,
dummy1: f32,
#endif
#ifndef COLORGRADIENTS
color : vec4<f32>,
#endif
#ifndef BILLBOARD
initialDirection : vec3<f32>,
dummy2: f32,
#endif
#ifdef NOISE
noiseCoordinates1 : vec3<f32>,
dummy3: f32,
noiseCoordinates2 : vec3<f32>,
dummy4: f32,
#endif
#ifdef ANGULARSPEEDGRADIENTS
angle : f32,
#else
angle : vec2<f32>,
#endif
#ifdef ANIMATESHEET
cellIndex : f32,
#ifdef ANIMATESHEETRANDOMSTART
cellStartOffset : f32,
#endif
#endif
};struct Particles {particles : array<Particle>,};struct SimParams {currentCount : f32,
timeDelta : f32,
stopFactor : f32,
randomTextureSize: i32,
lifeTime : vec2<f32>,
emitPower : vec2<f32>,
#ifndef COLORGRADIENTS
color1 : vec4<f32>,
color2 : vec4<f32>,
#endif
sizeRange : vec2<f32>,
scaleRange : vec4<f32>,
angleRange : vec4<f32>,
gravity : vec3<f32>,
#ifdef LIMITVELOCITYGRADIENTS
limitVelocityDamping : f32,
#endif
#ifdef ANIMATESHEET
cellInfos : vec4<f32>,
#endif
#ifdef NOISE
noiseStrength : vec3<f32>,
#endif
#ifdef FLOWMAP
flowMapProjection : mat4x4<f32>,
flowMapStrength : f32,
#endif
#ifndef LOCAL
emitterWM : mat4x4<f32>,
#endif
#ifdef BOXEMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
minEmitBox : vec3<f32>,
maxEmitBox : vec3<f32>,
#endif
#ifdef CONEEMITTER
radius : vec2<f32>,
coneAngle : f32,
height : vec2<f32>,
#ifdef DIRECTEDCONEEMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
#else
directionRandomizer : f32,
#endif
#endif
#ifdef CYLINDEREMITTER
radius : f32,
height : f32,
radiusRange : f32,
#ifdef DIRECTEDCYLINDEREMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
#else
directionRandomizer : f32,
#endif
#endif
#ifdef HEMISPHERICEMITTER
radius : f32,
radiusRange : f32,
directionRandomizer : f32,
#endif
#ifdef POINTEMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
#endif
#ifdef SPHEREEMITTER
radius : f32,
radiusRange : f32,
#ifdef DIRECTEDSPHEREEMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
#else
directionRandomizer : f32,
#endif
#endif
};@binding(0) @group(0) var<uniform> params : SimParams;@binding(1) @group(0) var<storage,read> particlesIn : Particles;@binding(2) @group(0) var<storage,read_write> particlesOut : Particles;@binding(3) @group(0) var randomTexture : texture_2d<f32>;@binding(4) @group(0) var randomTexture2 : texture_2d<f32>;
#ifdef SIZEGRADIENTS
@binding(0) @group(1) var sizeGradientSampler : sampler;@binding(1) @group(1) var sizeGradientTexture : texture_2d<f32>;
#endif 
#ifdef ANGULARSPEEDGRADIENTS
@binding(2) @group(1) var angularSpeedGradientSampler : sampler;@binding(3) @group(1) var angularSpeedGradientTexture : texture_2d<f32>;
#endif 
#ifdef VELOCITYGRADIENTS
@binding(4) @group(1) var velocityGradientSampler : sampler;@binding(5) @group(1) var velocityGradientTexture : texture_2d<f32>;
#endif
#ifdef LIMITVELOCITYGRADIENTS
@binding(6) @group(1) var limitVelocityGradientSampler : sampler;@binding(7) @group(1) var limitVelocityGradientTexture : texture_2d<f32>;
#endif
#ifdef DRAGGRADIENTS
@binding(8) @group(1) var dragGradientSampler : sampler;@binding(9) @group(1) var dragGradientTexture : texture_2d<f32>;
#endif
#ifdef NOISE
@binding(10) @group(1) var noiseSampler : sampler;@binding(11) @group(1) var noiseTexture : texture_2d<f32>;
#endif
#ifdef FLOWMAP
@binding(12) @group(1) var flowMapSampler : sampler;@binding(13) @group(1) var flowMapTexture : texture_2d<f32>;
#endif
fn getRandomVec3(offset : f32,vertexID : f32)->vec3<f32> {return textureLoad(randomTexture2,vec2<i32>(i32(vertexID*offset/params.currentCount*f32(params.randomTextureSize)) % params.randomTextureSize,0),0).rgb;}
fn getRandomVec4(offset : f32,vertexID : f32)->vec4<f32> {return textureLoad(randomTexture,vec2<i32>(i32(vertexID*offset/params.currentCount*f32(params.randomTextureSize)) % params.randomTextureSize,0),0);}
@compute @workgroup_size(64)
fn main(@builtin(global_invocation_id) GlobalInvocationID : vec3<u32>) {let index : u32=GlobalInvocationID.x;let vertexID : f32=f32(index);if (index>=u32(params.currentCount)) {return;}
let PI : f32=3.14159;let timeDelta : f32=params.timeDelta;let newAge : f32=particlesIn.particles[index].age+timeDelta;let life : f32=particlesIn.particles[index].life;let seed : vec4<f32>=particlesIn.particles[index].seed;let direction : vec3<f32>=particlesIn.particles[index].direction;if (newAge>=life && params.stopFactor != 0.) {var newPosition : vec3<f32>;var newDirection : vec3<f32>;let randoms : vec4<f32>=getRandomVec4(seed.x,vertexID);let outLife : f32=params.lifeTime.x+(params.lifeTime.y-params.lifeTime.x)*randoms.r;particlesOut.particles[index].life=outLife;particlesOut.particles[index].age=newAge-life;particlesOut.particles[index].seed=seed;var sizex : f32;
#ifdef SIZEGRADIENTS 
sizex=textureSampleLevel(sizeGradientTexture,sizeGradientSampler,vec2<f32>(0.,0.),0.).r;
#else
sizex=params.sizeRange.x+(params.sizeRange.y-params.sizeRange.x)*randoms.g;
#endif
particlesOut.particles[index].size=vec3<f32>(
sizex,
params.scaleRange.x+(params.scaleRange.y-params.scaleRange.x)*randoms.b,
params.scaleRange.z+(params.scaleRange.w-params.scaleRange.z)*randoms.a);
#ifndef COLORGRADIENTS
particlesOut.particles[index].color=params.color1+(params.color2-params.color1)*randoms.b;
#endif
#ifndef ANGULARSPEEDGRADIENTS 
particlesOut.particles[index].angle=vec2<f32>(
params.angleRange.z+(params.angleRange.w-params.angleRange.z)*randoms.r,
params.angleRange.x+(params.angleRange.y-params.angleRange.x)*randoms.a);
#else
particlesOut.particles[index].angle=params.angleRange.z+(params.angleRange.w-params.angleRange.z)*randoms.r;
#endif 
#if defined(POINTEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);newPosition=vec3<f32>(0.,0.,0.);newDirection=params.direction1+(params.direction2-params.direction1)*randoms3;
#elif defined(BOXEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);newPosition=params.minEmitBox+(params.maxEmitBox-params.minEmitBox)*randoms2;newDirection=params.direction1+(params.direction2-params.direction1)*randoms3; 
#elif defined(HEMISPHERICEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);let phi : f32=2.0*PI*randoms2.x;let theta : f32=acos(-1.0+2.0*randoms2.y);let randX : f32=cos(phi)*sin(theta);let randY : f32=cos(theta);let randZ : f32=sin(phi)*sin(theta);newPosition=(params.radius-(params.radius*params.radiusRange*randoms2.z))*vec3<f32>(randX,abs(randY),randZ);newDirection=normalize(newPosition+params.directionRandomizer*randoms3);
#elif defined(SPHEREEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);let phi : f32=2.0*PI*randoms2.x;let theta : f32=acos(-1.0+2.0*randoms2.y);let randX : f32=cos(phi)*sin(theta);let randY : f32=cos(theta);let randZ : f32=sin(phi)*sin(theta);newPosition=(params.radius-(params.radius*params.radiusRange*randoms2.z))*vec3<f32>(randX,randY,randZ);
#ifdef DIRECTEDSPHEREEMITTER
newDirection=normalize(params.direction1+(params.direction2-params.direction1)*randoms3);
#else
newDirection=normalize(newPosition+params.directionRandomizer*randoms3);
#endif
#elif defined(CYLINDEREMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);let yPos : f32=(-0.5+randoms2.x)*params.height;var angle : f32=randoms2.y*PI*2.;let inverseRadiusRangeSquared : f32=(1.-params.radiusRange)*(1.-params.radiusRange);let positionRadius : f32=params.radius*sqrt(inverseRadiusRangeSquared+randoms2.z*(1.-inverseRadiusRangeSquared));let xPos : f32=positionRadius*cos(angle);let zPos : f32=positionRadius*sin(angle);newPosition=vec3<f32>(xPos,yPos,zPos);
#ifdef DIRECTEDCYLINDEREMITTER
newDirection=params.direction1+(params.direction2-params.direction1)*randoms3;
#else
angle=angle+(-0.5+randoms3.x)*PI*params.directionRandomizer;newDirection=vec3<f32>(cos(angle),(-0.5+randoms3.y)*params.directionRandomizer,sin(angle));newDirection=normalize(newDirection);
#endif
#elif defined(CONEEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let s : f32=2.0*PI*randoms2.x;
#ifdef CONEEMITTERSPAWNPOINT
let h : f32=0.0001;
#else
var h : f32=randoms2.y*params.height.y;h=1.-h*h; 
#endif
var lRadius : f32=params.radius.x-params.radius.x*randoms2.z*params.radius.y;lRadius=lRadius*h;let randX : f32=lRadius*sin(s);let randZ : f32=lRadius*cos(s);let randY : f32=h *params.height.x;newPosition=vec3<f32>(randX,randY,randZ); 
let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);
#ifdef DIRECTEDCONEEMITTER
newDirection=params.direction1+(params.direction2-params.direction1)*randoms3;
#else
if (abs(cos(params.coneAngle))==1.0) {newDirection=vec3<f32>(0.,1.0,0.);} else {newDirection=normalize(newPosition+params.directionRandomizer*randoms3); }
#endif
#elif defined(CUSTOMEMITTER)
newPosition=particlesIn.particles[index].initialPosition;particlesOut.particles[index].initialPosition=newPosition;
#else 
newPosition=vec3<f32>(0.,0.,0.);newDirection=2.0*(getRandomVec3(seed.w,vertexID)-vec3<f32>(0.5,0.5,0.5));
#endif
let power : f32=params.emitPower.x+(params.emitPower.y-params.emitPower.x)*randoms.a;
#ifdef LOCAL
particlesOut.particles[index].position=newPosition;
#else
particlesOut.particles[index].position=(params.emitterWM*vec4<f32>(newPosition,1.)).xyz;
#endif
#ifdef CUSTOMEMITTER
particlesOut.particles[index].direction=direction;
#ifndef BILLBOARD 
particlesOut.particles[index].initialDirection=direction;
#endif
#else
#ifdef LOCAL
let initial : vec3<f32>=newDirection;
#else 
let initial : vec3<f32>=(params.emitterWM*vec4<f32>(newDirection,0.)).xyz;
#endif
particlesOut.particles[index].direction=initial*power;
#ifndef BILLBOARD 
particlesOut.particles[index].initialDirection=initial;
#endif
#endif
#ifdef ANIMATESHEET 
particlesOut.particles[index].cellIndex=params.cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
particlesOut.particles[index].cellStartOffset=randoms.a*outLife;
#endif 
#endif
#ifdef NOISE
particlesOut.particles[index].noiseCoordinates1=particlesIn.particles[index].noiseCoordinates1;particlesOut.particles[index].noiseCoordinates2=particlesIn.particles[index].noiseCoordinates2;
#endif
} else {var directionScale : f32=timeDelta;particlesOut.particles[index].age=newAge;let ageGradient : f32=newAge/life;
#ifdef VELOCITYGRADIENTS
directionScale=directionScale*textureSampleLevel(velocityGradientTexture,velocityGradientSampler,vec2<f32>(ageGradient,0.),0.).r;
#endif
#ifdef DRAGGRADIENTS
directionScale=directionScale*(1.0-textureSampleLevel(dragGradientTexture,dragGradientSampler,vec2<f32>(ageGradient,0.),0.).r);
#endif
let position : vec3<f32>=particlesIn.particles[index].position;
#if defined(CUSTOMEMITTER)
particlesOut.particles[index].position=position+(direction-position)*ageGradient; 
particlesOut.particles[index].initialPosition=particlesIn.particles[index].initialPosition;
#else
particlesOut.particles[index].position=position+direction*directionScale;
#endif
particlesOut.particles[index].life=life;particlesOut.particles[index].seed=seed;
#ifndef COLORGRADIENTS 
particlesOut.particles[index].color=particlesIn.particles[index].color;
#endif
#ifdef SIZEGRADIENTS
particlesOut.particles[index].size=vec3<f32>(
textureSampleLevel(sizeGradientTexture,sizeGradientSampler,vec2<f32>(ageGradient,0.),0.).r,
particlesIn.particles[index].size.yz);
#else
particlesOut.particles[index].size=particlesIn.particles[index].size;
#endif 
#ifndef BILLBOARD 
particlesOut.particles[index].initialDirection=particlesIn.particles[index].initialDirection;
#endif
#ifdef CUSTOMEMITTER
particlesOut.particles[index].direction=direction;
#else
var updatedDirection : vec3<f32>=direction+params.gravity*timeDelta;
#ifdef FLOWMAP
var clipSpace=(params.flowMapProjection*vec4f(position,1.));var ndcSpace=clipSpace.xyz/clipSpace.w;var flowMapUV=ndcSpace.xy*0.5+0.5;var flowMapValue=textureSampleLevel(flowMapTexture,flowMapSampler,flowMapUV,0.);var flowMapDirection=(flowMapValue.xyz*2.0-1.0)*flowMapValue.w;updatedDirection+=flowMapDirection*timeDelta*params.flowMapStrength;
#endif
#ifdef LIMITVELOCITYGRADIENTS
let limitVelocity : f32=textureSampleLevel(limitVelocityGradientTexture,limitVelocityGradientSampler,vec2<f32>(ageGradient,0.),0.).r;let currentVelocity : f32=length(updatedDirection);if (currentVelocity>limitVelocity) {updatedDirection=updatedDirection*params.limitVelocityDamping;}
#endif
particlesOut.particles[index].direction=updatedDirection;
#ifdef NOISE
let noiseCoordinates1 : vec3<f32>=particlesIn.particles[index].noiseCoordinates1;let noiseCoordinates2 : vec3<f32>=particlesIn.particles[index].noiseCoordinates2;let fetchedR : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates1.x,noiseCoordinates1.y)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;let fetchedG : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates1.z,noiseCoordinates2.x)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;let fetchedB : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates2.y,noiseCoordinates2.z)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;let force : vec3<f32>=vec3<f32>(-1.+2.*fetchedR,-1.+2.*fetchedG,-1.+2.*fetchedB)*params.noiseStrength;particlesOut.particles[index].direction=particlesOut.particles[index].direction+force*timeDelta;particlesOut.particles[index].noiseCoordinates1=noiseCoordinates1;particlesOut.particles[index].noiseCoordinates2=noiseCoordinates2;
#endif 
#endif 
#ifdef ANGULARSPEEDGRADIENTS
let angularSpeed : f32=textureSampleLevel(angularSpeedGradientTexture,angularSpeedGradientSampler,vec2<f32>(ageGradient,0.),0.).r;particlesOut.particles[index].angle=particlesIn.particles[index].angle+angularSpeed*timeDelta;
#else
let angle : vec2<f32>=particlesIn.particles[index].angle;particlesOut.particles[index].angle=vec2<f32>(angle.x+angle.y*timeDelta,angle.y);
#endif
#ifdef ANIMATESHEET 
var offsetAge : f32=particlesOut.particles[index].age;let dist : f32=params.cellInfos.y-params.cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
let cellStartOffset : f32=particlesIn.particles[index].cellStartOffset;particlesOut.particles[index].cellStartOffset=cellStartOffset;offsetAge=offsetAge+cellStartOffset;
#else
let cellStartOffset : f32=0.;
#endif 
var ratio : f32;if (params.cellInfos.w==1.0) {ratio=clamp(((cellStartOffset+params.cellInfos.z*offsetAge) % life)/life,0.,1.0);}
else {ratio=clamp((cellStartOffset+params.cellInfos.z*offsetAge)/life,0.,1.0);}
particlesOut.particles[index].cellIndex=f32(i32(params.cellInfos.x+ratio*dist));
#endif
}}
`;S.ShadersStoreWGSL[vb]||(S.ShadersStoreWGSL[vb]=EH);class TH{constructor(e,t){this._bufferComputeShader=[],this._renderVertexBuffers=[],this.alignDataInBuffer=!0,this._parent=e,this._engine=t}contextLost(){this._updateComputeShader=void 0,this._bufferComputeShader.length=0,this._renderVertexBuffers.length=0}isUpdateBufferCreated(){return!!this._updateComputeShader}isUpdateBufferReady(){var e;return((e=this._updateComputeShader)==null?void 0:e.isReady())??!1}createUpdateBuffer(e){var i;const t={params:{group:0,binding:0},particlesIn:{group:0,binding:1},particlesOut:{group:0,binding:2},randomTexture:{group:0,binding:3},randomTexture2:{group:0,binding:4}};return this._parent._sizeGradientsTexture&&(t.sizeGradientTexture={group:1,binding:1}),this._parent._angularSpeedGradientsTexture&&(t.angularSpeedGradientTexture={group:1,binding:3}),this._parent._velocityGradientsTexture&&(t.velocityGradientTexture={group:1,binding:5}),this._parent._limitVelocityGradientsTexture&&(t.limitVelocityGradientTexture={group:1,binding:7}),this._parent._dragGradientsTexture&&(t.dragGradientTexture={group:1,binding:9}),this._parent.noiseTexture&&(t.noiseTexture={group:1,binding:11}),this._parent.flowMap&&(t.flowMapTexture={group:1,binding:13}),this._updateComputeShader=new on("updateParticles",this._engine,"gpuUpdateParticles",{bindingsMapping:t,defines:e.split(`
`)}),(i=this._simParamsComputeShader)==null||i.dispose(),this._simParamsComputeShader=new hn(this._engine,void 0,void 0,"ComputeShaderParticleSystemUBO"),this._simParamsComputeShader.addUniform("currentCount",1),this._simParamsComputeShader.addUniform("timeDelta",1),this._simParamsComputeShader.addUniform("stopFactor",1),this._simParamsComputeShader.addUniform("randomTextureSize",1),this._simParamsComputeShader.addUniform("lifeTime",2),this._simParamsComputeShader.addUniform("emitPower",2),this._parent._colorGradientsTexture||(this._simParamsComputeShader.addUniform("color1",4),this._simParamsComputeShader.addUniform("color2",4)),this._simParamsComputeShader.addUniform("sizeRange",2),this._simParamsComputeShader.addUniform("scaleRange",4),this._simParamsComputeShader.addUniform("angleRange",4),this._simParamsComputeShader.addUniform("gravity",3),this._parent._limitVelocityGradientsTexture&&this._simParamsComputeShader.addUniform("limitVelocityDamping",1),this._parent.isAnimationSheetEnabled&&this._simParamsComputeShader.addUniform("cellInfos",4),this._parent.noiseTexture&&this._simParamsComputeShader.addUniform("noiseStrength",3),this._parent.flowMap&&(this._simParamsComputeShader.addUniform("flowMapProjection",16),this._simParamsComputeShader.addUniform("flowMapStrength",1)),this._parent.isLocal||this._simParamsComputeShader.addUniform("emitterWM",16),this._parent.particleEmitterType&&this._parent.particleEmitterType.buildUniformLayout(this._simParamsComputeShader),this._updateComputeShader.setUniformBuffer("params",this._simParamsComputeShader),new eM(this._simParamsComputeShader)}createVertexBuffers(e,t){this._renderVertexBuffers.push(t)}createParticleBuffer(e){const t=new ZI(this._engine,e.length*4,11,"ComputeShaderParticleSystemBuffer");return t.update(e),this._bufferComputeShader.push(t),t.getBuffer()}bindDrawBuffers(e,t,i){this._engine.bindBuffers(this._renderVertexBuffers[e],i,t)}preUpdateParticleBuffer(){}updateParticleBuffer(e,t,i){this._simParamsComputeShader.update(),this._updateComputeShader.setTexture("randomTexture",this._parent._randomTexture,!1),this._updateComputeShader.setTexture("randomTexture2",this._parent._randomTexture2,!1),this._parent._sizeGradientsTexture&&this._updateComputeShader.setTexture("sizeGradientTexture",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateComputeShader.setTexture("angularSpeedGradientTexture",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateComputeShader.setTexture("velocityGradientTexture",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateComputeShader.setTexture("limitVelocityGradientTexture",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateComputeShader.setTexture("dragGradientTexture",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateComputeShader.setTexture("noiseTexture",this._parent.noiseTexture),this._parent.flowMap&&this._updateComputeShader.setTexture("flowMapTexture",this._parent.flowMap),this._updateComputeShader.setStorageBuffer("particlesIn",this._bufferComputeShader[e]),this._updateComputeShader.setStorageBuffer("particlesOut",this._bufferComputeShader[e^1]),this._updateComputeShader.dispatch(Math.ceil(i/64))}releaseBuffers(){var e;for(let t=0;t<this._bufferComputeShader.length;++t)this._bufferComputeShader[t].dispose();this._bufferComputeShader.length=0,(e=this._simParamsComputeShader)==null||e.dispose(),this._simParamsComputeShader=null,this._updateComputeShader=null}releaseVertexBuffers(){this._renderVertexBuffers.length=0}}y("BABYLON.ComputeShaderParticleSystem",TH);class Dh{constructor(){this._emitterNodeIsOwned=!0,this.systems=[]}get emitterNode(){return this._emitterNode}set emitterNode(e){this._emitterNodeIsOwned&&this._emitterNode&&(this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNodeIsOwned=!1);for(const t of this.systems)t.emitter=e;this._emitterNode=e}setEmitterAsSphere(e,t,i){this._emitterNodeIsOwned&&this._emitterNode&&this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNodeIsOwned=!0,this._emitterCreationOptions={kind:"Sphere",options:e,renderingGroupId:t};const r=Sn("emitterSphere",{diameter:e.diameter,segments:e.segments},i);r.renderingGroupId=t;const n=new Lr("emitterSphereMaterial",i);n.emissiveColor=e.color,r.material=n;for(const a of this.systems)a.emitter=r;this._emitterNode=r}start(e){for(const t of this.systems)e&&(t.emitter=e),t.start()}dispose(){for(const e of this.systems)e.dispose();this.systems.length=0,this._emitterNode&&(this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNode=null)}serialize(e=!1){const t={};t.systems=[];for(const i of this.systems)t.systems.push(i.serialize(e));return this._emitterNode&&(t.emitter=this._emitterCreationOptions),t}static Parse(e,t,i=!1,r){const n=new Dh,a=this.BaseAssetsUrl+"/textures/";t=t||De.LastCreatedScene;for(const o of e.systems)n.systems.push(i?EI.Parse(o,t,a,!0,r):Dl.Parse(o,t,a,!0,r));if(e.emitter){const o=e.emitter.options;switch(e.emitter.kind){case"Sphere":n.setEmitterAsSphere({diameter:o.diameter,segments:o.segments,color:q.FromArray(o.color)},e.emitter.renderingGroupId,t);break}}return n}}Dh.BaseAssetsUrl="https://assets.babylonjs.com/particles";ko(se.NAME_PARTICLESYSTEM,(s,e,t,i)=>{const r=wI(se.NAME_PARTICLESYSTEM);if(r&&s.particleSystems!==void 0&&s.particleSystems!==null)for(let n=0,a=s.particleSystems.length;n<a;n++){const o=s.particleSystems[n];t.particleSystems.push(r(o,e,i))}});oF(se.NAME_PARTICLESYSTEM,(s,e,t)=>s.activeParticleCount?EI.Parse(s,e,t):Dl.Parse(s,e,t));te.prototype.createEffectForParticles=function(s,e=[],t=[],i="",r,n,a,o,l=0,c){let u=[],h=[];const d=[];return o?o.fillUniformsAttributesAndSamplerNames(h,u,d):(u=Dl._GetAttributeNamesOrOptions(),h=Dl._GetEffectCreationOptions()),i.indexOf(" BILLBOARD")===-1&&(i+=`
#define BILLBOARD
`),o!=null&&o.isAnimationSheetEnabled&&i.indexOf(" ANIMATESHEET")===-1&&(i+=`
#define ANIMATESHEET
`),t.indexOf("diffuseSampler")===-1&&t.push("diffuseSampler"),this.createEffect({vertex:c??(o==null?void 0:o.vertexShaderName)??"particles",fragmentElement:s},u,h.concat(e),d.concat(t),i,r,n,a,void 0,l,async()=>{l===0?await U(()=>import("./particles.vertex-30642282.js"),["assets/particles.vertex-30642282.js","assets/main-e8601b72.js","assets/index-ad665221.css"]):await U(()=>import("./particles.vertex-b54b1b17.js"),["assets/particles.vertex-b54b1b17.js","assets/main-e8601b72.js","assets/index-ad665221.css","assets/clipPlaneVertex-9e3b7044.js","assets/fogVertex-63846594.js","assets/logDepthDeclaration-2a2324b6.js","assets/logDepthVertex-50f013a0.js"])})};Oe.prototype.getEmittedParticleSystems=function(){const s=[];for(let e=0;e<this.getScene().particleSystems.length;e++){const t=this.getScene().particleSystems[e];t.emitter===this&&s.push(t)}return s};Oe.prototype.getHierarchyEmittedParticleSystems=function(){const s=[],e=this.getDescendants();e.push(this);for(let t=0;t<this.getScene().particleSystems.length;t++){const i=this.getScene().particleSystems[t],r=i.emitter;r.position&&e.indexOf(r)!==-1&&s.push(i)}return s};var xb;(function(s){s[s.Color=2]="Color",s[s.UV=1]="UV",s[s.Random=0]="Random",s[s.Stated=3]="Stated"})(xb||(xb={}));const Eb=new x(0,0,0),Tb=new x(0,0,0),to=new x(0,0,0);class du{constructor(e,t,i){this.width=e,this.height=t,this.data=i}processFlowable(e,t=1,i){if(!i)return;i instanceof z?x.TransformCoordinatesToRef(e.position,i,to):(to.x=i.x,to.y=i.y,to.z=i.z);const r=to.x*.5+.5,n=1-(to.y*.5+.5),a=Math.floor(r*this.width),o=Math.floor(n*this.height);if(a<0||a>=this.width||o<0||o>=this.height)return;const l=(o*this.width+a)*4,c=this.data[l],u=this.data[l+1],h=this.data[l+2],d=this.data[l+3],f=c/255*2-1,m=u/255*2-1,g=h/255*2-1,v=d/255;Eb.set(f,m,g),Eb.scaleToRef(t*v,Tb),e.direction.addInPlace(Tb)}_processParticle(e,t=1,i){this.processFlowable(e,t,i)}static async FromUrlAsync(e){return await new Promise((t,i)=>{const r=document.createElement("canvas"),n=r.getContext("2d");let a=null;const o=new Image;o.crossOrigin="anonymous",o.src=e,o.onerror=l=>{i(new Error(`Failed to load image: ${e} : ${l}`))},o.onload=()=>{r.width=o.width,r.height=o.height,n.drawImage(o,0,0),a=n.getImageData(0,0,r.width,r.height),t(new du(r.width,r.height,a.data))}})}static async ExtractFromTextureAsync(e){const t=await Jm.GetTextureDataAsync(e),{width:i,height:r}=e.getSize();return new du(i,r,new Uint8ClampedArray(t))}}var L;(function(s){s[s.Int=1]="Int",s[s.Float=2]="Float",s[s.Vector2=4]="Vector2",s[s.Vector3=8]="Vector3",s[s.Matrix=16]="Matrix",s[s.Particle=32]="Particle",s[s.Texture=64]="Texture",s[s.Color4=128]="Color4",s[s.FloatGradient=256]="FloatGradient",s[s.Vector2Gradient=512]="Vector2Gradient",s[s.Vector3Gradient=1024]="Vector3Gradient",s[s.Color4Gradient=2048]="Color4Gradient",s[s.System=4096]="System",s[s.AutoDetect=8192]="AutoDetect",s[s.BasedOnInput=16384]="BasedOnInput",s[s.Undefined=32768]="Undefined",s[s.All=65535]="All"})(L||(L={}));var bb;(function(s){s[s.Compatible=0]="Compatible",s[s.TypeIncompatible=1]="TypeIncompatible",s[s.HierarchyIssue=2]="HierarchyIssue"})(bb||(bb={}));var Cb;(function(s){s[s.Input=0]="Input",s[s.Output=1]="Output"})(Cb||(Cb={}));class yb{get direction(){return this._direction}get type(){if(this._type===L.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource){if(this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.type;if(this._linkedConnectionSource._defaultConnectionPointType)return this._linkedConnectionSource._defaultConnectionPointType}if(this._defaultConnectionPointType)return this._defaultConnectionPointType}if(this._type===L.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSourceTranslation?this._typeConnectionSourceTranslation(this._typeConnectionSource.type):this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._type=e}get isConnected(){return this.connectedPoint!==null||this.hasEndpoints}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return this._endpoints.length===0?[]:this._endpoints.map(e=>e.ownerBlock)}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get innerType(){return this._linkedConnectionSource&&!this._isMainLinkSource&&this._linkedConnectionSource.isConnected?this.type:this._type}constructor(e,t,i){this._connectedPoint=null,this._storedValue=null,this._storedFunction=null,this._acceptedConnectionPointType=null,this._endpoints=new Array,this._type=L.Particle,this._linkedConnectionSource=null,this._typeConnectionSource=null,this._typeConnectionSourceTranslation=null,this._defaultConnectionPointType=null,this._isMainLinkSource=!1,this.acceptedConnectionPointTypes=[],this.excludedConnectionPointTypes=[],this.onConnectionObservable=new k,this.onDisconnectionObservable=new k,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this.defaultValue=null,this.value=null,this.valueMin=null,this.valueMax=null,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeParticleConnectionPoint"}getConnectedValue(e){var t;return this.isConnected?(t=this._connectedPoint)!=null&&t._storedFunction?this._connectedPoint._storedFunction(e):this._connectedPoint._storedValue:this.value}canConnectTo(e){return this.checkCompatibilityState(e)===0}checkCompatibilityState(e){const t=this._ownerBlock,i=e.ownerBlock;if(this.type!==e.type&&e.innerType!==L.AutoDetect)return e.acceptedConnectionPointTypes&&e.acceptedConnectionPointTypes.indexOf(this.type)!==-1?0:1;if(e.excludedConnectionPointTypes&&e.excludedConnectionPointTypes.indexOf(this.type)!==-1)return 1;let r=i,n=t;return this.direction===0&&(r=t,n=i),r.isAnAncestorOf(n)?2:0}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw`Cannot connect these two connectors. source: "${this.ownerBlock.name}".${this.name}, target: "${e.ownerBlock.name}".${e.name}`;return this._endpoints.push(e),e._connectedPoint=this,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){const t=this._endpoints.indexOf(e);return t===-1?this:(this._endpoints.splice(t,1),e._connectedPoint=null,this.onDisconnectionObservable.notifyObservers(e),e.onDisconnectionObservable.notifyObservers(this),this)}addExcludedConnectionPointFromAllowedTypes(e){let t=1;for(;t<L.All;)e&t||this.excludedConnectionPointTypes.push(t),t=t<<1}serialize(e=!0){const t={};return t.name=this.name,t.displayName=this.displayName,this.value!==void 0&&this.value!==null&&(this.value.asArray?(t.valueType="BABYLON."+this.value.getClassName(),t.value=this.value.asArray()):(t.valueType="number",t.value=this.value)),e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear(),this.onDisconnectionObservable.clear()}}class Ze{get isTeleportOut(){return this._isTeleportOut}get isTeleportIn(){return this._isTeleportIn}get isSystem(){return this._isSystem}get isInput(){return this._isInput}get isDebug(){return this._isDebug}get name(){return this._name}set name(e){this._name=e}getClassName(){return"NodeParticleBlock"}get inputs(){return this._inputs}get outputs(){return this._outputs}constructor(e){this._name="",this._isInput=!1,this._isSystem=!1,this._isDebug=!1,this._isTeleportOut=!1,this._isTeleportIn=!1,this._inputs=new Array,this._outputs=new Array,this.onBuildObservable=new k,this.onDisposeObservable=new k,this.onInputChangedObservable=new k,this.visibleOnFrame=!1,this._name=e,this.uniqueId=bn.UniqueId}_inputRename(e){return e}_outputRename(e){return e}isAnAncestorOf(e){for(const t of this._outputs)if(t.hasEndpoints){for(const i of t.endpoints)if(i.ownerBlock===e||i.ownerBlock.isAnAncestorOf(e))return!0}return!1}isAnAncestorOfType(e){if(this.getClassName()===e)return!0;for(const t of this._outputs)if(t.hasEndpoints){for(const i of t.endpoints)if(i.ownerBlock.isAnAncestorOfType(e))return!0}return!1}getInputByName(e){const t=this._inputs.filter(i=>i.name===e);return t.length?t[0]:null}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:(this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[e]._isMainLinkSource=!0),this._inputs[t]._linkedConnectionSource=this._inputs[e]}registerInput(e,t,i=!1,r,n,a){const o=new yb(e,this,0);return o.type=t,o.isOptional=i,o.defaultValue=r,o.value=r,o.valueMin=n,o.valueMax=a,this._inputs.push(o),this.onInputChangedObservable.notifyObservers(o),this}registerOutput(e,t,i){return i=i??new yb(e,this,1),i.type=t,this._outputs.push(i),this}_build(e){}_customBuildStep(e){}build(e){if(this._buildId===e.buildId)return!0;if(this._outputs.length>0&&!this._outputs.some(t=>t.hasEndpoints)&&!this.isDebug&&!this.isSystem)return!1;this._buildId=e.buildId;for(const t of this._inputs){if(!t.connectedPoint){t.isOptional||e.notConnectedNonOptionalInputs.push(t);continue}const i=t.connectedPoint.ownerBlock;i&&i!==this&&!i.isSystem&&i.build(e)}return this._customBuildStep(e),e.verbose&&N.Log(`Building ${this.name} [${this.getClassName()}]`),this._build(e),this.onBuildObservable.notifyObservers(this),!1}serialize(){const e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.visibleOnFrame=this.visibleOnFrame,e.comments=this.comments,e.inputs=[],e.outputs=[];for(const t of this.inputs)e.inputs.push(t.serialize());for(const t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e){this._name=e.name,this.comments=e.comments,this.visibleOnFrame=!!e.visibleOnFrame,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){const t=e.inputs,i=e.outputs;if(t)for(const r of t){const n=this.inputs.find(a=>a.name===r.name);if(!n)return;if(r.displayName&&(n.displayName=r.displayName),r.isExposedOnFrame&&(n.isExposedOnFrame=r.isExposedOnFrame,n.exposedPortPosition=r.exposedPortPosition),r.value!==void 0&&r.value!==null)if(r.valueType==="number")n.value=r.value;else{const a=ki(r.valueType);a&&(n.value=a.FromArray(r.value))}}if(i)for(let r=0;r<i.length;r++){const n=i[r];n.displayName&&(this.outputs[r].displayName=n.displayName),n.isExposedOnFrame&&(this.outputs[r].isExposedOnFrame=n.isExposedOnFrame,this.outputs[r].exposedPortPosition=n.exposedPortPosition)}}clone(){const e=this.serialize(),t=ki(e.customType);if(t){const i=new t;return i._deserialize(e),i}return null}dispose(){this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear();for(const e of this.inputs)e.dispose();for(const e of this.outputs)e.dispose();this.onBuildObservable.clear(),this.onInputChangedObservable.clear()}}_([R("comment")],Ze.prototype,"comments",void 0);var Je;(function(s){s[s.None=0]="None",s[s.Position=1]="Position",s[s.Direction=2]="Direction",s[s.Age=3]="Age",s[s.Lifetime=4]="Lifetime",s[s.Color=5]="Color",s[s.ScaledDirection=6]="ScaledDirection",s[s.Scale=7]="Scale",s[s.AgeGradient=8]="AgeGradient",s[s.Angle=9]="Angle",s[s.SpriteCellIndex=16]="SpriteCellIndex",s[s.SpriteCellStart=17]="SpriteCellStart",s[s.SpriteCellEnd=18]="SpriteCellEnd",s[s.InitialColor=19]="InitialColor",s[s.ColorDead=20]="ColorDead",s[s.InitialDirection=21]="InitialDirection"})(Je||(Je={}));var er;(function(s){s[s.None=0]="None",s[s.Time=1]="Time",s[s.Delta=2]="Delta",s[s.Emitter=3]="Emitter",s[s.CameraPosition=4]="CameraPosition"})(er||(er={}));class $0{constructor(){this.notConnectedNonOptionalInputs=[],this.particleContext=null,this.systemContext=null,this.gradientIndex=0,this.nextGradientIndex=0}emitErrors(){let e="";for(const t of this.notConnectedNonOptionalInputs)e+=`input ${t.name} from block ${t.ownerBlock.name}[${t.ownerBlock.getClassName()}] is not connected and is not optional.
`;if(e)throw`Build of Node Particle System Set failed:
`+e}adapt(e,t){const i=e.getConnectedValue(this)||0;if(e.type===t)return i;switch(t){case L.Vector2:return new X(i,i);case L.Vector3:return new x(i,i,i);case L.Color4:return new Te(i,i,i,i)}return null}getContextualValue(e){if(!this.particleContext||!this.systemContext)return null;switch(e){case Je.Position:return this.particleContext.position;case Je.Direction:return this.particleContext.direction;case Je.ScaledDirection:return this.particleContext.direction.scaleToRef(this.systemContext._directionScale,this.systemContext._scaledDirection),this.systemContext._scaledDirection;case Je.Color:return this.particleContext.color;case Je.InitialColor:return this.particleContext.initialColor;case Je.ColorDead:return this.particleContext.colorDead;case Je.Age:return this.particleContext.age;case Je.Lifetime:return this.particleContext.lifeTime;case Je.Angle:return this.particleContext.angle;case Je.Scale:return this.particleContext.scale;case Je.AgeGradient:return this.particleContext.age/this.particleContext.lifeTime;case Je.SpriteCellEnd:return this.systemContext.endSpriteCellID;case Je.SpriteCellIndex:return this.particleContext.cellIndex;case Je.SpriteCellStart:return this.systemContext.startSpriteCellID;case Je.InitialDirection:return this.particleContext._initialDirection}return null}get isEmitterTransformNode(){return this.systemContext?!!this.systemContext.emitter.position:!1}get emitterWorldMatrix(){return this.systemContext?this.systemContext._emitterWorldMatrix:null}get emitterInverseWorldMatrix(){return this.systemContext?this.systemContext._emitterInverseWorldMatrix:null}get emitterPosition(){return this.systemContext?this.isEmitterTransformNode?this.systemContext.emitter.absolutePosition:this.systemContext.emitter:null}getSystemValue(e){var t;if(!this.particleContext||!this.systemContext)return null;switch(e){case er.Time:return this.systemContext._actualFrame;case er.Delta:return this.systemContext._scaledUpdateSpeed;case er.Emitter:return this.isEmitterTransformNode?this.systemContext.emitter.absolutePosition:this.systemContext.emitter;case er.CameraPosition:return((t=this.scene.activeCamera)==null?void 0:t.globalPosition)||x.Zero()}return null}}function If(s,e,t){const i=new $0;i.scene=e;const r=s.createSystem(i);return r.canStart=()=>!0,r.emitter=t.clone(),r.disposeOnStop=!0,r.start(),r}class Cs extends Ze{constructor(e){super(e),this.blendMode=Nn.BLENDMODE_ONEONE,this.capacity=1e3,this.emitRate=10,this.targetStopDuration=0,this.startDelay=0,this.doNoStart=!1,this._internalId=Cs._IdCounter++,this._isSystem=!0,this.registerInput("particle",L.Particle),this.registerInput("texture",L.Texture),this.registerInput("onStart",L.System,!0),this.registerInput("onEnd",L.System,!0),this.registerOutput("system",L.System)}getClassName(){return"SystemBlock"}get particle(){return this._inputs[0]}get texture(){return this._inputs[1]}get onStart(){return this._inputs[2]}get onEnd(){return this._inputs[3]}get system(){return this._outputs[0]}createSystem(e){e.capacity=this.capacity,e.buildId=this._buildId++,this.build(e);const t=this.particle.getConnectedValue(e);return t.particleTexture=this.texture.getConnectedValue(e),t.emitRate=this.emitRate,t.blendMode=this.blendMode,t.name=this.name,t._targetStopDuration=this.targetStopDuration,t.startDelay=this.startDelay,this.system._storedValue=this,t.canStart=()=>!this.doNoStart,t.onStartedObservable.add(i=>{const r=this.onStart.getConnectedValue(e);r&&i.onStartedObservable.addOnce(()=>{e.systemContext=t;const a=If(r,e.scene,e.emitterPosition);this.onDisposeObservable.addOnce(()=>{a.dispose()})});const n=this.onEnd.getConnectedValue(e);n&&i.onStoppedObservable.addOnce(()=>{e.systemContext=t;const a=If(n,e.scene,e.emitterPosition);this.onDisposeObservable.addOnce(()=>{a.dispose()})})}),this.onDisposeObservable.addOnce(()=>{t.dispose()}),t}serialize(){const e=super.serialize();return e.capacity=this.capacity,e.emitRate=this.emitRate,e.blendMode=this.blendMode,e.doNoStart=this.doNoStart,e.targetStopDuration=this.targetStopDuration,e.startDelay=this.startDelay,e}_deserialize(e){super._deserialize(e),this.capacity=e.capacity,this.emitRate=e.emitRate,this.doNoStart=!!e.doNoStart,e.blendMode!==void 0&&(this.blendMode=e.blendMode),e.targetStopDuration!==void 0&&(this.targetStopDuration=e.targetStopDuration),e.startDelay!==void 0&&(this.startDelay=e.startDelay)}}Cs._IdCounter=0;_([O("Blend mode",5,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"OneOne",value:Nn.BLENDMODE_ONEONE},{label:"Standard",value:Nn.BLENDMODE_STANDARD},{label:"Add",value:Nn.BLENDMODE_ADD},{label:"Multiply",value:Nn.BLENDMODE_MULTIPLY},{label:"MultiplyAdd",value:Nn.BLENDMODE_MULTIPLYADD}]})],Cs.prototype,"blendMode",void 0);_([O("Capacity",2,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},min:0,max:1e4})],Cs.prototype,"capacity",void 0);_([O("Emit rate",2,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},min:0})],Cs.prototype,"emitRate",void 0);_([O("Target duration",1,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},min:0})],Cs.prototype,"targetStopDuration",void 0);_([O("Delay start(ms)",1,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},min:0})],Cs.prototype,"startDelay",void 0);_([O("Do no start",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Cs.prototype,"doNoStart",void 0);y("BABYLON.SystemBlock",Cs);class Rf extends Ze{get type(){if(this._type===L.AutoDetect&&this.value!=null){if(!isNaN(this.value))return this._type=L.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=L.Vector2,this._type;case"Vector3":return this._type=L.Vector3,this._type;case"Color4":return this._type=L.Color4,this._type;case"Matrix":return this._type=L.Matrix,this._type}}return this._type}get isSystemSource(){return this._contextualSource===Je.None&&this._systemSource!==er.None}get systemSource(){return this._systemSource}set systemSource(e){if(this._systemSource=e,e!==er.None){switch(this._contextualSource=Je.None,this._type=L.Float,e){case er.Time:case er.Delta:this._type=L.Float;break;case er.Emitter:case er.CameraPosition:this._type=L.Vector3;break}this.output&&(this.output.type=this._type)}}get isContextual(){return this._contextualSource!==Je.None}get contextualValue(){return this._contextualSource}set contextualValue(e){if(this._contextualSource=e,e!==Je.None){switch(this._systemSource=er.None,e){case Je.Scale:this._type=L.Vector2;break;case Je.Position:case Je.Direction:case Je.ScaledDirection:case Je.InitialDirection:this._type=L.Vector3;break;case Je.Color:case Je.InitialColor:case Je.ColorDead:this._type=L.Color4;break;case Je.Age:case Je.Lifetime:case Je.Angle:case Je.AgeGradient:this._type=L.Float;break;case Je.SpriteCellEnd:case Je.SpriteCellStart:case Je.SpriteCellIndex:this._type=L.Int;break}this.output&&(this.output.type=this._type)}}constructor(e,t=L.AutoDetect){super(e),this._type=L.Undefined,this.min=0,this.max=0,this.groupInInspector="",this.displayInInspector=!0,this.onValueChangedObservable=new k,this._systemSource=er.None,this._contextualSource=Je.None,this._type=t,this._isInput=!0,this._storedValue=null,this.setDefaultValue(),this.registerOutput("output",t)}get value(){return this._storedValue}set value(e){this.type===L.Float&&this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e)),this._storedValue=e,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this._valueCallback}set valueCallback(e){this._valueCallback=e}getClassName(){return"ParticleInputBlock"}get output(){return this._outputs[0]}setDefaultValue(){switch(this.type){case L.Int:case L.Float:this.value=0;break;case L.Vector2:this.value=X.Zero();break;case L.Vector3:this.value=x.Zero();break;case L.Color4:this.value=new Te(1,1,1,1);break;case L.Matrix:this.value=z.Identity();break}}_build(e){super._build(e),this.isSystemSource?(this.output._storedValue=null,this.output._storedFunction=t=>t.getSystemValue(this._systemSource)):this.isContextual?(this.output._storedValue=null,this.output._storedFunction=t=>t.getContextualValue(this._contextualSource)):(this.output._storedValue=this.value,this.output._storedFunction=()=>this.value)}dispose(){this.onValueChangedObservable.clear(),super.dispose()}serialize(){const e=super.serialize();return e.type=this.type,e.contextualValue=this.contextualValue,e.systemSource=this.systemSource,e.min=this.min,e.max=this.max,e.groupInInspector=this.groupInInspector,e.displayInInspector=this.displayInInspector,this._storedValue!==null&&!this.isContextual&&!this.isSystemSource&&(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e}_deserialize(e){if(super._deserialize(e),this._type=e.type,this.contextualValue=e.contextualValue,this.systemSource=e.systemSource||er.None,this.min=e.min||0,this.max=e.max||0,this.groupInInspector=e.groupInInspector||"",e.displayInInspector!==void 0&&(this.displayInInspector=e.displayInInspector),!!e.valueType)if(e.valueType==="number")this._storedValue=e.value;else{const t=ki(e.valueType);t&&(this._storedValue=t.FromArray(e.value))}}}y("BABYLON.ParticleInputBlock",Rf);class X0 extends Ze{get url(){return this._url}set url(e){this._url!==e&&(this._cachedData=null,this._url=e,this._textureDataUrl="",this._sourceTexture=null)}get textureDataUrl(){return this._textureDataUrl}set textureDataUrl(e){this._textureDataUrl!==e&&(this._cachedData=null,this._textureDataUrl=e,this._url="",this._sourceTexture=null)}set sourceTexture(e){this._sourceTexture!==e&&(this._cachedData=null,this._sourceTexture=e,this._url=e.url||"",this._textureDataUrl="")}constructor(e){super(e),this._url="",this._textureDataUrl="",this._sourceTexture=null,this._cachedData=null,this.serializedCachedData=!1,this.registerOutput("texture",L.Texture)}getClassName(){return"ParticleTextureSourceBlock"}get texture(){return this._outputs[0]}async extractTextureContentAsync(){if(!this.texture._storedValue&&!this._sourceTexture)return null;if(this._cachedData)return this._cachedData;const e=this.texture._storedValue||this._sourceTexture;return await new Promise((t,i)=>{if(!e.isReady()){e.onLoadObservable.addOnce(async()=>{try{this._cachedData=await this.extractTextureContentAsync(),t(this._cachedData)}catch(n){i(n)}});return}const r=e.getSize();Jm.GetTextureDataAsync(e,r.width,r.height).then(n=>{this._cachedData={width:r.width,height:r.height,data:new Uint8ClampedArray(n)},e.dispose(),t(this._cachedData)}).catch(i)})}_build(e){if(this._sourceTexture){this.texture._storedValue=this._sourceTexture;return}if(!this._textureDataUrl&&!this._url){this.texture._storedValue=null;return}if(this._textureDataUrl){this.texture._storedValue=new $(this._textureDataUrl,e.scene);return}this.texture._storedValue=new $(this._url,e.scene)}serialize(){const e=super.serialize();return e.url=this.url,e.serializedCachedData=this.serializedCachedData,this.serializedCachedData&&(e.textureDataUrl=this.textureDataUrl),e}_deserialize(e){super._deserialize(e),this.url=e.url,this.serializedCachedData=!!e.serializedCachedData,e.textureDataUrl&&(this.textureDataUrl=e.textureDataUrl)}dispose(){this._sourceTexture||this.texture._storedValue&&(this.texture._storedValue.dispose(),this.texture._storedValue=null),super.dispose()}}y("BABYLON.ParticleTextureSourceBlock",X0);class Y0 extends Ze{constructor(e){super(e),this.registerInput("particle",L.Particle),this.registerInput("position",L.Vector3),this.registerOutput("output",L.Particle)}get particle(){return this._inputs[0]}get position(){return this._inputs[1]}get output(){return this._outputs[0]}getClassName(){return"UpdatePositionBlock"}_build(e){const t=this.particle.getConnectedValue(e);if(this.output._storedValue=t,!this.position.isConnected)return;const r={process:n=>{e.particleContext=n,e.systemContext=t,n.position.copyFrom(this.position.getConnectedValue(e))},previousItem:null,nextItem:null};t._updateQueueStart?Tr(r,t._updateQueueStart):t._updateQueueStart=r}}y("BABYLON.UpdatePositionBlock",Y0);var Xi;(function(s){s[s.Add=0]="Add",s[s.Subtract=1]="Subtract",s[s.Multiply=2]="Multiply",s[s.Divide=3]="Divide",s[s.Max=4]="Max",s[s.Min=5]="Min"})(Xi||(Xi={}));class q_ extends Ze{constructor(e){super(e),this.operation=Xi.Add,this.registerInput("left",L.AutoDetect),this.registerInput("right",L.AutoDetect),this.registerOutput("output",L.BasedOnInput),this.output._typeConnectionSource=this.left;const t=[L.Matrix,L.Particle,L.Texture,L.System,L.FloatGradient,L.Color4Gradient,L.Vector2Gradient,L.Vector3Gradient];this.left.excludedConnectionPointTypes.push(...t),this.right.excludedConnectionPointTypes.push(...t),this._linkConnectionTypes(0,1),this._connectionObservers=[this.left.onConnectionObservable.add(()=>this._updateInputOutputTypes()),this.left.onDisconnectionObservable.add(()=>this._updateInputOutputTypes()),this.right.onConnectionObservable.add(()=>this._updateInputOutputTypes()),this.right.onDisconnectionObservable.add(()=>this._updateInputOutputTypes())]}getClassName(){return"ParticleMathBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_build(e){let t;const i=this.left,r=this.right;if(!i.isConnected||!r.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}const n=i.type===L.Float||i.type===L.Int,a=r.type===L.Float||r.type===L.Int,o=n&&a;switch(this.operation){case Xi.Add:{o?t=l=>i.getConnectedValue(l)+r.getConnectedValue(l):n?t=l=>l.adapt(i,r.type).add(r.getConnectedValue(l)):t=l=>i.getConnectedValue(l).add(l.adapt(r,i.type));break}case Xi.Subtract:{o?t=l=>i.getConnectedValue(l)-r.getConnectedValue(l):n?t=l=>l.adapt(i,r.type).subtract(r.getConnectedValue(l)):t=l=>i.getConnectedValue(l).subtract(l.adapt(r,i.type));break}case Xi.Multiply:{o?t=l=>i.getConnectedValue(l)*r.getConnectedValue(l):n?t=l=>l.adapt(i,r.type).multiply(r.getConnectedValue(l)):t=l=>i.getConnectedValue(l).multiply(l.adapt(r,i.type));break}case Xi.Divide:{o?t=l=>i.getConnectedValue(l)/r.getConnectedValue(l):n?t=l=>l.adapt(i,r.type).divide(r.getConnectedValue(l)):t=l=>i.getConnectedValue(l).divide(l.adapt(r,i.type));break}case Xi.Min:{if(o)t=l=>Math.min(i.getConnectedValue(l),r.getConnectedValue(l));else{const[l,c]=n?[r,i]:[i,r];switch(l.type){case L.Vector2:{t=u=>X.Minimize(l.getConnectedValue(u),u.adapt(c,l.type));break}case L.Vector3:{t=u=>x.Minimize(l.getConnectedValue(u),u.adapt(c,l.type));break}case L.Color4:{t=u=>{const h=l.getConnectedValue(u),{r:d,g:f,b:m,a:g}=u.adapt(c,l.type);return new Te(Math.min(h.r,d),Math.min(h.g,f),Math.min(h.b,m),Math.min(h.a,g))};break}}}break}case Xi.Max:if(o)t=l=>Math.max(i.getConnectedValue(l),r.getConnectedValue(l));else{const[l,c]=n?[r,i]:[i,r];switch(l.type){case L.Vector2:{t=u=>X.Maximize(l.getConnectedValue(u),u.adapt(c,l.type));break}case L.Vector3:{t=u=>x.Maximize(l.getConnectedValue(u),u.adapt(c,l.type));break}case L.Color4:{t=u=>{const h=l.getConnectedValue(u),{r:d,g:f,b:m,a:g}=u.adapt(c,l.type);return new Te(Math.max(h.r,d),Math.min(h.g,f),Math.min(h.b,m),Math.min(h.a,g))};break}}break}}this.output._storedFunction=l=>i.type===L.Int?t(l)|0:t(l)}_updateInputOutputTypes(){if(this.output._typeConnectionSource=this.left,this.left.isConnected&&this.right.isConnected?(this.left.type===L.Int||this.left.type===L.Float&&this.right.type!==L.Int)&&(this.output._typeConnectionSource=this.right):this.left.isConnected!==this.right.isConnected&&(this.output._typeConnectionSource=this.left.isConnected?this.left:this.right),this.left.isConnected||this.right.isConnected)for(const[e,t]of[[this.left,this.right],[this.right,this.left]])e.acceptedConnectionPointTypes=[L.Int,L.Float],t.isConnected&&(e.acceptedConnectionPointTypes.push(t.type),(t.type===L.Int||t.type===L.Float)&&e.acceptedConnectionPointTypes.push(L.Vector2,L.Vector3,L.Color4))}dispose(){super.dispose();for(const e of this._connectionObservers)e.remove();this._connectionObservers.length=0}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e){super._deserialize(e),this.operation=e.operation}}_([O("Operation",5,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Add",value:Xi.Add},{label:"Subtract",value:Xi.Subtract},{label:"Multiply",value:Xi.Multiply},{label:"Divide",value:Xi.Divide},{label:"Max",value:Xi.Max},{label:"Min",value:Xi.Min}]})],q_.prototype,"operation",void 0);y("BABYLON.ParticleMathBlock",q_);class j0 extends Ze{constructor(e){super(e),this.registerInput("particle",L.Particle),this.registerInput("direction1",L.Vector3,!0,new x(0,1,0)),this.registerInput("direction2",L.Vector3,!0,new x(0,1,0)),this.registerInput("minEmitBox",L.Vector3,!0,new x(-.5,-.5,-.5)),this.registerInput("maxEmitBox",L.Vector3,!0,new x(.5,.5,.5)),this.registerOutput("output",L.Particle)}getClassName(){return"BoxShapeBlock"}get particle(){return this._inputs[0]}get direction1(){return this._inputs[1]}get direction2(){return this._inputs[2]}get minEmitBox(){return this._inputs[3]}get maxEmitBox(){return this._inputs[4]}get output(){return this._outputs[0]}_build(e){const t=this.particle.getConnectedValue(e);t._directionCreation.process=i=>{e.particleContext=i,e.systemContext=t;const r=this.direction1.getConnectedValue(e),n=this.direction2.getConnectedValue(e),a=It(r.x,n.x),o=It(r.y,n.y),l=It(r.z,n.z);e.isEmitterTransformNode?x.TransformNormalFromFloatsToRef(a,o,l,e.emitterWorldMatrix,i.direction):i.direction.copyFromFloats(a,o,l),i._initialDirection=i.direction.clone()},t._positionCreation.process=i=>{e.particleContext=i,e.systemContext=t;const r=this.minEmitBox.getConnectedValue(e),n=this.maxEmitBox.getConnectedValue(e),a=It(r.x,n.x),o=It(r.y,n.y),l=It(r.z,n.z);e.isEmitterTransformNode?x.TransformCoordinatesFromFloatsToRef(a,o,l,e.emitterWorldMatrix,i.position):(i.position.copyFromFloats(a,o,l),i.position.addInPlace(e.emitterPosition))},this.output._storedValue=t}}y("BABYLON.BoxShapeBlock",j0);const Ib=new Te;class q0 extends Ze{constructor(e){super(e),this.registerInput("emitPower",L.Float,!0,1),this.registerInput("lifeTime",L.Float,!0,1),this.registerInput("color",L.Color4,!0,new Te(1,1,1,1)),this.registerInput("colorDead",L.Color4,!0,new Te(0,0,0,0)),this.registerInput("scale",L.Vector2,!0,new X(1,1)),this.registerInput("angle",L.Float,!0,0),this.registerOutput("particle",L.Particle),this.scale.acceptedConnectionPointTypes.push(L.Float)}getClassName(){return"CreateParticleBlock"}get emitPower(){return this._inputs[0]}get lifeTime(){return this._inputs[1]}get color(){return this._inputs[2]}get colorDead(){return this._inputs[3]}get scale(){return this._inputs[4]}get angle(){return this._inputs[5]}get particle(){return this._outputs[0]}_build(e){const t=new Dl(this.name,e.capacity,e.scene,null,!1,void 0,!0);t.particleEmitterType=new tM,t._lifeTimeCreation.process=(i,r)=>{e.particleContext=i,i.lifeTime=this.lifeTime.getConnectedValue(e),r._emitPower=this.emitPower.getConnectedValue(e)},t._colorCreation.process=i=>{e.particleContext=i,i.color.copyFrom(this.color.getConnectedValue(e))},t._colorDeadCreation.process=i=>{e.particleContext=i,i.colorDead.copyFrom(this.colorDead.getConnectedValue(e)),i.initialColor.copyFrom(i.color),i.colorDead.subtractToRef(i.initialColor,Ib),Ib.scaleToRef(1/i.lifeTime,i.colorStep)},t._sizeCreation.process=i=>{e.particleContext=i,i.size=1;const r=this.scale.getConnectedValue(e);r.x!==void 0?(i.scale.x=r.x,i.scale.y=r.y):(i.scale.x=r,i.scale.y=r)},t._angleCreation.process=i=>{e.particleContext=i,i.angle=this.angle.getConnectedValue(e)},this.particle._storedValue=t}}y("BABYLON.CreateParticleBlock",q0);class us{get systemBlocks(){return this._systemBlocks}get inputBlocks(){const e=[];for(const t of this.attachedBlocks)t.isInput&&e.push(t);return e}getBlockByName(e){let t=null;for(const i of this.attachedBlocks)if(i.name===e)if(!t)t=i;else return j.Warn("More than one block was found with the name `"+e+"`"),t;return t}getBlockByPredicate(e){for(const t of this.attachedBlocks)if(e(t))return t;return null}getInputBlockByPredicate(e){for(const t of this.attachedBlocks)if(t.isInput&&e(t))return t;return null}constructor(e){this._systemBlocks=[],this._buildId=0,this.attachedBlocks=[],this.editorData=null,this.onBuildObservable=new k,this.BJSNODEPARTICLEEDITOR=this._getGlobalNodeParticleEditor(),this.name=e}getClassName(){return"NodeParticleSystemSet"}_initializeBlock(e,t=!0){this.attachedBlocks.indexOf(e)===-1&&this.attachedBlocks.push(e);for(const i of e.inputs){const r=i.connectedPoint;if(r){const n=r.ownerBlock;n!==e&&this._initializeBlock(n,t)}}}_getGlobalNodeParticleEditor(){if(typeof NODEPARTICLEEDITOR<"u")return NODEPARTICLEEDITOR;if(typeof BABYLON<"u"&&typeof BABYLON.NodeParticleEditor<"u")return BABYLON}_createNodeParticleEditor(e){const t={nodeParticleSet:this,...e};this.BJSNODEPARTICLEEDITOR.NodeParticleEditor.Show(t)}async editAsync(e){return await new Promise(t=>{if(this.BJSNODEPARTICLEEDITOR=this.BJSNODEPARTICLEEDITOR||this._getGlobalNodeParticleEditor(),typeof this.BJSNODEPARTICLEEDITOR>"u"){const i=e&&e.editorURL?e.editorURL:us.EditorURL;j.LoadBabylonScript(i,()=>{this.BJSNODEPARTICLEEDITOR=this.BJSNODEPARTICLEEDITOR||this._getGlobalNodeParticleEditor(),this._createNodeParticleEditor(e==null?void 0:e.nodeEditorConfig),t()})}else this._createNodeParticleEditor(e==null?void 0:e.nodeEditorConfig),t()})}async buildAsync(e,t=!1){return await new Promise(i=>{const r=new Dh;for(const n of this._systemBlocks)this._initializeBlock(n);for(const n of this.systemBlocks){const a=new $0;a.buildId=this._buildId++,a.scene=e,a.verbose=t;const o=n.createSystem(a);o._source=this,o._blockReference=n._internalId,a.emitErrors(),r.systems.push(o)}this.onBuildObservable.notifyObservers(this),i(r)})}clear(){this.attachedBlocks.length=0,this._systemBlocks.length=0}setToDefault(){this.clear(),this.editorData=null;const e=new Cs("Particle system"),t=new Y0("Update position");t.output.connectTo(e.particle);const i=new Rf("Position");i.contextualValue=Je.Position;const r=new Rf("Scaled direction");r.contextualValue=Je.ScaledDirection;const n=new q_("Add");n.operation=Xi.Add,i.output.connectTo(n.left),r.output.connectTo(n.right),n.output.connectTo(t.position);const a=new q0("Create particle"),o=new j0("Box shape");a.particle.connectTo(o.particle),o.output.connectTo(t.particle);const l=new X0("Texture");l.texture.connectTo(e.texture),l.url="https://assets.babylonjs.com/textures/flare.png",this._systemBlocks.push(e)}removeBlock(e){const t=this.attachedBlocks.indexOf(e);if(t>-1&&this.attachedBlocks.splice(t,1),e.isSystem){const i=this._systemBlocks.indexOf(e);i>-1&&this._systemBlocks.splice(i,1)}}parseSerializedObject(e,t=!1){t||this.clear();const i={};for(const r of e.blocks){const n=ki(r.customType);if(n){const a=new n;a._deserialize(r),i[r.id]=a,this.attachedBlocks.push(a),a.isSystem&&this._systemBlocks.push(a)}}for(const r of this.attachedBlocks)if(r.isTeleportOut){const n=r,a=n._tempEntryPointUniqueId;if(a){const o=i[a];o&&o.attachToEndpoint(n)}}for(let r=0;r<e.blocks.length;r++){const n=e.blocks[r],a=i[n.id];a&&(a.inputs.length&&n.inputs.some(o=>o.targetConnectionName)&&!t||this._restoreConnections(a,e,i))}if(e.locations||e.editorData&&e.editorData.locations){const r=e.locations||e.editorData.locations;for(const a of r)i[a.blockId]&&(a.blockId=i[a.blockId].uniqueId);t&&this.editorData&&this.editorData.locations&&r.concat(this.editorData.locations),e.locations?this.editorData={locations:r}:(this.editorData=e.editorData,this.editorData.locations=r);const n={};for(const a in i)n[a]=i[a].uniqueId;this.editorData.map=n}this.comment=e.comment}_restoreConnections(e,t,i){for(const r of e.outputs)for(const n of t.blocks){const a=i[n.id];if(a){for(const o of n.inputs)if(i[o.targetBlockId]===e&&o.targetConnectionName===r.name){const l=a.getInputByName(o.inputName);if(!l||l.isConnected)continue;r.connectTo(l,!0),this._restoreConnections(a,t,i);continue}}}}serialize(e){const t=e?{}:me.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];e?i=e:t.customType="BABYLON.NodeParticleSystemSet",t.blocks=[];for(const r of i)t.blocks.push(r.serialize());if(!e)for(const r of this.attachedBlocks)i.indexOf(r)===-1&&t.blocks.push(r.serialize());return t}clone(e){const t=this.serialize(),i=me.Clone(()=>new us(e),this);return i.name=e,i.snippetId=this.snippetId,i.parseSerializedObject(t),i._buildId=this._buildId,i}dispose(){for(const e of this.attachedBlocks)e.dispose();this.attachedBlocks.length=0,this.onBuildObservable.clear()}static CreateDefault(e){const t=new us(e);return t.setToDefault(),t}static Parse(e){const t=me.Parse(()=>new us(e.name),e,null);return t.parseSerializedObject(e),t}static ParseFromSnippetAsync(e,t){return e==="_BLANK"?Promise.resolve(us.CreateDefault("blank")):new Promise((i,r)=>{const n=new dn;n.addEventListener("readystatechange",()=>{if(n.readyState==4)if(n.status==200){const a=JSON.parse(JSON.parse(n.responseText).jsonPayload),o=JSON.parse(a.nodeParticle);t||(t=me.Parse(()=>new us(e),o,null)),t.parseSerializedObject(o),t.snippetId=e;try{i(t)}catch(l){r(l)}}else r("Unable to load the snippet "+e)}),n.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),n.send()})}}us.EditorURL=`${j._DefaultCdnUrl}/v${te.Version}/nodeParticleEditor/babylon.nodeParticleEditor.js`;us.SnippetUrl="https://snippet.babylonjs.com";_([R()],us.prototype,"name",void 0);_([R("comment")],us.prototype,"comment",void 0);class bH extends Ze{constructor(e){super(e),this.registerInput("particle",L.Particle),this.registerInput("direction1",L.Vector3,!0,new x(0,1,0)),this.registerInput("direction2",L.Vector3,!0,new x(0,1,0)),this.registerOutput("output",L.Particle)}getClassName(){return"PointShapeBlock"}get particle(){return this._inputs[0]}get direction1(){return this._inputs[1]}get direction2(){return this._inputs[2]}get output(){return this._outputs[0]}_build(e){const t=this.particle.getConnectedValue(e);t._directionCreation.process=i=>{e.particleContext=i,e.systemContext=t;const r=this.direction1.getConnectedValue(e),n=this.direction2.getConnectedValue(e),a=It(r.x,n.x),o=It(r.y,n.y),l=It(r.z,n.z);e.isEmitterTransformNode?x.TransformNormalFromFloatsToRef(a,o,l,e.emitterWorldMatrix,i.direction):i.direction.copyFromFloats(a,o,l),i._initialDirection=i.direction.clone()},t._positionCreation.process=i=>{e.systemContext=t,e.isEmitterTransformNode?x.TransformCoordinatesFromFloatsToRef(0,0,0,e.emitterWorldMatrix,i.position):i.position.copyFrom(e.emitterPosition)},this.output._storedValue=t}}y("BABYLON.PointShapeBlock",bH);class CH extends Ze{constructor(e){super(e),this.registerInput("particle",L.Particle),this.registerInput("radius",L.Float,!0,1),this.registerInput("radiusRange",L.Float,!0,1,0,1),this.registerInput("directionRandomizer",L.Float,!0,0,0,1),this.registerOutput("output",L.Particle)}getClassName(){return"SphereShapeBlock"}get particle(){return this._inputs[0]}get radius(){return this._inputs[1]}get radiusRange(){return this._inputs[2]}get directionRandomizer(){return this._inputs[3]}get output(){return this._outputs[0]}_build(e){const t=this.particle.getConnectedValue(e);t._directionCreation.process=i=>{e.particleContext=i,e.systemContext=t;const r=this.directionRandomizer.getConnectedValue(e),n=i.position.subtract(e.emitterPosition).normalize(),a=It(0,r),o=It(0,r),l=It(0,r);n.x+=a,n.y+=o,n.z+=l,n.normalize(),e.isEmitterTransformNode?x.TransformNormalFromFloatsToRef(a,o,l,e.emitterWorldMatrix,i.direction):i.direction.copyFromFloats(a,o,l),i._initialDirection=i.direction.clone()},t._positionCreation.process=i=>{e.particleContext=i,e.systemContext=t;const r=this.radius.getConnectedValue(e),n=this.radiusRange.getConnectedValue(e),a=r-It(0,r*n),o=It(0,1),l=It(0,2*Math.PI),c=Math.acos(2*o-1),u=a*Math.cos(l)*Math.sin(c),h=a*Math.cos(c),d=a*Math.sin(l)*Math.sin(c);e.isEmitterTransformNode?x.TransformCoordinatesFromFloatsToRef(u,h,d,e.emitterWorldMatrix,i.position):(i.position.copyFromFloats(u,h,d),i.position.addInPlace(e.emitterPosition))},this.output._storedValue=t}}y("BABYLON.SphereShapeBlock",CH);class yH extends Ze{constructor(e){super(e),this._tempVector=x.Zero(),this.registerInput("particle",L.Particle),this.registerInput("radius",L.Float,!0,1),this.registerInput("height",L.Float,!0,1,0),this.registerInput("radiusRange",L.Float,!0,1,0,1),this.registerInput("directionRandomizer",L.Float,!0,0,0,1),this.registerOutput("output",L.Particle)}getClassName(){return"CylinderShapeBlock"}get particle(){return this._inputs[0]}get radius(){return this._inputs[1]}get height(){return this._inputs[2]}get radiusRange(){return this._inputs[3]}get directionRandomizer(){return this._inputs[4]}get output(){return this._outputs[0]}_build(e){const t=this.particle.getConnectedValue(e);t._directionCreation.process=i=>{e.particleContext=i,e.systemContext=t;const r=this.directionRandomizer.getConnectedValue(e);i.position.subtractToRef(e.emitterPosition,this._tempVector),this._tempVector.normalize(),e.isEmitterTransformNode&&x.TransformNormalToRef(this._tempVector,e.emitterInverseWorldMatrix,this._tempVector);const n=It(-r/2,r/2);let a=Math.atan2(this._tempVector.x,this._tempVector.z);a+=It(-Math.PI/2,Math.PI/2)*r,this._tempVector.y=n,this._tempVector.x=Math.sin(a),this._tempVector.z=Math.cos(a),this._tempVector.normalize(),e.isEmitterTransformNode?x.TransformNormalFromFloatsToRef(this._tempVector.x,this._tempVector.y,this._tempVector.z,e.emitterWorldMatrix,i.direction):i.direction.copyFrom(this._tempVector),i._initialDirection=i.direction.clone()},t._positionCreation.process=i=>{e.particleContext=i,e.systemContext=t;const r=this.height.getConnectedValue(e),n=this.radiusRange.getConnectedValue(e),a=this.radius.getConnectedValue(e),o=It(-r/2,r/2),l=It(0,2*Math.PI),c=It((1-n)*(1-n),1),u=Math.sqrt(c)*a,h=u*Math.cos(l),d=u*Math.sin(l);e.isEmitterTransformNode?x.TransformCoordinatesFromFloatsToRef(h,o,d,e.emitterWorldMatrix,i.position):(i.position.copyFromFloats(h,o,d),i.position.addInPlace(e.emitterPosition))},this.output._storedValue=t}}y("BABYLON.CylinderShapeBlock",yH);class fc extends Ze{get mesh(){return this._mesh}set mesh(e){this._mesh=e}constructor(e){super(e),this._cachedVertexData=null,this._indices=null,this._positions=null,this._normals=null,this._colors=null,this._storedNormal=x.Zero(),this.serializedCachedData=!1,this.useMeshNormalsForDirection=!1,this.useMeshColorForColor=!1,this.worldSpace=!1,this.registerInput("particle",L.Particle),this.registerInput("direction1",L.Vector3,!0,new x(0,1,0)),this.registerInput("direction2",L.Vector3,!0,new x(0,1,0)),this.registerOutput("output",L.Particle)}getClassName(){return"MeshShapeBlock"}get isUsingCachedData(){return!this.mesh&&!!this._cachedVertexData}get particle(){return this._inputs[0]}get direction1(){return this._inputs[1]}get direction2(){return this._inputs[2]}get output(){return this._outputs[0]}cleanData(){this._mesh=null,this._cachedVertexData=null}_build(e){const t=this.particle.getConnectedValue(e);if(!this._mesh&&!this._cachedVertexData){this.output._storedValue=t;return}if(this._mesh&&(this._cachedVertexData=li.ExtractFromMesh(this._mesh,!1,!0)),!this._cachedVertexData){this.output._storedValue=t;return}this._indices=this._cachedVertexData.indices,this._positions=this._cachedVertexData.positions,this._normals=this._cachedVertexData.normals,this._colors=this._cachedVertexData.colors,this.useMeshColorForColor&&this._colors&&(t._colorCreation.process=()=>{}),t._directionCreation.process=i=>{if(e.particleContext=i,e.systemContext=t,this.useMeshNormalsForDirection&&this._normals){e.isEmitterTransformNode?x.TransformNormalToRef(this._storedNormal,e.emitterWorldMatrix,i.direction):i.direction.copyFrom(this._storedNormal);return}const r=this.direction1.getConnectedValue(e),n=this.direction2.getConnectedValue(e),a=It(r.x,n.x),o=It(r.y,n.y),l=It(r.z,n.z);e.isEmitterTransformNode?x.TransformNormalFromFloatsToRef(a,o,l,e.emitterWorldMatrix,i.direction):i.direction.copyFromFloats(a,o,l),i._initialDirection=i.direction.clone()},t._positionCreation.process=i=>{if(!this._indices||!this._positions)return;const r=3*(Math.random()*(this._indices.length/3)|0),n=Math.random(),a=Math.random()*(1-n),o=1-n-a,l=this._indices[r],c=this._indices[r+1],u=this._indices[r+2],h=G.Vector3[0],d=G.Vector3[1],f=G.Vector3[2],m=G.Vector3[3];x.FromArrayToRef(this._positions,l*3,h),x.FromArrayToRef(this._positions,c*3,d),x.FromArrayToRef(this._positions,u*3,f),m.x=n*h.x+a*d.x+o*f.x,m.y=n*h.y+a*d.y+o*f.y,m.z=n*h.z+a*d.z+o*f.z,this.worldSpace&&this.mesh&&x.TransformCoordinatesFromFloatsToRef(m.x,m.y,m.z,this.mesh.getWorldMatrix(),m),e.isEmitterTransformNode?x.TransformCoordinatesFromFloatsToRef(m.x,m.y,m.z,e.emitterWorldMatrix,i.position):i.position.copyFromFloats(m.x,m.y,m.z),this.useMeshNormalsForDirection&&this._normals&&(x.FromArrayToRef(this._normals,l*3,h),x.FromArrayToRef(this._normals,c*3,d),x.FromArrayToRef(this._normals,u*3,f),this._storedNormal.x=n*h.x+a*d.x+o*f.x,this._storedNormal.y=n*h.y+a*d.y+o*f.y,this._storedNormal.z=n*h.z+a*d.z+o*f.z),this.useMeshColorForColor&&this._colors&&(Ee.FromArrayToRef(this._colors,l*4,G.Vector4[0]),Ee.FromArrayToRef(this._colors,c*4,G.Vector4[1]),Ee.FromArrayToRef(this._colors,u*4,G.Vector4[2]),i.color.copyFromFloats(n*G.Vector4[0].x+a*G.Vector4[1].x+o*G.Vector4[2].x,n*G.Vector4[0].y+a*G.Vector4[1].y+o*G.Vector4[2].y,n*G.Vector4[0].z+a*G.Vector4[1].z+o*G.Vector4[2].z,n*G.Vector4[0].w+a*G.Vector4[1].w+o*G.Vector4[2].w))},this.output._storedValue=t}serialize(){const e=super.serialize();return e.serializedCachedData=this.serializedCachedData,this.serializedCachedData&&(this._mesh?e.cachedVertexData=li.ExtractFromMesh(this._mesh,!1,!0).serialize():this._cachedVertexData&&(e.cachedVertexData=this._cachedVertexData.serialize())),e.useMeshNormalsForDirection=this.useMeshNormalsForDirection,e.useMeshColorForColor=this.useMeshColorForColor,e.worldSpace=this.worldSpace,e}_deserialize(e){super._deserialize(e),e.cachedVertexData&&(this._cachedVertexData=li.Parse(e.cachedVertexData)),this.serializedCachedData=!!e.serializedCachedData,this.useMeshNormalsForDirection=!!e.useMeshNormalsForDirection,this.useMeshColorForColor=!!e.useMeshColorForColor,this.worldSpace=!!e.worldSpace}}_([O("Serialize cached data",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],fc.prototype,"serializedCachedData",void 0);_([O("Use normals for direction",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],fc.prototype,"useMeshNormalsForDirection",void 0);_([O("Use vertex color for color",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],fc.prototype,"useMeshColorForColor",void 0);_([O("World space",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],fc.prototype,"worldSpace",void 0);y("BABYLON.MeshShapeBlock",fc);class IH extends Ze{constructor(e){super(e),this.registerInput("particle",L.Particle),this.registerOutput("output",L.Particle)}get particle(){return this._inputs[0]}get output(){return this._outputs[0]}getClassName(){return"BasicPositionUpdateBlock"}_build(e){const t=this.particle.getConnectedValue(e),r={process:n=>{e.particleContext=n,e.systemContext=t,n.direction.scaleToRef(t._directionScale,t._scaledDirection),n.position.addInPlace(t._scaledDirection)},previousItem:null,nextItem:null};t._updateQueueStart?Tr(r,t._updateQueueStart):t._updateQueueStart=r,this.output._storedValue=t}}y("BABYLON.BasicPositionUpdateBlock",IH);class RH extends Ze{constructor(e){super(e),this.registerInput("particle",L.Particle),this.registerOutput("output",L.Particle)}get particle(){return this._inputs[0]}get output(){return this._outputs[0]}getClassName(){return"BasicColorUpdateBlock"}_build(e){const t=this.particle.getConnectedValue(e),r={process:n=>{e.particleContext=n,e.systemContext=t,n.colorStep.scaleToRef(t._scaledUpdateSpeed,t._scaledColorStep),n.color.addInPlace(t._scaledColorStep),n.color.a<0&&(n.color.a=0)},previousItem:null,nextItem:null};t._updateQueueStart?Tr(r,t._updateQueueStart):t._updateQueueStart=r,this.output._storedValue=t}}y("BABYLON.BasicColorUpdateBlock",RH);var cn;(function(s){s[s.None=0]="None",s[s.PerParticle=1]="PerParticle",s[s.PerSystem=2]="PerSystem"})(cn||(cn={}));class Z0 extends Ze{constructor(e){super(e),this._currentLockId=-2,this.lockMode=cn.PerParticle,this.registerInput("min",L.AutoDetect,!0,0),this.registerInput("max",L.AutoDetect,!0,1),this.registerOutput("output",L.BasedOnInput),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(L.Float|L.Int|L.Vector2|L.Vector3|L.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(L.Float|L.Int|L.Vector2|L.Vector3|L.Color4),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[0]._defaultConnectionPointType=L.Float,this._linkConnectionTypes(0,1)}getClassName(){return"ParticleRandomBlock"}get min(){return this._inputs[0]}get max(){return this._inputs[1]}get output(){return this._outputs[0]}_build(){let e=null;switch(this._currentLockId=-2,this.min.type){case L.AutoDetect:case L.Int:case L.Float:{e=t=>{const i=this.min.getConnectedValue(t)||0,r=this.max.getConnectedValue(t)||1;return i+Math.random()*(r-i)};break}case L.Vector2:{e=t=>{const i=this.min.getConnectedValue(t)||X.Zero(),r=this.max.getConnectedValue(t)||X.One();return new X(i.x+Math.random()*(r.x-i.x),i.y+Math.random()*(r.y-i.y))};break}case L.Vector3:{e=t=>{const i=this.min.getConnectedValue(t)||x.Zero(),r=this.max.getConnectedValue(t)||x.One();return new x(i.x+Math.random()*(r.x-i.x),i.y+Math.random()*(r.y-i.y),i.z+Math.random()*(r.z-i.z))};break}case L.Color4:{e=t=>{const i=this.min.getConnectedValue(t)||new Te(0,0,0,0),r=this.max.getConnectedValue(t)||new Te(1,1,1,1);return new Te(i.r+Math.random()*(r.r-i.r),i.g+Math.random()*(r.g-i.g),i.b+Math.random()*(r.b-i.b),i.a+Math.random()*(r.a-i.a))};break}}this.output._storedFunction=t=>{var r;let i=0;switch(this.lockMode){case cn.PerParticle:i=((r=t.particleContext)==null?void 0:r.id)||-1;break;case cn.PerSystem:i=t.buildId||0;break}return this._currentLockId!==i&&(this.lockMode!==cn.None&&(this._currentLockId=i),this.output._storedValue=e(t)),this.output._storedValue}}serialize(){const e=super.serialize();return e.lockMode=this.lockMode,e}_deserialize(e){super._deserialize(e),this.lockMode=e.lockMode}}_([O("LockMode",5,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"None",value:cn.None},{label:"Per particle",value:cn.PerParticle},{label:"Per system",value:cn.PerSystem}]})],Z0.prototype,"lockMode",void 0);y("BABYLON.ParticleRandomBlock",Z0);class AH extends Ze{constructor(e){super(e),this.registerInput("left",L.AutoDetect),this.registerInput("right",L.AutoDetect),this.registerInput("gradient",L.Float,!0,0,0,1),this.registerOutput("output",L.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(L.Float|L.Int|L.Vector2|L.Vector3|L.Color4)}getClassName(){return"ParticleLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_build(){if(!this.left.isConnected||!this.right.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}const e=(t,i,r)=>(1-t)*i+t*r;this.output._storedFunction=t=>{const i=this.left.getConnectedValue(t),r=this.right.getConnectedValue(t),n=this.gradient.getConnectedValue(t);switch(this.left.type){case L.Int:case L.Float:return e(n,i,r);case L.Vector2:return new X(e(n,i.x,r.x),e(n,i.y,r.y));case L.Vector3:return new x(e(n,i.x,r.x),e(n,i.y,r.y),e(n,i.z,r.z));case L.Color4:return new Te(e(n,i.r,r.r),e(n,i.g,r.g),e(n,i.b,r.b),e(n,i.a,r.a))}return 0}}}y("BABYLON.ParticleLerpBlock",AH);class PH extends Ze{constructor(e){super(e),this.registerInput("particle",L.Particle),this.registerInput("direction",L.Vector3),this.registerOutput("output",L.Particle)}get particle(){return this._inputs[0]}get direction(){return this._inputs[1]}get output(){return this._outputs[0]}getClassName(){return"UpdateDirectionBlock"}_build(e){const t=this.particle.getConnectedValue(e);if(this.output._storedValue=t,!this.direction.isConnected)return;const r={process:n=>{e.particleContext=n,e.systemContext=t,n.direction.copyFrom(this.direction.getConnectedValue(e))},previousItem:null,nextItem:null};t._updateQueueStart?Tr(r,t._updateQueueStart):t._updateQueueStart=r}}y("BABYLON.UpdateDirectionBlock",PH);class OH extends Ze{constructor(e){super(e),this.registerInput("particle",L.Particle),this.registerInput("color",L.Color4),this.registerOutput("output",L.Particle)}get particle(){return this._inputs[0]}get color(){return this._inputs[1]}get output(){return this._outputs[0]}getClassName(){return"UpdateColorBlock"}_build(e){const t=this.particle.getConnectedValue(e);if(this.output._storedValue=t,!this.color.isConnected)return;const r={process:n=>{e.particleContext=n,e.systemContext=t,n.color.copyFrom(this.color.getConnectedValue(e))},previousItem:null,nextItem:null};t._updateQueueStart?Tr(r,t._updateQueueStart):t._updateQueueStart=r}}y("BABYLON.UpdateColorBlock",OH);class NH extends Ze{constructor(e){super(e),this.registerInput("particle",L.Particle),this.registerInput("scale",L.Vector2),this.registerOutput("output",L.Particle)}get particle(){return this._inputs[0]}get scale(){return this._inputs[1]}get output(){return this._outputs[0]}getClassName(){return"UpdateScaleBlock"}_build(e){const t=this.particle.getConnectedValue(e);if(this.output._storedValue=t,!this.scale.isConnected)return;const r={process:n=>{e.particleContext=n,e.systemContext=t,n.scale.copyFrom(this.scale.getConnectedValue(e))},previousItem:null,nextItem:null};t._updateQueueStart?Tr(r,t._updateQueueStart):t._updateQueueStart=r}}y("BABYLON.UpdateScaleBlock",NH);class DH extends Ze{constructor(e){super(e),this.registerInput("particle",L.Particle),this.registerInput("angle",L.Float),this.registerOutput("output",L.Particle)}get particle(){return this._inputs[0]}get angle(){return this._inputs[1]}get output(){return this._outputs[0]}getClassName(){return"UpdateAngleBlock"}_build(e){const t=this.particle.getConnectedValue(e);if(this.output._storedValue=t,!this.angle.isConnected)return;const r={process:n=>{e.particleContext=n,e.systemContext=t,n.angle=this.angle.getConnectedValue(e)},previousItem:null,nextItem:null};t._updateQueueStart?Tr(r,t._updateQueueStart):t._updateQueueStart=r}}y("BABYLON.UpdateAngleBlock",DH);class MH extends Ze{constructor(e){super(e),this.registerInput("particle",L.Particle),this.registerInput("age",L.Float),this.registerOutput("output",L.Particle)}get particle(){return this._inputs[0]}get age(){return this._inputs[1]}get output(){return this._outputs[0]}getClassName(){return"UpdateAgeBlock"}_build(e){const t=this.particle.getConnectedValue(e);if(this.output._storedValue=t,!this.age.isConnected)return;const r={process:n=>{e.particleContext=n,e.systemContext=t,n.age=this.age.getConnectedValue(e)},previousItem:null,nextItem:null};t._updateQueueStart?Tr(r,t._updateQueueStart):t._updateQueueStart=r}}y("BABYLON.UpdateAgeBlock",MH);class FH extends Ze{constructor(e){super(e),this.registerInput("particle",L.Particle),this.registerOutput("output",L.Particle)}get particle(){return this._inputs[0]}get output(){return this._outputs[0]}getClassName(){return"BasicSpriteUpdateBlock"}_build(e){const t=this.particle.getConnectedValue(e),r={process:n=>{e.particleContext=n,e.systemContext=t,n.updateCellIndex()},previousItem:null,nextItem:null};t._updateQueueStart?Tr(r,t._updateQueueStart):t._updateQueueStart=r,this.output._storedValue=t}}y("BABYLON.BasicSpriteUpdateBlock",FH);class LH extends Ze{constructor(e){super(e),this.registerInput("particle",L.Particle),this.registerInput("cellIndex",L.Int),this.registerOutput("output",L.Particle),this.cellIndex.acceptedConnectionPointTypes=[L.Float]}get particle(){return this._inputs[0]}get cellIndex(){return this._inputs[1]}get output(){return this._outputs[0]}getClassName(){return"UpdateSpriteCellIndexBlock"}_build(e){const t=this.particle.getConnectedValue(e);if(this.output._storedValue=t,!this.cellIndex.isConnected)return;const r={process:n=>{e.particleContext=n,e.systemContext=t,n.cellIndex=Math.floor(this.cellIndex.getConnectedValue(e))},previousItem:null,nextItem:null};t._updateQueueStart?Tr(r,t._updateQueueStart):t._updateQueueStart=r}}y("BABYLON.UpdateSpriteCellIndexBlock",LH);class Q0 extends Ze{constructor(e){super(e),this.strength=1,this.registerInput("particle",L.Particle),this.registerInput("flowMap",L.Texture),this.registerOutput("output",L.Particle)}get particle(){return this._inputs[0]}get flowMap(){return this._inputs[1]}get output(){return this._outputs[0]}getClassName(){return"UpdateFlowMapBlock"}_build(e){var l;const t=this.particle.getConnectedValue(e),i=e.scene,r=(l=this.flowMap.connectedPoint)==null?void 0:l.ownerBlock;let n;r.extractTextureContentAsync().then(c=>{c&&(n=new du(c.width,c.height,c.data))});const o={process:c=>{const u=i.getTransformMatrix();n&&n._processParticle(c,this.strength*t._tempScaledUpdateSpeed,u)},previousItem:null,nextItem:null};t._updateQueueStart?Tr(o,t._updateQueueStart):t._updateQueueStart=o,this.output._storedValue=t}serialize(){const e=super.serialize();return e.strength=this.strength,e}_deserialize(e){super._deserialize(e),this.strength=e.strength}}_([O("strength",1,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},min:0})],Q0.prototype,"strength",void 0);y("BABYLON.UpdateFlowMapBlock",Q0);const nd=x.Zero(),Rb=x.Zero(),Ab=x.Zero();class wH extends Ze{constructor(e){super(e),this.registerInput("particle",L.Particle),this.registerInput("attractor",L.Vector3,!0,x.Zero()),this.registerInput("strength",L.Float,!0,1),this.registerOutput("output",L.Particle)}get particle(){return this._inputs[0]}get attractor(){return this._inputs[1]}get strength(){return this._inputs[2]}get output(){return this._outputs[0]}getClassName(){return"UpdateAttractorBlock"}_build(e){const t=this.particle.getConnectedValue(e),r={process:n=>{const a=this.attractor.getConnectedValue(e),o=this.strength.getConnectedValue(e);a.subtractToRef(n.position,nd);const l=nd.lengthSquared()+1;nd.normalize().scaleToRef(o/l,Rb),Rb.scaleToRef(t._tempScaledUpdateSpeed,Ab),n.direction.addInPlace(Ab)},previousItem:null,nextItem:null};t._updateQueueStart?Tr(r,t._updateQueueStart):t._updateQueueStart=r,this.output._storedValue=t}}y("BABYLON.UpdateAttractorBlock",wH);class K0 extends Ze{constructor(e){super(e),this.alignment=Math.PI/2,this.registerInput("particle",L.Particle),this.registerOutput("output",L.Particle)}get particle(){return this._inputs[0]}get output(){return this._outputs[0]}getClassName(){return"AlignAngleBlock"}_build(e){const t=this.particle.getConnectedValue(e);this.output._storedValue=t;const i=new x,n={process:a=>{const o=e.scene.activeCamera;if(!o)return;const l=a.direction,c=o.getViewMatrix(),u=x.TransformNormalToRef(l,c,i),h=Math.atan2(u.y,u.x)+this.alignment;a.angle=h},previousItem:null,nextItem:null};t._updateQueueStart?Tr(n,t._updateQueueStart):t._updateQueueStart=n}serialize(){const e=super.serialize();return e.alignment=this.alignment,e}_deserialize(e){super._deserialize(e),e.alignment!==void 0&&(this.alignment=e.alignment)}}_([O("alignment",1,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},min:-0,max:2*Math.PI})],K0.prototype,"alignment",void 0);y("BABYLON.AlignAngleBlock",K0);class BH extends Ze{constructor(e){super(e),this.registerInput("particle",L.Particle),this.registerInput("position",L.Vector3,!0,new x(0,0,0)),this.registerInput("direction",L.Vector3,!0,new x(0,1,0)),this.registerOutput("output",L.Particle)}getClassName(){return"CustomShapeBlock"}get particle(){return this._inputs[0]}get position(){return this._inputs[1]}get direction(){return this._inputs[2]}get output(){return this._outputs[0]}_build(e){const t=this.particle.getConnectedValue(e);t._directionCreation.process=i=>{e.particleContext=i,e.systemContext=t;const r=this.direction.getConnectedValue(e);e.isEmitterTransformNode?x.TransformNormalToRef(r,e.emitterWorldMatrix,i.direction):i.direction.copyFrom(r),i._initialDirection=i.direction.clone()},t._positionCreation.process=i=>{e.particleContext=i,e.systemContext=t;const r=this.position.getConnectedValue(e);e.isEmitterTransformNode?x.TransformCoordinatesToRef(r,e.emitterWorldMatrix,i.position):(i.position.copyFrom(r),i.position.addInPlace(e.emitterPosition))},this.output._storedValue=t}}y("BABYLON.CustomShapeBlock",BH);class Ga extends Ze{constructor(e){super(e),this.start=0,this.end=8,this.width=64,this.height=64,this.loop=!1,this.randomStartCell=!1,this.registerInput("particle",L.Particle),this.registerOutput("output",L.Particle),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"SetupSpriteSheetBlock"}get particle(){return this._inputs[0]}get output(){return this._outputs[0]}_build(e){super._build(e);const t=this.particle.getConnectedValue(e);t._isAnimationSheetEnabled=!0,t.spriteCellWidth=this.width,t.spriteCellHeight=this.height,t.startSpriteCellID=this.start,t.endSpriteCellID=this.end,t.spriteRandomStartCell=this.randomStartCell,this.output._storedValue=t}serialize(){const e=super.serialize();return e.width=this.width,e.height=this.height,e.start=this.start,e.end=this.end,e.randomStartCell=this.randomStartCell,e}_deserialize(e){super._deserialize(e),this.width=e.width,this.height=e.height,this.start=e.start,this.end=e.end,this.randomStartCell=e.randomStartCell}}_([O("Start",2,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},min:0})],Ga.prototype,"start",void 0);_([O("End",2,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},min:0})],Ga.prototype,"end",void 0);_([O("Width",1,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},min:0})],Ga.prototype,"width",void 0);_([O("Height",1,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},min:0})],Ga.prototype,"height",void 0);_([O("Loop",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Ga.prototype,"loop",void 0);_([O("Random start cell",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Ga.prototype,"randomStartCell",void 0);y("BABYLON.SetupSpriteSheetBlock",Ga);class J0 extends Ze{constructor(e){super(e),this.reference=0,this.registerInput("value",L.AutoDetect),this.registerOutput("output",L.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[0]._typeConnectionSourceTranslation=t=>{switch(t){case L.Float:return L.FloatGradient;case L.Vector2:return L.Vector2Gradient;case L.Vector3:return L.Vector3Gradient;case L.Color4:return L.Color4Gradient}return t},this._inputs[0].addExcludedConnectionPointFromAllowedTypes(L.Float|L.Vector2|L.Vector3|L.Color4)}getClassName(){return"ParticleGradientValueBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_build(){this.output._storedFunction=e=>null}serialize(){const e=super.serialize();return e.reference=this.reference,e}_deserialize(e){super._deserialize(e),this.reference=e.reference}}_([O("Reference",1,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},min:0,max:1})],J0.prototype,"reference",void 0);y("BABYLON.ParticleGradientValueBlock",J0);class VH extends Ze{constructor(e){super(e),this._entryCount=1,this.registerInput("gradient",L.Float,!0,1,0,1),this.registerInput("value0",L.AutoDetect),this.registerOutput("output",L.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[1],this._outputs[0]._typeConnectionSourceTranslation=t=>{switch(t){case L.FloatGradient:return L.Float;case L.Vector2Gradient:return L.Vector2;case L.Vector3Gradient:return L.Vector3;case L.Color4Gradient:return L.Color4}return t},this._inputs[1].addExcludedConnectionPointFromAllowedTypes(L.FloatGradient|L.Vector2Gradient|L.Vector3Gradient|L.Color4Gradient),this._manageExtendedInputs(1)}_extend(){this._entryCount++,this.registerInput("value"+(this._entryCount-1),L.AutoDetect,!0),this._linkConnectionTypes(1,this._entryCount),this._manageExtendedInputs(this._entryCount)}_manageExtendedInputs(e){this._inputs[e].onConnectionObservable.add(()=>{this._entryCount>e||this._extend()})}getClassName(){return"ParticleGradientBlock"}get gradient(){return this._inputs[0]}get output(){return this._outputs[0]}_build(){var t;const e=[];for(let i=1;i<this._inputs.length;i++)this._inputs[i].isConnected&&e.push((t=this._inputs[i].connectedPoint)==null?void 0:t.ownerBlock);e.sort((i,r)=>i.reference-r.reference),this.output._storedFunction=i=>{const r=this.gradient.getConnectedValue(i);if(e.length===1)return e[0].value.getConnectedValue(i);let n=null;for(let a=e.length-1;a>=0;a--){const o=e[a];if(o.reference<=r){const l=o.value.getConnectedValue(i);if(n){const c=n.value.getConnectedValue(i),u=n.reference,h=o.reference,d=Math.max(0,Math.min(1,(r-h)/(u-h)));switch(this.output.type){case L.Float:return Vc(l,c,d);case L.Vector2:return X.Lerp(l,c,d);case L.Vector3:return x.Lerp(l,c,d);case L.Color4:return Te.Lerp(l,c,d)}}return l}n=o}return 0}}serialize(){const e=super.serialize();return e._entryCount=this._entryCount,e}_deserialize(e){if(super._deserialize(e),e._entryCount&&e._entryCount>1)for(let t=1;t<e._entryCount;t++)this._extend()}}y("BABYLON.ParticleGradientBlock",VH);class UH extends Ze{constructor(e){super(e),this.registerInput("color ",L.Color4,!0),this.registerInput("xyz ",L.Vector3,!0),this.registerInput("xy ",L.Vector2,!0),this.registerInput("zw ",L.Vector2,!0),this.registerInput("x ",L.Float,!0),this.registerInput("y ",L.Float,!0),this.registerInput("z ",L.Float,!0),this.registerInput("w ",L.Float,!0),this.registerOutput("color",L.Color4),this.registerOutput("xyz",L.Vector3),this.registerOutput("xy",L.Vector2),this.registerOutput("zw",L.Vector2),this.registerOutput("x",L.Float),this.registerOutput("y",L.Float),this.registerOutput("z",L.Float),this.registerOutput("w",L.Float)}getClassName(){return"ParticleConverterBlock"}get colorIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get xIn(){return this._inputs[4]}get yIn(){return this._inputs[5]}get zIn(){return this._inputs[6]}get wIn(){return this._inputs[7]}get colorOut(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xOut(){return this._outputs[4]}get yOut(){return this._outputs[5]}get zOut(){return this._outputs[6]}get wOut(){return this._outputs[7]}_inputRename(e){return e==="color "?"colorIn":e==="xyz "?"xyzIn":e==="xy "?"xyIn":e==="zw "?"zwIn":e==="x "?"xIn":e==="y "?"yIn":e==="z "?"zIn":e==="w "?"wIn":e}_outputRename(e){switch(e){case"x":return"xOut";case"y":return"yOut";case"z":return"zOut";case"w":return"wOut";case"xy":return"xyOut";case"zw":return"zwOut";case"xyz":return"xyzOut";case"color":return"colorOut";default:return e}}_build(e){super._build(e);const t=this.xIn,i=this.yIn,r=this.zIn,n=this.wIn,a=this.xyIn,o=this.zwIn,l=this.xyzIn,c=this.colorIn,u=this.colorOut,h=this.xyzOut,d=this.xyOut,f=this.zwOut,m=this.xOut,g=this.yOut,v=this.zOut,E=this.wOut,T=C=>{if(c.isConnected)return c.getConnectedValue(C);let A=0,I=0,F=0,V=0;if(t.isConnected&&(A=t.getConnectedValue(C)),i.isConnected&&(I=i.getConnectedValue(C)),r.isConnected&&(F=r.getConnectedValue(C)),n.isConnected&&(V=n.getConnectedValue(C)),a.isConnected){const D=a.getConnectedValue(C);D&&(A=D.x,I=D.y)}if(o.isConnected){const D=o.getConnectedValue(C);D&&(F=D.x,V=D.y)}if(l.isConnected){const D=l.getConnectedValue(C);D&&(A=D.x,I=D.y,F=D.z)}return new Te(A,I,F,V)};u._storedFunction=C=>T(C),h._storedFunction=C=>{const A=T(C);return new x(A.r,A.g,A.b)},d._storedFunction=C=>{const A=T(C);return new X(A.r,A.g)},f._storedFunction=C=>{const A=T(C);return new X(A.b,A.a)},m._storedFunction=C=>T(C).r,g._storedFunction=C=>T(C).g,v._storedFunction=C=>T(C).b,E._storedFunction=C=>T(C).a}}y("BABYLON.ParticleConverterBlock",UH);var Ge;(function(s){s[s.Cos=0]="Cos",s[s.Sin=1]="Sin",s[s.Abs=2]="Abs",s[s.Exp=3]="Exp",s[s.Exp2=4]="Exp2",s[s.Round=5]="Round",s[s.Floor=6]="Floor",s[s.Ceiling=7]="Ceiling",s[s.Sqrt=8]="Sqrt",s[s.Log=9]="Log",s[s.Tan=10]="Tan",s[s.ArcTan=11]="ArcTan",s[s.ArcCos=12]="ArcCos",s[s.ArcSin=13]="ArcSin",s[s.Sign=14]="Sign",s[s.Negate=15]="Negate",s[s.OneMinus=16]="OneMinus",s[s.Reciprocal=17]="Reciprocal",s[s.ToDegrees=18]="ToDegrees",s[s.ToRadians=19]="ToRadians",s[s.Fract=20]="Fract"})(Ge||(Ge={}));class eP extends Ze{constructor(e){super(e),this.operation=Ge.Cos,this.registerInput("input",L.AutoDetect),this.registerOutput("output",L.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].addExcludedConnectionPointFromAllowedTypes(L.Float|L.Int|L.Vector2|L.Vector3|L.Color4)}getClassName(){return"ParticleTrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_build(e){super._build(e);let t=null;switch(this.operation){case Ge.Cos:{t=i=>Math.cos(i);break}case Ge.Sin:{t=i=>Math.sin(i);break}case Ge.Abs:{t=i=>Math.abs(i);break}case Ge.Exp:{t=i=>Math.exp(i);break}case Ge.Exp2:{t=i=>Math.pow(2,i);break}case Ge.Round:{t=i=>Math.round(i);break}case Ge.Floor:{t=i=>Math.floor(i);break}case Ge.Ceiling:{t=i=>Math.ceil(i);break}case Ge.Sqrt:{t=i=>Math.sqrt(i);break}case Ge.Log:{t=i=>Math.log(i);break}case Ge.Tan:{t=i=>Math.tan(i);break}case Ge.ArcTan:{t=i=>Math.atan(i);break}case Ge.ArcCos:{t=i=>Math.acos(i);break}case Ge.ArcSin:{t=i=>Math.asin(i);break}case Ge.Sign:{t=i=>Math.sign(i);break}case Ge.Negate:{t=i=>-i;break}case Ge.OneMinus:{t=i=>1-i;break}case Ge.Reciprocal:{t=i=>1/i;break}case Ge.ToRadians:{t=i=>i*Math.PI/180;break}case Ge.ToDegrees:{t=i=>i*180/Math.PI;break}case Ge.Fract:{t=i=>i>=0?i-Math.floor(i):i-Math.ceil(i);break}}if(!t){this.output._storedFunction=null,this.output._storedValue=null;return}switch(this.input.type){case L.Int:case L.Float:{this.output._storedFunction=i=>{const r=this.input.getConnectedValue(i);return t(r)};break}case L.Vector2:{this.output._storedFunction=i=>{const r=this.input.getConnectedValue(i);return new X(t(r.x),t(r.y))};break}case L.Vector3:{this.output._storedFunction=i=>{const r=this.input.getConnectedValue(i);return new x(t(r.x),t(r.y),t(r.z))};break}case L.Color4:{this.output._storedFunction=i=>{const r=this.input.getConnectedValue(i);return new Te(t(r.r),t(r.g),t(r.b),t(r.a))};break}}return this}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e){super._deserialize(e),this.operation=e.operation}}_([O("Operation",5,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},options:[{label:"Cos",value:Ge.Cos},{label:"Sin",value:Ge.Sin},{label:"Abs",value:Ge.Abs},{label:"Exp",value:Ge.Exp},{label:"Exp2",value:Ge.Exp2},{label:"Round",value:Ge.Round},{label:"Floor",value:Ge.Floor},{label:"Ceiling",value:Ge.Ceiling},{label:"Sqrt",value:Ge.Sqrt},{label:"Log",value:Ge.Log},{label:"Tan",value:Ge.Tan},{label:"ArcTan",value:Ge.ArcTan},{label:"ArcCos",value:Ge.ArcCos},{label:"ArcSin",value:Ge.ArcSin},{label:"Sign",value:Ge.Sign},{label:"Negate",value:Ge.Negate},{label:"OneMinus",value:Ge.OneMinus},{label:"Reciprocal",value:Ge.Reciprocal},{label:"ToDegrees",value:Ge.ToDegrees},{label:"ToRadians",value:Ge.ToRadians},{label:"Fract",value:Ge.Fract}]})],eP.prototype,"operation",void 0);y("BABYLON.ParticleTrigonometryBlock",eP);class tP extends Ze{constructor(e){super(e),this.log=[],this.stackSize=10,this.onDataCollectedObservable=new k(void 0,!0),this._isDebug=!0,this.registerInput("input",L.AutoDetect),this.registerOutput("output",L.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(L.FloatGradient),this._inputs[0].excludedConnectionPointTypes.push(L.Vector2Gradient),this._inputs[0].excludedConnectionPointTypes.push(L.Vector3Gradient),this._inputs[0].excludedConnectionPointTypes.push(L.Color4Gradient),this._inputs[0].excludedConnectionPointTypes.push(L.System),this._inputs[0].excludedConnectionPointTypes.push(L.Particle),this._inputs[0].excludedConnectionPointTypes.push(L.Texture)}getClassName(){return"ParticleDebugBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_build(e){if(!this.input.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}this.log=[];const t=i=>{const r=this.input.getConnectedValue(i);if(this.log.length>=this.stackSize)return r;if(r==null)return this.log.push(["null",""]),r;switch(this.input.type){case L.Vector2:this.log.push([SR(r,4),r.toString()]);break;case L.Vector3:this.log.push([vR(r,4),r.toString()]);break;case L.Color4:this.log.push([`{R: ${r.r.toFixed(4)} G: ${r.g.toFixed(4)} B: ${r.b.toFixed(4)} A: ${r.a.toFixed(4)}}`,r.toString()]);break;default:this.log.push([r.toString(),r.toString()]);break}return this.onDataCollectedObservable.notifyObservers(this),r};this.output.isConnected?this.output._storedFunction=t:this.output._storedValue=t(e)}serialize(){const e=super.serialize();return e.stackSize=this.stackSize,e}_deserialize(e){super._deserialize(e),this.stackSize=e.stackSize}dispose(){this.onDataCollectedObservable.clear(),super.dispose()}}_([O("Reference",2,"ADVANCED",{embedded:!1,notifiers:{rebuild:!0},min:1,max:100})],tP.prototype,"stackSize",void 0);y("BABYLON.ParticleDebugBlock",tP);class kH extends Ze{constructor(e){super(e),this.registerInput("input",L.AutoDetect),this.registerOutput("output",L.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ParticleElbowBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_build(e){super._build(e);const t=this._outputs[0],i=this._inputs[0];t._storedFunction=r=>i.getConnectedValue(r)}}y("BABYLON.ParticleElbowBlock",kH);class GH extends Ze{get endpoints(){return this._endpoints}constructor(e){super(e),this._endpoints=[],this._isTeleportIn=!0,this.registerInput("input",L.AutoDetect)}getClassName(){return"ParticleTeleportInBlock"}get input(){return this._inputs[0]}isAnAncestorOfType(e){if(this.getClassName()===e)return!0;for(const t of this.endpoints)if(t.isAnAncestorOfType(e))return!0;return!1}isAnAncestorOf(e){for(const t of this.endpoints)if(t===e||t.isAnAncestorOf(e))return!0;return!1}attachToEndpoint(e){e.detach(),this._endpoints.push(e),e._entryPoint=this,e._outputs[0]._typeConnectionSource=this._inputs[0],e._tempEntryPointUniqueId=null,e.name="> "+this.name}detachFromEndpoint(e){const t=this._endpoints.indexOf(e);t!==-1&&(this._endpoints.splice(t,1),e._outputs[0]._typeConnectionSource=null,e._entryPoint=null)}_build(){for(const e of this._endpoints)e.output._storedFunction=t=>this.input.getConnectedValue(t)}}y("BABYLON.ParticleTeleportInBlock",GH);class zH extends Ze{constructor(e){super(e),this._entryPoint=null,this._tempEntryPointUniqueId=null,this._isTeleportOut=!0,this.registerOutput("output",L.BasedOnInput)}get entryPoint(){return this._entryPoint}getClassName(){return"ParticleTeleportOutBlock"}get output(){return this._outputs[0]}detach(){this._entryPoint&&this._entryPoint.detachFromEndpoint(this)}_build(){}_customBuildStep(e){this.entryPoint&&this.entryPoint.build(e)}clone(){const e=super.clone();return this.entryPoint&&this.entryPoint.attachToEndpoint(e),e}serialize(){var t;const e=super.serialize();return e.entryPoint=((t=this.entryPoint)==null?void 0:t.uniqueId)??"",e}_deserialize(e){super._deserialize(e),this._tempEntryPointUniqueId=e.entryPoint}}y("BABYLON.ParticleTeleportOutBlock",zH);var _i;(function(s){s[s.Equal=0]="Equal",s[s.NotEqual=1]="NotEqual",s[s.LessThan=2]="LessThan",s[s.GreaterThan=3]="GreaterThan",s[s.LessOrEqual=4]="LessOrEqual",s[s.GreaterOrEqual=5]="GreaterOrEqual",s[s.Xor=6]="Xor",s[s.Or=7]="Or",s[s.And=8]="And"})(_i||(_i={}));class Z_ extends Ze{constructor(e){super(e),this.test=_i.Equal,this.epsilon=0,this.registerInput("left",L.Float),this.registerInput("right",L.Float,!0,0),this.registerInput("ifTrue",L.AutoDetect,!0,1),this.registerInput("ifFalse",L.AutoDetect,!0,0),this.registerOutput("output",L.BasedOnInput),this.output._typeConnectionSource=this._inputs[2],this.output._defaultConnectionPointType=L.Float,this._inputs[0].acceptedConnectionPointTypes.push(L.Int),this._inputs[1].acceptedConnectionPointTypes.push(L.Int),this._linkConnectionTypes(2,3)}getClassName(){return"ParticleConditionBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get ifTrue(){return this._inputs[2]}get ifFalse(){return this._inputs[3]}get output(){return this._outputs[0]}_build(){const e=t=>{const i=this.left.getConnectedValue(t),r=this.right.getConnectedValue(t);let n=!1;switch(this.test){case _i.Equal:n=fn(i,r,this.epsilon);break;case _i.NotEqual:n=!fn(i,r,this.epsilon);break;case _i.LessThan:n=i<r+this.epsilon;break;case _i.GreaterThan:n=i>r-this.epsilon;break;case _i.LessOrEqual:n=i<=r+this.epsilon;break;case _i.GreaterOrEqual:n=i>=r-this.epsilon;break;case _i.Xor:n=!!i&&!r||!i&&!!r;break;case _i.Or:n=!!i||!!r;break;case _i.And:n=!!i&&!!r;break}return n};this.output._storedFunction=t=>e(t)?this.ifTrue.getConnectedValue(t):this.ifFalse.getConnectedValue(t)}serialize(){const e=super.serialize();return e.test=this.test,e.epsilon=this.epsilon,e}_deserialize(e){super._deserialize(e),this.test=e.test,e.epsilon!==void 0&&(this.epsilon=e.epsilon)}}_([O("Test",5,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Equal",value:_i.Equal},{label:"NotEqual",value:_i.NotEqual},{label:"LessThan",value:_i.LessThan},{label:"GreaterThan",value:_i.GreaterThan},{label:"LessOrEqual",value:_i.LessOrEqual},{label:"GreaterOrEqual",value:_i.GreaterOrEqual},{label:"Xor",value:_i.Xor},{label:"Or",value:_i.Or},{label:"And",value:_i.And}]})],Z_.prototype,"test",void 0);_([O("Epsilon",1,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Z_.prototype,"epsilon",void 0);y("BABYLON.ParticleConditionBlock",Z_);class Q_ extends Ze{constructor(e){super(e),this._triggerCount=0,this.limit=5,this.delay=250,this._previousOne=null,this.registerInput("input",L.Particle),this.registerInput("condition",L.Float,!0,0),this.registerInput("system",L.System),this.registerOutput("output",L.Particle)}getClassName(){return"ParticleTriggerBlock"}get input(){return this._inputs[0]}get condition(){return this._inputs[1]}get system(){return this._inputs[2]}get output(){return this._outputs[0]}_build(e){this._triggerCount=0;const t=this.input.getConnectedValue(e),r={process:n=>{if(e.particleContext=n,e.systemContext=t,this.condition.getConnectedValue(e)!==0&&(this.limit===0||this._triggerCount<this.limit)){const a=new Date().getTime();if(this._previousOne&&a-this._previousOne<this.delay)return;this._triggerCount++,this._previousOne=a;const o=this.system.getConnectedValue(e);if(o){const l=If(o,e.scene,n.position);l.onDisposeObservable.addOnce(()=>{this._triggerCount--}),t.onDisposeObservable.addOnce(()=>{l.dispose()})}}},previousItem:null,nextItem:null};t._updateQueueStart?Tr(r,t._updateQueueStart):t._updateQueueStart=r,this.output._storedValue=t}serialize(){const e=super.serialize();return e.limit=this.limit,e.delay=this.delay,e}_deserialize(e){super._deserialize(e),e.limit!==void 0&&(this.limit=e.limit),e.delay!==void 0&&(this.delay=e.delay)}dispose(){super.dispose(),this._triggerCount=0}}_([O("Max simultaneous",2,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},min:0})],Q_.prototype,"limit",void 0);_([O("Delay between calls (ms)",2,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},min:0})],Q_.prototype,"delay",void 0);y("BABYLON.ParticleTriggerBlock",Q_);var No;(function(s){s[s.Particle=0]="Particle",s[s.Loop=1]="Loop"})(No||(No={}));class iP extends Ze{constructor(e){super(e),this.scope=No.Particle,this._isDebug=!0,this.registerInput("input",L.AutoDetect),this.registerOutput("output",L.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(L.FloatGradient),this._inputs[0].excludedConnectionPointTypes.push(L.Vector2Gradient),this._inputs[0].excludedConnectionPointTypes.push(L.Vector3Gradient),this._inputs[0].excludedConnectionPointTypes.push(L.Color4Gradient),this._inputs[0].excludedConnectionPointTypes.push(L.System),this._inputs[0].excludedConnectionPointTypes.push(L.Particle),this._inputs[0].excludedConnectionPointTypes.push(L.Texture)}getClassName(){return"ParticleLocalVariableBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_build(e){if(!this.input.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let t=null,i=-1;const r=n=>{var o,l;if(!n.particleContext&&!n.systemContext)return t=null,null;const a=(this.scope===No.Particle?(o=n.particleContext)==null?void 0:o.id:(l=n.systemContext)==null?void 0:l.getScene().getFrameId())||-1;return i!==a&&(i=a,t=null),t===null&&(t=this.input.getConnectedValue(n)),t};this.output.isConnected?this.output._storedFunction=r:this.output._storedValue=r(e)}serialize(){const e=super.serialize();return e.scope=this.scope,e}_deserialize(e){super._deserialize(e),this.scope=e.scope}}_([O("Scope",5,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},options:[{label:"Particle",value:No.Particle},{label:"Loop",value:No.Loop}]})],iP.prototype,"scope",void 0);y("BABYLON.ParticleLocalVariableBlock",iP);class WH extends Ze{constructor(e){super(e),this.registerInput("input",L.AutoDetect),this.registerOutput("output",L.Float),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(L.Vector2|L.Vector3)}getClassName(){return"ParticleVectorLengthBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_build(){if(!this.input.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}this.output._storedFunction=e=>this.input.getConnectedValue(e).length()}}y("BABYLON.ParticleVectorLengthBlock",WH);class HH extends Ze{constructor(e){super(e),this.registerInput("view",L.Vector3),this.registerInput("normal",L.Vector3),this.registerOutput("output",L.Float)}getClassName(){return"ParticleFresnelBlock"}get view(){return this._inputs[0]}get normal(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_build(){if(!this.view.isConnected||!this.normal.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}this.output._storedFunction=e=>{const t=this.view.getConnectedValue(e),i=this.normal.getConnectedValue(e),r=.04,n=i.length(),a=t.length();if(n<1e-8||a<1e-8)return r;const l=1-Math.min(Math.max(x.Dot(i,t)/(n*a),0),1);return r+(1-r)*Math.pow(l,5)}}}y("BABYLON.ParticleFresnelBlock",HH);Object.defineProperty(Mt.prototype,"physicsImpostor",{get:function(){return this._physicsImpostor},set:function(s){this._physicsImpostor!==s&&(this._disposePhysicsObserver&&this.onDisposeObservable.remove(this._disposePhysicsObserver),this._physicsImpostor=s,s&&(this._disposePhysicsObserver=this.onDisposeObservable.add(()=>{this.physicsImpostor&&(this.physicsImpostor.dispose(),this.physicsImpostor=null)})))},enumerable:!0,configurable:!0});Mt.prototype.getPhysicsImpostor=function(){return this.physicsImpostor};Mt.prototype.applyImpulse=function(s,e){return this.physicsImpostor?(this.physicsImpostor.applyImpulse(s,e),this):this};Mt.prototype.setPhysicsLinkWith=function(s,e,t,i){return!this.physicsImpostor||!s.physicsImpostor?this:(this.physicsImpostor.createJoint(s.physicsImpostor,xt.HingeJoint,{mainPivot:e,connectedPivot:t,nativeParams:i}),this)};class K_{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw Ys("")}constructor(e,t=K_.DefaultPluginFactory()){this._physicsPlugin=t,this._physicsBodies=[],this._subTimeStep=0,e=e||new x(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}setVelocityLimits(e,t){this._physicsPlugin.setVelocityLimits(e,t)}getMaxLinearVelocity(){return this._physicsPlugin.getMaxLinearVelocity()}getMaxAngularVelocity(){return this._physicsPlugin.getMaxAngularVelocity()}_step(e){e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._physicsBodies)}addBody(e){this._physicsBodies.push(e)}removeBody(e){const t=this._physicsBodies.indexOf(e);t>-1&&this._physicsBodies.splice(t,1)}getBodies(){return this._physicsBodies}getPhysicsPlugin(){return this._physicsPlugin}raycastToRef(e,t,i,r){this._physicsPlugin.raycast(e,t,i,r)}raycast(e,t,i){const r=new bh;return this._physicsPlugin.raycast(e,t,r,i),r}}var Pb;(function(s){s[s.FREE=0]="FREE",s[s.LIMITED=1]="LIMITED",s[s.LOCKED=2]="LOCKED"})(Pb||(Pb={}));var Ob;(function(s){s[s.LINEAR_X=0]="LINEAR_X",s[s.LINEAR_Y=1]="LINEAR_Y",s[s.LINEAR_Z=2]="LINEAR_Z",s[s.ANGULAR_X=3]="ANGULAR_X",s[s.ANGULAR_Y=4]="ANGULAR_Y",s[s.ANGULAR_Z=5]="ANGULAR_Z",s[s.LINEAR_DISTANCE=6]="LINEAR_DISTANCE"})(Ob||(Ob={}));var Nb;(function(s){s[s.BALL_AND_SOCKET=1]="BALL_AND_SOCKET",s[s.DISTANCE=2]="DISTANCE",s[s.HINGE=3]="HINGE",s[s.SLIDER=4]="SLIDER",s[s.LOCK=5]="LOCK",s[s.PRISMATIC=6]="PRISMATIC",s[s.SIX_DOF=7]="SIX_DOF"})(Nb||(Nb={}));var Db;(function(s){s[s.SPHERE=0]="SPHERE",s[s.CAPSULE=1]="CAPSULE",s[s.CYLINDER=2]="CYLINDER",s[s.BOX=3]="BOX",s[s.CONVEX_HULL=4]="CONVEX_HULL",s[s.CONTAINER=5]="CONTAINER",s[s.MESH=6]="MESH",s[s.HEIGHTFIELD=7]="HEIGHTFIELD"})(Db||(Db={}));var Mb;(function(s){s[s.NONE=0]="NONE",s[s.VELOCITY=1]="VELOCITY",s[s.POSITION=2]="POSITION"})(Mb||(Mb={}));var Fb;(function(s){s.COLLISION_STARTED="COLLISION_STARTED",s.COLLISION_CONTINUED="COLLISION_CONTINUED",s.COLLISION_FINISHED="COLLISION_FINISHED",s.TRIGGER_ENTERED="TRIGGER_ENTERED",s.TRIGGER_EXITED="TRIGGER_EXITED"})(Fb||(Fb={}));var Lb;(function(s){s[s.STATIC=0]="STATIC",s[s.ANIMATED=1]="ANIMATED",s[s.DYNAMIC=2]="DYNAMIC"})(Lb||(Lb={}));var wb;(function(s){s[s.DISABLED=0]="DISABLED",s[s.TELEPORT=1]="TELEPORT",s[s.ACTION=2]="ACTION"})(wb||(wb={}));var Bb;(function(s){s[s.SIMULATION_CONTROLLED=0]="SIMULATION_CONTROLLED",s[s.ALWAYS_ACTIVE=1]="ALWAYS_ACTIVE",s[s.ALWAYS_INACTIVE=2]="ALWAYS_INACTIVE"})(Bb||(Bb={}));var Vb;(function(s){s[s.GEOMETRIC_MEAN=0]="GEOMETRIC_MEAN",s[s.MINIMUM=1]="MINIMUM",s[s.MAXIMUM=2]="MAXIMUM",s[s.ARITHMETIC_MEAN=3]="ARITHMETIC_MEAN",s[s.MULTIPLY=4]="MULTIPLY"})(Vb||(Vb={}));var Ub;(function(s){s[s.UNSUPPORTED=0]="UNSUPPORTED",s[s.SLIDING=1]="SLIDING",s[s.SUPPORTED=2]="SUPPORTED"})(Ub||(Ub={}));var kb;(function(s){s[s.OK=0]="OK",s[s.FAILURE_3D=1]="FAILURE_3D",s[s.FAILURE_2D=2]="FAILURE_2D"})(kb||(kb={}));le.prototype.getPhysicsEngine=function(){return this._physicsEngine??null};le.prototype.enablePhysics=function(s=null,e){if(this._physicsEngine)return!0;let t=this._getComponent(se.NAME_PHYSICSENGINE);t||(t=new $H(this),this._addComponent(t));try{if(!e||(e==null?void 0:e.getPluginVersion())===1)this._physicsEngine=new mA(s,e);else if((e==null?void 0:e.getPluginVersion())===2)this._physicsEngine=new K_(s,e);else throw new Error("Unsupported Physics plugin version.");return this._physicsTimeAccumulator=0,!0}catch(i){return N.Error(i.message),!1}};le.prototype.disablePhysicsEngine=function(){this._physicsEngine&&(this._physicsEngine.dispose(),this._physicsEngine=null)};le.prototype.isPhysicsEnabled=function(){return this._physicsEngine!==void 0};le.prototype.deleteCompoundImpostor=function(s){const e=s.parts[0].mesh;e.physicsImpostor&&(e.physicsImpostor.dispose(),e.physicsImpostor=null)};le.prototype._advancePhysicsEngineStep=function(s){if(this._physicsEngine){const e=this._physicsEngine.getSubTimeStep();if(e>0)for(this._physicsTimeAccumulator+=s;this._physicsTimeAccumulator>e;)this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(e/1e3),this.onAfterPhysicsObservable.notifyObservers(this),this._physicsTimeAccumulator-=e;else this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(s/1e3),this.onAfterPhysicsObservable.notifyObservers(this)}};class $H{constructor(e){this.name=se.NAME_PHYSICSENGINE,this.scene=e,this.scene.onBeforePhysicsObservable=new k,this.scene.onAfterPhysicsObservable=new k,this.scene.getDeterministicFrameTime=()=>this.scene._physicsEngine?this.scene._physicsEngine.getTimeStep()*1e3:1e3/60}register(){}rebuild(){}dispose(){this.scene.onBeforePhysicsObservable.clear(),this.scene.onAfterPhysicsObservable.clear(),this.scene._physicsEngine&&this.scene.disablePhysicsEngine()}}Object.defineProperty(Es.prototype,"physicsBody",{get:function(){return this._physicsBody},set:function(s){this._physicsBody!==s&&(this._disposePhysicsObserver&&this.onDisposeObservable.remove(this._disposePhysicsObserver),this._physicsBody=s,s&&(this._disposePhysicsObserver=this.onDisposeObservable.add(()=>{this.physicsBody&&(this.physicsBody.dispose(),this.physicsBody=null)})))},enumerable:!0,configurable:!0});Es.prototype.getPhysicsBody=function(){return this.physicsBody};Es.prototype.applyImpulse=function(s,e){if(!this.physicsBody)throw new Error("No Physics Body for TransformNode");return this.physicsBody.applyImpulse(s,e),this};Es.prototype.applyAngularImpulse=function(s){if(!this.physicsBody)throw new Error("No Physics Body for TransformNode");return this.physicsBody.applyAngularImpulse(s),this};x.Zero();var Gb;(function(s){s[s.Constant=0]="Constant",s[s.Linear=1]="Linear"})(Gb||(Gb={}));var zb;(function(s){s[s.Center=0]="Center",s[s.Perpendicular=1]="Perpendicular"})(zb||(zb={}));class Mh extends Se{get degree(){return this._effectWrapper.degree}set degree(e){this._effectWrapper.degree=e}getClassName(){return"BlackAndWhitePostProcess"}constructor(e,t,i=null,r,n,a){const o={uniforms:Vs.Uniforms,size:typeof t=="number"?t:void 0,camera:i,samplingMode:r,engine:n,reusable:a,...t};super(e,Vs.FragmentUrl,{effectWrapper:typeof t=="number"||!t.effectWrapper?new Vs(e,n,o):void 0,...o})}static _Parse(e,t,i,r){return me.Parse(()=>new Mh(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}}_([R()],Mh.prototype,"degree",null);y("BABYLON.BlackAndWhitePostProcess",Mh);class Ye{constructor(e,t,i,r=!0){this._name=t,this._singleInstance=r,this._getPostProcesses=i,this._cameras={},this._indicesForCamera={},this._postProcesses={}}get isSupported(){for(const e in this._postProcesses)if(Object.prototype.hasOwnProperty.call(this._postProcesses,e)){const t=this._postProcesses[e];for(let i=0;i<t.length;i++)if(!t[i].isSupported)return!1}return!0}_update(){}_attachCameras(e){let t;const i=j.MakeArray(e||this._cameras);if(i)for(let r=0;r<i.length;r++){const n=i[r];if(!n)continue;const a=n.name;if(this._singleInstance?t=0:t=a,!this._postProcesses[t]){const l=this._getPostProcesses();l&&(this._postProcesses[t]=Array.isArray(l)?l:[l])}this._indicesForCamera[a]||(this._indicesForCamera[a]=[]);const o=this._postProcesses[t];for(const l of o){const c=n.attachPostProcess(l);this._indicesForCamera[a].push(c)}this._cameras[a]||(this._cameras[a]=n)}}_detachCameras(e){const t=j.MakeArray(e||this._cameras);if(t)for(let i=0;i<t.length;i++){const r=t[i],n=r.name,a=this._postProcesses[this._singleInstance?0:n];if(a)for(const o of a)r.detachPostProcess(o);this._cameras[n]&&(this._cameras[n]=null),delete this._indicesForCamera[n]}}_enable(e){const t=j.MakeArray(e||this._cameras);if(t)for(let i=0;i<t.length;i++){const r=t[i],n=r.name,a=this._singleInstance?0:n;for(let o=0;o<this._indicesForCamera[n].length;o++){const l=this._indicesForCamera[n][o],c=r._postProcesses[l];c==null&&t[i].attachPostProcess(this._postProcesses[a][o],l)}}}_disable(e){const t=j.MakeArray(e||this._cameras);if(t)for(let i=0;i<t.length;i++){const r=t[i],n=r.name,a=this._postProcesses[this._singleInstance?0:n];for(const o of a)r.detachPostProcess(o)}}getPostProcesses(e){return this._singleInstance?this._postProcesses[0]:e?this._postProcesses[e.name]:null}}class J_ extends Se{get threshold(){return this._effectWrapper.threshold}set threshold(e){this._effectWrapper.threshold=e}get _exposure(){return this._effectWrapper._exposure}set _exposure(e){this._effectWrapper._exposure=e}getClassName(){return"ExtractHighlightsPostProcess"}constructor(e,t,i=null,r,n,a,o=0,l=!1){const c={uniforms:_s.Uniforms,size:typeof t=="number"?t:void 0,camera:i,samplingMode:r,engine:n,reusable:a,textureType:o,blockCompilation:l,...t};super(e,_s.FragmentUrl,{effectWrapper:typeof t=="number"||!t.effectWrapper?new _s(e,n,c):void 0,...c}),this._inputPostProcess=null,this.onApplyObservable.add(u=>{this.externalTextureSamplerBinding=!!this._inputPostProcess,this._inputPostProcess&&u.setTextureFromPostProcess("textureSampler",this._inputPostProcess)})}}_([R()],J_.prototype,"threshold",null);y("BABYLON.ExtractHighlightsPostProcess",J_);class eg extends Se{get weight(){return this._effectWrapper.weight}set weight(e){this._effectWrapper.weight=e}getClassName(){return"BloomMergePostProcess"}constructor(e,t,i,r,n,a=null,o,l,c,u=0,h=!1){const d=typeof n=="number"?h:!!n.blockCompilation,f={uniforms:Dr.Uniforms,samplers:Dr.Samplers,size:typeof n=="number"?n:void 0,camera:a,samplingMode:o,engine:l,reusable:c,textureType:u,...n,blockCompilation:!0};super(e,Dr.FragmentUrl,{effectWrapper:typeof n=="number"||!n.effectWrapper?new Dr(e,l,f):void 0,...f}),this.weight=r,this.externalTextureSamplerBinding=!0,this.onApplyObservable.add(m=>{m.setTextureFromPostProcess("textureSampler",t),m.setTextureFromPostProcessOutput("bloomBlur",i)}),d||this.updateEffect()}}_([R()],eg.prototype,"weight",null);y("BABYLON.BloomMergePostProcess",eg);class Wb extends Ye{get threshold(){return this._thinBloomEffect.threshold}set threshold(e){this._thinBloomEffect.threshold=e}get weight(){return this._thinBloomEffect.weight}set weight(e){this._thinBloomEffect.weight=e}get kernel(){return this._thinBloomEffect.kernel}set kernel(e){this._thinBloomEffect.kernel=e}get bloomScale(){return this._thinBloomEffect.scale}constructor(e,t,i,r,n=0,a=!1){const o=e._renderForCamera?e.getEngine():e;super(o,"bloom",()=>this._effects,!0),this._effects=[],this._thinBloomEffect=new AR("bloom",o,t,a),this._downscale=new J_("highlights",{size:1,samplingMode:$.BILINEAR_SAMPLINGMODE,engine:o,textureType:n,blockCompilation:a,effectWrapper:this._thinBloomEffect._downscale}),this._blurX=new nr("horizontal blur",this._thinBloomEffect._blurX.direction,this._thinBloomEffect._blurX.kernel,{size:t,samplingMode:$.BILINEAR_SAMPLINGMODE,engine:o,textureType:n,blockCompilation:a,effectWrapper:this._thinBloomEffect._blurX}),this._blurX.alwaysForcePOT=!0,this._blurX.autoClear=!1,this._blurY=new nr("vertical blur",this._thinBloomEffect._blurY.direction,this._thinBloomEffect._blurY.kernel,{size:t,samplingMode:$.BILINEAR_SAMPLINGMODE,engine:o,textureType:n,blockCompilation:a,effectWrapper:this._thinBloomEffect._blurY}),this._blurY.alwaysForcePOT=!0,this._blurY.autoClear=!1,this.kernel=r,this._effects=[this._downscale,this._blurX,this._blurY],this._merge=new eg("bloomMerge",this._downscale,this._blurY,i,{size:t,samplingMode:$.BILINEAR_SAMPLINGMODE,engine:o,textureType:n,blockCompilation:a,effectWrapper:this._thinBloomEffect._merge}),this._merge.autoClear=!1,this._effects.push(this._merge)}disposeEffects(e){for(let t=0;t<this._effects.length;t++)this._effects[t].dispose(e)}_updateEffects(){for(let e=0;e<this._effects.length;e++)this._effects[e].updateEffect()}_isReady(){return this._thinBloomEffect.isReady()}}class Zs extends Se{get aberrationAmount(){return this._effectWrapper.aberrationAmount}set aberrationAmount(e){this._effectWrapper.aberrationAmount=e}get radialIntensity(){return this._effectWrapper.radialIntensity}set radialIntensity(e){this._effectWrapper.radialIntensity=e}get direction(){return this._effectWrapper.direction}set direction(e){this._effectWrapper.direction=e}get centerPosition(){return this._effectWrapper.centerPosition}set centerPosition(e){this._effectWrapper.centerPosition=e}get screenWidth(){return this._effectWrapper.screenWidth}set screenWidth(e){this._effectWrapper.screenWidth=e}get screenHeight(){return this._effectWrapper.screenHeight}set screenHeight(e){this._effectWrapper.screenHeight=e}getClassName(){return"ChromaticAberrationPostProcess"}constructor(e,t,i,r,n,a,o,l,c=0,u=!1){const h={uniforms:Us.Uniforms,size:typeof r=="number"?r:void 0,camera:n,samplingMode:a,engine:o,reusable:l,textureType:c,blockCompilation:u,...r};super(e,Us.FragmentUrl,{effectWrapper:typeof r=="number"||!r.effectWrapper?new Us(e,o,h):void 0,...h}),this.screenWidth=t,this.screenHeight=i}static _Parse(e,t,i,r){return me.Parse(()=>new Zs(e.name,e.screenWidth,e.screenHeight,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,!1),e,i,r)}}_([R()],Zs.prototype,"aberrationAmount",null);_([R()],Zs.prototype,"radialIntensity",null);_([R()],Zs.prototype,"direction",null);_([R()],Zs.prototype,"centerPosition",null);_([R()],Zs.prototype,"screenWidth",null);_([R()],Zs.prototype,"screenHeight",null);y("BABYLON.ChromaticAberrationPostProcess",Zs);class tl extends Se{get lensSize(){return this._effectWrapper.lensSize}set lensSize(e){this._effectWrapper.lensSize=e}get fStop(){return this._effectWrapper.fStop}set fStop(e){this._effectWrapper.fStop=e}get focusDistance(){return this._effectWrapper.focusDistance}set focusDistance(e){this._effectWrapper.focusDistance=e}get focalLength(){return this._effectWrapper.focalLength}set focalLength(e){this._effectWrapper.focalLength=e}getClassName(){return"CircleOfConfusionPostProcess"}constructor(e,t,i,r,n,a,o,l=0,c=!1){const u={uniforms:Vi.Uniforms,samplers:Vi.Samplers,defines:typeof i=="object"&&i.depthNotNormalized?Vi.DefinesDepthNotNormalized:void 0,size:typeof i=="number"?i:void 0,camera:r,samplingMode:n,engine:a,reusable:o,textureType:l,blockCompilation:c,...i};super(e,Vi.FragmentUrl,{effectWrapper:typeof i=="number"||!i.effectWrapper?new Vi(e,a,u):void 0,...u}),this._depthTexture=null,this._depthTexture=t,this.onApplyObservable.add(h=>{if(!this._depthTexture){N.Warn("No depth texture set on CircleOfConfusionPostProcess");return}h.setTexture("depthSampler",this._depthTexture),this._effectWrapper.camera=this._depthTexture.activeCamera})}set depthTexture(e){this._depthTexture=e}}_([R()],tl.prototype,"lensSize",null);_([R()],tl.prototype,"fStop",null);_([R()],tl.prototype,"focusDistance",null);_([R()],tl.prototype,"focalLength",null);y("BABYLON.CircleOfConfusionPostProcess",tl);class Fh extends Se{get colorTableUrl(){return this._effectWrapper.colorTableUrl}getClassName(){return"ColorCorrectionPostProcess"}constructor(e,t,i,r,n,a,o){const l={samplers:gs.Samplers,size:typeof i=="number"?i:void 0,camera:r,samplingMode:n,engine:a,reusable:o,...i},c=(r==null?void 0:r.getScene())||null;super(e,gs.FragmentUrl,{effectWrapper:typeof i=="number"||!i.effectWrapper?new gs(e,c,t,l):void 0,...l})}static _Parse(e,t,i,r){return me.Parse(()=>new Fh(e.name,e.colorTableUrl,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}}_([R()],Fh.prototype,"colorTableUrl",null);y("BABYLON.ColorCorrectionPostProcess",Fh);class Qs extends Se{get kernel(){return this._effectWrapper.kernel}set kernel(e){this._effectWrapper.kernel=e}getClassName(){return"ConvolutionPostProcess"}constructor(e,t,i,r,n,a,o,l=0){const c={uniforms:tt.Uniforms,size:typeof i=="number"?i:void 0,camera:r,samplingMode:n,engine:a,reusable:o,textureType:l,...i};super(e,tt.FragmentUrl,{effectWrapper:typeof i=="number"||!i.effectWrapper?new tt(e,a,t,c):void 0,...c}),this.onApply=u=>{this._effectWrapper.textureWidth=this.width,this._effectWrapper.textureHeight=this.height}}static _Parse(e,t,i,r){return me.Parse(()=>new Qs(e.name,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType),e,i,r)}}Qs.EdgeDetect0Kernel=tt.EdgeDetect0Kernel;Qs.EdgeDetect1Kernel=tt.EdgeDetect1Kernel;Qs.EdgeDetect2Kernel=tt.EdgeDetect2Kernel;Qs.SharpenKernel=tt.SharpenKernel;Qs.EmbossKernel=tt.EmbossKernel;Qs.GaussianKernel=tt.GaussianKernel;_([R()],Qs.prototype,"kernel",null);y("BABYLON.ConvolutionPostProcess",Qs);class Af extends nr{getClassName(){return"DepthOfFieldBlurPostProcess"}constructor(e,t,i,r,n,a,o,l=null,c=$.BILINEAR_SAMPLINGMODE,u,h,d=0,f=!1,m=5){const g={size:typeof n=="number"?n:void 0,camera:a,samplingMode:c=2,engine:u,reusable:h,textureType:d,defines:`#define DOF 1
`,blockCompilation:f,textureFormat:m,...n};super(e,i,r,{effectWrapper:typeof n=="number"||!n.effectWrapper?new iu(e,u,i,r,g):void 0,...g}),this.externalTextureSamplerBinding=!!l,this.onApplyObservable.add(v=>{l!=null&&v.setTextureFromPostProcess("textureSampler",l),v.setTextureFromPostProcessOutput("circleOfConfusionSampler",o)})}}y("BABYLON.DepthOfFieldBlurPostProcess",Af);class XH extends Se{getClassName(){return"DepthOfFieldMergePostProcess"}constructor(e,t,i,r,n,a,o,l,c,u=0,h=!1){const d=typeof n=="number"?h:!!n.blockCompilation,f={samplers:ks.Samplers,size:typeof n=="number"?n:void 0,camera:a,samplingMode:o,engine:l,reusable:c,textureType:u,...n,blockCompilation:!0};super(e,ks.FragmentUrl,{effectWrapper:typeof n=="number"||!n.effectWrapper?new ks(e,l,f):void 0,...f}),this._blurSteps=r,this.externalTextureSamplerBinding=!0,this.onApplyObservable.add(m=>{m.setTextureFromPostProcess("textureSampler",t),m.setTextureFromPostProcessOutput("circleOfConfusionSampler",i);for(let g=0;g<r.length;g++){const v=r[g];m.setTextureFromPostProcessOutput("blurStep"+(r.length-g-1),v)}}),d||this.updateEffect()}updateEffect(e=null,t=null,i=null,r,n,a){e||(e="",e+="#define BLUR_LEVEL "+(this._blurSteps.length-1)+`
`),super.updateEffect(e,t,i,r,n,a)}}var Hb;(function(s){s[s.Low=0]="Low",s[s.Medium=1]="Medium",s[s.High=2]="High"})(Hb||(Hb={}));class $b extends Ye{set focalLength(e){this._thinDepthOfFieldEffect.focalLength=e}get focalLength(){return this._thinDepthOfFieldEffect.focalLength}set fStop(e){this._thinDepthOfFieldEffect.fStop=e}get fStop(){return this._thinDepthOfFieldEffect.fStop}set focusDistance(e){this._thinDepthOfFieldEffect.focusDistance=e}get focusDistance(){return this._thinDepthOfFieldEffect.focusDistance}set lensSize(e){this._thinDepthOfFieldEffect.lensSize=e}get lensSize(){return this._thinDepthOfFieldEffect.lensSize}constructor(e,t,i=0,r=0,n=!1,a=!1){const o=e._renderForCamera?e.getEngine():e;super(o,"depth of field",()=>this._effects,!0),this._effects=[],this._thinDepthOfFieldEffect=new MR("Depth of Field",o,i,!1,n);const l=o.isWebGPU||o.version>1?6:5;this._circleOfConfusion=new tl("circleOfConfusion",t,{size:1,samplingMode:$.BILINEAR_SAMPLINGMODE,engine:o,textureType:r,blockCompilation:n,depthNotNormalized:a,effectWrapper:this._thinDepthOfFieldEffect._circleOfConfusion},null),this._depthOfFieldBlurY=[],this._depthOfFieldBlurX=[];const c=this._thinDepthOfFieldEffect._depthOfFieldBlurX.length;for(let u=0;u<c;u++){const[h,d]=this._thinDepthOfFieldEffect._depthOfFieldBlurY[u],f=new Af("vertical blur",null,h.direction,h.kernel,{size:d,samplingMode:$.BILINEAR_SAMPLINGMODE,engine:o,textureType:r,blockCompilation:n,textureFormat:u==0?l:5,effectWrapper:h},null,this._circleOfConfusion,u==0?this._circleOfConfusion:null);f.autoClear=!1;const[m,g]=this._thinDepthOfFieldEffect._depthOfFieldBlurX[u],v=new Af("horizontal blur",null,m.direction,m.kernel,{size:g,samplingMode:$.BILINEAR_SAMPLINGMODE,engine:o,textureType:r,blockCompilation:n,effectWrapper:m},null,this._circleOfConfusion,null);v.autoClear=!1,this._depthOfFieldBlurY.push(f),this._depthOfFieldBlurX.push(v)}this._effects=[this._circleOfConfusion];for(let u=0;u<this._depthOfFieldBlurX.length;u++)this._effects.push(this._depthOfFieldBlurY[u]),this._effects.push(this._depthOfFieldBlurX[u]);this._dofMerge=new XH("dofMerge",this._circleOfConfusion,this._circleOfConfusion,this._depthOfFieldBlurX,{size:this._thinDepthOfFieldEffect._depthOfFieldBlurX[c-1][1],samplingMode:$.BILINEAR_SAMPLINGMODE,engine:o,textureType:r,blockCompilation:n,effectWrapper:this._thinDepthOfFieldEffect._dofMerge},null),this._dofMerge.autoClear=!1,this._effects.push(this._dofMerge)}getClassName(){return"DepthOfFieldEffect"}set depthTexture(e){this._circleOfConfusion.depthTexture=e}disposeEffects(e){for(let t=0;t<this._effects.length;t++)this._effects[t].dispose(e)}_updateEffects(){for(let e=0;e<this._effects.length;e++)this._effects[e].updateEffect()}_isReady(){return this._thinDepthOfFieldEffect.isReady()}}class tg extends Se{getClassName(){return"DisplayPassPostProcess"}constructor(e,t,i,r,n,a){super(e,"displayPass",["passSampler"],["passSampler"],t,i,r,n,a)}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([U(()=>Promise.resolve().then(()=>u5),void 0)]))):t.push(Promise.all([U(()=>Promise.resolve().then(()=>l5),void 0)])),super._gatherImports(e,t)}static _Parse(e,t,i,r){return me.Parse(()=>new tg(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}}y("BABYLON.DisplayPassPostProcess",tg);class Lh extends Se{get kernelMatrix(){return this._effectWrapper.kernelMatrix}set kernelMatrix(e){this._effectWrapper.kernelMatrix=e}getClassName(){return"FilterPostProcess"}constructor(e,t,i,r,n,a,o){const l={uniforms:Gs.Uniforms,size:typeof i=="number"?i:void 0,camera:r,samplingMode:n,engine:a,reusable:o,...i};super(e,Gs.FragmentUrl,{effectWrapper:typeof i=="number"||!i.effectWrapper?new Gs(e,a,l):void 0,...l}),this.kernelMatrix=t}static _Parse(e,t,i,r){return me.Parse(()=>new Lh(e.name,e.kernelMatrix,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}}_([Um()],Lh.prototype,"kernelMatrix",null);y("BABYLON.FilterPostProcess",Lh);class il extends Se{get intensity(){return this._effectWrapper.intensity}set intensity(e){this._effectWrapper.intensity=e}get animated(){return this._effectWrapper.animated}set animated(e){this._effectWrapper.animated=e}getClassName(){return"GrainPostProcess"}constructor(e,t,i,r,n,a,o=0,l=!1){const c={uniforms:zs.Uniforms,size:typeof t=="number"?t:void 0,camera:i,samplingMode:r,engine:n,reusable:a,textureType:o,blockCompilation:l,...t};super(e,zs.FragmentUrl,{effectWrapper:typeof t=="number"||!t.effectWrapper?new zs(e,n,c):void 0,...c})}static _Parse(e,t,i,r){return me.Parse(()=>new il(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}}_([R()],il.prototype,"intensity",null);_([R()],il.prototype,"animated",null);y("BABYLON.GrainPostProcess",il);class ig extends Se{get _imageProcessingConfiguration(){return this._effectWrapper.imageProcessingConfiguration}get imageProcessingConfiguration(){return this._effectWrapper.imageProcessingConfiguration}set imageProcessingConfiguration(e){this._effectWrapper.imageProcessingConfiguration=e}get isSupported(){const e=this.getEffect();return!e||e.isSupported}get colorCurves(){return this.imageProcessingConfiguration.colorCurves}set colorCurves(e){this.imageProcessingConfiguration.colorCurves=e}get colorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set colorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get colorGradingTexture(){return this.imageProcessingConfiguration.colorGradingTexture}set colorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get colorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set colorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get exposure(){return this.imageProcessingConfiguration.exposure}set exposure(e){this.imageProcessingConfiguration.exposure=e}get toneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set toneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get toneMappingType(){return this._imageProcessingConfiguration.toneMappingType}set toneMappingType(e){this._imageProcessingConfiguration.toneMappingType=e}get contrast(){return this.imageProcessingConfiguration.contrast}set contrast(e){this.imageProcessingConfiguration.contrast=e}get vignetteStretch(){return this.imageProcessingConfiguration.vignetteStretch}set vignetteStretch(e){this.imageProcessingConfiguration.vignetteStretch=e}get vignetteCentreX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCentreX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteCentreY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCentreY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCenterY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCenterX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteWeight(){return this.imageProcessingConfiguration.vignetteWeight}set vignetteWeight(e){this.imageProcessingConfiguration.vignetteWeight=e}get vignetteColor(){return this.imageProcessingConfiguration.vignetteColor}set vignetteColor(e){this.imageProcessingConfiguration.vignetteColor=e}get vignetteCameraFov(){return this.imageProcessingConfiguration.vignetteCameraFov}set vignetteCameraFov(e){this.imageProcessingConfiguration.vignetteCameraFov=e}get vignetteBlendMode(){return this.imageProcessingConfiguration.vignetteBlendMode}set vignetteBlendMode(e){this.imageProcessingConfiguration.vignetteBlendMode=e}get vignetteEnabled(){return this.imageProcessingConfiguration.vignetteEnabled}set vignetteEnabled(e){this.imageProcessingConfiguration.vignetteEnabled=e}get ditheringIntensity(){return this.imageProcessingConfiguration.ditheringIntensity}set ditheringIntensity(e){this.imageProcessingConfiguration.ditheringIntensity=e}get ditheringEnabled(){return this.imageProcessingConfiguration.ditheringEnabled}set ditheringEnabled(e){this.imageProcessingConfiguration.ditheringEnabled=e}get fromLinearSpace(){return this._effectWrapper.fromLinearSpace}set fromLinearSpace(e){this._effectWrapper.fromLinearSpace=e}constructor(e,t,i=null,r,n,a,o=0,l){const c={size:typeof t=="number"?t:void 0,camera:i,samplingMode:r,engine:n,reusable:a,textureType:o,imageProcessingConfiguration:l,scene:i==null?void 0:i.getScene(),...t,blockCompilation:!0};super(e,Ia.FragmentUrl,{effectWrapper:typeof t=="number"||!t.effectWrapper?new Ia(e,n,c):void 0,...c}),this.onApply=()=>{this._effectWrapper.overrideAspectRatio=this.aspectRatio}}getClassName(){return"ImageProcessingPostProcess"}_updateParameters(){this._effectWrapper._updateParameters()}dispose(e){super.dispose(e),this._imageProcessingConfiguration&&(this.imageProcessingConfiguration.applyByPostProcess=!1)}}_([R()],ig.prototype,"fromLinearSpace",null);const Xb="mrtFragmentDeclaration",YH=`#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
layout(location=0) out vec4 glFragData[{X}];
#endif
`;S.IncludesShadersStore[Xb]||(S.IncludesShadersStore[Xb]=YH);const Pf="geometryPixelShader",rP=`#extension GL_EXT_draw_buffers : require
#if defined(BUMP) || !defined(NORMAL)
#extension GL_OES_standard_derivatives : enable
#endif
precision highp float;
#ifdef BUMP
varying mat4 vWorldView;varying vec3 vNormalW;
#else
varying vec3 vNormalV;
#endif
varying vec4 vViewPos;
#if defined(POSITION) || defined(BUMP)
varying vec3 vPositionW;
#endif
#if defined(VELOCITY) || defined(VELOCITY_LINEAR)
varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;
#endif
#ifdef NEED_UV
varying vec2 vUV;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;
#endif
#if defined(REFLECTIVITY)
#if defined(ORMTEXTURE) || defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)
uniform sampler2D reflectivitySampler;varying vec2 vReflectivityUV;
#else
#ifdef METALLIC_TEXTURE
uniform sampler2D metallicSampler;varying vec2 vMetallicUV;
#endif
#ifdef ROUGHNESS_TEXTURE
uniform sampler2D roughnessSampler;varying vec2 vRoughnessUV;
#endif
#endif
#ifdef ALBEDOTEXTURE
varying vec2 vAlbedoUV;uniform sampler2D albedoSampler;
#endif
#ifdef REFLECTIVITYCOLOR
uniform vec3 reflectivityColor;
#endif
#ifdef ALBEDOCOLOR
uniform vec3 albedoColor;
#endif
#ifdef METALLIC
uniform float metallic;
#endif
#if defined(ROUGHNESS) || defined(GLOSSINESS)
uniform float glossiness;
#endif
#endif
#if defined(ALPHATEST) && defined(NEED_UV)
uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
#include<mrtFragmentDeclaration>[SCENE_MRT_COUNT]
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<helperFunctions>
void main() {
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
vec3 normalOutput;
#ifdef BUMP
vec3 normalW=normalize(vNormalW);
#include<bumpFragment>
#ifdef NORMAL_WORLDSPACE
normalOutput=normalW;
#else
normalOutput=normalize(vec3(vWorldView*vec4(normalW,0.0)));
#endif
#elif defined(HAS_NORMAL_ATTRIBUTE)
normalOutput=normalize(vNormalV);
#elif defined(POSITION)
normalOutput=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));
#endif
#ifdef ENCODE_NORMAL
normalOutput=normalOutput*0.5+0.5;
#endif
#ifdef DEPTH
gl_FragData[DEPTH_INDEX]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);
#endif
#ifdef NORMAL
gl_FragData[NORMAL_INDEX]=vec4(normalOutput,1.0);
#endif
#ifdef SCREENSPACE_DEPTH
gl_FragData[SCREENSPACE_DEPTH_INDEX]=vec4(gl_FragCoord.z,0.0,0.0,1.0);
#endif
#ifdef POSITION
gl_FragData[POSITION_INDEX]=vec4(vPositionW,1.0);
#endif
#ifdef VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[VELOCITY_INDEX]=vec4(velocity,0.0,1.0);
#endif
#ifdef VELOCITY_LINEAR
vec2 velocity=vec2(0.5)*((vPreviousPosition.xy/vPreviousPosition.w) -
(vCurrentPosition.xy/vCurrentPosition.w));gl_FragData[VELOCITY_LINEAR_INDEX]=vec4(velocity,0.0,1.0);
#endif
#ifdef REFLECTIVITY
vec4 reflectivity=vec4(0.0,0.0,0.0,1.0);
#ifdef METALLICWORKFLOW
float metal=1.0;float roughness=1.0;
#ifdef ORMTEXTURE
metal*=texture2D(reflectivitySampler,vReflectivityUV).b;roughness*=texture2D(reflectivitySampler,vReflectivityUV).g;
#else
#ifdef METALLIC_TEXTURE
metal*=texture2D(metallicSampler,vMetallicUV).r;
#endif
#ifdef ROUGHNESS_TEXTURE
roughness*=texture2D(roughnessSampler,vRoughnessUV).r;
#endif
#endif
#ifdef METALLIC
metal*=metallic;
#endif
#ifdef ROUGHNESS
roughness*=(1.0-glossiness); 
#endif
reflectivity.a-=roughness;vec3 color=vec3(1.0);
#ifdef ALBEDOTEXTURE
color=texture2D(albedoSampler,vAlbedoUV).rgb;
#ifdef GAMMAALBEDO
color=toLinearSpace(color);
#endif
#endif
#ifdef ALBEDOCOLOR
color*=albedoColor.xyz;
#endif
reflectivity.rgb=mix(vec3(0.04),color,metal);
#else
#if defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)
reflectivity=texture2D(reflectivitySampler,vReflectivityUV);
#ifdef GAMMAREFLECTIVITYTEXTURE
reflectivity.rgb=toLinearSpace(reflectivity.rgb);
#endif
#else 
#ifdef REFLECTIVITYCOLOR
reflectivity.rgb=toLinearSpace(reflectivityColor.xyz);reflectivity.a=1.0;
#endif
#endif
#ifdef GLOSSINESSS
reflectivity.a*=glossiness; 
#endif
#endif
gl_FragData[REFLECTIVITY_INDEX]=reflectivity;
#endif
}
`;S.ShadersStore[Pf]||(S.ShadersStore[Pf]=rP);const jH={name:Pf,shader:rP},qH=Object.freeze(Object.defineProperty({__proto__:null,geometryPixelShader:jH},Symbol.toStringTag,{value:"Module"})),Yb="geometryVertexDeclaration",ZH="uniform mat4 viewProjection;uniform mat4 view;";S.IncludesShadersStore[Yb]||(S.IncludesShadersStore[Yb]=ZH);const jb="geometryUboDeclaration",QH=`#include<sceneUboDeclaration>
`;S.IncludesShadersStore[jb]||(S.IncludesShadersStore[jb]=QH);const Of="geometryVertexShader",sP=`precision highp float;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
#include<__decl__geometryVertex>
#include<clipPlaneVertexDeclaration>
attribute vec3 position;
#ifdef HAS_NORMAL_ATTRIBUTE
attribute vec3 normal;
#endif
#ifdef NEED_UV
varying vec2 vUV;
#ifdef ALPHATEST
uniform mat4 diffuseMatrix;
#endif
#ifdef BUMP
uniform mat4 bumpMatrix;varying vec2 vBumpUV;
#endif
#ifdef REFLECTIVITY
uniform mat4 reflectivityMatrix;uniform mat4 albedoMatrix;varying vec2 vReflectivityUV;varying vec2 vAlbedoUV;
#endif
#ifdef METALLIC_TEXTURE
varying vec2 vMetallicUV;uniform mat4 metallicMatrix;
#endif
#ifdef ROUGHNESS_TEXTURE
varying vec2 vRoughnessUV;uniform mat4 roughnessMatrix;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#ifdef BUMP
varying mat4 vWorldView;
#endif
#ifdef BUMP
varying vec3 vNormalW;
#else
varying vec3 vNormalV;
#endif
varying vec4 vViewPos;
#if defined(POSITION) || defined(BUMP)
varying vec3 vPositionW;
#endif
#if defined(VELOCITY) || defined(VELOCITY_LINEAR)
uniform mat4 previousViewProjection;varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;
#ifdef HAS_NORMAL_ATTRIBUTE
vec3 normalUpdated=normal;
#else
vec3 normalUpdated=vec3(0.0,0.0,0.0);
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#ifdef UV2
vec2 uv2Updated=uv2;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#if (defined(VELOCITY) || defined(VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=vec4(finalWorld*vec4(positionUpdated,1.0));
#ifdef BUMP
vWorldView=view*finalWorld;mat3 normalWorld=mat3(finalWorld);vNormalW=normalize(normalWorld*normalUpdated);
#else
#ifdef NORMAL_WORLDSPACE
vNormalV=normalize(vec3(finalWorld*vec4(normalUpdated,0.0)));
#else
vNormalV=normalize(vec3((view*finalWorld)*vec4(normalUpdated,0.0)));
#endif
#endif
vViewPos=view*worldPos;
#if (defined(VELOCITY) || defined(VELOCITY_LINEAR)) && defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#if NUM_BONE_INFLUENCERS>0
mat4 previousInfluence;previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
vPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);
#else
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#endif
#if defined(POSITION) || defined(BUMP)
vPositionW=worldPos.xyz/worldPos.w;
#endif
gl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#include<clipPlaneVertex>
#ifdef NEED_UV
#ifdef UV1
#if defined(ALPHATEST) && defined(ALPHATEST_UV1)
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#else
vUV=uvUpdated;
#endif
#ifdef BUMP_UV1
vBumpUV=vec2(bumpMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef REFLECTIVITY_UV1
vReflectivityUV=vec2(reflectivityMatrix*vec4(uvUpdated,1.0,0.0));
#else
#ifdef METALLIC_UV1
vMetallicUV=vec2(metallicMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef ROUGHNESS_UV1
vRoughnessUV=vec2(roughnessMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#endif
#ifdef ALBEDO_UV1
vAlbedoUV=vec2(albedoMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#endif
#ifdef UV2
#if defined(ALPHATEST) && defined(ALPHATEST_UV2)
vUV=vec2(diffuseMatrix*vec4(uv2Updated,1.0,0.0));
#else
vUV=uv2Updated;
#endif
#ifdef BUMP_UV2
vBumpUV=vec2(bumpMatrix*vec4(uv2Updated,1.0,0.0));
#endif
#ifdef REFLECTIVITY_UV2
vReflectivityUV=vec2(reflectivityMatrix*vec4(uv2Updated,1.0,0.0));
#else
#ifdef METALLIC_UV2
vMetallicUV=vec2(metallicMatrix*vec4(uv2Updated,1.0,0.0));
#endif
#ifdef ROUGHNESS_UV2
vRoughnessUV=vec2(roughnessMatrix*vec4(uv2Updated,1.0,0.0));
#endif
#endif
#ifdef ALBEDO_UV2
vAlbedoUV=vec2(albedoMatrix*vec4(uv2Updated,1.0,0.0));
#endif
#endif
#endif
#include<bumpVertex>
}
`;S.ShadersStore[Of]||(S.ShadersStore[Of]=sP);const KH={name:Of,shader:sP},JH=Object.freeze(Object.defineProperty({__proto__:null,geometryVertexShader:KH},Symbol.toStringTag,{value:"Module"})),nP=["world","mBones","viewProjection","diffuseMatrix","view","previousWorld","previousViewProjection","mPreviousBones","bumpMatrix","reflectivityMatrix","albedoMatrix","reflectivityColor","albedoColor","metallic","glossiness","vTangentSpaceParams","vBumpInfos","morphTargetInfluences","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","boneTextureWidth"];Na(nP);class Ae{get normalsAreUnsigned(){return this._normalsAreUnsigned}_linkPrePassRenderer(e){this._linkedWithPrePass=!0,this._prePassRenderer=e,this._multiRenderTarget&&(this._multiRenderTarget.onClearObservable.clear(),this._multiRenderTarget.onClearObservable.add(()=>{}))}_unlinkPrePassRenderer(){this._linkedWithPrePass=!1,this._createRenderTargets()}_resetLayout(){this._enableDepth=!0,this._enableNormal=!0,this._enablePosition=!1,this._enableReflectivity=!1,this._enableVelocity=!1,this._enableVelocityLinear=!1,this._enableScreenspaceDepth=!1,this._attachmentsFromPrePass=[]}_forceTextureType(e,t){e===Ae.POSITION_TEXTURE_TYPE?(this._positionIndex=t,this._enablePosition=!0):e===Ae.VELOCITY_TEXTURE_TYPE?(this._velocityIndex=t,this._enableVelocity=!0):e===Ae.VELOCITY_LINEAR_TEXTURE_TYPE?(this._velocityLinearIndex=t,this._enableVelocityLinear=!0):e===Ae.REFLECTIVITY_TEXTURE_TYPE?(this._reflectivityIndex=t,this._enableReflectivity=!0):e===Ae.DEPTH_TEXTURE_TYPE?(this._depthIndex=t,this._enableDepth=!0):e===Ae.NORMAL_TEXTURE_TYPE?(this._normalIndex=t,this._enableNormal=!0):e===Ae.SCREENSPACE_DEPTH_TEXTURE_TYPE&&(this._screenspaceDepthIndex=t,this._enableScreenspaceDepth=!0)}_setAttachments(e){this._attachmentsFromPrePass=e}_linkInternalTexture(e){this._multiRenderTarget.setInternalTexture(e,0,!1)}get renderList(){return this._multiRenderTarget.renderList}set renderList(e){this._multiRenderTarget.renderList=e}get isSupported(){return this._multiRenderTarget.isSupported}getTextureIndex(e){switch(e){case Ae.POSITION_TEXTURE_TYPE:return this._positionIndex;case Ae.VELOCITY_TEXTURE_TYPE:return this._velocityIndex;case Ae.VELOCITY_LINEAR_TEXTURE_TYPE:return this._velocityLinearIndex;case Ae.REFLECTIVITY_TEXTURE_TYPE:return this._reflectivityIndex;case Ae.DEPTH_TEXTURE_TYPE:return this._depthIndex;case Ae.NORMAL_TEXTURE_TYPE:return this._normalIndex;case Ae.SCREENSPACE_DEPTH_TEXTURE_TYPE:return this._screenspaceDepthIndex;default:return-1}}get enableDepth(){return this._enableDepth}set enableDepth(e){this._enableDepth=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableNormal(){return this._enableNormal}set enableNormal(e){this._enableNormal=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enablePosition(){return this._enablePosition}set enablePosition(e){this._enablePosition=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableVelocity(){return this._enableVelocity}set enableVelocity(e){this._enableVelocity=e,e||(this._previousTransformationMatrices={}),this._linkedWithPrePass||(this.dispose(),this._createRenderTargets()),this._scene.needsPreviousWorldMatrices=e}get enableVelocityLinear(){return this._enableVelocityLinear}set enableVelocityLinear(e){this._enableVelocityLinear=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableReflectivity(){return this._enableReflectivity}set enableReflectivity(e){this._enableReflectivity=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableScreenspaceDepth(){return this._enableScreenspaceDepth}set enableScreenspaceDepth(e){this._enableScreenspaceDepth=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get scene(){return this._scene}get ratio(){return typeof this._ratioOrDimensions=="object"?1:this._ratioOrDimensions}get shaderLanguage(){return this._shaderLanguage}constructor(e,t=1,i=15,r){this._previousTransformationMatrices={},this._previousBonesTransformationMatrices={},this.excludedSkinnedMeshesFromVelocity=[],this.renderTransparentMeshes=!0,this.generateNormalsInWorldSpace=!1,this._normalsAreUnsigned=!1,this._resizeObserver=null,this._enableDepth=!0,this._enableNormal=!0,this._enablePosition=!1,this._enableVelocity=!1,this._enableVelocityLinear=!1,this._enableReflectivity=!1,this._enableScreenspaceDepth=!1,this._clearColor=new Te(0,0,0,0),this._clearDepthColor=new Te(0,0,0,1),this._positionIndex=-1,this._velocityIndex=-1,this._velocityLinearIndex=-1,this._reflectivityIndex=-1,this._depthIndex=-1,this._normalIndex=-1,this._screenspaceDepthIndex=-1,this._linkedWithPrePass=!1,this.useSpecificClearForDepthTexture=!1,this._shaderLanguage=0,this._shadersLoaded=!1,this._scene=e,this._ratioOrDimensions=t,this._useUbo=e.getEngine().supportsUniformBuffers,this._depthFormat=i,this._textureTypesAndFormats=r||{},this._initShaderSourceAsync(),Ae._SceneComponentInitialization(this._scene),this._createRenderTargets()}async _initShaderSourceAsync(){this._scene.getEngine().isWebGPU&&!Ae.ForceGLSL?(this._shaderLanguage=1,await Promise.all([U(()=>Promise.resolve().then(()=>OY),void 0),U(()=>Promise.resolve().then(()=>AY),void 0)])):await Promise.all([U(()=>Promise.resolve().then(()=>JH),void 0),U(()=>Promise.resolve().then(()=>qH),void 0)]),this._shadersLoaded=!0}isReady(e,t){if(!this._shadersLoaded)return!1;const i=e.getMaterial();if(i&&i.disableDepthWrite)return!1;const r=[],n=[M.PositionKind],a=e.getMesh();a.isVerticesDataPresent(M.NormalKind)&&(r.push("#define HAS_NORMAL_ATTRIBUTE"),n.push(M.NormalKind));let l=!1,c=!1;const u=!1;if(i){let v=!1;if(i.needAlphaTestingForMesh(a)&&i.getAlphaTestTexture()&&(r.push("#define ALPHATEST"),r.push(`#define ALPHATEST_UV${i.getAlphaTestTexture().coordinatesIndex+1}`),v=!0),(i.bumpTexture||i.normalTexture||i.geometryNormalTexture)&&K.BumpTextureEnabled){const E=i.bumpTexture||i.normalTexture||i.geometryNormalTexture;r.push("#define BUMP"),r.push(`#define BUMP_UV${E.coordinatesIndex+1}`),v=!0}if(this._enableReflectivity){let E=!1;if(i.getClassName()==="PBRMetallicRoughnessMaterial")i.metallicRoughnessTexture&&(r.push("#define ORMTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.metallicRoughnessTexture.coordinatesIndex+1}`),r.push("#define METALLICWORKFLOW"),v=!0,E=!0),i.metallic!=null&&(r.push("#define METALLIC"),r.push("#define METALLICWORKFLOW"),E=!0),i.roughness!=null&&(r.push("#define ROUGHNESS"),r.push("#define METALLICWORKFLOW"),E=!0),E&&(i.baseTexture&&(r.push("#define ALBEDOTEXTURE"),r.push(`#define ALBEDO_UV${i.baseTexture.coordinatesIndex+1}`),i.baseTexture.gammaSpace&&r.push("#define GAMMAALBEDO"),v=!0),i.baseColor&&r.push("#define ALBEDOCOLOR"));else if(i.getClassName()==="PBRSpecularGlossinessMaterial")i.specularGlossinessTexture?(r.push("#define SPECULARGLOSSINESSTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.specularGlossinessTexture.coordinatesIndex+1}`),v=!0,i.specularGlossinessTexture.gammaSpace&&r.push("#define GAMMAREFLECTIVITYTEXTURE")):i.specularColor&&r.push("#define REFLECTIVITYCOLOR"),i.glossiness!=null&&r.push("#define GLOSSINESS");else if(i.getClassName()==="PBRMaterial")i.metallicTexture&&(r.push("#define ORMTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.metallicTexture.coordinatesIndex+1}`),r.push("#define METALLICWORKFLOW"),v=!0,E=!0),i.metallic!=null&&(r.push("#define METALLIC"),r.push("#define METALLICWORKFLOW"),E=!0),i.roughness!=null&&(r.push("#define ROUGHNESS"),r.push("#define METALLICWORKFLOW"),E=!0),E?(i.albedoTexture&&(r.push("#define ALBEDOTEXTURE"),r.push(`#define ALBEDO_UV${i.albedoTexture.coordinatesIndex+1}`),i.albedoTexture.gammaSpace&&r.push("#define GAMMAALBEDO"),v=!0),i.albedoColor&&r.push("#define ALBEDOCOLOR")):(i.reflectivityTexture?(r.push("#define SPECULARGLOSSINESSTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.reflectivityTexture.coordinatesIndex+1}`),i.reflectivityTexture.gammaSpace&&r.push("#define GAMMAREFLECTIVITYTEXTURE"),v=!0):i.reflectivityColor&&r.push("#define REFLECTIVITYCOLOR"),i.microSurface!=null&&r.push("#define GLOSSINESS"));else if(i.getClassName()==="StandardMaterial")i.specularTexture&&(r.push("#define REFLECTIVITYTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.specularTexture.coordinatesIndex+1}`),i.specularTexture.gammaSpace&&r.push("#define GAMMAREFLECTIVITYTEXTURE"),v=!0),i.specularColor&&r.push("#define REFLECTIVITYCOLOR");else if(i.getClassName()==="OpenPBRMaterial"){const T=i;r.push("#define METALLICWORKFLOW"),E=!0,r.push("#define METALLIC"),r.push("#define ROUGHNESS"),T._useRoughnessFromMetallicTextureGreen&&T.baseMetalnessTexture?(r.push("#define ORMTEXTURE"),r.push(`#define REFLECTIVITY_UV${T.baseMetalnessTexture.coordinatesIndex+1}`),v=!0):T.baseMetalnessTexture?(r.push("#define METALLIC_TEXTURE"),r.push(`#define METALLIC_UV${T.baseMetalnessTexture.coordinatesIndex+1}`),v=!0):T.specularRoughnessTexture&&(r.push("#define ROUGHNESS_TEXTURE"),r.push(`#define ROUGHNESS_UV${T.specularRoughnessTexture.coordinatesIndex+1}`),v=!0),T.baseColorTexture&&(r.push("#define ALBEDOTEXTURE"),r.push(`#define ALBEDO_UV${T.baseColorTexture.coordinatesIndex+1}`),T.baseColorTexture.gammaSpace&&r.push("#define GAMMAALBEDO"),v=!0),T.baseColor&&r.push("#define ALBEDOCOLOR")}}v&&(r.push("#define NEED_UV"),a.isVerticesDataPresent(M.UVKind)&&(n.push(M.UVKind),r.push("#define UV1"),l=!0),a.isVerticesDataPresent(M.UV2Kind)&&(n.push(M.UV2Kind),r.push("#define UV2"),c=!0))}this._enableDepth&&(r.push("#define DEPTH"),r.push("#define DEPTH_INDEX "+this._depthIndex)),this._enableNormal&&(r.push("#define NORMAL"),r.push("#define NORMAL_INDEX "+this._normalIndex)),this._enablePosition&&(r.push("#define POSITION"),r.push("#define POSITION_INDEX "+this._positionIndex)),this._enableVelocity&&(r.push("#define VELOCITY"),r.push("#define VELOCITY_INDEX "+this._velocityIndex),this.excludedSkinnedMeshesFromVelocity.indexOf(a)===-1&&r.push("#define BONES_VELOCITY_ENABLED")),this._enableVelocityLinear&&(r.push("#define VELOCITY_LINEAR"),r.push("#define VELOCITY_LINEAR_INDEX "+this._velocityLinearIndex),this.excludedSkinnedMeshesFromVelocity.indexOf(a)===-1&&r.push("#define BONES_VELOCITY_ENABLED")),this._enableReflectivity&&(r.push("#define REFLECTIVITY"),r.push("#define REFLECTIVITY_INDEX "+this._reflectivityIndex)),this._enableScreenspaceDepth&&this._screenspaceDepthIndex!==-1&&(r.push("#define SCREENSPACE_DEPTH_INDEX "+this._screenspaceDepthIndex),r.push("#define SCREENSPACE_DEPTH")),this.generateNormalsInWorldSpace&&r.push("#define NORMAL_WORLDSPACE"),this._normalsAreUnsigned&&r.push("#define ENCODE_NORMAL"),a.useBones&&a.computeBonesUsingShaders&&a.skeleton?(n.push(M.MatricesIndicesKind),n.push(M.MatricesWeightsKind),a.numBoneInfluencers>4&&(n.push(M.MatricesIndicesExtraKind),n.push(M.MatricesWeightsExtraKind)),r.push("#define NUM_BONE_INFLUENCERS "+a.numBoneInfluencers),r.push("#define BONETEXTURE "+a.skeleton.isUsingTextureForMatrices),r.push("#define BonesPerMesh "+(a.skeleton.bones.length+1))):(r.push("#define NUM_BONE_INFLUENCERS 0"),r.push("#define BONETEXTURE false"),r.push("#define BonesPerMesh 0"));const h=a.morphTargetManager?Eu(a.morphTargetManager,r,n,a,!0,!0,!1,l,c,u):0;t&&(r.push("#define INSTANCES"),Tu(n,this._enableVelocity||this._enableVelocityLinear),e.getRenderingMesh().hasThinInstances&&r.push("#define THIN_INSTANCES")),this._linkedWithPrePass?r.push("#define SCENE_MRT_COUNT "+this._attachmentsFromPrePass.length):r.push("#define SCENE_MRT_COUNT "+this._multiRenderTarget.textures.length),Vm(i,this._scene,r);const d=this._scene.getEngine(),f=e._getDrawWrapper(void 0,!0),m=f.defines,g=r.join(`
`);return m!==g&&f.setEffect(d.createEffect("geometry",{attributes:n,uniformsNames:nP,samplers:["diffuseSampler","bumpSampler","reflectivitySampler","albedoSampler","morphTargets","boneSampler"],defines:g,onCompiled:null,fallbacks:null,onError:null,uniformBuffersNames:["Scene"],indexParameters:{buffersCount:this._multiRenderTarget.textures.length-1,maxSimultaneousMorphTargets:h},shaderLanguage:this.shaderLanguage},d),g),f.effect.isReady()}getGBuffer(){return this._multiRenderTarget}get samples(){return this._multiRenderTarget.samples}set samples(e){this._multiRenderTarget.samples=e}dispose(){this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.getGBuffer().dispose()}_assignRenderTargetIndices(){const e=[],t=[];let i=0;return this._enableDepth&&(this._depthIndex=i,i++,e.push("gBuffer_Depth"),t.push(this._textureTypesAndFormats[Ae.DEPTH_TEXTURE_TYPE])),this._enableNormal&&(this._normalIndex=i,i++,e.push("gBuffer_Normal"),t.push(this._textureTypesAndFormats[Ae.NORMAL_TEXTURE_TYPE])),this._enablePosition&&(this._positionIndex=i,i++,e.push("gBuffer_Position"),t.push(this._textureTypesAndFormats[Ae.POSITION_TEXTURE_TYPE])),this._enableVelocity&&(this._velocityIndex=i,i++,e.push("gBuffer_Velocity"),t.push(this._textureTypesAndFormats[Ae.VELOCITY_TEXTURE_TYPE])),this._enableVelocityLinear&&(this._velocityLinearIndex=i,i++,e.push("gBuffer_VelocityLinear"),t.push(this._textureTypesAndFormats[Ae.VELOCITY_LINEAR_TEXTURE_TYPE])),this._enableReflectivity&&(this._reflectivityIndex=i,i++,e.push("gBuffer_Reflectivity"),t.push(this._textureTypesAndFormats[Ae.REFLECTIVITY_TEXTURE_TYPE])),this._enableScreenspaceDepth&&(this._screenspaceDepthIndex=i,i++,e.push("gBuffer_ScreenspaceDepth"),t.push(this._textureTypesAndFormats[Ae.SCREENSPACE_DEPTH_TEXTURE_TYPE])),[i,e,t]}_createRenderTargets(){const e=this._scene.getEngine(),[t,i,r]=this._assignRenderTargetIndices();let n=0;e._caps.textureFloat&&e._caps.textureFloatLinearFiltering?n=1:e._caps.textureHalfFloat&&e._caps.textureHalfFloatLinearFiltering&&(n=2);const a=this._ratioOrDimensions.width!==void 0?this._ratioOrDimensions:{width:e.getRenderWidth()*this._ratioOrDimensions,height:e.getRenderHeight()*this._ratioOrDimensions},o=[],l=[];for(const v of r)v?(o.push(v.textureType),l.push(v.textureFormat)):(o.push(n),l.push(5));if(this._normalsAreUnsigned=o[Ae.NORMAL_TEXTURE_TYPE]===11||o[Ae.NORMAL_TEXTURE_TYPE]===13,this._multiRenderTarget=new da("gBuffer",a,t,this._scene,{generateMipMaps:!1,generateDepthTexture:!0,types:o,formats:l,depthTextureFormat:this._depthFormat},i.concat("gBuffer_DepthBuffer")),!this.isSupported)return;this._multiRenderTarget.wrapU=$.CLAMP_ADDRESSMODE,this._multiRenderTarget.wrapV=$.CLAMP_ADDRESSMODE,this._multiRenderTarget.refreshRate=1,this._multiRenderTarget.renderParticles=!1,this._multiRenderTarget.renderList=null;const c=[!0],u=[!1],h=[!0];for(let v=1;v<t;++v)c.push(!0),h.push(!1),u.push(!0);const d=e.buildTextureLayout(c),f=e.buildTextureLayout(u),m=e.buildTextureLayout(h);this._multiRenderTarget.onClearObservable.add(v=>{v.bindAttachments(this.useSpecificClearForDepthTexture?f:d),v.clear(this._clearColor,!0,!0,!0),this.useSpecificClearForDepthTexture&&(v.bindAttachments(m),v.clear(this._clearDepthColor,!0,!0,!0)),v.bindAttachments(d)}),this._resizeObserver=e.onResizeObservable.add(()=>{if(this._multiRenderTarget){const v=this._ratioOrDimensions.width!==void 0?this._ratioOrDimensions:{width:e.getRenderWidth()*this._ratioOrDimensions,height:e.getRenderHeight()*this._ratioOrDimensions};this._multiRenderTarget.resize(v)}});const g=v=>{const E=v.getRenderingMesh(),T=v.getEffectiveMesh(),C=this._scene,A=C.getEngine(),I=v.getMaterial();if(!I)return;if(T._internalAbstractMeshDataInfo._isActiveIntermediate=!1,(this._enableVelocity||this._enableVelocityLinear)&&!this._previousTransformationMatrices[T.uniqueId]&&(this._previousTransformationMatrices[T.uniqueId]={world:z.Identity(),viewProjection:C.getTransformMatrix()},E.skeleton)){const w=E.skeleton.getTransformMatrices(E);this._previousBonesTransformationMatrices[E.uniqueId]=this._copyBonesTransformationMatrices(w,new Float32Array(w.length))}const F=E._getInstancesRenderList(v._id,!!v.getReplacementMesh());if(F.mustReturn)return;const V=A.getCaps().instancedArrays&&(F.visibleInstances[v._id]!==null||E.hasThinInstances),D=T.getWorldMatrix();if(this.isReady(v,V)){const w=v._getDrawWrapper();if(!w)return;const B=w.effect;A.enableEffect(w),V||E._bind(v,B,I.fillMode),this._useUbo?(iM(B,this._scene.getSceneUniformBuffer()),this._scene.finalizeSceneUbo()):(B.setMatrix("viewProjection",C.getTransformMatrix()),B.setMatrix("view",C.getViewMatrix()));let Q;if(!E._instanceDataStorage.isFrozen&&(I.backFaceCulling||I.sideOrientation!==null)){const re=T._getWorldMatrixDeterminant();Q=I._getEffectiveOrientation(E),re<0&&(Q=Q===Le.ClockWiseSideOrientation?Le.CounterClockWiseSideOrientation:Le.ClockWiseSideOrientation)}else Q=E._effectiveSideOrientation;if(I._preBind(w,Q),I.needAlphaTestingForMesh(T)){const re=I.getAlphaTestTexture();re&&(B.setTexture("diffuseSampler",re),B.setMatrix("diffuseMatrix",re.getTextureMatrix()))}if((I.bumpTexture||I.normalTexture||I.geometryNormalTexture)&&C.getEngine().getCaps().standardDerivatives&&K.BumpTextureEnabled){const re=I.bumpTexture||I.normalTexture||I.geometryNormalTexture;B.setFloat3("vBumpInfos",re.coordinatesIndex,1/re.level,I.parallaxScaleBias),B.setMatrix("bumpMatrix",re.getTextureMatrix()),B.setTexture("bumpSampler",re),B.setFloat2("vTangentSpaceParams",I.invertNormalMapX?-1:1,I.invertNormalMapY?-1:1)}if(this._enableReflectivity){if(I.getClassName()==="PBRMetallicRoughnessMaterial")I.metallicRoughnessTexture!==null&&(B.setTexture("reflectivitySampler",I.metallicRoughnessTexture),B.setMatrix("reflectivityMatrix",I.metallicRoughnessTexture.getTextureMatrix())),I.metallic!==null&&B.setFloat("metallic",I.metallic),I.roughness!==null&&B.setFloat("glossiness",1-I.roughness),I.baseTexture!==null&&(B.setTexture("albedoSampler",I.baseTexture),B.setMatrix("albedoMatrix",I.baseTexture.getTextureMatrix())),I.baseColor!==null&&B.setColor3("albedoColor",I.baseColor);else if(I.getClassName()==="PBRSpecularGlossinessMaterial")I.specularGlossinessTexture!==null?(B.setTexture("reflectivitySampler",I.specularGlossinessTexture),B.setMatrix("reflectivityMatrix",I.specularGlossinessTexture.getTextureMatrix())):I.specularColor!==null&&B.setColor3("reflectivityColor",I.specularColor),I.glossiness!==null&&B.setFloat("glossiness",I.glossiness);else if(I.getClassName()==="PBRMaterial")I.metallicTexture!==null&&(B.setTexture("reflectivitySampler",I.metallicTexture),B.setMatrix("reflectivityMatrix",I.metallicTexture.getTextureMatrix())),I.metallic!==null&&B.setFloat("metallic",I.metallic),I.roughness!==null&&B.setFloat("glossiness",1-I.roughness),I.roughness!==null||I.metallic!==null||I.metallicTexture!==null?(I.albedoTexture!==null&&(B.setTexture("albedoSampler",I.albedoTexture),B.setMatrix("albedoMatrix",I.albedoTexture.getTextureMatrix())),I.albedoColor!==null&&B.setColor3("albedoColor",I.albedoColor)):(I.reflectivityTexture!==null?(B.setTexture("reflectivitySampler",I.reflectivityTexture),B.setMatrix("reflectivityMatrix",I.reflectivityTexture.getTextureMatrix())):I.reflectivityColor!==null&&B.setColor3("reflectivityColor",I.reflectivityColor),I.microSurface!==null&&B.setFloat("glossiness",I.microSurface));else if(I.getClassName()==="StandardMaterial")I.specularTexture!==null&&(B.setTexture("reflectivitySampler",I.specularTexture),B.setMatrix("reflectivityMatrix",I.specularTexture.getTextureMatrix())),I.specularColor!==null&&B.setColor3("reflectivityColor",I.specularColor);else if(I.getClassName()==="OpenPBRMaterial"){const re=I;re._useRoughnessFromMetallicTextureGreen&&re.baseMetalnessTexture?(B.setTexture("reflectivitySampler",re.baseMetalnessTexture),B.setMatrix("reflectivityMatrix",re.baseMetalnessTexture.getTextureMatrix())):re.baseMetalnessTexture?(B.setTexture("metallicSampler",re.baseMetalnessTexture),B.setMatrix("metallicMatrix",re.baseMetalnessTexture.getTextureMatrix())):re.specularRoughnessTexture&&(B.setTexture("roughnessSampler",re.specularRoughnessTexture),B.setMatrix("roughnessMatrix",re.specularRoughnessTexture.getTextureMatrix())),B.setFloat("metallic",re.baseMetalness),B.setFloat("glossiness",1-re.specularRoughness),re.baseColorTexture!==null&&(B.setTexture("albedoSampler",re.baseColorTexture),B.setMatrix("albedoMatrix",re.baseColorTexture.getTextureMatrix())),re.baseColor!==null&&B.setColor3("albedoColor",re.baseColor)}}if(jn(B,I,this._scene),E.useBones&&E.computeBonesUsingShaders&&E.skeleton){const re=E.skeleton;if(re.isUsingTextureForMatrices&&B.getUniformIndex("boneTextureWidth")>-1){const ne=re.getTransformMatrixTexture(E);B.setTexture("boneSampler",ne),B.setFloat("boneTextureWidth",4*(re.bones.length+1))}else B.setMatrices("mBones",E.skeleton.getTransformMatrices(E));(this._enableVelocity||this._enableVelocityLinear)&&B.setMatrices("mPreviousBones",this._previousBonesTransformationMatrices[E.uniqueId])}Da(E,B),E.morphTargetManager&&E.morphTargetManager.isUsingTextureForTargets&&E.morphTargetManager._bind(B),(this._enableVelocity||this._enableVelocityLinear)&&(B.setMatrix("previousWorld",this._previousTransformationMatrices[T.uniqueId].world),B.setMatrix("previousViewProjection",this._previousTransformationMatrices[T.uniqueId].viewProjection)),V&&E.hasThinInstances&&B.setMatrix("world",D),E._processRendering(T,v,B,I.fillMode,F,V,(re,ne)=>{re||B.setMatrix("world",ne)})}(this._enableVelocity||this._enableVelocityLinear)&&(this._previousTransformationMatrices[T.uniqueId].world=D.clone(),this._previousTransformationMatrices[T.uniqueId].viewProjection=this._scene.getTransformMatrix().clone(),E.skeleton&&this._copyBonesTransformationMatrices(E.skeleton.getTransformMatrices(E),this._previousBonesTransformationMatrices[T.uniqueId]))};this._multiRenderTarget.customIsReadyFunction=(v,E,T)=>{if((T||E===0)&&v.subMeshes)for(let C=0;C<v.subMeshes.length;++C){const A=v.subMeshes[C],I=A.getMaterial(),F=A.getRenderingMesh();if(!I)continue;const V=F._getInstancesRenderList(A._id,!!A.getReplacementMesh()),D=e.getCaps().instancedArrays&&(V.visibleInstances[A._id]!==null||F.hasThinInstances);if(!this.isReady(A,D))return!1}return!0},this._multiRenderTarget.customRenderFunction=(v,E,T,C)=>{let A;if(this._linkedWithPrePass){if(!this._prePassRenderer.enabled)return;this._scene.getEngine().bindAttachments(this._attachmentsFromPrePass)}if(C.length){for(e.setColorWrite(!1),A=0;A<C.length;A++)g(C.data[A]);e.setColorWrite(!0)}for(A=0;A<v.length;A++)g(v.data[A]);for(e.setDepthWrite(!1),A=0;A<E.length;A++)g(E.data[A]);if(this.renderTransparentMeshes)for(A=0;A<T.length;A++)g(T.data[A]);e.setDepthWrite(!0)}}_copyBonesTransformationMatrices(e,t){for(let i=0;i<e.length;i++)t[i]=e[i];return t}}Ae.ForceGLSL=!1;Ae.DEPTH_TEXTURE_TYPE=0;Ae.NORMAL_TEXTURE_TYPE=1;Ae.POSITION_TEXTURE_TYPE=2;Ae.VELOCITY_TEXTURE_TYPE=3;Ae.REFLECTIVITY_TEXTURE_TYPE=4;Ae.SCREENSPACE_DEPTH_TEXTURE_TYPE=5;Ae.VELOCITY_LINEAR_TEXTURE_TYPE=6;Ae._SceneComponentInitialization=s=>{throw Ys("GeometryBufferRendererSceneComponent")};class e${constructor(){this.enabled=!1,this.name="motionBlur",this.texturesRequired=[2]}}Object.defineProperty(le.prototype,"geometryBufferRenderer",{get:function(){return this._geometryBufferRenderer},set:function(s){s&&s.isSupported&&(this._geometryBufferRenderer=s)},enumerable:!0,configurable:!0});le.prototype.enableGeometryBufferRenderer=function(s=1,e=15,t){return this._geometryBufferRenderer?this._geometryBufferRenderer:(this._geometryBufferRenderer=new Ae(this,s,e,t),this._geometryBufferRenderer.isSupported||(this._geometryBufferRenderer=null),this._geometryBufferRenderer)};le.prototype.disableGeometryBufferRenderer=function(){this._geometryBufferRenderer&&(this._geometryBufferRenderer.dispose(),this._geometryBufferRenderer=null)};class t${constructor(e){this.name=se.NAME_GEOMETRYBUFFERRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(se.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER,this,this._gatherRenderTargets)}rebuild(){}dispose(){}_gatherRenderTargets(e){this.scene._geometryBufferRenderer&&e.push(this.scene._geometryBufferRenderer.getGBuffer())}}Ae._SceneComponentInitialization=s=>{let e=s._getComponent(se.NAME_GEOMETRYBUFFERRENDERER);e||(e=new t$(s),s._addComponent(e))};class za extends Se{get motionStrength(){return this._effectWrapper.motionStrength}set motionStrength(e){this._effectWrapper.motionStrength=e}get motionBlurSamples(){return this._effectWrapper.motionBlurSamples}set motionBlurSamples(e){this._effectWrapper.motionBlurSamples=e}get isObjectBased(){return this._effectWrapper.isObjectBased}set isObjectBased(e){this.isObjectBased!==e&&(this._effectWrapper.isObjectBased=e,this._applyMode())}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._forcedGeometryBuffer??this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}getClassName(){return"MotionBlurPostProcess"}constructor(e,t,i,r,n,a,o,l=0,c=!1,u=!1){const h={uniforms:ji.Uniforms,samplers:ji.Samplers,defines:ji.Defines,size:typeof i=="number"?i:void 0,camera:r,samplingMode:n,engine:a,reusable:o,textureType:l,blockCompilation:c,...i};super(e,ji.FragmentUrl,{effectWrapper:typeof i=="number"||!i.effectWrapper?new ji(e,t,h):void 0,...h}),this._forcedGeometryBuffer=null,this._forceGeometryBuffer=!1,u instanceof Ae?(this._forceGeometryBuffer=!0,this._forcedGeometryBuffer=u):this._forceGeometryBuffer=u,this._forceGeometryBuffer?(this._forcedGeometryBuffer||t.enableGeometryBufferRenderer(),this._geometryBufferRenderer&&(this._geometryBufferRenderer.enableVelocity=this.isObjectBased)):(t.enablePrePassRenderer(),this._prePassRenderer&&(this._prePassRenderer.markAsDirty(),this._prePassEffectConfiguration=new e$)),this._applyMode()}excludeSkinnedMesh(e){if(e.skeleton){let t;if(this._geometryBufferRenderer)t=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else if(this._prePassRenderer)t=this._prePassRenderer.excludedSkinnedMesh;else return;t.push(e)}}removeExcludedSkinnedMesh(e){if(e.skeleton){let t;if(this._geometryBufferRenderer)t=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else if(this._prePassRenderer)t=this._prePassRenderer.excludedSkinnedMesh;else return;const i=t.indexOf(e);i!==-1&&t.splice(i,1)}}dispose(e){this._geometryBufferRenderer&&!this._forcedGeometryBuffer&&(this._geometryBufferRenderer._previousTransformationMatrices={},this._geometryBufferRenderer._previousBonesTransformationMatrices={},this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity=[]),super.dispose(e)}_applyMode(){if(!this._geometryBufferRenderer&&!this._prePassRenderer){N.Warn("Multiple Render Target support needed to compute object based motion blur");return}this._geometryBufferRenderer&&(this._geometryBufferRenderer.enableVelocity=this.isObjectBased),this.isObjectBased?(this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=2),this.onApply=e=>this._onApplyObjectBased(e)):(this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=5),this.onApply=e=>this._onApplyScreenBased(e))}_onApplyObjectBased(e){if(this._effectWrapper.textureWidth=this.width,this._effectWrapper.textureHeight=this.height,this._geometryBufferRenderer){const t=this._geometryBufferRenderer.getTextureIndex(Ae.VELOCITY_TEXTURE_TYPE);e.setTexture("velocitySampler",this._geometryBufferRenderer.getGBuffer().textures[t])}else if(this._prePassRenderer){const t=this._prePassRenderer.getIndex(2);e.setTexture("velocitySampler",this._prePassRenderer.getRenderTarget().textures[t])}}_onApplyScreenBased(e){if(this._effectWrapper.textureWidth=this.width,this._effectWrapper.textureHeight=this.height,this._geometryBufferRenderer){const t=this._geometryBufferRenderer.getTextureIndex(Ae.DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[t])}else if(this._prePassRenderer){const t=this._prePassRenderer.getIndex(5);e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[t])}}static _Parse(e,t,i,r){return me.Parse(()=>new za(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,!1),e,i,r)}}_([R()],za.prototype,"motionStrength",null);_([R()],za.prototype,"motionBlurSamples",null);_([R()],za.prototype,"isObjectBased",null);y("BABYLON.MotionBlurPostProcess",za);const qb="refractionPixelShader",i$="varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D refractionSampler;uniform vec3 baseColor;uniform float depth;uniform float colorLevel;void main() {float ref=1.0-texture2D(refractionSampler,vUV).r;vec2 uv=vUV-vec2(0.5);vec2 offset=uv*depth*ref;vec3 sourceColor=texture2D(textureSampler,vUV-offset).rgb;gl_FragColor=vec4(sourceColor+sourceColor*ref*colorLevel,1.0);}";S.ShadersStore[qb]||(S.ShadersStore[qb]=i$);class Wa extends Se{get refractionTexture(){return this._refTexture}set refractionTexture(e){this._refTexture&&this._ownRefractionTexture&&this._refTexture.dispose(),this._refTexture=e,this._ownRefractionTexture=!1}getClassName(){return"RefractionPostProcess"}constructor(e,t,i,r,n,a,o,l,c,u){super(e,"refraction",["baseColor","depth","colorLevel"],["refractionSampler"],a,o,l,c,u),this._ownRefractionTexture=!0,this.color=i,this.depth=r,this.colorLevel=n,this.refractionTextureUrl=t,this.onActivateObservable.add(h=>{this._refTexture=this._refTexture||new $(t,h.getScene())}),this.onApplyObservable.add(h=>{h.setColor3("baseColor",this.color),h.setFloat("depth",this.depth),h.setFloat("colorLevel",this.colorLevel),h.setTexture("refractionSampler",this._refTexture)})}dispose(e){this._refTexture&&this._ownRefractionTexture&&(this._refTexture.dispose(),this._refTexture=null),super.dispose(e)}static _Parse(e,t,i,r){return me.Parse(()=>new Wa(e.name,e.refractionTextureUrl,e.color,e.depth,e.colorLevel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}}_([R()],Wa.prototype,"color",void 0);_([R()],Wa.prototype,"depth",void 0);_([R()],Wa.prototype,"colorLevel",void 0);_([R()],Wa.prototype,"refractionTextureUrl",void 0);y("BABYLON.RefractionPostProcess",Wa);const Nf="sharpenPixelShader",aP=`varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform vec2 sharpnessAmounts;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec2 onePixel=vec2(1.0,1.0)/screenSize;vec4 color=texture2D(textureSampler,vUV);vec4 edgeDetection=texture2D(textureSampler,vUV+onePixel*vec2(0,-1)) +
texture2D(textureSampler,vUV+onePixel*vec2(-1,0)) +
texture2D(textureSampler,vUV+onePixel*vec2(1,0)) +
texture2D(textureSampler,vUV+onePixel*vec2(0,1)) -
color*4.0;gl_FragColor=max(vec4(color.rgb*sharpnessAmounts.y,color.a)-(sharpnessAmounts.x*vec4(edgeDetection.rgb,0)),0.);}`;S.ShadersStore[Nf]||(S.ShadersStore[Nf]=aP);const r$={name:Nf,shader:aP},s$=Object.freeze(Object.defineProperty({__proto__:null,sharpenPixelShader:r$},Symbol.toStringTag,{value:"Module"}));class rl extends Se{get colorAmount(){return this._effectWrapper.colorAmount}set colorAmount(e){this._effectWrapper.colorAmount=e}get edgeAmount(){return this._effectWrapper.edgeAmount}set edgeAmount(e){this._effectWrapper.edgeAmount=e}getClassName(){return"SharpenPostProcess"}constructor(e,t,i,r,n,a,o=0,l=!1){const c={uniforms:Ws.Uniforms,size:typeof t=="number"?t:void 0,camera:i,samplingMode:r,engine:n,reusable:a,textureType:o,blockCompilation:l,...t};super(e,Ws.FragmentUrl,{effectWrapper:typeof t=="number"||!t.effectWrapper?new Ws(e,n,c):void 0,...c}),this.onApply=u=>{this._effectWrapper.textureWidth=this.width,this._effectWrapper.textureHeight=this.height}}static _Parse(e,t,i,r){return me.Parse(()=>new rl(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable),e,i,r)}}_([R()],rl.prototype,"colorAmount",null);_([R()],rl.prototype,"edgeAmount",null);y("BABYLON.SharpenPostProcess",rl);class Ha{get name(){return this._name}get cameras(){return this._cameras}get engine(){return this._engine}constructor(e,t){this._engine=e,this.uniqueId=bn.UniqueId,this._name=t,this._renderEffects={},this._renderEffectsForIsolatedPass=new Array,this._cameras=[]}getClassName(){return"PostProcessRenderPipeline"}get isSupported(){for(const e in this._renderEffects)if(Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&!this._renderEffects[e].isSupported)return!1;return!0}addEffect(e){this._renderEffects[e._name]=e}_rebuild(){}_enableEffect(e,t){const i=this._renderEffects[e];i&&i._enable(j.MakeArray(t||this._cameras))}_disableEffect(e,t){const i=this._renderEffects[e];i&&i._disable(j.MakeArray(t||this._cameras))}_attachCameras(e,t){const i=j.MakeArray(e||this._cameras);if(!i)return;const r=[];let n;for(n=0;n<i.length;n++){const a=i[n];a&&(this._cameras.indexOf(a)===-1?this._cameras.push(a):t&&r.push(n))}for(n=0;n<r.length;n++)i.splice(r[n],1);for(const a in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,a)&&this._renderEffects[a]._attachCameras(i)}_detachCameras(e){const t=j.MakeArray(e||this._cameras);if(t){for(const i in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,i)&&this._renderEffects[i]._detachCameras(t);for(let i=0;i<t.length;i++)this._cameras.splice(this._cameras.indexOf(t[i]),1)}}_update(){for(const e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._update();for(let e=0;e<this._cameras.length;e++){if(!this._cameras[e])continue;const t=this._cameras[e].name;this._renderEffectsForIsolatedPass[t]&&this._renderEffectsForIsolatedPass[t]._update()}}_reset(){this._renderEffects={},this._renderEffectsForIsolatedPass=new Array}_enableMSAAOnFirstPostProcess(e){if(!this._engine._features.supportMSAA)return!1;const t=Object.keys(this._renderEffects);if(t.length>0){const i=this._renderEffects[t[0]].getPostProcesses();i&&(i[0].samples=e)}return!0}_adaptPostProcessesToViewPort(){const e=Object.keys(this._renderEffects);for(const t of e){const i=this._renderEffects[t].getPostProcesses();if(i)for(const r of i)r.adaptScaleToCurrentViewport=!0}}setPrePassRenderer(e){return!1}dispose(){}}_([R()],Ha.prototype,"_name",void 0);class n${constructor(){this._renderPipelines={},this._onNewPipelineAddedObservable=new k,this._onPipelineRemovedObservable=new k}get onNewPipelineAddedObservable(){return this._onNewPipelineAddedObservable}get onPipelineRemovedObservable(){return this._onPipelineRemovedObservable}get supportedPipelines(){const e=[];for(const t in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,t)){const i=this._renderPipelines[t];i.isSupported&&e.push(i)}return e}addPipeline(e){this.removePipeline(e._name),this._renderPipelines[e._name]=e,this._onNewPipelineAddedObservable.notifyObservers(e)}removePipeline(e){const t=this._renderPipelines[e];t&&(this._onPipelineRemovedObservable.notifyObservers(t),delete this._renderPipelines[e])}attachCamerasToRenderPipeline(e,t,i=!1){const r=this._renderPipelines[e];r&&r._attachCameras(t,i)}detachCamerasFromRenderPipeline(e,t){const i=this._renderPipelines[e];i&&i._detachCameras(t)}enableEffectInPipeline(e,t,i){const r=this._renderPipelines[e];r&&r._enableEffect(t,i)}disableEffectInPipeline(e,t,i){const r=this._renderPipelines[e];r&&r._disableEffect(t,i)}update(){for(const e in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,e)){const t=this._renderPipelines[e];t.isSupported?t._update():(t.dispose(),delete this._renderPipelines[e])}}_rebuild(){for(const e in this._renderPipelines)Object.prototype.hasOwnProperty.call(this._renderPipelines,e)&&this._renderPipelines[e]._rebuild()}dispose(){for(const e in this._renderPipelines)Object.prototype.hasOwnProperty.call(this._renderPipelines,e)&&this._renderPipelines[e].dispose()}}Object.defineProperty(le.prototype,"postProcessRenderPipelineManager",{get:function(){if(!this._postProcessRenderPipelineManager){let s=this._getComponent(se.NAME_POSTPROCESSRENDERPIPELINEMANAGER);s||(s=new a$(this),this._addComponent(s)),this._postProcessRenderPipelineManager=new n$}return this._postProcessRenderPipelineManager},enumerable:!0,configurable:!0});class a${constructor(e){this.name=se.NAME_POSTPROCESSRENDERPIPELINEMANAGER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(se.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER,this,this._gatherRenderTargets)}rebuild(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager._rebuild()}dispose(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.dispose()}_gatherRenderTargets(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.update()}}class yi extends Ha{get automaticBuild(){return this._buildAllowed}set automaticBuild(e){this._buildAllowed=e}get scene(){return this._scene}set sharpenEnabled(e){this._sharpenEnabled!==e&&(this._sharpenEnabled=e,this._buildPipeline())}get sharpenEnabled(){return this._sharpenEnabled}get bloomKernel(){return this._bloomKernel}set bloomKernel(e){this._bloomKernel=e,this.bloom.kernel=e/this._hardwareScaleLevel}set bloomWeight(e){this._bloomWeight!==e&&(this.bloom.weight=e,this._bloomWeight=e)}get bloomWeight(){return this._bloomWeight}set bloomThreshold(e){this._bloomThreshold!==e&&(this.bloom.threshold=e,this._bloomThreshold=e)}get bloomThreshold(){return this._bloomThreshold}set bloomScale(e){this._bloomScale!==e&&(this._bloomScale=e,this._rebuildBloom(),this._buildPipeline())}get bloomScale(){return this._bloomScale}set bloomEnabled(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())}get bloomEnabled(){return this._bloomEnabled}_rebuildBloom(){const e=this.bloom;this.bloom=new Wb(this._scene,this.bloomScale,this._bloomWeight,this.bloomKernel/this._hardwareScaleLevel,this._defaultPipelineTextureType,!1),this.bloom.threshold=e.threshold;for(let t=0;t<this._cameras.length;t++)e.disposeEffects(this._cameras[t])}get depthOfFieldEnabled(){return this._depthOfFieldEnabled}set depthOfFieldEnabled(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())}get depthOfFieldBlurLevel(){return this._depthOfFieldBlurLevel}set depthOfFieldBlurLevel(e){if(this._depthOfFieldBlurLevel===e)return;this._depthOfFieldBlurLevel=e;const t=this.depthOfField;this.depthOfField=new $b(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!1),this.depthOfField.focalLength=t.focalLength,this.depthOfField.focusDistance=t.focusDistance,this.depthOfField.fStop=t.fStop,this.depthOfField.lensSize=t.lensSize;for(let i=0;i<this._cameras.length;i++)t.disposeEffects(this._cameras[i]);this._buildPipeline()}set fxaaEnabled(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())}get fxaaEnabled(){return this._fxaaEnabled}set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}get samples(){return this._samples}set imageProcessingEnabled(e){this._imageProcessingEnabled!==e&&(this._scene.imageProcessingConfiguration.isEnabled=e)}get imageProcessingEnabled(){return this._imageProcessingEnabled}set glowLayerEnabled(e){e&&!this._glowLayer?this._glowLayer=new es("",this._scene):!e&&this._glowLayer&&(this._glowLayer.dispose(),this._glowLayer=null)}get glowLayerEnabled(){return this._glowLayer!=null}get glowLayer(){return this._glowLayer}set chromaticAberrationEnabled(e){this._chromaticAberrationEnabled!==e&&(this._chromaticAberrationEnabled=e,this._buildPipeline())}get chromaticAberrationEnabled(){return this._chromaticAberrationEnabled}set grainEnabled(e){this._grainEnabled!==e&&(this._grainEnabled=e,this._buildPipeline())}get grainEnabled(){return this._grainEnabled}constructor(e="",t=!0,i=De.LastCreatedScene,r,n=!0){super(i.getEngine(),e),this._camerasToBeAttached=[],this.SharpenPostProcessId="SharpenPostProcessEffect",this.ImageProcessingPostProcessId="ImageProcessingPostProcessEffect",this.FxaaPostProcessId="FxaaPostProcessEffect",this.ChromaticAberrationPostProcessId="ChromaticAberrationPostProcessEffect",this.GrainPostProcessId="GrainPostProcessEffect",this._glowLayer=null,this.animations=[],this._imageProcessingConfigurationObserver=null,this._sharpenEnabled=!1,this._bloomEnabled=!1,this._depthOfFieldEnabled=!1,this._depthOfFieldBlurLevel=0,this._fxaaEnabled=!1,this._imageProcessingEnabled=!0,this._bloomScale=.5,this._chromaticAberrationEnabled=!1,this._grainEnabled=!1,this._buildAllowed=!0,this.onBuildObservable=new k,this._resizeObserver=null,this._hardwareScaleLevel=1,this._bloomKernel=64,this._bloomWeight=.15,this._bloomThreshold=.9,this._samples=1,this._hasCleared=!1,this._prevPostProcess=null,this._prevPrevPostProcess=null,this._depthOfFieldSceneObserver=null,this._activeCameraChangedObserver=null,this._activeCamerasChangedObserver=null,this._cameras=r||i.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._buildAllowed=n,this._scene=i;const a=this._scene.getEngine().getCaps();this._hdr=t&&(a.textureHalfFloatRender||a.textureFloatRender),this._hdr?a.textureHalfFloatRender?this._defaultPipelineTextureType=2:a.textureFloatRender&&(this._defaultPipelineTextureType=1):this._defaultPipelineTextureType=0,i.postProcessRenderPipelineManager.addPipeline(this);const o=this._scene.getEngine();this.sharpen=new rl("sharpen",1,null,$.BILINEAR_SAMPLINGMODE,o,!1,this._defaultPipelineTextureType,!0),this._sharpenEffect=new Ye(o,this.SharpenPostProcessId,()=>this.sharpen,!0),this.depthOfField=new $b(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!0),this._hardwareScaleLevel=o.getHardwareScalingLevel(),this._resizeObserver=o.onResizeObservable.add(()=>{this._hardwareScaleLevel=o.getHardwareScalingLevel(),this.bloomKernel=this._bloomKernel}),this.bloom=new Wb(this._scene,this._bloomScale,this._bloomWeight,this.bloomKernel/this._hardwareScaleLevel,this._defaultPipelineTextureType,!0),this.chromaticAberration=new Zs("ChromaticAberration",o.getRenderWidth(),o.getRenderHeight(),1,null,$.BILINEAR_SAMPLINGMODE,o,!1,this._defaultPipelineTextureType,!0),this._chromaticAberrationEffect=new Ye(o,this.ChromaticAberrationPostProcessId,()=>this.chromaticAberration,!0),this.grain=new il("Grain",1,null,$.BILINEAR_SAMPLINGMODE,o,!1,this._defaultPipelineTextureType,!0),this._grainEffect=new Ye(o,this.GrainPostProcessId,()=>this.grain,!0);let l=!0;this._imageProcessingConfigurationObserver=this._scene.imageProcessingConfiguration.onUpdateParameters.add(()=>{this.bloom._downscale._exposure=this._scene.imageProcessingConfiguration.exposure,this.imageProcessingEnabled!==this._scene.imageProcessingConfiguration.isEnabled&&(this._imageProcessingEnabled=this._scene.imageProcessingConfiguration.isEnabled,l?j.SetImmediate(()=>{this._buildPipeline()}):this._buildPipeline())}),this._buildPipeline(),l=!1}getClassName(){return"DefaultRenderingPipeline"}prepare(){const e=this._buildAllowed;this._buildAllowed=!0,this._buildPipeline(),this._buildAllowed=e}_setAutoClearAndTextureSharing(e,t=!1){this._hasCleared?e.autoClear=!1:(e.autoClear=!0,this._scene.autoClear=!1,this._hasCleared=!0),t||(this._prevPrevPostProcess?e.shareOutputWith(this._prevPrevPostProcess):e.useOwnOutput(),this._prevPostProcess&&(this._prevPrevPostProcess=this._prevPostProcess),this._prevPostProcess=e)}_buildPipeline(){if(!this._buildAllowed)return;this._scene.autoClear=!0;const e=this._scene.getEngine();if(this._disposePostProcesses(),this._cameras!==null&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._prevPostProcess=null,this._prevPrevPostProcess=null,this._hasCleared=!1,this.depthOfFieldEnabled){if(this._cameras.length>1){for(const t of this._cameras){const i=this._scene.enableDepthRenderer(t);i.useOnlyInActiveCamera=!0}this._depthOfFieldSceneObserver=this._scene.onAfterRenderTargetsRenderObservable.add(t=>{this._cameras.indexOf(t.activeCamera)>-1&&(this.depthOfField.depthTexture=t.enableDepthRenderer(t.activeCamera).getDepthMap())})}else{this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);const t=this._scene.enableDepthRenderer(this._cameras[0]);this.depthOfField.depthTexture=t.getDepthMap()}this.depthOfField._isReady()||this.depthOfField._updateEffects(),this.addEffect(this.depthOfField),this._setAutoClearAndTextureSharing(this.depthOfField._effects[0],!0)}else this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);this.bloomEnabled&&(this.bloom._isReady()||this.bloom._updateEffects(),this.addEffect(this.bloom),this._setAutoClearAndTextureSharing(this.bloom._effects[0],!0)),this._imageProcessingEnabled&&(this.imageProcessing=new ig("imageProcessing",1,null,$.BILINEAR_SAMPLINGMODE,e,!1,this._defaultPipelineTextureType,this.scene.imageProcessingConfiguration),this._hdr?(this.addEffect(new Ye(e,this.ImageProcessingPostProcessId,()=>this.imageProcessing,!0)),this._setAutoClearAndTextureSharing(this.imageProcessing)):this._scene.imageProcessingConfiguration.applyByPostProcess=!1,(!this._cameras||this._cameras.length===0)&&(this._scene.imageProcessingConfiguration.applyByPostProcess=!1),this.imageProcessing.getEffect()||this.imageProcessing._updateParameters()),this.sharpenEnabled&&(this.sharpen.isReady()||this.sharpen.updateEffect(),this.addEffect(this._sharpenEffect),this._setAutoClearAndTextureSharing(this.sharpen)),this.grainEnabled&&(this.grain.isReady()||this.grain.updateEffect(),this.addEffect(this._grainEffect),this._setAutoClearAndTextureSharing(this.grain)),this.chromaticAberrationEnabled&&(this.chromaticAberration.isReady()||this.chromaticAberration.updateEffect(),this.addEffect(this._chromaticAberrationEffect),this._setAutoClearAndTextureSharing(this.chromaticAberration)),this.fxaaEnabled&&(this.fxaa=new el("fxaa",1,null,$.BILINEAR_SAMPLINGMODE,e,!1,this._defaultPipelineTextureType),this.addEffect(new Ye(e,this.FxaaPostProcessId,()=>this.fxaa,!0)),this._setAutoClearAndTextureSharing(this.fxaa,!0)),this._cameras!==null&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),(this._scene.activeCameras&&this._scene.activeCameras.length>1||this._scene.activeCamera&&this._cameras.indexOf(this._scene.activeCamera)===-1)&&(this._scene.autoClear=!0),this._activeCameraChangedObserver||(this._activeCameraChangedObserver=this._scene.onActiveCameraChanged.add(()=>{this._scene.activeCamera&&this._cameras.indexOf(this._scene.activeCamera)===-1&&(this._scene.autoClear=!0)})),this._activeCamerasChangedObserver||(this._activeCamerasChangedObserver=this._scene.onActiveCamerasChanged.add(()=>{this._scene.activeCameras&&this._scene.activeCameras.length>1&&(this._scene.autoClear=!0)})),this._adaptPostProcessesToViewPort(),!this._enableMSAAOnFirstPostProcess(this.samples)&&this.samples>1&&N.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0"),this.onBuildObservable.notifyObservers(this)}_disposePostProcesses(e=!1){for(let t=0;t<this._cameras.length;t++){const i=this._cameras[t];this.imageProcessing&&this.imageProcessing.dispose(i),this.fxaa&&this.fxaa.dispose(i),e&&(this.sharpen&&this.sharpen.dispose(i),this.depthOfField&&(this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver),this.depthOfField.disposeEffects(i)),this.bloom&&this.bloom.disposeEffects(i),this.chromaticAberration&&this.chromaticAberration.dispose(i),this.grain&&this.grain.dispose(i),this._glowLayer&&this._glowLayer.dispose())}this.imageProcessing=null,this.fxaa=null,e&&(this.sharpen=null,this._sharpenEffect=null,this.depthOfField=null,this.bloom=null,this.chromaticAberration=null,this._chromaticAberrationEffect=null,this.grain=null,this._grainEffect=null,this._glowLayer=null)}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){const t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(){this._buildAllowed=!1,this.onBuildObservable.clear(),this._disposePostProcesses(!0),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._scene._postProcessRenderPipelineManager.removePipeline(this.name),this._scene.autoClear=!0,this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this._scene.onActiveCameraChanged.remove(this._activeCameraChangedObserver),this._scene.onActiveCamerasChanged.remove(this._activeCamerasChangedObserver),this._scene.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigurationObserver),super.dispose()}serialize(){const e=me.Serialize(this);return e.customType="DefaultRenderingPipeline",e}static Parse(e,t,i){return me.Parse(()=>new yi(e._name,e._name._hdr,t),e,t,i)}}_([R()],yi.prototype,"sharpenEnabled",null);_([R()],yi.prototype,"bloomKernel",null);_([R()],yi.prototype,"_bloomWeight",void 0);_([R()],yi.prototype,"_bloomThreshold",void 0);_([R()],yi.prototype,"_hdr",void 0);_([R()],yi.prototype,"bloomWeight",null);_([R()],yi.prototype,"bloomThreshold",null);_([R()],yi.prototype,"bloomScale",null);_([R()],yi.prototype,"bloomEnabled",null);_([R()],yi.prototype,"depthOfFieldEnabled",null);_([R()],yi.prototype,"depthOfFieldBlurLevel",null);_([R()],yi.prototype,"fxaaEnabled",null);_([R()],yi.prototype,"samples",null);_([R()],yi.prototype,"imageProcessingEnabled",null);_([R()],yi.prototype,"glowLayerEnabled",null);_([R()],yi.prototype,"chromaticAberrationEnabled",null);_([R()],yi.prototype,"grainEnabled",null);y("BABYLON.DefaultRenderingPipeline",yi);const Df="chromaticAberrationPixelShader",oP=`uniform sampler2D textureSampler; 
uniform float chromatic_aberration;uniform float radialIntensity;uniform vec2 direction;uniform vec2 centerPosition;uniform float screen_width;uniform float screen_height;varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec2 centered_screen_pos=vec2(vUV.x-centerPosition.x,vUV.y-centerPosition.y);vec2 directionOfEffect=direction;if(directionOfEffect.x==0. && directionOfEffect.y==0.){directionOfEffect=normalize(centered_screen_pos);}
float radius2=centered_screen_pos.x*centered_screen_pos.x
+ centered_screen_pos.y*centered_screen_pos.y;float radius=sqrt(radius2);vec3 ref_indices=vec3(-0.3,0.0,0.3);float ref_shiftX=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.x/screen_width;float ref_shiftY=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.y/screen_height;vec2 ref_coords_r=vec2(vUV.x+ref_indices.r*ref_shiftX,vUV.y+ref_indices.r*ref_shiftY*0.5);vec2 ref_coords_g=vec2(vUV.x+ref_indices.g*ref_shiftX,vUV.y+ref_indices.g*ref_shiftY*0.5);vec2 ref_coords_b=vec2(vUV.x+ref_indices.b*ref_shiftX,vUV.y+ref_indices.b*ref_shiftY*0.5);vec4 r=texture2D(textureSampler,ref_coords_r);vec4 g=texture2D(textureSampler,ref_coords_g);vec4 b=texture2D(textureSampler,ref_coords_b);float a=clamp(r.a+g.a+b.a,0.,1.);gl_FragColor=vec4(r.r,g.g,b.b,a);}`;S.ShadersStore[Df]||(S.ShadersStore[Df]=oP);const o$={name:Df,shader:oP},l$=Object.freeze(Object.defineProperty({__proto__:null,chromaticAberrationPixelShader:o$},Symbol.toStringTag,{value:"Module"})),Zb="lensHighlightsPixelShader",c$=`uniform sampler2D textureSampler; 
uniform float gain;uniform float threshold;uniform float screen_width;uniform float screen_height;varying vec2 vUV;vec4 highlightColor(vec4 color) {vec4 highlight=color;float luminance=dot(highlight.rgb,vec3(0.2125,0.7154,0.0721));float lum_threshold;if (threshold>1.0) { lum_threshold=0.94+0.01*threshold; }
else { lum_threshold=0.5+0.44*threshold; }
luminance=clamp((luminance-lum_threshold)*(1.0/(1.0-lum_threshold)),0.0,1.0);highlight*=luminance*gain;highlight.a=1.0;return highlight;}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec4 original=texture2D(textureSampler,vUV);if (gain==-1.0) {gl_FragColor=vec4(0.0,0.0,0.0,1.0);return;}
float w=2.0/screen_width;float h=2.0/screen_height;float weight=1.0;vec4 blurred=vec4(0.0,0.0,0.0,0.0);
#ifdef PENTAGON
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.84*w,0.43*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.48*w,-1.29*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.61*w,1.51*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.55*w,-0.74*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.71*w,-0.52*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.94*w,1.59*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.40*w,-1.87*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.62*w,1.16*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.09*w,0.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.46*w,-1.71*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.08*w,2.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.85*w,-1.89*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.89*w,0.16*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.29*w,1.88*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.40*w,-2.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.54*w,2.26*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.60*w,-0.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.31*w,-1.30*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.83*w,2.53*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.12*w,-2.48*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.60*w,1.11*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.99*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.50*w,-2.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.85*w,3.33*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.94*w,-1.92*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.27*w,-0.53*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.95*w,2.48*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.23*w,-3.04*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.17*w,2.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.97*w,-0.04*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.25*w,-2.00*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.31*w,3.08*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.94*w,-2.59*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.37*w,0.64*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.13*w,1.93*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.03*w,-3.65*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.60*w,3.17*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.14*w,-1.19*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.00*w,-1.19*h)));
#else
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.85*w,0.36*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.52*w,-1.14*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.46*w,1.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.46*w,-0.83*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.79*w,-0.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.11*w,1.62*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.29*w,-2.07*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.69*w,1.39*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.28*w,0.12*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.65*w,-1.69*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.08*w,2.44*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.63*w,-1.90*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.55*w,0.31*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.13*w,1.52*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.56*w,-2.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.38*w,2.34*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.64*w,-0.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.53*w,-1.21*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.06*w,2.63*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.00*w,-2.69*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.59*w,1.32*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.78*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.57*w,-2.50*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.54*w,2.93*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.39*w,-1.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,-0.28*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.04*w,2.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.02*w,-3.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.09*w,2.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.07*w,-0.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.44*w,-1.90*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.52*w,3.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.68*w,-2.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,0.79*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.76*w,1.46*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.05*w,-2.94*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.21*w,2.88*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.84*w,-1.30*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.98*w,-0.96*h)));
#endif
blurred/=39.0;gl_FragColor=blurred;}`;S.ShadersStore[Zb]||(S.ShadersStore[Zb]=c$);const Qb="depthOfFieldPixelShader",u$=`uniform sampler2D textureSampler;uniform sampler2D highlightsSampler;uniform sampler2D depthSampler;uniform sampler2D grainSampler;uniform float grain_amount;uniform bool blur_noise;uniform float screen_width;uniform float screen_height;uniform float distortion;uniform bool dof_enabled;uniform float screen_distance; 
uniform float aperture;uniform float darken;uniform float edge_blur;uniform bool highlights;uniform float near;uniform float far;varying vec2 vUV;
#define PI 3.14159265
#define TWOPI 6.28318530
#define inverse_focal_length 0.1 
vec2 centered_screen_pos;vec2 distorted_coords;float radius2;float radius;vec2 rand(vec2 co)
{float noise1=(fract(sin(dot(co,vec2(12.9898,78.233)))*43758.5453));float noise2=(fract(sin(dot(co,vec2(12.9898,78.233)*2.0))*43758.5453));return clamp(vec2(noise1,noise2),0.0,1.0);}
vec2 getDistortedCoords(vec2 coords) {if (distortion==0.0) { return coords; }
vec2 direction=1.0*normalize(centered_screen_pos);vec2 dist_coords=vec2(0.5,0.5);dist_coords.x=0.5+direction.x*radius2*1.0;dist_coords.y=0.5+direction.y*radius2*1.0;float dist_amount=clamp(distortion*0.23,0.0,1.0);dist_coords=mix(coords,dist_coords,dist_amount);return dist_coords;}
float sampleScreen(inout vec4 color,in vec2 offset,in float weight) {vec2 coords=distorted_coords;float angle=rand(coords*100.0).x*TWOPI;coords+=vec2(offset.x*cos(angle)-offset.y*sin(angle),offset.x*sin(angle)+offset.y*cos(angle));color+=texture2D(textureSampler,coords)*weight;return weight;}
float getBlurLevel(float size) {return min(3.0,ceil(size/1.0));}
vec4 getBlurColor(float size) {vec4 col=texture2D(textureSampler,distorted_coords);float blur_level=getBlurLevel(size);float w=(size/screen_width);float h=(size/screen_height);float total_weight=1.0;vec2 sample_coords;total_weight+=sampleScreen(col,vec2(-0.50*w,0.24*h),0.93);total_weight+=sampleScreen(col,vec2(0.30*w,-0.75*h),0.90);total_weight+=sampleScreen(col,vec2(0.36*w,0.96*h),0.87);total_weight+=sampleScreen(col,vec2(-1.08*w,-0.55*h),0.85);total_weight+=sampleScreen(col,vec2(1.33*w,-0.37*h),0.83);total_weight+=sampleScreen(col,vec2(-0.82*w,1.31*h),0.80);total_weight+=sampleScreen(col,vec2(-0.31*w,-1.67*h),0.78);total_weight+=sampleScreen(col,vec2(1.47*w,1.11*h),0.76);total_weight+=sampleScreen(col,vec2(-1.97*w,0.19*h),0.74);total_weight+=sampleScreen(col,vec2(1.42*w,-1.57*h),0.72);if (blur_level>1.0) {total_weight+=sampleScreen(col,vec2(0.01*w,2.25*h),0.70);total_weight+=sampleScreen(col,vec2(-1.62*w,-1.74*h),0.67);total_weight+=sampleScreen(col,vec2(2.49*w,0.20*h),0.65);total_weight+=sampleScreen(col,vec2(-2.07*w,1.61*h),0.63);total_weight+=sampleScreen(col,vec2(0.46*w,-2.70*h),0.61);total_weight+=sampleScreen(col,vec2(1.55*w,2.40*h),0.59);total_weight+=sampleScreen(col,vec2(-2.88*w,-0.75*h),0.56);total_weight+=sampleScreen(col,vec2(2.73*w,-1.44*h),0.54);total_weight+=sampleScreen(col,vec2(-1.08*w,3.02*h),0.52);total_weight+=sampleScreen(col,vec2(-1.28*w,-3.05*h),0.49);}
if (blur_level>2.0) {total_weight+=sampleScreen(col,vec2(3.11*w,1.43*h),0.46);total_weight+=sampleScreen(col,vec2(-3.36*w,1.08*h),0.44);total_weight+=sampleScreen(col,vec2(1.80*w,-3.16*h),0.41);total_weight+=sampleScreen(col,vec2(0.83*w,3.65*h),0.38);total_weight+=sampleScreen(col,vec2(-3.16*w,-2.19*h),0.34);total_weight+=sampleScreen(col,vec2(3.92*w,-0.53*h),0.31);total_weight+=sampleScreen(col,vec2(-2.59*w,3.12*h),0.26);total_weight+=sampleScreen(col,vec2(-0.20*w,-4.15*h),0.22);total_weight+=sampleScreen(col,vec2(3.02*w,3.00*h),0.15);}
col/=total_weight; 
if (darken>0.0) {col.rgb*=clamp(0.3,1.0,1.05-size*0.5*darken);}
return col;}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{centered_screen_pos=vec2(vUV.x-0.5,vUV.y-0.5);radius2=centered_screen_pos.x*centered_screen_pos.x+centered_screen_pos.y*centered_screen_pos.y;radius=sqrt(radius2);distorted_coords=getDistortedCoords(vUV); 
vec2 texels_coords=vec2(vUV.x*screen_width,vUV.y*screen_height); 
float depth=texture2D(depthSampler,distorted_coords).r; 
float distance=near+(far-near)*depth; 
vec4 color=texture2D(textureSampler,vUV); 
float coc=abs(aperture*(screen_distance*(inverse_focal_length-1.0/distance)-1.0));if (dof_enabled==false || coc<0.07) { coc=0.0; }
float edge_blur_amount=0.0;if (edge_blur>0.0) {edge_blur_amount=clamp((radius*2.0-1.0+0.15*edge_blur)*1.5,0.0,1.0)*1.3;}
float blur_amount=max(edge_blur_amount,coc);if (blur_amount==0.0) {gl_FragColor=texture2D(textureSampler,distorted_coords);}
else {gl_FragColor=getBlurColor(blur_amount*1.7);if (highlights) {gl_FragColor.rgb+=clamp(coc,0.0,1.0)*texture2D(highlightsSampler,distorted_coords).rgb;}
if (blur_noise) {vec2 noise=rand(distorted_coords)*0.01*blur_amount;vec2 blurred_coord=vec2(distorted_coords.x+noise.x,distorted_coords.y+noise.y);gl_FragColor=0.04*texture2D(textureSampler,blurred_coord)+0.96*gl_FragColor;}}
if (grain_amount>0.0) {vec4 grain_color=texture2D(grainSampler,texels_coords*0.003);gl_FragColor.rgb+=(-0.5+grain_color.rgb)*0.30*grain_amount;}}
`;S.ShadersStore[Qb]||(S.ShadersStore[Qb]=u$);class h${constructor(){this.enabled=!1,this.name="ssao2",this.texturesRequired=[6,5]}}class Fi extends Ha{get totalStrength(){return this._thinSSAORenderingPipeline.totalStrength}set totalStrength(e){this._thinSSAORenderingPipeline.totalStrength=e}get maxZ(){return this._thinSSAORenderingPipeline.maxZ}set maxZ(e){this._thinSSAORenderingPipeline.maxZ=e}get minZAspect(){return this._thinSSAORenderingPipeline.minZAspect}set minZAspect(e){this._thinSSAORenderingPipeline.minZAspect=e}set epsilon(e){this._thinSSAORenderingPipeline.epsilon=e}get epsilon(){return this._thinSSAORenderingPipeline.epsilon}set samples(e){this._thinSSAORenderingPipeline.samples=e}get samples(){return this._thinSSAORenderingPipeline.samples}set textureSamples(e){this._textureSamples=e,this._prePassRenderer?this._prePassRenderer.samples=e:this._originalColorPostProcess.samples=e}get textureSamples(){return this._textureSamples}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._forcedGeometryBuffer??this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}get radius(){return this._thinSSAORenderingPipeline.radius}set radius(e){this._thinSSAORenderingPipeline.radius=e}get base(){return this._thinSSAORenderingPipeline.base}set base(e){this._thinSSAORenderingPipeline.base=e}set bypassBlur(e){this._thinSSAORenderingPipeline.bypassBlur=e}get bypassBlur(){return this._thinSSAORenderingPipeline.bypassBlur}set expensiveBlur(e){this._thinSSAORenderingPipeline.expensiveBlur=e}get expensiveBlur(){return this._thinSSAORenderingPipeline.expensiveBlur}get bilateralSamples(){return this._thinSSAORenderingPipeline.bilateralSamples}set bilateralSamples(e){this._thinSSAORenderingPipeline.bilateralSamples=e}get bilateralSoften(){return this._thinSSAORenderingPipeline.bilateralSoften}set bilateralSoften(e){this._thinSSAORenderingPipeline.bilateralSoften=e}get bilateralTolerance(){return this._thinSSAORenderingPipeline.bilateralTolerance}set bilateralTolerance(e){this._thinSSAORenderingPipeline.bilateralTolerance=e}static get IsSupported(){const e=De.LastCreatedEngine;return e?e._features.supportSSAO2:!1}get useViewportInCombineStage(){return this._thinSSAORenderingPipeline.useViewportInCombineStage}set useViewportInCombineStage(e){this._thinSSAORenderingPipeline.useViewportInCombineStage=e}get scene(){return this._scene}constructor(e,t,i,r,n=!1,a=0){var c,u;if(super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this._textureSamples=1,this._forcedGeometryBuffer=null,this._forceGeometryBuffer=!1,this._thinSSAORenderingPipeline=new VR(e,t),this._scene=t,this._ratio=i,this._textureType=a,n instanceof Ae?(this._forceGeometryBuffer=!0,this._forcedGeometryBuffer=n):this._forceGeometryBuffer=n,!this.isSupported){N.Error("The current engine does not support SSAO 2.");return}const o=this._ratio.ssaoRatio||i,l=this._ratio.blurRatio||i;this._forceGeometryBuffer?(this._forcedGeometryBuffer||t.enableGeometryBufferRenderer(),(c=t.geometryBufferRenderer)!=null&&c.generateNormalsInWorldSpace&&N.Error("SSAO2RenderingPipeline does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!")):(t.enablePrePassRenderer(),(u=t.prePassRenderer)!=null&&u.generateNormalsInWorldSpace&&N.Error("SSAO2RenderingPipeline does not support generateNormalsInWorldSpace=true for the prepass renderer!")),this._originalColorPostProcess=new Uo("SSAOOriginalSceneColor",1,null,$.BILINEAR_SAMPLINGMODE,t.getEngine(),void 0,this._textureType),this._originalColorPostProcess.samples=this.textureSamples,this._createSSAOPostProcess(1,a),this._createBlurPostProcess(o,l,this._textureType),this._createSSAOCombinePostProcess(l,this._textureType),this.addEffect(new Ye(t.getEngine(),this.SSAOOriginalSceneColorEffect,()=>this._originalColorPostProcess,!0)),this.addEffect(new Ye(t.getEngine(),this.SSAORenderEffect,()=>this._ssaoPostProcess,!0)),this.addEffect(new Ye(t.getEngine(),this.SSAOBlurHRenderEffect,()=>this._blurHPostProcess,!0)),this.addEffect(new Ye(t.getEngine(),this.SSAOBlurVRenderEffect,()=>this._blurVPostProcess,!0)),this.addEffect(new Ye(t.getEngine(),this.SSAOCombineRenderEffect,()=>this._ssaoCombinePostProcess,!0)),t.postProcessRenderPipelineManager.addPipeline(this),r&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,r)}getClassName(){return"SSAO2RenderingPipeline"}dispose(e=!1){for(let t=0;t<this._scene.cameras.length;t++){const i=this._scene.cameras[t];this._originalColorPostProcess.dispose(i),this._ssaoPostProcess.dispose(i),this._blurHPostProcess.dispose(i),this._blurVPostProcess.dispose(i),this._ssaoCombinePostProcess.dispose(i)}e&&!this._forcedGeometryBuffer&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),this._scene.postProcessRenderPipelineManager.removePipeline(this._name),this._thinSSAORenderingPipeline.dispose(),super.dispose()}_rebuild(){super._rebuild()}_createBlurPostProcess(e,t,i){this._blurHPostProcess=this._createBlurFilter("BlurH",e,i,!0),this._blurVPostProcess=this._createBlurFilter("BlurV",t,i,!1)}_createBlurFilter(e,t,i,r){const n=new Se(e,Ss.FragmentUrl,{size:t,samplingMode:2,engine:this._scene.getEngine(),textureType:this._textureType,effectWrapper:r?this._thinSSAORenderingPipeline._ssaoBlurXPostProcess:this._thinSSAORenderingPipeline._ssaoBlurYPostProcess});return n.onApply=a=>{const o=this._ratio.blurRatio||this._ratio,l=r?this._originalColorPostProcess.width*o:this._originalColorPostProcess.height*o,c=r?this._originalColorPostProcess.width:this._originalColorPostProcess.height;this._thinSSAORenderingPipeline._ssaoBlurXPostProcess.textureSize=l>0?l:c,this._thinSSAORenderingPipeline._ssaoBlurYPostProcess.textureSize=l>0?l:c,this._geometryBufferRenderer?a.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]):this._prePassRenderer&&a.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)])},n.samples=this.textureSamples,n.autoClear=!1,n}_getTextureSize(){var r;const e=this._scene.getEngine(),t=this._prePassRenderer;let i={width:e.getRenderWidth(),height:e.getRenderHeight()};if(t&&((r=this._scene.activeCamera)==null?void 0:r._getFirstPostProcess())===this._ssaoPostProcess){const n=t.getRenderTarget();n&&n.textures&&(i=n.textures[t.getIndex(4)].getSize())}else this._ssaoPostProcess.inputTexture&&(i.width=this._ssaoPostProcess.inputTexture.width,i.height=this._ssaoPostProcess.inputTexture.height);return i}_createSSAOPostProcess(e,t){this._ssaoPostProcess=new Se("ssao",_r.FragmentUrl,{size:e,samplingMode:2,engine:this._scene.getEngine(),textureType:t,effectWrapper:this._thinSSAORenderingPipeline._ssaoPostProcess}),this._ssaoPostProcess.autoClear=!1,this._ssaoPostProcess.onApply=i=>{this._thinSSAORenderingPipeline._ssaoPostProcess.camera=this._scene.activeCamera,this._geometryBufferRenderer?(i.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]),i.setTexture("normalSampler",this._geometryBufferRenderer.getGBuffer().textures[1])):this._prePassRenderer&&(i.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)]),i.setTexture("normalSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(6)]));const r=this._getTextureSize();this._thinSSAORenderingPipeline._ssaoPostProcess.textureWidth=r.width,this._thinSSAORenderingPipeline._ssaoPostProcess.textureHeight=r.height},this._ssaoPostProcess.samples=this.textureSamples,this._forceGeometryBuffer||(this._ssaoPostProcess._prePassEffectConfiguration=new h$)}_createSSAOCombinePostProcess(e,t){this._ssaoCombinePostProcess=new Se("ssaoCombine",pn.FragmentUrl,{size:e,samplingMode:2,engine:this._scene.getEngine(),textureType:t,effectWrapper:this._thinSSAORenderingPipeline._ssaoCombinePostProcess}),this._ssaoCombinePostProcess.onApply=i=>{this._thinSSAORenderingPipeline._ssaoCombinePostProcess.camera=this._scene.activeCamera,i.setTextureFromPostProcessOutput("originalColor",this._originalColorPostProcess)},this._ssaoCombinePostProcess.autoClear=!1,this._ssaoCombinePostProcess.samples=this.textureSamples}serialize(){const e=me.Serialize(this);return e.customType="SSAO2RenderingPipeline",e}static Parse(e,t,i){return me.Parse(()=>new Fi(e._name,t,e._ratio,void 0,e._forceGeometryBuffer,e._textureType),e,t,i)}}_([R()],Fi.prototype,"totalStrength",null);_([R()],Fi.prototype,"maxZ",null);_([R()],Fi.prototype,"minZAspect",null);_([R("epsilon")],Fi.prototype,"epsilon",null);_([R("samples")],Fi.prototype,"samples",null);_([R("textureSamples")],Fi.prototype,"_textureSamples",void 0);_([R()],Fi.prototype,"_forceGeometryBuffer",void 0);_([R()],Fi.prototype,"_ratio",void 0);_([R()],Fi.prototype,"_textureType",void 0);_([R()],Fi.prototype,"radius",null);_([R()],Fi.prototype,"base",null);_([R("bypassBlur")],Fi.prototype,"bypassBlur",null);_([R("expensiveBlur")],Fi.prototype,"expensiveBlur",null);_([R()],Fi.prototype,"bilateralSamples",null);_([R()],Fi.prototype,"bilateralSoften",null);_([R()],Fi.prototype,"bilateralTolerance",null);y("BABYLON.SSAO2RenderingPipeline",Fi);const Kb="ssaoPixelShader",d$=`uniform sampler2D textureSampler;varying vec2 vUV;
#ifdef SSAO
uniform sampler2D randomSampler;uniform float randTextureTiles;uniform float samplesFactor;uniform vec3 sampleSphere[SAMPLES];uniform float totalStrength;uniform float radius;uniform float area;uniform float fallOff;uniform float base;vec3 normalFromDepth(float depth,vec2 coords)
{vec2 offset1=vec2(0.0,radius);vec2 offset2=vec2(radius,0.0);float depth1=texture2D(textureSampler,coords+offset1).r;float depth2=texture2D(textureSampler,coords+offset2).r;vec3 p1=vec3(offset1,depth1-depth);vec3 p2=vec3(offset2,depth2-depth);vec3 normal=cross(p1,p2);normal.z=-normal.z;return normalize(normal);}
void main()
{vec3 random=normalize(texture2D(randomSampler,vUV*randTextureTiles).rgb);float depth=texture2D(textureSampler,vUV).r;vec3 position=vec3(vUV,depth);vec3 normal=normalFromDepth(depth,vUV);float radiusDepth=radius/depth;float occlusion=0.0;vec3 ray;vec3 hemiRay;float occlusionDepth;float difference;for (int i=0; i<SAMPLES; i++)
{ray=radiusDepth*reflect(sampleSphere[i],random);hemiRay=position+sign(dot(ray,normal))*ray;occlusionDepth=texture2D(textureSampler,clamp(hemiRay.xy,vec2(0.001,0.001),vec2(0.999,0.999))).r;difference=depth-occlusionDepth;occlusion+=step(fallOff,difference)*(1.0-smoothstep(fallOff,area,difference));}
float ao=1.0-totalStrength*occlusion*samplesFactor;float result=clamp(ao+base,0.0,1.0);gl_FragColor.r=result;gl_FragColor.g=result;gl_FragColor.b=result;gl_FragColor.a=1.0;}
#endif
`;S.ShadersStore[Kb]||(S.ShadersStore[Kb]=d$);const Mf="ssaoCombinePixelShader",lP=`uniform sampler2D textureSampler;uniform sampler2D originalColor;uniform vec4 viewport;varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec2 uv=viewport.xy+vUV*viewport.zw;vec4 ssaoColor=texture2D(textureSampler,uv);vec4 sceneColor=texture2D(originalColor,uv);gl_FragColor=sceneColor*ssaoColor;
#define CUSTOM_FRAGMENT_MAIN_END
}
`;S.ShadersStore[Mf]||(S.ShadersStore[Mf]=lP);const f$={name:Mf,shader:lP},p$=Object.freeze(Object.defineProperty({__proto__:null,ssaoCombinePixelShader:f$},Symbol.toStringTag,{value:"Module"}));class pc extends Ha{get scene(){return this._scene}constructor(e,t,i,r){super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.radius=1e-4,this.area=.0075,this.fallOff=1e-6,this.base=.5,this._firstUpdate=!0,this._scene=t,this._createRandomTexture();const n=i.ssaoRatio||i,a=i.combineRatio||i;this._originalColorPostProcess=new Uo("SSAOOriginalSceneColor",a,null,$.BILINEAR_SAMPLINGMODE,t.getEngine(),!1),this._createSSAOPostProcess(n),this._createBlurPostProcess(n),this._createSSAOCombinePostProcess(a),this.addEffect(new Ye(t.getEngine(),this.SSAOOriginalSceneColorEffect,()=>this._originalColorPostProcess,!0)),this.addEffect(new Ye(t.getEngine(),this.SSAORenderEffect,()=>this._ssaoPostProcess,!0)),this.addEffect(new Ye(t.getEngine(),this.SSAOBlurHRenderEffect,()=>this._blurHPostProcess,!0)),this.addEffect(new Ye(t.getEngine(),this.SSAOBlurVRenderEffect,()=>this._blurVPostProcess,!0)),this.addEffect(new Ye(t.getEngine(),this.SSAOCombineRenderEffect,()=>this._ssaoCombinePostProcess,!0)),t.postProcessRenderPipelineManager.addPipeline(this),r&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,r)}_attachCameras(e,t){super._attachCameras(e,t);for(const i of this._cameras)this._scene.enableDepthRenderer(i).getDepthMap()}getClassName(){return"SSAORenderingPipeline"}dispose(e=!1){for(let t=0;t<this._scene.cameras.length;t++){const i=this._scene.cameras[t];this._originalColorPostProcess.dispose(i),this._ssaoPostProcess.dispose(i),this._blurHPostProcess.dispose(i),this._blurVPostProcess.dispose(i),this._ssaoCombinePostProcess.dispose(i)}this._randomTexture.dispose(),e&&this._scene.disableDepthRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),this._scene.postProcessRenderPipelineManager.removePipeline(this._name),super.dispose()}_createBlurPostProcess(e){this._blurHPostProcess=new nr("BlurH",new X(1,0),16,e,null,$.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurVPostProcess=new nr("BlurV",new X(0,1),16,e,null,$.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurHPostProcess.onActivateObservable.add(()=>{const i=this._blurHPostProcess.width/this._scene.getEngine().getRenderWidth();this._blurHPostProcess.kernel=16*i}),this._blurVPostProcess.onActivateObservable.add(()=>{const i=this._blurVPostProcess.height/this._scene.getEngine().getRenderHeight();this._blurVPostProcess.kernel=16*i})}_rebuild(){this._firstUpdate=!0,super._rebuild()}_createSSAOPostProcess(e){const i=[.5381,.1856,-.4319,.1379,.2486,.443,.3371,.5679,-.0057,-.6999,-.0451,-.0019,.0689,-.1598,-.8547,.056,.0069,-.1843,-.0146,.1402,.0762,.01,-.1924,-.0344,-.3577,-.5301,-.4358,-.3169,.1063,.0158,.0103,-.5869,.0046,-.0897,-.494,.3287,.7119,-.0154,-.0918,-.0533,.0596,-.5411,.0352,-.0631,.546,-.4776,.2847,-.0271],r=1/16;this._ssaoPostProcess=new Se("ssao","ssao",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","area","fallOff","base","range","viewport"],["randomSampler"],e,null,$.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,`#define SAMPLES 16
#define SSAO`),this._ssaoPostProcess.externalTextureSamplerBinding=!0,this._ssaoPostProcess.onApply=n=>{this._firstUpdate&&(n.setArray3("sampleSphere",i),n.setFloat("samplesFactor",r),n.setFloat("randTextureTiles",4)),n.setFloat("totalStrength",this.totalStrength),n.setFloat("radius",this.radius),n.setFloat("area",this.area),n.setFloat("fallOff",this.fallOff),n.setFloat("base",this.base),n.setTexture("textureSampler",this._scene.enableDepthRenderer(this._scene.activeCamera).getDepthMap()),n.setTexture("randomSampler",this._randomTexture)}}_createSSAOCombinePostProcess(e){this._ssaoCombinePostProcess=new Se("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,$.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._ssaoCombinePostProcess.onApply=t=>{t.setVector4("viewport",G.Vector4[0].copyFromFloats(0,0,1,1)),t.setTextureFromPostProcess("originalColor",this._originalColorPostProcess)}}_createRandomTexture(){const t=new Uint8Array(1048576);for(let r=0;r<t.length;)t[r++]=Math.floor(Math.max(0,It(-1,1))*255),t[r++]=Math.floor(Math.max(0,It(-1,1))*255),t[r++]=Math.floor(Math.max(0,It(-1,1))*255),t[r++]=255;const i=gi.CreateRGBATexture(t,512,512,this._scene,!1,!1,2);i.name="SSAORandomTexture",i.wrapU=$.WRAP_ADDRESSMODE,i.wrapV=$.WRAP_ADDRESSMODE,this._randomTexture=i}}_([R()],pc.prototype,"totalStrength",void 0);_([R()],pc.prototype,"radius",void 0);_([R()],pc.prototype,"area",void 0);_([R()],pc.prototype,"fallOff",void 0);_([R()],pc.prototype,"base",void 0);class m${constructor(){this.enabled=!1,this.name="screenSpaceReflections",this.texturesRequired=[6,3,1]}}const Jb="screenSpaceReflectionPixelShader",_$=`uniform sampler2D textureSampler;
#ifdef SSR_SUPPORTED
uniform sampler2D reflectivitySampler;uniform sampler2D normalSampler;uniform sampler2D positionSampler;
#endif
uniform mat4 view;uniform mat4 projection;uniform float stepSize;uniform float strength;uniform float threshold;uniform float roughnessFactor;uniform float reflectionSpecularFalloffExponent;varying vec2 vUV;
#ifdef SSR_SUPPORTED
struct ReflectionInfo {vec3 color;vec4 coords;};/**
* According to specular,see https:
*/
vec3 fresnelSchlick(float cosTheta,vec3 F0)
{return F0+(1.0-F0)*pow(1.0-cosTheta,5.0);}
/**
* Once the pixel's coordinates has been found,let's adjust (smooth) a little bit
* by sampling multiple reflection pixels.
*/
ReflectionInfo smoothReflectionInfo(vec3 dir,vec3 hitCoord)
{ReflectionInfo info;info.color=vec3(0.0);vec4 projectedCoord;float sampledDepth;for(int i=0; i<SMOOTH_STEPS; i++)
{projectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);sampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;float depth=sampledDepth-hitCoord.z;dir*=0.5;if(depth>0.0)
hitCoord-=dir;else
hitCoord+=dir;info.color+=texture2D(textureSampler,projectedCoord.xy).rgb;}
projectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);info.coords=vec4(projectedCoord.xy,sampledDepth,1.0);info.color+=texture2D(textureSampler,projectedCoord.xy).rgb;info.color/=float(SMOOTH_STEPS+1);return info;}
/**
* Tests the given world position (hitCoord) according to the given reflection vector (dir)
* until it finds a collision (means that depth is enough close to say "it's the pixel to sample!").
*/
ReflectionInfo getReflectionInfo(vec3 dir,vec3 hitCoord)
{ReflectionInfo info;vec4 projectedCoord;float sampledDepth;dir*=stepSize;for(int i=0; i<REFLECTION_SAMPLES; i++)
{hitCoord+=dir;projectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);sampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;float depth=sampledDepth-hitCoord.z;
#ifdef RIGHT_HANDED_SCENE
depth*=-1.0;
#endif
if(((depth-dir.z)<threshold) && depth<=0.0)
{
#ifdef ENABLE_SMOOTH_REFLECTIONS
return smoothReflectionInfo(dir,hitCoord);
#else
info.color=texture2D(textureSampler,projectedCoord.xy).rgb;info.coords=vec4(projectedCoord.xy,sampledDepth,0.0);return info;
#endif
}}
info.color=texture2D(textureSampler,projectedCoord.xy).rgb;info.coords=vec4(projectedCoord.xy,sampledDepth,0.0);return info;}
vec3 hash(vec3 a)
{a=fract(a*0.8);a+=dot(a,a.yxz+19.19);return fract((a.xxy+a.yxx)*a.zyx);}
#endif
void main()
{
#ifdef SSR_SUPPORTED
vec4 albedoFull=texture2D(textureSampler,vUV);vec3 albedo=albedoFull.rgb;float spec=texture2D(reflectivitySampler,vUV).r;if (spec==0.0) {gl_FragColor=albedoFull;return;}
vec3 normal=(texture2D(normalSampler,vUV)).xyz;vec3 position=(view*texture2D(positionSampler,vUV)).xyz;vec3 reflected=normalize(reflect(normalize(position),normalize(normal)));float roughness=1.0-texture2D(reflectivitySampler,vUV).a;vec3 jitt=mix(vec3(0.0),hash(position),roughness)*roughnessFactor;ReflectionInfo info=getReflectionInfo(jitt+reflected,position);vec2 dCoords=smoothstep(0.2,0.6,abs(vec2(0.5,0.5)-info.coords.xy));float screenEdgefactor=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);vec3 F0=vec3(0.04);F0 =mix(F0,albedo,spec);vec3 fresnel=fresnelSchlick(max(dot(normalize(normal),normalize(position)),0.0),F0);
#ifdef RIGHT_HANDED_SCENE
reflected.z*=-1.0;
#endif
float reflectionMultiplier=clamp(pow(spec*strength,reflectionSpecularFalloffExponent)*screenEdgefactor*reflected.z,0.0,0.9);float albedoMultiplier=1.0-reflectionMultiplier;vec3 SSR=info.color*fresnel;gl_FragColor=vec4((albedo*albedoMultiplier)+(SSR*reflectionMultiplier),albedoFull.a);
#else
gl_FragColor=texture2D(textureSampler,vUV);
#endif
}
`;S.ShadersStore[Jb]||(S.ShadersStore[Jb]=_$);class ts extends Se{get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}getClassName(){return"ScreenSpaceReflectionPostProcess"}constructor(e,t,i,r,n,a,o,l=0,c=!1,u=!1){if(super(e,"screenSpaceReflection",["projection","view","threshold","reflectionSpecularFalloffExponent","strength","stepSize","roughnessFactor"],["textureSampler","normalSampler","positionSampler","reflectivitySampler"],i,r,n,a,o,`#define SSR_SUPPORTED
#define REFLECTION_SAMPLES 64
#define SMOOTH_STEPS 5
`,l,void 0,null,c),this.threshold=1.2,this.strength=1,this.reflectionSpecularFalloffExponent=3,this.step=1,this.roughnessFactor=.2,this._forceGeometryBuffer=!1,this._enableSmoothReflections=!1,this._reflectionSamples=64,this._smoothSteps=5,this._forceGeometryBuffer=u,this._forceGeometryBuffer){const h=t.enableGeometryBufferRenderer();h&&h.isSupported&&(h.enablePosition=!0,h.enableReflectivity=!0,h.generateNormalsInWorldSpace&&N.Error("ScreenSpaceReflectionPostProcess does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!"))}else{const h=t.enablePrePassRenderer();h==null||h.markAsDirty(),h!=null&&h.generateNormalsInWorldSpace&&N.Error("ScreenSpaceReflectionPostProcess does not support generateNormalsInWorldSpace=true for the prepass renderer!"),this._prePassEffectConfiguration=new m$}this._updateEffectDefines(),this.onApply=h=>{const d=this._geometryBufferRenderer,f=this._prePassRenderer;if(!f&&!d)return;if(d){const E=d.getTextureIndex(Ae.POSITION_TEXTURE_TYPE),T=d.getTextureIndex(Ae.REFLECTIVITY_TEXTURE_TYPE);h.setTexture("normalSampler",d.getGBuffer().textures[1]),h.setTexture("positionSampler",d.getGBuffer().textures[E]),h.setTexture("reflectivitySampler",d.getGBuffer().textures[T])}else if(f){const E=f.getIndex(1),T=f.getIndex(3),C=f.getIndex(6);h.setTexture("normalSampler",f.getRenderTarget().textures[C]),h.setTexture("positionSampler",f.getRenderTarget().textures[E]),h.setTexture("reflectivitySampler",f.getRenderTarget().textures[T])}const m=t.activeCamera;if(!m)return;const g=m.getViewMatrix(!0),v=m.getProjectionMatrix(!0);h.setMatrix("projection",v),h.setMatrix("view",g),h.setFloat("threshold",this.threshold),h.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),h.setFloat("strength",this.strength),h.setFloat("stepSize",this.step),h.setFloat("roughnessFactor",this.roughnessFactor)},this._isSceneRightHanded=t.useRightHandedSystem}get enableSmoothReflections(){return this._enableSmoothReflections}set enableSmoothReflections(e){e!==this._enableSmoothReflections&&(this._enableSmoothReflections=e,this._updateEffectDefines())}get reflectionSamples(){return this._reflectionSamples}set reflectionSamples(e){e!==this._reflectionSamples&&(this._reflectionSamples=e,this._updateEffectDefines())}get smoothSteps(){return this._smoothSteps}set smoothSteps(e){e!==this._smoothSteps&&(this._smoothSteps=e,this._updateEffectDefines())}_updateEffectDefines(){const e=[];(this._geometryBufferRenderer||this._prePassRenderer)&&e.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&e.push("#define ENABLE_SMOOTH_REFLECTIONS"),this._isSceneRightHanded&&e.push("#define RIGHT_HANDED_SCENE"),e.push("#define REFLECTION_SAMPLES "+(this._reflectionSamples>>0)),e.push("#define SMOOTH_STEPS "+(this._smoothSteps>>0)),this.updateEffect(e.join(`
`))}static _Parse(e,t,i,r){return me.Parse(()=>new ts(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable),e,i,r)}}_([R()],ts.prototype,"threshold",void 0);_([R()],ts.prototype,"strength",void 0);_([R()],ts.prototype,"reflectionSpecularFalloffExponent",void 0);_([R()],ts.prototype,"step",void 0);_([R()],ts.prototype,"roughnessFactor",void 0);_([R()],ts.prototype,"enableSmoothReflections",null);_([R()],ts.prototype,"reflectionSamples",null);_([R()],ts.prototype,"smoothSteps",null);y("BABYLON.ScreenSpaceReflectionPostProcess",ts);const eC="standardPixelShader",g$=`uniform sampler2D textureSampler;varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
#if defined(PASS_POST_PROCESS)
void main(void)
{vec4 color=texture2D(textureSampler,vUV);gl_FragColor=color;}
#endif
#if defined(DOWN_SAMPLE_X4)
uniform vec2 dsOffsets[16];void main(void)
{vec4 average=vec4(0.0,0.0,0.0,0.0);average=texture2D(textureSampler,vUV+dsOffsets[0]);average+=texture2D(textureSampler,vUV+dsOffsets[1]);average+=texture2D(textureSampler,vUV+dsOffsets[2]);average+=texture2D(textureSampler,vUV+dsOffsets[3]);average+=texture2D(textureSampler,vUV+dsOffsets[4]);average+=texture2D(textureSampler,vUV+dsOffsets[5]);average+=texture2D(textureSampler,vUV+dsOffsets[6]);average+=texture2D(textureSampler,vUV+dsOffsets[7]);average+=texture2D(textureSampler,vUV+dsOffsets[8]);average+=texture2D(textureSampler,vUV+dsOffsets[9]);average+=texture2D(textureSampler,vUV+dsOffsets[10]);average+=texture2D(textureSampler,vUV+dsOffsets[11]);average+=texture2D(textureSampler,vUV+dsOffsets[12]);average+=texture2D(textureSampler,vUV+dsOffsets[13]);average+=texture2D(textureSampler,vUV+dsOffsets[14]);average+=texture2D(textureSampler,vUV+dsOffsets[15]);average/=16.0;gl_FragColor=average;}
#endif
#if defined(BRIGHT_PASS)
uniform vec2 dsOffsets[4];uniform float brightThreshold;void main(void)
{vec4 average=vec4(0.0,0.0,0.0,0.0);average=texture2D(textureSampler,vUV+vec2(dsOffsets[0].x,dsOffsets[0].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[1].x,dsOffsets[1].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[2].x,dsOffsets[2].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[3].x,dsOffsets[3].y));average*=0.25;float luminance=length(average.rgb);if (luminance<brightThreshold) {average=vec4(0.0,0.0,0.0,1.0);}
gl_FragColor=average;}
#endif
#if defined(TEXTURE_ADDER)
uniform sampler2D otherSampler;uniform sampler2D lensSampler;uniform float exposure;void main(void)
{vec3 colour=texture2D(textureSampler,vUV).rgb;colour*=exposure;vec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);vec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);colour=retColor*retColor;colour+=colour*texture2D(lensSampler,vUV).rgb;vec4 finalColor=vec4(colour.rgb,1.0)+texture2D(otherSampler,vUV);gl_FragColor=finalColor;}
#endif
#if defined(VLS)
#define PI 3.1415926535897932384626433832795
uniform mat4 shadowViewProjection;uniform mat4 lightWorld;uniform vec3 cameraPosition;uniform vec3 sunDirection;uniform vec3 sunColor;uniform vec2 depthValues;uniform float scatteringCoefficient;uniform float scatteringPower;uniform sampler2D shadowMapSampler;uniform sampler2D positionSampler;float computeScattering(float lightDotView)
{float result=1.0-scatteringCoefficient*scatteringCoefficient;result/=(4.0*PI*pow(1.0+scatteringCoefficient*scatteringCoefficient-(2.0*scatteringCoefficient)*lightDotView,1.5));return result;}
void main(void)
{vec3 worldPos=texture2D(positionSampler,vUV).rgb;vec3 startPosition=cameraPosition;vec3 rayVector=worldPos-startPosition;float rayLength=length(rayVector);vec3 rayDirection=rayVector/rayLength;float stepLength=rayLength/NB_STEPS;vec3 stepL=rayDirection*stepLength;vec3 currentPosition=startPosition;vec3 accumFog=vec3(0.0);for (int i=0; i<int(NB_STEPS); i++)
{vec4 worldInShadowCameraSpace=shadowViewProjection*vec4(currentPosition,1.0);float depthMetric= (worldInShadowCameraSpace.z+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depthMetric,0.0,1.0);worldInShadowCameraSpace.xyz/=worldInShadowCameraSpace.w;worldInShadowCameraSpace.xyz=0.5*worldInShadowCameraSpace.xyz+vec3(0.5);float shadowMapValue=texture2D(shadowMapSampler,worldInShadowCameraSpace.xy).r;if (shadowMapValue>shadowPixelDepth)
accumFog+=sunColor*computeScattering(dot(rayDirection,sunDirection));currentPosition+=stepL;}
accumFog/=NB_STEPS;vec3 color=accumFog*scatteringPower;gl_FragColor=vec4(color*exp(color) ,1.0);}
#endif
#if defined(VLSMERGE)
uniform sampler2D originalSampler;void main(void)
{gl_FragColor=texture2D(originalSampler,vUV)+texture2D(textureSampler,vUV);}
#endif
#if defined(LUMINANCE)
uniform vec2 lumOffsets[4];void main()
{float average=0.0;vec4 color=vec4(0.0);float maximum=-1e20;vec3 weight=vec3(0.299,0.587,0.114);for (int i=0; i<4; i++)
{color=texture2D(textureSampler,vUV+ lumOffsets[i]);float GreyValue=dot(color.rgb,vec3(0.33,0.33,0.33));
#ifdef WEIGHTED_AVERAGE
float GreyValue=dot(color.rgb,weight);
#endif
#ifdef BRIGHTNESS
float GreyValue=max(color.r,max(color.g,color.b));
#endif
#ifdef HSL_COMPONENT
float GreyValue=0.5*(max(color.r,max(color.g,color.b))+min(color.r,min(color.g,color.b)));
#endif
#ifdef MAGNITUDE
float GreyValue=length(color.rgb);
#endif
maximum=max(maximum,GreyValue);average+=(0.25*log(1e-5+GreyValue));}
average=exp(average);gl_FragColor=vec4(average,maximum,0.0,1.0);}
#endif
#if defined(LUMINANCE_DOWN_SAMPLE)
uniform vec2 dsOffsets[9];uniform float halfDestPixelSize;
#ifdef FINAL_DOWN_SAMPLER
#include<packingFunctions>
#endif
void main()
{vec4 color=vec4(0.0);float average=0.0;for (int i=0; i<9; i++)
{color=texture2D(textureSampler,vUV+vec2(halfDestPixelSize,halfDestPixelSize)+dsOffsets[i]);average+=color.r;}
average/=9.0;
#ifdef FINAL_DOWN_SAMPLER
gl_FragColor=pack(average);
#else
gl_FragColor=vec4(average,average,0.0,1.0);
#endif
}
#endif
#if defined(HDR)
uniform sampler2D textureAdderSampler;uniform float averageLuminance;void main()
{vec4 color=texture2D(textureAdderSampler,vUV);
#ifndef AUTO_EXPOSURE
vec4 adjustedColor=color/averageLuminance;color=adjustedColor;color.a=1.0;
#endif
gl_FragColor=color;}
#endif
#if defined(LENS_FLARE)
#define GHOSTS 3
uniform sampler2D lensColorSampler;uniform float strength;uniform float ghostDispersal;uniform float haloWidth;uniform vec2 resolution;uniform float distortionStrength;float hash(vec2 p)
{float h=dot(p,vec2(127.1,311.7));return -1.0+2.0*fract(sin(h)*43758.5453123);}
float noise(in vec2 p)
{vec2 i=floor(p);vec2 f=fract(p);vec2 u=f*f*(3.0-2.0*f);return mix(mix(hash(i+vec2(0.0,0.0)),
hash(i+vec2(1.0,0.0)),u.x),
mix(hash(i+vec2(0.0,1.0)),
hash(i+vec2(1.0,1.0)),u.x),u.y);}
float fbm(vec2 p)
{float f=0.0;f+=0.5000*noise(p); p*=2.02;f+=0.2500*noise(p); p*=2.03;f+=0.1250*noise(p); p*=2.01;f+=0.0625*noise(p); p*=2.04;f/=0.9375;return f;}
vec3 pattern(vec2 uv)
{vec2 p=-1.0+2.0*uv;float p2=dot(p,p);float f=fbm(vec2(15.0*p2))/2.0;float r=0.2+0.6*sin(12.5*length(uv-vec2(0.5)));float g=0.2+0.6*sin(20.5*length(uv-vec2(0.5)));float b=0.2+0.6*sin(17.2*length(uv-vec2(0.5)));return (1.0-f)*vec3(r,g,b);}
float luminance(vec3 color)
{return dot(color.rgb,vec3(0.2126,0.7152,0.0722));}
vec4 textureDistorted(sampler2D tex,vec2 texcoord,vec2 direction,vec3 distortion)
{return vec4(
texture2D(tex,texcoord+direction*distortion.r).r,
texture2D(tex,texcoord+direction*distortion.g).g,
texture2D(tex,texcoord+direction*distortion.b).b,
1.0
);}
void main(void)
{vec2 uv=-vUV+vec2(1.0);vec2 ghostDir=(vec2(0.5)-uv)*ghostDispersal;vec2 texelSize=1.0/resolution;vec3 distortion=vec3(-texelSize.x*distortionStrength,0.0,texelSize.x*distortionStrength);vec4 result=vec4(0.0);float ghostIndice=1.0;for (int i=0; i<GHOSTS; ++i)
{vec2 offset=fract(uv+ghostDir*ghostIndice);float weight=length(vec2(0.5)-offset)/length(vec2(0.5));weight=pow(1.0-weight,10.0);result+=textureDistorted(textureSampler,offset,normalize(ghostDir),distortion)*weight*strength;ghostIndice+=1.0;}
vec2 haloVec=normalize(ghostDir)*haloWidth;float weight=length(vec2(0.5)-fract(uv+haloVec))/length(vec2(0.5));weight=pow(1.0-weight,10.0);result+=textureDistorted(textureSampler,fract(uv+haloVec),normalize(ghostDir),distortion)*weight*strength;result*=texture2D(lensColorSampler,vec2(length(vec2(0.5)-uv)/length(vec2(0.5))));gl_FragColor=result;}
#endif
#if defined(LENS_FLARE_COMPOSE)
uniform sampler2D otherSampler;uniform sampler2D lensDirtSampler;uniform sampler2D lensStarSampler;uniform mat4 lensStarMatrix;void main(void)
{vec2 lensFlareCoords=(lensStarMatrix*vec4(vUV,1.0,1.0)).xy;vec4 lensMod=texture2D(lensDirtSampler,vUV);lensMod+=texture2D(lensStarSampler,vUV/*lensFlareCoords*/);vec4 result=texture2D(textureSampler,vUV)*lensMod;gl_FragColor=texture2D(otherSampler,vUV)+result;}
#endif
#if defined(DEPTH_OF_FIELD)
uniform sampler2D otherSampler;uniform sampler2D depthSampler;uniform float distance;void main(void)
{vec4 sharp=texture2D(otherSampler,vUV);vec4 blur=texture2D(textureSampler,vUV);float dist=clamp(texture2D(depthSampler,vUV).r*distance,0.0,1.0);float factor=0.0;if (dist<0.05)
factor=1.0;else if (dist<0.1)
factor=20.0*(0.1-dist);else if (dist<0.5)
factor=0.0;else
factor=2.0*(dist-0.5);factor=clamp(factor,0.0,0.90);gl_FragColor=mix(sharp,blur,factor);}
#endif
#if defined(MOTION_BLUR)
uniform mat4 inverseViewProjection;uniform mat4 prevViewProjection;uniform vec2 screenSize;uniform float motionScale;uniform float motionStrength;uniform sampler2D depthSampler;void main(void)
{vec2 texelSize=1.0/screenSize;float depth=texture2D(depthSampler,vUV).r;vec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);cpos=cpos*inverseViewProjection;vec4 ppos=cpos*prevViewProjection;ppos.xyz/=ppos.w;ppos.xy=ppos.xy*0.5+0.5;vec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;float speed=length(velocity/texelSize);int nSamples=int(clamp(speed,1.0,MAX_MOTION_SAMPLES));vec4 result=texture2D(textureSampler,vUV);for (int i=1; i<int(MAX_MOTION_SAMPLES); ++i) {if (i>=nSamples)
break;vec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);result+=texture2D(textureSampler,offset1);}
gl_FragColor=result/float(nSamples);}
#endif
`;S.ShadersStore[eC]||(S.ShadersStore[eC]=g$);class je extends Ha{get exposure(){return this._fixedExposure}set exposure(e){this._fixedExposure=e,this._currentExposure=e}get hdrAutoExposure(){return this._hdrAutoExposure}set hdrAutoExposure(e){if(this._hdrAutoExposure=e,this.hdrPostProcess){const t=["#define HDR"];e&&t.push("#define AUTO_EXPOSURE"),this.hdrPostProcess.updateEffect(t.join(`
`))}}get motionStrength(){return this._motionStrength}set motionStrength(e){this._motionStrength=e,this._isObjectBasedMotionBlur&&this.motionBlurPostProcess&&(this.motionBlurPostProcess.motionStrength=e)}get objectBasedMotionBlur(){return this._isObjectBasedMotionBlur}set objectBasedMotionBlur(e){const t=this._isObjectBasedMotionBlur!==e;this._isObjectBasedMotionBlur=e,t&&this._buildPipeline()}get BloomEnabled(){return this._bloomEnabled}set BloomEnabled(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())}get DepthOfFieldEnabled(){return this._depthOfFieldEnabled}set DepthOfFieldEnabled(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())}get LensFlareEnabled(){return this._lensFlareEnabled}set LensFlareEnabled(e){this._lensFlareEnabled!==e&&(this._lensFlareEnabled=e,this._buildPipeline())}get HDREnabled(){return this._hdrEnabled}set HDREnabled(e){this._hdrEnabled!==e&&(this._hdrEnabled=e,this._buildPipeline())}get VLSEnabled(){return this._vlsEnabled}set VLSEnabled(e){if(this._vlsEnabled!==e){if(e&&!this._scene.enableGeometryBufferRenderer()){N.Warn("Geometry renderer is not supported, cannot create volumetric lights in Standard Rendering Pipeline");return}this._vlsEnabled=e,this._buildPipeline()}}get MotionBlurEnabled(){return this._motionBlurEnabled}set MotionBlurEnabled(e){this._motionBlurEnabled!==e&&(this._motionBlurEnabled=e,this._buildPipeline())}get fxaaEnabled(){return this._fxaaEnabled}set fxaaEnabled(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())}get screenSpaceReflectionsEnabled(){return this._screenSpaceReflectionsEnabled}set screenSpaceReflectionsEnabled(e){this._screenSpaceReflectionsEnabled!==e&&(this._screenSpaceReflectionsEnabled=e,this._buildPipeline())}get volumetricLightStepsCount(){return this._volumetricLightStepsCount}set volumetricLightStepsCount(e){this.volumetricLightPostProcess&&this.volumetricLightPostProcess.updateEffect(`#define VLS
#define NB_STEPS `+e.toFixed(1)),this._volumetricLightStepsCount=e}get motionBlurSamples(){return this._motionBlurSamples}set motionBlurSamples(e){this.motionBlurPostProcess&&(this._isObjectBasedMotionBlur?this.motionBlurPostProcess.motionBlurSamples=e:this.motionBlurPostProcess.updateEffect(`#define MOTION_BLUR
#define MAX_MOTION_SAMPLES `+e.toFixed(1))),this._motionBlurSamples=e}get samples(){return this._samples}set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}constructor(e,t,i,r=null,n){super(t.getEngine(),e),this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.blurHPostProcesses=[],this.blurVPostProcesses=[],this.textureAdderPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.luminancePostProcess=null,this.luminanceDownSamplePostProcesses=[],this.hdrPostProcess=null,this.textureAdderFinalPostProcess=null,this.lensFlareFinalPostProcess=null,this.hdrFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.motionBlurPostProcess=null,this.depthOfFieldPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.brightThreshold=1,this.blurWidth=512,this.horizontalBlur=!1,this.lensTexture=null,this.volumetricLightCoefficient=.2,this.volumetricLightPower=4,this.volumetricLightBlurScale=64,this.sourceLight=null,this.hdrMinimumLuminance=1,this.hdrDecreaseRate=.5,this.hdrIncreaseRate=.5,this.lensColorTexture=null,this.lensFlareStrength=20,this.lensFlareGhostDispersal=1.4,this.lensFlareHaloWidth=.7,this.lensFlareDistortionStrength=16,this.lensFlareBlurWidth=512,this.lensStarTexture=null,this.lensFlareDirtTexture=null,this.depthOfFieldDistance=10,this.depthOfFieldBlurWidth=64,this.animations=[],this._currentDepthOfFieldSource=null,this._fixedExposure=1,this._currentExposure=1,this._hdrAutoExposure=!1,this._hdrCurrentLuminance=1,this._motionStrength=1,this._isObjectBasedMotionBlur=!1,this._camerasToBeAttached=[],this._bloomEnabled=!1,this._depthOfFieldEnabled=!1,this._vlsEnabled=!1,this._lensFlareEnabled=!1,this._hdrEnabled=!1,this._motionBlurEnabled=!1,this._fxaaEnabled=!1,this._screenSpaceReflectionsEnabled=!1,this._motionBlurSamples=64,this._volumetricLightStepsCount=50,this._samples=1,this._cameras=n||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._basePostProcess=r,this._ratio=i,this._floatTextureType=t.getEngine().getCaps().textureFloatRender?1:2,t.postProcessRenderPipelineManager.addPipeline(this),this._buildPipeline()}_buildPipeline(){const e=this._ratio,t=this._scene;this._disposePostProcesses(),this._cameras!==null&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._screenSpaceReflectionsEnabled&&(this.screenSpaceReflectionPostProcess=new ts("HDRPass",t,e,null,$.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,this._floatTextureType),this.screenSpaceReflectionPostProcess.onApplyObservable.add(()=>{this._currentDepthOfFieldSource=this.screenSpaceReflectionPostProcess}),this.addEffect(new Ye(t.getEngine(),"HDRScreenSpaceReflections",()=>this.screenSpaceReflectionPostProcess,!0))),this._basePostProcess?this.originalPostProcess=this._basePostProcess:this.originalPostProcess=new Se("HDRPass","standard",[],[],e,null,$.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",this._floatTextureType),this.originalPostProcess.autoClear=!this.screenSpaceReflectionPostProcess,this.originalPostProcess.onApplyObservable.add(()=>{this._currentDepthOfFieldSource=this.originalPostProcess}),this.addEffect(new Ye(t.getEngine(),"HDRPassPostProcess",()=>this.originalPostProcess,!0)),this._bloomEnabled&&(this._createDownSampleX4PostProcess(t,e/4),this._createBrightPassPostProcess(t,e/4),this._createBlurPostProcesses(t,e/4,1),this._createTextureAdderPostProcess(t,e),this.textureAdderFinalPostProcess=new Se("HDRDepthOfFieldSource","standard",[],[],e,null,$.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new Ye(t.getEngine(),"HDRBaseDepthOfFieldSource",()=>this.textureAdderFinalPostProcess,!0))),this._vlsEnabled&&(this._createVolumetricLightPostProcess(t,e),this.volumetricLightFinalPostProcess=new Se("HDRVLSFinal","standard",[],[],e,null,$.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new Ye(t.getEngine(),"HDRVLSFinal",()=>this.volumetricLightFinalPostProcess,!0))),this._lensFlareEnabled&&(this._createLensFlarePostProcess(t,e),this.lensFlareFinalPostProcess=new Se("HDRPostLensFlareDepthOfFieldSource","standard",[],[],e,null,$.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new Ye(t.getEngine(),"HDRPostLensFlareDepthOfFieldSource",()=>this.lensFlareFinalPostProcess,!0))),this._hdrEnabled&&(this._createLuminancePostProcesses(t,this._floatTextureType),this._createHdrPostProcess(t,e),this.hdrFinalPostProcess=new Se("HDRPostHDReDepthOfFieldSource","standard",[],[],e,null,$.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new Ye(t.getEngine(),"HDRPostHDReDepthOfFieldSource",()=>this.hdrFinalPostProcess,!0))),this._depthOfFieldEnabled&&(this._createBlurPostProcesses(t,e/2,3,"depthOfFieldBlurWidth"),this._createDepthOfFieldPostProcess(t,e)),this._motionBlurEnabled&&this._createMotionBlurPostProcess(t,e),this._fxaaEnabled&&(this.fxaaPostProcess=new el("fxaa",1,null,$.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,0),this.addEffect(new Ye(t.getEngine(),"HDRFxaa",()=>this.fxaaPostProcess,!0))),this._cameras!==null&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),!this._enableMSAAOnFirstPostProcess(this._samples)&&this._samples>1&&N.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0")}_createDownSampleX4PostProcess(e,t){const i=new Array(32);this.downSampleX4PostProcess=new Se("HDRDownSampleX4","standard",["dsOffsets"],[],t,null,$.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DOWN_SAMPLE_X4",this._floatTextureType),this.downSampleX4PostProcess.onApply=r=>{let n=0;const a=this.downSampleX4PostProcess.width,o=this.downSampleX4PostProcess.height;for(let l=-2;l<2;l++)for(let c=-2;c<2;c++)i[n]=(l+.5)*(1/a),i[n+1]=(c+.5)*(1/o),n+=2;r.setArray2("dsOffsets",i)},this.addEffect(new Ye(e.getEngine(),"HDRDownSampleX4",()=>this.downSampleX4PostProcess,!0))}_createBrightPassPostProcess(e,t){const i=new Array(8);this.brightPassPostProcess=new Se("HDRBrightPass","standard",["dsOffsets","brightThreshold"],[],t,null,$.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define BRIGHT_PASS",this._floatTextureType),this.brightPassPostProcess.onApply=r=>{const n=1/this.brightPassPostProcess.width,a=1/this.brightPassPostProcess.height;i[0]=-.5*n,i[1]=.5*a,i[2]=.5*n,i[3]=.5*a,i[4]=-.5*n,i[5]=-.5*a,i[6]=.5*n,i[7]=-.5*a,r.setArray2("dsOffsets",i),r.setFloat("brightThreshold",this.brightThreshold)},this.addEffect(new Ye(e.getEngine(),"HDRBrightPass",()=>this.brightPassPostProcess,!0))}_createBlurPostProcesses(e,t,i,r="blurWidth"){const n=e.getEngine(),a=new nr("HDRBlurH_"+i,new X(1,0),this[r],t,null,$.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType),o=new nr("HDRBlurV_"+i,new X(0,1),this[r],t,null,$.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType);a.onActivateObservable.add(()=>{const l=a.width/n.getRenderWidth();a.kernel=this[r]*l}),o.onActivateObservable.add(()=>{const l=o.height/n.getRenderHeight();o.kernel=this.horizontalBlur?64*l:this[r]*l}),this.addEffect(new Ye(e.getEngine(),"HDRBlurH"+i,()=>a,!0)),this.addEffect(new Ye(e.getEngine(),"HDRBlurV"+i,()=>o,!0)),this.blurHPostProcesses.push(a),this.blurVPostProcesses.push(o)}_createTextureAdderPostProcess(e,t){this.textureAdderPostProcess=new Se("HDRTextureAdder","standard",["exposure"],["otherSampler","lensSampler"],t,null,$.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define TEXTURE_ADDER",this._floatTextureType),this.textureAdderPostProcess.onApply=i=>{i.setTextureFromPostProcess("otherSampler",this._vlsEnabled?this._currentDepthOfFieldSource:this.originalPostProcess),i.setTexture("lensSampler",this.lensTexture),i.setFloat("exposure",this._currentExposure),this._currentDepthOfFieldSource=this.textureAdderFinalPostProcess},this.addEffect(new Ye(e.getEngine(),"HDRTextureAdder",()=>this.textureAdderPostProcess,!0))}_createVolumetricLightPostProcess(e,t){const i=e.enableGeometryBufferRenderer();i.enablePosition=!0;const r=i.getGBuffer();this.volumetricLightPostProcess=new Se("HDRVLS","standard",["shadowViewProjection","cameraPosition","sunDirection","sunColor","scatteringCoefficient","scatteringPower","depthValues"],["shadowMapSampler","positionSampler"],t/8,null,$.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,`#define VLS
#define NB_STEPS `+this._volumetricLightStepsCount.toFixed(1));const n=X.Zero();this.volumetricLightPostProcess.onApply=a=>{if(this.sourceLight&&this.sourceLight.getShadowGenerator()&&this._scene.activeCamera){const o=this.sourceLight.getShadowGenerator();a.setTexture("shadowMapSampler",o.getShadowMap()),a.setTexture("positionSampler",r.textures[2]),a.setColor3("sunColor",this.sourceLight.diffuse),a.setVector3("sunDirection",this.sourceLight.getShadowDirection()),a.setVector3("cameraPosition",this._scene.activeCamera.globalPosition),a.setMatrix("shadowViewProjection",o.getTransformMatrix()),a.setFloat("scatteringCoefficient",this.volumetricLightCoefficient),a.setFloat("scatteringPower",this.volumetricLightPower),n.x=this.sourceLight.getDepthMinZ(this._scene.activeCamera),n.y=this.sourceLight.getDepthMaxZ(this._scene.activeCamera),a.setVector2("depthValues",n)}},this.addEffect(new Ye(e.getEngine(),"HDRVLS",()=>this.volumetricLightPostProcess,!0)),this._createBlurPostProcesses(e,t/4,0,"volumetricLightBlurScale"),this.volumetricLightMergePostProces=new Se("HDRVLSMerge","standard",[],["originalSampler"],t,null,$.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define VLSMERGE"),this.volumetricLightMergePostProces.onApply=a=>{a.setTextureFromPostProcess("originalSampler",this._bloomEnabled?this.textureAdderFinalPostProcess:this.originalPostProcess),this._currentDepthOfFieldSource=this.volumetricLightFinalPostProcess},this.addEffect(new Ye(e.getEngine(),"HDRVLSMerge",()=>this.volumetricLightMergePostProces,!0))}_createLuminancePostProcesses(e,t){let i=Math.pow(3,je.LuminanceSteps);this.luminancePostProcess=new Se("HDRLuminance","standard",["lumOffsets"],[],{width:i,height:i},null,$.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LUMINANCE",t);const r=[];this.luminancePostProcess.onApply=a=>{const o=1/this.luminancePostProcess.width,l=1/this.luminancePostProcess.height;r[0]=-.5*o,r[1]=.5*l,r[2]=.5*o,r[3]=.5*l,r[4]=-.5*o,r[5]=-.5*l,r[6]=.5*o,r[7]=-.5*l,a.setArray2("lumOffsets",r)},this.addEffect(new Ye(e.getEngine(),"HDRLuminance",()=>this.luminancePostProcess,!0));for(let a=je.LuminanceSteps-1;a>=0;a--){i=Math.pow(3,a);let o=`#define LUMINANCE_DOWN_SAMPLE
`;a===0&&(o+="#define FINAL_DOWN_SAMPLER");const l=new Se("HDRLuminanceDownSample"+a,"standard",["dsOffsets","halfDestPixelSize"],[],{width:i,height:i},null,$.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,o,t);this.luminanceDownSamplePostProcesses.push(l)}let n=this.luminancePostProcess;for(let a=0;a<this.luminanceDownSamplePostProcesses.length;a++){const o=this.luminanceDownSamplePostProcesses[a],l=new Array(18);o.onApply=c=>{if(!n)return;let u=0;for(let h=-1;h<2;h++)for(let d=-1;d<2;d++)l[u]=h/n.width,l[u+1]=d/n.height,u+=2;c.setArray2("dsOffsets",l),c.setFloat("halfDestPixelSize",.5/n.width),a===this.luminanceDownSamplePostProcesses.length-1?n=this.luminancePostProcess:n=o},a===this.luminanceDownSamplePostProcesses.length-1&&(o.onAfterRender=()=>{const c=e.getEngine().readPixels(0,0,1,1),u=new Ee(1/(255*255*255),1/(255*255),1/255,1);c.then(h=>{const d=new Uint8Array(h.buffer);this._hdrCurrentLuminance=(d[0]*u.x+d[1]*u.y+d[2]*u.z+d[3]*u.w)/100})}),this.addEffect(new Ye(e.getEngine(),"HDRLuminanceDownSample"+a,()=>o,!0))}}_createHdrPostProcess(e,t){const i=["#define HDR"];this._hdrAutoExposure&&i.push("#define AUTO_EXPOSURE"),this.hdrPostProcess=new Se("HDR","standard",["averageLuminance"],["textureAdderSampler"],t,null,$.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,i.join(`
`),0);let r=1,n=0,a=0;this.hdrPostProcess.onApply=o=>{if(o.setTextureFromPostProcess("textureAdderSampler",this._currentDepthOfFieldSource),n+=e.getEngine().getDeltaTime(),r<0)r=this._hdrCurrentLuminance;else{const l=(a-n)/1e3;this._hdrCurrentLuminance<r+this.hdrDecreaseRate*l?r+=this.hdrDecreaseRate*l:this._hdrCurrentLuminance>r-this.hdrIncreaseRate*l?r-=this.hdrIncreaseRate*l:r=this._hdrCurrentLuminance}this.hdrAutoExposure?this._currentExposure=this._fixedExposure/r:(r=ls(r,this.hdrMinimumLuminance,1e20),o.setFloat("averageLuminance",r)),a=n,this._currentDepthOfFieldSource=this.hdrFinalPostProcess},this.addEffect(new Ye(e.getEngine(),"HDR",()=>this.hdrPostProcess,!0))}_createLensFlarePostProcess(e,t){this.lensFlarePostProcess=new Se("HDRLensFlare","standard",["strength","ghostDispersal","haloWidth","resolution","distortionStrength"],["lensColorSampler"],t/2,null,$.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE",0),this.addEffect(new Ye(e.getEngine(),"HDRLensFlare",()=>this.lensFlarePostProcess,!0)),this._createBlurPostProcesses(e,t/4,2,"lensFlareBlurWidth"),this.lensFlareComposePostProcess=new Se("HDRLensFlareCompose","standard",["lensStarMatrix"],["otherSampler","lensDirtSampler","lensStarSampler"],t,null,$.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE_COMPOSE",0),this.addEffect(new Ye(e.getEngine(),"HDRLensFlareCompose",()=>this.lensFlareComposePostProcess,!0));const i=new X(0,0);this.lensFlarePostProcess.externalTextureSamplerBinding=!0,this.lensFlarePostProcess.onApply=a=>{a.setTextureFromPostProcess("textureSampler",this._bloomEnabled?this.blurHPostProcesses[0]:this.originalPostProcess),a.setTexture("lensColorSampler",this.lensColorTexture),a.setFloat("strength",this.lensFlareStrength),a.setFloat("ghostDispersal",this.lensFlareGhostDispersal),a.setFloat("haloWidth",this.lensFlareHaloWidth),i.x=this.lensFlarePostProcess.width,i.y=this.lensFlarePostProcess.height,a.setVector2("resolution",i),a.setFloat("distortionStrength",this.lensFlareDistortionStrength)};const r=z.FromValues(2,0,-1,0,0,2,-1,0,0,0,1,0,0,0,0,1),n=z.FromValues(.5,0,.5,0,0,.5,.5,0,0,0,1,0,0,0,0,1);this.lensFlareComposePostProcess.onApply=a=>{if(!this._scene.activeCamera)return;a.setTextureFromPostProcess("otherSampler",this.lensFlarePostProcess),a.setTexture("lensDirtSampler",this.lensFlareDirtTexture),a.setTexture("lensStarSampler",this.lensStarTexture);const o=this._scene.activeCamera.getViewMatrix().getRow(0),l=this._scene.activeCamera.getViewMatrix().getRow(2);let c=x.Dot(o.toVector3(),new x(1,0,0))+x.Dot(l.toVector3(),new x(0,0,1));c*=4;const u=z.FromValues(Math.cos(c)*.5,-Math.sin(c),0,0,Math.sin(c),Math.cos(c)*.5,0,0,0,0,1,0,0,0,0,1),h=n.multiply(u).multiply(r);a.setMatrix("lensStarMatrix",h),this._currentDepthOfFieldSource=this.lensFlareFinalPostProcess}}_createDepthOfFieldPostProcess(e,t){this.depthOfFieldPostProcess=new Se("HDRDepthOfField","standard",["distance"],["otherSampler","depthSampler"],t,null,$.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DEPTH_OF_FIELD",0),this.depthOfFieldPostProcess.onApply=i=>{i.setTextureFromPostProcess("otherSampler",this._currentDepthOfFieldSource),i.setTexture("depthSampler",this._getDepthTexture()),i.setFloat("distance",this.depthOfFieldDistance)},this.addEffect(new Ye(e.getEngine(),"HDRDepthOfField",()=>this.depthOfFieldPostProcess,!0))}_createMotionBlurPostProcess(e,t){if(this._isObjectBasedMotionBlur){const i=new za("HDRMotionBlur",e,t,null,$.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,0);i.motionStrength=this.motionStrength,i.motionBlurSamples=this.motionBlurSamples,this.motionBlurPostProcess=i}else{this.motionBlurPostProcess=new Se("HDRMotionBlur","standard",["inverseViewProjection","prevViewProjection","screenSize","motionScale","motionStrength"],["depthSampler"],t,null,$.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,`#define MOTION_BLUR
#define MAX_MOTION_SAMPLES `+this.motionBlurSamples.toFixed(1),0);let i=0,r=z.Identity();const n=z.Identity();let a=z.Identity();const o=X.Zero();this.motionBlurPostProcess.onApply=l=>{a=e.getProjectionMatrix().multiply(e.getViewMatrix()),a.invertToRef(n),l.setMatrix("inverseViewProjection",n),l.setMatrix("prevViewProjection",r),r=a,o.x=this.motionBlurPostProcess.width,o.y=this.motionBlurPostProcess.height,l.setVector2("screenSize",o),i=e.getEngine().getFps()/60,l.setFloat("motionScale",i),l.setFloat("motionStrength",this.motionStrength),l.setTexture("depthSampler",this._getDepthTexture())}}this.addEffect(new Ye(e.getEngine(),"HDRMotionBlur",()=>this.motionBlurPostProcess,!0))}_getDepthTexture(){return this._scene.getEngine().getCaps().drawBuffersExtension?this._scene.enableGeometryBufferRenderer().getGBuffer().textures[0]:this._scene.enableDepthRenderer().getDepthMap()}_disposePostProcesses(){for(let e=0;e<this._cameras.length;e++){const t=this._cameras[e];this.originalPostProcess&&this.originalPostProcess.dispose(t),this.screenSpaceReflectionPostProcess&&this.screenSpaceReflectionPostProcess.dispose(t),this.downSampleX4PostProcess&&this.downSampleX4PostProcess.dispose(t),this.brightPassPostProcess&&this.brightPassPostProcess.dispose(t),this.textureAdderPostProcess&&this.textureAdderPostProcess.dispose(t),this.volumetricLightPostProcess&&this.volumetricLightPostProcess.dispose(t),this.volumetricLightSmoothXPostProcess&&this.volumetricLightSmoothXPostProcess.dispose(t),this.volumetricLightSmoothYPostProcess&&this.volumetricLightSmoothYPostProcess.dispose(t),this.volumetricLightMergePostProces&&this.volumetricLightMergePostProces.dispose(t),this.volumetricLightFinalPostProcess&&this.volumetricLightFinalPostProcess.dispose(t),this.lensFlarePostProcess&&this.lensFlarePostProcess.dispose(t),this.lensFlareComposePostProcess&&this.lensFlareComposePostProcess.dispose(t);for(let i=0;i<this.luminanceDownSamplePostProcesses.length;i++)this.luminanceDownSamplePostProcesses[i].dispose(t);this.luminancePostProcess&&this.luminancePostProcess.dispose(t),this.hdrPostProcess&&this.hdrPostProcess.dispose(t),this.hdrFinalPostProcess&&this.hdrFinalPostProcess.dispose(t),this.depthOfFieldPostProcess&&this.depthOfFieldPostProcess.dispose(t),this.motionBlurPostProcess&&this.motionBlurPostProcess.dispose(t),this.fxaaPostProcess&&this.fxaaPostProcess.dispose(t);for(let i=0;i<this.blurHPostProcesses.length;i++)this.blurHPostProcesses[i].dispose(t);for(let i=0;i<this.blurVPostProcesses.length;i++)this.blurVPostProcesses[i].dispose(t)}this.originalPostProcess=null,this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.textureAdderPostProcess=null,this.textureAdderFinalPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.luminancePostProcess=null,this.hdrPostProcess=null,this.hdrFinalPostProcess=null,this.depthOfFieldPostProcess=null,this.motionBlurPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.luminanceDownSamplePostProcesses.length=0,this.blurHPostProcesses.length=0,this.blurVPostProcesses.length=0}dispose(){this._disposePostProcesses(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._scene.postProcessRenderPipelineManager.removePipeline(this._name),super.dispose()}serialize(){const e=me.Serialize(this);return this.sourceLight&&(e.sourceLightId=this.sourceLight.id),this.screenSpaceReflectionPostProcess&&(e.screenSpaceReflectionPostProcess=me.Serialize(this.screenSpaceReflectionPostProcess)),e.customType="StandardRenderingPipeline",e}static Parse(e,t,i){const r=me.Parse(()=>new je(e._name,t,e._ratio),e,t,i);return e.sourceLightId&&(r.sourceLight=t.getLightById(e.sourceLightId)),e.screenSpaceReflectionPostProcess&&me.Parse(()=>r.screenSpaceReflectionPostProcess,e.screenSpaceReflectionPostProcess,t,i),r}}je.LuminanceSteps=6;_([R()],je.prototype,"brightThreshold",void 0);_([R()],je.prototype,"blurWidth",void 0);_([R()],je.prototype,"horizontalBlur",void 0);_([R()],je.prototype,"exposure",null);_([We("lensTexture")],je.prototype,"lensTexture",void 0);_([R()],je.prototype,"volumetricLightCoefficient",void 0);_([R()],je.prototype,"volumetricLightPower",void 0);_([R()],je.prototype,"volumetricLightBlurScale",void 0);_([R()],je.prototype,"hdrMinimumLuminance",void 0);_([R()],je.prototype,"hdrDecreaseRate",void 0);_([R()],je.prototype,"hdrIncreaseRate",void 0);_([R()],je.prototype,"hdrAutoExposure",null);_([We("lensColorTexture")],je.prototype,"lensColorTexture",void 0);_([R()],je.prototype,"lensFlareStrength",void 0);_([R()],je.prototype,"lensFlareGhostDispersal",void 0);_([R()],je.prototype,"lensFlareHaloWidth",void 0);_([R()],je.prototype,"lensFlareDistortionStrength",void 0);_([R()],je.prototype,"lensFlareBlurWidth",void 0);_([We("lensStarTexture")],je.prototype,"lensStarTexture",void 0);_([We("lensFlareDirtTexture")],je.prototype,"lensFlareDirtTexture",void 0);_([R()],je.prototype,"depthOfFieldDistance",void 0);_([R()],je.prototype,"depthOfFieldBlurWidth",void 0);_([R()],je.prototype,"motionStrength",null);_([R()],je.prototype,"objectBasedMotionBlur",null);_([R()],je.prototype,"_ratio",void 0);_([R()],je.prototype,"BloomEnabled",null);_([R()],je.prototype,"DepthOfFieldEnabled",null);_([R()],je.prototype,"LensFlareEnabled",null);_([R()],je.prototype,"HDREnabled",null);_([R()],je.prototype,"VLSEnabled",null);_([R()],je.prototype,"MotionBlurEnabled",null);_([R()],je.prototype,"fxaaEnabled",null);_([R()],je.prototype,"screenSpaceReflectionsEnabled",null);_([R()],je.prototype,"volumetricLightStepsCount",null);_([R()],je.prototype,"motionBlurSamples",null);_([R()],je.prototype,"samples",null);y("BABYLON.StandardRenderingPipeline",je);class S${constructor(e=!1){this.enabled=!1,this.name="screenSpaceReflections2",this.texturesRequired=[6,3],this.texturesRequired.push(e?10:5)}}class Tt extends Ha{set samples(e){this._samples!==e&&(this._samples=e,this._ssrPostProcess&&(this._ssrPostProcess.samples=this.samples))}get samples(){return this._samples}get maxDistance(){return this._thinSSRRenderingPipeline.maxDistance}set maxDistance(e){this._thinSSRRenderingPipeline.maxDistance=e}get step(){return this._thinSSRRenderingPipeline.step}set step(e){this._thinSSRRenderingPipeline.step=e}get thickness(){return this._thinSSRRenderingPipeline.thickness}set thickness(e){this._thinSSRRenderingPipeline.thickness=e}get strength(){return this._thinSSRRenderingPipeline.strength}set strength(e){this._thinSSRRenderingPipeline.strength=e}get reflectionSpecularFalloffExponent(){return this._thinSSRRenderingPipeline.reflectionSpecularFalloffExponent}set reflectionSpecularFalloffExponent(e){this._thinSSRRenderingPipeline.reflectionSpecularFalloffExponent=e}get maxSteps(){return this._thinSSRRenderingPipeline.maxSteps}set maxSteps(e){this._thinSSRRenderingPipeline.maxSteps=e}get roughnessFactor(){return this._thinSSRRenderingPipeline.roughnessFactor}set roughnessFactor(e){this._thinSSRRenderingPipeline.roughnessFactor=e}get selfCollisionNumSkip(){return this._thinSSRRenderingPipeline.selfCollisionNumSkip}set selfCollisionNumSkip(e){this._thinSSRRenderingPipeline.selfCollisionNumSkip=e}get reflectivityThreshold(){return this._thinSSRRenderingPipeline.reflectivityThreshold}set reflectivityThreshold(e){const t=this.reflectivityThreshold;e!==t&&(this._thinSSRRenderingPipeline.reflectivityThreshold=e,(e===0&&t!==0||e!==0&&t===0)&&this._buildPipeline())}get ssrDownsample(){return this._thinSSRRenderingPipeline.ssrDownsample}set ssrDownsample(e){this._thinSSRRenderingPipeline.ssrDownsample=e,this._buildPipeline()}get blurDispersionStrength(){return this._thinSSRRenderingPipeline.blurDispersionStrength}set blurDispersionStrength(e){const t=this.blurDispersionStrength;e!==t&&(this._thinSSRRenderingPipeline.blurDispersionStrength=e,(e===0&&t!==0||e!==0&&t===0)&&this._buildPipeline())}_useBlur(){return this.blurDispersionStrength>0}get blurDownsample(){return this._thinSSRRenderingPipeline.blurDownsample}set blurDownsample(e){this._thinSSRRenderingPipeline.blurDownsample=e,this._buildPipeline()}get enableSmoothReflections(){return this._thinSSRRenderingPipeline.enableSmoothReflections}set enableSmoothReflections(e){this._thinSSRRenderingPipeline.enableSmoothReflections=e}get _useScreenspaceDepth(){return this._thinSSRRenderingPipeline.useScreenspaceDepth}get environmentTexture(){return this._thinSSRRenderingPipeline.environmentTexture}set environmentTexture(e){this._thinSSRRenderingPipeline.environmentTexture=e}get environmentTextureIsProbe(){return this._thinSSRRenderingPipeline.environmentTextureIsProbe}set environmentTextureIsProbe(e){this._thinSSRRenderingPipeline.environmentTextureIsProbe=e}get attenuateScreenBorders(){return this._thinSSRRenderingPipeline.attenuateScreenBorders}set attenuateScreenBorders(e){this._thinSSRRenderingPipeline.attenuateScreenBorders=e}get attenuateIntersectionDistance(){return this._thinSSRRenderingPipeline.attenuateIntersectionDistance}set attenuateIntersectionDistance(e){this._thinSSRRenderingPipeline.attenuateIntersectionDistance=e}get attenuateIntersectionIterations(){return this._thinSSRRenderingPipeline.attenuateIntersectionIterations}set attenuateIntersectionIterations(e){this._thinSSRRenderingPipeline.attenuateIntersectionIterations=e}get attenuateFacingCamera(){return this._thinSSRRenderingPipeline.attenuateFacingCamera}set attenuateFacingCamera(e){this._thinSSRRenderingPipeline.attenuateFacingCamera=e}get attenuateBackfaceReflection(){return this._thinSSRRenderingPipeline.attenuateBackfaceReflection}set attenuateBackfaceReflection(e){this._thinSSRRenderingPipeline.attenuateBackfaceReflection=e}get clipToFrustum(){return this._thinSSRRenderingPipeline.clipToFrustum}set clipToFrustum(e){this._thinSSRRenderingPipeline.clipToFrustum=e}get useFresnel(){return this._thinSSRRenderingPipeline.useFresnel}set useFresnel(e){this._thinSSRRenderingPipeline.useFresnel=e,this._buildPipeline()}get enableAutomaticThicknessComputation(){return this._thinSSRRenderingPipeline.enableAutomaticThicknessComputation}set enableAutomaticThicknessComputation(e){this._thinSSRRenderingPipeline.enableAutomaticThicknessComputation=e,this._buildPipeline()}get backfaceDepthRenderer(){return this._depthRenderer}get backfaceDepthTextureDownsample(){return this._backfaceDepthTextureDownsample}set backfaceDepthTextureDownsample(e){this._backfaceDepthTextureDownsample!==e&&(this._backfaceDepthTextureDownsample=e,this._resizeDepthRenderer())}get backfaceForceDepthWriteTransparentMeshes(){return this._backfaceForceDepthWriteTransparentMeshes}set backfaceForceDepthWriteTransparentMeshes(e){this._backfaceForceDepthWriteTransparentMeshes!==e&&(this._backfaceForceDepthWriteTransparentMeshes=e,this._depthRenderer&&(this._depthRenderer.forceDepthWriteTransparentMeshes=e))}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,e?e&&(this._isDirty?this._buildPipeline():this._cameras!==null&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)):this._cameras!==null&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()))}get inputTextureColorIsInGammaSpace(){return this._thinSSRRenderingPipeline.inputTextureColorIsInGammaSpace}set inputTextureColorIsInGammaSpace(e){this._thinSSRRenderingPipeline.inputTextureColorIsInGammaSpace=e,this._buildPipeline()}get generateOutputInGammaSpace(){return this._thinSSRRenderingPipeline.generateOutputInGammaSpace}set generateOutputInGammaSpace(e){this._thinSSRRenderingPipeline.generateOutputInGammaSpace=e,this._buildPipeline()}get debug(){return this._thinSSRRenderingPipeline.debug}set debug(e){this._thinSSRRenderingPipeline.debug=e,this._buildPipeline()}getScene(){return this._scene}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}get scene(){return this._scene}get isSupported(){const e=this._scene.getEngine().getCaps();return e.drawBuffersExtension&&e.texelFetch}constructor(e,t,i,r=!1,n=0,a=!1){if(super(t.getEngine(),e),this.SSRRenderEffect="SSRRenderEffect",this.SSRBlurRenderEffect="SSRBlurRenderEffect",this.SSRCombineRenderEffect="SSRCombineRenderEffect",this._samples=1,this._backfaceDepthTextureDownsample=0,this._backfaceForceDepthWriteTransparentMeshes=!0,this._isEnabled=!0,this._forceGeometryBuffer=!1,this._isDirty=!1,this._camerasToBeAttached=[],this._thinSSRRenderingPipeline=new UR(e,t),this._thinSSRRenderingPipeline.isSSRSupported=!1,this._thinSSRRenderingPipeline.useScreenspaceDepth=a,this._cameras=i||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._textureType=n,this._forceGeometryBuffer=r,this.isSupported){if(this._createSSRPostProcess(),t.postProcessRenderPipelineManager.addPipeline(this),this._forceGeometryBuffer){const o=t.enableGeometryBufferRenderer();o&&(o.enableReflectivity=!0,o.useSpecificClearForDepthTexture=!0,o.enableScreenspaceDepth=this._useScreenspaceDepth,o.enableDepth=!this._useScreenspaceDepth)}else{const o=t.enablePrePassRenderer();o&&(o.useSpecificClearForDepthTexture=!0,o.markAsDirty())}this._thinSSRRenderingPipeline.isSSRSupported=!!this._geometryBufferRenderer||!!this._prePassRenderer,this._buildPipeline()}}getClassName(){return"SSRRenderingPipeline"}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){const t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(e=!1){this._disposeDepthRenderer(),this._disposeSSRPostProcess(),this._disposeBlurPostProcesses(),e&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._scene.postProcessRenderPipelineManager.removePipeline(this._name),this._thinSSRRenderingPipeline.dispose(),super.dispose()}_getTextureSize(){var r,n;const e=this._scene.getEngine(),t=this._prePassRenderer;let i={width:e.getRenderWidth(),height:e.getRenderHeight()};if(t&&((r=this._scene.activeCamera)==null?void 0:r._getFirstPostProcess())===this._ssrPostProcess){const a=t.getRenderTarget();a&&a.textures&&(i=a.textures[t.getIndex(4)].getSize())}else(n=this._ssrPostProcess)!=null&&n.inputTexture&&(i.width=this._ssrPostProcess.inputTexture.width,i.height=this._ssrPostProcess.inputTexture.height);return i}_buildPipeline(){var t,i,r;if(!this.isSupported)return;if(!this._isEnabled){this._isDirty=!0;return}this._isDirty=!1;const e=this._scene.getEngine();if(this._disposeDepthRenderer(),this._cameras!==null&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice(),this._cameras.length>0&&(this._thinSSRRenderingPipeline.camera=this._cameras[0])),this._reset(),this._thinSSRRenderingPipeline.normalsAreInWorldSpace=!!(((t=this._geometryBufferRenderer)==null?void 0:t.generateNormalsInWorldSpace)??((i=this._prePassRenderer)==null?void 0:i.generateNormalsInWorldSpace)),this.enableAutomaticThicknessComputation){const n=(r=this._cameras)==null?void 0:r[0];n&&(this._depthRendererCamera=n,this._depthRenderer=new Qm(this._scene,void 0,void 0,this._useScreenspaceDepth,1,!this._useScreenspaceDepth,"SSRBackDepth"),this._depthRenderer.reverseCulling=!0,this._depthRenderer.forceDepthWriteTransparentMeshes=this.backfaceForceDepthWriteTransparentMeshes,this._resizeDepthRenderer(),n.customRenderTargets.push(this._depthRenderer.getDepthMap()))}this.addEffect(new Ye(e,this.SSRRenderEffect,()=>this._ssrPostProcess,!0)),this._disposeBlurPostProcesses(),this._useBlur()&&(this._createBlurAndCombinerPostProcesses(),this.addEffect(new Ye(e,this.SSRBlurRenderEffect,()=>[this._blurPostProcessX,this._blurPostProcessY],!0)),this.addEffect(new Ye(e,this.SSRCombineRenderEffect,()=>this._blurCombinerPostProcess,!0))),this._cameras!==null&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)}_resizeDepthRenderer(){if(!this._depthRenderer)return;const e=this._getTextureSize(),t=this._depthRenderer.getDepthMap().getSize(),i=Math.floor(e.width/(this.backfaceDepthTextureDownsample+1)),r=Math.floor(e.height/(this.backfaceDepthTextureDownsample+1));(t.width!==i||t.height!==r)&&this._depthRenderer.getDepthMap().resize({width:i,height:r})}_disposeDepthRenderer(){if(this._depthRenderer){if(this._depthRendererCamera){const e=this._depthRendererCamera.customRenderTargets.indexOf(this._depthRenderer.getDepthMap())??-1;e!==-1&&this._depthRendererCamera.customRenderTargets.splice(e,1)}this._depthRendererCamera=null,this._depthRenderer.getDepthMap().dispose()}this._depthRenderer=null}_disposeBlurPostProcesses(){var e,t,i;for(let r=0;r<this._cameras.length;r++){const n=this._cameras[r];(e=this._blurPostProcessX)==null||e.dispose(n),(t=this._blurPostProcessY)==null||t.dispose(n),(i=this._blurCombinerPostProcess)==null||i.dispose(n)}this._blurPostProcessX=null,this._blurPostProcessY=null,this._blurCombinerPostProcess=null}_disposeSSRPostProcess(){var e;for(let t=0;t<this._cameras.length;t++){const i=this._cameras[t];(e=this._ssrPostProcess)==null||e.dispose(i)}this._ssrPostProcess=null}_createSSRPostProcess(){this._ssrPostProcess=new Se("ssr",Jr.FragmentUrl,{uniformNames:Jr.Uniforms,samplerNames:Jr.Samplers,size:1,samplingMode:2,engine:this._scene.getEngine(),textureType:this._textureType,effectWrapper:this._thinSSRRenderingPipeline._ssrPostProcess}),this._ssrPostProcess.onApply=e=>{this._resizeDepthRenderer();const t=this._geometryBufferRenderer,i=this._prePassRenderer;if(!i&&!t)return;if(t){const n=t.getTextureIndex(Ae.REFLECTIVITY_TEXTURE_TYPE),a=t.getTextureIndex(Ae.NORMAL_TEXTURE_TYPE);if(e.setTexture("normalSampler",t.getGBuffer().textures[a]),e.setTexture("reflectivitySampler",t.getGBuffer().textures[n]),this._useScreenspaceDepth){const o=t.getTextureIndex(Ae.SCREENSPACE_DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",t.getGBuffer().textures[o])}else{const o=t.getTextureIndex(Ae.DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",t.getGBuffer().textures[o])}}else if(i){const n=i.getIndex(this._useScreenspaceDepth?10:5),a=i.getIndex(3),o=i.getIndex(6);e.setTexture("normalSampler",i.getRenderTarget().textures[o]),e.setTexture("depthSampler",i.getRenderTarget().textures[n]),e.setTexture("reflectivitySampler",i.getRenderTarget().textures[a])}this.enableAutomaticThicknessComputation&&this._depthRenderer&&(e.setTexture("backDepthSampler",this._depthRenderer.getDepthMap()),e.setFloat("backSizeFactor",this.backfaceDepthTextureDownsample+1));const r=this._getTextureSize();this._thinSSRRenderingPipeline._ssrPostProcess.textureWidth=r.width,this._thinSSRRenderingPipeline._ssrPostProcess.textureHeight=r.height},this._ssrPostProcess.samples=this.samples,this._forceGeometryBuffer||(this._ssrPostProcess._prePassEffectConfiguration=new S$(this._useScreenspaceDepth))}_createBlurAndCombinerPostProcesses(){const e=this._scene.getEngine();this._blurPostProcessX=new Se("SSRblurX",Yi.FragmentUrl,{uniformNames:Yi.Uniforms,samplerNames:Yi.Samplers,size:1/(this.ssrDownsample+1),samplingMode:2,engine:e,textureType:this._textureType,effectWrapper:this._thinSSRRenderingPipeline._ssrBlurXPostProcess}),this._blurPostProcessX.autoClear=!1,this._blurPostProcessX.onApplyObservable.add(()=>{var t;this._thinSSRRenderingPipeline._ssrBlurXPostProcess.textureWidth=((t=this._blurPostProcessX)==null?void 0:t.inputTexture.width)??this._scene.getEngine().getRenderWidth(),this._thinSSRRenderingPipeline._ssrBlurXPostProcess.textureHeight=1}),this._blurPostProcessY=new Se("SSRblurY",Yi.FragmentUrl,{uniformNames:Yi.Uniforms,samplerNames:Yi.Samplers,size:1/(this.blurDownsample+1),samplingMode:2,engine:e,textureType:this._textureType,effectWrapper:this._thinSSRRenderingPipeline._ssrBlurYPostProcess}),this._blurPostProcessY.autoClear=!1,this._blurPostProcessY.onApplyObservable.add(()=>{var t;this._thinSSRRenderingPipeline._ssrBlurYPostProcess.textureWidth=1,this._thinSSRRenderingPipeline._ssrBlurYPostProcess.textureHeight=((t=this._blurPostProcessY)==null?void 0:t.inputTexture.height)??this._scene.getEngine().getRenderHeight()}),this._blurCombinerPostProcess=new Se("SSRblurCombiner",vs.FragmentUrl,{uniformNames:vs.Uniforms,samplerNames:vs.Samplers,size:1/(this.blurDownsample+1),samplingMode:1,engine:e,textureType:this._textureType,effectWrapper:this._thinSSRRenderingPipeline._ssrBlurCombinerPostProcess}),this._blurCombinerPostProcess.autoClear=!1,this._blurCombinerPostProcess.onApplyObservable.add(t=>{var n;const i=this._geometryBufferRenderer,r=this._prePassRenderer;if(!(!r&&!i)){if(r&&((n=this._scene.activeCamera)==null?void 0:n._getFirstPostProcess())===this._ssrPostProcess){const a=r.getRenderTarget();a&&a.textures&&t.setTexture("mainSampler",a.textures[r.getIndex(4)])}else t.setTextureFromPostProcess("mainSampler",this._ssrPostProcess);if(i){const a=i.getTextureIndex(Ae.REFLECTIVITY_TEXTURE_TYPE);if(t.setTexture("reflectivitySampler",i.getGBuffer().textures[a]),this.useFresnel)if(t.setTexture("normalSampler",i.getGBuffer().textures[1]),this._useScreenspaceDepth){const o=i.getTextureIndex(Ae.SCREENSPACE_DEPTH_TEXTURE_TYPE);t.setTexture("depthSampler",i.getGBuffer().textures[o])}else t.setTexture("depthSampler",i.getGBuffer().textures[0])}else if(r){const a=r.getIndex(3);if(t.setTexture("reflectivitySampler",r.getRenderTarget().textures[a]),this.useFresnel){const o=r.getIndex(this._useScreenspaceDepth?10:5),l=r.getIndex(6);t.setTexture("normalSampler",r.getRenderTarget().textures[l]),t.setTexture("depthSampler",r.getRenderTarget().textures[o])}}}})}serialize(){const e=me.Serialize(this);return e.customType="SSRRenderingPipeline",e}static Parse(e,t,i){return me.Parse(()=>new Tt(e._name,t,e._ratio),e,t,i)}}_([R()],Tt.prototype,"samples",null);_([R()],Tt.prototype,"maxDistance",null);_([R()],Tt.prototype,"step",null);_([R()],Tt.prototype,"thickness",null);_([R()],Tt.prototype,"strength",null);_([R()],Tt.prototype,"reflectionSpecularFalloffExponent",null);_([R()],Tt.prototype,"maxSteps",null);_([R()],Tt.prototype,"roughnessFactor",null);_([R()],Tt.prototype,"selfCollisionNumSkip",null);_([R()],Tt.prototype,"reflectivityThreshold",null);_([R()],Tt.prototype,"ssrDownsample",null);_([R("blurDispersionStrength")],Tt.prototype,"blurDispersionStrength",null);_([R("blurDownsample")],Tt.prototype,"blurDownsample",null);_([R("enableSmoothReflections")],Tt.prototype,"enableSmoothReflections",null);_([R("environmentTexture")],Tt.prototype,"environmentTexture",null);_([R("environmentTextureIsProbe")],Tt.prototype,"environmentTextureIsProbe",null);_([R("attenuateScreenBorders")],Tt.prototype,"attenuateScreenBorders",null);_([R("attenuateIntersectionDistance")],Tt.prototype,"attenuateIntersectionDistance",null);_([R("attenuateIntersectionIterations")],Tt.prototype,"attenuateIntersectionIterations",null);_([R("attenuateFacingCamera")],Tt.prototype,"attenuateFacingCamera",null);_([R("attenuateBackfaceReflection")],Tt.prototype,"attenuateBackfaceReflection",null);_([R("clipToFrustum")],Tt.prototype,"clipToFrustum",null);_([R("useFresnel")],Tt.prototype,"useFresnel",null);_([R("enableAutomaticThicknessComputation")],Tt.prototype,"enableAutomaticThicknessComputation",null);_([R("backfaceDepthTextureDownsample")],Tt.prototype,"_backfaceDepthTextureDownsample",void 0);_([R("backfaceForceDepthWriteTransparentMeshes")],Tt.prototype,"_backfaceForceDepthWriteTransparentMeshes",void 0);_([R("isEnabled")],Tt.prototype,"_isEnabled",void 0);_([R("inputTextureColorIsInGammaSpace")],Tt.prototype,"inputTextureColorIsInGammaSpace",null);_([R("generateOutputInGammaSpace")],Tt.prototype,"generateOutputInGammaSpace",null);_([R("debug")],Tt.prototype,"debug",null);y("BABYLON.SSRRenderingPipeline",Tt);class v$ extends Oi{constructor(){super(...arguments),this.TAA_JITTER=!1}}class wn extends Er{get manager(){return this._manager}set manager(e){this._manager!==e&&(this.dispose(),this._manager=e,e==null||e._materialPlugins.push(this),this._updateMaterial())}get isEnabled(){var e;return((e=this._manager)==null?void 0:e.isEnabled)??!1}constructor(e){super(e,wn.Name,300,new v$),this.registerForExtraEvents=!0,this.doNotSerialize=!0}_updateMaterial(){this._enable(this.isEnabled),this.markAllDefinesAsDirty()}isCompatible(){return!0}getClassName(){return"TAAJitterMaterialPlugin"}prepareDefines(e){e.TAA_JITTER=this.isEnabled}getUniforms(e=0){const t=[{name:"taa_jitter",size:2,type:"vec2"}];return e===0?{ubo:t,vertex:`
                    #ifdef TAA_JITTER
                    uniform vec2 taa_jitter;
                    #endif
                `}:{ubo:t}}hardBindForSubMesh(e){if(this.isEnabled){const t=this._manager.jitter;e.updateFloat2("taa_jitter",t.x,t.y)}}getCustomCode(e,t=0){return e!=="vertex"?null:t===1?{CUSTOM_VERTEX_MAIN_END:`
                    #ifdef TAA_JITTER
                    vertexOutputs.position += vec4f(uniforms.taa_jitter * vertexOutputs.position.w, 0, 1);
                    #endif
                `}:{CUSTOM_VERTEX_MAIN_END:`
                    #ifdef TAA_JITTER
                    gl_Position.xy += taa_jitter * gl_Position.w;
                    #endif
                `}}dispose(){if(this._manager){const e=this._manager._materialPlugins.indexOf(this);e!==-1&&this._manager._materialPlugins.splice(e,1)}}}wn.Name="TAAJitter";y("BABYLON.TAAJitterMaterialPlugin",wn);class x${get isEnabled(){return this._isEnabled}set isEnabled(e){if(this._isEnabled!==e){this._isEnabled=e;for(const t of this._materialPlugins)t._updateMaterial()}}constructor(e){this._isEnabled=!0,this.jitter=new X,this._materialPlugins=[];for(const t of e.materials)this._getPlugin(t);TI(wn.Name,t=>this._getPlugin(t))}dispose(){bI(wn.Name);const e=this._materialPlugins.splice(0,this._materialPlugins.length);for(const t of e)t.manager=null}_getPlugin(e){var i;let t=(i=e.pluginManager)==null?void 0:i.getPlugin(wn.Name);return t||(t=new wn(e)),t.manager=this,t}}class E${constructor(){this.name="taa",this.enabled=!0,this.texturesRequired=[11]}}class Ks extends Ha{set samples(e){this._taaThinPostProcess.samples=e}get samples(){return this._taaThinPostProcess.samples}set msaaSamples(e){this._msaaSamples!==e&&(this._msaaSamples=e,this._taaPostProcess&&(this._taaPostProcess.samples=e))}get msaaSamples(){return this._msaaSamples}get factor(){return this._taaThinPostProcess.factor}set factor(e){this._taaThinPostProcess.factor=e}get disableOnCameraMove(){return this._taaThinPostProcess.disableOnCameraMove}set disableOnCameraMove(e){this._taaThinPostProcess.disableOnCameraMove=e}get reprojectHistory(){return this._taaThinPostProcess.reprojectHistory}set reprojectHistory(e){this.reprojectHistory!==e&&this._updateReprojection(e)}get clampHistory(){return this._taaThinPostProcess.clampHistory}set clampHistory(e){this._taaThinPostProcess.clampHistory=e}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this._taaMaterialManager&&(this._taaMaterialManager.isEnabled=e&&this.reprojectHistory),e?e&&(this._isDirty?this._buildPipeline():this._cameras!==null&&(this._taaThinPostProcess._reset(),this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras))):this._cameras!==null&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()))}get scene(){return this._scene}get isSupported(){return this._scene.getEngine().getCaps().texelFetch}constructor(e,t,i,r=0){const n=t.getEngine();super(n,e),this.TAARenderEffect="TAARenderEffect",this.TAAPassEffect="TAAPassEffect",this._msaaSamples=1,this._isEnabled=!0,this._isDirty=!1,this._camerasToBeAttached=[],this._pingpong=0,this._cameras=i||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._textureType=r,this._taaThinPostProcess=new mn("TAA",this._scene.getEngine()),this.isSupported&&(this._createPingPongTextures(n.getRenderWidth(),n.getRenderHeight()),t.postProcessRenderPipelineManager.addPipeline(this),this._buildPipeline())}getClassName(){return"TAARenderingPipeline"}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){const t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(){var e;this._disposePostProcesses(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._scene.postProcessRenderPipelineManager.removePipeline(this._name),(e=this._taaMaterialManager)==null||e.dispose(),this._ping.dispose(),this._pong.dispose(),super.dispose()}_createPingPongTextures(e,t){var r,n;const i=this._scene.getEngine();(r=this._ping)==null||r.dispose(),(n=this._pong)==null||n.dispose(),this._ping=i.createRenderTargetTexture({width:e,height:t},{generateMipMaps:!1,generateDepthBuffer:!1,type:2,samplingMode:2}),this._pong=i.createRenderTargetTexture({width:e,height:t},{generateMipMaps:!1,generateDepthBuffer:!1,type:2,samplingMode:2}),this._taaThinPostProcess.textureWidth=e,this._taaThinPostProcess.textureHeight=t}_updateReprojection(e){if(e){if(this._scene.enablePrePassRenderer())this._taaMaterialManager||(this._taaMaterialManager=new x$(this._scene));else{N.Warn("TAA reprojection requires PrePass which is not supported");return}this._taaThinPostProcess._reset()}this._taaThinPostProcess.reprojectHistory=e,this._taaMaterialManager&&(this._taaMaterialManager.isEnabled=e&&this._isEnabled),this._buildPipeline()}_buildPipeline(){if(!this.isSupported)return;if(!this._isEnabled){this._isDirty=!0;return}this._isDirty=!1;const e=this._scene.getEngine();this._disposePostProcesses(),this._cameras!==null&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._createTAAPostProcess(),this.addEffect(new Ye(e,this.TAARenderEffect,()=>this._taaPostProcess,!0)),this._createPassPostProcess(),this.addEffect(new Ye(e,this.TAAPassEffect,()=>this._passPostProcess,!0)),this._cameras!==null&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)}_disposePostProcesses(){var e,t;for(let i=0;i<this._cameras.length;i++){const r=this._cameras[i];(e=this._taaPostProcess)==null||e.dispose(r),(t=this._passPostProcess)==null||t.dispose(r),r.getProjectionMatrix(!0)}this._taaPostProcess=null,this._passPostProcess=null}_createTAAPostProcess(){this._taaPostProcess=new Se("TAA","taa",{uniforms:["factor"],samplers:["historySampler"],size:1,engine:this._scene.getEngine(),textureType:this._textureType,effectWrapper:this._taaThinPostProcess}),this.reprojectHistory&&(this._taaPostProcess._prePassEffectConfiguration=new E$),this._taaPostProcess.samples=this._msaaSamples,this._taaPostProcess.onActivateObservable.add(()=>{var e,t;if(this._taaThinPostProcess.camera=this._scene.activeCamera,((e=this._taaPostProcess)==null?void 0:e.width)!==this._ping.width||((t=this._taaPostProcess)==null?void 0:t.height)!==this._ping.height){const i=this._scene.getEngine();this._createPingPongTextures(i.getRenderWidth(),i.getRenderHeight())}this.reprojectHistory&&this._taaMaterialManager?this._taaThinPostProcess.nextJitterOffset(this._taaMaterialManager.jitter):(this._taaThinPostProcess.updateProjectionMatrix(),this._scene.updateTransformMatrix()),this._passPostProcess&&(this._passPostProcess.inputTexture=this._pingpong?this._ping:this._pong),this._pingpong=this._pingpong^1}),this._taaPostProcess.onApplyObservable.add(e=>{e._bindTexture("historySampler",this._pingpong?this._ping.texture:this._pong.texture);const t=this._scene.prePassRenderer;if(this.reprojectHistory&&t){const i=t.getRenderTarget(),r=t.getIndex(11);e.setTexture("velocitySampler",i.textures[r])}})}_createPassPostProcess(){const e=this._scene.getEngine();this._passPostProcess=new Uo("TAAPass",1,null,1,e),this._passPostProcess.inputTexture=this._ping,this._passPostProcess.autoClear=!1}serialize(){const e=me.Serialize(this);return e.customType="TAARenderingPipeline",e}static Parse(e,t,i){return me.Parse(()=>new Ks(e._name,t,e._ratio),e,t,i)}}_([R("samples")],Ks.prototype,"samples",null);_([R("msaaSamples")],Ks.prototype,"_msaaSamples",void 0);_([R()],Ks.prototype,"factor",null);_([R()],Ks.prototype,"disableOnCameraMove",null);_([R()],Ks.prototype,"reprojectHistory",null);_([R()],Ks.prototype,"clampHistory",null);_([R("isEnabled")],Ks.prototype,"_isEnabled",void 0);y("BABYLON.TAARenderingPipeline",Ks);const Ff="ssao2PixelShader",cP=`precision highp float;uniform sampler2D textureSampler;varying vec2 vUV;
#ifdef SSAO
float scales[16]=float[16](
0.1,
0.11406250000000001,
0.131640625,
0.15625,
0.187890625,
0.2265625,
0.272265625,
0.325,
0.384765625,
0.4515625,
0.525390625,
0.60625,
0.694140625,
0.7890625,
0.891015625,
1.0
);uniform float near;uniform float radius;uniform sampler2D depthSampler;uniform sampler2D randomSampler;uniform sampler2D normalSampler;uniform float randTextureTiles;uniform float samplesFactor;uniform vec3 sampleSphere[SAMPLES];uniform float totalStrength;uniform float base;
#ifdef ORTHOGRAPHIC_CAMERA
uniform vec4 viewport;
#else
uniform float xViewport;uniform float yViewport;
#endif
uniform mat3 depthProjection;uniform float maxZ;uniform float minZAspect;uniform vec2 texelSize;uniform mat4 projection;void main()
{vec3 random=textureLod(randomSampler,vUV*randTextureTiles,0.0).rgb;float depth=textureLod(depthSampler,vUV,0.0).r;float depthSign=sign(depth);depth=depth*depthSign;vec3 normal=textureLod(normalSampler,vUV,0.0).rgb;float occlusion=0.0;float correctedRadius=min(radius,minZAspect*depth/near);
#ifdef ORTHOGRAPHIC_CAMERA
vec3 vViewRay=vec3(mix(viewport.x,viewport.y,vUV.x),mix(viewport.z,viewport.w,vUV.y),depthSign);
#else
vec3 vViewRay=vec3((vUV.x*2.0-1.0)*xViewport,(vUV.y*2.0-1.0)*yViewport,depthSign);
#endif
vec3 vDepthFactor=depthProjection*vec3(1.0,1.0,depth);vec3 origin=vViewRay*vDepthFactor;vec3 rvec=random*2.0-1.0;rvec.z=0.0;float dotProduct=dot(rvec,normal);rvec=1.0-abs(dotProduct)>1e-2 ? rvec : vec3(-rvec.y,0.0,rvec.x);vec3 tangent=normalize(rvec-normal*dot(rvec,normal));vec3 bitangent=cross(normal,tangent);mat3 tbn=mat3(tangent,bitangent,normal);float difference;for (int i=0; i<SAMPLES; ++i) {vec3 samplePosition=scales[(i+int(random.x*16.0)) % 16]*tbn*sampleSphere[(i+int(random.y*16.0)) % 16];samplePosition=samplePosition*correctedRadius+origin;vec4 offset=vec4(samplePosition,1.0);offset=projection*offset;offset.xyz/=offset.w;offset.xy=offset.xy*0.5+0.5;if (offset.x<0.0 || offset.y<0.0 || offset.x>1.0 || offset.y>1.0) {continue;}
float sampleDepth=abs(textureLod(depthSampler,offset.xy,0.0).r);difference=depthSign*samplePosition.z-sampleDepth;float rangeCheck=1.0-smoothstep(correctedRadius*0.5,correctedRadius,difference);occlusion+=step(EPSILON,difference)*rangeCheck;}
occlusion=occlusion*(1.0-smoothstep(maxZ*0.75,maxZ,depth));float ao=1.0-totalStrength*occlusion*samplesFactor;float result=clamp(ao+base,0.0,1.0);gl_FragColor=vec4(vec3(result),1.0);}
#endif
#ifdef BLUR
uniform float outSize;uniform float soften;uniform float tolerance;uniform int samples;
#ifndef BLUR_BYPASS
uniform sampler2D depthSampler;
#ifdef BLUR_LEGACY
#define inline
float blur13Bilateral(sampler2D image,vec2 uv,vec2 step) {float result=0.0;vec2 off1=vec2(1.411764705882353)*step;vec2 off2=vec2(3.2941176470588234)*step;vec2 off3=vec2(5.176470588235294)*step;float compareDepth=abs(textureLod(depthSampler,uv,0.0).r);float sampleDepth;float weight;float weightSum=30.0;result+=textureLod(image,uv,0.0).r*30.0;sampleDepth=abs(textureLod(depthSampler,uv+off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureLod(image,uv+off1,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureLod(image,uv-off1,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv+off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv+off2,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv-off2,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv+off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv+off3,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv-off3,0.0).r*weight;return result/weightSum;}
#endif
#endif
void main()
{float result=0.0;
#ifdef BLUR_BYPASS
result=textureLod(textureSampler,vUV,0.0).r;
#else
#ifdef BLUR_H
vec2 step=vec2(1.0/outSize,0.0);
#else
vec2 step=vec2(0.0,1.0/outSize);
#endif
#ifdef BLUR_LEGACY
result=blur13Bilateral(textureSampler,vUV,step);
#else
float compareDepth=abs(textureLod(depthSampler,vUV,0.0).r);float weightSum=0.0;for (int i=-samples; i<samples; i+=2)
{vec2 samplePos=vUV+step*(float(i)+0.5);float sampleDepth=abs(textureLod(depthSampler,samplePos,0.0).r);float falloff=smoothstep(0.0,
float(samples),
float(samples)-abs(float(i))*soften);float minDivider=tolerance*0.5+0.003;float weight=falloff/( minDivider+abs(compareDepth-sampleDepth));result+=textureLod(textureSampler,samplePos,0.0).r*weight;weightSum+=weight;}
result/=weightSum;
#endif
#endif
gl_FragColor.rgb=vec3(result);gl_FragColor.a=1.0;}
#endif
`;S.ShadersStore[Ff]||(S.ShadersStore[Ff]=cP);const T$={name:Ff,shader:cP},uP=Object.freeze(Object.defineProperty({__proto__:null,ssao2PixelShader:T$},Symbol.toStringTag,{value:"Module"})),Lf="ssao2PixelShader",hP=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;
#ifdef SSAO
const scales: array<f32,16>=array<f32,16>(
0.1,
0.11406250000000001,
0.131640625,
0.15625,
0.187890625,
0.2265625,
0.272265625,
0.325,
0.384765625,
0.4515625,
0.525390625,
0.60625,
0.694140625,
0.7890625,
0.891015625,
1.0
);uniform near: f32;uniform radius: f32;var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;var randomSamplerSampler: sampler;var randomSampler: texture_2d<f32>;var normalSamplerSampler: sampler;var normalSampler: texture_2d<f32>;uniform randTextureTiles: f32;uniform samplesFactor: f32;uniform sampleSphere: array<vec3f,SAMPLES>;uniform totalStrength: f32;uniform base: f32;
#ifdef ORTHOGRAPHIC_CAMERA
uniform viewport: vec4f;
#else
uniform xViewport: f32;uniform yViewport: f32;
#endif
uniform depthProjection: mat3x3f;uniform maxZ: f32;uniform minZAspect: f32;uniform texelSize: vec2f;uniform projection: mat4x4f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var random: vec3f=textureSampleLevel(randomSampler,randomSamplerSampler,input.vUV*uniforms.randTextureTiles,0.0).rgb;var depth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV,0.0).r;var depthSign: f32=sign(depth);depth=depth*depthSign;var normal: vec3f=textureSampleLevel(normalSampler,normalSamplerSampler,input.vUV,0.0).rgb;var occlusion: f32=0.0;var correctedRadius: f32=min(uniforms.radius,uniforms.minZAspect*depth/uniforms.near);
#ifdef ORTHOGRAPHIC_CAMERA
var vViewRay: vec3f= vec3f(mix(uniforms.viewport.x,uniforms.viewport.y,input.vUV.x),mix(uniforms.viewport.z,uniforms.viewport.w,input.vUV.y),depthSign);
#else
var vViewRay: vec3f= vec3f((input.vUV.x*2.0-1.0)*uniforms.xViewport,(input.vUV.y*2.0-1.0)*uniforms.yViewport,depthSign);
#endif
var vDepthFactor: vec3f=uniforms.depthProjection* vec3f(1.0,1.0,depth);var origin: vec3f=vViewRay*vDepthFactor;var rvec: vec3f=random*2.0-1.0;rvec.z=0.0;var dotProduct: f32=dot(rvec,normal);rvec=select( vec3f(-rvec.y,0.0,rvec.x),rvec,1.0-abs(dotProduct)>1e-2);var tangent: vec3f=normalize(rvec-normal*dot(rvec,normal));var bitangent: vec3f=cross(normal,tangent);var tbn: mat3x3f= mat3x3f(tangent,bitangent,normal);var difference: f32;for (var i: i32=0; i<SAMPLES; i++) {var samplePosition: vec3f=scales[(i+ i32(random.x*16.0)) % 16]*tbn*uniforms.sampleSphere[(i+ i32(random.y*16.0)) % 16];samplePosition=samplePosition*correctedRadius+origin;var offset: vec4f= vec4f(samplePosition,1.0);offset=uniforms.projection*offset;offset=vec4f(offset.xyz/offset.w,offset.w);offset=vec4f(offset.xy*0.5+0.5,offset.z,offset.w);if (offset.x<0.0 || offset.y<0.0 || offset.x>1.0 || offset.y>1.0) {continue;}
var sampleDepth: f32=abs(textureSampleLevel(depthSampler,depthSamplerSampler,offset.xy,0.0).r);difference=depthSign*samplePosition.z-sampleDepth;var rangeCheck: f32=1.0-smoothstep(correctedRadius*0.5,correctedRadius,difference);occlusion+=step(EPSILON,difference)*rangeCheck;}
occlusion=occlusion*(1.0-smoothstep(uniforms.maxZ*0.75,uniforms.maxZ,depth));var ao: f32=1.0-uniforms.totalStrength*occlusion*uniforms.samplesFactor;var result: f32=clamp(ao+uniforms.base,0.0,1.0);fragmentOutputs.color= vec4f( vec3f(result),1.0);}
#else
#ifdef BLUR
uniform outSize: f32;uniform soften: f32;uniform tolerance: f32;uniform samples: i32;
#ifndef BLUR_BYPASS
var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;
#ifdef BLUR_LEGACY
fn blur13Bilateral(image: texture_2d<f32>,imageSampler: sampler,uv: vec2f,step: vec2f)->f32 {var result: f32=0.0;var off1: vec2f= vec2f(1.411764705882353)*step;var off2: vec2f= vec2f(3.2941176470588234)*step;var off3: vec2f= vec2f(5.176470588235294)*step;var compareDepth: f32=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv,0.0).r);var sampleDepth: f32;var weight: f32;var weightSum: f32=30.0;result+=textureSampleLevel(image,imageSampler,uv,0.0).r*30.0;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv+off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureSampleLevel(image,imageSampler,uv+off1,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv-off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureSampleLevel(image,imageSampler,uv-off1,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv+off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureSampleLevel(image,imageSampler,uv+off2,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv-off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureSampleLevel(image,imageSampler,uv-off2,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv+off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureSampleLevel(image,imageSampler,uv+off3,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv-off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureSampleLevel(image,imageSampler,uv-off3,0.0).r*weight;return result/weightSum;}
#endif
#endif
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var result: f32=0.0;
#ifdef BLUR_BYPASS
result=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0).r;
#else
#ifdef BLUR_H
var step: vec2f= vec2f(1.0/uniforms.outSize,0.0);
#else
var step: vec2f= vec2f(0.0,1.0/uniforms.outSize);
#endif
#ifdef BLUR_LEGACY
result=blur13Bilateral(textureSampler,textureSamplerSampler,input.vUV,step);
#else
var compareDepth: f32=abs(textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV,0.0).r);var weightSum: f32=0.0;for (var i: i32=-uniforms.samples; i<uniforms.samples; i+=2)
{var samplePos: vec2f=input.vUV+step*( f32(i)+0.5);var sampleDepth: f32=abs(textureSampleLevel(depthSampler,depthSamplerSampler,samplePos,0.0).r);var falloff: f32=smoothstep(0.0,
f32(uniforms.samples),
f32(uniforms.samples)-abs( f32(i))*uniforms.soften);var minDivider: f32=uniforms.tolerance*0.5+0.003;var weight: f32=falloff/( minDivider+abs(compareDepth-sampleDepth));result+=textureSampleLevel(textureSampler,textureSamplerSampler,samplePos,0.0).r*weight;weightSum+=weight;}
result/=weightSum;
#endif
#endif
fragmentOutputs.color=vec4f(result,result,result,1.0);}
#endif
#endif
`;S.ShadersStoreWGSL[Lf]||(S.ShadersStoreWGSL[Lf]=hP);const b$={name:Lf,shader:hP},dP=Object.freeze(Object.defineProperty({__proto__:null,ssao2PixelShaderWGSL:b$},Symbol.toStringTag,{value:"Module"})),wf="ssaoCombinePixelShader",fP=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var originalColorSampler: sampler;var originalColor: texture_2d<f32>;uniform viewport: vec4f;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
var uv: vec2f=uniforms.viewport.xy+input.vUV*uniforms.viewport.zw;var ssaoColor: vec4f=textureSample(textureSampler,textureSamplerSampler,uv);var sceneColor: vec4f=textureSample(originalColor,originalColorSampler,uv);fragmentOutputs.color=sceneColor*ssaoColor;
#define CUSTOM_FRAGMENT_MAIN_END
}
`;S.ShadersStoreWGSL[wf]||(S.ShadersStoreWGSL[wf]=fP);const C$={name:wf,shader:fP},y$=Object.freeze(Object.defineProperty({__proto__:null,ssaoCombinePixelShaderWGSL:C$},Symbol.toStringTag,{value:"Module"})),tC="screenSpaceRayTrace",I$=`float distanceSquared(vec2 a,vec2 b) { a-=b; return dot(a,a); }
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
float linearizeDepth(float depth,float near,float far) {
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
return -(near*far)/(far-depth*(far-near));
#else
return (near*far)/(far-depth*(far-near));
#endif
}
#endif
/**
param csOrigin Camera-space ray origin,which must be 
within the view volume and must have z>0.01 and project within the valid screen rectangle
param csDirection Unit length camera-space ray direction
param projectToPixelMatrix A projection matrix that maps to **pixel** coordinates 
(**not** [-1,+1] normalized device coordinates).
param csZBuffer The camera-space Z buffer
param csZBufferSize Dimensions of csZBuffer
param csZThickness Camera space csZThickness to ascribe to each pixel in the depth buffer
param nearPlaneZ Positive number. Doesn't have to be THE actual near plane,just a reasonable value
for clipping rays headed towards the camera
param stride Step in horizontal or vertical pixels between samples. This is a float
because integer math is slow on GPUs,but should be set to an integer>=1
param jitterFraction Number between 0 and 1 for how far to bump the ray in stride units
to conceal banding artifacts,plus the stride ray offset.
param maxSteps Maximum number of iterations. Higher gives better images but may be slow
param maxRayTraceDistance Maximum camera-space distance to trace before returning a miss
param selfCollisionNumSkip Number of steps to skip at start when raytracing to avoid self collisions.
1 is a reasonable value,depending on the scene you may need to set this value to 2
param hitPixel Pixel coordinates of the first intersection with the scene
param numIterations number of iterations performed
param csHitPoint Camera space location of the ray hit
*/
#define inline
bool traceScreenSpaceRay1(
vec3 csOrigin,
vec3 csDirection,
mat4 projectToPixelMatrix,
sampler2D csZBuffer,
vec2 csZBufferSize,
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
sampler2D csZBackBuffer,
float csZBackSizeFactor,
#endif
float csZThickness,
float nearPlaneZ,
float farPlaneZ,
float stride,
float jitterFraction,
float maxSteps,
float maxRayTraceDistance,
float selfCollisionNumSkip,
out vec2 startPixel,
out vec2 hitPixel,
out vec3 csHitPoint,
out float numIterations
#ifdef SSRAYTRACE_DEBUG
,out vec3 debugColor
#endif
)
{
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
float rayLength=(csOrigin.z+csDirection.z*maxRayTraceDistance)>-nearPlaneZ ? (-nearPlaneZ-csOrigin.z)/csDirection.z : maxRayTraceDistance;
#else
float rayLength=(csOrigin.z+csDirection.z*maxRayTraceDistance)<nearPlaneZ ? (nearPlaneZ-csOrigin.z)/csDirection.z : maxRayTraceDistance;
#endif
vec3 csEndPoint=csOrigin+csDirection*rayLength;hitPixel=vec2(-1.0,-1.0);vec4 H0=projectToPixelMatrix*vec4(csOrigin,1.0);vec4 H1=projectToPixelMatrix*vec4(csEndPoint,1.0);float k0=1.0/H0.w;float k1=1.0/H1.w;vec3 Q0=csOrigin*k0;vec3 Q1=csEndPoint*k1;vec2 P0=H0.xy*k0;vec2 P1=H1.xy*k1;
#ifdef SSRAYTRACE_CLIP_TO_FRUSTUM
float xMax=csZBufferSize.x-0.5,xMin=0.5,yMax=csZBufferSize.y-0.5,yMin=0.5;float alpha=0.0;if ((P1.y>yMax) || (P1.y<yMin)) {alpha=(P1.y-((P1.y>yMax) ? yMax : yMin))/(P1.y-P0.y);}
if ((P1.x>xMax) || (P1.x<xMin)) {alpha=max(alpha,(P1.x-((P1.x>xMax) ? xMax : xMin))/(P1.x-P0.x));}
P1=mix(P1,P0,alpha); k1=mix(k1,k0,alpha); Q1=mix(Q1,Q0,alpha);
#endif
P1+=vec2((distanceSquared(P0,P1)<0.0001) ? 0.01 : 0.0);vec2 delta=P1-P0;bool permute=false;if (abs(delta.x)<abs(delta.y)) { 
permute=true;delta=delta.yx;P0=P0.yx;P1=P1.yx; }
float stepDirection=sign(delta.x);float invdx=stepDirection/delta.x;vec2 dP=vec2(stepDirection,delta.y*invdx);vec3 dQ=(Q1-Q0)*invdx;float dk=(k1-k0)*invdx;float zMin=min(csEndPoint.z,csOrigin.z);float zMax=max(csEndPoint.z,csOrigin.z);dP*=stride; dQ*=stride; dk*=stride;P0+=dP*jitterFraction; Q0+=dQ*jitterFraction; k0+=dk*jitterFraction;vec4 pqk=vec4(P0,Q0.z,k0);vec4 dPQK=vec4(dP,dQ.z,dk);startPixel=permute ? P0.yx : P0.xy;float prevZMaxEstimate=csOrigin.z;float rayZMin=prevZMaxEstimate,rayZMax=prevZMaxEstimate;float sceneZMax=rayZMax+1e4;float end=P1.x*stepDirection;bool hit=false;float stepCount;for (stepCount=0.0;stepCount<=selfCollisionNumSkip ||
(pqk.x*stepDirection)<=end &&
stepCount<maxSteps &&
!hit &&
sceneZMax != 0.0; 
pqk+=dPQK,++stepCount)
{hitPixel=permute ? pqk.yx : pqk.xy;rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;if (rayZMin>rayZMax) { 
float t=rayZMin; rayZMin=rayZMax; rayZMax=t;}
sceneZMax=texelFetch(csZBuffer,ivec2(hitPixel),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
sceneZMax=linearizeDepth(sceneZMax,nearPlaneZ,farPlaneZ);
#endif
if (sceneZMax==0.0) sceneZMax=1e8;
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
float sceneBackZ=texelFetch(csZBackBuffer,ivec2(hitPixel/csZBackSizeFactor),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
sceneBackZ=linearizeDepth(sceneBackZ,nearPlaneZ,farPlaneZ);
#endif
if (sceneBackZ==0.0) sceneBackZ=-1e8;hit=(rayZMax>=sceneBackZ-csZThickness) && (rayZMin<=sceneZMax);
#else
hit=(rayZMax>=sceneZMax-csZThickness) && (rayZMin<=sceneZMax);
#endif
#else
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
float sceneBackZ=texelFetch(csZBackBuffer,ivec2(hitPixel/csZBackSizeFactor),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
sceneBackZ=linearizeDepth(sceneBackZ,nearPlaneZ,farPlaneZ);
#endif
if (sceneBackZ==0.0) sceneBackZ=1e8;hit=(rayZMin<=sceneBackZ+csZThickness) && (rayZMax>=sceneZMax) && (sceneZMax != 0.0);
#else
hit=(rayZMin<=sceneZMax+csZThickness) && (rayZMax>=sceneZMax);
#endif
#endif
}
pqk-=dPQK;stepCount-=1.0;if (((pqk.x+dPQK.x)*stepDirection)>end || (stepCount+1.0)>=maxSteps || sceneZMax==0.0) {hit=false;}
#ifdef SSRAYTRACE_ENABLE_REFINEMENT
if (stride>1.0 && hit) {pqk-=dPQK;stepCount-=1.0;float invStride=1.0/stride;dPQK*=invStride;float refinementStepCount=0.0;prevZMaxEstimate=pqk.z/pqk.w;rayZMax=prevZMaxEstimate;sceneZMax=rayZMax+1e7;for (;refinementStepCount<=1.0 ||
(refinementStepCount<=stride*1.4) &&
(rayZMax<sceneZMax) && (sceneZMax != 0.0);pqk+=dPQK,refinementStepCount+=1.0)
{rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;rayZMax=max(rayZMax,rayZMin);hitPixel=permute ? pqk.yx : pqk.xy;sceneZMax=texelFetch(csZBuffer,ivec2(hitPixel),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
sceneZMax=linearizeDepth(sceneZMax,nearPlaneZ,farPlaneZ);
#endif
}
pqk-=dPQK;refinementStepCount-=1.0;stepCount+=refinementStepCount/stride;}
#endif
Q0.xy+=dQ.xy*stepCount;Q0.z=pqk.z;csHitPoint=Q0/pqk.w;numIterations=stepCount+1.0;
#ifdef SSRAYTRACE_DEBUG
if (((pqk.x+dPQK.x)*stepDirection)>end) {debugColor=vec3(0,0,1);} else if ((stepCount+1.0)>=maxSteps) {debugColor=vec3(1,0,0);} else if (sceneZMax==0.0) {debugColor=vec3(1,1,0);} else {debugColor=vec3(0,stepCount/maxSteps,0);}
#endif
return hit;}
/**
texCoord: in the [0,1] range
depth: depth in view space (range [znear,zfar]])
*/
vec3 computeViewPosFromUVDepth(vec2 texCoord,float depth,mat4 projection,mat4 invProjectionMatrix) {vec4 ndc;ndc.xy=texCoord*2.0-1.0;
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
#ifdef ORTHOGRAPHIC_CAMERA
ndc.z=-projection[2].z*depth+projection[3].z;
#else
ndc.z=-projection[2].z-projection[3].z/depth;
#endif
#else
#ifdef ORTHOGRAPHIC_CAMERA
ndc.z=projection[2].z*depth+projection[3].z;
#else
ndc.z=projection[2].z+projection[3].z/depth;
#endif
#endif
ndc.w=1.0;vec4 eyePos=invProjectionMatrix*ndc;eyePos.xyz/=eyePos.w;return eyePos.xyz;}
`;S.IncludesShadersStore[tC]||(S.IncludesShadersStore[tC]=I$);const Bf="screenSpaceReflection2PixelShader",pP=`#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,lod) texture2DLodEXT(s,c,lod)
#define TEXTURECUBEFUNC(s,c,lod) textureLod(s,c,lod)
#else
#define TEXTUREFUNC(s,c,bias) texture2D(s,c,bias)
#define TEXTURECUBEFUNC(s,c,bias) textureCube(s,c,bias)
#endif
uniform sampler2D textureSampler;varying vec2 vUV;
#ifdef SSR_SUPPORTED
uniform sampler2D reflectivitySampler;uniform sampler2D normalSampler;uniform sampler2D depthSampler;
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
uniform sampler2D backDepthSampler;uniform float backSizeFactor;
#endif
#ifdef SSR_USE_ENVIRONMENT_CUBE
uniform samplerCube envCubeSampler;
#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC
uniform vec3 vReflectionPosition;uniform vec3 vReflectionSize;
#endif
#endif
uniform mat4 view;uniform mat4 invView;uniform mat4 projection;uniform mat4 invProjectionMatrix;uniform mat4 projectionPixel;uniform float nearPlaneZ;uniform float farPlaneZ;uniform float stepSize;uniform float maxSteps;uniform float strength;uniform float thickness;uniform float roughnessFactor;uniform float reflectionSpecularFalloffExponent;uniform float maxDistance;uniform float selfCollisionNumSkip;uniform float reflectivityThreshold;
#include<helperFunctions>
#include<pbrBRDFFunctions>
#include<screenSpaceRayTrace>
vec3 hash(vec3 a)
{a=fract(a*0.8);a+=dot(a,a.yxz+19.19);return fract((a.xxy+a.yxx)*a.zyx);}
float computeAttenuationForIntersection(ivec2 hitPixel,vec2 hitUV,vec3 vsRayOrigin,vec3 vsHitPoint,vec3 reflectionVector,float maxRayDistance,float numIterations) {float attenuation=1.0;
#ifdef SSR_ATTENUATE_SCREEN_BORDERS
vec2 dCoords=smoothstep(0.2,0.6,abs(vec2(0.5,0.5)-hitUV.xy));attenuation*=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);
#endif
#ifdef SSR_ATTENUATE_INTERSECTION_DISTANCE
attenuation*=1.0-clamp(distance(vsRayOrigin,vsHitPoint)/maxRayDistance,0.0,1.0);
#endif
#ifdef SSR_ATTENUATE_INTERSECTION_NUMITERATIONS
attenuation*=1.0-(numIterations/maxSteps);
#endif
#ifdef SSR_ATTENUATE_BACKFACE_REFLECTION
vec3 reflectionNormal=texelFetch(normalSampler,hitPixel,0).xyz;float directionBasedAttenuation=smoothstep(-0.17,0.0,dot(reflectionNormal,-reflectionVector));attenuation*=directionBasedAttenuation;
#endif
return attenuation;}
#endif
void main()
{
#ifdef SSR_SUPPORTED
vec4 colorFull=TEXTUREFUNC(textureSampler,vUV,0.0);vec3 color=colorFull.rgb;vec4 reflectivity=max(TEXTUREFUNC(reflectivitySampler,vUV,0.0),vec4(0.));
#ifndef SSR_DISABLE_REFLECTIVITY_TEST
if (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=reflectivityThreshold) {
#ifdef SSR_USE_BLUR
gl_FragColor=vec4(0.);
#else
gl_FragColor=colorFull;
#endif
return;}
#endif
#ifdef SSR_INPUT_IS_GAMMA_SPACE
color=toLinearSpace(color);
#endif
vec2 texSize=vec2(textureSize(depthSampler,0));vec3 csNormal=texelFetch(normalSampler,ivec2(vUV*texSize),0).xyz; 
#ifdef SSR_DECODE_NORMAL
csNormal=csNormal*2.0-1.0;
#endif
#ifdef SSR_NORMAL_IS_IN_WORLDSPACE
csNormal=(view*vec4(csNormal,0.0)).xyz;
#endif
float depth=texelFetch(depthSampler,ivec2(vUV*texSize),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
depth=linearizeDepth(depth,nearPlaneZ,farPlaneZ);
#endif
vec3 csPosition=computeViewPosFromUVDepth(vUV,depth,projection,invProjectionMatrix);
#ifdef ORTHOGRAPHIC_CAMERA
vec3 csViewDirection=vec3(0.,0.,1.);
#else
vec3 csViewDirection=normalize(csPosition);
#endif
vec3 csReflectedVector=reflect(csViewDirection,csNormal);
#ifdef SSR_USE_ENVIRONMENT_CUBE
vec3 wReflectedVector=vec3(invView*vec4(csReflectedVector,0.0));
#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC
vec4 worldPos=invView*vec4(csPosition,1.0);wReflectedVector=parallaxCorrectNormal(worldPos.xyz,normalize(wReflectedVector),vReflectionSize,vReflectionPosition);
#endif
#ifdef SSR_INVERTCUBICMAP
wReflectedVector.y*=-1.0;
#endif
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
wReflectedVector.z*=-1.0;
#endif
vec3 envColor=TEXTURECUBEFUNC(envCubeSampler,wReflectedVector,0.0).xyz;
#ifdef SSR_ENVIRONMENT_CUBE_IS_GAMMASPACE
envColor=toLinearSpace(envColor);
#endif
#else
vec3 envColor=color;
#endif
float reflectionAttenuation=1.0;bool rayHasHit=false;vec2 startPixel;vec2 hitPixel;vec3 hitPoint;float numIterations;
#ifdef SSRAYTRACE_DEBUG
vec3 debugColor;
#endif
#ifdef SSR_ATTENUATE_FACING_CAMERA
reflectionAttenuation*=1.0-smoothstep(0.25,0.5,dot(-csViewDirection,csReflectedVector));
#endif
if (reflectionAttenuation>0.0) {
#ifdef SSR_USE_BLUR
vec3 jitt=vec3(0.);
#else
float roughness=1.0-reflectivity.a;vec3 jitt=mix(vec3(0.0),hash(csPosition)-vec3(0.5),roughness)*roughnessFactor; 
#endif
vec2 uv2=vUV*texSize;float c=(uv2.x+uv2.y)*0.25;float jitter=mod(c,1.0); 
rayHasHit=traceScreenSpaceRay1(
csPosition,
normalize(csReflectedVector+jitt),
projectionPixel,
depthSampler,
texSize,
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
backDepthSampler,
backSizeFactor,
#endif
thickness,
nearPlaneZ,
farPlaneZ,
stepSize,
jitter,
maxSteps,
maxDistance,
selfCollisionNumSkip,
startPixel,
hitPixel,
hitPoint,
numIterations
#ifdef SSRAYTRACE_DEBUG
,debugColor
#endif
);}
#ifdef SSRAYTRACE_DEBUG
gl_FragColor=vec4(debugColor,1.);return;
#endif
vec3 F0=reflectivity.rgb;vec3 fresnel=fresnelSchlickGGX(max(dot(csNormal,-csViewDirection),0.0),F0,vec3(1.));vec3 SSR=envColor;if (rayHasHit) {vec3 reflectedColor=texelFetch(textureSampler,ivec2(hitPixel),0).rgb;
#ifdef SSR_INPUT_IS_GAMMA_SPACE
reflectedColor=toLinearSpace(reflectedColor);
#endif
reflectionAttenuation*=computeAttenuationForIntersection(ivec2(hitPixel),hitPixel/texSize,csPosition,hitPoint,csReflectedVector,maxDistance,numIterations);SSR=reflectedColor*reflectionAttenuation+(1.0-reflectionAttenuation)*envColor;}
#ifndef SSR_BLEND_WITH_FRESNEL
SSR*=fresnel;
#endif
#ifdef SSR_USE_BLUR
float blur_radius=0.0;float roughness=1.0-reflectivity.a*(1.0-roughnessFactor);if (roughness>0.001) {float cone_angle=min(roughness,0.999)*3.14159265*0.5;float cone_len=distance(startPixel,hitPixel);float op_len=2.0*tan(cone_angle)*cone_len; 
float a=op_len;float h=cone_len;float a2=a*a;float fh2=4.0f*h*h;blur_radius=(a*(sqrt(a2+fh2)-a))/(4.0f*h);}
gl_FragColor=vec4(SSR,blur_radius/255.0); 
#else
#ifdef SSR_BLEND_WITH_FRESNEL
vec3 reflectionMultiplier=clamp(pow(fresnel*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);
#else
vec3 reflectionMultiplier=clamp(pow(reflectivity.rgb*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);
#endif
vec3 colorMultiplier=1.0-reflectionMultiplier;vec3 finalColor=(color*colorMultiplier)+(SSR*reflectionMultiplier);
#ifdef SSR_OUTPUT_IS_GAMMA_SPACE
finalColor=toGammaSpace(finalColor);
#endif
gl_FragColor=vec4(finalColor,colorFull.a);
#endif
#else
gl_FragColor=TEXTUREFUNC(textureSampler,vUV,0.0);
#endif
}
`;S.ShadersStore[Bf]||(S.ShadersStore[Bf]=pP);const R$={name:Bf,shader:pP},A$=Object.freeze(Object.defineProperty({__proto__:null,screenSpaceReflection2PixelShader:R$},Symbol.toStringTag,{value:"Module"})),Vf="screenSpaceReflection2BlurPixelShader",mP=`#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,lod) texture2DLodEXT(s,c,lod)
#else
#define TEXTUREFUNC(s,c,bias) texture2D(s,c,bias)
#endif
uniform sampler2D textureSampler;varying vec2 vUV;uniform vec2 texelOffsetScale;const float weights[8]=float[8] (0.071303,0.131514,0.189879,0.321392,0.452906, 0.584419,0.715932,0.847445);void processSample(vec2 uv,float i,vec2 stepSize,inout vec4 accumulator,inout float denominator)
{vec2 offsetUV=stepSize*i+uv;float coefficient=weights[int(2.0-abs(i))];accumulator+=TEXTUREFUNC(textureSampler,offsetUV,0.0)*coefficient;denominator+=coefficient;}
void main()
{vec4 colorFull=TEXTUREFUNC(textureSampler,vUV,0.0);if (dot(colorFull,vec4(1.0))==0.0) {gl_FragColor=colorFull;return;}
float blurRadius=colorFull.a*255.0; 
vec2 stepSize=texelOffsetScale.xy*blurRadius;vec4 accumulator=TEXTUREFUNC(textureSampler,vUV,0.0)*0.214607;float denominator=0.214607;processSample(vUV,1.0,stepSize,accumulator,denominator);processSample(vUV,1.0*0.2,stepSize,accumulator,denominator);processSample(vUV,1.0*0.4,stepSize,accumulator,denominator);processSample(vUV,1.0*0.6,stepSize,accumulator,denominator);processSample(vUV,1.0*0.8,stepSize,accumulator,denominator);processSample(vUV,1.0*1.2,stepSize,accumulator,denominator);processSample(vUV,1.0*1.4,stepSize,accumulator,denominator);processSample(vUV,1.0*1.6,stepSize,accumulator,denominator);processSample(vUV,1.0*1.8,stepSize,accumulator,denominator);processSample(vUV,1.0*2.0,stepSize,accumulator,denominator);processSample(vUV,-1.0,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.2,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.4,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.6,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.8,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.2,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.4,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.6,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.8,stepSize,accumulator,denominator);processSample(vUV,-1.0*2.0,stepSize,accumulator,denominator);gl_FragColor=vec4(accumulator.rgb/denominator,colorFull.a);}
`;S.ShadersStore[Vf]||(S.ShadersStore[Vf]=mP);const P$={name:Vf,shader:mP},O$=Object.freeze(Object.defineProperty({__proto__:null,screenSpaceReflection2BlurPixelShader:P$},Symbol.toStringTag,{value:"Module"})),Uf="screenSpaceReflection2BlurCombinerPixelShader",_P=`uniform sampler2D textureSampler; 
uniform sampler2D mainSampler;uniform sampler2D reflectivitySampler;uniform float strength;uniform float reflectionSpecularFalloffExponent;uniform float reflectivityThreshold;varying vec2 vUV;
#include<helperFunctions>
#ifdef SSR_BLEND_WITH_FRESNEL
#include<pbrBRDFFunctions>
#include<screenSpaceRayTrace>
uniform mat4 projection;uniform mat4 invProjectionMatrix;
#ifdef SSR_NORMAL_IS_IN_WORLDSPACE
uniform mat4 view;
#endif
uniform sampler2D normalSampler;uniform sampler2D depthSampler;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
uniform float nearPlaneZ;uniform float farPlaneZ;
#endif
#endif
void main()
{
#ifdef SSRAYTRACE_DEBUG
gl_FragColor=texture2D(textureSampler,vUV);
#else
vec3 SSR=texture2D(textureSampler,vUV).rgb;vec4 color=texture2D(mainSampler,vUV);vec4 reflectivity=texture2D(reflectivitySampler,vUV);
#ifndef SSR_DISABLE_REFLECTIVITY_TEST
if (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=reflectivityThreshold) {gl_FragColor=color;return;}
#endif
#ifdef SSR_INPUT_IS_GAMMA_SPACE
color=toLinearSpace(color);
#endif
#ifdef SSR_BLEND_WITH_FRESNEL
vec2 texSize=vec2(textureSize(depthSampler,0));vec3 csNormal=texelFetch(normalSampler,ivec2(vUV*texSize),0).xyz;
#ifdef SSR_DECODE_NORMAL
csNormal=csNormal*2.0-1.0;
#endif
#ifdef SSR_NORMAL_IS_IN_WORLDSPACE
csNormal=(view*vec4(csNormal,0.0)).xyz;
#endif
float depth=texelFetch(depthSampler,ivec2(vUV*texSize),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
depth=linearizeDepth(depth,nearPlaneZ,farPlaneZ);
#endif
vec3 csPosition=computeViewPosFromUVDepth(vUV,depth,projection,invProjectionMatrix);vec3 csViewDirection=normalize(csPosition);vec3 F0=reflectivity.rgb;vec3 fresnel=fresnelSchlickGGX(max(dot(csNormal,-csViewDirection),0.0),F0,vec3(1.));vec3 reflectionMultiplier=clamp(pow(fresnel*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);
#else
vec3 reflectionMultiplier=clamp(pow(reflectivity.rgb*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);
#endif
vec3 colorMultiplier=1.0-reflectionMultiplier;vec3 finalColor=(color.rgb*colorMultiplier)+(SSR*reflectionMultiplier);
#ifdef SSR_OUTPUT_IS_GAMMA_SPACE
finalColor=toGammaSpace(finalColor);
#endif
gl_FragColor=vec4(finalColor,color.a);
#endif
}
`;S.ShadersStore[Uf]||(S.ShadersStore[Uf]=_P);const N$={name:Uf,shader:_P},D$=Object.freeze(Object.defineProperty({__proto__:null,screenSpaceReflection2BlurCombinerPixelShader:N$},Symbol.toStringTag,{value:"Module"})),iC="screenSpaceRayTrace",M$=`fn distanceSquared(a: vec2f,b: vec2f)->f32 { 
var temp=a-b; 
return dot(temp,temp); }
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
fn linearizeDepth(depth: f32,near: f32,far: f32)->f32 {
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
return -(near*far)/(far-depth*(far-near));
#else
return (near*far)/(far-depth*(far-near));
#endif
}
#endif
/**
param csOrigin Camera-space ray origin,which must be 
within the view volume and must have z>0.01 and project within the valid screen rectangle
param csDirection Unit length camera-space ray direction
param projectToPixelMatrix A projection matrix that maps to **pixel** coordinates 
(**not** [-1,+1] normalized device coordinates).
param csZBuffer The camera-space Z buffer
param csZBufferSize Dimensions of csZBuffer
param csZThickness Camera space csZThickness to ascribe to each pixel in the depth buffer
param nearPlaneZ Positive number. Doesn't have to be THE actual near plane,just a reasonable value
for clipping rays headed towards the camera. Should be the actual near plane if screen-space depth is enabled.
param farPlaneZ The far plane for the camera. Used when screen-space depth is enabled.
param stride Step in horizontal or vertical pixels between samples. This is a var because: f32 integer math is slow on GPUs,but should be set to an integer>=1
param jitterFraction Number between 0 and 1 for how far to bump the ray in stride units
to conceal banding artifacts,plus the stride ray offset.
param maxSteps Maximum number of iterations. Higher gives better images but may be slow
param maxRayTraceDistance Maximum camera-space distance to trace before returning a miss
param selfCollisionNumSkip Number of steps to skip at start when raytracing to avar self: voidnull collisions.
1 is a reasonable value,depending on the scene you may need to set this value to 2
param hitPixel Pixel coordinates of the first intersection with the scene
param numIterations number of iterations performed
param csHitPovar Camera: i32 space location of the ray hit
*/
fn traceScreenSpaceRay1(
csOrigin: vec3f,
csDirection: vec3f,
projectToPixelMatrix: mat4x4f,
csZBuffer: texture_2d<f32>,
csZBufferSize: vec2f,
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
csZBackBuffer: texture_2d<f32>,
csZBackSizeFactor: f32,
#endif
csZThickness: f32,
nearPlaneZ: f32,
farPlaneZ: f32,
stride: f32,
jitterFraction: f32,
maxSteps: f32,
maxRayTraceDistance: f32,
selfCollisionNumSkip: f32,
startPixel: ptr<function,vec2f>,
hitPixel: ptr<function,vec2f>,
csHitPoint: ptr<function,vec3f>,
numIterations: ptr<function,f32>
#ifdef SSRAYTRACE_DEBUG
,debugColor: ptr<function,vec3f>
#endif
)->bool
{
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
var rayLength: f32=select(maxRayTraceDistance,(-nearPlaneZ-csOrigin.z)/csDirection.z,(csOrigin.z+csDirection.z*maxRayTraceDistance)>-nearPlaneZ);
#else
var rayLength: f32=select(maxRayTraceDistance,(nearPlaneZ-csOrigin.z)/csDirection.z,(csOrigin.z+csDirection.z*maxRayTraceDistance)<nearPlaneZ);
#endif
var csEndPoint: vec3f=csOrigin+csDirection*rayLength;*hitPixel= vec2f(-1.0,-1.0);var H0: vec4f=projectToPixelMatrix* vec4f(csOrigin,1.0);var H1: vec4f=projectToPixelMatrix* vec4f(csEndPoint,1.0);var k0: f32=1.0/H0.w;var k1: f32=1.0/H1.w;var Q0: vec3f=csOrigin*k0;var Q1: vec3f=csEndPoint*k1;var P0: vec2f=H0.xy*k0;var P1: vec2f=H1.xy*k1;
#ifdef SSRAYTRACE_CLIP_TO_FRUSTUM
var xMax: f32=csZBufferSize.x-0.5;var xMin=0.5;var yMax=csZBufferSize.y-0.5;var yMin=0.5;var alpha: f32=0.0;if ((P1.y>yMax) || (P1.y<yMin)) {alpha=(P1.y-select(yMin,yMax,(P1.y>yMax)))/(P1.y-P0.y);}
if ((P1.x>xMax) || (P1.x<xMin)) {alpha=max(alpha,(P1.x-select(xMin,xMax,(P1.x>xMax)))/(P1.x-P0.x));}
P1=mix(P1,P0,alpha); k1=mix(k1,k0,alpha); Q1=mix(Q1,Q0,alpha);
#endif
P1+= vec2f(select(0.0,0.01,distanceSquared(P0,P1)<0.0001));var delta: vec2f=P1-P0;var permute: bool=false;if (abs(delta.x)<abs(delta.y)) { 
permute=true;delta=delta.yx;P0=P0.yx;P1=P1.yx; }
var stepDirection: f32=sign(delta.x);var invdx: f32=stepDirection/delta.x;var dP: vec2f= vec2f(stepDirection,delta.y*invdx);var dQ: vec3f=(Q1-Q0)*invdx;var dk: f32=(k1-k0)*invdx;var zMin: f32=min(csEndPoint.z,csOrigin.z);var zMax: f32=max(csEndPoint.z,csOrigin.z);dP*=stride; dQ*=stride; dk*=stride;P0+=dP*jitterFraction; Q0+=dQ*jitterFraction; k0+=dk*jitterFraction;var pqk: vec4f= vec4f(P0,Q0.z,k0);var dPQK: vec4f= vec4f(dP,dQ.z,dk);*startPixel=select(P0.xy,P0.yx,permute);var prevZMaxEstimate: f32=csOrigin.z;var rayZMin: f32=prevZMaxEstimate;var rayZMax=prevZMaxEstimate;var sceneZMax: f32=rayZMax+1e4;var end: f32=P1.x*stepDirection;var hit: bool=false;var stepCount: f32;for (stepCount=0.0;(stepCount<=selfCollisionNumSkip) ||
((pqk.x*stepDirection)<=end &&
stepCount<maxSteps &&
!hit &&
sceneZMax != 0.0);pqk+=dPQK 
)
{*hitPixel=select(pqk.xy,pqk.yx,permute);rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;if (rayZMin>rayZMax) { 
var t: f32=rayZMin; rayZMin=rayZMax; rayZMax=t;}
sceneZMax=textureLoad(csZBuffer,vec2<i32>(*hitPixel),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
sceneZMax=linearizeDepth(sceneZMax,nearPlaneZ,farPlaneZ);
#endif
if (sceneZMax==0.0) { sceneZMax=1e8; }
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
var sceneBackZ: f32=textureLoad(csZBackBuffer,vec2<i32>(*hitPixel/csZBackSizeFactor),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
sceneBackZ=linearizeDepth(sceneBackZ,nearPlaneZ,farPlaneZ);
#endif
if (sceneBackZ==0.0) { sceneBackZ=-1e8; }
hit=(rayZMax>=sceneBackZ-csZThickness) && (rayZMin<=sceneZMax);
#else
hit=(rayZMax>=sceneZMax-csZThickness) && (rayZMin<=sceneZMax);
#endif
#else
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
var sceneBackZ: f32=textureLoad(csZBackBuffer,vec2<i32>(*hitPixel/csZBackSizeFactor),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
sceneBackZ=linearizeDepth(sceneBackZ,nearPlaneZ,farPlaneZ);
#endif
if (sceneBackZ==0.0) { sceneBackZ=1e8; }
hit=(rayZMin<=sceneBackZ+csZThickness) && (rayZMax>=sceneZMax) && (sceneZMax != 0.0);
#else
hit=(rayZMin<=sceneZMax+csZThickness) && (rayZMax>=sceneZMax);
#endif
#endif
stepCount+=1.0;}
pqk-=dPQK;stepCount-=1.0;if (((pqk.x+dPQK.x)*stepDirection)>end || (stepCount+1.0)>=maxSteps || sceneZMax==0.0) {hit=false;}
#ifdef SSRAYTRACE_ENABLE_REFINEMENT
if (stride>1.0 && hit) {pqk-=dPQK;stepCount-=1.0;var invStride: f32=1.0/stride;dPQK*=invStride;var refinementStepCount: f32=0.0;prevZMaxEstimate=pqk.z/pqk.w;rayZMax=prevZMaxEstimate;sceneZMax=rayZMax+1e7;for (;refinementStepCount<=1.0 ||
((refinementStepCount<=stride*1.4) &&
(rayZMax<sceneZMax) && (sceneZMax != 0.0));pqk+=dPQK)
{rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;rayZMax=max(rayZMax,rayZMin);*hitPixel=select(pqk.xy,pqk.yx,permute);sceneZMax=textureLoad(csZBuffer,vec2<i32>(*hitPixel),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
sceneZMax=linearizeDepth(sceneZMax,nearPlaneZ,farPlaneZ);
#endif
refinementStepCount+=1.0;}
pqk-=dPQK;refinementStepCount-=1.0;stepCount+=refinementStepCount/stride;}
#endif
Q0=vec3f(Q0.xy+dQ.xy*stepCount,pqk.z);*csHitPoint=Q0/pqk.w;*numIterations=stepCount+1.0;
#ifdef SSRAYTRACE_DEBUG
if (((pqk.x+dPQK.x)*stepDirection)>end) {*debugColor= vec3f(0,0,1);} else if ((stepCount+1.0)>=maxSteps) {*debugColor= vec3f(1,0,0);} else if (sceneZMax==0.0) {*debugColor= vec3f(1,1,0);} else {*debugColor= vec3f(0,stepCount/maxSteps,0);}
#endif
return hit;}
/**
texCoord: in the [0,1] range
depth: depth in view space (range [znear,zfar]])
*/
fn computeViewPosFromUVDepth(texCoord: vec2f,depth: f32,projection: mat4x4f,invProjectionMatrix: mat4x4f)->vec3f {var xy=texCoord*2.0-1.0;var z: f32;
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
#ifdef ORTHOGRAPHIC_CAMERA
z=-projection[2].z*depth+projection[3].z;
#else
z=-projection[2].z-projection[3].z/depth;
#endif
#else
#ifdef ORTHOGRAPHIC_CAMERA
z=projection[2].z*depth+projection[3].z;
#else
z=projection[2].z+projection[3].z/depth;
#endif
#endif
var w=1.0;var ndc=vec4f(xy,z,w);var eyePos: vec4f=invProjectionMatrix*ndc;var result=eyePos.xyz/eyePos.w;return result;}
`;S.IncludesShadersStoreWGSL[iC]||(S.IncludesShadersStoreWGSL[iC]=M$);const kf="screenSpaceReflection2PixelShader",gP=`var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;varying vUV: vec2f;
#ifdef SSR_SUPPORTED
var reflectivitySamplerSampler: sampler;var reflectivitySampler: texture_2d<f32>;var normalSampler: texture_2d<f32>;var depthSampler: texture_2d<f32>;
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
var backDepthSampler: texture_2d<f32>;uniform backSizeFactor: f32;
#endif
#ifdef SSR_USE_ENVIRONMENT_CUBE
var envCubeSamplerSampler: sampler;var envCubeSampler: texture_cube<f32>;
#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC
uniform vReflectionPosition: vec3f;uniform vReflectionSize: vec3f;
#endif
#endif
uniform view: mat4x4f;uniform invView: mat4x4f;uniform projection: mat4x4f;uniform invProjectionMatrix: mat4x4f;uniform projectionPixel: mat4x4f;uniform nearPlaneZ: f32;uniform farPlaneZ: f32;uniform stepSize: f32;uniform maxSteps: f32;uniform strength: f32;uniform thickness: f32;uniform roughnessFactor: f32;uniform reflectionSpecularFalloffExponent: f32;uniform maxDistance: f32;uniform selfCollisionNumSkip: f32;uniform reflectivityThreshold: f32;
#include<helperFunctions>
#include<pbrBRDFFunctions>
#include<screenSpaceRayTrace>
fn hash(a: vec3f)->vec3f
{var result=fract(a*0.8);result+=dot(result,result.yxz+19.19);return fract((result.xxy+result.yxx)*result.zyx);}
fn computeAttenuationForIntersection(ihitPixel: vec2f,hitUV: vec2f,vsRayOrigin: vec3f,vsHitPoint: vec3f,reflectionVector: vec3f,maxRayDistance: f32,numIterations: f32)->f32 {var attenuation: f32=1.0;
#ifdef SSR_ATTENUATE_SCREEN_BORDERS
var dCoords: vec2f=smoothstep(vec2f(0.2),vec2f(0.6),abs( vec2f(0.5,0.5)-hitUV.xy));attenuation*=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);
#endif
#ifdef SSR_ATTENUATE_INTERSECTION_DISTANCE
attenuation*=1.0-clamp(distance(vsRayOrigin,vsHitPoint)/maxRayDistance,0.0,1.0);
#endif
#ifdef SSR_ATTENUATE_INTERSECTION_NUMITERATIONS
attenuation*=1.0-(numIterations/uniforms.maxSteps);
#endif
#ifdef SSR_ATTENUATE_BACKFACE_REFLECTION
var reflectionNormal: vec3f=texelFetch(normalSampler,hitPixel,0).xyz;var directionBasedAttenuation: f32=smoothstep(-0.17,0.0,dot(reflectionNormal,-reflectionVector));attenuation*=directionBasedAttenuation;
#endif
return attenuation;}
#endif
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#ifdef SSR_SUPPORTED
var colorFull: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);var color: vec3f=colorFull.rgb;var reflectivity: vec4f=max(textureSampleLevel(reflectivitySampler,reflectivitySamplerSampler,input.vUV,0.0),vec4f(0.0));
#ifndef SSR_DISABLE_REFLECTIVITY_TEST
if (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=uniforms.reflectivityThreshold) {
#ifdef SSR_USE_BLUR
fragmentOutputs.color= vec4f(0.);
#else
fragmentOutputs.color=colorFull;
#endif
return fragmentOutputs;}
#endif
#ifdef SSR_INPUT_IS_GAMMA_SPACE
color=toLinearSpaceVec3(color);
#endif
var texSize: vec2f= vec2f(textureDimensions(depthSampler,0));var csNormal: vec3f=textureLoad(normalSampler,vec2<i32>(input.vUV*texSize),0).xyz; 
#ifdef SSR_DECODE_NORMAL
csNormal=csNormal*2.0-1.0;
#endif
#ifdef SSR_NORMAL_IS_IN_WORLDSPACE
csNormal=(uniforms.view* vec4f(csNormal,0.0)).xyz;
#endif
var depth: f32=textureLoad(depthSampler,vec2<i32>(input.vUV*texSize),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
depth=linearizeDepth(depth,uniforms.nearPlaneZ,uniforms.farPlaneZ);
#endif
var csPosition: vec3f=computeViewPosFromUVDepth(input.vUV,depth,uniforms.projection,uniforms.invProjectionMatrix);
#ifdef ORTHOGRAPHIC_CAMERA
var csViewDirection: vec3f= vec3f(0.,0.,1.);
#else
var csViewDirection: vec3f=normalize(csPosition);
#endif
var csReflectedVector: vec3f=reflect(csViewDirection,csNormal);
#ifdef SSR_USE_ENVIRONMENT_CUBE
var wReflectedVector: vec3f=(uniforms.invView* vec4f(csReflectedVector,0.0)).xyz;
#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC
var worldPos: vec4f=uniforms.invView* vec4f(csPosition,1.0);wReflectedVector=parallaxCorrectNormal(worldPos.xyz,normalize(wReflectedVector),uniforms.vReflectionSize,uniforms.vReflectionPosition);
#endif
#ifdef SSR_INVERTCUBICMAP
wReflectedVector.y*=-1.0;
#endif
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
wReflectedVector.z*=-1.0;
#endif
var envColor: vec3f=textureSampleLevel(envCubeSampler,envCubeSamplerSampler,wReflectedVector,0.0).xyz;
#ifdef SSR_ENVIRONMENT_CUBE_IS_GAMMASPACE
envColor=toLinearSpaceVec3(envColor);
#endif
#else
var envColor: vec3f=color;
#endif
var reflectionAttenuation: f32=1.0;var rayHasHit: bool=false;var startPixel: vec2f;var hitPixel: vec2f;var hitPoint: vec3f;var numIterations: f32;
#ifdef SSRAYTRACE_DEBUG
var debugColor: vec3f;
#endif
#ifdef SSR_ATTENUATE_FACING_CAMERA
reflectionAttenuation*=1.0-smoothstep(0.25,0.5,dot(-csViewDirection,csReflectedVector));
#endif
if (reflectionAttenuation>0.0) {
#ifdef SSR_USE_BLUR
var jitt: vec3f= vec3f(0.);
#else
var roughness: f32=1.0-reflectivity.a;var jitt: vec3f=mix( vec3f(0.0),hash(csPosition)- vec3f(0.5),roughness)*uniforms.roughnessFactor; 
#endif
var uv2: vec2f=input.vUV*texSize;var c: f32=(uv2.x+uv2.y)*0.25;var jitter: f32=((c)%(1.0)); 
rayHasHit=traceScreenSpaceRay1(
csPosition,
normalize(csReflectedVector+jitt),
uniforms.projectionPixel,
depthSampler,
texSize,
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
backDepthSampler,
uniforms.backSizeFactor,
#endif
uniforms.thickness,
uniforms.nearPlaneZ,
uniforms.farPlaneZ,
uniforms.stepSize,
jitter,
uniforms.maxSteps,
uniforms.maxDistance,
uniforms.selfCollisionNumSkip,
&startPixel,
&hitPixel,
&hitPoint,
&numIterations
#ifdef SSRAYTRACE_DEBUG
,&debugColor
#endif
);}
#ifdef SSRAYTRACE_DEBUG
fragmentOutputs.color= vec4f(debugColor,1.);return fragmentOutputs;
#endif
var F0: vec3f=reflectivity.rgb;var fresnel: vec3f=fresnelSchlickGGXVec3(max(dot(csNormal,-csViewDirection),0.0),F0, vec3f(1.));var SSR: vec3f=envColor;if (rayHasHit) {var reflectedColor: vec3f=textureLoad(textureSampler,vec2<i32>(hitPixel),0).rgb;
#ifdef SSR_INPUT_IS_GAMMA_SPACE
reflectedColor=toLinearSpaceVec3(reflectedColor);
#endif
reflectionAttenuation*=computeAttenuationForIntersection(hitPixel,hitPixel/texSize,csPosition,hitPoint,csReflectedVector,uniforms.maxDistance,numIterations);SSR=reflectedColor*reflectionAttenuation+(1.0-reflectionAttenuation)*envColor;}
#ifndef SSR_BLEND_WITH_FRESNEL
SSR*=fresnel;
#endif
#ifdef SSR_USE_BLUR
var blur_radius: f32=0.0;var roughness: f32=1.0-reflectivity.a*(1.0-uniforms.roughnessFactor);if (roughness>0.001) {var cone_angle: f32=min(roughness,0.999)*3.14159265*0.5;var cone_len: f32=distance(startPixel,hitPixel);var op_len: f32=2.0*tan(cone_angle)*cone_len; 
var a: f32=op_len;var h: f32=cone_len;var a2: f32=a*a;var fh2: f32=4.0f*h*h;blur_radius=(a*(sqrt(a2+fh2)-a))/(4.0f*h);}
fragmentOutputs.color= vec4f(SSR,blur_radius/255.0); 
#else
#ifdef SSR_BLEND_WITH_FRESNEL
var reflectionMultiplier: vec3f=clamp(pow(fresnel*uniforms.strength, vec3f(uniforms.reflectionSpecularFalloffExponent)),vec3f(0.0),vec3f(1.0));
#else
var reflectionMultiplier: vec3f=clamp(pow(reflectivity.rgb*uniforms.strength, vec3f(uniforms.reflectionSpecularFalloffExponent)),vec3f(0.0),vec3f(1.0));
#endif
var colorMultiplier: vec3f=1.0-reflectionMultiplier;var finalColor: vec3f=(color*colorMultiplier)+(SSR*reflectionMultiplier);
#ifdef SSR_OUTPUT_IS_GAMMA_SPACE
finalColor=toGammaSpaceVec3(finalColor);
#endif
fragmentOutputs.color= vec4f(finalColor,colorFull.a);
#endif
#else
fragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);
#endif
}
`;S.ShadersStoreWGSL[kf]||(S.ShadersStoreWGSL[kf]=gP);const F$={name:kf,shader:gP},L$=Object.freeze(Object.defineProperty({__proto__:null,screenSpaceReflection2PixelShaderWGSL:F$},Symbol.toStringTag,{value:"Module"})),Gf="screenSpaceReflection2BlurPixelShader",SP=`var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;varying vUV: vec2f;uniform texelOffsetScale: vec2f;const weights: array<f32,8>=array<f32,8>(0.071303,0.131514,0.189879,0.321392,0.452906, 0.584419,0.715932,0.847445);fn processSample(uv: vec2f,i: f32,stepSize: vec2f,accumulator: ptr<function,vec4f>,denominator: ptr<function,f32>)
{var offsetUV: vec2f=stepSize*i+uv;var coefficient: f32=weights[ i32(2.0-abs(i))];*accumulator+=textureSampleLevel(textureSampler,textureSamplerSampler,offsetUV,0.0)*coefficient;*denominator+=coefficient;}
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var colorFull: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);if (dot(colorFull, vec4f(1.0))==0.0) {fragmentOutputs.color=colorFull;return fragmentOutputs;}
var blurRadius: f32=colorFull.a*255.0; 
var stepSize: vec2f=uniforms.texelOffsetScale.xy*blurRadius;var accumulator: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0)*0.214607;var denominator: f32=0.214607;processSample(input.vUV,1.0,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*0.2,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*0.4,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*0.6,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*0.8,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*1.2,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*1.4,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*1.6,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*1.8,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*2.0,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*0.2,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*0.4,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*0.6,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*0.8,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*1.2,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*1.4,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*1.6,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*1.8,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*2.0,stepSize,&accumulator,&denominator);fragmentOutputs.color= vec4f(accumulator.rgb/denominator,colorFull.a);}
`;S.ShadersStoreWGSL[Gf]||(S.ShadersStoreWGSL[Gf]=SP);const w$={name:Gf,shader:SP},B$=Object.freeze(Object.defineProperty({__proto__:null,screenSpaceReflection2BlurPixelShaderWGSL:w$},Symbol.toStringTag,{value:"Module"})),zf="screenSpaceReflection2BlurCombinerPixelShader",vP=`var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>; 
var mainSamplerSampler: sampler;var mainSampler: texture_2d<f32>;var reflectivitySamplerSampler: sampler;var reflectivitySampler: texture_2d<f32>;uniform strength: f32;uniform reflectionSpecularFalloffExponent: f32;uniform reflectivityThreshold: f32;varying vUV: vec2f;
#include<helperFunctions>
#ifdef SSR_BLEND_WITH_FRESNEL
#include<pbrBRDFFunctions>
#include<screenSpaceRayTrace>
uniform projection: mat4x4f;uniform invProjectionMatrix: mat4x4f;
#ifdef SSR_NORMAL_IS_IN_WORLDSPACE
uniform view: mat4x4f;
#endif
var normalSampler: texture_2d<f32>;var depthSampler: texture_2d<f32>;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
uniform nearPlaneZ: f32;uniform farPlaneZ: f32;
#endif
#endif
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#ifdef SSRAYTRACE_DEBUG
fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);
#else
var SSR: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;var color: vec4f=textureSample(mainSampler,textureSamplerSampler,input.vUV);var reflectivity: vec4f=textureSample(reflectivitySampler,reflectivitySamplerSampler,input.vUV);
#ifndef SSR_DISABLE_REFLECTIVITY_TEST
if (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=uniforms.reflectivityThreshold) {fragmentOutputs.color=color;return fragmentOutputs;}
#endif
#ifdef SSR_INPUT_IS_GAMMA_SPACE
color=toLinearSpaceVec4(color);
#endif
#ifdef SSR_BLEND_WITH_FRESNEL
var texSize: vec2f= vec2f(textureDimensions(depthSampler,0));var csNormal: vec3f=textureLoad(normalSampler,vec2<i32>(input.vUV*texSize),0).xyz;
#ifdef SSR_DECODE_NORMAL
csNormal=csNormal*2.0-1.0;
#endif
#ifdef SSR_NORMAL_IS_IN_WORLDSPACE
csNormal=(uniforms.view*vec4f(csNormal,0.0)).xyz;
#endif
var depth: f32=textureLoad(depthSampler,vec2<i32>(input.vUV*texSize),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
depth=linearizeDepth(depth,uniforms.nearPlaneZ,uniforms.farPlaneZ);
#endif
var csPosition: vec3f=computeViewPosFromUVDepth(input.vUV,depth,uniforms.projection,uniforms.invProjectionMatrix);var csViewDirection: vec3f=normalize(csPosition);var F0: vec3f=reflectivity.rgb;var fresnel: vec3f=fresnelSchlickGGXVec3(max(dot(csNormal,-csViewDirection),0.0),F0, vec3f(1.));var reflectionMultiplier: vec3f=clamp(pow(fresnel*uniforms.strength, vec3f(uniforms.reflectionSpecularFalloffExponent)),vec3f(0.0),vec3f(1.0));
#else
var reflectionMultiplier: vec3f=clamp(pow(reflectivity.rgb*uniforms.strength, vec3f(uniforms.reflectionSpecularFalloffExponent)),vec3f(0.0),vec3f(1.0));
#endif
var colorMultiplier: vec3f=1.0-reflectionMultiplier;var finalColor: vec3f=(color.rgb*colorMultiplier)+(SSR*reflectionMultiplier);
#ifdef SSR_OUTPUT_IS_GAMMA_SPACE
finalColor=toGammaSpaceVec3(finalColor);
#endif
fragmentOutputs.color= vec4f(finalColor,color.a);
#endif
}
`;S.ShadersStoreWGSL[zf]||(S.ShadersStoreWGSL[zf]=vP);const V$={name:zf,shader:vP},U$=Object.freeze(Object.defineProperty({__proto__:null,screenSpaceReflection2BlurCombinerPixelShaderWGSL:V$},Symbol.toStringTag,{value:"Module"})),Wf="taaPixelShader",xP=`varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D historySampler;
#ifdef TAA_REPROJECT_HISTORY
uniform sampler2D velocitySampler;
#endif
uniform float factor;void main() {ivec2 pos=ivec2(gl_FragCoord.xy);vec4 c=texelFetch(textureSampler,pos,0);
#ifdef TAA_REPROJECT_HISTORY
vec4 v=texelFetch(velocitySampler,pos,0);vec4 h=texture2D(historySampler,vUV+v.xy);
#else
vec4 h=texelFetch(historySampler,pos,0);
#endif
#ifdef TAA_CLAMP_HISTORY
vec4 cmin=vec4(1);vec4 cmax=vec4(0);for (int x=-1; x<=1; x+=1) {for (int y=-1; y<=1; y+=1) {vec4 c=texelFetch(textureSampler,pos+ivec2(x,y),0);cmin=min(cmin,c);cmax=max(cmax,c);}}
h=clamp(h,cmin,cmax);
#endif
gl_FragColor=mix(h,c,factor);}
`;S.ShadersStore[Wf]||(S.ShadersStore[Wf]=xP);const k$={name:Wf,shader:xP},G$=Object.freeze(Object.defineProperty({__proto__:null,taaPixelShader:k$},Symbol.toStringTag,{value:"Module"})),Hf="taaPixelShader",EP=`varying vUV: vec2f;var textureSampler: texture_2d<f32>;var historySampler: texture_2d<f32>;
#ifdef TAA_REPROJECT_HISTORY
var historySamplerSampler: sampler;var velocitySampler: texture_2d<f32>;
#endif
uniform factor: f32;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {let pos=vec2i(fragmentInputs.position.xy);let c=textureLoad(textureSampler,pos,0);
#ifdef TAA_REPROJECT_HISTORY
let v=textureLoad(velocitySampler,pos,0);var h=textureSample(historySampler,historySamplerSampler,input.vUV+v.xy);
#else
var h=textureLoad(historySampler,pos,0);
#endif
#ifdef TAA_CLAMP_HISTORY
var cmin=vec4f(1);var cmax=vec4f(0);for (var x=-1; x<=1; x+=1) {for (var y=-1; y<=1; y+=1) {let c=textureLoad(textureSampler,pos+vec2i(x,y),0);cmin=min(cmin,c);cmax=max(cmax,c);}}
h=clamp(h,cmin,cmax);
#endif
fragmentOutputs.color= mix(h,c,uniforms.factor);}
`;S.ShadersStoreWGSL[Hf]||(S.ShadersStoreWGSL[Hf]=EP);const z$={name:Hf,shader:EP},W$=Object.freeze(Object.defineProperty({__proto__:null,taaPixelShaderWGSL:z$},Symbol.toStringTag,{value:"Module"}));class mc extends Se{get exposureAdjustment(){return this._effectWrapper.exposureAdjustment}set exposureAdjustment(e){this._effectWrapper.exposureAdjustment=e}get operator(){return this._effectWrapper.operator}getClassName(){return"TonemapPostProcess"}constructor(e,t,i,r,n=2,a,o=0,l){const c=r===null||r instanceof dt,u={operator:t,exposureAdjustment:i,uniforms:xs.Uniforms,camera:c?r:void 0,samplingMode:n,engine:a,reusable:l,textureType:o};c||Object.assign(u,r),super(e,xs.FragmentUrl,{effectWrapper:c||!r.effectWrapper?new xs(e,a,u):void 0,...u})}static _Parse(e,t,i,r){return me.Parse(()=>new mc(e.name,e.operator,e.exposureAdjustment,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable),e,i,r)}}_([R()],mc.prototype,"exposureAdjustment",null);_([R()],mc.prototype,"operator",null);y("BABYLON.TonemapPostProcess",mc);const rC="volumetricLightScatteringPixelShader",H$=`uniform sampler2D textureSampler;uniform sampler2D lightScatteringSampler;uniform float decay;uniform float exposure;uniform float weight;uniform float density;uniform vec2 meshPositionOnScreen;varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec2 tc=vUV;vec2 deltaTexCoord=(tc-meshPositionOnScreen.xy);deltaTexCoord*=1.0/float(NUM_SAMPLES)*density;float illuminationDecay=1.0;vec4 color=texture2D(lightScatteringSampler,tc)*0.4;for(int i=0; i<NUM_SAMPLES; i++) {tc-=deltaTexCoord;vec4 dataSample=texture2D(lightScatteringSampler,tc)*0.4;dataSample*=illuminationDecay*weight;color+=dataSample;illuminationDecay*=decay;}
vec4 realColor=texture2D(textureSampler,vUV);gl_FragColor=((vec4((vec3(color.r,color.g,color.b)*exposure),realColor.a))+(realColor*(1.5-0.4)));
#define CUSTOM_FRAGMENT_MAIN_END
}
`;S.ShadersStore[rC]||(S.ShadersStore[rC]=H$);const sC="volumetricLightScatteringPassVertexShader",$$=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
uniform mat4 viewProjection;uniform vec2 depthValues;
#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;
#if (defined(ALPHATEST) || defined(NEED_UV)) && defined(UV1)
vec2 uvUpdated=uv;
#endif
#if (defined(ALPHATEST) || defined(NEED_UV)) && defined(UV2)
vec2 uv2Updated=uv2;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
gl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#if defined(ALPHATEST) || defined(BASIC_RENDER)
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2Updated,1.0,0.0));
#endif
#endif
}
`;S.ShadersStore[sC]||(S.ShadersStore[sC]=$$);const nC="volumetricLightScatteringPassPixelShader",X$=`#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;
#endif
#if defined(ALPHATEST)
uniform sampler2D diffuseSampler;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#if defined(ALPHATEST)
vec4 diffuseColor=texture2D(diffuseSampler,vUV);if (diffuseColor.a<0.4)
discard;
#endif
gl_FragColor=vec4(0.0,0.0,0.0,1.0);}
`;S.ShadersStore[nC]||(S.ShadersStore[nC]=X$);class Gr extends Se{get useDiffuseColor(){return N.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead"),!1}set useDiffuseColor(e){N.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead")}constructor(e,t,i,r,n=100,a=$.BILINEAR_SAMPLINGMODE,o,l,c){super(e,"volumetricLightScattering",["decay","exposure","weight","meshPositionOnScreen","density"],["lightScatteringSampler"],t.postProcessRatio||t,i,a,o,l,"#define NUM_SAMPLES "+n),this._screenCoordinates=X.Zero(),this.customMeshPosition=x.Zero(),this.useCustomMeshPosition=!1,this.invert=!0,this.excludedMeshes=[],this.includedMeshes=[],this.exposure=.3,this.decay=.96815,this.weight=.58767,this.density=.926,c=(i==null?void 0:i.getScene())??c??this._scene,o=c.getEngine(),this._viewPort=new Hn(0,0,1,1).toGlobal(o.getRenderWidth(),o.getRenderHeight()),this.mesh=r??Gr.CreateDefaultMesh("VolumetricLightScatteringMesh",c),this._createPass(c,t.passRatio||t),this.onActivate=u=>{this.isSupported||this.dispose(u),this.onActivate=null},this.onApplyObservable.add(u=>{this._updateMeshScreenCoordinates(c),u.setTexture("lightScatteringSampler",this._volumetricLightScatteringRTT),u.setFloat("exposure",this.exposure),u.setFloat("decay",this.decay),u.setFloat("weight",this.weight),u.setFloat("density",this.density),u.setVector2("meshPositionOnScreen",this._screenCoordinates)})}getClassName(){return"VolumetricLightScatteringPostProcess"}_isReady(e,t){var E;const i=e.getMesh();if(i===this.mesh&&i.material)return i.material.isReady(i);const r=(E=i._internalAbstractMeshDataInfo._materialForRenderPass)==null?void 0:E[this._scene.getEngine().currentRenderPassId];if(r)return r.isReadyForSubMesh(i,e,t);const n=[],a=[M.PositionKind],o=e.getMaterial();let l=!1,c=!1;const u=!1;if(o){const T=o.needAlphaTestingForMesh(i);T&&n.push("#define ALPHATEST"),i.isVerticesDataPresent(M.UVKind)&&(a.push(M.UVKind),n.push("#define UV1"),l=T),i.isVerticesDataPresent(M.UV2Kind)&&(a.push(M.UV2Kind),n.push("#define UV2"),c=T)}const h=new Ma;if(i.useBones&&i.computeBonesUsingShaders&&i.skeleton){a.push(M.MatricesIndicesKind),a.push(M.MatricesWeightsKind),i.numBoneInfluencers>4&&(a.push(M.MatricesIndicesExtraKind),a.push(M.MatricesWeightsExtraKind)),n.push("#define NUM_BONE_INFLUENCERS "+i.numBoneInfluencers),i.numBoneInfluencers>0&&h.addCPUSkinningFallback(0,i);const T=i.skeleton;T.isUsingTextureForMatrices?n.push("#define BONETEXTURE"):n.push("#define BonesPerMesh "+(T.bones.length+1))}else n.push("#define NUM_BONE_INFLUENCERS 0");const d=i.morphTargetManager?Eu(i.morphTargetManager,n,a,i,!0,!1,!1,l,c,u):0;t&&(n.push("#define INSTANCES"),Tu(a),e.getRenderingMesh().hasThinInstances&&n.push("#define THIN_INSTANCES"));const f=i.bakedVertexAnimationManager;f&&f.isEnabled&&(n.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&a.push("bakedVertexAnimationSettingsInstanced"));const m=e._getDrawWrapper(void 0,!0),g=m.defines,v=n.join(`
`);if(g!==v){const T=["world","mBones","boneTextureWidth","viewProjection","diffuseMatrix","morphTargetInfluences","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],C=["diffuseSampler","morphTargets","boneSampler","bakedVertexAnimationTexture"];m.setEffect(i.getScene().getEngine().createEffect("volumetricLightScatteringPass",{attributes:a,uniformsNames:T,uniformBuffersNames:[],samplers:C,defines:v,fallbacks:h,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:d}},i.getScene().getEngine()),v)}return m.effect.isReady()}setCustomMeshPosition(e){this.customMeshPosition=e}getCustomMeshPosition(){return this.customMeshPosition}dispose(e){const t=e.getScene().customRenderTargets.indexOf(this._volumetricLightScatteringRTT);t!==-1&&e.getScene().customRenderTargets.splice(t,1),this._volumetricLightScatteringRTT.dispose(),super.dispose(e)}getPass(){return this._volumetricLightScatteringRTT}_meshExcluded(e){return this.includedMeshes.length>0&&this.includedMeshes.indexOf(e)===-1||this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(e)!==-1}_createPass(e,t){const i=e.getEngine();this._volumetricLightScatteringRTT=new Zi("volumetricLightScatteringMap",{width:i.getRenderWidth()*t,height:i.getRenderHeight()*t},e,!1,!0,0),this._volumetricLightScatteringRTT.wrapU=$.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.wrapV=$.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.renderList=null,this._volumetricLightScatteringRTT.renderParticles=!1,this._volumetricLightScatteringRTT.ignoreCameraViewport=!0;const r=this.getCamera();r?r.customRenderTargets.push(this._volumetricLightScatteringRTT):e.customRenderTargets.push(this._volumetricLightScatteringRTT);const n=l=>{var v;const c=l.getRenderingMesh(),u=l.getEffectiveMesh();if(this._meshExcluded(c))return;u._internalAbstractMeshDataInfo._isActiveIntermediate=!1;const h=l.getMaterial();if(!h)return;const d=c.getScene(),f=d.getEngine();f.setState(h.backFaceCulling,void 0,void 0,void 0,h.cullBackFaces);const m=c._getInstancesRenderList(l._id,!!l.getReplacementMesh());if(m.mustReturn)return;const g=f.getCaps().instancedArrays&&(m.visibleInstances[l._id]!==null||c.hasThinInstances);if(this._isReady(l,g)){const E=(v=u._internalAbstractMeshDataInfo._materialForRenderPass)==null?void 0:v[f.currentRenderPassId];let T=l._getDrawWrapper();if(c===this.mesh&&!T&&(T=h._getDrawWrapper()),!T)return;const C=T.effect;if(f.enableEffect(T),g||c._bind(l,C,h.fillMode),c===this.mesh)h.bind(u.getWorldMatrix(),c);else if(E)E.bindForSubMesh(u.getWorldMatrix(),u,l);else{if(C.setMatrix("viewProjection",d.getTransformMatrix()),h.needAlphaTestingForMesh(u)){const I=h.getAlphaTestTexture();I&&(C.setTexture("diffuseSampler",I),C.setMatrix("diffuseMatrix",I.getTextureMatrix()))}Bo(c,C),Da(c,C),c.morphTargetManager&&c.morphTargetManager.isUsingTextureForTargets&&c.morphTargetManager._bind(C);const A=l.getMesh().bakedVertexAnimationManager;A&&A.isEnabled&&A.bind(C,g)}g&&c.hasThinInstances&&C.setMatrix("world",u.getWorldMatrix()),c._processRendering(u,l,C,Le.TriangleFillMode,m,g,(A,I)=>{A||C.setMatrix("world",I)})}};let a;const o=new Te(0,0,0,1);this._volumetricLightScatteringRTT.onBeforeRenderObservable.add(()=>{a=e.clearColor,e.clearColor=o}),this._volumetricLightScatteringRTT.onAfterRenderObservable.add(()=>{e.clearColor=a}),this._volumetricLightScatteringRTT.customIsReadyFunction=(l,c,u)=>{if((u||c===0)&&l.subMeshes)for(let h=0;h<l.subMeshes.length;++h){const d=l.subMeshes[h],f=d.getMaterial(),m=d.getRenderingMesh();if(!f)continue;const g=m._getInstancesRenderList(d._id,!!d.getReplacementMesh()),v=i.getCaps().instancedArrays&&(g.visibleInstances[d._id]!==null||m.hasThinInstances);if(!this._isReady(d,v))return!1}return!0},this._volumetricLightScatteringRTT.customRenderFunction=(l,c,u,h)=>{const d=e.getEngine();let f;if(h.length){for(d.setColorWrite(!1),f=0;f<h.length;f++)n(h.data[f]);d.setColorWrite(!0)}for(f=0;f<l.length;f++)n(l.data[f]);for(f=0;f<c.length;f++)n(c.data[f]);if(u.length){for(f=0;f<u.length;f++){const g=u.data[f],v=g.getBoundingInfo();v&&e.activeCamera&&(g._alphaIndex=g.getMesh().alphaIndex,g._distanceToCamera=v.boundingSphere.centerWorld.subtract(e.activeCamera.position).length())}const m=u.data.slice(0,u.length);for(m.sort((g,v)=>g._alphaIndex>v._alphaIndex?1:g._alphaIndex<v._alphaIndex?-1:g._distanceToCamera<v._distanceToCamera?1:g._distanceToCamera>v._distanceToCamera?-1:0),d.setAlphaMode(2),f=0;f<m.length;f++)n(m[f]);d.setAlphaMode(0)}}}_updateMeshScreenCoordinates(e){const t=e.getTransformMatrix();let i;this.useCustomMeshPosition?i=this.customMeshPosition:this.attachedNode?i=this.attachedNode.position:i=this.mesh.parent?this.mesh.getAbsolutePosition():this.mesh.position;const r=x.Project(i,z.Identity(),t,this._viewPort);this._screenCoordinates.x=r.x/this._viewPort.width,this._screenCoordinates.y=r.y/this._viewPort.height,this.invert&&(this._screenCoordinates.y=1-this._screenCoordinates.y)}static CreateDefaultMesh(e,t){const i=Ym(e,{size:1},t);i.billboardMode=Mt.BILLBOARDMODE_ALL;const r=new Lr(e+"Material",t);return r.emissiveColor=new q(1,1,1),i.material=r,i}}_([Cn()],Gr.prototype,"customMeshPosition",void 0);_([R()],Gr.prototype,"useCustomMeshPosition",void 0);_([R()],Gr.prototype,"invert",void 0);_([Mm()],Gr.prototype,"mesh",void 0);_([R()],Gr.prototype,"excludedMeshes",void 0);_([R()],Gr.prototype,"includedMeshes",void 0);_([R()],Gr.prototype,"exposure",void 0);_([R()],Gr.prototype,"decay",void 0);_([R()],Gr.prototype,"weight",void 0);_([R()],Gr.prototype,"density",void 0);y("BABYLON.VolumetricLightScatteringPostProcess",Gr);const $f="screenSpaceCurvaturePixelShader",TP=`precision highp float;varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D normalSampler;uniform float curvature_ridge;uniform float curvature_valley;
#ifndef CURVATURE_OFFSET
#define CURVATURE_OFFSET 1
#endif
float curvature_soft_clamp(float curvature,float control)
{if (curvature<0.5/control)
return curvature*(1.0-curvature*control);return 0.25/control;}
float calculate_curvature(ivec2 texel,float ridge,float valley)
{vec2 normal_up =texelFetch(normalSampler,texel+ivec2(0, CURVATURE_OFFSET),0).rb;vec2 normal_down =texelFetch(normalSampler,texel+ivec2(0,-CURVATURE_OFFSET),0).rb;vec2 normal_left =texelFetch(normalSampler,texel+ivec2(-CURVATURE_OFFSET,0),0).rb;vec2 normal_right=texelFetch(normalSampler,texel+ivec2( CURVATURE_OFFSET,0),0).rb;float normal_diff=((normal_up.g-normal_down.g)+(normal_right.r-normal_left.r));if (normal_diff<0.0)
return -2.0*curvature_soft_clamp(-normal_diff,valley);return 2.0*curvature_soft_clamp(normal_diff,ridge);}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{ivec2 texel=ivec2(gl_FragCoord.xy);vec4 baseColor=texture2D(textureSampler,vUV);float curvature=calculate_curvature(texel,curvature_ridge,curvature_valley);baseColor.rgb*=curvature+1.0;gl_FragColor=baseColor;}`;S.ShadersStore[$f]||(S.ShadersStore[$f]=TP);const Y$={name:$f,shader:TP},j$=Object.freeze(Object.defineProperty({__proto__:null,screenSpaceCurvaturePixelShader:Y$},Symbol.toStringTag,{value:"Module"}));class _c extends Se{get ridge(){return this._effectWrapper.ridge}set ridge(e){this._effectWrapper.ridge=e}get valley(){return this._effectWrapper.valley}set valley(e){this._effectWrapper.valley=e}getClassName(){return"ScreenSpaceCurvaturePostProcess"}constructor(e,t,i,r,n,a,o,l=0,c=!1){const u={uniforms:Fr.Uniforms,samplers:Fr.Samplers,size:typeof i=="number"?i:void 0,camera:r,samplingMode:n,engine:a,reusable:o,textureType:l,blockCompilation:c,...i};super(e,Fr.FragmentUrl,{effectWrapper:typeof i=="number"||!i.effectWrapper?new Fr(e,a,u):void 0,...u}),this._geometryBufferRenderer=t.enableGeometryBufferRenderer(),this._geometryBufferRenderer?(this._geometryBufferRenderer.generateNormalsInWorldSpace&&N.Error("ScreenSpaceCurvaturePostProcess does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!"),this.onApply=h=>{const d=this._geometryBufferRenderer.getGBuffer().textures[1];h.setTexture("normalSampler",d)}):N.Error("Multiple Render Target support needed for screen space curvature post process. Please use IsSupported test first.")}static get IsSupported(){const e=De.LastCreatedEngine;return e?e.getCaps().drawBuffersExtension:!1}static _Parse(e,t,i,r){return me.Parse(()=>new _c(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable),e,i,r)}}_([R()],_c.prototype,"ridge",null);_([R()],_c.prototype,"valley",null);y("BABYLON.ScreenSpaceCurvaturePostProcess",_c);const Xf="vrDistortionCorrectionPixelShader",bP=`varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 LensCenter;uniform vec2 Scale;uniform vec2 ScaleIn;uniform vec4 HmdWarpParam;vec2 HmdWarp(vec2 in01) {vec2 theta=(in01-LensCenter)*ScaleIn; 
float rSq=theta.x*theta.x+theta.y*theta.y;vec2 rvector=theta*(HmdWarpParam.x+HmdWarpParam.y*rSq+HmdWarpParam.z*rSq*rSq+HmdWarpParam.w*rSq*rSq*rSq);return LensCenter+Scale*rvector;}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec2 tc=HmdWarp(vUV);if (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0)
gl_FragColor=vec4(0.0,0.0,0.0,0.0);else{gl_FragColor=texture2D(textureSampler,tc);}}`;S.ShadersStore[Xf]||(S.ShadersStore[Xf]=bP);const q$={name:Xf,shader:bP},Z$=Object.freeze(Object.defineProperty({__proto__:null,vrDistortionCorrectionPixelShader:q$},Symbol.toStringTag,{value:"Module"})),Yf="vrDistortionCorrectionPixelShader",CP=`#define DISABLE_UNIFORMITY_ANALYSIS
varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform LensCenter: vec2f;uniform Scale: vec2f;uniform ScaleIn: vec2f;uniform HmdWarpParam: vec4f;fn HmdWarp(in01: vec2f)->vec2f {var theta: vec2f=(in01-uniforms.LensCenter)*uniforms.ScaleIn; 
var rSq: f32=theta.x*theta.x+theta.y*theta.y;var rvector: vec2f=theta*(uniforms.HmdWarpParam.x+uniforms.HmdWarpParam.y*rSq+uniforms.HmdWarpParam.z*rSq*rSq+uniforms.HmdWarpParam.w*rSq*rSq*rSq);return uniforms.LensCenter+uniforms.Scale*rvector;}
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var tc: vec2f=HmdWarp(input.vUV);if (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0) {fragmentOutputs.color=vec4f(0.0,0.0,0.0,0.0);}
else{fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,tc);}}`;S.ShadersStoreWGSL[Yf]||(S.ShadersStoreWGSL[Yf]=CP);const Q$={name:Yf,shader:CP},K$=Object.freeze(Object.defineProperty({__proto__:null,vrDistortionCorrectionPixelShaderWGSL:Q$},Symbol.toStringTag,{value:"Module"})),jf="imageProcessingPixelShader",yP=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;
#include<imageProcessingDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var result: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);result=vec4f(max(result.rgb,vec3f(0.)),result.a);
#ifdef IMAGEPROCESSING
#ifndef FROMLINEARSPACE
result=vec4f(toLinearSpaceVec3(result.rgb),result.a);
#endif
result=applyImageProcessing(result);
#else
#ifdef FROMLINEARSPACE
result=applyImageProcessing(result);
#endif
#endif
fragmentOutputs.color=result;}`;S.ShadersStoreWGSL[jf]||(S.ShadersStoreWGSL[jf]=yP);const J$={name:jf,shader:yP},eX=Object.freeze(Object.defineProperty({__proto__:null,imageProcessingPixelShaderWGSL:J$},Symbol.toStringTag,{value:"Module"})),qf="imageProcessingPixelShader",IP=`varying vec2 vUV;uniform sampler2D textureSampler;
#include<imageProcessingDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec4 result=texture2D(textureSampler,vUV);result.rgb=max(result.rgb,vec3(0.));
#ifdef IMAGEPROCESSING
#ifndef FROMLINEARSPACE
result.rgb=toLinearSpace(result.rgb);
#endif
result=applyImageProcessing(result);
#else
#ifdef FROMLINEARSPACE
result=applyImageProcessing(result);
#endif
#endif
gl_FragColor=result;}`;S.ShadersStore[qf]||(S.ShadersStore[qf]=IP);const tX={name:qf,shader:IP},iX=Object.freeze(Object.defineProperty({__proto__:null,imageProcessingPixelShader:tX},Symbol.toStringTag,{value:"Module"})),Zf="sharpenPixelShader",RP=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform screenSize: vec2f;uniform sharpnessAmounts: vec2f;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var onePixel: vec2f= vec2f(1.0,1.0)/uniforms.screenSize;var color: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);var edgeDetection: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel*vec2f(0,-1)) +
textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel*vec2f(-1,0)) +
textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel*vec2f(1,0)) +
textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel*vec2f(0,1)) -
color*4.0;fragmentOutputs.color=max(vec4f(color.rgb*uniforms.sharpnessAmounts.y,color.a)-(uniforms.sharpnessAmounts.x* vec4f(edgeDetection.rgb,0)),vec4f(0.));}`;S.ShadersStoreWGSL[Zf]||(S.ShadersStoreWGSL[Zf]=RP);const rX={name:Zf,shader:RP},sX=Object.freeze(Object.defineProperty({__proto__:null,sharpenPixelShaderWGSL:rX},Symbol.toStringTag,{value:"Module"})),Qf="grainPixelShader",AP=`#include<helperFunctions>
uniform sampler2D textureSampler; 
uniform float intensity;uniform float animatedSeed;varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{gl_FragColor=texture2D(textureSampler,vUV);vec2 seed=vUV*(animatedSeed);float grain=dither(seed,intensity);float lum=getLuminance(gl_FragColor.rgb);float grainAmount=(cos(-PI+(lum*PI*2.))+1.)/2.;gl_FragColor.rgb+=grain*grainAmount;gl_FragColor.rgb=max(gl_FragColor.rgb,0.0);}`;S.ShadersStore[Qf]||(S.ShadersStore[Qf]=AP);const nX={name:Qf,shader:AP},aX=Object.freeze(Object.defineProperty({__proto__:null,grainPixelShader:nX},Symbol.toStringTag,{value:"Module"})),Kf="grainPixelShader",PP=`#include<helperFunctions>
varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform intensity: f32;uniform animatedSeed: f32;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);var seed: vec2f=input.vUV*uniforms.animatedSeed;var grain: f32=dither(seed,uniforms.intensity);var lum: f32=getLuminance(fragmentOutputs.color.rgb);var grainAmount: f32=(cos(-PI+(lum*PI*2.))+1.)/2.;fragmentOutputs.color=vec4f(fragmentOutputs.color.rgb+grain*grainAmount,fragmentOutputs.color.a);fragmentOutputs.color=vec4f(max(fragmentOutputs.color.rgb,vec3f(0.0)),fragmentOutputs.color.a);}`;S.ShadersStoreWGSL[Kf]||(S.ShadersStoreWGSL[Kf]=PP);const oX={name:Kf,shader:PP},lX=Object.freeze(Object.defineProperty({__proto__:null,grainPixelShaderWGSL:oX},Symbol.toStringTag,{value:"Module"})),Jf="chromaticAberrationPixelShader",OP=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform chromatic_aberration: f32;uniform radialIntensity: f32;uniform direction: vec2f;uniform centerPosition: vec2f;uniform screen_width: f32;uniform screen_height: f32;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var centered_screen_pos: vec2f= vec2f(input.vUV.x-uniforms.centerPosition.x,input.vUV.y-uniforms.centerPosition.y);var directionOfEffect: vec2f=uniforms.direction;if(directionOfEffect.x==0. && directionOfEffect.y==0.){directionOfEffect=normalize(centered_screen_pos);}
var radius2: f32=centered_screen_pos.x*centered_screen_pos.x
+ centered_screen_pos.y*centered_screen_pos.y;var radius: f32=sqrt(radius2);var ref_indices: vec3f= vec3f(-0.3,0.0,0.3);var ref_shiftX: f32=uniforms.chromatic_aberration*pow(radius,uniforms.radialIntensity)*directionOfEffect.x/uniforms.screen_width;var ref_shiftY: f32=uniforms.chromatic_aberration*pow(radius,uniforms.radialIntensity)*directionOfEffect.y/uniforms.screen_height;var ref_coords_r: vec2f=vec2f(input.vUV.x+ref_indices.r*ref_shiftX,input.vUV.y+ref_indices.r*ref_shiftY*0.5);var ref_coords_g: vec2f=vec2f(input.vUV.x+ref_indices.g*ref_shiftX,input.vUV.y+ref_indices.g*ref_shiftY*0.5);var ref_coords_b: vec2f=vec2f(input.vUV.x+ref_indices.b*ref_shiftX,input.vUV.y+ref_indices.b*ref_shiftY*0.5);var r=textureSample(textureSampler,textureSamplerSampler,ref_coords_r);var g=textureSample(textureSampler,textureSamplerSampler,ref_coords_g);var b=textureSample(textureSampler,textureSamplerSampler,ref_coords_b);var a=clamp(r.a+g.a+b.a,0.,1.);fragmentOutputs.color=vec4f(r.r,g.g,b.b,a);}`;S.ShadersStoreWGSL[Jf]||(S.ShadersStoreWGSL[Jf]=OP);const cX={name:Jf,shader:OP},uX=Object.freeze(Object.defineProperty({__proto__:null,chromaticAberrationPixelShaderWGSL:cX},Symbol.toStringTag,{value:"Module"})),ep="depthOfFieldMergePixelShader",NP=`#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,lod) texture2DLodEXT(s,c,lod)
#else
#define TEXTUREFUNC(s,c,bias) texture2D(s,c,bias)
#endif
uniform sampler2D textureSampler;varying vec2 vUV;uniform sampler2D circleOfConfusionSampler;uniform sampler2D blurStep0;
#if BLUR_LEVEL>0
uniform sampler2D blurStep1;
#endif
#if BLUR_LEVEL>1
uniform sampler2D blurStep2;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{float coc=TEXTUREFUNC(circleOfConfusionSampler,vUV,0.0).r;
#if BLUR_LEVEL==0
vec4 original=TEXTUREFUNC(textureSampler,vUV,0.0);vec4 blurred0=TEXTUREFUNC(blurStep0,vUV,0.0);gl_FragColor=mix(original,blurred0,coc);
#endif
#if BLUR_LEVEL==1
if(coc<0.5){vec4 original=TEXTUREFUNC(textureSampler,vUV,0.0);vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);gl_FragColor=mix(original,blurred1,coc/0.5);}else{vec4 blurred0=TEXTUREFUNC(blurStep0,vUV,0.0);vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);gl_FragColor=mix(blurred1,blurred0,(coc-0.5)/0.5);}
#endif
#if BLUR_LEVEL==2
if(coc<0.33){vec4 original=TEXTUREFUNC(textureSampler,vUV,0.0);vec4 blurred2=TEXTUREFUNC(blurStep2,vUV,0.0);gl_FragColor=mix(original,blurred2,coc/0.33);}else if(coc<0.66){vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);vec4 blurred2=TEXTUREFUNC(blurStep2,vUV,0.0);gl_FragColor=mix(blurred2,blurred1,(coc-0.33)/0.33);}else{vec4 blurred0=TEXTUREFUNC(blurStep0,vUV,0.0);vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);gl_FragColor=mix(blurred1,blurred0,(coc-0.66)/0.34);}
#endif
}
`;S.ShadersStore[ep]||(S.ShadersStore[ep]=NP);const hX={name:ep,shader:NP},dX=Object.freeze(Object.defineProperty({__proto__:null,depthOfFieldMergePixelShader:hX},Symbol.toStringTag,{value:"Module"})),tp="depthOfFieldMergePixelShader",DP=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var circleOfConfusionSamplerSampler: sampler;var circleOfConfusionSampler: texture_2d<f32>;var blurStep0Sampler: sampler;var blurStep0: texture_2d<f32>;
#if BLUR_LEVEL>0
var blurStep1Sampler: sampler;var blurStep1: texture_2d<f32>;
#endif
#if BLUR_LEVEL>1
var blurStep2Sampler: sampler;var blurStep2: texture_2d<f32>;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var coc: f32=textureSampleLevel(circleOfConfusionSampler,circleOfConfusionSamplerSampler,input.vUV,0.0).r;
#if BLUR_LEVEL==0
var original: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);var blurred0: vec4f=textureSampleLevel(blurStep0,blurStep0Sampler,input.vUV,0.0);fragmentOutputs.color=mix(original,blurred0,coc);
#endif
#if BLUR_LEVEL==1
if(coc<0.5){var original: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);var blurred1: vec4f=textureSampleLevel(blurStep1,blurStep1Sampler,input.vUV,0.0);fragmentOutputs.color=mix(original,blurred1,coc/0.5);}else{var blurred0: vec4f=textureSampleLevel(blurStep0,blurStep0Sampler,input.vUV,0.0);var blurred1: vec4f=textureSampleLevel(blurStep1,blurStep1Sampler,input.vUV,0.0);fragmentOutputs.color=mix(blurred1,blurred0,(coc-0.5)/0.5);}
#endif
#if BLUR_LEVEL==2
if(coc<0.33){var original: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);var blurred2: vec4f=textureSampleLevel(blurStep2,blurStep2Sampler,input.vUV,0.0);fragmentOutputs.color=mix(original,blurred2,coc/0.33);}else if(coc<0.66){var blurred1: vec4f=textureSampleLevel(blurStep1,blurStep1Sampler,input.vUV,0.0);var blurred2: vec4f=textureSampleLevel(blurStep2,blurStep2Sampler,input.vUV,0.0);fragmentOutputs.color=mix(blurred2,blurred1,(coc-0.33)/0.33);}else{var blurred0: vec4f=textureSampleLevel(blurStep0,blurStep0Sampler,input.vUV,0.0);var blurred1: vec4f=textureSampleLevel(blurStep1,blurStep1Sampler,input.vUV,0.0);fragmentOutputs.color=mix(blurred1,blurred0,(coc-0.66)/0.34);}
#endif
}
`;S.ShadersStoreWGSL[tp]||(S.ShadersStoreWGSL[tp]=DP);const fX={name:tp,shader:DP},pX=Object.freeze(Object.defineProperty({__proto__:null,depthOfFieldMergePixelShaderWGSL:fX},Symbol.toStringTag,{value:"Module"})),ip="circleOfConfusionPixelShader",MP=`uniform sampler2D depthSampler;varying vec2 vUV;
#ifndef COC_DEPTH_NOT_NORMALIZED
uniform vec2 cameraMinMaxZ;
#endif
uniform float focusDistance;uniform float cocPrecalculation;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{float depth=texture2D(depthSampler,vUV).r;
#define CUSTOM_COC_DEPTH
#ifdef COC_DEPTH_NOT_NORMALIZED
float pixelDistance=depth*1000.0;
#else
float pixelDistance=(cameraMinMaxZ.x+cameraMinMaxZ.y*depth)*1000.0; 
#endif
#define CUSTOM_COC_PIXELDISTANCE
float coc=abs(cocPrecalculation*((focusDistance-pixelDistance)/pixelDistance));coc=clamp(coc,0.0,1.0);gl_FragColor=vec4(coc,coc,coc,1.0);}
`;S.ShadersStore[ip]||(S.ShadersStore[ip]=MP);const mX={name:ip,shader:MP},_X=Object.freeze(Object.defineProperty({__proto__:null,circleOfConfusionPixelShader:mX},Symbol.toStringTag,{value:"Module"})),rp="circleOfConfusionPixelShader",FP=`varying vUV: vec2f;var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;
#ifndef COC_DEPTH_NOT_NORMALIZED
uniform cameraMinMaxZ: vec2f;
#endif
uniform focusDistance: f32;uniform cocPrecalculation: f32;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var depth: f32=textureSample(depthSampler,depthSamplerSampler,input.vUV).r;
#define CUSTOM_COC_DEPTH
#ifdef COC_DEPTH_NOT_NORMALIZED
let pixelDistance=depth*1000.0;
#else
let pixelDistance: f32=(uniforms.cameraMinMaxZ.x+uniforms.cameraMinMaxZ.y*depth)*1000.0; 
#endif
#define CUSTOM_COC_PIXELDISTANCE
var coc: f32=abs(uniforms.cocPrecalculation*((uniforms.focusDistance-pixelDistance)/pixelDistance));coc=clamp(coc,0.0,1.0);fragmentOutputs.color= vec4f(coc,coc,coc,1.0);}
`;S.ShadersStoreWGSL[rp]||(S.ShadersStoreWGSL[rp]=FP);const gX={name:rp,shader:FP},SX=Object.freeze(Object.defineProperty({__proto__:null,circleOfConfusionPixelShaderWGSL:gX},Symbol.toStringTag,{value:"Module"})),sp="bloomMergePixelShader",LP=`uniform sampler2D textureSampler;uniform sampler2D bloomBlur;varying vec2 vUV;uniform float bloomWeight;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{gl_FragColor=texture2D(textureSampler,vUV);vec3 blurred=texture2D(bloomBlur,vUV).rgb;gl_FragColor.rgb=gl_FragColor.rgb+(blurred.rgb*bloomWeight); }
`;S.ShadersStore[sp]||(S.ShadersStore[sp]=LP);const vX={name:sp,shader:LP},xX=Object.freeze(Object.defineProperty({__proto__:null,bloomMergePixelShader:vX},Symbol.toStringTag,{value:"Module"})),np="bloomMergePixelShader",wP=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var bloomBlurSampler: sampler;var bloomBlur: texture_2d<f32>;uniform bloomWeight: f32;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);var blurred: vec3f=textureSample(bloomBlur,bloomBlurSampler,input.vUV).rgb;fragmentOutputs.color=vec4f(fragmentOutputs.color.rgb+(blurred.rgb*uniforms.bloomWeight),fragmentOutputs.color.a);}
`;S.ShadersStoreWGSL[np]||(S.ShadersStoreWGSL[np]=wP);const EX={name:np,shader:wP},TX=Object.freeze(Object.defineProperty({__proto__:null,bloomMergePixelShaderWGSL:EX},Symbol.toStringTag,{value:"Module"})),ap="extractHighlightsPixelShader",BP=`#include<helperFunctions>
varying vec2 vUV;uniform sampler2D textureSampler;uniform float threshold;uniform float exposure;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{gl_FragColor=texture2D(textureSampler,vUV);float luma=dot(LuminanceEncodeApprox,gl_FragColor.rgb*exposure);gl_FragColor.rgb=step(threshold,luma)*gl_FragColor.rgb;}`;S.ShadersStore[ap]||(S.ShadersStore[ap]=BP);const bX={name:ap,shader:BP},CX=Object.freeze(Object.defineProperty({__proto__:null,extractHighlightsPixelShader:bX},Symbol.toStringTag,{value:"Module"})),op="extractHighlightsPixelShader",VP=`#include<helperFunctions>
varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform threshold: f32;uniform exposure: f32;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);var luma: f32=dot(LuminanceEncodeApprox,fragmentOutputs.color.rgb*uniforms.exposure);fragmentOutputs.color=vec4f(step(uniforms.threshold,luma)*fragmentOutputs.color.rgb,fragmentOutputs.color.a);}`;S.ShadersStoreWGSL[op]||(S.ShadersStoreWGSL[op]=VP);const yX={name:op,shader:VP},IX=Object.freeze(Object.defineProperty({__proto__:null,extractHighlightsPixelShaderWGSL:yX},Symbol.toStringTag,{value:"Module"})),lp="fxaaPixelShader",UP=`#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)
#else
#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)
#endif
uniform sampler2D textureSampler;uniform vec2 texelSize;varying vec2 vUV;varying vec2 sampleCoordS;varying vec2 sampleCoordE;varying vec2 sampleCoordN;varying vec2 sampleCoordW;varying vec2 sampleCoordNW;varying vec2 sampleCoordSE;varying vec2 sampleCoordNE;varying vec2 sampleCoordSW;const float fxaaQualitySubpix=1.0;const float fxaaQualityEdgeThreshold=0.166;const float fxaaQualityEdgeThresholdMin=0.0833;const vec3 kLumaCoefficients=vec3(0.2126,0.7152,0.0722);
#define FxaaLuma(rgba) dot(rgba.rgb,kLumaCoefficients)
void main(){vec2 posM;posM.x=vUV.x;posM.y=vUV.y;vec4 rgbyM=TEXTUREFUNC(textureSampler,vUV,0.0);float lumaM=FxaaLuma(rgbyM);float lumaS=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordS,0.0));float lumaE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordE,0.0));float lumaN=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordN,0.0));float lumaW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordW,0.0));float maxSM=max(lumaS,lumaM);float minSM=min(lumaS,lumaM);float maxESM=max(lumaE,maxSM);float minESM=min(lumaE,minSM);float maxWN=max(lumaN,lumaW);float minWN=min(lumaN,lumaW);float rangeMax=max(maxWN,maxESM);float rangeMin=min(minWN,minESM);float rangeMaxScaled=rangeMax*fxaaQualityEdgeThreshold;float range=rangeMax-rangeMin;float rangeMaxClamped=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);
#ifndef MALI
if(range<rangeMaxClamped) 
{gl_FragColor=rgbyM;return;}
#endif
float lumaNW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordNW,0.0));float lumaSE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordSE,0.0));float lumaNE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordNE,0.0));float lumaSW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordSW,0.0));float lumaNS=lumaN+lumaS;float lumaWE=lumaW+lumaE;float subpixRcpRange=1.0/range;float subpixNSWE=lumaNS+lumaWE;float edgeHorz1=(-2.0*lumaM)+lumaNS;float edgeVert1=(-2.0*lumaM)+lumaWE;float lumaNESE=lumaNE+lumaSE;float lumaNWNE=lumaNW+lumaNE;float edgeHorz2=(-2.0*lumaE)+lumaNESE;float edgeVert2=(-2.0*lumaN)+lumaNWNE;float lumaNWSW=lumaNW+lumaSW;float lumaSWSE=lumaSW+lumaSE;float edgeHorz4=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);float edgeVert4=(abs(edgeVert1)*2.0)+abs(edgeVert2);float edgeHorz3=(-2.0*lumaW)+lumaNWSW;float edgeVert3=(-2.0*lumaS)+lumaSWSE;float edgeHorz=abs(edgeHorz3)+edgeHorz4;float edgeVert=abs(edgeVert3)+edgeVert4;float subpixNWSWNESE=lumaNWSW+lumaNESE;float lengthSign=texelSize.x;bool horzSpan=edgeHorz>=edgeVert;float subpixA=subpixNSWE*2.0+subpixNWSWNESE;if (!horzSpan)
{lumaN=lumaW;}
if (!horzSpan) 
{lumaS=lumaE;}
if (horzSpan) 
{lengthSign=texelSize.y;}
float subpixB=(subpixA*(1.0/12.0))-lumaM;float gradientN=lumaN-lumaM;float gradientS=lumaS-lumaM;float lumaNN=lumaN+lumaM;float lumaSS=lumaS+lumaM;bool pairN=abs(gradientN)>=abs(gradientS);float gradient=max(abs(gradientN),abs(gradientS));if (pairN)
{lengthSign=-lengthSign;}
float subpixC=clamp(abs(subpixB)*subpixRcpRange,0.0,1.0);vec2 posB;posB.x=posM.x;posB.y=posM.y;vec2 offNP;offNP.x=(!horzSpan) ? 0.0 : texelSize.x;offNP.y=(horzSpan) ? 0.0 : texelSize.y;if (!horzSpan) 
{posB.x+=lengthSign*0.5;}
if (horzSpan)
{posB.y+=lengthSign*0.5;}
vec2 posN;posN.x=posB.x-offNP.x*1.5;posN.y=posB.y-offNP.y*1.5;vec2 posP;posP.x=posB.x+offNP.x*1.5;posP.y=posB.y+offNP.y*1.5;float subpixD=((-2.0)*subpixC)+3.0;float lumaEndN=FxaaLuma(TEXTUREFUNC(textureSampler,posN,0.0));float subpixE=subpixC*subpixC;float lumaEndP=FxaaLuma(TEXTUREFUNC(textureSampler,posP,0.0));if (!pairN) 
{lumaNN=lumaSS;}
float gradientScaled=gradient*1.0/4.0;float lumaMM=lumaM-lumaNN*0.5;float subpixF=subpixD*subpixE;bool lumaMLTZero=lumaMM<0.0;lumaEndN-=lumaNN*0.5;lumaEndP-=lumaNN*0.5;bool doneN=abs(lumaEndN)>=gradientScaled;bool doneP=abs(lumaEndP)>=gradientScaled;if (!doneN) 
{posN.x-=offNP.x*3.0;}
if (!doneN) 
{posN.y-=offNP.y*3.0;}
bool doneNP=(!doneN) || (!doneP);if (!doneP) 
{posP.x+=offNP.x*3.0;}
if (!doneP)
{posP.y+=offNP.y*3.0;}
if (doneNP)
{if (!doneN) lumaEndN=FxaaLuma(TEXTUREFUNC(textureSampler,posN.xy,0.0));if (!doneP) lumaEndP=FxaaLuma(TEXTUREFUNC(textureSampler,posP.xy,0.0));if (!doneN) lumaEndN=lumaEndN-lumaNN*0.5;if (!doneP) lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if (!doneN) posN.x-=offNP.x*12.0;if (!doneN) posN.y-=offNP.y*12.0;doneNP=(!doneN) || (!doneP);if (!doneP) posP.x+=offNP.x*12.0;if (!doneP) posP.y+=offNP.y*12.0;}
float dstN=posM.x-posN.x;float dstP=posP.x-posM.x;if (!horzSpan)
{dstN=posM.y-posN.y;}
if (!horzSpan) 
{dstP=posP.y-posM.y;}
bool goodSpanN=(lumaEndN<0.0) != lumaMLTZero;float spanLength=(dstP+dstN);bool goodSpanP=(lumaEndP<0.0) != lumaMLTZero;float spanLengthRcp=1.0/spanLength;bool directionN=dstN<dstP;float dst=min(dstN,dstP);bool goodSpan=directionN ? goodSpanN : goodSpanP;float subpixG=subpixF*subpixF;float pixelOffset=(dst*(-spanLengthRcp))+0.5;float subpixH=subpixG*fxaaQualitySubpix;float pixelOffsetGood=goodSpan ? pixelOffset : 0.0;float pixelOffsetSubpix=max(pixelOffsetGood,subpixH);if (!horzSpan)
{posM.x+=pixelOffsetSubpix*lengthSign;}
if (horzSpan)
{posM.y+=pixelOffsetSubpix*lengthSign;}
#ifdef MALI
if(range<rangeMaxClamped) 
{gl_FragColor=rgbyM;}
else
{gl_FragColor=TEXTUREFUNC(textureSampler,posM,0.0);}
#else
gl_FragColor=TEXTUREFUNC(textureSampler,posM,0.0);
#endif
}`;S.ShadersStore[lp]||(S.ShadersStore[lp]=UP);const RX={name:lp,shader:UP},AX=Object.freeze(Object.defineProperty({__proto__:null,fxaaPixelShader:RX},Symbol.toStringTag,{value:"Module"})),cp="fxaaVertexShader",kP=`attribute vec2 position;uniform vec2 texelSize;varying vec2 vUV;varying vec2 sampleCoordS;varying vec2 sampleCoordE;varying vec2 sampleCoordN;varying vec2 sampleCoordW;varying vec2 sampleCoordNW;varying vec2 sampleCoordSE;varying vec2 sampleCoordNE;varying vec2 sampleCoordSW;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=(position*madd+madd);sampleCoordS=vUV+vec2( 0.0,1.0)*texelSize;sampleCoordE=vUV+vec2( 1.0,0.0)*texelSize;sampleCoordN=vUV+vec2( 0.0,-1.0)*texelSize;sampleCoordW=vUV+vec2(-1.0,0.0)*texelSize;sampleCoordNW=vUV+vec2(-1.0,-1.0)*texelSize;sampleCoordSE=vUV+vec2( 1.0,1.0)*texelSize;sampleCoordNE=vUV+vec2( 1.0,-1.0)*texelSize;sampleCoordSW=vUV+vec2(-1.0,1.0)*texelSize;gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;S.ShadersStore[cp]||(S.ShadersStore[cp]=kP);const PX={name:cp,shader:kP},OX=Object.freeze(Object.defineProperty({__proto__:null,fxaaVertexShader:PX},Symbol.toStringTag,{value:"Module"})),up="fxaaPixelShader",GP=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform texelSize: vec2f;varying sampleCoordS: vec2f;varying sampleCoordE: vec2f;varying sampleCoordN: vec2f;varying sampleCoordW: vec2f;varying sampleCoordNW: vec2f;varying sampleCoordSE: vec2f;varying sampleCoordNE: vec2f;varying sampleCoordSW: vec2f;const fxaaQualitySubpix: f32=1.0;const fxaaQualityEdgeThreshold: f32=0.166;const fxaaQualityEdgeThresholdMin: f32=0.0833;const kLumaCoefficients: vec3f= vec3f(0.2126,0.7152,0.0722);fn FxaaLuma(rgba: vec4f)->f32 {return dot(rgba.rgb,kLumaCoefficients);} 
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var posM: vec2f;posM.x=input.vUV.x;posM.y=input.vUV.y;var rgbyM: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);var lumaM: f32=FxaaLuma(rgbyM);var lumaS: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordS,0.0));var lumaE: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordE,0.0));var lumaN: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordN,0.0));var lumaW: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordW,0.0));var maxSM: f32=max(lumaS,lumaM);var minSM: f32=min(lumaS,lumaM);var maxESM: f32=max(lumaE,maxSM);var minESM: f32=min(lumaE,minSM);var maxWN: f32=max(lumaN,lumaW);var minWN: f32=min(lumaN,lumaW);var rangeMax: f32=max(maxWN,maxESM);var rangeMin: f32=min(minWN,minESM);var rangeMaxScaled: f32=rangeMax*fxaaQualityEdgeThreshold;var range: f32=rangeMax-rangeMin;var rangeMaxClamped: f32=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);
#ifndef MALI
if(range<rangeMaxClamped) 
{fragmentOutputs.color=rgbyM;return fragmentOutputs;}
#endif
var lumaNW: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordNW,0.0));var lumaSE: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordSE,0.0));var lumaNE: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordNE,0.0));var lumaSW: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordSW,0.0));var lumaNS: f32=lumaN+lumaS;var lumaWE: f32=lumaW+lumaE;var subpixRcpRange: f32=1.0/range;var subpixNSWE: f32=lumaNS+lumaWE;var edgeHorz1: f32=(-2.0*lumaM)+lumaNS;var edgeVert1: f32=(-2.0*lumaM)+lumaWE;var lumaNESE: f32=lumaNE+lumaSE;var lumaNWNE: f32=lumaNW+lumaNE;var edgeHorz2: f32=(-2.0*lumaE)+lumaNESE;var edgeVert2: f32=(-2.0*lumaN)+lumaNWNE;var lumaNWSW: f32=lumaNW+lumaSW;var lumaSWSE: f32=lumaSW+lumaSE;var edgeHorz4: f32=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);var edgeVert4: f32=(abs(edgeVert1)*2.0)+abs(edgeVert2);var edgeHorz3: f32=(-2.0*lumaW)+lumaNWSW;var edgeVert3: f32=(-2.0*lumaS)+lumaSWSE;var edgeHorz: f32=abs(edgeHorz3)+edgeHorz4;var edgeVert: f32=abs(edgeVert3)+edgeVert4;var subpixNWSWNESE: f32=lumaNWSW+lumaNESE;var lengthSign: f32=uniforms.texelSize.x;var horzSpan: bool=edgeHorz>=edgeVert;var subpixA: f32=subpixNSWE*2.0+subpixNWSWNESE;if (!horzSpan)
{lumaN=lumaW;}
if (!horzSpan) 
{lumaS=lumaE;}
if (horzSpan) 
{lengthSign=uniforms.texelSize.y;}
var subpixB: f32=(subpixA*(1.0/12.0))-lumaM;var gradientN: f32=lumaN-lumaM;var gradientS: f32=lumaS-lumaM;var lumaNN: f32=lumaN+lumaM;var lumaSS: f32=lumaS+lumaM;var pairN: bool=abs(gradientN)>=abs(gradientS);var gradient: f32=max(abs(gradientN),abs(gradientS));if (pairN)
{lengthSign=-lengthSign;}
var subpixC: f32=clamp(abs(subpixB)*subpixRcpRange,0.0,1.0);var posB: vec2f;posB.x=posM.x;posB.y=posM.y;var offNP: vec2f;offNP.x=select(uniforms.texelSize.x,0.0,(!horzSpan));offNP.y=select(uniforms.texelSize.y,0.0,(horzSpan));if (!horzSpan) 
{posB.x+=lengthSign*0.5;}
if (horzSpan)
{posB.y+=lengthSign*0.5;}
var posN: vec2f;posN.x=posB.x-offNP.x*1.5;posN.y=posB.y-offNP.y*1.5;var posP: vec2f;posP.x=posB.x+offNP.x*1.5;posP.y=posB.y+offNP.y*1.5;var subpixD: f32=((-2.0)*subpixC)+3.0;var lumaEndN: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,posN,0.0));var subpixE: f32=subpixC*subpixC;var lumaEndP: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,posP,0.0));if (!pairN) 
{lumaNN=lumaSS;}
var gradientScaled: f32=gradient*1.0/4.0;var lumaMM: f32=lumaM-lumaNN*0.5;var subpixF: f32=subpixD*subpixE;var lumaMLTZero: bool=lumaMM<0.0;lumaEndN-=lumaNN*0.5;lumaEndP-=lumaNN*0.5;var doneN: bool=abs(lumaEndN)>=gradientScaled;var doneP: bool=abs(lumaEndP)>=gradientScaled;if (!doneN) 
{posN.x-=offNP.x*3.0;}
if (!doneN) 
{posN.y-=offNP.y*3.0;}
var doneNP: bool=(!doneN) || (!doneP);if (!doneP) 
{posP.x+=offNP.x*3.0;}
if (!doneP)
{posP.y+=offNP.y*3.0;}
if (doneNP)
{if (!doneN) {lumaEndN=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,posN.xy,0.0));}
if (!doneP) {lumaEndP=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,posP.xy,0.0));}
if (!doneN) {lumaEndN=lumaEndN-lumaNN*0.5;}
if (!doneP) {lumaEndP=lumaEndP-lumaNN*0.5;}
doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if (!doneN) {posN.x-=offNP.x*12.0;}
if (!doneN) {posN.y-=offNP.y*12.0;}
doneNP=(!doneN) || (!doneP);if (!doneP) {posP.x+=offNP.x*12.0;}
if (!doneP) {posP.y+=offNP.y*12.0;}}
var dstN: f32=posM.x-posN.x;var dstP: f32=posP.x-posM.x;if (!horzSpan)
{dstN=posM.y-posN.y;}
if (!horzSpan) 
{dstP=posP.y-posM.y;}
var goodSpanN: bool=(lumaEndN<0.0) != lumaMLTZero;var spanLength: f32=(dstP+dstN);var goodSpanP: bool=(lumaEndP<0.0) != lumaMLTZero;var spanLengthRcp: f32=1.0/spanLength;var directionN: bool=dstN<dstP;var dst: f32=min(dstN,dstP);var goodSpan: bool=select(goodSpanP,goodSpanN,directionN);var subpixG: f32=subpixF*subpixF;var pixelOffset: f32=(dst*(-spanLengthRcp))+0.5;var subpixH: f32=subpixG*fxaaQualitySubpix;var pixelOffsetGood: f32=select(0.0,pixelOffset,goodSpan);var pixelOffsetSubpix: f32=max(pixelOffsetGood,subpixH);if (!horzSpan)
{posM.x+=pixelOffsetSubpix*lengthSign;}
if (horzSpan)
{posM.y+=pixelOffsetSubpix*lengthSign;}
#ifdef MALI
if(range<rangeMaxClamped) 
{fragmentOutputs.color=rgbyM;}
else
{fragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,posM,0.0);}
#else
fragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,posM,0.0);
#endif
}`;S.ShadersStoreWGSL[up]||(S.ShadersStoreWGSL[up]=GP);const NX={name:up,shader:GP},DX=Object.freeze(Object.defineProperty({__proto__:null,fxaaPixelShaderWGSL:NX},Symbol.toStringTag,{value:"Module"})),hp="fxaaVertexShader",zP=`attribute position: vec2f;uniform texelSize: vec2f;varying vUV: vec2f;varying sampleCoordS: vec2f;varying sampleCoordE: vec2f;varying sampleCoordN: vec2f;varying sampleCoordW: vec2f;varying sampleCoordNW: vec2f;varying sampleCoordSE: vec2f;varying sampleCoordNE: vec2f;varying sampleCoordSW: vec2f;const madd: vec2f= vec2f(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
vertexOutputs.vUV=(input.position*madd+madd);vertexOutputs.sampleCoordS=vertexOutputs.vUV+ vec2f( 0.0,1.0)*uniforms.texelSize;vertexOutputs.sampleCoordE=vertexOutputs.vUV+ vec2f( 1.0,0.0)*uniforms.texelSize;vertexOutputs.sampleCoordN=vertexOutputs.vUV+ vec2f( 0.0,-1.0)*uniforms.texelSize;vertexOutputs.sampleCoordW=vertexOutputs.vUV+ vec2f(-1.0,0.0)*uniforms.texelSize;vertexOutputs.sampleCoordNW=vertexOutputs.vUV+ vec2f(-1.0,-1.0)*uniforms.texelSize;vertexOutputs.sampleCoordSE=vertexOutputs.vUV+ vec2f( 1.0,1.0)*uniforms.texelSize;vertexOutputs.sampleCoordNE=vertexOutputs.vUV+ vec2f( 1.0,-1.0)*uniforms.texelSize;vertexOutputs.sampleCoordSW=vertexOutputs.vUV+ vec2f(-1.0,1.0)*uniforms.texelSize;vertexOutputs.position=vec4f(input.position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;S.ShadersStoreWGSL[hp]||(S.ShadersStoreWGSL[hp]=zP);const MX={name:hp,shader:zP},FX=Object.freeze(Object.defineProperty({__proto__:null,fxaaVertexShaderWGSL:MX},Symbol.toStringTag,{value:"Module"})),dp="blackAndWhitePixelShader",WP=`varying vec2 vUV;uniform sampler2D textureSampler;uniform float degree;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{vec3 color=texture2D(textureSampler,vUV).rgb;float luminance=dot(color,vec3(0.3,0.59,0.11)); 
vec3 blackAndWhite=vec3(luminance,luminance,luminance);gl_FragColor=vec4(color-((color-blackAndWhite)*degree),1.0);}`;S.ShadersStore[dp]||(S.ShadersStore[dp]=WP);const LX={name:dp,shader:WP},wX=Object.freeze(Object.defineProperty({__proto__:null,blackAndWhitePixelShader:LX},Symbol.toStringTag,{value:"Module"})),fp="blackAndWhitePixelShader",HP=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform degree: f32;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var color: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;var luminance: f32=dot(color, vec3f(0.3,0.59,0.11)); 
var blackAndWhite: vec3f= vec3f(luminance,luminance,luminance);fragmentOutputs.color= vec4f(color-((color-blackAndWhite)*uniforms.degree),1.0);}`;S.ShadersStoreWGSL[fp]||(S.ShadersStoreWGSL[fp]=HP);const BX={name:fp,shader:HP},VX=Object.freeze(Object.defineProperty({__proto__:null,blackAndWhitePixelShaderWGSL:BX},Symbol.toStringTag,{value:"Module"})),pp="anaglyphPixelShader",$P=`varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D leftSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec4 leftFrag=texture2D(leftSampler,vUV);leftFrag=vec4(1.0,leftFrag.g,leftFrag.b,1.0);vec4 rightFrag=texture2D(textureSampler,vUV);rightFrag=vec4(rightFrag.r,1.0,1.0,1.0);gl_FragColor=vec4(rightFrag.rgb*leftFrag.rgb,1.0);}`;S.ShadersStore[pp]||(S.ShadersStore[pp]=$P);const UX={name:pp,shader:$P},kX=Object.freeze(Object.defineProperty({__proto__:null,anaglyphPixelShader:UX},Symbol.toStringTag,{value:"Module"})),mp="anaglyphPixelShader",XP=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var leftSamplerSampler: sampler;var leftSampler: texture_2d<f32>;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var leftFrag: vec4f=textureSample(leftSampler,leftSamplerSampler,input.vUV);leftFrag= vec4f(1.0,leftFrag.g,leftFrag.b,1.0);var rightFrag: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);rightFrag= vec4f(rightFrag.r,1.0,1.0,1.0);fragmentOutputs.color= vec4f(rightFrag.rgb*leftFrag.rgb,1.0);}`;S.ShadersStoreWGSL[mp]||(S.ShadersStoreWGSL[mp]=XP);const GX={name:mp,shader:XP},zX=Object.freeze(Object.defineProperty({__proto__:null,anaglyphPixelShaderWGSL:GX},Symbol.toStringTag,{value:"Module"})),_p="convolutionPixelShader",YP=`varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform float kernel[9];
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec2 onePixel=vec2(1.0,1.0)/screenSize;vec4 colorSum =
texture2D(textureSampler,vUV+onePixel*vec2(-1,-1))*kernel[0] +
texture2D(textureSampler,vUV+onePixel*vec2(0,-1))*kernel[1] +
texture2D(textureSampler,vUV+onePixel*vec2(1,-1))*kernel[2] +
texture2D(textureSampler,vUV+onePixel*vec2(-1,0))*kernel[3] +
texture2D(textureSampler,vUV+onePixel*vec2(0,0))*kernel[4] +
texture2D(textureSampler,vUV+onePixel*vec2(1,0))*kernel[5] +
texture2D(textureSampler,vUV+onePixel*vec2(-1,1))*kernel[6] +
texture2D(textureSampler,vUV+onePixel*vec2(0,1))*kernel[7] +
texture2D(textureSampler,vUV+onePixel*vec2(1,1))*kernel[8];float kernelWeight =
kernel[0] +
kernel[1] +
kernel[2] +
kernel[3] +
kernel[4] +
kernel[5] +
kernel[6] +
kernel[7] +
kernel[8];if (kernelWeight<=0.0) {kernelWeight=1.0;}
gl_FragColor=vec4((colorSum/kernelWeight).rgb,1);}`;S.ShadersStore[_p]||(S.ShadersStore[_p]=YP);const WX={name:_p,shader:YP},HX=Object.freeze(Object.defineProperty({__proto__:null,convolutionPixelShader:WX},Symbol.toStringTag,{value:"Module"})),gp="convolutionPixelShader",jP=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform screenSize: vec2f;uniform kernel: array<f32,9>;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var onePixel: vec2f= vec2f(1.0,1.0)/uniforms.screenSize;var colorSum: vec4f =
textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(-1,-1))*uniforms.kernel[0] +
textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(0,-1))*uniforms.kernel[1] +
textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(1,-1))*uniforms.kernel[2] +
textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(-1,0))*uniforms.kernel[3] +
textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(0,0))*uniforms.kernel[4] +
textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(1,0))*uniforms.kernel[5] +
textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(-1,1))*uniforms.kernel[6] +
textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(0,1))*uniforms.kernel[7] +
textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(1,1))*uniforms.kernel[8];var kernelWeight: f32 =
uniforms.kernel[0] +
uniforms.kernel[1] +
uniforms.kernel[2] +
uniforms.kernel[3] +
uniforms.kernel[4] +
uniforms.kernel[5] +
uniforms.kernel[6] +
uniforms.kernel[7] +
uniforms.kernel[8];if (kernelWeight<=0.0) {kernelWeight=1.0;}
fragmentOutputs.color= vec4f((colorSum/kernelWeight).rgb,1);}`;S.ShadersStoreWGSL[gp]||(S.ShadersStoreWGSL[gp]=jP);const $X={name:gp,shader:jP},XX=Object.freeze(Object.defineProperty({__proto__:null,convolutionPixelShaderWGSL:$X},Symbol.toStringTag,{value:"Module"})),Sp="colorCorrectionPixelShader",qP=`uniform sampler2D textureSampler; 
uniform sampler2D colorTable; 
varying vec2 vUV;const float SLICE_COUNT=16.0; 
#define inline
vec4 sampleAs3DTexture(sampler2D textureSampler,vec3 uv,float width) {float sliceSize=1.0/width; 
float slicePixelSize=sliceSize/width; 
float sliceInnerSize=slicePixelSize*(width-1.0); 
float zSlice0=min(floor(uv.z*width),width-1.0);float zSlice1=min(zSlice0+1.0,width-1.0);float xOffset=slicePixelSize*0.5+uv.x*sliceInnerSize;float s0=xOffset+(zSlice0*sliceSize);float s1=xOffset+(zSlice1*sliceSize);vec4 slice0Color=texture2D(textureSampler,vec2(s0,uv.y));vec4 slice1Color=texture2D(textureSampler,vec2(s1,uv.y));float zOffset=mod(uv.z*width,1.0);vec4 result=mix(slice0Color,slice1Color,zOffset);return result;}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec4 screen_color=texture2D(textureSampler,vUV);gl_FragColor=sampleAs3DTexture(colorTable,screen_color.rgb,SLICE_COUNT);}`;S.ShadersStore[Sp]||(S.ShadersStore[Sp]=qP);const YX={name:Sp,shader:qP},jX=Object.freeze(Object.defineProperty({__proto__:null,colorCorrectionPixelShader:YX},Symbol.toStringTag,{value:"Module"})),vp="colorCorrectionPixelShader",ZP=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;varying vUV: vec2f;var colorTableSampler: sampler;var colorTable: texture_2d<f32>;const SLICE_COUNT: f32=16.0; 
fn sampleAs3DTexture(uv: vec3f,width: f32)->vec4f {var sliceSize: f32=1.0/width; 
var slicePixelSize: f32=sliceSize/width; 
var sliceInnerSize: f32=slicePixelSize*(width-1.0); 
var zSlice0: f32=min(floor(uv.z*width),width-1.0);var zSlice1: f32=min(zSlice0+1.0,width-1.0);var xOffset: f32=slicePixelSize*0.5+uv.x*sliceInnerSize;var s0: f32=xOffset+(zSlice0*sliceSize);var s1: f32=xOffset+(zSlice1*sliceSize);var slice0Color: vec4f=textureSample(colorTable,colorTableSampler,vec2f(s0,uv.y));var slice1Color: vec4f=textureSample(colorTable,colorTableSampler,vec2f(s1,uv.y));var zOffset: f32=((uv.z*width)%(1.0));return mix(slice0Color,slice1Color,zOffset);}
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var screen_color: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);fragmentOutputs.color=sampleAs3DTexture(screen_color.rgb,SLICE_COUNT);}`;S.ShadersStoreWGSL[vp]||(S.ShadersStoreWGSL[vp]=ZP);const qX={name:vp,shader:ZP},ZX=Object.freeze(Object.defineProperty({__proto__:null,colorCorrectionPixelShaderWGSL:qX},Symbol.toStringTag,{value:"Module"})),xp="motionBlurPixelShader",QP=`varying vec2 vUV;uniform sampler2D textureSampler;uniform float motionStrength;uniform float motionScale;uniform vec2 screenSize;
#ifdef OBJECT_BASED
uniform sampler2D velocitySampler;
#else
uniform sampler2D depthSampler;uniform mat4 inverseViewProjection;uniform mat4 prevViewProjection;uniform mat4 projection;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#ifdef GEOMETRY_SUPPORTED
#ifdef OBJECT_BASED
vec2 texelSize=1.0/screenSize;vec4 velocityColor=textureLod(velocitySampler,vUV,0.0);velocityColor.rg=velocityColor.rg*2.0-vec2(1.0);vec2 signs=sign(velocityColor.rg);vec2 velocity=pow(abs(velocityColor.rg),vec2(3.0))*signs*velocityColor.a;velocity*=motionScale*motionStrength;float speed=length(velocity/texelSize);int samplesCount=int(clamp(speed,1.0,SAMPLES));velocity=normalize(velocity)*texelSize;float hlim=float(-samplesCount)*0.5+0.5;vec4 result=textureLod(textureSampler,vUV,0.0);for (int i=1; i<int(SAMPLES); ++i)
{if (i>=samplesCount)
break;vec2 offset=vUV+velocity*(hlim+float(i));result+=textureLod(textureSampler,offset,0.0);}
gl_FragColor=result/float(samplesCount);gl_FragColor.a=1.0;
#else
vec4 result=textureLod(textureSampler,vUV,0.0);vec2 texelSize=1.0/screenSize;float depth=textureLod(depthSampler,vUV,0.0).r;if (depth==0.0) {gl_FragColor=result;return;}
depth=projection[2].z+projection[3].z/depth; 
vec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);cpos=inverseViewProjection*cpos;cpos/=cpos.w;vec4 ppos=prevViewProjection*cpos;ppos/=ppos.w;ppos.xy=ppos.xy*0.5+0.5;vec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;float speed=length(velocity/texelSize);int nSamples=int(clamp(speed,1.0,SAMPLES));for (int i=1; i<int(SAMPLES); ++i) {if (i>=nSamples)
break;vec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);result+=textureLod(textureSampler,offset1,0.0);}
gl_FragColor=result/float(nSamples);
#endif
#else
gl_FragColor=texture2D(textureSampler,vUV);
#endif
}
`;S.ShadersStore[xp]||(S.ShadersStore[xp]=QP);const QX={name:xp,shader:QP},KX=Object.freeze(Object.defineProperty({__proto__:null,motionBlurPixelShader:QX},Symbol.toStringTag,{value:"Module"})),Ep="motionBlurPixelShader",KP=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform motionStrength: f32;uniform motionScale: f32;uniform screenSize: vec2f;
#ifdef OBJECT_BASED
var velocitySamplerSampler: sampler;var velocitySampler: texture_2d<f32>;
#else
var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;uniform inverseViewProjection: mat4x4f;uniform prevViewProjection: mat4x4f;uniform projection: mat4x4f;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#ifdef GEOMETRY_SUPPORTED
#ifdef OBJECT_BASED
var texelSize: vec2f=1.0/uniforms.screenSize;var velocityColor: vec4f=textureSampleLevel(velocitySampler,velocitySamplerSampler,input.vUV,0.0);velocityColor=vec4f(velocityColor.rg*2.0- vec2f(1.0),velocityColor.b,velocityColor.a);let signs=sign(velocityColor.rg);var velocity=pow(abs(velocityColor.rg),vec2f(3.0))*signs*velocityColor.a;velocity*=uniforms.motionScale*uniforms.motionStrength;var speed: f32=length(velocity/texelSize);var samplesCount: i32= i32(clamp(speed,1.0,SAMPLES));velocity=normalize(velocity)*texelSize;var hlim: f32= f32(-samplesCount)*0.5+0.5;var result: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler, input.vUV,0.0);for (var i: i32=1; i< i32(SAMPLES); i++)
{if (i>=samplesCount) {break;}
var offset: vec2f=input.vUV+velocity*(hlim+ f32(i));result+=textureSampleLevel(textureSampler,textureSamplerSampler, offset,0.0);}
fragmentOutputs.color=vec4f(result.rgb/ f32(samplesCount),1.0);
#else
var result: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler, input.vUV,0.0);var texelSize: vec2f=1.0/uniforms.screenSize;var depth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV,0.0).r;if (depth==0.0) {fragmentOutputs.color=result;return fragmentOutputs;}
depth=uniforms.projection[2].z+uniforms.projection[3].z/depth; 
var cpos: vec4f= vec4f(input.vUV*2.0-1.0,depth,1.0);cpos=uniforms.inverseViewProjection*cpos;cpos/=cpos.w;var ppos: vec4f=uniforms.prevViewProjection*cpos;ppos/=ppos.w;ppos=vec4f(ppos.xy*0.5+0.5,ppos.zw);var velocity: vec2f=(ppos.xy-input.vUV)*uniforms.motionScale*uniforms.motionStrength;var speed: f32=length(velocity/texelSize);var nSamples: i32= i32(clamp(speed,1.0,SAMPLES));for (var i: i32=1; i< i32(SAMPLES); i++) {if (i>=nSamples) {break;}
var offset1: vec2f=input.vUV+velocity*( f32(i)/ f32(nSamples-1)-0.5);result+=textureSampleLevel(textureSampler,textureSamplerSampler, offset1,0.0);}
fragmentOutputs.color=result/ f32(nSamples);
#endif
#else
fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler, input.vUV);
#endif
}
`;S.ShadersStoreWGSL[Ep]||(S.ShadersStoreWGSL[Ep]=KP);const JX={name:Ep,shader:KP},e5=Object.freeze(Object.defineProperty({__proto__:null,motionBlurPixelShaderWGSL:JX},Symbol.toStringTag,{value:"Module"})),Tp="filterPixelShader",JP=`varying vec2 vUV;uniform sampler2D textureSampler;uniform mat4 kernelMatrix;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec3 baseColor=texture2D(textureSampler,vUV).rgb;vec3 updatedColor=(kernelMatrix*vec4(baseColor,1.0)).rgb;gl_FragColor=vec4(updatedColor,1.0);}`;S.ShadersStore[Tp]||(S.ShadersStore[Tp]=JP);const t5={name:Tp,shader:JP},i5=Object.freeze(Object.defineProperty({__proto__:null,filterPixelShader:t5},Symbol.toStringTag,{value:"Module"})),bp="filterPixelShader",eO=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform kernelMatrix: mat4x4f;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var baseColor: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;var updatedColor: vec3f=(uniforms.kernelMatrix* vec4f(baseColor,1.0)).rgb;fragmentOutputs.color= vec4f(updatedColor,1.0);}`;S.ShadersStoreWGSL[bp]||(S.ShadersStoreWGSL[bp]=eO);const r5={name:bp,shader:eO},s5=Object.freeze(Object.defineProperty({__proto__:null,filterPixelShaderWGSL:r5},Symbol.toStringTag,{value:"Module"})),aC="highlightsPixelShader",n5=`varying vec2 vUV;uniform sampler2D textureSampler;const vec3 RGBLuminanceCoefficients=vec3(0.2126,0.7152,0.0722);
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{vec4 tex=texture2D(textureSampler,vUV);vec3 c=tex.rgb;float luma=dot(c.rgb,RGBLuminanceCoefficients);gl_FragColor=vec4(pow(c,vec3(25.0-luma*15.0)),tex.a); }`;S.ShadersStore[aC]||(S.ShadersStore[aC]=n5);const oC="highlightsPixelShader",a5=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;const RGBLuminanceCoefficients: vec3f= vec3f(0.2126,0.7152,0.0722);
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var tex: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);var c: vec3f=tex.rgb;var luma: f32=dot(c.rgb,RGBLuminanceCoefficients);fragmentOutputs.color= vec4f(pow(c, vec3f(25.0-luma*15.0)),tex.a); }`;S.ShadersStoreWGSL[oC]||(S.ShadersStoreWGSL[oC]=a5);const Cp="displayPassPixelShader",tO=`varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D passSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{gl_FragColor=texture2D(passSampler,vUV);}`;S.ShadersStore[Cp]||(S.ShadersStore[Cp]=tO);const o5={name:Cp,shader:tO},l5=Object.freeze(Object.defineProperty({__proto__:null,displayPassPixelShader:o5},Symbol.toStringTag,{value:"Module"})),yp="displayPassPixelShader",iO=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var passSamplerSampler: sampler;var passSampler: texture_2d<f32>;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(passSampler,passSamplerSampler,input.vUV);}`;S.ShadersStoreWGSL[yp]||(S.ShadersStoreWGSL[yp]=iO);const c5={name:yp,shader:iO},u5=Object.freeze(Object.defineProperty({__proto__:null,displayPassPixelShaderWGSL:c5},Symbol.toStringTag,{value:"Module"})),Ip="tonemapPixelShader",rO=`varying vec2 vUV;uniform sampler2D textureSampler;uniform float _ExposureAdjustment;
#if defined(HABLE_TONEMAPPING)
const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;const float W=11.2;
#endif
float Luminance(vec3 c)
{return dot(c,vec3(0.22,0.707,0.071));}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{vec3 colour=texture2D(textureSampler,vUV).rgb;
#if defined(REINHARD_TONEMAPPING)
float lum=Luminance(colour.rgb); 
float lumTm=lum*_ExposureAdjustment;float scale=lumTm/(1.0+lumTm); 
colour*=scale/lum;
#elif defined(HABLE_TONEMAPPING)
colour*=_ExposureAdjustment;const float ExposureBias=2.0;vec3 x=ExposureBias*colour;vec3 curr=((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;x=vec3(W,W,W);vec3 whiteScale=1.0/(((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F);colour=curr*whiteScale;
#elif defined(OPTIMIZED_HEJIDAWSON_TONEMAPPING)
colour*=_ExposureAdjustment;vec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);vec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);colour=retColor*retColor;
#elif defined(PHOTOGRAPHIC_TONEMAPPING)
colour= vec3(1.0,1.0,1.0)-exp2(-_ExposureAdjustment*colour);
#endif
gl_FragColor=vec4(colour.rgb,1.0);}`;S.ShadersStore[Ip]||(S.ShadersStore[Ip]=rO);const h5={name:Ip,shader:rO},d5=Object.freeze(Object.defineProperty({__proto__:null,tonemapPixelShader:h5},Symbol.toStringTag,{value:"Module"})),Rp="tonemapPixelShader",sO=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform _ExposureAdjustment: f32;
#if defined(HABLE_TONEMAPPING)
const A: f32=0.15;const B: f32=0.50;const C: f32=0.10;const D: f32=0.20;const E: f32=0.02;const F: f32=0.30;const W: f32=11.2;
#endif
fn Luminance(c: vec3f)->f32
{return dot(c, vec3f(0.22,0.707,0.071));}
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var colour: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;
#if defined(REINHARD_TONEMAPPING)
var lum: f32=Luminance(colour.rgb); 
var lumTm: f32=lum*uniforms._ExposureAdjustment;var scale: f32=lumTm/(1.0+lumTm); 
colour*=scale/lum;
#elif defined(HABLE_TONEMAPPING)
colour*=uniforms._ExposureAdjustment;const ExposureBias: f32=2.0;var x: vec3f=ExposureBias*colour;var curr: vec3f=((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;x= vec3f(W,W,W);var whiteScale: vec3f=1.0/(((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F);colour=curr*whiteScale;
#elif defined(OPTIMIZED_HEJIDAWSON_TONEMAPPING)
colour*=uniforms._ExposureAdjustment;var X: vec3f=max( vec3f(0.0,0.0,0.0),colour-0.004);var retColor: vec3f=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);colour=retColor*retColor;
#elif defined(PHOTOGRAPHIC_TONEMAPPING)
colour= vec3f(1.0,1.0,1.0)-exp2(-uniforms._ExposureAdjustment*colour);
#endif
fragmentOutputs.color= vec4f(colour.rgb,1.0);}`;S.ShadersStoreWGSL[Rp]||(S.ShadersStoreWGSL[Rp]=sO);const f5={name:Rp,shader:sO},p5=Object.freeze(Object.defineProperty({__proto__:null,tonemapPixelShaderWGSL:f5},Symbol.toStringTag,{value:"Module"}));Object.defineProperty(le.prototype,"forceShowBoundingBoxes",{get:function(){return this._forceShowBoundingBoxes||!1},set:function(s){this._forceShowBoundingBoxes=s,s&&this.getBoundingBoxRenderer()},enumerable:!0,configurable:!0});le.prototype.getBoundingBoxRenderer=function(){return this._boundingBoxRenderer||(this._boundingBoxRenderer=new g5(this)),this._boundingBoxRenderer};Object.defineProperty(Mt.prototype,"showBoundingBox",{get:function(){return this._showBoundingBox||!1},set:function(s){this._showBoundingBox=s,s&&this.getScene().getBoundingBoxRenderer()},enumerable:!0,configurable:!0});const nO=z.Identity(),fu=new x,m5=new x,_5=nO.asArray(),lC=new ud(fu,fu);class g5{get shaderLanguage(){return this._shaderLanguage}constructor(e){this.name=se.NAME_BOUNDINGBOXRENDERER,this.frontColor=new q(1,1,1),this.backColor=new q(.1,.1,.1),this.showBackLines=!0,this.onBeforeBoxRenderingObservable=new k,this.onAfterBoxRenderingObservable=new k,this.onResourcesReadyObservable=new k,this.enabled=!0,this._shaderLanguage=0,this.renderList=new Xn(32),this._vertexBuffers={},this._fillIndexBuffer=null,this._fillIndexData=null,this._matrixBuffer=null,this._matrices=null,this._useInstances=!1,this._drawWrapperFront=null,this._drawWrapperBack=null,this.scene=e,this.scene.getEngine().isWebGPU&&(this._shaderLanguage=1),e._addComponent(this),this._uniformBufferFront=new hn(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererFront",!0),this._buildUniformLayout(this._uniformBufferFront),this._uniformBufferBack=new hn(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererBack",!0),this._buildUniformLayout(this._uniformBufferBack)}_buildUniformLayout(e){e.addUniform("color",4),e.addUniform("world",16),e.addUniform("viewProjection",16),e.addUniform("viewProjectionR",16),e.create()}register(){this.scene._beforeEvaluateActiveMeshStage.registerStep(se.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER,this,this.reset),this.scene._preActiveMeshStage.registerStep(se.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER,this,this._preActiveMesh),this.scene._evaluateSubMeshStage.registerStep(se.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER,this,this._evaluateSubMesh),this.scene._afterRenderingGroupDrawStage.registerStep(se.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER,this,this.render)}async whenReadyAsync(e=16,t=3e4){return this._prepareResources(),await new Promise(i=>{Wn(()=>this._colorShader.isReady(),()=>{i()},(r,n)=>{n?(N.Error("BoundingBoxRenderer: Timeout while waiting for the renderer to be ready."),r&&N.Error(r)):(N.Error("BoundingBoxRenderer: An unexpected error occurred while waiting for the renderer to be ready."),r&&(N.Error(r),r.stack&&N.Error(r.stack)))},e,t)})}_evaluateSubMesh(e,t){if(e.showSubMeshesBoundingBox){const i=t.getBoundingInfo();i!=null&&(i.boundingBox._tag=e.renderingGroupId,this.renderList.push(i.boundingBox))}}_preActiveMesh(e){if(e.showBoundingBox||this.scene.forceShowBoundingBoxes){const t=e.getBoundingInfo();t.boundingBox._tag=e.renderingGroupId,this.renderList.push(t.boundingBox)}}_prepareResources(){if(this._colorShader)return;this._colorShader=new Ta("colorShader",this.scene,"boundingBoxRenderer",{attributes:[M.PositionKind,"world0","world1","world2","world3"],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{this._shaderLanguage===1?await Promise.all([U(()=>Promise.resolve().then(()=>BC),void 0),U(()=>Promise.resolve().then(()=>wC),void 0)]):await Promise.all([U(()=>Promise.resolve().then(()=>LC),void 0),U(()=>Promise.resolve().then(()=>MC),void 0)])}},!1),this._colorShader.setDefine("INSTANCES",this._useInstances),this._colorShader.doNotSerialize=!0,this._colorShader.reservedDataStore={hidden:!0},this._colorShaderForOcclusionQuery=new Ta("colorShaderOccQuery",this.scene,"boundingBoxRenderer",{attributes:[M.PositionKind],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{this._shaderLanguage===1?await Promise.all([U(()=>Promise.resolve().then(()=>BC),void 0),U(()=>Promise.resolve().then(()=>wC),void 0)]):await Promise.all([U(()=>Promise.resolve().then(()=>LC),void 0),U(()=>Promise.resolve().then(()=>MC),void 0)])}},!0),this._colorShaderForOcclusionQuery.doNotSerialize=!0,this._colorShaderForOcclusionQuery.reservedDataStore={hidden:!0};const e=this.scene.getEngine(),t=rM({size:1});this._vertexBuffers[M.PositionKind]=new M(e,t.positions,M.PositionKind,!1),this._createIndexBuffer(),this._fillIndexData=t.indices,this.onResourcesReadyObservable.notifyObservers(this)}_createIndexBuffer(){const e=this.scene.getEngine();this._indexBuffer=e.createIndexBuffer([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,7,1,6,2,5,3,4])}rebuild(){const e=this._vertexBuffers[M.PositionKind];e&&e._rebuild(),this._createIndexBuffer(),this._matrixBuffer&&this._matrixBuffer._rebuild()}reset(){this.renderList.reset()}render(e){if(this.renderList.length===0||!this.enabled)return;if(this._useInstances){this._renderInstanced(e);return}if(this._prepareResources(),!this._colorShader.isReady())return;const t=this.scene.getEngine();t.setDepthWrite(!1);const i=this.scene.getTransformMatrix();for(let r=0;r<this.renderList.length;r++){const n=this.renderList.data[r];if(n._tag!==e)continue;this._createWrappersForBoundingBox(n),this.onBeforeBoxRenderingObservable.notifyObservers(n);const a=n.minimum,l=n.maximum.subtract(a),c=a.add(l.scale(.5)),u=z.Scaling(l.x,l.y,l.z).multiply(z.Translation(c.x,c.y,c.z)).multiply(n.getWorldMatrix()),h=t.useReverseDepthBuffer;if(this.showBackLines){const f=n._drawWrapperBack??this._colorShader._getDrawWrapper();this._colorShader._preBind(f),t.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),h?t.setDepthFunctionToLessOrEqual():t.setDepthFunctionToGreaterOrEqual(),this._uniformBufferBack.bindToEffect(f.effect,"BoundingBoxRenderer"),this._uniformBufferBack.updateColor4("color",this.backColor,1),this._uniformBufferBack.updateMatrix("world",u),this._uniformBufferBack.updateMatrix("viewProjection",i),this._uniformBufferBack.update(),t.drawElementsType(Le.LineListDrawMode,0,24)}const d=n._drawWrapperFront??this._colorShader._getDrawWrapper();this._colorShader._preBind(d),t.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),h?t.setDepthFunctionToGreater():t.setDepthFunctionToLess(),this._uniformBufferFront.bindToEffect(d.effect,"BoundingBoxRenderer"),this._uniformBufferFront.updateColor4("color",this.frontColor,1),this._uniformBufferFront.updateMatrix("world",u),this._uniformBufferFront.updateMatrix("viewProjection",i),this._uniformBufferFront.update(),t.drawElementsType(Le.LineListDrawMode,0,24),this.onAfterBoxRenderingObservable.notifyObservers(n)}this._colorShader.unbind(),t.setDepthFunctionToLessOrEqual(),t.setDepthWrite(!0)}_createWrappersForBoundingBox(e){if(!e._drawWrapperFront){const t=this.scene.getEngine();e._drawWrapperFront=new gn(t),e._drawWrapperBack=new gn(t),e._drawWrapperFront.setEffect(this._colorShader.getEffect()),e._drawWrapperBack.setEffect(this._colorShader.getEffect())}}renderOcclusionBoundingBox(e){const t=this.scene.getEngine();this._renderPassIdForOcclusionQuery===void 0&&(this._renderPassIdForOcclusionQuery=t.createRenderPassId("Render pass for occlusion query"));const i=t.currentRenderPassId;t.currentRenderPassId=this._renderPassIdForOcclusionQuery,this._prepareResources();const r=e.subMeshes[0];if(!this._colorShaderForOcclusionQuery.isReady(e,void 0,r)||!e.hasBoundingInfo){t.currentRenderPassId=i;return}this._fillIndexBuffer||(this._fillIndexBuffer=t.createIndexBuffer(this._fillIndexData));const n=t.useReverseDepthBuffer;t.setDepthWrite(!1),t.setColorWrite(!1);const a=e.getBoundingInfo().boundingBox,o=a.minimum,c=a.maximum.subtract(o),u=o.add(c.scale(.5)),h=z.Scaling(c.x,c.y,c.z).multiply(z.Translation(u.x,u.y,u.z)).multiply(a.getWorldMatrix()),d=r._drawWrapper;this._colorShaderForOcclusionQuery._preBind(d),t.bindBuffers(this._vertexBuffers,this._fillIndexBuffer,d.effect),n?t.setDepthFunctionToGreater():t.setDepthFunctionToLess(),this.scene.resetCachedMaterial(),this._uniformBufferFront.bindToEffect(d.effect,"BoundingBoxRenderer"),this._uniformBufferFront.updateMatrix("world",h),this._uniformBufferFront.updateMatrix("viewProjection",this.scene.getTransformMatrix()),this._uniformBufferFront.update(),t.drawElementsType(Le.TriangleFillMode,0,36),this._colorShaderForOcclusionQuery.unbind(),t.setDepthFunctionToLessOrEqual(),t.setDepthWrite(!0),t.setColorWrite(!0),t.currentRenderPassId=i}set useInstances(e){this._useInstances=e,this._colorShader&&this._colorShader.setDefine("INSTANCES",e),e||this._cleanupInstances()}get useInstances(){return this._useInstances}_renderInstanced(e){if(this.renderList.length===0||!this.enabled||(this._prepareResources(),!this._colorShader.isReady()))return;const t=this._colorShader;let i=this._matrices;const r=this.renderList.length*16;(!i||i.length<r||i.length>r*2)&&(i=new Float32Array(r),this._matrices=i),this.onBeforeBoxRenderingObservable.notifyObservers(lC);let n=0;for(let m=0;m<this.renderList.length;m++){const g=this.renderList.data[m];if(g._tag!==e)continue;const v=g.minimum,T=g.maximum.subtractToRef(v,m5),C=v.addToRef(T.scaleToRef(.5,fu),fu),A=_5;A[0]=T._x,A[3]=C._x,A[5]=T._y,A[7]=C._y,A[10]=T._z,A[11]=C._z,nO.multiplyToArray(g.getWorldMatrix(),i,n*16),n++}const a=this.scene.getEngine(),o=a.getDepthFunction()??515,l=a.getDepthWrite();a.setDepthWrite(!1);const c=this._matrixBuffer;c!=null&&c.isUpdatable()&&c.getData()===i?c.update(i):this._createInstanceBuffer(i),this._createWrappersForBoundingBox(this);const u=a.useReverseDepthBuffer,h=this.scene.getTransformMatrix();if(this.showBackLines){const m=this._drawWrapperBack??t._getDrawWrapper();t._preBind(m),a.bindBuffers(this._vertexBuffers,this._indexBuffer,t.getEffect()),u?a.setDepthFunctionToLessOrEqual():a.setDepthFunctionToGreaterOrEqual();const g=this._uniformBufferBack;g.bindToEffect(m.effect,"BoundingBoxRenderer"),g.updateColor4("color",this.backColor,1),g.updateMatrix("viewProjection",h),g.update(),a.drawElementsType(Le.LineListDrawMode,0,24,n)}const d=t._getDrawWrapper();t._preBind(d),a.bindBuffers(this._vertexBuffers,this._indexBuffer,t.getEffect()),u?a.setDepthFunctionToGreater():a.setDepthFunctionToLess();const f=this._uniformBufferFront;f.bindToEffect(d.effect,"BoundingBoxRenderer"),f.updateColor4("color",this.frontColor,1),f.updateMatrix("viewProjection",h),f.update(),a.drawElementsType(Le.LineListDrawMode,0,24,n),this.onAfterBoxRenderingObservable.notifyObservers(lC),t.unbind(),a.setDepthFunction(o),a.setDepthWrite(l)}_createInstanceBuffer(e){const t=this._vertexBuffers;this._cleanupInstanceBuffer();const i=new gr(this.scene.getEngine(),e,!0,16,!1,!0);t.world0=i.createVertexBuffer("world0",0,4),t.world1=i.createVertexBuffer("world1",4,4),t.world2=i.createVertexBuffer("world2",8,4),t.world3=i.createVertexBuffer("world3",12,4),this._matrixBuffer=i}_cleanupInstanceBuffer(){const e=this._vertexBuffers;e.world0&&(e.world0.dispose(),delete e.world0),e.world1&&(e.world1.dispose(),delete e.world1),e.world2&&(e.world2.dispose(),delete e.world2),e.world3&&(e.world3.dispose(),delete e.world3),this._matrices=null,this._matrixBuffer&&(this._matrixBuffer.dispose(),this._matrixBuffer=null)}_cleanupInstances(){this._cleanupInstanceBuffer(),this._drawWrapperFront&&(this._drawWrapperFront.dispose(),this._drawWrapperFront=null),this._drawWrapperBack&&(this._drawWrapperBack.dispose(),this._drawWrapperBack=null)}dispose(){if(this._renderPassIdForOcclusionQuery!==void 0&&(this.scene.getEngine().releaseRenderPassId(this._renderPassIdForOcclusionQuery),this._renderPassIdForOcclusionQuery=void 0),!this._colorShader)return;this.onBeforeBoxRenderingObservable.clear(),this.onAfterBoxRenderingObservable.clear(),this.onResourcesReadyObservable.clear(),this.renderList.dispose(),this._colorShader.dispose(),this._colorShaderForOcclusionQuery.dispose(),this._uniformBufferFront.dispose(),this._uniformBufferBack.dispose();const e=this._vertexBuffers[M.PositionKind];e&&(e.dispose(),this._vertexBuffers[M.PositionKind]=null),this.scene.getEngine()._releaseBuffer(this._indexBuffer),this._fillIndexBuffer&&(this.scene.getEngine()._releaseBuffer(this._fillIndexBuffer),this._fillIndexBuffer=null),this._cleanupInstances()}}le.prototype.enableDepthRenderer=function(s,e=!1,t=!1,i=3,r=!1,n){if(s=s||this.activeCamera,!s)throw"No camera available to enable depth renderer";if(this._depthRenderer||(this._depthRenderer={}),!this._depthRenderer[s.id]){const a=!!this.getEngine().getCaps().textureFloatRender;let o=0;this.getEngine().getCaps().textureHalfFloatRender&&(!t||!a)?o=2:a?o=1:o=0,this._depthRenderer[s.id]=new Qm(this,o,s,e,i,r,void 0,n)}return this._depthRenderer[s.id]};le.prototype.disableDepthRenderer=function(s){s=s||this.activeCamera,!(!s||!this._depthRenderer||!this._depthRenderer[s.id])&&this._depthRenderer[s.id].dispose()};class S5{constructor(e){this.name=se.NAME_DEPTHRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(se.STEP_GATHERRENDERTARGETS_DEPTHRENDERER,this,this._gatherRenderTargets),this.scene._gatherActiveCameraRenderTargetsStage.registerStep(se.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER,this,this._gatherActiveCameraRenderTargets)}rebuild(){}dispose(){for(const e in this.scene._depthRenderer)this.scene._depthRenderer[e].dispose()}_gatherRenderTargets(e){if(this.scene._depthRenderer)for(const t in this.scene._depthRenderer){const i=this.scene._depthRenderer[t];i.enabled&&!i.useOnlyInActiveCamera&&e.push(i.getDepthMap())}}_gatherActiveCameraRenderTargets(e){if(this.scene._depthRenderer)for(const t in this.scene._depthRenderer){const i=this.scene._depthRenderer[t];i.enabled&&i.useOnlyInActiveCamera&&this.scene.activeCamera.id===t&&e.push(i.getDepthMap())}}}Qm._SceneComponentInitialization=s=>{let e=s._getComponent(se.NAME_DEPTHRENDERER);e||(e=new S5(s),s._addComponent(e))};class v5{constructor(){this.enabled=!0,this.name="depthPeeling",this.texturesRequired=[4]}}class un{get passCount(){return this._passCount}set passCount(e){this._passCount!==e&&(this._passCount=e,this._createRenderPassIds())}get useRenderPasses(){return this._useRenderPasses}set useRenderPasses(e){this._useRenderPasses!==e&&(this._useRenderPasses=e,this._createRenderPassIds())}addExcludedMesh(e){this._excludedMeshes.indexOf(e.uniqueId)===-1&&this._excludedMeshes.push(e.uniqueId)}removeExcludedMesh(e){const t=this._excludedMeshes.indexOf(e.uniqueId);t!==-1&&this._excludedMeshes.splice(t,1)}get shaderLanguage(){return this._shaderLanguage}constructor(e,t=5){if(this._thinTextures=[],this._currentPingPongState=0,this._layoutCacheFormat=[[!0],[!0,!0],[!0,!0,!0]],this._layoutCache=[],this._candidateSubMeshes=new Xn(10),this._excludedSubMeshes=new Xn(10),this._excludedMeshes=[],this._colorCache=[new Te(un._DEPTH_CLEAR_VALUE,un._DEPTH_CLEAR_VALUE,0,0),new Te(-un._MIN_DEPTH,un._MAX_DEPTH,0,0),new Te(0,0,0,0)],this._shaderLanguage=0,this._scene=e,this._engine=e.getEngine(),this._passCount=t,!e.enablePrePassRenderer()){N.Warn("Depth peeling for order independant transparency could not enable PrePass, aborting.");return}for(let i=0;i<this._layoutCacheFormat.length;++i)this._layoutCache[i]=this._engine.buildTextureLayout(this._layoutCacheFormat[i]);this._renderPassIds=[],this.useRenderPasses=!1,this._engine.isWebGPU&&(this._shaderLanguage=1),this._prePassEffectConfiguration=new v5,this._createTextures(),this._createEffects()}_createRenderPassIds(){if(this._releaseRenderPassIds(),this._useRenderPasses)for(let e=0;e<this._passCount+1;++e)this._renderPassIds[e]||(this._renderPassIds[e]=this._engine.createRenderPassId(`DepthPeelingRenderer - pass #${e}`))}_releaseRenderPassIds(){for(let e=0;e<this._renderPassIds.length;++e)this._engine.releaseRenderPassId(this._renderPassIds[e]);this._renderPassIds=[]}_createTextures(){const e={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()};this._depthMrts=[new da("depthPeelingDepth0MRT",e,3,this._scene,void 0,["depthPeelingDepth0MRT_depth","depthPeelingDepth0MRT_frontColor","depthPeelingDepth0MRT_backColor"]),new da("depthPeelingDepth1MRT",e,3,this._scene,void 0,["depthPeelingDepth1MRT_depth","depthPeelingDepth1MRT_frontColor","depthPeelingDepth1MRT_backColor"])],this._colorMrts=[new da("depthPeelingColor0MRT",e,2,this._scene,{generateDepthBuffer:!1},["depthPeelingColor0MRT_frontColor","depthPeelingColor0MRT_backColor"]),new da("depthPeelingColor1MRT",e,2,this._scene,{generateDepthBuffer:!1},["depthPeelingColor1MRT_frontColor","depthPeelingColor1MRT_backColor"])],this._blendBackMrt=new da("depthPeelingBackMRT",e,1,this._scene,{generateDepthBuffer:!1},["depthPeelingBackMRT_blendBack"]),this._outputRT=new Zi("depthPeelingOutputRTT",e,this._scene,!1);const t=[{format:7,samplingMode:1,type:this._engine.getCaps().textureFloatLinearFiltering?1:2,label:"DepthPeelingRenderer-DepthTexture"},{format:5,samplingMode:1,type:2,label:"DepthPeelingRenderer-ColorTexture"}];for(let i=0;i<2;i++){const r=this._engine._createInternalTexture(e,t[0],!1),n=this._engine._createInternalTexture(e,t[1],!1),a=this._engine._createInternalTexture(e,t[1],!1);this._depthMrts[i].setInternalTexture(r,0),this._depthMrts[i].setInternalTexture(n,1),this._depthMrts[i].setInternalTexture(a,2),this._colorMrts[i].setInternalTexture(n,0),this._colorMrts[i].setInternalTexture(a,1),this._thinTextures.push(new xc(r),new xc(n),new xc(a))}}_disposeTextures(){for(let e=0;e<this._thinTextures.length;e++)e!==6&&this._thinTextures[e].dispose();for(let e=0;e<2;e++)this._depthMrts[e].dispose(!0),this._colorMrts[e].dispose(!0),this._blendBackMrt.dispose(!0);this._outputRT.dispose(),this._thinTextures=[],this._colorMrts=[],this._depthMrts=[]}_updateTextures(){return(this._depthMrts[0].getSize().width!==this._engine.getRenderWidth()||this._depthMrts[0].getSize().height!==this._engine.getRenderHeight())&&(this._disposeTextures(),this._createTextures()),this._updateTextureReferences()}_updateTextureReferences(){var r;const e=this._scene.prePassRenderer;if(!e)return!1;const t=e.getIndex(4),i=(r=e.defaultRT.textures)!=null&&r.length?e.defaultRT.textures[t].getInternalTexture():null;return i?(this._blendBackTexture!==i&&(this._blendBackTexture=i,this._blendBackMrt.setInternalTexture(this._blendBackTexture,0),this._thinTextures[6]&&this._thinTextures[6].dispose(),this._thinTextures[6]=new xc(this._blendBackTexture),e.defaultRT.renderTarget.shareDepth(this._depthMrts[0].renderTarget)),!0):!1}_createEffects(){this._blendBackEffectWrapper=new gt({fragmentShader:"oitBackBlend",useShaderStore:!0,engine:this._engine,samplerNames:["uBackColor"],uniformNames:[],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{this._shaderLanguage===1?await U(()=>Promise.resolve().then(()=>gy),void 0):await U(()=>Promise.resolve().then(()=>_y),void 0)}}),this._blendBackEffectWrapperPingPong=new gt({fragmentShader:"oitBackBlend",useShaderStore:!0,engine:this._engine,samplerNames:["uBackColor"],uniformNames:[],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{this._shaderLanguage===1?await U(()=>Promise.resolve().then(()=>gy),void 0):await U(()=>Promise.resolve().then(()=>_y),void 0)}}),this._finalEffectWrapper=new gt({fragmentShader:"oitFinal",useShaderStore:!0,engine:this._engine,samplerNames:["uFrontColor","uBackColor"],uniformNames:[],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{this._shaderLanguage===1?await U(()=>Promise.resolve().then(()=>o6),void 0):await U(()=>Promise.resolve().then(()=>s6),void 0)}}),this._effectRenderer=new go(this._engine)}setPrePassRenderer(e){e.addEffectConfiguration(this._prePassEffectConfiguration)}bind(e){e.setTexture("oitDepthSampler",this._thinTextures[this._currentPingPongState*3]),e.setTexture("oitFrontColorSampler",this._thinTextures[this._currentPingPongState*3+1])}_renderSubMeshes(e){let t;this._useRenderPasses&&(t={});for(let i=0;i<e.length;i++){const r=e.data[i].getMaterial();let n=!0,a=!1;const o=e.data[i];let l,c=!1;if(this._useRenderPasses&&(l=o._getDrawWrapper(),c=!l),r&&(n=r.allowShaderHotSwapping,a=r.backFaceCulling,r.allowShaderHotSwapping=!1,r.backFaceCulling=!1),o.render(!1),c&&(l=o._getDrawWrapper(),l.materialContext)){let u=t[l.materialContext.uniqueId];u||(u=t[l.materialContext.uniqueId]=this._engine.createMaterialContext()),o._getDrawWrapper().materialContext=u}r&&(r.allowShaderHotSwapping=n,r.backFaceCulling=a)}}_finalCompose(e){var i;((i=this._scene.prePassRenderer)==null?void 0:i.setCustomOutput(this._outputRT))?this._engine.bindFramebuffer(this._outputRT.renderTarget):this._engine.restoreDefaultFramebuffer(),this._engine.setAlphaMode(0),this._engine.applyStates(),this._engine.enableEffect(this._finalEffectWrapper.drawWrapper),this._finalEffectWrapper.effect.setTexture("uFrontColor",this._thinTextures[e*3+1]),this._finalEffectWrapper.effect.setTexture("uBackColor",this._thinTextures[6]),this._effectRenderer.render(this._finalEffectWrapper)}isReady(){return this._blendBackEffectWrapper.effect.isReady()&&this._blendBackEffectWrapperPingPong.effect.isReady()&&this._finalEffectWrapper.effect.isReady()&&this._updateTextures()}render(e){if(this._candidateSubMeshes.length=0,this._excludedSubMeshes.length=0,!this.isReady())return this._excludedSubMeshes;this._scene.activeCamera&&this._engine.setViewport(this._scene.activeCamera.viewport);for(let n=0;n<e.length;n++){const a=e.data[n],o=a.getMaterial(),l=o&&a.getRenderingMesh()._getRenderingFillMode(o.fillMode);o&&(l===Le.TriangleFanDrawMode||l===Le.TriangleFillMode||l===Le.TriangleStripDrawMode)&&this._excludedMeshes.indexOf(a.getMesh().uniqueId)===-1?this._candidateSubMeshes.push(a):this._excludedSubMeshes.push(a)}if(!this._candidateSubMeshes.length)return this._engine.bindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[1].renderTarget),this._finalCompose(1),this._excludedSubMeshes;const t=this._engine.currentRenderPassId;this._scene.prePassRenderer._enabled=!1,this._useRenderPasses&&(this._engine.currentRenderPassId=this._renderPassIds[0]),this._engine.bindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[0],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindFramebuffer(this._depthMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[1],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[1].renderTarget),this._engine.bindFramebuffer(this._colorMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[0].renderTarget),this._engine.bindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.setAlphaMode(11),this._engine.setAlphaEquation(3),this._engine.depthCullingState.depthMask=!1,this._engine.depthCullingState.depthTest=!0,this._engine.applyStates(),this._currentPingPongState=1,this._renderSubMeshes(this._candidateSubMeshes),this._engine.unBindFramebuffer(this._depthMrts[0].renderTarget),this._scene.resetCachedMaterial();let i=0,r=0;for(let n=0;n<this._passCount;n++){i=n%2,r=1-i,this._currentPingPongState=i,this._useRenderPasses&&(this._engine.currentRenderPassId=this._renderPassIds[n+1]),this._scene.activeCamera&&this._engine.setViewport(this._scene.activeCamera.viewport),this._engine.bindFramebuffer(this._depthMrts[r].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[0],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[r].renderTarget),this._engine.bindFramebuffer(this._colorMrts[r].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[r].renderTarget),this._engine.bindFramebuffer(this._depthMrts[r].renderTarget),this._engine.bindAttachments(this._layoutCache[2]),this._engine.setAlphaMode(11),this._engine.setAlphaEquation(3),this._engine.depthCullingState.depthTest=!1,this._engine.applyStates(),this._renderSubMeshes(this._candidateSubMeshes),this._engine.unBindFramebuffer(this._depthMrts[r].renderTarget),this._scene.resetCachedMaterial(),this._engine.bindFramebuffer(this._blendBackMrt.renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.setAlphaEquation(0),this._engine.setAlphaMode(17),this._engine.applyStates();const a=r===0||!this._useRenderPasses?this._blendBackEffectWrapper:this._blendBackEffectWrapperPingPong;this._engine.enableEffect(a.drawWrapper),a.effect.setTexture("uBackColor",this._thinTextures[r*3+2]),this._effectRenderer.render(a),this._engine.unBindFramebuffer(this._blendBackMrt.renderTarget)}return this._engine.currentRenderPassId=t,this._finalCompose(r),this._scene.prePassRenderer._enabled=!0,this._engine.depthCullingState.depthMask=!0,this._engine.depthCullingState.depthTest=!0,this._excludedSubMeshes}dispose(){this._disposeTextures(),this._blendBackEffectWrapper.dispose(),this._finalEffectWrapper.dispose(),this._effectRenderer.dispose(),this._releaseRenderPassIds()}}un._DEPTH_CLEAR_VALUE=-99999;un._MIN_DEPTH=0;un._MAX_DEPTH=1;Object.defineProperty(le.prototype,"depthPeelingRenderer",{get:function(){if(!this._depthPeelingRenderer){let s=this._getComponent(se.NAME_DEPTHPEELINGRENDERER);s||(s=new x5(this),this._addComponent(s))}return this._depthPeelingRenderer},set:function(s){this._depthPeelingRenderer=s},enumerable:!0,configurable:!0});Object.defineProperty(le.prototype,"useOrderIndependentTransparency",{get:function(){return this._useOrderIndependentTransparency},set:function(s){var e;this._useOrderIndependentTransparency!==s&&(this._useOrderIndependentTransparency=s,this.markAllMaterialsAsDirty(127),(e=this.prePassRenderer)==null||e.markAsDirty())},enumerable:!0,configurable:!0});class x5{constructor(e){this.name=se.NAME_DEPTHPEELINGRENDERER,this.scene=e,e.depthPeelingRenderer=new un(e)}register(){}rebuild(){}dispose(){var e;(e=this.scene.depthPeelingRenderer)==null||e.dispose(),this.scene.depthPeelingRenderer=null}}Mt.prototype.disableEdgesRendering=function(){return this._edgesRenderer&&(this._edgesRenderer.dispose(),this._edgesRenderer=null),this};Mt.prototype.enableEdgesRendering=function(s=.95,e=!1,t){return this.disableEdgesRendering(),this._edgesRenderer=new wh(this,s,e,!0,t),this};Object.defineProperty(Mt.prototype,"edgesRenderer",{get:function(){return this._edgesRenderer},enumerable:!0,configurable:!0});CI.prototype.enableEdgesRendering=function(s=.95,e=!1){return this.disableEdgesRendering(),this._edgesRenderer=new T5(this,s,e),this};sM.prototype.enableEdgesRendering=function(s=.95,e=!1){return CI.prototype.enableEdgesRendering.apply(this,arguments),this};class E5{constructor(){this.edges=[],this.edgesConnectedCount=0}}class wh{get linesPositions(){return this._linesPositions}get linesNormals(){return this._linesNormals}get linesIndices(){return this._linesIndices}get lineShader(){return this._lineShader}set lineShader(e){this._lineShader=e}static _GetShader(e,t){if(!e._edgeRenderLineShader){const i=new Ta("lineShader",e,"line",{attributes:["position","normal"],uniforms:["world","viewProjection","color","width","aspectRatio"],uniformBuffers:["Scene","Mesh"],shaderLanguage:t,extraInitializationsAsync:async()=>{t===1?await Promise.all([U(()=>Promise.resolve().then(()=>YY),void 0),U(()=>Promise.resolve().then(()=>$Y),void 0)]):await Promise.all([U(()=>Promise.resolve().then(()=>WY),void 0),U(()=>Promise.resolve().then(()=>UY),void 0)])}},!1);i.disableDepthWrite=!0,i.backFaceCulling=!1,i.checkReadyOnEveryCall=e.getEngine().isWebGPU,e._edgeRenderLineShader=i,e.onDisposeObservable.add(()=>{e._edgeRenderLineShader.dispose(),e._edgeRenderLineShader=null})}return e._edgeRenderLineShader}get shaderLanguage(){return this._shaderLanguage}constructor(e,t=.95,i=!1,r=!0,n){this.edgesWidthScalerForOrthographic=1e3,this.edgesWidthScalerForPerspective=50,this._linesPositions=new Array,this._linesNormals=new Array,this._linesIndices=new Array,this._buffers={},this._buffersForInstances={},this._checkVerticesInsteadOfIndices=!1,this.isEnabled=!0,this.customInstances=new Xn(32),this._shaderLanguage=0,this._source=e,this._checkVerticesInsteadOfIndices=i,this._options=n??null,this._epsilon=t;const a=this._source.getScene().getEngine();a.isWebGPU&&(this._drawWrapper=new gn(a),this._shaderLanguage=1),this._prepareResources(),r&&((n==null?void 0:n.useAlternateEdgeFinder)??!0?this._generateEdgesLinesAlternate():this._generateEdgesLines()),this._meshRebuildObserver=this._source.onRebuildObservable.add(()=>{this._rebuild()}),this._meshDisposeObserver=this._source.onDisposeObservable.add(()=>{this.dispose()})}_prepareResources(){this._lineShader||(this._lineShader=wh._GetShader(this._source.getScene(),this._shaderLanguage))}_rebuild(){let e=this._buffers[M.PositionKind];e&&e._rebuild(),e=this._buffers[M.NormalKind],e&&e._rebuild();const i=this._source.getScene().getEngine();this._ib=i.createIndexBuffer(this._linesIndices)}dispose(){var t;this._source.onRebuildObservable.remove(this._meshRebuildObserver),this._source.onDisposeObservable.remove(this._meshDisposeObserver);let e=this._buffers[M.PositionKind];e&&(e.dispose(),this._buffers[M.PositionKind]=null),e=this._buffers[M.NormalKind],e&&(e.dispose(),this._buffers[M.NormalKind]=null),this._ib&&this._source.getScene().getEngine()._releaseBuffer(this._ib),(t=this._drawWrapper)==null||t.dispose()}_processEdgeForAdjacencies(e,t,i,r,n){return e===i&&t===r||e===r&&t===i?0:e===r&&t===n||e===n&&t===r?1:e===n&&t===i||e===i&&t===n?2:-1}_processEdgeForAdjacenciesWithVertices(e,t,i,r,n){return e.equalsWithEpsilon(i,1e-10)&&t.equalsWithEpsilon(r,1e-10)||e.equalsWithEpsilon(r,1e-10)&&t.equalsWithEpsilon(i,1e-10)?0:e.equalsWithEpsilon(r,1e-10)&&t.equalsWithEpsilon(n,1e-10)||e.equalsWithEpsilon(n,1e-10)&&t.equalsWithEpsilon(r,1e-10)?1:e.equalsWithEpsilon(n,1e-10)&&t.equalsWithEpsilon(i,1e-10)||e.equalsWithEpsilon(i,1e-10)&&t.equalsWithEpsilon(n,1e-10)?2:-1}_checkEdge(e,t,i,r,n){let a;t===void 0?a=!0:a=x.Dot(i[e],i[t])<this._epsilon,a&&this.createLine(r,n,this._linesPositions.length/3)}createLine(e,t,i){this._linesPositions.push(e.x,e.y,e.z,e.x,e.y,e.z,t.x,t.y,t.z,t.x,t.y,t.z),this._linesNormals.push(t.x,t.y,t.z,-1,t.x,t.y,t.z,1,e.x,e.y,e.z,-1,e.x,e.y,e.z,1),this._linesIndices.push(i,i+1,i+2,i,i+2,i+3)}_tessellateTriangle(e,t,i,r){const n=(D,w,B)=>{B>=0&&w.push(B);for(let Q=0;Q<D.length;++Q)w.push(D[Q][0])};let a=0;e[1].length>=e[0].length&&e[1].length>=e[2].length?a=1:e[2].length>=e[0].length&&e[2].length>=e[1].length&&(a=2);for(let D=0;D<3;++D)D===a?e[D].sort((w,B)=>w[1]<B[1]?-1:w[1]>B[1]?1:0):e[D].sort((w,B)=>w[1]>B[1]?-1:w[1]<B[1]?1:0);const o=[],l=[];n(e[a],o,-1);const c=o.length;for(let D=a+2;D>=a+1;--D)n(e[D%3],l,D!==a+2?r[i[t+(D+1)%3]]:-1);const u=l.length,h=0,d=0;i.push(r[i[t+a]],o[0],l[0]),i.push(r[i[t+(a+1)%3]],l[u-1],o[c-1]);const f=c<=u,m=f?c:u,g=f?u:c,v=f?c-1:u-1,E=f?0:1;let T=c+u-2,C=f?h:d,A=f?d:h;const I=f?o:l,F=f?l:o;let V=0;for(;T-- >0;){E?i.push(I[C],F[A]):i.push(F[A],I[C]),V+=m;let D;V>=g&&C<v?(D=I[++C],V-=g):D=F[++A],i.push(D)}i[t+0]=i[i.length-3],i[t+1]=i[i.length-2],i[t+2]=i[i.length-1],i.length=i.length-3}_generateEdgesLinesAlternate(){var c,u,h,d,f,m;const e=this._source.getVerticesData(M.PositionKind);let t=this._source.getIndices();if(!t||!e)return;Array.isArray(t)||(t=Array.from(t));const i=((c=this._options)==null?void 0:c.useFastVertexMerger)??!0,r=i?Math.round(-Math.log(((u=this._options)==null?void 0:u.epsilonVertexMerge)??1e-6)/Math.log(10)):((h=this._options)==null?void 0:h.epsilonVertexMerge)??1e-6,n=[],a=[];if(i){const g={};for(let v=0;v<e.length;v+=3){const E=e[v+0],T=e[v+1],C=e[v+2],A=E.toFixed(r)+"|"+T.toFixed(r)+"|"+C.toFixed(r);if(g[A]!==void 0)n.push(g[A]);else{const I=v/3;g[A]=I,n.push(I),a.push(I)}}}else for(let g=0;g<e.length;g+=3){const v=e[g+0],E=e[g+1],T=e[g+2];let C=!1;for(let A=0;A<g&&!C;A+=3){const I=e[A+0],F=e[A+1],V=e[A+2];if(Math.abs(v-I)<r&&Math.abs(E-F)<r&&Math.abs(T-V)<r){n.push(A/3),C=!0;break}}C||(n.push(g/3),a.push(g/3))}if((d=this._options)!=null&&d.applyTessellation){const g=((f=this._options)==null?void 0:f.epsilonVertexAligned)??1e-6,v=[];for(let E=0;E<t.length;E+=3){let T;for(let C=0;C<3;++C){const A=n[t[E+C]],I=n[t[E+(C+1)%3]],F=n[t[E+(C+2)%3]];if(A===I)continue;const V=e[A*3+0],D=e[A*3+1],w=e[A*3+2],B=e[I*3+0],Q=e[I*3+1],J=e[I*3+2],re=Math.sqrt((B-V)*(B-V)+(Q-D)*(Q-D)+(J-w)*(J-w));for(let ne=0;ne<a.length-1;ne++){const fe=a[ne];if(fe===A||fe===I||fe===F)continue;const be=e[fe*3+0],Me=e[fe*3+1],ce=e[fe*3+2],bt=Math.sqrt((be-V)*(be-V)+(Me-D)*(Me-D)+(ce-w)*(ce-w)),Pt=Math.sqrt((be-B)*(be-B)+(Me-Q)*(Me-Q)+(ce-J)*(ce-J));Math.abs(bt+Pt-re)<g&&(T||(T={index:E,edgesPoints:[[],[],[]]},v.push(T)),T.edgesPoints[C].push([fe,bt]))}}}for(let E=0;E<v.length;++E){const T=v[E];this._tessellateTriangle(T.edgesPoints,T.index,t,n)}v.length=0}const o={};for(let g=0;g<t.length;g+=3){let v;for(let E=0;E<3;++E){let T=n[t[g+E]],C=n[t[g+(E+1)%3]];const A=n[t[g+(E+2)%3]];if(T===C||(T===A||C===A)&&((m=this._options)!=null&&m.removeDegeneratedTriangles))continue;if(G.Vector3[0].copyFromFloats(e[T*3+0],e[T*3+1],e[T*3+2]),G.Vector3[1].copyFromFloats(e[C*3+0],e[C*3+1],e[C*3+2]),G.Vector3[2].copyFromFloats(e[A*3+0],e[A*3+1],e[A*3+2]),v||(G.Vector3[1].subtractToRef(G.Vector3[0],G.Vector3[3]),G.Vector3[2].subtractToRef(G.Vector3[1],G.Vector3[4]),v=x.Cross(G.Vector3[3],G.Vector3[4]),v.normalize()),T>C){const V=T;T=C,C=V}const I=T+"_"+C,F=o[I];F?F.done||(x.Dot(v,F.normal)<this._epsilon&&this.createLine(G.Vector3[0],G.Vector3[1],this._linesPositions.length/3),F.done=!0):o[I]={normal:v,done:!1,index:g,i:E}}}for(const g in o){const v=o[g];if(!v.done){const E=n[t[v.index+v.i]],T=n[t[v.index+(v.i+1)%3]];G.Vector3[0].copyFromFloats(e[E*3+0],e[E*3+1],e[E*3+2]),G.Vector3[1].copyFromFloats(e[T*3+0],e[T*3+1],e[T*3+2]),this.createLine(G.Vector3[0],G.Vector3[1],this._linesPositions.length/3)}}const l=this._source.getScene().getEngine();this._buffers[M.PositionKind]=new M(l,this._linesPositions,M.PositionKind,!1),this._buffers[M.NormalKind]=new M(l,this._linesNormals,M.NormalKind,!1,!1,4),this._buffersForInstances[M.PositionKind]=this._buffers[M.PositionKind],this._buffersForInstances[M.NormalKind]=this._buffers[M.NormalKind],this._ib=l.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}_generateEdgesLines(){const e=this._source.getVerticesData(M.PositionKind),t=this._source.getIndices();if(!t||!e)return;const i=[],r=[];let n,a;for(n=0;n<t.length;n+=3){a=new E5;const l=t[n],c=t[n+1],u=t[n+2];a.p0=new x(e[l*3],e[l*3+1],e[l*3+2]),a.p1=new x(e[c*3],e[c*3+1],e[c*3+2]),a.p2=new x(e[u*3],e[u*3+1],e[u*3+2]);const h=x.Cross(a.p1.subtract(a.p0),a.p2.subtract(a.p1));h.normalize(),r.push(h),i.push(a)}for(n=0;n<i.length;n++){a=i[n];for(let l=n+1;l<i.length;l++){const c=i[l];if(a.edgesConnectedCount===3)break;if(c.edgesConnectedCount===3)continue;const u=t[l*3],h=t[l*3+1],d=t[l*3+2];for(let f=0;f<3;f++){let m=0;if(a.edges[f]===void 0){switch(f){case 0:this._checkVerticesInsteadOfIndices?m=this._processEdgeForAdjacenciesWithVertices(a.p0,a.p1,c.p0,c.p1,c.p2):m=this._processEdgeForAdjacencies(t[n*3],t[n*3+1],u,h,d);break;case 1:this._checkVerticesInsteadOfIndices?m=this._processEdgeForAdjacenciesWithVertices(a.p1,a.p2,c.p0,c.p1,c.p2):m=this._processEdgeForAdjacencies(t[n*3+1],t[n*3+2],u,h,d);break;case 2:this._checkVerticesInsteadOfIndices?m=this._processEdgeForAdjacenciesWithVertices(a.p2,a.p0,c.p0,c.p1,c.p2):m=this._processEdgeForAdjacencies(t[n*3+2],t[n*3],u,h,d);break}if(m!==-1&&(a.edges[f]=l,c.edges[m]=n,a.edgesConnectedCount++,c.edgesConnectedCount++,a.edgesConnectedCount===3))break}}}}for(n=0;n<i.length;n++){const l=i[n];this._checkEdge(n,l.edges[0],r,l.p0,l.p1),this._checkEdge(n,l.edges[1],r,l.p1,l.p2),this._checkEdge(n,l.edges[2],r,l.p2,l.p0)}const o=this._source.getScene().getEngine();this._buffers[M.PositionKind]=new M(o,this._linesPositions,M.PositionKind,!1),this._buffers[M.NormalKind]=new M(o,this._linesNormals,M.NormalKind,!1,!1,4),this._buffersForInstances[M.PositionKind]=this._buffers[M.PositionKind],this._buffersForInstances[M.NormalKind]=this._buffers[M.NormalKind],this._ib=o.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}isReady(){return this._lineShader.isReady(this._source,this._source.hasInstances&&this.customInstances.length>0||this._source.hasThinInstances)}render(){const e=this._source.getScene(),t=this._lineShader._getDrawWrapper();if(this._drawWrapper&&this._lineShader._setDrawWrapper(this._drawWrapper),!this.isReady()||!e.activeCamera){this._lineShader._setDrawWrapper(t);return}const i=this._source.hasInstances&&this.customInstances.length>0,r=i||this._source.hasThinInstances;let n=0;if(r)if(this._buffersForInstances.world0=this._source.getVertexBuffer("world0"),this._buffersForInstances.world1=this._source.getVertexBuffer("world1"),this._buffersForInstances.world2=this._source.getVertexBuffer("world2"),this._buffersForInstances.world3=this._source.getVertexBuffer("world3"),i){const o=this._source._getInstanceDataStorage(),l=this._source._instanceDataStorage.isFrozen;if(n=this.customInstances.length,!o.instancesData){this._source.getScene()._activeMeshesFrozen||this.customInstances.reset();return}if(!l){let c=0;for(let u=0;u<n;++u)this.customInstances.data[u].copyToArray(o.instancesData,c),c+=16;o.instancesBuffer.updateDirectly(o.instancesData,0,n)}}else n=this._source.thinInstanceCount;const a=e.getEngine();this._lineShader._preBind(),this._source.edgesColor.a!==1?a.setAlphaMode(2):a.setAlphaMode(0),a.bindBuffers(r?this._buffersForInstances:this._buffers,this._ib,this._lineShader.getEffect()),e.resetCachedMaterial(),this._lineShader.setColor4("color",this._source.edgesColor),e.activeCamera.mode===dt.ORTHOGRAPHIC_CAMERA?this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForOrthographic):this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForPerspective),this._lineShader.setFloat("aspectRatio",a.getAspectRatio(e.activeCamera)),this._lineShader.bind(this._source.getWorldMatrix(),this._source),a.drawElementsType(Le.TriangleFillMode,0,this._indicesCount,n),this._lineShader.unbind(),r&&a.unbindInstanceAttributes(),this._source.getScene()._activeMeshesFrozen||this.customInstances.reset(),this._lineShader._setDrawWrapper(t)}}class T5 extends wh{constructor(e,t=.95,i=!1){super(e,t,i,!1),this._generateEdgesLines()}_generateEdgesLines(){const e=this._source.getVerticesData(M.PositionKind),t=this._source.getIndices();if(!t||!e)return;const i=G.Vector3[0],r=G.Vector3[1],n=t.length-1;for(let o=0,l=0;o<n;o+=2,l+=4)x.FromArrayToRef(e,3*t[o],i),x.FromArrayToRef(e,3*t[o+1],r),this.createLine(i,r,l);const a=this._source.getScene().getEngine();this._buffers[M.PositionKind]=new M(a,this._linesPositions,M.PositionKind,!1),this._buffers[M.NormalKind]=new M(a,this._linesNormals,M.NormalKind,!1,!1,4),this._ib=a.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}}Object.defineProperty(le.prototype,"iblCdfGenerator",{get:function(){return this._iblCdfGenerator},set:function(s){s&&(this._iblCdfGenerator=s)},enumerable:!0,configurable:!0});le.prototype.enableIblCdfGenerator=function(){return this._iblCdfGenerator?this._iblCdfGenerator:(this._iblCdfGenerator=new Aa(this),this._iblCdfGenerator.isSupported?(this.environmentTexture&&(this._iblCdfGenerator.iblSource=this.environmentTexture),this._iblCdfGenerator):(this._iblCdfGenerator=null,null))};le.prototype.disableIblCdfGenerator=function(){this._iblCdfGenerator&&(this._iblCdfGenerator.dispose(),this._iblCdfGenerator=null)};class b5{constructor(e){this.name=se.NAME_IBLCDFGENERATOR,this._newIblObserver=null,this.scene=e}register(){this._updateIblSource(),this._newIblObserver=this.scene.onEnvironmentTextureChangedObservable.add(this._updateIblSource.bind(this))}rebuild(){}dispose(){this.scene.onEnvironmentTextureChangedObservable.remove(this._newIblObserver)}_updateIblSource(){this.scene.iblCdfGenerator&&this.scene.environmentTexture&&(this.scene.iblCdfGenerator.iblSource=this.scene.environmentTexture)}}Aa._SceneComponentInitialization=s=>{let e=s._getComponent(se.NAME_IBLCDFGENERATOR);e||(e=new b5(s),s._addComponent(e))};class C5 extends Oi{constructor(){super(...arguments),this.RENDER_WITH_IBL_SHADOWS=!1,this.COLORED_IBL_SHADOWS=!1}}class sl extends Er{get isColored(){return this._isColored}set isColored(e){this._isColored!==e&&(this._isColored=e,this._markAllSubMeshesAsTexturesDirty())}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e){super(e,sl.Name,310,new C5),this.shadowOpacity=1,this._isEnabled=!1,this._isColored=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}prepareDefines(e){e.RENDER_WITH_IBL_SHADOWS=this._isEnabled,e.COLORED_IBL_SHADOWS=this.isColored}getClassName(){return"IBLShadowsPluginMaterial"}getUniforms(){return{ubo:[{name:"renderTargetSize",size:2,type:"vec2"},{name:"shadowOpacity",size:1,type:"float"}],fragment:`#ifdef RENDER_WITH_IBL_SHADOWS
                    uniform vec2 renderTargetSize;
                    uniform float shadowOpacity;
                #endif`}}getSamplers(e){e.push("iblShadowsTexture")}bindForSubMesh(e){this._isEnabled&&(e.bindTexture("iblShadowsTexture",this.iblShadowsTexture),e.updateFloat2("renderTargetSize",this._material.getScene().getEngine().getRenderWidth(),this._material.getScene().getEngine().getRenderHeight()),e.updateFloat("shadowOpacity",this.shadowOpacity))}getCustomCode(e,t){let i;return t===1?(i={CUSTOM_FRAGMENT_DEFINITIONS:`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    var iblShadowsTextureSampler: sampler;
                    var iblShadowsTexture: texture_2d<f32>;

                    #ifdef COLORED_IBL_SHADOWS
                        fn computeIndirectShadow() -> vec3f {
                            var uv = fragmentInputs.position.xy / uniforms.renderTargetSize;
                            var shadowValue: vec3f = textureSample(iblShadowsTexture, iblShadowsTextureSampler, uv).rgb;
                            return mix(shadowValue, vec3f(1.0), 1.0 - uniforms.shadowOpacity);
                        }
                    #else
                        fn computeIndirectShadow() -> vec2f {
                            var uv = fragmentInputs.position.xy / uniforms.renderTargetSize;
                            var shadowValue: vec2f = textureSample(iblShadowsTexture, iblShadowsTextureSampler, uv).rg;
                            return mix(shadowValue, vec2f(1.0), 1.0 - uniforms.shadowOpacity);
                        }
                    #endif
                #endif
            `},this._material instanceof Ve?i.CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION=`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    #ifndef UNLIT
                        #ifdef REFLECTION
                            #ifdef COLORED_IBL_SHADOWS
                                var shadowValue: vec3f = computeIndirectShadow();
                                finalIrradiance *= shadowValue;
                                finalRadianceScaled *= mix(vec3f(1.0), shadowValue, roughness);
                            #else
                                var shadowValue: vec2f = computeIndirectShadow();
                                finalIrradiance *= vec3f(shadowValue.x);
                                finalRadianceScaled *= vec3f(mix(pow(shadowValue.y, 4.0), shadowValue.x, roughness));
                            #endif
                        #endif
                    #else
                        finalDiffuse *= computeIndirectShadow().x;
                    #endif
                #endif
            `:this._material instanceof oe?i.CUSTOM_FRAGMENT_BEFORE_IBLLAYERCOMPOSITION=`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    #ifndef UNLIT
                        #ifdef REFLECTION
                            #ifdef COLORED_IBL_SHADOWS
                                var shadowValue: vec3f = computeIndirectShadow();
                                slab_diffuse_ibl *= shadowValue;
                                slab_glossy_ibl *= mix(vec3f(1.0), shadowValue, specularAlphaG);
                            #else
                                var shadowValue: vec2f = computeIndirectShadow();
                                slab_diffuse_ibl *= vec3f(shadowValue.x);
                                slab_glossy_ibl *= vec3f(mix(pow(shadowValue.y, 4.0), shadowValue.x, specularAlphaG));
                            #endif
                        #endif
                    #else
                        slab_diffuse_ibl *= computeIndirectShadow().x;
                    #endif
                #endif
            `:i.CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR=`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    #ifdef COLORED_IBL_SHADOWS
                        var shadowValue: vec3f = computeIndirectShadow();
                        color *= toGammaSpace(vec4f(shadowValue, 1.0f));
                    #else
                        var shadowValue: vec2f = computeIndirectShadow();
                        color *= toGammaSpace(vec4f(shadowValue.x, shadowValue.x, shadowValue.x, 1.0f));
                    #endif
                #endif
            `):(i={CUSTOM_FRAGMENT_DEFINITIONS:`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    uniform sampler2D iblShadowsTexture;
                #ifdef COLORED_IBL_SHADOWS
                    vec3 computeIndirectShadow() {
                        vec2 uv = gl_FragCoord.xy / renderTargetSize;
                        vec3 shadowValue = texture2D(iblShadowsTexture, uv).rgb;
                        return mix(shadowValue.rgb, vec3(1.0), 1.0 - shadowOpacity);
                    }
                #else
                    vec2 computeIndirectShadow() {
                        vec2 uv = gl_FragCoord.xy / renderTargetSize;
                        vec2 shadowValue = texture2D(iblShadowsTexture, uv).rg;
                        return mix(shadowValue.rg, vec2(1.0), 1.0 - shadowOpacity);
                    }
                #endif
                #endif
            `},this._material instanceof Ve?i.CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION=`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    #ifndef UNLIT
                        #ifdef REFLECTION
                            #ifdef COLORED_IBL_SHADOWS
                                vec3 shadowValue = computeIndirectShadow();
                                finalIrradiance.rgb *= shadowValue.rgb;
                                finalRadianceScaled *= mix(vec3(1.0), shadowValue.rgb, roughness);
                            #else
                                vec2 shadowValue = computeIndirectShadow();
                                finalIrradiance *= shadowValue.x;
                                finalRadianceScaled *= mix(pow(shadowValue.y, 4.0), shadowValue.x, roughness);
                            #endif
                        #endif
                    #else
                        finalDiffuse *= computeIndirectShadow().x;
                    #endif
                #endif
            `:this._material instanceof oe?i.CUSTOM_FRAGMENT_BEFORE_IBLLAYERCOMPOSITION=`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    #ifndef UNLIT
                        #ifdef REFLECTION
                            #ifdef COLORED_IBL_SHADOWS
                                vec3 shadowValue = computeIndirectShadow();
                                slab_diffuse_ibl.rgb *= shadowValue.rgb;
                                slab_glossy_ibl *= mix(vec3(1.0), shadowValue.rgb, specularAlphaG);
                            #else
                                vec2 shadowValue = computeIndirectShadow();
                                slab_diffuse_ibl *= shadowValue.x;
                                slab_glossy_ibl *= mix(pow(shadowValue.y, 4.0), shadowValue.x, specularAlphaG);
                            #endif
                        #endif
                    #else
                        slab_diffuse_ibl *= computeIndirectShadow().x;
                    #endif
                #endif
            `:i.CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR=`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    #ifdef COLORED_IBL_SHADOWS
                        vec3 shadowValue = computeIndirectShadow();
                        color.rgb *= toGammaSpace(shadowValue.rgb);
                    #else
                        vec2 shadowValue = computeIndirectShadow();
                        color.rgb *= toGammaSpace(shadowValue.x);
                    #endif
                #endif
            `),e==="vertex"?null:i}}sl.Name="IBLShadowsPluginMaterial";_([R()],sl.prototype,"shadowOpacity",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],sl.prototype,"isEnabled",void 0);y("BABYLON.IBLShadowsPluginMaterial",sl);class y5 extends da{constructor(e,t,i,r,n,a){super(e,i,r,n,a),this._beforeCompositionPostProcesses=[],this._internalTextureDirty=!1,this.enabled=!1,this.renderTargetTexture=null,this.renderTargetTexture=t}_createCompositionEffect(){this.imageProcessingPostProcess=new ig("prePassComposition",1,null,void 0,this._engine),this.imageProcessingPostProcess._updateParameters()}_checkSize(){const e=this._engine.getRenderWidth(!0),t=this._engine.getRenderHeight(!0),i=this.getRenderWidth(),r=this.getRenderHeight();(i!==e||r!==t)&&(this.resize({width:e,height:t}),this._internalTextureDirty=!0)}updateCount(e,t,i){super.updateCount(e,t,i),this._internalTextureDirty=!0}_resetPostProcessChain(){this._beforeCompositionPostProcesses.length=0}dispose(){const e=this._scene;if(super.dispose(),e&&e.prePassRenderer){const t=e.prePassRenderer.renderTargets.indexOf(this);t!==-1&&e.prePassRenderer.renderTargets.splice(t,1)}this.imageProcessingPostProcess&&this.imageProcessingPostProcess.dispose(),this.renderTargetTexture&&(this.renderTargetTexture._prePassRenderTarget=null),this._outputPostProcess&&(this._outputPostProcess.autoClear=!0,this._outputPostProcess.restoreDefaultInputTexture())}}class Ri{get generateNormalsInWorldSpace(){return this._generateNormalsInWorldSpace}set generateNormalsInWorldSpace(e){this._generateNormalsInWorldSpace!==e&&(this._generateNormalsInWorldSpace=e,this._markAllMaterialsAsPrePassDirty())}getIndex(e){return this._textureIndices[e]}get samples(){return this.defaultRT.samples}set samples(e){this.defaultRT.samples=e}get useSpecificClearForDepthTexture(){return this._useSpecificClearForDepthTexture}set useSpecificClearForDepthTexture(e){this._useSpecificClearForDepthTexture!==e&&(this._useSpecificClearForDepthTexture=e,this._isDirty=!0)}getRenderTarget(){return this._currentTarget}_setRenderTarget(e){var t;e?this._currentTarget=e:(this._currentTarget=this.defaultRT,this._engine.currentRenderPassId=((t=this._scene.activeCamera)==null?void 0:t.renderPassId)??this._currentTarget.renderPassId)}get currentRTisSceneRT(){return this._currentTarget===this.defaultRT}_refreshGeometryBufferRendererLink(){if(this.doNotUseGeometryRendererFallback)this._geometryBuffer&&this._geometryBuffer._unlinkPrePassRenderer(),this._geometryBuffer=null,this._scene.disableGeometryBufferRenderer();else{if(this._geometryBuffer=this._scene.enableGeometryBufferRenderer(),!this._geometryBuffer){this.doNotUseGeometryRendererFallback=!0;return}this._geometryBuffer._linkPrePassRenderer(this)}}get enabled(){return this._enabled}constructor(e){this.excludedSkinnedMesh=[],this.excludedMaterials=[],this.mrtCount=0,this._mrtTypes=[],this._mrtFormats=[],this._mrtLayout=[],this._mrtNames=[],this._textureIndices=[],this._generateNormalsInWorldSpace=!1,this._useSpecificClearForDepthTexture=!1,this._isDirty=!0,this._effectConfigurations=[],this.doNotUseGeometryRendererFallback=!0,this.renderTargets=[],this._clearColor=new Te(0,0,0,0),this._clearDepthColor=new Te(0,0,0,1),this._enabled=!1,this._needsCompositionForThisPass=!1,this.disableGammaTransform=!1,this._scene=e,this._engine=e.getEngine();let t=0;this._engine._caps.textureFloat&&this._engine._caps.textureFloatLinearFiltering?t=1:this._engine._caps.textureHalfFloat&&this._engine._caps.textureHalfFloatLinearFiltering&&(t=2);for(let i=0;i<Ri.TextureFormats.length;++i){const r=Ri.TextureFormats[i].format;Ri.TextureFormats[i].type===1&&(Ri.TextureFormats[i].type=t,t===1&&(r===6||r===7||r===5)&&!this._engine._caps.supportFloatTexturesResolve&&(Ri.TextureFormats[i].type=2))}Ri._SceneComponentInitialization(this._scene),this.defaultRT=this._createRenderTarget("sceneprePassRT",null),this._currentTarget=this.defaultRT}_createRenderTarget(e,t){const i=new y5(e,t,{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},0,this._scene,{generateMipMaps:!1,generateStencilBuffer:this._engine.isStencilEnable,defaultType:0,types:[],drawOnlyOnFirstAttachmentByDefault:!0});return this.renderTargets.push(i),this._enabled&&this._update(),i}get isSupported(){return this._scene.getEngine().getCaps().drawBuffersExtension}bindAttachmentsForEffect(e,t){const i=t.getMaterial(),r=i&&i.isPrePassCapable,n=i&&this.excludedMaterials.indexOf(i)!==-1;this.enabled&&this._currentTarget.enabled&&(e._multiTarget&&r&&!n?this._engine.bindAttachments(this._multiRenderAttachments):(this._engine._currentRenderTarget?this._engine.bindAttachments(this._defaultAttachments):this._engine.restoreSingleAttachment(),this._geometryBuffer&&this.currentRTisSceneRT&&!n&&this._geometryBuffer.renderList.push(t.getRenderingMesh())))}_reinitializeAttachments(){const e=[],t=[!1],i=[!1],r=[!0];for(let n=0;n<this.mrtCount;n++)e.push(!0),n>0&&(this._useSpecificClearForDepthTexture&&this._mrtLayout[n]===5?(t.push(!1),i.push(!0)):(t.push(!0),i.push(!1)),r.push(!1));this._multiRenderAttachments=this._engine.buildTextureLayout(e),this._clearAttachments=this._engine.buildTextureLayout(t),this._clearDepthAttachments=this._engine.buildTextureLayout(i),this._defaultAttachments=this._engine.buildTextureLayout(r)}_resetLayout(){for(let e=0;e<Ri.TextureFormats.length;e++)this._textureIndices[Ri.TextureFormats[e].purpose]=-1;this._textureIndices[4]=0,this._mrtLayout=[4],this._mrtTypes=[Ri.TextureFormats[4].type],this._mrtFormats=[Ri.TextureFormats[4].format],this._mrtNames=[Ri.TextureFormats[4].name],this.mrtCount=1}_updateGeometryBufferLayout(){if(this._refreshGeometryBufferRendererLink(),this._geometryBuffer){this._geometryBuffer._resetLayout();const e=[];for(let i=0;i<this._mrtLayout.length;i++)e.push(!1);this._geometryBuffer._linkInternalTexture(this.defaultRT.getInternalTexture());const t=[{prePassConstant:5,geometryBufferConstant:Ae.DEPTH_TEXTURE_TYPE},{prePassConstant:6,geometryBufferConstant:Ae.NORMAL_TEXTURE_TYPE},{prePassConstant:1,geometryBufferConstant:Ae.POSITION_TEXTURE_TYPE},{prePassConstant:3,geometryBufferConstant:Ae.REFLECTIVITY_TEXTURE_TYPE},{prePassConstant:2,geometryBufferConstant:Ae.VELOCITY_TEXTURE_TYPE}];for(let i=0;i<t.length;i++){const r=this._mrtLayout.indexOf(t[i].prePassConstant);r!==-1&&(this._geometryBuffer._forceTextureType(t[i].geometryBufferConstant,r),e[r]=!0)}this._geometryBuffer._setAttachments(this._engine.buildTextureLayout(e))}}restoreAttachments(){this.enabled&&this._currentTarget.enabled&&this._defaultAttachments&&(this._engine._currentRenderTarget?this._engine.bindAttachments(this._defaultAttachments):this._engine.restoreSingleAttachment())}_beforeDraw(e,t,i){this._isDirty&&this._update(),!(!this._enabled||!this._currentTarget.enabled)&&(this._geometryBuffer&&(this._geometryBuffer.renderList=[]),this._setupOutputForThisPass(this._currentTarget,e))}_prepareFrame(e,t,i){e.renderTargetTexture?e.renderTargetTexture._prepareFrame(this._scene,t,i,e.renderTargetTexture.useCameraPostProcesses):this._postProcessesSourceForThisPass.length?this._scene.postProcessManager._prepareFrame():this._engine.restoreDefaultFramebuffer()}setCustomOutput(e){const t=this._postProcessesSourceForThisPass[0];return t?(t.inputTexture=e.renderTarget,!0):!1}_renderPostProcesses(e,t){var a;const i=this._postProcessesSourceForThisPass[0],r=i?i.inputTexture:e.renderTargetTexture?e.renderTargetTexture.renderTarget:null;let n=this._currentTarget._beforeCompositionPostProcesses;this._needsCompositionForThisPass&&(n=n.concat([this._currentTarget.imageProcessingPostProcess])),n.length&&(this._scene.postProcessManager._prepareFrame((a=this._currentTarget.renderTarget)==null?void 0:a.texture,n),this._scene.postProcessManager.directRender(n,r,!1,t))}_afterDraw(e,t){this._enabled&&this._currentTarget.enabled&&(this._prepareFrame(this._currentTarget,e,t),this._renderPostProcesses(this._currentTarget,e))}_clear(){this._isDirty&&this._update(),this._enabled&&this._currentTarget.enabled&&(this._bindFrameBuffer(),this._engine.bindAttachments(this._clearAttachments),this._engine.clear(this._clearColor,!0,!1,!1),this._useSpecificClearForDepthTexture&&(this._engine.bindAttachments(this._clearDepthAttachments),this._engine.clear(this._clearDepthColor,!0,!1,!1)),this._engine.bindAttachments(this._defaultAttachments))}_bindFrameBuffer(){if(this._enabled&&this._currentTarget.enabled){this._currentTarget._checkSize();const e=this._currentTarget.renderTarget;e&&this._engine.bindFramebuffer(e)}}_setEnabled(e){this._enabled=e}_setRenderTargetEnabled(e,t){e.enabled=t,t||this._unlinkInternalTexture(e)}addEffectConfiguration(e){for(let t=0;t<this._effectConfigurations.length;t++)if(this._effectConfigurations[t].name===e.name)return this._effectConfigurations[t];return this._effectConfigurations.push(e),e.clearColor&&this._clearColor.copyFrom(e.clearColor),e}getEffectConfiguration(e){for(let t=0;t<this._effectConfigurations.length;t++)if(this._effectConfigurations[t].name===e)return this._effectConfigurations[t];return null}_enable(){const e=this.mrtCount;for(let t=0;t<this._effectConfigurations.length;t++)this._effectConfigurations[t].enabled&&this._enableTextures(this._effectConfigurations[t].texturesRequired);for(let t=0;t<this.renderTargets.length;t++){(this.mrtCount!==e||this.renderTargets[t].count!==this.mrtCount)&&this.renderTargets[t].updateCount(this.mrtCount,{types:this._mrtTypes,formats:this._mrtFormats},this._mrtNames.concat("prePass_DepthBuffer")),this.renderTargets[t]._resetPostProcessChain();for(let i=0;i<this._effectConfigurations.length;i++)this._effectConfigurations[i].enabled&&(!this._effectConfigurations[i].postProcess&&this._effectConfigurations[i].createPostProcess&&this._effectConfigurations[i].createPostProcess(),this._effectConfigurations[i].postProcess&&this.renderTargets[t]._beforeCompositionPostProcesses.push(this._effectConfigurations[i].postProcess))}this._reinitializeAttachments(),this._setEnabled(!0),this._updateGeometryBufferLayout()}_disable(){this._setEnabled(!1);for(let e=0;e<this.renderTargets.length;e++)this._setRenderTargetEnabled(this.renderTargets[e],!1);this._resetLayout();for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].enabled=!1}_getPostProcessesSource(e,t){if(t)return t._postProcesses;if(e.renderTargetTexture)if(e.renderTargetTexture.useCameraPostProcesses){const i=e.renderTargetTexture.activeCamera?e.renderTargetTexture.activeCamera:this._scene.activeCamera;return i?i._postProcesses:[]}else return e.renderTargetTexture.postProcesses?e.renderTargetTexture.postProcesses:[];else return this._scene.activeCamera?this._scene.activeCamera._postProcesses:[]}_setupOutputForThisPass(e,t){const i=t&&this._scene.activeCameras&&!!this._scene.activeCameras.length&&this._scene.activeCameras.indexOf(t)!==0;this._postProcessesSourceForThisPass=this._getPostProcessesSource(e,t),this._postProcessesSourceForThisPass=this._postProcessesSourceForThisPass.filter(l=>l!=null),this._scene.autoClear=!0;const r=this._hasImageProcessing(this._postProcessesSourceForThisPass);this._needsCompositionForThisPass=!r&&!this.disableGammaTransform&&this._needsImageProcessing()&&!i;const n=this._getFirstPostProcess(this._postProcessesSourceForThisPass),a=e._beforeCompositionPostProcesses&&e._beforeCompositionPostProcesses[0];let o=null;this._scene.imageProcessingConfiguration.applyByPostProcess=this._needsCompositionForThisPass||r,this._needsCompositionForThisPass&&!e.imageProcessingPostProcess&&e._createCompositionEffect(),a?o=a:this._needsCompositionForThisPass?o=e.imageProcessingPostProcess:n&&(o=n),this._bindFrameBuffer(),this._linkInternalTexture(e,o)}_linkInternalTexture(e,t){t&&(t.autoClear=!1,t.inputTexture=e.renderTarget),e._outputPostProcess!==t&&(e._outputPostProcess&&this._unlinkInternalTexture(e),e._outputPostProcess=t),e._internalTextureDirty&&(this._updateGeometryBufferLayout(),e._internalTextureDirty=!1)}_unlinkInternalTexture(e){e._outputPostProcess&&(e._outputPostProcess.autoClear=!0,e._outputPostProcess.restoreDefaultInputTexture(),e._outputPostProcess=null)}_needsImageProcessing(){for(let e=0;e<this._effectConfigurations.length;e++)if(this._effectConfigurations[e].enabled&&this._effectConfigurations[e].needsImageProcessing)return!0;return!1}_hasImageProcessing(e){var i;let t=!1;if(e){for(let r=0;r<e.length;r++)if(((i=e[r])==null?void 0:i.getClassName())==="ImageProcessingPostProcess"){t=!0;break}}return t}_getFirstPostProcess(e){for(let t=0;t<e.length;t++)if(e[t]!==null)return e[t];return null}markAsDirty(){this._isDirty=!0}_enableTextures(e){this._scene.needsPreviousWorldMatrices=!1;for(let t=0;t<e.length;t++){const i=e[t];this._textureIndices[i]===-1&&(this._textureIndices[i]=this._mrtLayout.length,this._mrtLayout.push(i),this._mrtTypes.push(Ri.TextureFormats[i].type),this._mrtFormats.push(Ri.TextureFormats[i].format),this._mrtNames.push(Ri.TextureFormats[i].name),this.mrtCount++),(i===2||i===11)&&(this._scene.needsPreviousWorldMatrices=!0)}}update(){this._isDirty&&this._update()}_update(){this._disable();let e=!1;this._scene.imageProcessingConfiguration.applyByPostProcess=!1,this._scene._depthPeelingRenderer&&this._scene.useOrderIndependentTransparency&&(this._scene._depthPeelingRenderer.setPrePassRenderer(this),e=!0);for(let i=0;i<this._scene.materials.length;i++)this._scene.materials[i].setPrePassRenderer(this)&&(e=!0);e&&this._setRenderTargetEnabled(this.defaultRT,!0);let t;for(let i=0;i<this.renderTargets.length;i++){if(this.renderTargets[i].renderTargetTexture)t=this._getPostProcessesSource(this.renderTargets[i]);else{const r=this._scene.activeCamera;if(!r)continue;t=r._postProcesses}if(t&&(t=t.filter(r=>r!=null),t)){for(let r=0;r<t.length;r++)t[r].setPrePassRenderer(this)&&(this._setRenderTargetEnabled(this.renderTargets[i],!0),e=!0);this._hasImageProcessing(t)&&(this._scene.imageProcessingConfiguration.applyByPostProcess=!0)}}this._markAllMaterialsAsPrePassDirty(),this._isDirty=!1,e&&this._enable()}_markAllMaterialsAsPrePassDirty(){const e=this._scene.materials;for(let t=0;t<e.length;t++)e[t].markAsDirty(Le.PrePassDirtyFlag)}dispose(){for(let e=this.renderTargets.length-1;e>=0;e--)this.renderTargets[e].dispose();for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].dispose&&this._effectConfigurations[e].dispose()}}Ri._SceneComponentInitialization=s=>{throw Ys("PrePassRendererSceneComponent")};Ri.TextureFormats=[{purpose:0,type:2,format:5,name:"prePass_Irradiance"},{purpose:1,type:2,format:5,name:"prePass_Position"},{purpose:2,type:0,format:5,name:"prePass_Velocity"},{purpose:3,type:0,format:5,name:"prePass_Reflectivity"},{purpose:4,type:2,format:5,name:"prePass_Color"},{purpose:5,type:1,format:6,name:"prePass_Depth"},{purpose:6,type:2,format:5,name:"prePass_Normal"},{purpose:7,type:0,format:5,name:"prePass_Albedo"},{purpose:8,type:0,format:5,name:"prePass_WorldNormal"},{purpose:9,type:2,format:5,name:"prePass_LocalPosition"},{purpose:10,type:1,format:6,name:"prePass_ScreenDepth"},{purpose:11,type:2,format:5,name:"prePass_VelocityLinear"}];Object.defineProperty(le.prototype,"prePassRenderer",{get:function(){return this._prePassRenderer},set:function(s){s&&s.isSupported&&(this._prePassRenderer=s)},enumerable:!0,configurable:!0});le.prototype.enablePrePassRenderer=function(){return this._prePassRenderer?this._prePassRenderer:(this._prePassRenderer=new Ri(this),this._prePassRenderer.isSupported||(this._prePassRenderer=null,N.Error(`PrePassRenderer needs WebGL 2 support.
Maybe you tried to use the following features that need the PrePassRenderer :
 + Subsurface Scattering`)),this._prePassRenderer)};le.prototype.disablePrePassRenderer=function(){this._prePassRenderer&&(this._prePassRenderer.dispose(),this._prePassRenderer=null)};class I5{constructor(e){this.name=se.NAME_PREPASSRENDERER,this.scene=e}register(){this.scene._beforeCameraDrawStage.registerStep(se.STEP_BEFORECAMERADRAW_PREPASS,this,this._beforeCameraDraw),this.scene._afterCameraDrawStage.registerStep(se.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterCameraDraw),this.scene._beforeRenderTargetDrawStage.registerStep(se.STEP_BEFORERENDERTARGETDRAW_PREPASS,this,this._beforeRenderTargetDraw),this.scene._afterRenderTargetDrawStage.registerStep(se.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterRenderTargetDraw),this.scene._beforeClearStage.registerStep(se.STEP_BEFORECLEAR_PREPASS,this,this._beforeClearStage),this.scene._beforeRenderTargetClearStage.registerStep(se.STEP_BEFORERENDERTARGETCLEAR_PREPASS,this,this._beforeRenderTargetClearStage),this.scene._beforeRenderingMeshStage.registerStep(se.STEP_BEFORERENDERINGMESH_PREPASS,this,this._beforeRenderingMeshStage),this.scene._afterRenderingMeshStage.registerStep(se.STEP_AFTERRENDERINGMESH_PREPASS,this,this._afterRenderingMeshStage)}_beforeRenderTargetDraw(e,t,i){this.scene.prePassRenderer&&!e.noPrePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(e._prePassRenderTarget),this.scene.prePassRenderer._beforeDraw(void 0,t,i))}_afterRenderTargetDraw(e,t,i){this.scene.prePassRenderer&&!e.noPrePassRenderer&&this.scene.prePassRenderer._afterDraw(t,i)}_beforeRenderTargetClearStage(e){this.scene.prePassRenderer&&!e.noPrePassRenderer&&(e._prePassRenderTarget||(e._prePassRenderTarget=this.scene.prePassRenderer._createRenderTarget(e.name+"_prePassRTT",e)),this.scene.prePassRenderer._setRenderTarget(e._prePassRenderTarget),this.scene.prePassRenderer._clear())}_beforeCameraDraw(e){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._beforeDraw(e))}_afterCameraDraw(){this.scene.prePassRenderer&&this.scene.prePassRenderer._afterDraw()}_beforeClearStage(){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._clear())}_beforeRenderingMeshStage(e,t,i,r){if(!r)return;const n=e.getScene();n.prePassRenderer&&n.prePassRenderer.bindAttachmentsForEffect(r,t)}_afterRenderingMeshStage(e){const t=e.getScene();t.prePassRenderer&&t.prePassRenderer.restoreAttachments()}rebuild(){}dispose(){this.scene.disablePrePassRenderer()}}Ri._SceneComponentInitialization=s=>{let e=s._getComponent(se.NAME_PREPASSRENDERER);e||(e=new I5(s),s._addComponent(e))};const cC="fibonacci",R5=`#define rcp(x) 1./x
#define GOLDEN_RATIO 1.618033988749895
vec2 Golden2dSeq(int i,float n)
{return vec2(float(i)/n+(0.5/n),fract(float(i)*rcp(GOLDEN_RATIO)));}
vec2 SampleDiskGolden(int i,int sampleCount)
{vec2 f=Golden2dSeq(i,float(sampleCount));return vec2(sqrt(f.x),TWO_PI*f.y);}`;S.IncludesShadersStore[cC]||(S.IncludesShadersStore[cC]=R5);const uC="diffusionProfile",A5="uniform vec3 diffusionS[5];uniform float diffusionD[5];uniform float filterRadii[5];";S.IncludesShadersStore[uC]||(S.IncludesShadersStore[uC]=A5);const hC="subSurfaceScatteringPixelShader",P5=`#include<helperFunctions>
#include<fibonacci>
#include<subSurfaceScatteringFunctions>
#include<diffusionProfile>
varying vec2 vUV;uniform vec2 texelSize;uniform sampler2D textureSampler;uniform sampler2D irradianceSampler;uniform sampler2D depthSampler;uniform sampler2D albedoSampler;uniform vec2 viewportSize;uniform float metersPerUnit;const float LOG2_E=1.4426950408889634;const float SSS_PIXELS_PER_SAMPLE=4.;const int _SssSampleBudget=40;
#define rcp(x) 1./x
#define Sq(x) x*x
#define SSS_BILATERAL_FILTER true
vec3 EvalBurleyDiffusionProfile(float r,vec3 S)
{vec3 exp_13=exp2(((LOG2_E*(-1.0/3.0))*r)*S); 
vec3 expSum=exp_13*(1.+exp_13*exp_13); 
return (S*rcp((8.*PI)))*expSum; }
vec2 SampleBurleyDiffusionProfile(float u,float rcpS)
{u=1.-u; 
float g=1.+(4.*u)*(2.*u+sqrt(1.+(4.*u)*u));float n=exp2(log2(g)*(-1.0/3.0)); 
float p=(g*n)*n; 
float c=1.+p+n; 
float d=(3./LOG2_E*2.)+(3./LOG2_E)*log2(u); 
float x=(3./LOG2_E)*log2(c)-d; 
float rcpExp=((c*c)*c)*rcp(((4.*u)*((c*c)+(4.*u)*(4.*u))));float r=x*rcpS;float rcpPdf=(8.*PI*rcpS)*rcpExp; 
return vec2(r,rcpPdf);}
vec3 ComputeBilateralWeight(float xy2,float z,float mmPerUnit,vec3 S,float rcpPdf)
{
#ifndef SSS_BILATERAL_FILTER
z=0.;
#endif
float r=sqrt(xy2+(z*mmPerUnit)*(z*mmPerUnit));float area=rcpPdf;
#if SSS_CLAMP_ARTIFACT
return clamp(EvalBurleyDiffusionProfile(r,S)*area,0.0,1.0);
#else
return EvalBurleyDiffusionProfile(r,S)*area;
#endif
}
void EvaluateSample(int i,int n,vec3 S,float d,vec3 centerPosVS,float mmPerUnit,float pixelsPerMm,
float phase,inout vec3 totalIrradiance,inout vec3 totalWeight)
{float scale =rcp(float(n));float offset=rcp(float(n))*0.5;float sinPhase,cosPhase;sinPhase=sin(phase);cosPhase=cos(phase);vec2 bdp=SampleBurleyDiffusionProfile(float(i)*scale+offset,d);float r=bdp.x;float rcpPdf=bdp.y;float phi=SampleDiskGolden(i,n).y;float sinPhi,cosPhi;sinPhi=sin(phi);cosPhi=cos(phi);float sinPsi=cosPhase*sinPhi+sinPhase*cosPhi; 
float cosPsi=cosPhase*cosPhi-sinPhase*sinPhi; 
vec2 vec=r*vec2(cosPsi,sinPsi);vec2 position; 
float xy2;position=vUV+round((pixelsPerMm*r)*vec2(cosPsi,sinPsi))*texelSize;xy2 =r*r;vec4 textureSample=texture2D(irradianceSampler,position);float viewZ=texture2D(depthSampler,position).r;vec3 irradiance =textureSample.rgb;if (testLightingForSSS(textureSample.a))
{float relZ=viewZ-centerPosVS.z;vec3 weight=ComputeBilateralWeight(xy2,relZ,mmPerUnit,S,rcpPdf);totalIrradiance+=weight*irradiance;totalWeight +=weight;}
else
{}}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{vec4 irradianceAndDiffusionProfile =texture2D(irradianceSampler,vUV);vec3 centerIrradiance=irradianceAndDiffusionProfile.rgb;int diffusionProfileIndex=int(round(irradianceAndDiffusionProfile.a*255.));float centerDepth =0.;vec4 inputColor=texture2D(textureSampler,vUV);bool passedStencilTest=testLightingForSSS(irradianceAndDiffusionProfile.a);if (passedStencilTest)
{centerDepth=texture2D(depthSampler,vUV).r;}
if (!passedStencilTest) { 
gl_FragColor=inputColor;return;}
float distScale =1.;vec3 S =diffusionS[diffusionProfileIndex];float d =diffusionD[diffusionProfileIndex];float filterRadius=filterRadii[diffusionProfileIndex];vec2 centerPosNDC=vUV;vec2 cornerPosNDC=vUV+0.5*texelSize;vec3 centerPosVS =vec3(centerPosNDC*viewportSize,1.0)*centerDepth; 
vec3 cornerPosVS =vec3(cornerPosNDC*viewportSize,1.0)*centerDepth; 
float mmPerUnit =1000.*(metersPerUnit*rcp(distScale));float unitsPerMm=rcp(mmPerUnit);float unitsPerPixel=2.*abs(cornerPosVS.x-centerPosVS.x);float pixelsPerMm =rcp(unitsPerPixel)*unitsPerMm;float filterArea =PI*Sq(filterRadius*pixelsPerMm);int sampleCount =int(filterArea*rcp(SSS_PIXELS_PER_SAMPLE));int sampleBudget=_SssSampleBudget;int texturingMode=0;vec3 albedo =texture2D(albedoSampler,vUV).rgb;if (distScale==0. || sampleCount<1)
{
#ifdef DEBUG_SSS_SAMPLES
vec3 green=vec3(0.,1.,0.);gl_FragColor=vec4(green,1.0);return;
#endif
gl_FragColor=vec4(inputColor.rgb+albedo*centerIrradiance,1.0);return;}
#ifdef DEBUG_SSS_SAMPLES
vec3 red =vec3(1.,0.,0.);vec3 blue=vec3(0.,0.,1.);gl_FragColor=vec4(mix(blue,red,clamp(float(sampleCount)/float(sampleBudget),0.0,1.0)),1.0);return;
#endif
float phase=0.;int n=min(sampleCount,sampleBudget);vec3 centerWeight =vec3(0.); 
vec3 totalIrradiance=vec3(0.);vec3 totalWeight =vec3(0.);for (int i=0; i<n; i++)
{EvaluateSample(i,n,S,d,centerPosVS,mmPerUnit,pixelsPerMm,
phase,totalIrradiance,totalWeight);}
totalWeight=max(totalWeight,HALF_MIN);gl_FragColor=vec4(inputColor.rgb+albedo*max(totalIrradiance/totalWeight,vec3(0.0)),1.);}`;S.ShadersStore[hC]||(S.ShadersStore[hC]=P5);const dC="fibonacci",O5=`fn rcp(x: f32)->f32
{return 1./x;}
const GOLDEN_RATIO=1.618033988749895;fn Golden2dSeq(i: u32,n: f32)->vec2f
{return vec2f(f32(i)/n+(0.5/n),fract(f32(i)*rcp(GOLDEN_RATIO)));}
fn SampleDiskGolden(i: u32,sampleCount: u32)->vec2f
{let f=Golden2dSeq(i,f32(sampleCount));return vec2f(sqrt(f.x),TWO_PI*f.y);}
`;S.IncludesShadersStoreWGSL[dC]||(S.IncludesShadersStoreWGSL[dC]=O5);const fC="diffusionProfile",N5=`uniform diffusionS: array<vec3f,5>;uniform diffusionD: array<f32,5>;uniform filterRadii: array<f32,5>;
`;S.IncludesShadersStoreWGSL[fC]||(S.IncludesShadersStoreWGSL[fC]=N5);const pC="subSurfaceScatteringPixelShader",D5=`#include<helperFunctions>
#include<fibonacci>
#include<subSurfaceScatteringFunctions>
#include<diffusionProfile>
varying vUV: vec2f;uniform texelSize: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var irradianceSamplerSampler: sampler;var irradianceSampler: texture_2d<f32>;var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;var albedoSamplerSampler: sampler;var albedoSampler: texture_2d<f32>;uniform viewportSize: vec2f;uniform metersPerUnit: f32;const LOG2_E=1.4426950408889634;const SSS_PIXELS_PER_SAMPLE=4.;const _SssSampleBudget=40u;
#define SSS_BILATERAL_FILTER true
fn EvalBurleyDiffusionProfile(r: f32,S: vec3f)->vec3f
{let exp_13=exp2(((LOG2_E*(-1.0/3.0))*r)*S); 
let expSum=exp_13*(1.+exp_13*exp_13); 
return (S*rcp(8.*PI))*expSum; }
fn SampleBurleyDiffusionProfile(u_: f32,rcpS: f32)->vec2f
{let u=1.-u_; 
let g=1.+(4.*u)*(2.*u+sqrt(1.+(4.*u)*u));let n=exp2(log2(g)*(-1.0/3.0)); 
let p=(g*n)*n; 
let c=1.+p+n; 
let d=(3./LOG2_E*2.)+(3./LOG2_E)*log2(u); 
let x=(3./LOG2_E)*log2(c)-d; 
let rcpExp=((c*c)*c)*rcp((4.*u)*((c*c)+(4.*u)*(4.*u)));let r=x*rcpS;let rcpPdf=(8.*PI*rcpS)*rcpExp; 
return vec2f(r,rcpPdf);}
fn ComputeBilateralWeight(xy2: f32,z_: f32,mmPerUnit: f32,S: vec3f,rcpPdf: f32)->vec3f
{
#ifndef SSS_BILATERAL_FILTER
let z=0.;
#else
let z=z_;
#endif
let r=sqrt(xy2+(z*mmPerUnit)*(z*mmPerUnit));let area=rcpPdf;
#ifdef SSS_CLAMP_ARTIFACT
return clamp(EvalBurleyDiffusionProfile(r,S)*area,vec3f(0.0),vec3f(1.0));
#else
return EvalBurleyDiffusionProfile(r,S)*area;
#endif
}
fn EvaluateSample(i: u32,n: u32,S: vec3f,d: f32,centerPosVS: vec3f,mmPerUnit: f32,pixelsPerMm: f32,
phase: f32,totalIrradiance: ptr<function,vec3f>,totalWeight: ptr<function,vec3f>)
{let scale =rcp(f32(n));let offset=rcp(f32(n))*0.5;let sinPhase=sin(phase);let cosPhase=cos(phase);let bdp=SampleBurleyDiffusionProfile(f32(i)*scale+offset,d);let r=bdp.x;let rcpPdf=bdp.y;let phi=SampleDiskGolden(i,n).y;let sinPhi=sin(phi);let cosPhi=cos(phi);let sinPsi=cosPhase*sinPhi+sinPhase*cosPhi; 
let cosPsi=cosPhase*cosPhi-sinPhase*sinPhi; 
let vec=r*vec2f(cosPsi,sinPsi);let position=fragmentInputs.vUV+round((pixelsPerMm*r)*vec2(cosPsi,sinPsi))*uniforms.texelSize;let xy2 =r*r;let textureRead=textureSampleLevel(irradianceSampler,irradianceSamplerSampler,position,0.);let viewZ=textureSampleLevel(depthSampler,depthSamplerSampler,position,0.).r;let irradiance =textureRead.rgb;if (testLightingForSSS(textureRead.a))
{let relZ=viewZ-centerPosVS.z;let weight=ComputeBilateralWeight(xy2,relZ,mmPerUnit,S,rcpPdf);*totalIrradiance+=weight*irradiance;*totalWeight +=weight;}
else
{}}
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {let irradianceAndDiffusionProfile =textureSampleLevel(irradianceSampler,irradianceSamplerSampler,fragmentInputs.vUV,0.);let centerIrradiance=irradianceAndDiffusionProfile.rgb;let diffusionProfileIndex=u32(round(irradianceAndDiffusionProfile.a*255.));var centerDepth =0.;let inputColor=textureSampleLevel(textureSampler,textureSamplerSampler,fragmentInputs.vUV,0.);let passedStencilTest=testLightingForSSS(irradianceAndDiffusionProfile.a);if (passedStencilTest)
{centerDepth=textureSampleLevel(depthSampler,depthSamplerSampler,fragmentInputs.vUV,0.).r;}
if (!passedStencilTest) { 
fragmentOutputs.color=inputColor;return fragmentOutputs;}
let distScale =1.;let S =uniforms.diffusionS[diffusionProfileIndex];let d =uniforms.diffusionD[diffusionProfileIndex];let filterRadius=uniforms.filterRadii[diffusionProfileIndex];let centerPosNDC=fragmentInputs.vUV;let cornerPosNDC=fragmentInputs.vUV+0.5*uniforms.texelSize;let centerPosVS =vec3f(centerPosNDC*uniforms.viewportSize,1.0)*centerDepth; 
let cornerPosVS =vec3f(cornerPosNDC*uniforms.viewportSize,1.0)*centerDepth; 
let mmPerUnit =1000.*(uniforms.metersPerUnit*rcp(distScale));let unitsPerMm=rcp(mmPerUnit);let unitsPerPixel=2.*abs(cornerPosVS.x-centerPosVS.x);let pixelsPerMm =rcp(unitsPerPixel)*unitsPerMm;let filterArea =PI*square(filterRadius*pixelsPerMm);let sampleCount =u32(filterArea*rcp(SSS_PIXELS_PER_SAMPLE));let sampleBudget=_SssSampleBudget;let albedo =textureSampleLevel(albedoSampler,albedoSamplerSampler,fragmentInputs.vUV,0.).rgb;if (distScale==0. || sampleCount<1)
{
#ifdef DEBUG_SSS_SAMPLES
let green=vec3f(0.,1.,0.);fragmentOutputs.color=vec4f(green,1.0);return fragmentOutputs;
#endif
fragmentOutputs.color=vec4f(inputColor.rgb+albedo*centerIrradiance,1.0);return fragmentOutputs;}
#ifdef DEBUG_SSS_SAMPLES
let red =vec3f(1.,0.,0.);let blue=vec3f(0.,0.,1.);fragmentOutputs.color=vec4f(mix(blue,red,clamp(f32(sampleCount)/f32(sampleBudget),0.0,1.0)),1.0);return fragmentOutputs;
#endif
let phase=0.;let n=min(sampleCount,sampleBudget);var totalIrradiance=vec3f(0.);var totalWeight =vec3f(0.);for (var i=0u; i<n; i++)
{EvaluateSample(i,n,S,d,centerPosVS,mmPerUnit,pixelsPerMm,
phase,&totalIrradiance,&totalWeight);}
totalWeight=max(totalWeight,vec3f(HALF_MIN));fragmentOutputs.color=vec4f(inputColor.rgb+albedo*max(totalIrradiance/totalWeight,vec3f(0.0)),1.);}
`;S.ShadersStoreWGSL[pC]||(S.ShadersStoreWGSL[pC]=D5);class M5 extends Se{getClassName(){return"SubSurfaceScatteringPostProcess"}constructor(e,t,i,r=null,n,a,o,l=0){const c={uniforms:["texelSize","viewportSize","metersPerUnit"],samplers:["diffusionS","diffusionD","filterRadii","irradianceSampler","depthSampler","albedoSampler"],size:typeof i=="number"?i:void 0,camera:r,samplingMode:n,engine:a,reusable:o,textureType:l,...i,blockCompilation:!0};super(e,"subSurfaceScattering",{...c,samplingMode:n||$.BILINEAR_SAMPLINGMODE}),this._scene=t,this.updateEffect(),this.onApplyObservable.add(u=>{if(!t.prePassRenderer||!t.subSurfaceConfiguration){N.Error("PrePass and subsurface configuration needs to be enabled for subsurface scattering.");return}const h=this.texelSize;u.setFloat("metersPerUnit",t.subSurfaceConfiguration.metersPerUnit),u.setFloat2("texelSize",h.x,h.y),u.setTexture("irradianceSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(0)]),u.setTexture("depthSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(5)]),u.setTexture("albedoSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(7)]),u.setFloat2("viewportSize",Math.tan(t.activeCamera.fov/2)*t.getEngine().getAspectRatio(t.activeCamera,!0),Math.tan(t.activeCamera.fov/2)),u.setArray3("diffusionS",t.subSurfaceConfiguration.ssDiffusionS),u.setArray("diffusionD",t.subSurfaceConfiguration.ssDiffusionD),u.setArray("filterRadii",t.subSurfaceConfiguration.ssFilterRadii)})}}class gc{get ssDiffusionS(){return this._ssDiffusionS}get ssDiffusionD(){return this._ssDiffusionD}get ssFilterRadii(){return this._ssFilterRadii}constructor(e){this._ssDiffusionS=[],this._ssFilterRadii=[],this._ssDiffusionD=[],this.enabled=!1,this.needsImageProcessing=!0,this.name=se.NAME_SUBSURFACE,this.ssDiffusionProfileColors=[],this.metersPerUnit=1,this.texturesRequired=[5,7,4,0],this.clearColor=new Te(0,0,0,1),this.addDiffusionProfile(new q(1,1,1)),this._scene=e,gc._SceneComponentInitialization(this._scene)}addDiffusionProfile(e){if(this.ssDiffusionD.length>=5)return N.Error("You already reached the maximum number of diffusion profiles."),0;for(let t=0;t<this._ssDiffusionS.length/3;t++)if(this._ssDiffusionS[t*3]===e.r&&this._ssDiffusionS[t*3+1]===e.g&&this._ssDiffusionS[t*3+2]===e.b)return t;return this._ssDiffusionS.push(e.r,e.b,e.g),this._ssDiffusionD.push(Math.max(Math.max(e.r,e.b),e.g)),this._ssFilterRadii.push(this.getDiffusionProfileParameters(e)),this.ssDiffusionProfileColors.push(e),this._ssDiffusionD.length-1}createPostProcess(){return this.postProcess=new M5("subSurfaceScattering",this._scene,{size:1,engine:this._scene.getEngine(),shaderLanguage:this._scene.getEngine().isWebGPU?1:0}),this.postProcess.autoClear=!1,this.postProcess}clearAllDiffusionProfiles(){this._ssDiffusionD=[],this._ssDiffusionS=[],this._ssFilterRadii=[],this.ssDiffusionProfileColors=[]}dispose(){this.clearAllDiffusionProfiles(),this.postProcess&&this.postProcess.dispose()}getDiffusionProfileParameters(e){const i=Math.max(e.r,e.g,e.b);return this._sampleBurleyDiffusionProfile(.997,i)}_sampleBurleyDiffusionProfile(e,t){e=1-e;const i=1+4*e*(2*e+Math.sqrt(1+4*e*e)),r=Math.pow(i,-1/3),a=1+i*r*r+r;return 3*Math.log(a/(4*e))*t}}gc._SceneComponentInitialization=s=>{throw Ys("SubSurfaceSceneComponent")};ko(se.NAME_SUBSURFACE,(s,e)=>{if(s.ssDiffusionProfileColors!==void 0&&s.ssDiffusionProfileColors!==null&&(e.enableSubSurfaceForPrePass(),e.subSurfaceConfiguration))for(let t=0,i=s.ssDiffusionProfileColors.length;t<i;t++){const r=s.ssDiffusionProfileColors[t];e.subSurfaceConfiguration.addDiffusionProfile(new q(r.r,r.g,r.b))}});Object.defineProperty(le.prototype,"subSurfaceConfiguration",{get:function(){return this._subSurfaceConfiguration},set:function(s){s&&this.enablePrePassRenderer()&&(this._subSurfaceConfiguration=s)},enumerable:!0,configurable:!0});le.prototype.enableSubSurfaceForPrePass=function(){if(this._subSurfaceConfiguration)return this._subSurfaceConfiguration;const s=this.enablePrePassRenderer();return s?(this._subSurfaceConfiguration=new gc(this),s.addEffectConfiguration(this._subSurfaceConfiguration),this._subSurfaceConfiguration):null};le.prototype.disableSubSurfaceForPrePass=function(){this._subSurfaceConfiguration&&(this._subSurfaceConfiguration.dispose(),this._subSurfaceConfiguration=null)};class F5{constructor(e){this.name=se.NAME_PREPASSRENDERER,this.scene=e}register(){}serialize(e){if(!this.scene.subSurfaceConfiguration)return;const t=this.scene.subSurfaceConfiguration.ssDiffusionProfileColors;e.ssDiffusionProfileColors=[];for(let i=0;i<t.length;i++)e.ssDiffusionProfileColors.push({r:t[i].r,g:t[i].g,b:t[i].b})}addFromContainer(){}removeFromContainer(){this.scene.prePassRenderer&&this.scene.subSurfaceConfiguration&&this.scene.subSurfaceConfiguration.clearAllDiffusionProfiles()}rebuild(){}dispose(){}}gc._SceneComponentInitialization=s=>{let e=s._getComponent(se.NAME_SUBSURFACE);e||(e=new F5(s),s._addComponent(e))};le.prototype.getOutlineRenderer=function(){return this._outlineRenderer||(this._outlineRenderer=new Hl(this)),this._outlineRenderer};Object.defineProperty(Oe.prototype,"renderOutline",{get:function(){return this._renderOutline},set:function(s){s&&this.getScene().getOutlineRenderer(),this._renderOutline=s},enumerable:!0,configurable:!0});Object.defineProperty(Oe.prototype,"renderOverlay",{get:function(){return this._renderOverlay},set:function(s){s&&this.getScene().getOutlineRenderer(),this._renderOverlay=s},enumerable:!0,configurable:!0});class Hl{get shaderLanguage(){return this._shaderLanguage}constructor(e){this.name=se.NAME_OUTLINERENDERER,this.zOffset=1,this.zOffsetUnits=4,this.enabled=!0,this._shaderLanguage=0,this.scene=e,this._engine=e.getEngine(),this.scene._addComponent(this),this._passIdForDrawWrapper=[];for(let i=0;i<4;++i)this._passIdForDrawWrapper[i]=this._engine.createRenderPassId(`Outline Renderer (${i})`);this._engine.isWebGPU&&(this._shaderLanguage=1)}register(){this.scene._beforeRenderingMeshStage.registerStep(se.STEP_BEFORERENDERINGMESH_OUTLINE,this,this._beforeRenderingMesh),this.scene._afterRenderingMeshStage.registerStep(se.STEP_AFTERRENDERINGMESH_OUTLINE,this,this._afterRenderingMesh)}rebuild(){}dispose(){for(let e=0;e<this._passIdForDrawWrapper.length;++e)this._engine.releaseRenderPassId(this._passIdForDrawWrapper[e])}render(e,t,i=!1,r){r=r??this._passIdForDrawWrapper[0];const n=this.scene,a=n.getEngine(),o=a.getCaps().instancedArrays&&(t.visibleInstances[e._id]!==null&&t.visibleInstances[e._id]!==void 0||e.getRenderingMesh().hasThinInstances);if(!this.isReady(e,o,r))return;const l=e.getMesh(),c=l._internalAbstractMeshDataInfo._actAsRegularMesh?l:null,u=e.getRenderingMesh(),h=c||u,d=e.getMaterial();if(!d||!n.activeCamera)return;const f=e._getDrawWrapper(r),m=gn.GetEffect(f);a.enableEffect(f),d.useLogarithmicDepth&&m.setFloat("logarithmicDepthConstant",2/(Math.log(n.activeCamera.maxZ+1)/Math.LN2)),m.setFloat("offset",i?0:u.outlineWidth),m.setColor4("color",i?u.overlayColor:u.outlineColor,i?u.overlayAlpha:d.alpha),m.setMatrix("viewProjection",n.getTransformMatrix()),m.setMatrix("world",h.getWorldMatrix()),Bo(u,m),Da(u,m),u.morphTargetManager&&u.morphTargetManager.isUsingTextureForTargets&&u.morphTargetManager._bind(m),o||u._bind(e,m,d.fillMode);const g=e.getMesh().bakedVertexAnimationManager;if(g&&g.isEnabled&&g.bind(m,o),d&&d.needAlphaTestingForMesh(h)){const v=d.getAlphaTestTexture();v&&(m.setTexture("diffuseSampler",v),m.setMatrix("diffuseMatrix",v.getTextureMatrix()))}jn(m,d,n),a.setZOffset(-this.zOffset),a.setZOffsetUnits(-this.zOffsetUnits),u._processRendering(h,e,m,d.fillMode,t,o,(v,E)=>{m.setMatrix("world",E)}),a.setZOffset(0),a.setZOffsetUnits(0)}isReady(e,t,i){i=i??this._passIdForDrawWrapper[0];const r=[],n=[M.PositionKind,M.NormalKind],a=e.getMesh(),o=e.getMaterial();if(!o)return!1;const l=a.getScene();let c=!1,u=!1;const h=!1;o.needAlphaTestingForMesh(a)&&(r.push("#define ALPHATEST"),a.isVerticesDataPresent(M.UVKind)&&(n.push(M.UVKind),r.push("#define UV1"),c=!0),a.isVerticesDataPresent(M.UV2Kind)&&(n.push(M.UV2Kind),r.push("#define UV2"),u=!0)),o.useLogarithmicDepth&&r.push("#define LOGARITHMICDEPTH"),Vm(o,l,r);const d=new Ma;if(a.useBones&&a.computeBonesUsingShaders&&a.skeleton){n.push(M.MatricesIndicesKind),n.push(M.MatricesWeightsKind),a.numBoneInfluencers>4&&(n.push(M.MatricesIndicesExtraKind),n.push(M.MatricesWeightsExtraKind));const T=a.skeleton;r.push("#define NUM_BONE_INFLUENCERS "+a.numBoneInfluencers),a.numBoneInfluencers>0&&d.addCPUSkinningFallback(0,a),T.isUsingTextureForMatrices?r.push("#define BONETEXTURE"):r.push("#define BonesPerMesh "+(T.bones.length+1))}else r.push("#define NUM_BONE_INFLUENCERS 0");const f=a.morphTargetManager?Eu(a.morphTargetManager,r,n,a,!0,!0,!1,c,u,h):0;t&&(r.push("#define INSTANCES"),Tu(n),e.getRenderingMesh().hasThinInstances&&r.push("#define THIN_INSTANCES"));const m=a.bakedVertexAnimationManager;m&&m.isEnabled&&(r.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&n.push("bakedVertexAnimationSettingsInstanced"));const g=e._getDrawWrapper(i,!0),v=g.defines,E=r.join(`
`);if(v!==E){const T=["world","mBones","viewProjection","diffuseMatrix","offset","color","logarithmicDepthConstant","morphTargetInfluences","boneTextureWidth","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],C=["diffuseSampler","boneSampler","morphTargets","bakedVertexAnimationTexture"];Na(T),g.setEffect(this.scene.getEngine().createEffect("outline",{attributes:n,uniformsNames:T,uniformBuffersNames:[],samplers:C,defines:E,fallbacks:d,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:f},shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{this._shaderLanguage===1?await Promise.all([U(()=>Promise.resolve().then(()=>JY),void 0),U(()=>Promise.resolve().then(()=>tj),void 0)]):await Promise.all([U(()=>Promise.resolve().then(()=>qY),void 0),U(()=>Promise.resolve().then(()=>QY),void 0)])}},this.scene.getEngine()),E)}return g.effect.isReady()}_beforeRenderingMesh(e,t,i){if(this.enabled&&(this._savedDepthWrite=this._engine.getDepthWrite(),e.renderOutline)){const r=t.getMaterial();r&&r.needAlphaBlendingForMesh(e)&&(this._engine.cacheStencilState(),this._engine.setDepthWrite(!1),this._engine.setColorWrite(!1),this._engine.setStencilBuffer(!0),this._engine.setStencilOperationPass(7681),this._engine.setStencilFunction(519),this._engine.setStencilMask(Hl._StencilReference),this._engine.setStencilFunctionReference(Hl._StencilReference),this._engine.stencilStateComposer.useStencilGlobalOnly=!0,this.render(t,i,!0,this._passIdForDrawWrapper[1]),this._engine.setColorWrite(!0),this._engine.setStencilFunction(517)),this._engine.setDepthWrite(!1),this.render(t,i,!1,this._passIdForDrawWrapper[0]),this._engine.setDepthWrite(this._savedDepthWrite),r&&r.needAlphaBlendingForMesh(e)&&(this._engine.stencilStateComposer.useStencilGlobalOnly=!1,this._engine.restoreStencilState())}}_afterRenderingMesh(e,t,i){if(this.enabled){if(e.renderOverlay){const r=this._engine.getAlphaMode(),n=this._engine.alphaState.alphaBlend;this._engine.setAlphaMode(2),this.render(t,i,!0,this._passIdForDrawWrapper[3]),this._engine.setAlphaMode(r),this._engine.setDepthWrite(this._savedDepthWrite),this._engine.alphaState.setAlphaBlend(n)}e.renderOutline&&this._savedDepthWrite&&(this._engine.setDepthWrite(!0),this._engine.setColorWrite(!1),this.render(t,i,!1,this._passIdForDrawWrapper[2]),this._engine.setColorWrite(!0))}}}Hl._StencilReference=4;class aO{get particleSize(){return this._particleSize}set particleSize(e){e!==this._particleSize&&(this._particleSize=e,this.onParticleSizeChanged.notifyObservers(this))}get useInstancing(){return!this.indexBuffer}get useVelocity(){return this._useVelocity}set useVelocity(e){this._useVelocity===e||!this._hasVelocity()||(this._useVelocity=e,this._effectsAreDirty=!0)}_hasVelocity(){var e;return!!((e=this.vertexBuffers)!=null&&e.velocity)}get indexBuffer(){return null}getClassName(){return"FluidRenderingObject"}get shaderLanguage(){return this._shaderLanguage}constructor(e,t){this.priority=0,this._particleSize=.1,this.onParticleSizeChanged=new k,this.particleThicknessAlpha=.05,this._useVelocity=!1,this._shaderLanguage=0,this._scene=e,this._engine=e.getEngine(),this._effectsAreDirty=!0,this._depthEffectWrapper=null,this._thicknessEffectWrapper=null,this._shaderLanguage=t??(this._engine.isWebGPU?1:0)}_createEffects(){const e=["view","projection","particleRadius","size"],t=["position","offset"],i=[];this._effectsAreDirty=!1,this.useVelocity&&(t.push("velocity"),i.push("#define FLUIDRENDERING_VELOCITY")),this._scene.useRightHandedSystem&&i.push("#define FLUIDRENDERING_RHS"),this._depthEffectWrapper=new gt({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleDepth",fragmentShader:"fluidRenderingParticleDepth",attributeNames:t,uniformNames:e,samplerNames:[],defines:i,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{this._shaderLanguage===1?await Promise.all([U(()=>Promise.resolve().then(()=>rY),void 0),U(()=>Promise.resolve().then(()=>nY),void 0)]):await Promise.all([U(()=>Promise.resolve().then(()=>z5),void 0),U(()=>Promise.resolve().then(()=>H5),void 0)])}}),e.push("particleAlpha"),this._thicknessEffectWrapper=new gt({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleThickness",fragmentShader:"fluidRenderingParticleThickness",attributeNames:["position","offset"],uniformNames:e,samplerNames:[],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{this._shaderLanguage===1?await Promise.all([U(()=>Promise.resolve().then(()=>oY),void 0),U(()=>Promise.resolve().then(()=>cY),void 0)]):await Promise.all([U(()=>Promise.resolve().then(()=>X5),void 0),U(()=>Promise.resolve().then(()=>j5),void 0)])}})}isReady(){if(this._effectsAreDirty&&this._createEffects(),!this._depthEffectWrapper||!this._thicknessEffectWrapper)return!1;const e=this._depthEffectWrapper.drawWrapper.effect,t=this._thicknessEffectWrapper.drawWrapper.effect;return e.isReady()&&t.isReady()}renderDepthTexture(){const e=this.numParticles;if(!this._depthEffectWrapper||e===0)return;const t=this._depthEffectWrapper.drawWrapper,i=t.effect;this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),i.setFloat2("size",this._particleSize,this._particleSize),i.setFloat("particleRadius",this._particleSize/2),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e)}renderThicknessTexture(){const e=this.numParticles;if(!this._thicknessEffectWrapper||e===0)return;const t=this._thicknessEffectWrapper.drawWrapper,i=t.effect;this._engine.setAlphaMode(6),this._engine.setDepthWrite(!1),this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),i.setFloat("particleAlpha",this.particleThicknessAlpha),i.setFloat2("size",this._particleSize,this._particleSize),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e),this._engine.setDepthWrite(!0),this._engine.setAlphaMode(0)}renderDiffuseTexture(){}dispose(){var e,t;(e=this._depthEffectWrapper)==null||e.dispose(!1),(t=this._thicknessEffectWrapper)==null||t.dispose(!1),this.onParticleSizeChanged.clear()}}class L5 extends aO{get particleSystem(){return this._particleSystem}getClassName(){return"FluidRenderingObjectParticleSystem"}get useTrueRenderingForDiffuseTexture(){return this._useTrueRenderingForDiffuseTexture}set useTrueRenderingForDiffuseTexture(e){this._useTrueRenderingForDiffuseTexture!==e&&(this._useTrueRenderingForDiffuseTexture=e,e?(this._particleSystem.blendMode=this._blendMode,this._particleSystem.onBeforeDrawParticlesObservable.remove(this._onBeforeDrawParticleObserver),this._onBeforeDrawParticleObserver=null):(this._particleSystem.blendMode=-1,this._onBeforeDrawParticleObserver=this._particleSystem.onBeforeDrawParticlesObservable.add(()=>{this._engine.setAlphaMode(2)})))}get vertexBuffers(){return this._particleSystem.vertexBuffers}get indexBuffer(){return this._particleSystem.indexBuffer}constructor(e,t,i){super(e,i),this._useTrueRenderingForDiffuseTexture=!0,this._particleSystem=t,this._originalRender=t.render.bind(t),this._blendMode=t.blendMode,this._onBeforeDrawParticleObserver=null,this._updateInAnimate=this._particleSystem.updateInAnimate,this._particleSystem.updateInAnimate=!0,this._particleSystem.render=()=>0,this.particleSize=(t.minSize+t.maxSize)/2,this.useTrueRenderingForDiffuseTexture=!1}isReady(){return super.isReady()&&this._particleSystem.isReady()}get numParticles(){return this._particleSystem.getActiveCount()}renderDiffuseTexture(){this._originalRender()}dispose(){super.dispose(),this._particleSystem.onBeforeDrawParticlesObservable.remove(this._onBeforeDrawParticleObserver),this._onBeforeDrawParticleObserver=null,this._particleSystem.render=this._originalRender,this._particleSystem.blendMode=this._blendMode,this._particleSystem.updateInAnimate=this._updateInAnimate}}class ad{get blurNumIterations(){return this._blurNumIterations}set blurNumIterations(e){if(this._blurNumIterations!==e&&(this._blurNumIterations=e,this._blurPostProcesses!==null)){const t=this._blurPostProcesses[0],i=this._blurPostProcesses[1];this._blurPostProcesses=[];for(let r=0;r<this._blurNumIterations*2;++r)this._blurPostProcesses[r]=r&1?i:t}}get renderTarget(){return this._rt}get renderTargetBlur(){return this._rtBlur}get texture(){return this._texture}get textureBlur(){return this._textureBlurred}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i,r,n,a,o=1,l=6,c=1,u=6,h=!1,d=null,f=!0,m=1,g){this.enableBlur=!0,this.blurSizeDivisor=1,this.blurFilterSize=7,this._blurNumIterations=3,this.blurMaxFilterSize=100,this.blurDepthScale=10,this.particleSize=.02,this.onDisposeObservable=new k,this._shaderLanguage=0,this._name=e,this._scene=t,this._camera=d,this._engine=t.getEngine(),this._width=i,this._height=r,this._blurTextureSizeX=n,this._blurTextureSizeY=a,this._textureType=o,this._textureFormat=l,this._blurTextureType=c,this._blurTextureFormat=u,this._useStandardBlur=h,this._generateDepthBuffer=f,this._samples=m,this._postProcessRunningIndex=0,this.enableBlur=n!==0&&a!==0,this._rt=null,this._texture=null,this._rtBlur=null,this._textureBlurred=null,this._blurPostProcesses=null,this._shaderLanguage=g??(this._engine.isWebGPU?1:0)}initialize(){if(this.dispose(),this._createRenderTarget(),this.enableBlur&&this._texture){const[e,t,i]=this._createBlurPostProcesses(this._texture,this._blurTextureType,this._blurTextureFormat,this.blurSizeDivisor,this._name,this._useStandardBlur);this._rtBlur=e,this._textureBlurred=t,this._blurPostProcesses=i}}applyBlurPostProcesses(){this.enableBlur&&this._blurPostProcesses&&(this._postProcessRunningIndex=0,this._scene.postProcessManager.directRender(this._blurPostProcesses,this._rtBlur,!0),this._engine.unBindFramebuffer(this._rtBlur))}_createRenderTarget(){this._rt=this._engine.createRenderTargetTexture({width:this._width,height:this._height},{generateMipMaps:!1,type:this._textureType,format:this._textureFormat,samplingMode:1,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:!1,samples:this._samples,label:`FluidRenderingRTT-${this._name}`});const e=this._rt.texture;e.incrementReferences(),this._texture=new $(null,this._scene),this._texture.name="rtt"+this._name,this._texture._texture=e,this._texture.wrapU=$.CLAMP_ADDRESSMODE,this._texture.wrapV=$.CLAMP_ADDRESSMODE,this._texture.anisotropicFilteringLevel=1}_createBlurPostProcesses(e,t,i,r,n,a=!1){const o=this._scene.getEngine(),l=new X(Math.floor(this._blurTextureSizeX/r),Math.floor(this._blurTextureSizeY/r)),c=t===1&&o.getCaps().textureFloatLinearFiltering||t===2&&o.getCaps().textureHalfFloatLinearFiltering,u=this._engine.createRenderTargetTexture({width:l.x,height:l.y},{generateMipMaps:!1,type:t,format:i,samplingMode:c?2:1,generateDepthBuffer:!1,generateStencilBuffer:!1,samples:this._samples,label:`FluidRenderingRTTBlur-${n}`}),h=u.texture;h.incrementReferences();const d=new $(null,this._scene);if(d.name="rttBlurred"+n,d._texture=h,d.wrapU=$.CLAMP_ADDRESSMODE,d.wrapV=$.CLAMP_ADDRESSMODE,d.anisotropicFilteringLevel=1,a){const f=new Se("BilateralBlurX","fluidRenderingStandardBlur",["filterSize","blurDir"],null,1,null,1,o,!0,null,t,void 0,void 0,void 0,i,this._shaderLanguage,async()=>{this.shaderLanguage===1?await U(()=>Promise.resolve().then(()=>TC),void 0):await U(()=>Promise.resolve().then(()=>vC),void 0)});f.samples=this._samples,f.externalTextureSamplerBinding=!0,f.onApplyObservable.add(v=>{this._postProcessRunningIndex===0?v.setTexture("textureSampler",e):v._bindTexture("textureSampler",f.inputTexture.texture),v.setInt("filterSize",this.blurFilterSize),v.setFloat2("blurDir",1/this._blurTextureSizeX,0),this._postProcessRunningIndex++}),f.onSizeChangedObservable.add(()=>{f._textures.forEach(v=>{v.texture.wrapU=$.CLAMP_ADDRESSMODE,v.texture.wrapV=$.CLAMP_ADDRESSMODE})}),this._fixReusablePostProcess(f);const m=new Se("BilateralBlurY","fluidRenderingStandardBlur",["filterSize","blurDir"],null,1,null,1,o,!0,null,t,void 0,void 0,void 0,i,this._shaderLanguage,async()=>{this.shaderLanguage===1?await U(()=>Promise.resolve().then(()=>TC),void 0):await U(()=>Promise.resolve().then(()=>vC),void 0)});m.samples=this._samples,m.onApplyObservable.add(v=>{v.setInt("filterSize",this.blurFilterSize),v.setFloat2("blurDir",0,1/this._blurTextureSizeY),this._postProcessRunningIndex++}),m.onSizeChangedObservable.add(()=>{m._textures.forEach(v=>{v.texture.wrapU=$.CLAMP_ADDRESSMODE,v.texture.wrapV=$.CLAMP_ADDRESSMODE})}),this._fixReusablePostProcess(m),f.autoClear=!1,m.autoClear=!1;const g=[];for(let v=0;v<this._blurNumIterations*2;++v)g[v]=v&1?m:f;return[u,d,g]}else{const f=["maxFilterSize","blurDir","projectedParticleConstant","depthThreshold"],m=new Se("BilateralBlurX","fluidRenderingBilateralBlur",f,null,1,null,1,o,!0,null,t,void 0,void 0,void 0,i,this._shaderLanguage,async()=>{this.shaderLanguage===1?await U(()=>Promise.resolve().then(()=>EC),void 0):await U(()=>Promise.resolve().then(()=>SC),void 0)});m.samples=this._samples,m.externalTextureSamplerBinding=!0,m.onApplyObservable.add(E=>{this._postProcessRunningIndex===0?E.setTexture("textureSampler",e):E._bindTexture("textureSampler",m.inputTexture.texture),E.setInt("maxFilterSize",this.blurMaxFilterSize),E.setFloat2("blurDir",1/this._blurTextureSizeX,0),E.setFloat("projectedParticleConstant",this._getProjectedParticleConstant()),E.setFloat("depthThreshold",this._getDepthThreshold()),this._postProcessRunningIndex++}),m.onSizeChangedObservable.add(()=>{m._textures.forEach(E=>{E.texture.wrapU=$.CLAMP_ADDRESSMODE,E.texture.wrapV=$.CLAMP_ADDRESSMODE})}),this._fixReusablePostProcess(m);const g=new Se("BilateralBlurY","fluidRenderingBilateralBlur",f,null,1,null,1,o,!0,null,t,void 0,void 0,void 0,i,this._shaderLanguage,async()=>{this.shaderLanguage===1?await U(()=>Promise.resolve().then(()=>EC),void 0):await U(()=>Promise.resolve().then(()=>SC),void 0)});g.samples=this._samples,g.onApplyObservable.add(E=>{E.setInt("maxFilterSize",this.blurMaxFilterSize),E.setFloat2("blurDir",0,1/this._blurTextureSizeY),E.setFloat("projectedParticleConstant",this._getProjectedParticleConstant()),E.setFloat("depthThreshold",this._getDepthThreshold()),this._postProcessRunningIndex++}),g.onSizeChangedObservable.add(()=>{g._textures.forEach(E=>{E.texture.wrapU=$.CLAMP_ADDRESSMODE,E.texture.wrapV=$.CLAMP_ADDRESSMODE})}),this._fixReusablePostProcess(g),m.autoClear=!1,g.autoClear=!1;const v=[];for(let E=0;E<this._blurNumIterations*2;++E)v[E]=E&1?g:m;return[u,d,v]}}_fixReusablePostProcess(e){e.isReusable()&&(e.onActivateObservable.add(()=>{e._currentRenderTextureInd=(e._currentRenderTextureInd+1)%2}),e.onApplyObservable.add(()=>{e._currentRenderTextureInd=(e._currentRenderTextureInd+1)%2}))}_getProjectedParticleConstant(){var e;return this.blurFilterSize*this.particleSize*.05*(this._height/2)/Math.tan((((e=this._camera)==null?void 0:e.fov)??45*Math.PI/180)/2)}_getDepthThreshold(){return this.particleSize/2*this.blurDepthScale}dispose(){var e,t,i,r;this.onDisposeObservable.hasObservers()&&this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),(e=this._rt)==null||e.dispose(),this._rt=null,(t=this._texture)==null||t.dispose(),this._texture=null,(i=this._rtBlur)==null||i.dispose(),this._rtBlur=null,(r=this._textureBlurred)==null||r.dispose(),this._textureBlurred=null,this._blurPostProcesses&&(this._blurPostProcesses[0].dispose(),this._blurPostProcesses[1].dispose()),this._blurPostProcesses=null}}var mC;(function(s){s[s.DepthTexture=0]="DepthTexture",s[s.DepthBlurredTexture=1]="DepthBlurredTexture",s[s.ThicknessTexture=2]="ThicknessTexture",s[s.ThicknessBlurredTexture=3]="ThicknessBlurredTexture",s[s.DiffuseTexture=4]="DiffuseTexture",s[s.Normals=5]="Normals",s[s.DiffuseRendering=6]="DiffuseRendering"})(mC||(mC={}));class _C{get needInitialization(){return this._needInitialization}get generateDiffuseTexture(){return this._generateDiffuseTexture}set generateDiffuseTexture(e){this._generateDiffuseTexture!==e&&(this._generateDiffuseTexture=e,this._needInitialization=!0)}get debugFeature(){return this._debugFeature}set debugFeature(e){this._debugFeature!==e&&(this._needInitialization=!0,this._debugFeature=e)}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,this._needInitialization=!0)}get environmentMap(){return this._environmentMap}set environmentMap(e){this._environmentMap!==e&&(this._needInitialization=!0,this._environmentMap=e)}get enableBlurDepth(){return this._enableBlurDepth}set enableBlurDepth(e){this._enableBlurDepth!==e&&(this._enableBlurDepth=e,this._needInitialization=!0)}get blurDepthSizeDivisor(){return this._blurDepthSizeDivisor}set blurDepthSizeDivisor(e){this._blurDepthSizeDivisor!==e&&(this._blurDepthSizeDivisor=e,this._needInitialization=!0)}get blurDepthFilterSize(){return this._blurDepthFilterSize}set blurDepthFilterSize(e){this._blurDepthFilterSize!==e&&(this._blurDepthFilterSize=e,this._setBlurParameters())}get blurDepthNumIterations(){return this._blurDepthNumIterations}set blurDepthNumIterations(e){this._blurDepthNumIterations!==e&&(this._blurDepthNumIterations=e,this._setBlurParameters())}get blurDepthMaxFilterSize(){return this._blurDepthMaxFilterSize}set blurDepthMaxFilterSize(e){this._blurDepthMaxFilterSize!==e&&(this._blurDepthMaxFilterSize=e,this._setBlurParameters())}get blurDepthDepthScale(){return this._blurDepthDepthScale}set blurDepthDepthScale(e){this._blurDepthDepthScale!==e&&(this._blurDepthDepthScale=e,this._setBlurParameters())}get enableBlurThickness(){return this._enableBlurThickness}set enableBlurThickness(e){this._enableBlurThickness!==e&&(this._enableBlurThickness=e,this._needInitialization=!0)}get blurThicknessSizeDivisor(){return this._blurThicknessSizeDivisor}set blurThicknessSizeDivisor(e){this._blurThicknessSizeDivisor!==e&&(this._blurThicknessSizeDivisor=e,this._needInitialization=!0)}get blurThicknessFilterSize(){return this._blurThicknessFilterSize}set blurThicknessFilterSize(e){this._blurThicknessFilterSize!==e&&(this._blurThicknessFilterSize=e,this._setBlurParameters())}get blurThicknessNumIterations(){return this._blurThicknessNumIterations}set blurThicknessNumIterations(e){this._blurThicknessNumIterations!==e&&(this._blurThicknessNumIterations=e,this._setBlurParameters())}get useFixedThickness(){return this._useFixedThickness}set useFixedThickness(e){this._useFixedThickness!==e&&(this._useFixedThickness=e,this._needInitialization=!0)}get useVelocity(){return this._useVelocity}set useVelocity(e){this._useVelocity!==e&&(this._useVelocity=e,this._needInitialization=!0,this._onUseVelocityChanged.notifyObservers(this))}get depthMapSize(){return this._depthMapSize}set depthMapSize(e){this._depthMapSize!==e&&(this._depthMapSize=e,this._needInitialization=!0)}get thicknessMapSize(){return this._thicknessMapSize}set thicknessMapSize(e){this._thicknessMapSize!==e&&(this._thicknessMapSize=e,this._needInitialization=!0)}get diffuseMapSize(){return this._diffuseMapSize}set diffuseMapSize(e){this._diffuseMapSize!==e&&(this._diffuseMapSize=e,this._needInitialization=!0)}get samples(){return this._samples}set samples(e){this._samples!==e&&(this._samples=e,this._needInitialization=!0)}get compositeMode(){return this._compositeMode}set compositeMode(e){this._compositeMode!==e&&(this._compositeMode=e,this._needInitialization=!0)}get camera(){return this._camera}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i){this._generateDiffuseTexture=!1,this.fluidColor=new q(.085,.6375,.765),this.density=2,this.refractionStrength=.1,this.fresnelClamp=1,this.specularPower=250,this.minimumThickness=0,this.dirLight=new x(-2,-1,1).normalize(),this._debugFeature=1,this._debug=!1,this._enableBlurDepth=!0,this._blurDepthSizeDivisor=1,this._blurDepthFilterSize=7,this._blurDepthNumIterations=3,this._blurDepthMaxFilterSize=100,this._blurDepthDepthScale=10,this._enableBlurThickness=!0,this._blurThicknessSizeDivisor=1,this._blurThicknessFilterSize=5,this._blurThicknessNumIterations=1,this._useFixedThickness=!1,this._onUseVelocityChanged=new k,this._useVelocity=!1,this._depthMapSize=null,this._thicknessMapSize=null,this._diffuseMapSize=null,this._samples=1,this._compositeMode=!1,this._shaderLanguage=0,this._scene=e,this._engine=e.getEngine(),this._camera=t??e.activeCamera,this._needInitialization=!0,this._bgDepthTexture=null,this._invProjectionMatrix=new z,this._depthClearColor=new Te(1e6,1e6,1e6,1),this._thicknessClearColor=new Te(0,0,0,1),this._depthRenderTarget=null,this._diffuseRenderTarget=null,this._thicknessRenderTarget=null,this._renderPostProcess=null,this._shaderLanguage=i??(this._engine.isWebGPU?1:0)}_initialize(){this.dispose(),this._needInitialization=!1;const e=this._depthMapSize??this._engine.getRenderWidth(),t=this._depthMapSize!==null?Math.round(this._depthMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();if(this._depthRenderTarget=new ad("Depth",this._scene,e,t,e,t,1,7,1,7,!1,this._camera,!0,this._samples,this._shaderLanguage),this._initializeRenderTarget(this._depthRenderTarget),this.generateDiffuseTexture){const n=this._diffuseMapSize??this._engine.getRenderWidth(),a=this._diffuseMapSize!==null?Math.round(this._diffuseMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();this._diffuseRenderTarget=new ad("Diffuse",this._scene,n,a,0,0,0,5,0,5,!0,this._camera,!0,this._samples,this._shaderLanguage),this._initializeRenderTarget(this._diffuseRenderTarget)}const i=this._thicknessMapSize??this._engine.getRenderWidth(),r=this._thicknessMapSize!==null?Math.round(this._thicknessMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();this._useFixedThickness||(this._thicknessRenderTarget=new ad("Thickness",this._scene,i,r,i,r,2,6,2,6,!0,this._camera,!1,this._samples,this._shaderLanguage),this._initializeRenderTarget(this._thicknessRenderTarget)),this._createLiquidRenderingPostProcess()}_setBlurParameters(e=null){(e===null||e===this._depthRenderTarget)&&this._setBlurDepthParameters(),(e===null||e===this._thicknessRenderTarget)&&this._setBlurThicknessParameters()}_setBlurDepthParameters(){this._depthRenderTarget&&(this._depthRenderTarget.blurFilterSize=this.blurDepthFilterSize,this._depthRenderTarget.blurMaxFilterSize=this.blurDepthMaxFilterSize,this._depthRenderTarget.blurNumIterations=this.blurDepthNumIterations,this._depthRenderTarget.blurDepthScale=this.blurDepthDepthScale)}_setBlurThicknessParameters(){this._thicknessRenderTarget&&(this._thicknessRenderTarget.blurFilterSize=this.blurThicknessFilterSize,this._thicknessRenderTarget.blurNumIterations=this.blurThicknessNumIterations)}_initializeRenderTarget(e){e!==this._diffuseRenderTarget&&(e.enableBlur=e===this._depthRenderTarget?this.enableBlurDepth:this.enableBlurThickness,e.blurSizeDivisor=e===this._depthRenderTarget?this.blurDepthSizeDivisor:this.blurThicknessSizeDivisor),this._setBlurParameters(e),e.initialize()}_createLiquidRenderingPostProcess(){const e=this._scene.getEngine(),t=["viewMatrix","projectionMatrix","invProjectionMatrix","texelSize","dirLight","cameraFar","density","refractionStrength","fresnelClamp","specularPower"],i=["depthSampler"],r=[];if(this.dispose(!0),!this._camera)return;const n=this._depthRenderTarget.enableBlur?this._depthRenderTarget.textureBlur:this._depthRenderTarget.texture,a=new X(1/n.getSize().width,1/n.getSize().height);this._scene.useRightHandedSystem&&r.push("#define FLUIDRENDERING_RHS"),this._environmentMap!==null&&(this._environmentMap??this._scene.environmentTexture)&&(i.push("reflectionSampler"),r.push("#define FLUIDRENDERING_ENVIRONMENT")),this._diffuseRenderTarget?(i.push("diffuseSampler"),r.push("#define FLUIDRENDERING_DIFFUSETEXTURE")):t.push("diffuseColor"),this._useVelocity&&(i.push("velocitySampler"),r.push("#define FLUIDRENDERING_VELOCITY")),this._useFixedThickness?(t.push("thickness"),i.push("bgDepthSampler"),r.push("#define FLUIDRENDERING_FIXED_THICKNESS")):(t.push("minimumThickness"),i.push("thicknessSampler")),this._compositeMode&&r.push("#define FLUIDRENDERING_COMPOSITE_MODE"),this._debug&&(r.push("#define FLUIDRENDERING_DEBUG"),this._debugFeature===5?r.push("#define FLUIDRENDERING_DEBUG_SHOWNORMAL"):this._debugFeature===6?r.push("#define FLUIDRENDERING_DEBUG_DIFFUSERENDERING"):(r.push("#define FLUIDRENDERING_DEBUG_TEXTURE"),i.push("debugSampler"),(this._debugFeature===0||this._debugFeature===1)&&r.push("#define FLUIDRENDERING_DEBUG_DEPTH"))),this._renderPostProcess=new Se("FluidRendering","fluidRenderingRender",t,i,1,null,2,e,!1,null,0,void 0,void 0,!0,void 0,this._shaderLanguage,async()=>{this._shaderLanguage===1?await U(()=>Promise.resolve().then(()=>_Y),void 0):await U(()=>Promise.resolve().then(()=>tY),void 0)}),this._renderPostProcess.updateEffect(r.join(`
`)),this._renderPostProcess.samples=this._samples;const o=e,l=o.setTextureSampler;this._renderPostProcess.onApplyObservable.add(c=>{var u,h,d,f,m,g,v,E,T,C;if(this._invProjectionMatrix.copyFrom(this._scene.getProjectionMatrix()),this._invProjectionMatrix.invert(),l&&l.call(o,"textureSamplerSampler",this._renderPostProcess.inputTexture.texture),this._depthRenderTarget.enableBlur?(c.setTexture("depthSampler",this._depthRenderTarget.textureBlur),l&&l.call(o,"depthSamplerSampler",((h=this._depthRenderTarget.textureBlur)==null?void 0:h.getInternalTexture())??null)):(c.setTexture("depthSampler",this._depthRenderTarget.texture),l&&l.call(o,"depthSamplerSampler",((u=this._depthRenderTarget.texture)==null?void 0:u.getInternalTexture())??null)),this._diffuseRenderTarget?this._diffuseRenderTarget.enableBlur?(c.setTexture("diffuseSampler",this._diffuseRenderTarget.textureBlur),l&&l.call(o,"diffuseSamplerSampler",((f=this._diffuseRenderTarget.textureBlur)==null?void 0:f.getInternalTexture())??null)):(c.setTexture("diffuseSampler",this._diffuseRenderTarget.texture),l&&l.call(o,"diffuseSamplerSampler",((d=this._diffuseRenderTarget.texture)==null?void 0:d.getInternalTexture())??null)):c.setColor3("diffuseColor",this.fluidColor),this._useFixedThickness?(c.setFloat("thickness",this.minimumThickness),c._bindTexture("bgDepthSampler",this._bgDepthTexture),l&&l.call(o,"bgDepthSamplerSampler",this._bgDepthTexture??null)):(this._thicknessRenderTarget.enableBlur?(c.setTexture("thicknessSampler",this._thicknessRenderTarget.textureBlur),l&&l.call(o,"thicknessSamplerSampler",((g=this._thicknessRenderTarget.textureBlur)==null?void 0:g.getInternalTexture())??null)):(c.setTexture("thicknessSampler",this._thicknessRenderTarget.texture),l&&l.call(o,"thicknessSamplerSampler",((m=this._thicknessRenderTarget.texture)==null?void 0:m.getInternalTexture())??null)),c.setFloat("minimumThickness",this.minimumThickness)),this._environmentMap!==null){const A=this._environmentMap??this._scene.environmentTexture;A&&(c.setTexture("reflectionSampler",A),l&&l.call(o,"reflectionSamplerSampler",(A==null?void 0:A.getInternalTexture())??null))}if(c.setMatrix("viewMatrix",this._scene.getViewMatrix()),c.setMatrix("invProjectionMatrix",this._invProjectionMatrix),c.setMatrix("projectionMatrix",this._scene.getProjectionMatrix()),c.setVector2("texelSize",a),c.setFloat("density",this.density),c.setFloat("refractionStrength",this.refractionStrength),c.setFloat("fresnelClamp",this.fresnelClamp),c.setFloat("specularPower",this.specularPower),c.setVector3("dirLight",this.dirLight),c.setFloat("cameraFar",this._camera.maxZ),this._debug){let A=null;switch(this._debugFeature){case 0:A=this._depthRenderTarget.texture;break;case 1:A=this._depthRenderTarget.enableBlur?this._depthRenderTarget.textureBlur:this._depthRenderTarget.texture;break;case 2:A=((v=this._thicknessRenderTarget)==null?void 0:v.texture)??null;break;case 3:A=(E=this._thicknessRenderTarget)!=null&&E.enableBlur?((T=this._thicknessRenderTarget)==null?void 0:T.textureBlur)??null:((C=this._thicknessRenderTarget)==null?void 0:C.texture)??null;break;case 4:this._diffuseRenderTarget&&(A=this._diffuseRenderTarget.texture);break}this._debugFeature!==5&&(c.setTexture("debugSampler",A),l&&l.call(o,"debugSamplerSampler",(A==null?void 0:A.getInternalTexture())??null))}})}_clearTargets(){var e,t,i;(e=this._depthRenderTarget)!=null&&e.renderTarget&&(this._engine.bindFramebuffer(this._depthRenderTarget.renderTarget),this._engine.clear(this._depthClearColor,!0,!0,!1),this._engine.unBindFramebuffer(this._depthRenderTarget.renderTarget)),(t=this._diffuseRenderTarget)!=null&&t.renderTarget&&(this._engine.bindFramebuffer(this._diffuseRenderTarget.renderTarget),this._engine.clear(this._thicknessClearColor,!0,!0,!1),this._engine.unBindFramebuffer(this._diffuseRenderTarget.renderTarget)),(i=this._thicknessRenderTarget)!=null&&i.renderTarget&&(this._engine.bindFramebuffer(this._thicknessRenderTarget.renderTarget),this._engine.clear(this._thicknessClearColor,!0,!1,!1),this._engine.unBindFramebuffer(this._thicknessRenderTarget.renderTarget))}_render(e){var i,r,n,a,o,l;if(this._needInitialization||!e.isReady())return;const t=this._engine._currentRenderTarget;this._engine.setState(!1,void 0,void 0,void 0,!0),this._engine.setDepthBuffer(!0),this._engine.setDepthWrite(!0),this._engine.setAlphaMode(0),(i=this._depthRenderTarget)!=null&&i.renderTarget&&(this._engine.bindFramebuffer(this._depthRenderTarget.renderTarget),e.renderDepthTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._depthRenderTarget.renderTarget)),(r=this._diffuseRenderTarget)!=null&&r.renderTarget&&(this._engine.bindFramebuffer(this._diffuseRenderTarget.renderTarget),e.renderDiffuseTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._diffuseRenderTarget.renderTarget)),(n=this._thicknessRenderTarget)!=null&&n.renderTarget&&(this._engine.bindFramebuffer(this._thicknessRenderTarget.renderTarget),e.renderThicknessTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._thicknessRenderTarget.renderTarget)),(a=this._depthRenderTarget)==null||a.applyBlurPostProcesses(),(o=this._diffuseRenderTarget)==null||o.applyBlurPostProcesses(),(l=this._thicknessRenderTarget)==null||l.applyBlurPostProcesses(),t&&this._engine.bindFramebuffer(t)}dispose(e=!1){var t,i,r,n;e||((t=this._depthRenderTarget)==null||t.dispose(),this._depthRenderTarget=null,(i=this._diffuseRenderTarget)==null||i.dispose(),this._diffuseRenderTarget=null,(r=this._thicknessRenderTarget)==null||r.dispose(),this._thicknessRenderTarget=null),this._renderPostProcess&&this._camera&&this._camera.detachPostProcess(this._renderPostProcess),(n=this._renderPostProcess)==null||n.dispose(),this._renderPostProcess=null,this._onUseVelocityChanged.clear(),this._needInitialization=!1}}class w5 extends aO{getClassName(){return"FluidRenderingObjectCustomParticles"}get vertexBuffers(){return this._vertexBuffers}constructor(e,t,i,r){super(e,r),this._numParticles=i,this._diffuseEffectWrapper=null,this._vertexBuffers={},this.addBuffers(t)}addBuffers(e){for(const t in e){let i,r=!0;switch(t){case"velocity":i=3;break;case"offset":r=!1;break}this._vertexBuffers[t]=new M(this._engine,e[t],t,!0,!1,i,r)}}_createEffects(){super._createEffects();const e=["view","projection","size"],t=["position","offset","color"];this._diffuseEffectWrapper=new gt({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleDiffuse",fragmentShader:"fluidRenderingParticleDiffuse",attributeNames:t,uniformNames:e,samplerNames:[],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{this._shaderLanguage===1?await U(()=>Promise.resolve().then(()=>dY),void 0):await U(()=>Promise.resolve().then(()=>Q5),void 0)}})}isReady(){var e;return this._vertexBuffers.offset||(this._vertexBuffers.offset=new M(this._engine,[0,0,1,0,0,1,1,1],"offset",!1,!1,2)),super.isReady()&&(((e=this._diffuseEffectWrapper)==null?void 0:e.effect.isReady())??!1)}get numParticles(){return this._numParticles}setNumParticles(e){this._numParticles=e}renderDiffuseTexture(){const e=this.numParticles;if(!this._diffuseEffectWrapper||e===0)return;const t=this._diffuseEffectWrapper.drawWrapper,i=t.effect;this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),this._particleSize!==null&&i.setFloat2("size",this._particleSize,this._particleSize),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e)}dispose(){var e;super.dispose(),(e=this._diffuseEffectWrapper)==null||e.dispose();for(const t in this._vertexBuffers)this._vertexBuffers[t].dispose();this._vertexBuffers={}}}class B5{get depthRTWrapper(){return this._depthRTWrapper}constructor(e,t,i,r=1){this._engine=e,this._copyTextureToTexture=new ER(e,!0),this._depthRTWrapper=this._engine.createRenderTargetTexture({width:t,height:i},{generateMipMaps:!1,type:0,format:6,samplingMode:1,generateDepthBuffer:!0,generateStencilBuffer:!1,samples:r,noColorAttachment:!0,label:"FluidRenderingDepthTextureCopyRTT"});const n=this._depthRTWrapper.createDepthStencilTexture(0,!1,!1,1,void 0,"FluidRenderingDepthTextureCopyRTTDepthStencil");n.label=`FluidDepthTextureCopy${t}x${i}x${r}`}copy(e){return this._copyTextureToTexture.copy(e,this._depthRTWrapper)}dispose(){this._depthRTWrapper.dispose(),this._copyTextureToTexture.dispose()}}Object.defineProperty(le.prototype,"fluidRenderer",{get:function(){return this._fluidRenderer},set:function(s){this._fluidRenderer=s},enumerable:!0,configurable:!0});le.prototype.enableFluidRenderer=function(){return this._fluidRenderer?this._fluidRenderer:(this._fluidRenderer=new rg(this),this._fluidRenderer)};le.prototype.disableFluidRenderer=function(){var s;(s=this._fluidRenderer)==null||s.dispose(),this._fluidRenderer=null};function V5(s){return!!s.particleSystem}function U5(s){return!!s.addBuffers}class k5{constructor(e){this.name=se.NAME_FLUIDRENDERER,this.scene=e}register(){this.scene._gatherActiveCameraRenderTargetsStage.registerStep(se.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER,this,this._gatherActiveCameraRenderTargets),this.scene._afterCameraDrawStage.registerStep(se.STEP_AFTERCAMERADRAW_FLUIDRENDERER,this,this._afterCameraDraw)}_gatherActiveCameraRenderTargets(e){var t;(t=this.scene.fluidRenderer)==null||t._prepareRendering()}_afterCameraDraw(e){var t;(t=this.scene.fluidRenderer)==null||t._render(e)}rebuild(){const e=this.scene.fluidRenderer;if(!e)return;const t=new Set;for(let i=0;i<e.renderObjects.length;++i){const r=e.renderObjects[i].object;if(U5(r)){const n=r.vertexBuffers;for(const a in n)t.add(n[a].getWrapperBuffer())}}t.forEach(i=>{i._rebuild()})}dispose(){this.scene.disableFluidRenderer()}}class rg{static _SceneComponentInitialization(e){let t=e._getComponent(se.NAME_FLUIDRENDERER);t||(t=new k5(e),e._addComponent(t))}get shaderLanguage(){return this._shaderLanguage}constructor(e){this._shaderLanguage=0,this._scene=e,this._engine=e.getEngine(),this._onEngineResizeObserver=null,this.renderObjects=[],this.targetRenderers=[],this._cameras=new Map,rg._SceneComponentInitialization(this._scene),this._onEngineResizeObserver=this._engine.onResizeObservable.add(()=>{this._initialize()}),this._engine.isWebGPU&&(this._shaderLanguage=1)}recreate(){this._sortRenderingObjects(),this._initialize()}getRenderObjectFromParticleSystem(e){const t=this._getParticleSystemIndex(e);return t!==-1?this.renderObjects[t]:null}addParticleSystem(e,t,i,r){const n=new L5(this._scene,e,this._shaderLanguage);n.onParticleSizeChanged.add(()=>this._setParticleSizeForRenderTargets()),i||(i=new _C(this._scene,r,this._shaderLanguage),this.targetRenderers.push(i)),i._onUseVelocityChanged.hasObservers()||i._onUseVelocityChanged.add(()=>this._setUseVelocityForRenderObject()),t!==void 0&&(i.generateDiffuseTexture=t);const a={object:n,targetRenderer:i};return this.renderObjects.push(a),this._sortRenderingObjects(),this._setParticleSizeForRenderTargets(),a}addCustomParticles(e,t,i,r,n){const a=new w5(this._scene,e,t,this._shaderLanguage);a.onParticleSizeChanged.add(()=>this._setParticleSizeForRenderTargets()),r||(r=new _C(this._scene,n,this._shaderLanguage),this.targetRenderers.push(r)),r._onUseVelocityChanged.hasObservers()||r._onUseVelocityChanged.add(()=>this._setUseVelocityForRenderObject()),i!==void 0&&(r.generateDiffuseTexture=i);const o={object:a,targetRenderer:r};return this.renderObjects.push(o),this._sortRenderingObjects(),this._setParticleSizeForRenderTargets(),o}removeRenderObject(e,t=!0){const i=this.renderObjects.indexOf(e);return i===-1?!1:(e.object.dispose(),this.renderObjects.splice(i,1),t&&this._removeUnusedTargetRenderers()?this._initialize():this._setParticleSizeForRenderTargets(),!0)}_sortRenderingObjects(){this.renderObjects.sort((e,t)=>e.object.priority<t.object.priority?-1:e.object.priority>t.object.priority?1:0)}_removeUnusedTargetRenderers(){const e={};for(let r=0;r<this.renderObjects.length;++r){const n=this.renderObjects[r].targetRenderer;e[this.targetRenderers.indexOf(n)]=!0}let t=!1;const i=[];for(let r=0;r<this.targetRenderers.length;++r)e[r]?i.push(this.targetRenderers[r]):(this.targetRenderers[r].dispose(),t=!0);return t&&(this.targetRenderers.length=0,this.targetRenderers.push(...i)),t}_getParticleSystemIndex(e){for(let t=0;t<this.renderObjects.length;++t){const i=this.renderObjects[t].object;if(V5(i)&&i.particleSystem===e)return t}return-1}_initialize(){for(let i=0;i<this.targetRenderers.length;++i)this.targetRenderers[i].dispose();const e=new Map;for(let i=0;i<this.targetRenderers.length;++i){const r=this.targetRenderers[i];if(r._initialize(),r.camera&&r._renderPostProcess){let n=e.get(r.camera);n||(n=[[],{}],e.set(r.camera,n)),n[0].push(r),r.camera.attachPostProcess(r._renderPostProcess,i)}}let t=e.keys();for(let i=t.next();i.done!==!0;i=t.next()){const r=i.value,n=e.get(r),a=r._getFirstPostProcess();if(!a)continue;const[o,l]=n;a.onSizeChangedObservable.add(()=>{var c;a.inputTexture.depthStencilTexture||a.inputTexture.createDepthStencilTexture(0,!0,this._engine.isStencilEnable,o[0].samples,this._engine.isStencilEnable?13:14,`PostProcessRTTDepthStencil-${a.name}`);for(const u of o){const h=(c=u._thicknessRenderTarget)==null?void 0:c.renderTarget,d=h==null?void 0:h.texture;if(h&&d){const f=d.width+"_"+d.height;let m=l[f];m||(m=l[f]=new B5(this._engine,d.width,d.height)),m.depthRTWrapper.shareDepth(h)}}})}t=this._cameras.keys();for(let i=t.next();i.done!==!0;i=t.next()){const r=i.value,a=this._cameras.get(r)[1],o=e.get(r);if(o)for(const l in a)o[1][l]||a[l].dispose();else for(const l in a)a[l].dispose()}this._cameras.clear(),this._cameras=e,this._setParticleSizeForRenderTargets()}_setParticleSizeForRenderTargets(){const e=new Map;for(let t=0;t<this.renderObjects.length;++t){const i=this.renderObjects[t];let r=e.get(i.targetRenderer);r===void 0&&(r=0),e.set(i.targetRenderer,Math.max(r,i.object.particleSize))}e.forEach((t,i)=>{i._depthRenderTarget&&(i._depthRenderTarget.particleSize=t)})}_setUseVelocityForRenderObject(){for(const e of this.renderObjects)e.object.useVelocity=e.targetRenderer.useVelocity}_prepareRendering(){for(const e of this.targetRenderers)if(e.needInitialization){this._initialize();return}}_render(e){var i;for(let r=0;r<this.targetRenderers.length;++r)(!e||this.targetRenderers[r].camera===e)&&this.targetRenderers[r]._clearTargets();const t=this._cameras.keys();for(let r=t.next();r.done!==!0;r=t.next()){const n=r.value,a=this._cameras.get(n);if(e&&n!==e)continue;const o=n._getFirstPostProcess();if(!o)continue;const l=(i=o.inputTexture)==null?void 0:i.depthStencilTexture;if(l){const[c,u]=a;for(const h of c)h._bgDepthTexture=l;for(const h in u)u[h].copy(l)}}for(let r=0;r<this.renderObjects.length;++r){const n=this.renderObjects[r];(!e||n.targetRenderer.camera===e)&&n.targetRenderer._render(n.object)}}dispose(){this._engine.onResizeObservable.remove(this._onEngineResizeObserver),this._onEngineResizeObserver=null;for(let e=0;e<this.renderObjects.length;++e)this.renderObjects[e].object.dispose();for(let e=0;e<this.targetRenderers.length;++e)this.targetRenderers[e].dispose();this._cameras.forEach(e=>{const t=e[1];for(const i in t)t[i].dispose()}),this.renderObjects.length=0,this.targetRenderers.length=0,this._cameras.clear()}}const Ap="fluidRenderingParticleDepthVertexShader",oO=`attribute vec3 position;attribute vec2 offset;uniform mat4 view;uniform mat4 projection;uniform vec2 size;varying vec2 uv;varying vec3 viewPos;varying float sphereRadius;
#ifdef FLUIDRENDERING_VELOCITY
attribute vec3 velocity;varying float velocityNorm;
#endif
void main(void) {vec3 cornerPos;cornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;cornerPos.z=0.0;viewPos=(view*vec4(position,1.0)).xyz;gl_Position=projection*vec4(viewPos+cornerPos,1.0);uv=offset;sphereRadius=size.x/2.0;
#ifdef FLUIDRENDERING_VELOCITY
velocityNorm=length(velocity);
#endif
}
`;S.ShadersStore[Ap]||(S.ShadersStore[Ap]=oO);const G5={name:Ap,shader:oO},z5=Object.freeze(Object.defineProperty({__proto__:null,fluidRenderingParticleDepthVertexShader:G5},Symbol.toStringTag,{value:"Module"})),Pp="fluidRenderingParticleDepthPixelShader",lO=`uniform mat4 projection;varying vec2 uv;varying vec3 viewPos;varying float sphereRadius;
#ifdef FLUIDRENDERING_VELOCITY
varying float velocityNorm;
#endif
void main(void) {vec3 normal;normal.xy=uv*2.0-1.0;float r2=dot(normal.xy,normal.xy);if (r2>1.0) discard;normal.z=sqrt(1.0-r2);
#ifndef FLUIDRENDERING_RHS
normal.z=-normal.z;
#endif
vec4 realViewPos=vec4(viewPos+normal*sphereRadius,1.0);vec4 clipSpacePos=projection*realViewPos;
#ifdef WEBGPU
gl_FragDepth=clipSpacePos.z/clipSpacePos.w;
#else
gl_FragDepth=(clipSpacePos.z/clipSpacePos.w)*0.5+0.5;
#endif
#ifdef FLUIDRENDERING_RHS
realViewPos.z=-realViewPos.z;
#endif
#ifdef FLUIDRENDERING_VELOCITY
glFragColor=vec4(realViewPos.z,velocityNorm,0.,1.);
#else
glFragColor=vec4(realViewPos.z,0.,0.,1.);
#endif
}
`;S.ShadersStore[Pp]||(S.ShadersStore[Pp]=lO);const W5={name:Pp,shader:lO},H5=Object.freeze(Object.defineProperty({__proto__:null,fluidRenderingParticleDepthPixelShader:W5},Symbol.toStringTag,{value:"Module"})),Op="fluidRenderingParticleThicknessVertexShader",cO=`attribute vec3 position;attribute vec2 offset;uniform mat4 view;uniform mat4 projection;uniform vec2 size;varying vec2 uv;void main(void) {vec3 cornerPos;cornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;cornerPos.z=0.0;vec3 viewPos=(view*vec4(position,1.0)).xyz+cornerPos;gl_Position=projection*vec4(viewPos,1.0);uv=offset;}
`;S.ShadersStore[Op]||(S.ShadersStore[Op]=cO);const $5={name:Op,shader:cO},X5=Object.freeze(Object.defineProperty({__proto__:null,fluidRenderingParticleThicknessVertexShader:$5},Symbol.toStringTag,{value:"Module"})),Np="fluidRenderingParticleThicknessPixelShader",uO=`uniform float particleAlpha;varying vec2 uv;void main(void) {vec3 normal;normal.xy=uv*2.0-1.0;float r2=dot(normal.xy,normal.xy);if (r2>1.0) discard;float thickness=sqrt(1.0-r2);glFragColor=vec4(vec3(particleAlpha*thickness),1.0);}
`;S.ShadersStore[Np]||(S.ShadersStore[Np]=uO);const Y5={name:Np,shader:uO},j5=Object.freeze(Object.defineProperty({__proto__:null,fluidRenderingParticleThicknessPixelShader:Y5},Symbol.toStringTag,{value:"Module"})),gC="fluidRenderingParticleDiffuseVertexShader",q5=`attribute vec3 position;attribute vec2 offset;attribute vec4 color;uniform mat4 view;uniform mat4 projection;uniform vec2 size;varying vec2 uv;varying vec3 diffuseColor;void main(void) {vec3 cornerPos;cornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;cornerPos.z=0.0;vec3 viewPos=(view*vec4(position,1.0)).xyz+cornerPos;gl_Position=projection*vec4(viewPos,1.0);uv=offset;diffuseColor=color.rgb;}
`;S.ShadersStore[gC]||(S.ShadersStore[gC]=q5);const Dp="fluidRenderingParticleDiffusePixelShader",hO=`uniform float particleAlpha;varying vec2 uv;varying vec3 diffuseColor;void main(void) {vec3 normal;normal.xy=uv*2.0-1.0;float r2=dot(normal.xy,normal.xy);if (r2>1.0) discard;glFragColor=vec4(diffuseColor,1.0);}
`;S.ShadersStore[Dp]||(S.ShadersStore[Dp]=hO);const Z5={name:Dp,shader:hO},Q5=Object.freeze(Object.defineProperty({__proto__:null,fluidRenderingParticleDiffusePixelShader:Z5},Symbol.toStringTag,{value:"Module"})),Mp="fluidRenderingBilateralBlurPixelShader",dO=`uniform sampler2D textureSampler;uniform int maxFilterSize;uniform vec2 blurDir;uniform float projectedParticleConstant;uniform float depthThreshold;varying vec2 vUV;void main(void) {float depth=textureLod(textureSampler,vUV,0.).x;if (depth>=1e6 || depth<=0.) {glFragColor=vec4(vec3(depth),1.);return;}
int filterSize=min(maxFilterSize,int(ceil(projectedParticleConstant/depth)));float sigma=float(filterSize)/3.0;float two_sigma2=2.0*sigma*sigma;float sigmaDepth=depthThreshold/3.0;float two_sigmaDepth2=2.0*sigmaDepth*sigmaDepth;float sum=0.;float wsum=0.;float sumVel=0.;for (int x=-filterSize; x<=filterSize; ++x) {vec2 coords=vec2(x);vec2 sampleDepthVel=textureLod(textureSampler,vUV+coords*blurDir,0.).rg;float r=dot(coords,coords);float w=exp(-r/two_sigma2);float rDepth=sampleDepthVel.r-depth;float wd=exp(-rDepth*rDepth/two_sigmaDepth2);sum+=sampleDepthVel.r*w*wd;sumVel+=sampleDepthVel.g*w*wd;wsum+=w*wd;}
glFragColor=vec4(sum/wsum,sumVel/wsum,0.,1.);}
`;S.ShadersStore[Mp]||(S.ShadersStore[Mp]=dO);const K5={name:Mp,shader:dO},SC=Object.freeze(Object.defineProperty({__proto__:null,fluidRenderingBilateralBlurPixelShader:K5},Symbol.toStringTag,{value:"Module"})),Fp="fluidRenderingStandardBlurPixelShader",fO=`uniform sampler2D textureSampler;uniform int filterSize;uniform vec2 blurDir;varying vec2 vUV;void main(void) {vec4 s=textureLod(textureSampler,vUV,0.);if (s.r==0.) {glFragColor=vec4(0.,0.,0.,1.);return;}
float sigma=float(filterSize)/3.0;float twoSigma2=2.0*sigma*sigma;vec4 sum=vec4(0.);float wsum=0.;for (int x=-filterSize; x<=filterSize; ++x) {vec2 coords=vec2(x);vec4 sampl=textureLod(textureSampler,vUV+coords*blurDir,0.);float w=exp(-coords.x*coords.x/twoSigma2);sum+=sampl*w;wsum+=w;}
sum/=wsum;glFragColor=vec4(sum.rgb,1.);}
`;S.ShadersStore[Fp]||(S.ShadersStore[Fp]=fO);const J5={name:Fp,shader:fO},vC=Object.freeze(Object.defineProperty({__proto__:null,fluidRenderingStandardBlurPixelShader:J5},Symbol.toStringTag,{value:"Module"})),Lp="fluidRenderingRenderPixelShader",pO=`#define DISABLE_UNIFORMITY_ANALYSIS
#define IOR 1.333
#define ETA 1.0/IOR
#define F0 0.02
uniform sampler2D textureSampler;uniform sampler2D depthSampler;
#ifdef FLUIDRENDERING_DIFFUSETEXTURE
uniform sampler2D diffuseSampler;
#else
uniform vec3 diffuseColor;
#endif
#ifdef FLUIDRENDERING_FIXED_THICKNESS
uniform float thickness;uniform sampler2D bgDepthSampler;
#else
uniform float minimumThickness;uniform sampler2D thicknessSampler;
#endif
#ifdef FLUIDRENDERING_ENVIRONMENT
uniform samplerCube reflectionSampler;
#endif
#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)
uniform sampler2D debugSampler;
#endif
uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform mat4 invProjectionMatrix;uniform vec2 texelSize;uniform vec3 dirLight;uniform float cameraFar;uniform float density;uniform float refractionStrength;uniform float fresnelClamp;uniform float specularPower;varying vec2 vUV;vec3 computeViewPosFromUVDepth(vec2 texCoord,float depth) {vec4 ndc;ndc.xy=texCoord*2.0-1.0;
#ifdef FLUIDRENDERING_RHS
ndc.z=-projectionMatrix[2].z+projectionMatrix[3].z/depth;
#else
ndc.z=projectionMatrix[2].z+projectionMatrix[3].z/depth;
#endif
ndc.w=1.0;vec4 eyePos=invProjectionMatrix*ndc;eyePos.xyz/=eyePos.w;return eyePos.xyz;}
vec3 getViewPosFromTexCoord(vec2 texCoord) {float depth=textureLod(depthSampler,texCoord,0.).x;return computeViewPosFromUVDepth(texCoord,depth);}
void main(void) {vec2 texCoord=vUV;
#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)
vec4 color=texture2D(debugSampler,texCoord);
#ifdef FLUIDRENDERING_DEBUG_DEPTH
glFragColor=vec4(color.rgb/vec3(2.0),1.);if (color.r>0.999 && color.g>0.999) {glFragColor=texture2D(textureSampler,texCoord);}
#else
glFragColor=vec4(color.rgb,1.);if (color.r<0.001 && color.g<0.001 && color.b<0.001) {glFragColor=texture2D(textureSampler,texCoord);}
#endif
return;
#endif
vec2 depthVel=textureLod(depthSampler,texCoord,0.).rg;float depth=depthVel.r;
#ifndef FLUIDRENDERING_FIXED_THICKNESS
float thickness=texture2D(thicknessSampler,texCoord).x;
#else
float bgDepth=texture2D(bgDepthSampler,texCoord).x;float depthNonLinear=projectionMatrix[2].z+projectionMatrix[3].z/depth;depthNonLinear=depthNonLinear*0.5+0.5;
#endif
vec4 backColor=texture2D(textureSampler,texCoord);
#ifndef FLUIDRENDERING_FIXED_THICKNESS
if (depth>=cameraFar || depth<=0. || thickness<=minimumThickness) {
#else
if (depth>=cameraFar || depth<=0. || bgDepth<=depthNonLinear) {
#endif
#ifdef FLUIDRENDERING_COMPOSITE_MODE
glFragColor.rgb=backColor.rgb*backColor.a;glFragColor.a=backColor.a;
#else
glFragColor=backColor;
#endif
return;}
vec3 viewPos=computeViewPosFromUVDepth(texCoord,depth);vec3 ddx=getViewPosFromTexCoord(texCoord+vec2(texelSize.x,0.))-viewPos;vec3 ddy=getViewPosFromTexCoord(texCoord+vec2(0.,texelSize.y))-viewPos;vec3 ddx2=viewPos-getViewPosFromTexCoord(texCoord+vec2(-texelSize.x,0.));if (abs(ddx.z)>abs(ddx2.z)) {ddx=ddx2;}
vec3 ddy2=viewPos-getViewPosFromTexCoord(texCoord+vec2(0.,-texelSize.y));if (abs(ddy.z)>abs(ddy2.z)) {ddy=ddy2;}
vec3 normal=normalize(cross(ddy,ddx));
#ifdef FLUIDRENDERING_RHS
normal=-normal;
#endif
#ifndef WEBGPU
if(isnan(normal.x) || isnan(normal.y) || isnan(normal.z) || isinf(normal.x) || isinf(normal.y) || isinf(normal.z)) {normal=vec3(0.,0.,-1.);}
#endif
#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_SHOWNORMAL)
glFragColor=vec4(normal*0.5+0.5,1.0);return;
#endif
vec3 rayDir=normalize(viewPos); 
#ifdef FLUIDRENDERING_DIFFUSETEXTURE
vec3 diffuseColor=textureLod(diffuseSampler,texCoord,0.0).rgb;
#endif
vec3 lightDir=normalize(vec3(viewMatrix*vec4(-dirLight,0.)));vec3 H =normalize(lightDir-rayDir);float specular=pow(max(0.0,dot(H,normal)),specularPower);
#ifdef FLUIDRENDERING_DEBUG_DIFFUSERENDERING
float diffuse =max(0.0,dot(lightDir,normal))*1.0;glFragColor=vec4(vec3(0.1) /*ambient*/+vec3(0.42,0.50,1.00)*diffuse+vec3(0,0,0.2)+specular,1.);return;
#endif
vec3 refractionDir=refract(rayDir,normal,ETA);vec4 transmitted=textureLod(textureSampler,vec2(texCoord+refractionDir.xy*thickness*refractionStrength),0.0);
#ifdef FLUIDRENDERING_COMPOSITE_MODE
if (transmitted.a==0.) transmitted.a=thickness;
#endif
vec3 transmittance=exp(-density*thickness*(1.0-diffuseColor)); 
vec3 refractionColor=transmitted.rgb*transmittance;
#ifdef FLUIDRENDERING_ENVIRONMENT
vec3 reflectionDir=reflect(rayDir,normal);vec3 reflectionColor=(textureCube(reflectionSampler,reflectionDir).rgb);float fresnel=clamp(F0+(1.0-F0)*pow(1.0-dot(normal,-rayDir),5.0),0.,fresnelClamp);vec3 finalColor=mix(refractionColor,reflectionColor,fresnel)+specular;
#else
vec3 finalColor=refractionColor+specular;
#endif
#ifdef FLUIDRENDERING_VELOCITY
float velocity=depthVel.g;finalColor=mix(finalColor,vec3(1.0),smoothstep(0.3,1.0,velocity/6.0));
#endif
glFragColor=vec4(finalColor,transmitted.a);}
`;S.ShadersStore[Lp]||(S.ShadersStore[Lp]=pO);const eY={name:Lp,shader:pO},tY=Object.freeze(Object.defineProperty({__proto__:null,fluidRenderingRenderPixelShader:eY},Symbol.toStringTag,{value:"Module"})),wp="fluidRenderingParticleDepthVertexShader",mO=`attribute position: vec3f;attribute offset: vec2f;uniform view: mat4x4f;uniform projection: mat4x4f;uniform size: vec2f;varying uv: vec2f;varying viewPos: vec3f;varying sphereRadius: f32;
#ifdef FLUIDRENDERING_VELOCITY
attribute velocity: vec3f;varying velocityNorm: f32;
#endif
@vertex
fn main(input: VertexInputs)->FragmentInputs {var cornerPos: vec3f=vec3f(
vec2f(input.offset.x-0.5,input.offset.y-0.5)*uniforms.size,
0.0
);vertexOutputs.viewPos=(uniforms.view*vec4f(input.position,1.0)).xyz;vertexOutputs.position=uniforms.projection*vec4f(vertexOutputs.viewPos+cornerPos,1.0);vertexOutputs.uv=input.offset;vertexOutputs.sphereRadius=uniforms.size.x/2.0;
#ifdef FLUIDRENDERING_VELOCITY
vertexOutputs.velocityNorm=length(velocity);
#endif
}
`;S.ShadersStoreWGSL[wp]||(S.ShadersStoreWGSL[wp]=mO);const iY={name:wp,shader:mO},rY=Object.freeze(Object.defineProperty({__proto__:null,fluidRenderingParticleDepthVertexShaderWGSL:iY},Symbol.toStringTag,{value:"Module"})),Bp="fluidRenderingParticleDepthPixelShader",_O=`uniform projection: mat4x4f;varying uv: vec2f;varying viewPos: vec3f;varying sphereRadius: f32;
#ifdef FLUIDRENDERING_VELOCITY
varying velocityNorm: f32;
#endif
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var normalxy: vec2f=input.uv*2.0-1.0;var r2: f32=dot(normalxy,normalxy);if (r2>1.0) {discard;}
var normal: vec3f=vec3f(normalxy,sqrt(1.0-r2));
#ifndef FLUIDRENDERING_RHS
normal.z=-normal.z;
#endif
var realViewPos: vec4f=vec4f(input.viewPos+normal*input.sphereRadius,1.0);var clipSpacePos: vec4f=uniforms.projection*realViewPos;fragmentOutputs.fragDepth=clipSpacePos.z/clipSpacePos.w;
#ifdef FLUIDRENDERING_RHS
realViewPos.z=-realViewPos.z;
#endif
#ifdef FLUIDRENDERING_VELOCITY
fragmentOutputs.color=vec4f(realViewPos.z,input.velocityNorm,0.,1.);
#else
fragmentOutputs.color=vec4f(realViewPos.z,0.,0.,1.);
#endif
}
`;S.ShadersStoreWGSL[Bp]||(S.ShadersStoreWGSL[Bp]=_O);const sY={name:Bp,shader:_O},nY=Object.freeze(Object.defineProperty({__proto__:null,fluidRenderingParticleDepthPixelShaderWGSL:sY},Symbol.toStringTag,{value:"Module"})),Vp="fluidRenderingParticleThicknessVertexShader",gO=`attribute position: vec3f;attribute offset: vec2f;uniform view: mat4x4f;uniform projection: mat4x4f;uniform size: vec2f;varying uv: vec2f;@vertex
fn main(input: VertexInputs)->FragmentInputs {var cornerPos: vec3f=vec3f(
vec2f(input.offset.x-0.5,input.offset.y-0.5)*uniforms.size,
0.0
);var viewPos: vec3f=(uniforms.view*vec4f(input.position,1.0)).xyz+cornerPos;vertexOutputs.position=uniforms.projection*vec4f(viewPos,1.0);vertexOutputs.uv=input.offset;}
`;S.ShadersStoreWGSL[Vp]||(S.ShadersStoreWGSL[Vp]=gO);const aY={name:Vp,shader:gO},oY=Object.freeze(Object.defineProperty({__proto__:null,fluidRenderingParticleThicknessVertexShaderWGSL:aY},Symbol.toStringTag,{value:"Module"})),Up="fluidRenderingParticleThicknessPixelShader",SO=`uniform particleAlpha: f32;varying uv: vec2f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var normalxy: vec2f=input.uv*2.0-1.0;var r2: f32=dot(normalxy,normalxy);if (r2>1.0) {discard;}
var thickness: f32=sqrt(1.0-r2);fragmentOutputs.color=vec4f(vec3f(uniforms.particleAlpha*thickness),1.0);}
`;S.ShadersStoreWGSL[Up]||(S.ShadersStoreWGSL[Up]=SO);const lY={name:Up,shader:SO},cY=Object.freeze(Object.defineProperty({__proto__:null,fluidRenderingParticleThicknessPixelShaderWGSL:lY},Symbol.toStringTag,{value:"Module"})),xC="fluidRenderingParticleDiffuseVertexShader",uY=`attribute position: vec3f;attribute offset: vec2f;attribute color: vec4f;uniform view: mat4x4f;uniform projection: mat4x4f;uniform size: vec2f;varying uv: vec2f;varying diffuseColor: vec3f;@vertex
fn main(input: VertexInputs)->FragmentInputs {var cornerPos: vec3f=vec3f(
vec2f(input.offset.x-0.5,input.offset.y-0.5)*uniforms.size,
0.0
);var viewPos: vec3f=(uniforms.view*vec4f(input.position,1.0)).xyz+cornerPos;vertexOutputs.position=uniforms.projection*vec4f(viewPos,1.0);vertexOutputs.uv=input.offset;vertexOutputs.diffuseColor=input.color.rgb;}
`;S.ShadersStoreWGSL[xC]||(S.ShadersStoreWGSL[xC]=uY);const kp="fluidRenderingParticleDiffusePixelShader",vO=`uniform particleAlpha: f32;varying uv: vec2f;varying diffuseColor: vec3f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var normalxy: vec2f=input.uv*2.0-1.0;var r2: f32=dot(normalxy,normalxy);if (r2>1.0) {discard;}
fragmentOutputs.color=vec4f(input.diffuseColor,1.0);}
`;S.ShadersStoreWGSL[kp]||(S.ShadersStoreWGSL[kp]=vO);const hY={name:kp,shader:vO},dY=Object.freeze(Object.defineProperty({__proto__:null,fluidRenderingParticleDiffusePixelShaderWGSL:hY},Symbol.toStringTag,{value:"Module"})),Gp="fluidRenderingBilateralBlurPixelShader",xO=`var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform maxFilterSize: i32;uniform blurDir: vec2f;uniform projectedParticleConstant: f32;uniform depthThreshold: f32;varying vUV: vec2f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var depth: f32=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.).x;if (depth>=1e6 || depth<=0.) {fragmentOutputs.color=vec4f(vec3f(depth),1.);return fragmentOutputs;}
var filterSize: i32=min(uniforms.maxFilterSize,i32(ceil(uniforms.projectedParticleConstant/depth)));var sigma: f32=f32(filterSize)/3.0;var two_sigma2: f32=2.0*sigma*sigma;var sigmaDepth: f32=uniforms.depthThreshold/3.0;var two_sigmaDepth2: f32=2.0*sigmaDepth*sigmaDepth;var sum: f32=0.;var wsum: f32=0.;var sumVel: f32=0.;for (var x: i32=-filterSize; x<=filterSize; x++) {var coords: vec2f=vec2f(f32(x));var sampleDepthVel: vec2f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV+coords*uniforms.blurDir,0.).rg;var r: f32=dot(coords,coords);var w: f32=exp(-r/two_sigma2);var rDepth: f32=sampleDepthVel.r-depth;var wd: f32=exp(-rDepth*rDepth/two_sigmaDepth2);sum+=sampleDepthVel.r*w*wd;sumVel+=sampleDepthVel.g*w*wd;wsum+=w*wd;}
fragmentOutputs.color=vec4f(sum/wsum,sumVel/wsum,0.,1.);}
`;S.ShadersStoreWGSL[Gp]||(S.ShadersStoreWGSL[Gp]=xO);const fY={name:Gp,shader:xO},EC=Object.freeze(Object.defineProperty({__proto__:null,fluidRenderingBilateralBlurPixelShaderWGSL:fY},Symbol.toStringTag,{value:"Module"})),zp="fluidRenderingStandardBlurPixelShader",EO=`var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform filterSize: i32;uniform blurDir: vec2f;varying vUV: vec2f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var s: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.);if (s.r==0.) {fragmentOutputs.color=vec4f(0.,0.,0.,1.);return fragmentOutputs;}
var sigma: f32=f32(uniforms.filterSize)/3.0;var twoSigma2: f32=2.0*sigma*sigma;var sum: vec4f=vec4f(0.);var wsum: f32=0.;for (var x: i32=-uniforms.filterSize; x<=uniforms.filterSize; x++) {var coords: vec2f=vec2f(f32(x));var sampl: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV+coords*uniforms.blurDir,0.);var w: f32=exp(-coords.x*coords.x/twoSigma2);sum+=sampl*w;wsum+=w;}
sum/=wsum;fragmentOutputs.color=vec4f(sum.rgb,1.);}
`;S.ShadersStoreWGSL[zp]||(S.ShadersStoreWGSL[zp]=EO);const pY={name:zp,shader:EO},TC=Object.freeze(Object.defineProperty({__proto__:null,fluidRenderingStandardBlurPixelShaderWGSL:pY},Symbol.toStringTag,{value:"Module"})),Wp="fluidRenderingRenderPixelShader",TO=`#define DISABLE_UNIFORMITY_ANALYSIS
#define IOR 1.333
#define ETA 1.0/IOR
#define F0 0.02
var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;
#ifdef FLUIDRENDERING_DIFFUSETEXTURE
var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;
#else
uniform diffuseColor: vec3f;
#endif
#ifdef FLUIDRENDERING_FIXED_THICKNESS
uniform thickness: f32;var bgDepthSamplerSampler: sampler;var bgDepthSampler: texture_2d<f32>;
#else
uniform minimumThickness: f32;var thicknessSamplerSampler: sampler;var thicknessSampler: texture_2d<f32>;
#endif
#ifdef FLUIDRENDERING_ENVIRONMENT
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_cube<f32>;
#endif
#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)
var debugSamplerSampler: sampler;var debugSampler: texture_2d<f32>;
#endif
uniform viewMatrix: mat4x4f;uniform projectionMatrix: mat4x4f;uniform invProjectionMatrix: mat4x4f;uniform texelSize: vec2f;uniform dirLight: vec3f;uniform cameraFar: f32;uniform density: f32;uniform refractionStrength: f32;uniform fresnelClamp: f32;uniform specularPower: f32;varying vUV: vec2f;fn computeViewPosFromUVDepth(texCoord: vec2f,depth: f32)->vec3f {var ndc: vec4f=vec4f(texCoord*2.0-1.0,0.0,1.0);
#ifdef FLUIDRENDERING_RHS
ndc.z=-uniforms.projectionMatrix[2].z+uniforms.projectionMatrix[3].z/depth;
#else
ndc.z=uniforms.projectionMatrix[2].z+uniforms.projectionMatrix[3].z/depth;
#endif
ndc.w=1.0;var eyePos: vec4f=uniforms.invProjectionMatrix*ndc;return eyePos.xyz/eyePos.w;}
fn getViewPosFromTexCoord(texCoord: vec2f)->vec3f {var depth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,texCoord,0.).x;return computeViewPosFromUVDepth(texCoord,depth);}
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var texCoord: vec2f=input.vUV;
#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)
var color: vec4f=textureSample(debugSampler,debugSamplerSampler,texCoord);
#ifdef FLUIDRENDERING_DEBUG_DEPTH
fragmentOutputs.color=vec4f(color.rgb/vec3f(2.0),1.);if (color.r>0.999 && color.g>0.999) {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,texCoord);}
#else
fragmentOutputs.color=vec4f(color.rgb,1.);if (color.r<0.001 && color.g<0.001 && color.b<0.001) {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,texCoord);}
#endif
return fragmentOutputs;
#endif
var depthVel: vec2f=textureSampleLevel(depthSampler,depthSamplerSampler,texCoord,0.).rg;var depth: f32=depthVel.r;
#ifndef FLUIDRENDERING_FIXED_THICKNESS
var thickness: f32=textureSample(thicknessSampler,thicknessSamplerSampler,texCoord).x;
#else
var thickness: f32=uniforms.thickness;var bgDepth: f32=textureSample(bgDepthSampler,bgDepthSamplerSampler,texCoord).x;var depthNonLinear: f32=uniforms.projectionMatrix[2].z+uniforms.projectionMatrix[3].z/depth;depthNonLinear=depthNonLinear*0.5+0.5;
#endif
var backColor: vec4f=textureSample(textureSampler,textureSamplerSampler,texCoord);
#ifndef FLUIDRENDERING_FIXED_THICKNESS
if (depth>=uniforms.cameraFar || depth<=0. || thickness<=uniforms.minimumThickness) {
#else
if (depth>=uniforms.cameraFar || depth<=0. || bgDepth<=depthNonLinear) {
#endif
#ifdef FLUIDRENDERING_COMPOSITE_MODE
fragmentOutputs.color=vec4f(backColor.rgb*backColor.a,backColor.a);
#else
fragmentOutputs.color=backColor;
#endif
return fragmentOutputs;}
var viewPos: vec3f=computeViewPosFromUVDepth(texCoord,depth);var ddx: vec3f=getViewPosFromTexCoord(texCoord+vec2f(uniforms.texelSize.x,0.))-viewPos;var ddy: vec3f=getViewPosFromTexCoord(texCoord+vec2f(0.,uniforms.texelSize.y))-viewPos;var ddx2: vec3f=viewPos-getViewPosFromTexCoord(texCoord+vec2f(-uniforms.texelSize.x,0.));if (abs(ddx.z)>abs(ddx2.z)) {ddx=ddx2;}
var ddy2: vec3f=viewPos-getViewPosFromTexCoord(texCoord+vec2f(0.,-uniforms.texelSize.y));if (abs(ddy.z)>abs(ddy2.z)) {ddy=ddy2;}
var normal: vec3f=normalize(cross(ddy,ddx));
#ifdef FLUIDRENDERING_RHS
normal=-normal;
#endif
#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_SHOWNORMAL)
fragmentOutputs.color=vec4f(normal*0.5+0.5,1.0);return fragmentOutputs;
#endif
var rayDir: vec3f=normalize(viewPos); 
#ifdef FLUIDRENDERING_DIFFUSETEXTURE
var diffuseColor: vec3f=textureSampleLevel(diffuseSampler,diffuseSamplerSampler,texCoord,0.0).rgb;
#else
var diffuseColor: vec3f=uniforms.diffuseColor;
#endif
var lightDir: vec3f=normalize((uniforms.viewMatrix*vec4f(-uniforms.dirLight,0.)).xyz);var H: vec3f =normalize(lightDir-rayDir);var specular: f32 =pow(max(0.0,dot(H,normal)),uniforms.specularPower);
#ifdef FLUIDRENDERING_DEBUG_DIFFUSERENDERING
var diffuse: f32 =max(0.0,dot(lightDir,normal))*1.0;fragmentOutputs.color=vec4f(vec3f(0.1) /*ambient*/+vec3f(0.42,0.50,1.00)*diffuse+vec3f(0,0,0.2)+specular,1.);return fragmentOutputs;
#endif
var refractionDir: vec3f=refract(rayDir,normal,ETA);var transmitted: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,vec2f(texCoord+refractionDir.xy*thickness*uniforms.refractionStrength),0.0);
#ifdef FLUIDRENDERING_COMPOSITE_MODE
if (transmitted.a==0.) {transmitted.a=thickness;}
#endif
var transmittance: vec3f=exp(-uniforms.density*thickness*(1.0-diffuseColor)); 
var refractionColor: vec3f=transmitted.rgb*transmittance;
#ifdef FLUIDRENDERING_ENVIRONMENT
var reflectionDir: vec3f=reflect(rayDir,normal);var reflectionColor: vec3f=(textureSample(reflectionSampler,reflectionSamplerSampler,reflectionDir).rgb);var fresnel: f32=clamp(F0+(1.0-F0)*pow(1.0-dot(normal,-rayDir),5.0),0.,uniforms.fresnelClamp);var finalColor: vec3f=mix(refractionColor,reflectionColor,fresnel)+specular;
#else
var finalColor: vec3f=refractionColor+specular;
#endif
#ifdef FLUIDRENDERING_VELOCITY
var velocity: f32=depthVel.g;finalColor=mix(finalColor,vec3f(1.0),smoothstep(0.3,1.0,velocity/6.0));
#endif
fragmentOutputs.color=vec4f(finalColor,transmitted.a);}
`;S.ShadersStoreWGSL[Wp]||(S.ShadersStoreWGSL[Wp]=TO);const mY={name:Wp,shader:TO},_Y=Object.freeze(Object.defineProperty({__proto__:null,fluidRenderingRenderPixelShaderWGSL:mY},Symbol.toStringTag,{value:"Module"}));class gY extends Oi{constructor(){super(...arguments),this.RSMCREATE=!1,this.RSMCREATE_PROJTEXTURE=!1,this.RSMCREATE_LIGHT_IS_SPOT=!1}}class nl extends Er{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e){super(e,nl.Name,300,new gY),this._lightColor=new q,this._hasProjectionTexture=!1,this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._varAlbedoName=e instanceof Ve?"surfaceAlbedo":"baseColor.rgb"}prepareDefines(e){e.RSMCREATE=this._isEnabled,this._hasProjectionTexture=!1;const t=this.light.getTypeID()===Xs.LIGHTTYPEID_SPOTLIGHT;if(t){const i=this.light;this._hasProjectionTexture=i.projectionTexture?i.projectionTexture.isReady():!1}e.RSMCREATE_PROJTEXTURE=this._hasProjectionTexture,e.RSMCREATE_LIGHT_IS_SPOT=t,e.SCENE_MRT_COUNT=3}getClassName(){return"RSMCreatePluginMaterial"}getUniforms(){return{ubo:[{name:"rsmTextureProjectionMatrix",size:16,type:"mat4"},{name:"rsmSpotInfo",size:4,type:"vec4"},{name:"rsmLightColor",size:3,type:"vec3"},{name:"rsmLightPosition",size:3,type:"vec3"}],fragment:`#ifdef RSMCREATE
                    uniform mat4 rsmTextureProjectionMatrix;
                    uniform vec4 rsmSpotInfo;
                    uniform vec3 rsmLightColor;
                    uniform vec3 rsmLightPosition;
                #endif`}}getSamplers(e){e.push("rsmTextureProjectionSampler")}bindForSubMesh(e){if(this._isEnabled&&(this.light.diffuse.scaleToRef(this.light.getScaledIntensity(),this._lightColor),e.updateColor3("rsmLightColor",this._lightColor),this.light.getTypeID()===Xs.LIGHTTYPEID_SPOTLIGHT)){const t=this.light;this._hasProjectionTexture&&(e.updateMatrix("rsmTextureProjectionMatrix",t.projectionTextureMatrix),e.setTexture("rsmTextureProjectionSampler",t.projectionTexture));const i=G.Vector3[0];t.computeTransformedInformation()?(e.updateFloat3("rsmLightPosition",this.light.transformedPosition.x,this.light.transformedPosition.y,this.light.transformedPosition.z),t.transformedDirection.normalizeToRef(i)):(e.updateFloat3("rsmLightPosition",this.light.position.x,this.light.position.y,this.light.position.z),t.direction.normalizeToRef(i)),e.updateFloat4("rsmSpotInfo",i.x,i.y,i.z,Math.cos(t.angle*.5))}}getCustomCode(e,t){return e==="vertex"?null:t===1?{CUSTOM_FRAGMENT_DEFINITIONS:`
                #ifdef RSMCREATE
                    #ifdef RSMCREATE_PROJTEXTURE
                        var rsmTextureProjectionSamplerSampler: sampler;
                        var rsmTextureProjectionSampler: texture_2d<f32>;
                    #endif
                #endif
            `,CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR:`
                #ifdef RSMCREATE
                    var rsmColor = ${this._varAlbedoName} * uniforms.rsmLightColor;
                    #ifdef RSMCREATE_PROJTEXTURE
                    {
                        var strq = uniforms.rsmTextureProjectionMatrix * vec4f(fragmentInputs.vPositionW, 1.0);
                        strq /= strq.w;
                        rsmColor *= textureSample(rsmTextureProjectionSampler, rsmTextureProjectionSamplerSampler, strq.xy).rgb;
                    }
                    #endif
                    #ifdef RSMCREATE_LIGHT_IS_SPOT
                    {
                        var cosAngle = max(0., dot(uniforms.rsmSpotInfo.xyz, normalize(fragmentInputs.vPositionW - uniforms.rsmLightPosition)));
                        rsmColor = sign(cosAngle - uniforms.rsmSpotInfo.w) * rsmColor;
                    }
                    #endif

                    #define MRT_AND_COLOR
                    fragmentOutputs.fragData0 = vec4f(fragmentInputs.vPositionW, 1.);
                    fragmentOutputs.fragData1 = vec4f(normalize(normalW) * 0.5 + 0.5, 1.);
                    fragmentOutputs.fragData2 = vec4f(rsmColor, 1.);
                #endif
            `}:{CUSTOM_FRAGMENT_BEGIN:`
                #ifdef RSMCREATE
                    #extension GL_EXT_draw_buffers : require
                #endif
            `,CUSTOM_FRAGMENT_DEFINITIONS:`
                #ifdef RSMCREATE
                    #ifdef RSMCREATE_PROJTEXTURE
                        uniform highp sampler2D rsmTextureProjectionSampler;                    
                    #endif
                    layout(location = 0) out highp vec4 glFragData[3];
                    vec4 glFragColor;
                #endif
            `,CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR:`
                #ifdef RSMCREATE
                    vec3 rsmColor = ${this._varAlbedoName} * rsmLightColor;
                    #ifdef RSMCREATE_PROJTEXTURE
                    {
                        vec4 strq = rsmTextureProjectionMatrix * vec4(vPositionW, 1.0);
                        strq /= strq.w;
                        rsmColor *= texture2D(rsmTextureProjectionSampler, strq.xy).rgb;
                    }
                    #endif
                    #ifdef RSMCREATE_LIGHT_IS_SPOT
                    {
                        float cosAngle = max(0., dot(rsmSpotInfo.xyz, normalize(vPositionW - rsmLightPosition)));
                        rsmColor = sign(cosAngle - rsmSpotInfo.w) * rsmColor;
                    }
                    #endif
                    glFragData[0] = vec4(vPositionW, 1.);
                    glFragData[1] = vec4(normalize(normalW) * 0.5 + 0.5, 1.);
                    glFragData[2] = vec4(rsmColor, 1.);
                #endif
            `}}}nl.Name="RSMCreate";_([R()],nl.prototype,"light",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],nl.prototype,"isEnabled",void 0);y("BABYLON.RSMCreatePluginMaterial",nl);class SY extends Oi{constructor(){super(...arguments),this.RENDER_WITH_GIRSM=!1,this.RSMCREATE_PROJTEXTURE=!1}}class Jn extends Er{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e){super(e,Jn.Name,310,new SY),this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._isPBR=e instanceof Ve}prepareDefines(e){e.RENDER_WITH_GIRSM=this._isEnabled}getClassName(){return"GIRSMRenderPluginMaterial"}getUniforms(){return{ubo:[{name:"girsmTextureOutputSize",size:2,type:"vec2"}],fragment:`#ifdef RENDER_WITH_GIRSM
                    uniform vec2 girsmTextureOutputSize;
                #endif`}}getSamplers(e){e.push("girsmTextureGIContrib")}bindForSubMesh(e){this._isEnabled&&(e.bindTexture("girsmTextureGIContrib",this.textureGIContrib),e.updateFloat2("girsmTextureOutputSize",this.outputTextureWidth,this.outputTextureHeight))}getCustomCode(e,t){let i;return t===1?(i={CUSTOM_FRAGMENT_DEFINITIONS:`
                #ifdef RENDER_WITH_GIRSM
                    var girsmTextureGIContribSampler: sampler;
                    var girsmTextureGIContrib: texture_2d<f32>;

                    fn computeIndirect() -> vec3f {
                        var uv = fragmentInputs.position.xy / uniforms.girsmTextureOutputSize;
                        return textureSample(girsmTextureGIContrib, girsmTextureGIContribSampler, uv).rgb;
                    }
                #endif
            `,CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION:`
                #ifdef RENDER_WITH_GIRSM
                    finalDiffuse += computeIndirect() * surfaceAlbedo.rgb;
                #endif
            `},this._isPBR||(i.CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR=`
                #ifdef RENDER_WITH_GIRSM
                    color = vec4f(color.rgb + computeIndirect() * baseColor.rgb, color.a);
                #endif
            `)):(i={CUSTOM_FRAGMENT_DEFINITIONS:`
                #ifdef RENDER_WITH_GIRSM
                    uniform sampler2D girsmTextureGIContrib;

                    vec3 computeIndirect() {
                        vec2 uv = gl_FragCoord.xy / girsmTextureOutputSize;
                        return texture2D(girsmTextureGIContrib, uv).rgb;
                    }
                #endif
            `,CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION:`
                #ifdef RENDER_WITH_GIRSM
                    finalDiffuse += computeIndirect() * surfaceAlbedo.rgb;
                #endif
            `},this._isPBR||(i.CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR=`
                #ifdef RENDER_WITH_GIRSM
                    color.rgb += computeIndirect() * baseColor.rgb;
                #endif
            `)),e==="vertex"?null:i}}Jn.Name="GIRSMRender";_([R()],Jn.prototype,"textureGIContrib",void 0);_([R()],Jn.prototype,"outputTextureWidth",void 0);_([R()],Jn.prototype,"outputTextureHeight",void 0);_([R(),W("_markAllSubMeshesAsTexturesDirty")],Jn.prototype,"isEnabled",void 0);y("BABYLON.GIRSMRenderPluginMaterial",Jn);const bC="bilateralBlurPixelShader",vY=`uniform sampler2D textureSampler;uniform sampler2D depthSampler;uniform sampler2D normalSampler;uniform int filterSize;uniform vec2 blurDir;uniform float depthThreshold;uniform float normalThreshold;varying vec2 vUV;void main(void) {vec3 color=textureLod(textureSampler,vUV,0.).rgb;float depth=textureLod(depthSampler,vUV,0.).x;if (depth>=1e6 || depth<=0.) {glFragColor=vec4(color,1.);return;}
vec3 normal=textureLod(normalSampler,vUV,0.).rgb;
#ifdef DECODE_NORMAL
normal=normal*2.0-1.0;
#endif
float sigma=float(filterSize);float two_sigma2=2.0*sigma*sigma;float sigmaDepth=depthThreshold;float two_sigmaDepth2=2.0*sigmaDepth*sigmaDepth;float sigmaNormal=normalThreshold;float two_sigmaNormal2=2.0*sigmaNormal*sigmaNormal;vec3 sum=vec3(0.);float wsum=0.;for (int x=-filterSize; x<=filterSize; ++x) {vec2 coords=vec2(x);vec3 sampleColor=textureLod(textureSampler,vUV+coords*blurDir,0.).rgb;float sampleDepth=textureLod(depthSampler,vUV+coords*blurDir,0.).r;vec3 sampleNormal=textureLod(normalSampler,vUV+coords*blurDir,0.).rgb;
#ifdef DECODE_NORMAL
sampleNormal=sampleNormal*2.0-1.0;
#endif
float r=dot(coords,coords);float w=exp(-r/two_sigma2);float depthDelta=abs(sampleDepth-depth);float wd=step(depthDelta,depthThreshold);vec3 normalDelta=abs(sampleNormal-normal);float wn=step(normalDelta.x+normalDelta.y+normalDelta.z,normalThreshold);sum+=sampleColor*w*wd*wn;wsum+=w*wd*wn;}
glFragColor=vec4(sum/wsum,1.);}
`;S.ShadersStore[bC]||(S.ShadersStore[bC]=vY);const CC="bilateralBlurQualityPixelShader",xY=`uniform sampler2D textureSampler;uniform sampler2D depthSampler;uniform sampler2D normalSampler;uniform int filterSize;uniform vec2 blurDir;uniform float depthThreshold;uniform float normalThreshold;varying vec2 vUV;void main(void) {vec3 color=textureLod(textureSampler,vUV,0.).rgb;float depth=textureLod(depthSampler,vUV,0.).x;if (depth>=1e6 || depth<=0.) {glFragColor=vec4(color,1.);return;}
vec3 normal=textureLod(normalSampler,vUV,0.).rgb;
#ifdef DECODE_NORMAL
normal=normal*2.0-1.0;
#endif
float sigma=float(filterSize);float two_sigma2=2.0*sigma*sigma;float sigmaDepth=depthThreshold;float two_sigmaDepth2=2.0*sigmaDepth*sigmaDepth;float sigmaNormal=normalThreshold;float two_sigmaNormal2=2.0*sigmaNormal*sigmaNormal;vec3 sum=vec3(0.);float wsum=0.;for (int x=-filterSize; x<=filterSize; ++x) {for (int y=-filterSize; y<=filterSize; ++y) {vec2 coords=vec2(x,y)*blurDir;vec3 sampleColor=textureLod(textureSampler,vUV+coords,0.).rgb;float sampleDepth=textureLod(depthSampler,vUV+coords,0.).r;vec3 sampleNormal=textureLod(normalSampler,vUV+coords,0.).rgb;
#ifdef DECODE_NORMAL
sampleNormal=sampleNormal*2.0-1.0;
#endif
float r=dot(coords,coords);float w=exp(-r/two_sigma2);float rDepth=sampleDepth-depth;float wd=exp(-rDepth*rDepth/two_sigmaDepth2);float rNormal=abs(sampleNormal.x-normal.x)+abs(sampleNormal.y-normal.y)+abs(sampleNormal.z-normal.z);float wn=exp(-rNormal*rNormal/two_sigmaNormal2);sum+=sampleColor*w*wd*wn;wsum+=w*wd*wn;}}
glFragColor=vec4(sum/wsum,1.);}
`;S.ShadersStore[CC]||(S.ShadersStore[CC]=xY);const yC="rsmGlobalIlluminationPixelShader",EY=`/**
* The implementation is an application of the formula found in http:
* For better results,it also adds a random (noise) rotation to the RSM samples (the noise artifacts are easier to remove than the banding artifacts).
*/
precision highp float;varying vec2 vUV;uniform mat4 rsmLightMatrix;uniform vec4 rsmInfo;uniform vec4 rsmInfo2;uniform sampler2D textureSampler;uniform sampler2D normalSampler;uniform sampler2D rsmPositionW;uniform sampler2D rsmNormalW;uniform sampler2D rsmFlux;uniform sampler2D rsmSamples;
#ifdef TRANSFORM_NORMAL
uniform mat4 invView;
#endif
float mod289(float x){return x-floor(x*(1.0/289.0))*289.0;}
vec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}
vec4 perm(vec4 x){return mod289(((x*34.0)+1.0)*x);}
float noise(vec3 p){vec3 a=floor(p);vec3 d=p-a;d=d*d*(3.0-2.0*d);vec4 b=a.xxyy+vec4(0.0,1.0,0.0,1.0);vec4 k1=perm(b.xyxy);vec4 k2=perm(k1.xyxy+b.zzww);vec4 c=k2+a.zzzz;vec4 k3=perm(c);vec4 k4=perm(c+1.0);vec4 o1=fract(k3*(1.0/41.0));vec4 o2=fract(k4*(1.0/41.0));vec4 o3=o2*d.z+o1*(1.0-d.z);vec2 o4=o3.yw*d.x+o3.xz*(1.0-d.x);return o4.y*d.y+o4.x*(1.0-d.y);}
vec3 computeIndirect(vec3 p,vec3 n) {vec3 indirectDiffuse=vec3(0.);int numSamples=int(rsmInfo.x);float radius=rsmInfo.y;float intensity=rsmInfo.z;float edgeArtifactCorrection=rsmInfo.w;vec4 texRSM=rsmLightMatrix*vec4(p,1.);texRSM.xy/=texRSM.w;texRSM.xy=texRSM.xy*0.5+0.5;float angle=noise(p*rsmInfo2.x);float c=cos(angle);float s=sin(angle);for (int i=0; i<numSamples; i++) {vec3 rsmSample=texelFetch(rsmSamples,ivec2(i,0),0).xyz;float weightSquare=rsmSample.z;if (rsmInfo2.y==1.0) rsmSample.xy=vec2(rsmSample.x*c+rsmSample.y*s,-rsmSample.x*s+rsmSample.y*c);vec2 uv=texRSM.xy+rsmSample.xy*radius;if (uv.x<0. || uv.x>1. || uv.y<0. || uv.y>1.) continue;vec3 vplPositionW=textureLod(rsmPositionW,uv,0.).xyz;vec3 vplNormalW=textureLod(rsmNormalW,uv,0.).xyz*2.0-1.0;vec3 vplFlux=textureLod(rsmFlux,uv,0.).rgb;vplPositionW-=vplNormalW*edgeArtifactCorrection; 
float dist2=dot(vplPositionW-p,vplPositionW-p);indirectDiffuse+=vplFlux*weightSquare*max(0.,dot(n,vplPositionW-p))*max(0.,dot(vplNormalW,p-vplPositionW))/(dist2*dist2);}
return clamp(indirectDiffuse*intensity,0.0,1.0);}
void main(void) 
{vec3 positionW=texture2D(textureSampler,vUV).xyz;vec3 normalW=texture2D(normalSampler,vUV).xyz;
#ifdef DECODE_NORMAL
normalW=normalW*2.0-1.0;
#endif
#ifdef TRANSFORM_NORMAL
normalW=(invView*vec4(normalW,0.)).xyz;
#endif
gl_FragColor.rgb=computeIndirect(positionW,normalW);gl_FragColor.a=1.0;}
`;S.ShadersStore[yC]||(S.ShadersStore[yC]=EY);const IC="rsmFullGlobalIlluminationPixelShader",TY=`/**
* The implementation is a direct application of the formula found in http:
*/
precision highp float;varying vec2 vUV;uniform mat4 rsmLightMatrix;uniform vec4 rsmInfo;uniform sampler2D textureSampler;uniform sampler2D normalSampler;uniform sampler2D rsmPositionW;uniform sampler2D rsmNormalW;uniform sampler2D rsmFlux;
#ifdef TRANSFORM_NORMAL
uniform mat4 invView;
#endif
vec3 computeIndirect(vec3 p,vec3 n) {vec3 indirectDiffuse=vec3(0.);float intensity=rsmInfo.z;float edgeArtifactCorrection=rsmInfo.w;vec4 texRSM=rsmLightMatrix*vec4(p,1.);texRSM.xy/=texRSM.w;texRSM.xy=texRSM.xy*0.5+0.5;int width=int(rsmInfo.x);int height=int(rsmInfo.y);for (int j=0; j<height; j++) {for (int i=0; i<width; i++) {ivec2 uv=ivec2(i,j);vec3 vplPositionW=texelFetch(rsmPositionW,uv,0).xyz;vec3 vplNormalW=texelFetch(rsmNormalW,uv,0).xyz*2.0-1.0;vec3 vplFlux=texelFetch(rsmFlux,uv,0).rgb;vplPositionW-=vplNormalW*edgeArtifactCorrection; 
float dist2=dot(vplPositionW-p,vplPositionW-p);indirectDiffuse+=vplFlux*max(0.,dot(n,vplPositionW-p))*max(0.,dot(vplNormalW,p-vplPositionW))/(dist2*dist2);}}
return clamp(indirectDiffuse*intensity,0.0,1.0);}
void main(void) 
{vec3 positionW=texture2D(textureSampler,vUV).xyz;vec3 normalW=texture2D(normalSampler,vUV).xyz;
#ifdef DECODE_NORMAL
normalW=normalW*2.0-1.0;
#endif
#ifdef TRANSFORM_NORMAL
normalW=(invView*vec4(normalW,0.)).xyz;
#endif
gl_FragColor.rgb=computeIndirect(positionW,normalW);gl_FragColor.a=1.0;}
`;S.ShadersStore[IC]||(S.ShadersStore[IC]=TY);const RC="bilateralBlurPixelShader",bY=`var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var normalSamplerSampler: sampler;var normalSampler: texture_2d<f32>;var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;uniform filterSize: i32;uniform blurDir: vec2f;uniform depthThreshold: f32;uniform normalThreshold: f32;varying vUV: vec2f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var color: vec3f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.).rgb;var depth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV,0.).x;if (depth>=1e6 || depth<=0.) {fragmentOutputs.color= vec4f(color,1.);return fragmentOutputs;}
var normal: vec3f=textureSampleLevel(normalSampler,normalSamplerSampler,input.vUV,0.).rgb;
#ifdef DECODE_NORMAL
normal=normal*2.0-1.0;
#endif
var sigma: f32= f32(uniforms.filterSize);var two_sigma2: f32=2.0*sigma*sigma;var sigmaDepth: f32=uniforms.depthThreshold;var two_sigmaDepth2: f32=2.0*sigmaDepth*sigmaDepth;var sigmaNormal: f32=uniforms.normalThreshold;var two_sigmaNormal2: f32=2.0*sigmaNormal*sigmaNormal;var sum: vec3f= vec3f(0.);var wsum: f32=0.;for (var x: i32=-uniforms.filterSize; x<=uniforms.filterSize; x++) {var coords=vec2f(f32(x));var sampleColor: vec3f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV+coords*uniforms.blurDir,0.).rgb;var sampleDepth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV+coords*uniforms.blurDir,0.).r;var sampleNormal: vec3f=textureSampleLevel(normalSampler,normalSamplerSampler,input.vUV+coords*uniforms.blurDir,0.).rgb;
#ifdef DECODE_NORMAL
sampleNormal=sampleNormal*2.0-1.0;
#endif
var r: f32=dot(coords,coords);var w: f32=exp(-r/two_sigma2);var depthDelta: f32=abs(sampleDepth-depth);var wd: f32=step(depthDelta,uniforms.depthThreshold);var normalDelta: vec3f=abs(sampleNormal-normal);var wn: f32=step(normalDelta.x+normalDelta.y+normalDelta.z,uniforms.normalThreshold);sum+=sampleColor*w*wd*wn;wsum+=w*wd*wn;}
fragmentOutputs.color= vec4f(sum/wsum,1.);}
`;S.ShadersStoreWGSL[RC]||(S.ShadersStoreWGSL[RC]=bY);const AC="bilateralBlurQualityPixelShader",CY=`var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var normalSamplerSampler: sampler;var normalSampler: texture_2d<f32>;var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;uniform filterSize: i32;uniform blurDir: vec2f;uniform depthThreshold: f32;uniform normalThreshold: f32;varying vUV: vec2f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var color: vec3f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.).rgb;var depth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV,0.).x;if (depth>=1e6 || depth<=0.) {fragmentOutputs.color= vec4f(color,1.);return fragmentOutputs;}
var normal: vec3f=textureSampleLevel(normalSampler,normalSamplerSampler,input.vUV,0.).rgb;
#ifdef DECODE_NORMAL
normal=normal*2.0-1.0;
#endif
var sigma: f32= f32(uniforms.filterSize);var two_sigma2: f32=2.0*sigma*sigma;var sigmaDepth: f32=uniforms.depthThreshold;var two_sigmaDepth2: f32=2.0*sigmaDepth*sigmaDepth;var sigmaNormal: f32=uniforms.normalThreshold;var two_sigmaNormal2: f32=2.0*sigmaNormal*sigmaNormal;var sum: vec3f= vec3f(0.);var wsum: f32=0.;for (var x: i32=-uniforms.filterSize; x<=uniforms.filterSize; x++) {for (var y: i32=-uniforms.filterSize; y<=uniforms.filterSize; y++) {var coords: vec2f= vec2f(f32(x),f32(y))*uniforms.blurDir;var sampleColor: vec3f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV+coords,0.).rgb;var sampleDepth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV+coords,0.).r;var sampleNormal: vec3f=textureSampleLevel(normalSampler,normalSamplerSampler,input.vUV+coords,0.).rgb;
#ifdef DECODE_NORMAL
sampleNormal=sampleNormal*2.0-1.0;
#endif
var r: f32=dot(coords,coords);var w: f32=exp(-r/two_sigma2);var rDepth: f32=sampleDepth-depth;var wd: f32=exp(-rDepth*rDepth/two_sigmaDepth2);var rNormal: f32=abs(sampleNormal.x-normal.x)+abs(sampleNormal.y-normal.y)+abs(sampleNormal.z-normal.z);var wn: f32=exp(-rNormal*rNormal/two_sigmaNormal2);sum+=sampleColor*w*wd*wn;wsum+=w*wd*wn;}}
fragmentOutputs.color= vec4f(sum/wsum,1.);}
`;S.ShadersStoreWGSL[AC]||(S.ShadersStoreWGSL[AC]=CY);const PC="rsmGlobalIlluminationPixelShader",yY=`/**
* The implementation is an application of the formula found in http:
* For better results,it also adds a random (noise) rotation to the RSM samples (the noise artifacts are easier to remove than the banding artifacts).
*/
varying vUV: vec2f;uniform rsmLightMatrix: mat4x4f;uniform rsmInfo: vec4f;uniform rsmInfo2: vec4f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var normalSamplerSampler: sampler;var normalSampler: texture_2d<f32>;var rsmPositionWSampler: sampler;var rsmPositionW: texture_2d<f32>;var rsmNormalWSampler: sampler;var rsmNormalW: texture_2d<f32>;var rsmFluxSampler: sampler;var rsmFlux: texture_2d<f32>;var rsmSamples: texture_2d<f32>;
#ifdef TRANSFORM_NORMAL
uniform invView: mat4x4f;
#endif
fn mod289(x: f32)->f32{return x-floor(x*(1.0/289.0))*289.0;}
fn mod289Vec4(x: vec4f)->vec4f {return x-floor(x*(1.0/289.0))* 289.0;}
fn perm(x: vec4f)->vec4f {return mod289Vec4(((x*34.0)+1.0)*x) ;}
fn noise(p: vec3f)->f32{var a: vec3f=floor(p);var d: vec3f=p-a;d=d*d*(3.0-2.0*d);var b: vec4f=a.xxyy+ vec4f(0.0,1.0,0.0,1.0);var k1: vec4f=perm(b.xyxy);var k2: vec4f=perm(k1.xyxy+b.zzww);var c: vec4f=k2+a.zzzz;var k3: vec4f=perm(c);var k4: vec4f=perm(c+1.0);var o1: vec4f=fract(k3*(1.0/41.0));var o2: vec4f=fract(k4*(1.0/41.0));var o3: vec4f=o2*d.z+o1*(1.0-d.z);var o4: vec2f=o3.yw*d.x+o3.xz*(1.0-d.x);return o4.y*d.y+o4.x*(1.0-d.y);}
fn computeIndirect(p: vec3f,n: vec3f)->vec3f {var indirectDiffuse: vec3f= vec3f(0.);var numSamples: i32= i32(uniforms.rsmInfo.x);var radius: f32=uniforms.rsmInfo.y;var intensity: f32=uniforms.rsmInfo.z;var edgeArtifactCorrection: f32=uniforms.rsmInfo.w;var texRSM: vec4f=uniforms.rsmLightMatrix* vec4f(p,1.);texRSM=vec4f(texRSM.xy/texRSM.w,texRSM.z,texRSM.w);texRSM=vec4f(texRSM.xy*0.5+0.5,texRSM.z,texRSM.w);var angle: f32=noise(p*uniforms.rsmInfo2.x);var c: f32=cos(angle);var s: f32=sin(angle);for (var i: i32=0; i<numSamples; i++) {var rsmSample: vec3f=textureLoad(rsmSamples,vec2<i32>(i,0),0).xyz;var weightSquare: f32=rsmSample.z;if (uniforms.rsmInfo2.y==1.0){rsmSample=vec3f(rsmSample.x*c+rsmSample.y*s,-rsmSample.x*s+rsmSample.y*c,rsmSample.z);}
var uv: vec2f=texRSM.xy+rsmSample.xy*radius;if (uv.x<0. || uv.x>1. || uv.y<0. || uv.y>1.) {continue;}
var vplPositionW: vec3f=textureSampleLevel(rsmPositionW,rsmPositionWSampler,uv,0.).xyz;var vplNormalW: vec3f=textureSampleLevel(rsmNormalW,rsmNormalWSampler,uv,0.).xyz*2.0-1.0;var vplFlux: vec3f=textureSampleLevel(rsmFlux,rsmFluxSampler,uv,0.).rgb;vplPositionW-=vplNormalW*edgeArtifactCorrection; 
var dist2: f32=dot(vplPositionW-p,vplPositionW-p);indirectDiffuse+=vplFlux*weightSquare*max(0.,dot(n,vplPositionW-p))*max(0.,dot(vplNormalW,p-vplPositionW))/(dist2*dist2);}
return clamp(indirectDiffuse*intensity,vec3f(0.0),vec3f(1.0));}
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var positionW: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).xyz;var normalW: vec3f=textureSample(normalSampler,normalSamplerSampler,input.vUV).xyz;
#ifdef DECODE_NORMAL
normalW=normalW*2.0-1.0;
#endif
#ifdef TRANSFORM_NORMAL
normalW=(uniforms.invView* vec4f(normalW,0.)).xyz;
#endif
fragmentOutputs.color=vec4f(computeIndirect(positionW,normalW),1.0);}
`;S.ShadersStoreWGSL[PC]||(S.ShadersStoreWGSL[PC]=yY);const OC="rsmFullGlobalIlluminationPixelShader",IY=`/**
* The implementation is a direct application of the formula found in http:
*/
varying vUV: vec2f;uniform rsmLightMatrix: mat4x4f;uniform rsmInfo: vec4f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var normalSamplerSampler: sampler;var normalSampler: texture_2d<f32>;var rsmPositionW: texture_2d<f32>;var rsmNormalW: texture_2d<f32>;var rsmFlux: texture_2d<f32>;
#ifdef TRANSFORM_NORMAL
uniform invView: mat4x4f;
#endif
fn computeIndirect(p: vec3f,n: vec3f)->vec3f {var indirectDiffuse: vec3f= vec3f(0.);var intensity: f32=uniforms.rsmInfo.z;var edgeArtifactCorrection: f32=uniforms.rsmInfo.w;var texRSM: vec4f=uniforms.rsmLightMatrix* vec4f(p,1.);texRSM=vec4f(texRSM.xy/texRSM.w,texRSM.z,texRSM.w);texRSM=vec4f(texRSM.xy*0.5+0.5,texRSM.z,texRSM.w);var width: i32= i32(uniforms.rsmInfo.x);var height: i32= i32(uniforms.rsmInfo.y);for (var j: i32=0; j<height; j++) {for (var i: i32=0; i<width; i++) {var uv=vec2<i32>(i,j);var vplPositionW: vec3f=textureLoad(rsmPositionW,uv,0).xyz;var vplNormalW: vec3f=textureLoad(rsmNormalW,uv,0).xyz*2.0-1.0;var vplFlux: vec3f=textureLoad(rsmFlux,uv,0).rgb;vplPositionW-=vplNormalW*edgeArtifactCorrection; 
var dist2: f32=dot(vplPositionW-p,vplPositionW-p);indirectDiffuse+=vplFlux*max(0.,dot(n,vplPositionW-p))*max(0.,dot(vplNormalW,p-vplPositionW))/(dist2*dist2);}}
return clamp(indirectDiffuse*intensity,vec3f(0.0),vec3f(1.0));}
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var positionW: vec3f=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.vUV).xyz;var normalW: vec3f=textureSample(normalSampler,normalSamplerSampler,fragmentInputs.vUV).xyz;
#ifdef DECODE_NORMAL
normalW=normalW*2.0-1.0;
#endif
#ifdef TRANSFORM_NORMAL
normalW=(uniforms.invView* vec4f(normalW,0.)).xyz;
#endif
fragmentOutputs.color=vec4f(computeIndirect(positionW,normalW),1.0);}
`;S.ShadersStoreWGSL[OC]||(S.ShadersStoreWGSL[OC]=IY);const Hp="geometryPixelShader",bO=`#ifdef BUMP
varying vWorldView0: vec4f;varying vWorldView1: vec4f;varying vWorldView2: vec4f;varying vWorldView3: vec4f;varying vNormalW: vec3f;
#else
varying vNormalV: vec3f;
#endif
varying vViewPos: vec4f;
#if defined(POSITION) || defined(BUMP)
varying vPositionW: vec3f;
#endif
#if defined(VELOCITY) || defined(VELOCITY_LINEAR)
varying vCurrentPosition: vec4f;varying vPreviousPosition: vec4f;
#endif
#ifdef NEED_UV
varying vUV: vec2f;
#endif
#ifdef BUMP
uniform vBumpInfos: vec3f;uniform vTangentSpaceParams: vec2f;
#endif
#if defined(REFLECTIVITY)
#if defined(ORMTEXTURE) || defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)
var reflectivitySamplerSampler: sampler;var reflectivitySampler: texture_2d<f32>;varying vReflectivityUV: vec2f;
#else
#ifdef METALLIC_TEXTURE
var metallicSamplerSampler: sampler;var metallicSampler: texture_2d<f32>;varying vMetallicUV: vec2f;
#endif
#ifdef ROUGHNESS_TEXTURE
var roughnessSamplerSampler: sampler;var roughnessSampler: texture_2d<f32>;varying vRoughnessUV: vec2f;
#endif
#endif
#ifdef ALBEDOTEXTURE
varying vAlbedoUV: vec2f;var albedoSamplerSampler: sampler;var albedoSampler: texture_2d<f32>;
#endif
#ifdef REFLECTIVITYCOLOR
uniform reflectivityColor: vec3f;
#endif
#ifdef ALBEDOCOLOR
uniform albedoColor: vec3f;
#endif
#ifdef METALLIC
uniform metallic: f32;
#endif
#if defined(ROUGHNESS) || defined(GLOSSINESS)
uniform glossiness: f32;
#endif
#endif
#if defined(ALPHATEST) && defined(NEED_UV)
var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;
#endif
#include<clipPlaneFragmentDeclaration>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<helperFunctions>
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (textureSample(diffuseSampler,diffuseSamplerSampler,input.vUV).a<0.4) {discard;}
#endif
var normalOutput: vec3f;
#ifdef BUMP
var normalW: vec3f=normalize(input.vNormalW);
#include<bumpFragment>
#ifdef NORMAL_WORLDSPACE
normalOutput=normalW;
#else
normalOutput=normalize( (mat4x4f(input.vWorldView0,input.vWorldView1,input.vWorldView2,input.vWorldView3)* vec4f(normalW,0.0)).xyz);
#endif
#elif defined(HAS_NORMAL_ATTRIBUTE)
normalOutput=normalize(input.vNormalV);
#elif defined(POSITION)
normalOutput=normalize(-cross(dpdx(input.vPositionW),dpdy(input.vPositionW)));
#endif
#ifdef ENCODE_NORMAL
normalOutput=normalOutput*0.5+0.5;
#endif
var fragData: array<vec4<f32>,SCENE_MRT_COUNT>;
#ifdef DEPTH
fragData[DEPTH_INDEX]=vec4f(input.vViewPos.z/input.vViewPos.w,0.0,0.0,1.0);
#endif
#ifdef NORMAL
fragData[NORMAL_INDEX]=vec4f(normalOutput,1.0);
#endif
#ifdef SCREENSPACE_DEPTH
fragData[SCREENSPACE_DEPTH_INDEX]=vec4f(fragmentInputs.position.z,0.0,0.0,1.0);
#endif
#ifdef POSITION
fragData[POSITION_INDEX]= vec4f(input.vPositionW,1.0);
#endif
#ifdef VELOCITY
var a: vec2f=(input.vCurrentPosition.xy/input.vCurrentPosition.w)*0.5+0.5;var b: vec2f=(input.vPreviousPosition.xy/input.vPreviousPosition.w)*0.5+0.5;var velocity: vec2f=abs(a-b);velocity= vec2f(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;fragData[VELOCITY_INDEX]= vec4f(velocity,0.0,1.0);
#endif
#ifdef VELOCITY_LINEAR
var velocity : vec2f=vec2f(0.5)*((input.vPreviousPosition.xy /
input.vPreviousPosition.w) -
(input.vCurrentPosition.xy /
input.vCurrentPosition.w));fragData[VELOCITY_LINEAR_INDEX]=vec4f(velocity,0.0,1.0);
#endif
#ifdef REFLECTIVITY
var reflectivity: vec4f= vec4f(0.0,0.0,0.0,1.0);
#ifdef METALLICWORKFLOW
var metal: f32=1.0;var roughness: f32=1.0;
#ifdef ORMTEXTURE
metal*=textureSample(reflectivitySampler,reflectivitySamplerSampler,input.vReflectivityUV).b;roughness*=textureSample(reflectivitySampler,reflectivitySamplerSampler,input.vReflectivityUV).g;
#else
#ifdef METALLIC_TEXTURE
metal*=textureSample(metallicSampler,metallicSamplerSampler,input.vMetallicUV).r;
#endif
#ifdef ROUGHNESS_TEXTURE
roughness*=textureSample(roughnessSampler,roughnessSamplerSampler,input.vRoughnessUV).r;
#endif
#endif
#ifdef METALLIC
metal*=uniforms.metallic;
#endif
#ifdef ROUGHNESS
roughness*=(1.0-uniforms.glossiness); 
#endif
reflectivity=vec4f(reflectivity.rgb,reflectivity.a-roughness);var color: vec3f= vec3f(1.0);
#ifdef ALBEDOTEXTURE
color=textureSample(albedoSampler,albedoSamplerSampler,input.vAlbedoUV).rgb;
#ifdef GAMMAALBEDO
color=toLinearSpaceVec4(color);
#endif
#endif
#ifdef ALBEDOCOLOR
color*=uniforms.albedoColor.xyz;
#endif
reflectivity=vec4f(mix( vec3f(0.04),color,metal),reflectivity.a);
#else
#if defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)
reflectivity=textureSample(reflectivitySampler,reflectivitySamplerSampler,input.vReflectivityUV);
#ifdef GAMMAREFLECTIVITYTEXTURE
reflectivity=vec4f(toLinearSpaceVec3(reflectivity.rgb),reflectivity.a);
#endif
#else 
#ifdef REFLECTIVITYCOLOR
reflectivity=vec4f(toLinearSpaceVec3(uniforms.reflectivityColor.xyz),1.0);
#endif
#endif
#ifdef GLOSSINESSS
reflectivity=vec4f(reflectivity.rgb,reflectivity.a*glossiness); 
#endif
#endif
fragData[REFLECTIVITY_INDEX]=reflectivity;
#endif
#if SCENE_MRT_COUNT>0
fragmentOutputs.fragData0=fragData[0];
#endif
#if SCENE_MRT_COUNT>1
fragmentOutputs.fragData1=fragData[1];
#endif
#if SCENE_MRT_COUNT>2
fragmentOutputs.fragData2=fragData[2];
#endif
#if SCENE_MRT_COUNT>3
fragmentOutputs.fragData3=fragData[3];
#endif
#if SCENE_MRT_COUNT>4
fragmentOutputs.fragData4=fragData[4];
#endif
#if SCENE_MRT_COUNT>5
fragmentOutputs.fragData5=fragData[5];
#endif
#if SCENE_MRT_COUNT>6
fragmentOutputs.fragData6=fragData[6];
#endif
#if SCENE_MRT_COUNT>7
fragmentOutputs.fragData7=fragData[7];
#endif
}
`;S.ShadersStoreWGSL[Hp]||(S.ShadersStoreWGSL[Hp]=bO);const RY={name:Hp,shader:bO},AY=Object.freeze(Object.defineProperty({__proto__:null,geometryPixelShaderWGSL:RY},Symbol.toStringTag,{value:"Module"})),$p="geometryVertexShader",CO=`#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
#include<sceneUboDeclaration>
#include<clipPlaneVertexDeclaration>
attribute position: vec3f;
#ifdef HAS_NORMAL_ATTRIBUTE
attribute normal: vec3f;
#endif
#ifdef NEED_UV
varying vUV: vec2f;
#ifdef ALPHATEST
uniform diffuseMatrix: mat4x4f;
#endif
#ifdef BUMP
uniform bumpMatrix: mat4x4f;varying vBumpUV: vec2f;
#endif
#ifdef REFLECTIVITY
uniform reflectivityMatrix: mat4x4f;uniform albedoMatrix: mat4x4f;varying vReflectivityUV: vec2f;varying vAlbedoUV: vec2f;
#endif
#ifdef METALLIC_TEXTURE
varying vMetallicUV: vec2f;uniform metallicMatrix: mat4x4f;
#endif
#ifdef ROUGHNESS_TEXTURE
varying vRoughnessUV: vec2f;uniform roughnessMatrix: mat4x4f;
#endif
#ifdef UV1
attribute uv: vec2f;
#endif
#ifdef UV2
attribute uv2: vec2f;
#endif
#endif
#ifdef BUMP
varying vWorldView0: vec4f;varying vWorldView1: vec4f;varying vWorldView2: vec4f;varying vWorldView3: vec4f;
#endif
#ifdef BUMP
varying vNormalW: vec3f;
#else
varying vNormalV: vec3f;
#endif
varying vViewPos: vec4f;
#if defined(POSITION) || defined(BUMP)
varying vPositionW: vec3f;
#endif
#if defined(VELOCITY) || defined(VELOCITY_LINEAR)
uniform previousViewProjection: mat4x4f;varying vCurrentPosition: vec4f;varying vPreviousPosition: vec4f;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;
#ifdef HAS_NORMAL_ATTRIBUTE
var normalUpdated: vec3f=input.normal;
#else
var normalUpdated: vec3f=vec3f(0.0,0.0,0.0);
#endif
#ifdef UV1
var uvUpdated: vec2f=input.uv;
#endif
#ifdef UV2
var uv2Updated: vec2f=input.uv2;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#if (defined(VELOCITY) || defined(VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=scene.viewProjection*finalWorld*vec4f(positionUpdated,1.0);vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld* vec4f(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f= vec4f(finalWorld* vec4f(positionUpdated,1.0));
#ifdef BUMP
let vWorldView=scene.view*finalWorld;vertexOutputs.vWorldView0=vWorldView[0];vertexOutputs.vWorldView1=vWorldView[1];vertexOutputs.vWorldView2=vWorldView[2];vertexOutputs.vWorldView3=vWorldView[3];let normalWorld: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);vertexOutputs.vNormalW=normalize(normalWorld*normalUpdated);
#else
#ifdef NORMAL_WORLDSPACE
vertexOutputs.vNormalV=normalize((finalWorld* vec4f(normalUpdated,0.0)).xyz);
#else
vertexOutputs.vNormalV=normalize(((scene.view*finalWorld)* vec4f(normalUpdated,0.0)).xyz);
#endif
#endif
vertexOutputs.vViewPos=scene.view*worldPos;
#if (defined(VELOCITY) || defined(VELOCITY_LINEAR)) && defined(BONES_VELOCITY_ENABLED)
vertexOutputs.vCurrentPosition=scene.viewProjection*finalWorld* vec4f(positionUpdated,1.0);
#if NUM_BONE_INFLUENCERS>0
var previousInfluence: mat4x4f;previousInfluence=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndices[0])]*vertexInputs.matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndices[1])]*vertexInputs.matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndices[2])]*vertexInputs.matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndices[3])]*vertexInputs.matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndicesExtra[0])]*vertexInputs.matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndicesExtra[1])]*vertexInputs.matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndicesExtra[2])]*vertexInputs.matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndicesExtra[3])]*vertexInputs.matricesWeightsExtra[3];
#endif
vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*previousInfluence* vec4f(positionUpdated,1.0);
#else
vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld* vec4f(positionUpdated,1.0);
#endif
#endif
#if defined(POSITION) || defined(BUMP)
vertexOutputs.vPositionW=worldPos.xyz/worldPos.w;
#endif
vertexOutputs.position=scene.viewProjection*finalWorld* vec4f(positionUpdated,1.0);
#include<clipPlaneVertex>
#ifdef NEED_UV
#ifdef UV1
#if defined(ALPHATEST) && defined(ALPHATEST_UV1)
vertexOutputs.vUV=(uniforms.diffuseMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#else
vertexOutputs.vUV=uvUpdated;
#endif
#ifdef BUMP_UV1
vertexOutputs.vBumpUV=(uniforms.bumpMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#endif
#ifdef REFLECTIVITY_UV1
vertexOutputs.vReflectivityUV=(uniforms.reflectivityMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#else
#ifdef METALLIC_UV1
vertexOutputs.vMetallicUV=(uniforms.metallicMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#endif
#ifdef ROUGHNESS_UV1
vertexOutputs.vRoughnessUV=(uniforms.roughnessMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#endif
#endif
#ifdef ALBEDO_UV1
vertexOutputs.vAlbedoUV=(uniforms.albedoMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#endif
#endif
#ifdef UV2
#if defined(ALPHATEST) && defined(ALPHATEST_UV2)
vertexOutputs.vUV=(uniforms.diffuseMatrix* vec4f(uv2Updated,1.0,0.0)).xy;
#else
vertexOutputs.vUV=uv2Updated;
#endif
#ifdef BUMP_UV2
vertexOutputs.vBumpUV=(uniforms.bumpMatrix* vec4f(uv2Updated,1.0,0.0)).xy;
#endif
#ifdef REFLECTIVITY_UV2
vertexOutputs.vReflectivityUV=(uniforms.reflectivityMatrix* vec4f(uv2Updated,1.0,0.0)).xy;
#else
#ifdef METALLIC_UV2
vertexOutputs.vMetallicUV=(uniforms.metallicMatrix* vec4f(uv2Updated,1.0,0.0)).xy;
#endif
#ifdef ROUGHNESS_UV2
vertexOutputs.vRoughnessUV=(uniforms.roughnessMatrix* vec4f(uv2Updated,1.0,0.0)).xy;
#endif
#endif
#ifdef ALBEDO_UV2
vertexOutputs.vAlbedoUV=(uniforms.albedoMatrix* vec4f(uv2Updated,1.0,0.0)).xy;
#endif
#endif
#endif
#include<bumpVertex>
}
`;S.ShadersStoreWGSL[$p]||(S.ShadersStoreWGSL[$p]=CO);const PY={name:$p,shader:CO},OY=Object.freeze(Object.defineProperty({__proto__:null,geometryVertexShaderWGSL:PY},Symbol.toStringTag,{value:"Module"})),NC="boundingBoxRendererFragmentDeclaration",NY=`uniform vec4 color;
`;S.IncludesShadersStore[NC]||(S.IncludesShadersStore[NC]=NY);const DC="boundingBoxRendererUboDeclaration",DY=`#ifdef WEBGL2
uniform vec4 color;uniform mat4 world;uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
#else
layout(std140,column_major) uniform;uniform BoundingBoxRenderer {vec4 color;mat4 world;mat4 viewProjection;mat4 viewProjectionR;};
#endif
`;S.IncludesShadersStore[DC]||(S.IncludesShadersStore[DC]=DY);const Xp="boundingBoxRendererPixelShader",yO=`#include<__decl__boundingBoxRendererFragment>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;S.ShadersStore[Xp]||(S.ShadersStore[Xp]=yO);const MY={name:Xp,shader:yO},MC=Object.freeze(Object.defineProperty({__proto__:null,boundingBoxRendererPixelShader:MY},Symbol.toStringTag,{value:"Module"})),FC="boundingBoxRendererVertexDeclaration",FY=`uniform mat4 world;uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
`;S.IncludesShadersStore[FC]||(S.IncludesShadersStore[FC]=FY);const Yp="boundingBoxRendererVertexShader",IO=`attribute vec3 position;
#include<__decl__boundingBoxRendererVertex>
#ifdef INSTANCES
attribute vec4 world0;attribute vec4 world1;attribute vec4 world2;attribute vec4 world3;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#ifdef INSTANCES
mat4 finalWorld=mat4(world0,world1,world2,world3);vec4 worldPos=finalWorld*vec4(position,1.0);
#else
vec4 worldPos=world*vec4(position,1.0);
#endif
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
#define CUSTOM_VERTEX_MAIN_END
}
`;S.ShadersStore[Yp]||(S.ShadersStore[Yp]=IO);const LY={name:Yp,shader:IO},LC=Object.freeze(Object.defineProperty({__proto__:null,boundingBoxRendererVertexShader:LY},Symbol.toStringTag,{value:"Module"})),jp="boundingBoxRendererPixelShader",RO=`uniform color: vec4f;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
fragmentOutputs.color=uniforms.color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;S.ShadersStoreWGSL[jp]||(S.ShadersStoreWGSL[jp]=RO);const wY={name:jp,shader:RO},wC=Object.freeze(Object.defineProperty({__proto__:null,boundingBoxRendererPixelShaderWGSL:wY},Symbol.toStringTag,{value:"Module"})),qp="boundingBoxRendererVertexShader",AO=`attribute position: vec3f;uniform world: mat4x4f;uniform viewProjection: mat4x4f;
#ifdef INSTANCES
attribute world0 : vec4<f32>;attribute world1 : vec4<f32>;attribute world2 : vec4<f32>;attribute world3 : vec4<f32>;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
#ifdef INSTANCES
var finalWorld=mat4x4<f32>(vertexInputs.world0,vertexInputs.world1,vertexInputs.world2,vertexInputs.world3);var worldPos: vec4f=finalWorld* vec4f(input.position,1.0);
#else
var worldPos: vec4f=uniforms.world* vec4f(input.position,1.0);
#endif
vertexOutputs.position=uniforms.viewProjection*worldPos;
#define CUSTOM_VERTEX_MAIN_END
}
`;S.ShadersStoreWGSL[qp]||(S.ShadersStoreWGSL[qp]=AO);const BY={name:qp,shader:AO},BC=Object.freeze(Object.defineProperty({__proto__:null,boundingBoxRendererVertexShaderWGSL:BY},Symbol.toStringTag,{value:"Module"})),Zp="linePixelShader",PO=`#include<clipPlaneFragmentDeclaration>
uniform vec4 color;
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<logDepthDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<logDepthFragment>
#include<clipPlaneFragment>
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;S.ShadersStore[Zp]||(S.ShadersStore[Zp]=PO);const VY={name:Zp,shader:PO},UY=Object.freeze(Object.defineProperty({__proto__:null,linePixelShader:VY},Symbol.toStringTag,{value:"Module"})),VC="lineVertexDeclaration",kY=`uniform mat4 viewProjection;
#define ADDITIONAL_VERTEX_DECLARATION
`;S.IncludesShadersStore[VC]||(S.IncludesShadersStore[VC]=kY);const UC="lineUboDeclaration",GY=`layout(std140,column_major) uniform;
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;S.IncludesShadersStore[UC]||(S.IncludesShadersStore[UC]=GY);const Qp="lineVertexShader",OO=`#include<__decl__lineVertex>
#include<instancesDeclaration>
#include<clipPlaneVertexDeclaration>
attribute vec3 position;attribute vec4 normal;uniform float width;uniform float aspectRatio;
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
mat4 worldViewProjection=viewProjection*finalWorld;vec4 viewPosition=worldViewProjection*vec4(position,1.0);vec4 viewPositionNext=worldViewProjection*vec4(normal.xyz,1.0);vec2 currentScreen=viewPosition.xy/viewPosition.w;vec2 nextScreen=viewPositionNext.xy/viewPositionNext.w;currentScreen.x*=aspectRatio;nextScreen.x*=aspectRatio;vec2 dir=normalize(nextScreen-currentScreen);vec2 normalDir=vec2(-dir.y,dir.x);normalDir*=width/2.0;normalDir.x/=aspectRatio;vec4 offset=vec4(normalDir*normal.w,0.0,0.0);gl_Position=viewPosition+offset;
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
vec4 worldPos=finalWorld*vec4(position,1.0);
#include<clipPlaneVertex>
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;S.ShadersStore[Qp]||(S.ShadersStore[Qp]=OO);const zY={name:Qp,shader:OO},WY=Object.freeze(Object.defineProperty({__proto__:null,lineVertexShader:zY},Symbol.toStringTag,{value:"Module"})),Kp="linePixelShader",NO=`#include<clipPlaneFragmentDeclaration>
uniform color: vec4f;
#include<logDepthDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<logDepthFragment>
#include<clipPlaneFragment>
fragmentOutputs.color=uniforms.color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;S.ShadersStoreWGSL[Kp]||(S.ShadersStoreWGSL[Kp]=NO);const HY={name:Kp,shader:NO},$Y=Object.freeze(Object.defineProperty({__proto__:null,linePixelShaderWGSL:HY},Symbol.toStringTag,{value:"Module"})),Jp="lineVertexShader",DO=`#define ADDITIONAL_VERTEX_DECLARATION
#include<instancesDeclaration>
#include<clipPlaneVertexDeclaration>
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
attribute position: vec3f;attribute normal: vec4f;uniform width: f32;uniform aspectRatio: f32;
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
var worldViewProjection: mat4x4f=scene.viewProjection*finalWorld;var viewPosition: vec4f=worldViewProjection* vec4f(input.position,1.0);var viewPositionNext: vec4f=worldViewProjection* vec4f(input.normal.xyz,1.0);var currentScreen: vec2f=viewPosition.xy/viewPosition.w;var nextScreen: vec2f=viewPositionNext.xy/viewPositionNext.w;currentScreen=vec2f(currentScreen.x*uniforms.aspectRatio,currentScreen.y);nextScreen=vec2f(nextScreen.x*uniforms.aspectRatio,nextScreen.y);var dir: vec2f=normalize(nextScreen-currentScreen);var normalDir: vec2f= vec2f(-dir.y,dir.x);normalDir*=uniforms.width/2.0;normalDir=vec2f(normalDir.x/uniforms.aspectRatio,normalDir.y);var offset: vec4f= vec4f(normalDir*input.normal.w,0.0,0.0);vertexOutputs.position=viewPosition+offset;
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
var worldPos: vec4f=finalWorld*vec4f(input.position,1.0);
#include<clipPlaneVertex>
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;S.ShadersStoreWGSL[Jp]||(S.ShadersStoreWGSL[Jp]=DO);const XY={name:Jp,shader:DO},YY=Object.freeze(Object.defineProperty({__proto__:null,lineVertexShaderWGSL:XY},Symbol.toStringTag,{value:"Module"})),em="outlinePixelShader",MO=`#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
uniform vec4 color;
#ifdef ALPHATEST
varying vec2 vUV;uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
#include<logDepthFragment>
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;S.ShadersStore[em]||(S.ShadersStore[em]=MO);const jY={name:em,shader:MO},qY=Object.freeze(Object.defineProperty({__proto__:null,outlinePixelShader:jY},Symbol.toStringTag,{value:"Module"})),tm="outlineVertexShader",FO=`attribute vec3 position;attribute vec3 normal;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
uniform float offset;
#include<instancesDeclaration>
uniform mat4 viewProjection;
#ifdef ALPHATEST
varying vec2 vUV;uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;vec3 normalUpdated=normal;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#ifdef UV2
vec2 uv2Updated=uv2;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
vec3 offsetPosition=positionUpdated+(normalUpdated*offset);
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(offsetPosition,1.0);gl_Position=viewProjection*worldPos;
#ifdef ALPHATEST
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2Updated,1.0,0.0));
#endif
#endif
#include<clipPlaneVertex>
#include<logDepthVertex>
}
`;S.ShadersStore[tm]||(S.ShadersStore[tm]=FO);const ZY={name:tm,shader:FO},QY=Object.freeze(Object.defineProperty({__proto__:null,outlineVertexShader:ZY},Symbol.toStringTag,{value:"Module"})),im="outlinePixelShader",LO=`uniform color: vec4f;
#ifdef ALPHATEST
varying vUV: vec2f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;
#endif
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (textureSample(diffuseSampler,diffuseSamplerSampler,fragmentInputs.vUV).a<0.4) {discard;}
#endif
#include<logDepthFragment>
fragmentOutputs.color=uniforms.color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;S.ShadersStoreWGSL[im]||(S.ShadersStoreWGSL[im]=LO);const KY={name:im,shader:LO},JY=Object.freeze(Object.defineProperty({__proto__:null,outlinePixelShaderWGSL:KY},Symbol.toStringTag,{value:"Module"})),rm="outlineVertexShader",wO=`attribute position: vec3f;attribute normal: vec3f;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
uniform offset: f32;
#include<instancesDeclaration>
uniform viewProjection: mat4x4f;
#ifdef ALPHATEST
varying vUV: vec2f;uniform diffuseMatrix: mat4x4f; 
#ifdef UV1
attribute uv: vec2f;
#endif
#ifdef UV2
attribute uv2: vec2f;
#endif
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input: VertexInputs)->FragmentInputs {var positionUpdated: vec3f=vertexInputs.position;var normalUpdated: vec3f=vertexInputs.normal;
#ifdef UV1
var uvUpdated: vec2f=vertexInputs.uv;
#endif
#ifdef UV2
var uv2Updated: vec2f=vertexInputs.uv2;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
var offsetPosition: vec3f=positionUpdated+(normalUpdated*uniforms.offset);
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld*vec4f(offsetPosition,1.0);vertexOutputs.position=uniforms.viewProjection*worldPos;
#ifdef ALPHATEST
#ifdef UV1
vertexOutputs.vUV=(uniforms.diffuseMatrix*vec4f(uvUpdated,1.0,0.0)).xy;
#endif
#ifdef UV2
vertexOutputs.vUV=(uniforms.diffuseMatrix*vec4f(uv2Updated,1.0,0.0)).xy;
#endif
#endif
#include<clipPlaneVertex>
#include<logDepthVertex>
}
`;S.ShadersStoreWGSL[rm]||(S.ShadersStoreWGSL[rm]=wO);const ej={name:rm,shader:wO},tj=Object.freeze(Object.defineProperty({__proto__:null,outlineVertexShaderWGSL:ej},Symbol.toStringTag,{value:"Module"})),kC="copyTexture3DLayerToTexturePixelShader",ij=`precision highp sampler3D;uniform sampler3D textureSampler;uniform int layerNum;varying vec2 vUV;void main(void) {vec3 coord=vec3(0.0,0.0,float(layerNum));coord.xy=vec2(vUV.x,vUV.y)*vec2(textureSize(textureSampler,0).xy);vec3 color=texelFetch(textureSampler,ivec3(coord),0).rgb;gl_FragColor=vec4(color,1);}
`;S.ShadersStore[kC]||(S.ShadersStore[kC]=ij);const GC="copyTexture3DLayerToTexturePixelShader",rj=`var textureSampler: texture_3d<f32>;uniform layerNum: i32;varying vUV: vec2f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {let coord=vec3f(vec2f(input.vUV.x,input.vUV.y)*vec2f(textureDimensions(textureSampler,0).xy),f32(uniforms.layerNum));let color=textureLoad(textureSampler,vec3i(coord),0).rgb;fragmentOutputs.color= vec4f(color,1);}`;S.ShadersStoreWGSL[GC]||(S.ShadersStoreWGSL[GC]=rj);const zC="iblShadowVoxelTracingPixelShader",sj=`precision highp sampler2D;precision highp sampler3D;
#define PI 3.1415927
varying vec2 vUV;
#define DISABLE_UNIFORMITY_ANALYSIS
uniform sampler2D depthSampler;uniform sampler2D worldNormalSampler;uniform sampler2D blueNoiseSampler;uniform sampler2D icdfSampler;uniform sampler3D voxelGridSampler;
#ifdef COLOR_SHADOWS
uniform samplerCube iblSampler;
#endif
uniform vec4 shadowParameters;
#define SHADOWdirs shadowParameters.x
#define SHADOWframe shadowParameters.y
#define SHADOWenvRot shadowParameters.w
uniform vec4 voxelBiasParameters;
#define highestMipLevel voxelBiasParameters.z
uniform vec4 sssParameters;
#define SSSsamples sssParameters.x
#define SSSstride sssParameters.y
#define SSSmaxDistance sssParameters.z
#define SSSthickness sssParameters.w
uniform vec4 shadowOpacity;uniform mat4 projMtx;uniform mat4 viewMtx;uniform mat4 invProjMtx;uniform mat4 invViewMtx;uniform mat4 wsNormalizationMtx;uniform mat4 invVPMtx;
#define PI 3.1415927
#define GOLD 0.618034
struct AABB3f {vec3 m_min;vec3 m_max;};struct Ray {vec3 orig;vec3 dir;vec3 dir_rcp;float t_min;float t_max;};Ray make_ray(const vec3 origin,const vec3 direction,const float tmin,
const float tmax) {Ray ray;ray.orig=origin;ray.dir=direction;ray.dir_rcp=1.0f/direction;ray.t_min=tmin;ray.t_max=tmax;return ray;}
bool ray_box_intersection(const in AABB3f aabb,const in Ray ray,
out float distance_near,out float distance_far) {vec3 tbot=ray.dir_rcp*(aabb.m_min-ray.orig);vec3 ttop=ray.dir_rcp*(aabb.m_max-ray.orig);vec3 tmin=min(ttop,tbot);vec3 tmax=max(ttop,tbot);distance_near=max(ray.t_min,max(tmin.x,max(tmin.y,tmin.z)));distance_far=min(ray.t_max,min(tmax.x,min(tmax.y,tmax.z)));return distance_near<=distance_far;}
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
struct VoxelMarchDiagnosticInfo {float heat;ivec3 voxel_intersect_coords;};
#endif
uint hash(uint i) {i ^= i>>16u;i*=0x7FEB352Du;i ^= i>>15u;i*=0x846CA68Bu;i ^= i>>16u;return i;}
float uint2float(uint i) {return uintBitsToFloat(0x3F800000u | (i>>9u))-1.0;}
vec3 uv_to_normal(vec2 uv) {vec3 N;vec2 uvRange=uv;float theta=uvRange.x*2.0*PI;float phi=uvRange.y*PI;N.x=cos(theta)*sin(phi);N.z=sin(theta)*sin(phi);N.y=cos(phi);return N;}
vec2 plasticSequence(const uint rstate) {return vec2(uint2float(rstate*3242174889u),
uint2float(rstate*2447445414u));}
float goldenSequence(const uint rstate) {return uint2float(rstate*2654435769u);}
float distanceSquared(vec2 a,vec2 b) {vec2 diff=a-b;return dot(diff,diff);}
void genTB(const vec3 N,out vec3 T,out vec3 B) {float s=N.z<0.0 ? -1.0 : 1.0;float a=-1.0/(s+N.z);float b=N.x*N.y*a;T=vec3(1.0+s*N.x*N.x*a,s*b,-s*N.x);B=vec3(b,s+N.y*N.y*a,-N.y);}
int stack[24]; 
#define PUSH(i) stack[stackLevel++]=i; 
#define POP() stack[--stackLevel] 
#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
bool anyHitVoxels(const Ray ray_vs,
out VoxelMarchDiagnosticInfo voxel_march_diagnostic_info) {
#else
bool anyHitVoxels(const Ray ray_vs) {
#endif
vec3 invD=ray_vs.dir_rcp;vec3 D=ray_vs.dir;vec3 O=ray_vs.orig;ivec3 negD=ivec3(lessThan(D,vec3(0,0,0)));int voxel0=negD.x | negD.y<<1 | negD.z<<2;vec3 t0=-O*invD,t1=(vec3(1.0)-O)*invD;int maxLod=int(highestMipLevel);int stackLevel=0;
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
uint steps=0u;
#endif
PUSH(maxLod<<24);while (stackLevel>0) {int elem=POP();ivec4 Coords =
ivec4(elem & 0xFF,elem>>8 & 0xFF,elem>>16 & 0xFF,elem>>24);if (Coords.w==0) {
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
voxel_march_diagnostic_info.heat=float(steps)/24.0;
#endif
return true;}
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
++steps;
#endif
float invRes=exp2(float(Coords.w-maxLod));vec3 bbmin=invRes*vec3(Coords.xyz+negD);vec3 bbmax=invRes*vec3(Coords.xyz-negD+ivec3(1));vec3 mint=mix(t0,t1,bbmin);vec3 maxt=mix(t0,t1,bbmax);vec3 midt=0.5*(mint+maxt);mint.x=max(0.0,mint.x);midt.x=max(0.0,midt.x);int nodeMask=int(
round(texelFetch(voxelGridSampler,Coords.xyz,Coords.w).x*255.0));Coords.w--;int voxelBit=voxel0;Coords.xyz=(Coords.xyz<<1)+negD;int packedCoords =
Coords.x | Coords.y<<8 | Coords.z<<16 | Coords.w<<24;if (max(mint.x,max(mint.y,mint.z))<min(midt.x,min(midt.y,midt.z)) &&
(1<<voxelBit & nodeMask) != 0)
PUSH(packedCoords);voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(midt.x,max(mint.y,mint.z))<min(maxt.x,min(midt.y,midt.z)) &&
(1<<voxelBit & nodeMask) != 0)
PUSH(packedCoords);voxelBit ^= 0x2;packedCoords ^= 0x00100;if (max(midt.x,max(midt.y,mint.z))<min(maxt.x,min(maxt.y,midt.z)) &&
(1<<voxelBit & nodeMask) != 0)
PUSH(packedCoords);voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(mint.x,max(midt.y,mint.z))<min(midt.x,min(maxt.y,midt.z)) &&
(1<<voxelBit & nodeMask) != 0)
PUSH(packedCoords);voxelBit ^= 0x4;packedCoords ^= 0x10000;if (max(mint.x,max(midt.y,midt.z))<min(midt.x,min(maxt.y,maxt.z)) &&
(1<<voxelBit & nodeMask) != 0)
PUSH(packedCoords);voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(midt.x,max(midt.y,midt.z))<min(maxt.x,min(maxt.y,maxt.z)) &&
(1<<voxelBit & nodeMask) != 0)
PUSH(packedCoords);voxelBit ^= 0x2;packedCoords ^= 0x00100;if (max(midt.x,max(mint.y,midt.z))<min(maxt.x,min(midt.y,maxt.z)) &&
(1<<voxelBit & nodeMask) != 0)
PUSH(packedCoords);voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(mint.x,max(mint.y,midt.z))<min(midt.x,min(midt.y,maxt.z)) &&
(1<<voxelBit & nodeMask) != 0)
PUSH(packedCoords);}
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
voxel_march_diagnostic_info.heat=float(steps)/24.0;
#endif
return false;}
float linearizeDepth(float depth,float near,float far) {return (near*far)/(far-depth*(far-near));}
float screenSpaceShadow(vec3 csOrigin,vec3 csDirection,vec2 csZBufferSize,
float nearPlaneZ,float farPlaneZ,float noise) {
#ifdef RIGHT_HANDED
float csZDir=-1.0;
#else 
float csZDir=1.0;
#endif
float ssSamples=SSSsamples;float ssMaxDist=SSSmaxDistance;float ssStride=SSSstride;float ssThickness=SSSthickness;float rayLength =
csZDir*(csOrigin.z+ssMaxDist*csDirection.z)<csZDir*nearPlaneZ
? 
(nearPlaneZ-csOrigin.z)/csDirection.z
: ssMaxDist;vec3 csEndPoint=csOrigin+rayLength*csDirection;vec4 H0=projMtx*vec4(csOrigin,1.0);vec4 H1=projMtx*vec4(csEndPoint,1.0);vec2 Z0=vec2(csOrigin.z ,1.0)/H0.w;vec2 Z1=vec2(csEndPoint.z,1.0)/H1.w;vec2 P0=csZBufferSize*(0.5*H0.xy*Z0.y+0.5);vec2 P1=csZBufferSize*(0.5*H1.xy*Z1.y+0.5);P1+=vec2(distanceSquared(P0,P1)<0.0001 ? 0.01 : 0.0);vec2 delta=P1-P0;bool permute=false;if (abs(delta.x)<abs(delta.y)) {permute=true;P0=P0.yx;P1=P1.yx;delta=delta.yx;}
float stepDirection=sign(delta.x);float invdx=stepDirection/delta.x;vec2 dP=ssStride*vec2(stepDirection,invdx*delta.y);vec2 dZ=ssStride*invdx*(Z1-Z0);float opacity=0.0;vec2 P=P0+noise*dP;vec2 Z=Z0+noise*dZ;float end=P1.x*stepDirection;float rayZMax=csZDir*Z.x/Z.y;float sceneDepth=rayZMax;Z+=dZ;for (float stepCount=0.0;opacity<1.0 && P.x*stepDirection<end && sceneDepth>0.0 && stepCount<ssSamples;stepCount++,P+=dP,
Z+=dZ) { 
ivec2 coords=ivec2(permute ? P.yx : P);sceneDepth=texelFetch(depthSampler,coords,0).x;sceneDepth=linearizeDepth(sceneDepth,nearPlaneZ,farPlaneZ);sceneDepth=csZDir*sceneDepth;if (sceneDepth<=0.0) {break;}
float rayZMin=rayZMax;rayZMax=csZDir*Z.x/Z.y;opacity+=max(opacity,step(rayZMax,sceneDepth+ssThickness)*step(sceneDepth,rayZMin));}
return opacity;}
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
float voxelShadow(vec3 wsOrigin,vec3 wsDirection,vec3 wsNormal,
vec2 DitherNoise,
out VoxelMarchDiagnosticInfo voxel_march_diagnostic_info) {
#else
float voxelShadow(vec3 wsOrigin,vec3 wsDirection,vec3 wsNormal,
vec2 DitherNoise) {
#endif
float vxResolution=float(textureSize(voxelGridSampler,0).x);vec3 T,B;genTB(wsDirection,T,B);vec2 DitherXY=sqrt(DitherNoise.x)*vec2(cos(2.0*PI*DitherNoise.y),
sin(2.0*PI*DitherNoise.y));float sceneScale=wsNormalizationMtx[0][0];vec3 Dithering =
(voxelBiasParameters.x*wsNormal+voxelBiasParameters.y*wsDirection +
DitherXY.x*T+DitherXY.y*B) /
vxResolution;vec3 O=0.5*wsOrigin+0.5+Dithering;Ray ray_vs=make_ray(O,wsDirection,0.0,10.0);AABB3f voxel_aabb;voxel_aabb.m_min=vec3(0);voxel_aabb.m_max=vec3(1);float near,far;if (!ray_box_intersection(voxel_aabb,ray_vs,near,far))
return 0.0;ray_vs.t_min=max(ray_vs.t_min,near);ray_vs.t_max=min(ray_vs.t_max,far);
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
return anyHitVoxels(ray_vs,voxel_march_diagnostic_info) ? 1.0f : 0.0f;
#else
return anyHitVoxels(ray_vs) ? 1.0f : 0.0f;
#endif
}
void main(void) {uint nbDirs=uint(SHADOWdirs);uint frameId=uint(SHADOWframe);float envRot=SHADOWenvRot;vec2 Resolution=vec2(textureSize(depthSampler,0));ivec2 currentPixel=ivec2(vUV*Resolution);uint GlobalIndex=(frameId*uint(Resolution.y)+uint(currentPixel.y)) *
uint(Resolution.x) +
uint(currentPixel.x);vec3 N=texelFetch(worldNormalSampler,currentPixel,0).xyz;if (length(N)<0.01) {glFragColor=vec4(1.0,1.0,0.0,1.0);return;}
float normalizedRotation=envRot/(2.0*PI);float depth=texelFetch(depthSampler,currentPixel,0).x;
#ifndef IS_NDC_HALF_ZRANGE
depth=depth*2.0-1.0;
#endif
vec2 temp=(vec2(currentPixel)+vec2(0.5))*2.0/Resolution-vec2(1.0);vec4 VP=invProjMtx*vec4(temp.x,-temp.y,depth,1.0);VP/=VP.w;N=normalize(N);vec3 noise=texelFetch(blueNoiseSampler,currentPixel & 0xFF,0).xyz;noise.z=fract(noise.z+goldenSequence(frameId*nbDirs));
#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
float heat=0.0f;
#endif
float shadowAccum=0.001;float specShadowAccum=0.001;float sampleWeight=0.001;
#ifdef COLOR_SHADOWS
vec3 totalLight=vec3(0.001);vec3 shadowedLight=vec3(0.0);
#endif
for (uint i=0u; i<nbDirs; i++) {uint dirId=nbDirs*GlobalIndex+i;vec4 L;vec2 T;{vec2 r=plasticSequence(frameId*nbDirs+i);r=fract(r+vec2(2.0)*abs(noise.xy-vec2(0.5)));T.x=textureLod(icdfSampler,vec2(r.x,0.0),0.0).x;T.y=textureLod(icdfSampler,vec2(T.x,r.y),0.0).y;L=vec4(uv_to_normal(vec2(T.x-normalizedRotation,T.y)),0);
#ifndef RIGHT_HANDED
L.z*=-1.0;
#endif
}
#ifdef COLOR_SHADOWS
vec3 lightDir=uv_to_normal(vec2(1.0-fract(T.x+0.25),T.y));vec3 ibl=textureLod(iblSampler,lightDir,0.0).xyz;float pdf=textureLod(icdfSampler,T,0.0).z;
#endif
float cosNL=dot(N,L.xyz);float opacity=0.0;if (cosNL>0.0) {vec4 VP2=VP;VP2.y*=-1.0;vec4 unormWP=invViewMtx*VP2;vec3 WP=(wsNormalizationMtx*unormWP).xyz;vec2 vxNoise=vec2(uint2float(hash(dirId*2u)),uint2float(hash(dirId*2u+1u)));
#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
VoxelMarchDiagnosticInfo voxel_march_diagnostic_info;opacity=max(opacity,shadowOpacity.x*voxelShadow(WP,L.xyz,N,vxNoise,voxel_march_diagnostic_info));heat+=voxel_march_diagnostic_info.heat;
#else
opacity =
max(opacity,shadowOpacity.x*voxelShadow(WP,L.xyz,N,vxNoise));
#endif
vec3 VL=(viewMtx*L).xyz;
#ifdef RIGHT_HANDED
float nearPlaneZ=-projMtx[3][2]/(projMtx[2][2]-1.0); 
float farPlaneZ=-projMtx[3][2]/(projMtx[2][2]+1.0);
#else
float nearPlaneZ=-projMtx[3][2]/(projMtx[2][2]+1.0); 
float farPlaneZ=-projMtx[3][2]/(projMtx[2][2]-1.0);
#endif
float ssShadow=shadowOpacity.y *
screenSpaceShadow(VP2.xyz,VL,Resolution,nearPlaneZ,farPlaneZ,
abs(2.0*noise.z-1.0));opacity=max(opacity,ssShadow);
#ifdef COLOR_SHADOWS
vec3 light=pdf<1e-6 ? vec3(0.0) : vec3(cosNL)/vec3(pdf)*ibl;shadowedLight+=light*opacity;totalLight+=light;
#else
float rcos=(1.0-cosNL);shadowAccum+=(1.0-opacity*(1.0-pow(rcos,8.0)));sampleWeight+=1.0;vec3 VR=-(viewMtx*vec4(reflect(-L.xyz,N),0.0)).xyz;specShadowAccum+=max(1.0-(opacity*pow(VR.z,8.0)),0.0);
#endif
}
noise.z=fract(noise.z+GOLD);}
#ifdef COLOR_SHADOWS
vec3 shadow=(totalLight-shadowedLight)/totalLight;float maxShadow=max(max(shadow.x,max(shadow.y,shadow.z)),1.0);glFragColor=vec4(shadow/maxShadow,1.0);
#else
#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
gl_FragColor=vec4(shadowAccum/float(sampleWeight),
specShadowAccum/float(sampleWeight),heat/float(sampleWeight),1.0);
#else
gl_FragColor=vec4(shadowAccum/float(sampleWeight),specShadowAccum/float(sampleWeight),0.0,1.0);
#endif
#endif
}`;S.ShadersStore[zC]||(S.ShadersStore[zC]=sj);const WC="iblShadowVoxelTracingPixelShader",nj=`#define PI 3.1415927
varying vUV: vec2f;
#define DISABLE_UNIFORMITY_ANALYSIS
var depthSampler: texture_2d<f32>;var worldNormalSampler : texture_2d<f32>;var blueNoiseSampler: texture_2d<f32>;var icdfSamplerSampler: sampler;var icdfSampler: texture_2d<f32>;var voxelGridSamplerSampler: sampler;var voxelGridSampler: texture_3d<f32>;
#ifdef COLOR_SHADOWS
var iblSamplerSampler: sampler;var iblSampler: texture_cube<f32>;
#endif
uniform shadowParameters: vec4f;
#define SHADOWdirs uniforms.shadowParameters.x
#define SHADOWframe uniforms.shadowParameters.y
#define SHADOWenvRot uniforms.shadowParameters.w
uniform voxelBiasParameters : vec4f;
#define highestMipLevel uniforms.voxelBiasParameters.z
uniform sssParameters: vec4f;
#define SSSsamples uniforms.sssParameters.x
#define SSSstride uniforms.sssParameters.y
#define SSSmaxDistance uniforms.sssParameters.z
#define SSSthickness uniforms.sssParameters.w
uniform shadowOpacity: vec4f;uniform projMtx: mat4x4f;uniform viewMtx: mat4x4f;uniform invProjMtx: mat4x4f;uniform invViewMtx: mat4x4f;uniform wsNormalizationMtx: mat4x4f;uniform invVPMtx: mat4x4f;
#define PI 3.1415927
#define GOLD 0.618034
struct AABB3f {m_min: vec3f,
m_max: vec3f,};struct Ray {orig: vec3f,
dir: vec3f,
dir_rcp: vec3f,
t_min: f32,
t_max: f32,};fn make_ray(origin: vec3f,direction: vec3f,tmin: f32,
tmax: f32)->Ray {var ray: Ray;ray.orig=origin;ray.dir=direction;ray.dir_rcp=1.0f/direction;ray.t_min=tmin;ray.t_max=tmax;return ray;}
fn ray_box_intersection(aabb: AABB3f,ray: Ray ,
distance_near: ptr<function,f32>,distance_far: ptr<function,f32>)->bool{var tbot: vec3f=ray.dir_rcp*(aabb.m_min-ray.orig);var ttop: vec3f=ray.dir_rcp*(aabb.m_max-ray.orig);var tmin: vec3f=min(ttop,tbot);var tmax: vec3f=max(ttop,tbot);*distance_near=max(ray.t_min,max(tmin.x,max(tmin.y,tmin.z)));*distance_far=min(ray.t_max,min(tmax.x,min(tmax.y,tmax.z)));return *distance_near<=*distance_far;}
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
struct VoxelMarchDiagnosticInfo {heat: f32,
voxel_intersect_coords: vec3i,};
#endif
fn hash(i: u32)->u32 {var temp=i ^ (i>>16u);temp*=0x7FEB352Du;temp ^= temp>>15u;temp*=0x846CA68Bu;temp ^= temp>>16u;return temp;}
fn uintBitsToFloat(x: u32)->f32 {return bitcast<f32>(x);}
fn uint2float(i: u32)->f32 {return uintBitsToFloat(0x3F800000u | (i>>9u))-1.0;}
fn uv_to_normal(uv: vec2f)->vec3f {var N: vec3f;var uvRange: vec2f=uv;var theta: f32=uvRange.x*2.0*PI;var phi: f32=uvRange.y*PI;N.x=cos(theta)*sin(phi);N.z=sin(theta)*sin(phi);N.y=cos(phi);return N;}
fn plasticSequence(rstate: u32)->vec2f {return vec2f(uint2float(rstate*3242174889u),
uint2float(rstate*2447445414u));}
fn goldenSequence(rstate: u32)->f32 {return uint2float(rstate*2654435769u);}
fn distanceSquared(a: vec2f,b: vec2f)->f32 {var diff: vec2f=a-b;return dot(diff,diff);}
fn genTB(N: vec3f,T: ptr<function,vec3f>,B: ptr<function,vec3f>) {var s: f32=select(1.0,-1.0,N.z<0.0);var a: f32=-1.0/(s+N.z);var b: f32=N.x*N.y*a;*T= vec3f(1.0+s*N.x*N.x*a,s*b,-s*N.x);*B= vec3f(b,s+N.y*N.y*a,-N.y);}
fn lessThan(x: vec3f,y: vec3f)->vec3<bool> {return x<y;}
#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
fn anyHitVoxels(ray_vs: Ray,
voxel_march_diagnostic_info: ptr<function,VoxelMarchDiagnosticInfo>)->bool {
#else
fn anyHitVoxels(ray_vs: Ray)->bool {
#endif
var stack=array<i32,24>(); 
var invD: vec3f=ray_vs.dir_rcp;var D: vec3f=ray_vs.dir;var O: vec3f=ray_vs.orig;var negD=vec3i(lessThan(D, vec3f(0,0,0)));var voxel0: i32=negD.x | (negD.y<<1) | (negD.z<<2);var t0: vec3f=-O*invD;var t1=(vec3f(1.0)-O)*invD;var maxLod: i32= i32(highestMipLevel);var stackLevel: i32=0;
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
var steps: u32=0u;
#endif
stack[stackLevel]=maxLod<<24;stackLevel++;while (stackLevel>0) {stackLevel=stackLevel-1;var elem: i32=stack[stackLevel];var Coords: vec4i =
vec4i(elem & 0xFF,(elem>>8) & 0xFF,(elem>>16) & 0xFF,elem>>24);if (Coords.w==0) {
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
*voxel_march_diagnostic_info.heat= f32(steps)/24.0;
#endif
return true;}
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
++steps;
#endif
var invRes: f32=exp2(f32(Coords.w-maxLod));var bbmin: vec3f=invRes*vec3f(Coords.xyz+negD);var bbmax: vec3f=invRes*vec3f(Coords.xyz-negD+vec3i(1));var mint: vec3f=mix(t0,t1,bbmin);var maxt: vec3f=mix(t0,t1,bbmax);var midt: vec3f=0.5*(mint+maxt);mint.x=max(0.0,mint.x);midt.x=max(0.0,midt.x);var nodeMask: u32= u32(
round(textureLoad(voxelGridSampler,Coords.xyz,Coords.w).x*255.0));Coords.w--;var voxelBit: u32=u32(voxel0);Coords=vec4i((Coords.xyz<<vec3u(1))+negD,Coords.w);var packedCoords: i32 =
Coords.x | (Coords.y<<8) | (Coords.z<<16) | (Coords.w<<24);if (max(mint.x,max(mint.y,mint.z))<min(midt.x,min(midt.y,midt.z)) &&
((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}
voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(midt.x,max(mint.y,mint.z))<min(maxt.x,min(midt.y,midt.z)) &&
((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}
voxelBit ^= 0x2;packedCoords ^= 0x00100;if (max(midt.x,max(midt.y,mint.z))<min(maxt.x,min(maxt.y,midt.z)) &&
((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}
voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(mint.x,max(midt.y,mint.z))<min(midt.x,min(maxt.y,midt.z)) &&
((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}
voxelBit ^= 0x4;packedCoords ^= 0x10000;if (max(mint.x,max(midt.y,midt.z))<min(midt.x,min(maxt.y,maxt.z)) &&
((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}
voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(midt.x,max(midt.y,midt.z))<min(maxt.x,min(maxt.y,maxt.z)) &&
((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}
voxelBit ^= 0x2;packedCoords ^= 0x00100;if (max(midt.x,max(mint.y,midt.z))<min(maxt.x,min(midt.y,maxt.z)) &&
((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}
voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(mint.x,max(mint.y,midt.z))<min(midt.x,min(midt.y,maxt.z)) &&
((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}}
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
*voxel_march_diagnostic_info.heat= f32(steps)/24.0;
#endif
return false;}
fn linearizeDepth(depth: f32,near: f32,far: f32)->f32 {return (near*far)/(far-depth*(far-near));}
fn screenSpaceShadow(csOrigin: vec3f,csDirection: vec3f,csZBufferSize: vec2f,
nearPlaneZ: f32,farPlaneZ: f32,noise: f32)->f32 {
#ifdef RIGHT_HANDED
var csZDir : f32=-1.0;
#else 
var csZDir : f32=1.0;
#endif
var ssSamples: f32=SSSsamples;var ssMaxDist: f32=SSSmaxDistance;var ssStride: f32=SSSstride;var ssThickness: f32=SSSthickness;var rayLength: f32 =
select(ssMaxDist,(nearPlaneZ-csOrigin.z)/csDirection.z,
csZDir*(csOrigin.z+ssMaxDist*csDirection.z)<csZDir*nearPlaneZ);var csEndPoint: vec3f=csOrigin+rayLength*csDirection;var H0: vec4f=uniforms.projMtx*vec4f(csOrigin,1.0);var H1: vec4f=uniforms.projMtx*vec4f(csEndPoint,1.0);var Z0=vec2f(csOrigin.z ,1.0)/H0.w;var Z1=vec2f(csEndPoint.z,1.0)/H1.w;var P0=csZBufferSize*(0.5*H0.xy*Z0.y+0.5);var P1=csZBufferSize*(0.5*H1.xy*Z1.y+0.5);P1+= vec2f(select(0.0,0.01,distanceSquared(P0,P1)<0.0001));var delta: vec2f=P1-P0;var permute: bool=false;if (abs(delta.x)<abs(delta.y)) {permute=true;P0=P0.yx;P1=P1.yx;delta=delta.yx;}
var stepDirection: f32=sign(delta.x);var invdx: f32=stepDirection/delta.x;var dP: vec2f=ssStride* vec2f(stepDirection,invdx*delta.y);var dZ: vec2f=ssStride*invdx*(Z1-Z0);var opacity: f32=0.0;var P: vec2f=P0+noise*dP;var Z: vec2f=Z0+noise*dZ;var end: f32=P1.x*stepDirection;var rayZMax=csZDir*Z.x/Z.y;var sceneDepth=rayZMax;Z+=dZ;for (var stepCount: f32=0.0; 
opacity<1.0 && P.x*stepDirection<end && sceneDepth>0.0 && stepCount<ssSamples;stepCount+=1) { 
var coords=vec2i(select(P,P.yx,permute));sceneDepth=textureLoad(depthSampler,coords,0).x;sceneDepth=linearizeDepth(sceneDepth,nearPlaneZ,farPlaneZ);sceneDepth=csZDir*sceneDepth;if (sceneDepth<=0.0) {break;}
var rayZMin: f32=rayZMax;rayZMax=csZDir*Z.x/Z.y;opacity+=max(opacity,step(rayZMax,sceneDepth+ssThickness)*step(sceneDepth,rayZMin));P+=dP;Z+=dZ;}
return opacity;}
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
fn voxelShadow(wsOrigin: vec3f,wsDirection: vec3f,wsNormal: vec3f,
DitherNoise: vec2f,
voxel_march_diagnostic_info: ptr<function,VoxelMarchDiagnosticInfo>)->f32 {
#else
fn voxelShadow(wsOrigin: vec3f,wsDirection: vec3f,wsNormal: vec3f,
DitherNoise: vec2f)->f32 {
#endif
var vxResolution: f32=f32(textureDimensions(voxelGridSampler,0).x);var T: vec3f;var B: vec3f;genTB(wsDirection,&T,&B);var DitherXY: vec2f=sqrt(DitherNoise.x)* vec2f(cos(2.0*PI*DitherNoise.y),
sin(2.0*PI*DitherNoise.y));var Dithering : vec3f=(uniforms.voxelBiasParameters.x*wsNormal +
uniforms.voxelBiasParameters.y*wsDirection +
DitherXY.x*T+DitherXY.y*B) /
vxResolution;var O: vec3f=0.5*wsOrigin+0.5+Dithering;var ray_vs=make_ray(O,wsDirection,0.0,10.0);var voxel_aabb: AABB3f;voxel_aabb.m_min=vec3f(0);voxel_aabb.m_max=vec3f(1);var near: f32=0;var far: f32=0;if (!ray_box_intersection(voxel_aabb,ray_vs,&near,&far)) {return 0.0;}
ray_vs.t_min=max(ray_vs.t_min,near);ray_vs.t_max=min(ray_vs.t_max,far);
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
return select(0.0f,1.0f,anyHitVoxels(ray_vs,voxel_march_diagnostic_info));
#else
return select(0.0f,1.0f,anyHitVoxels(ray_vs));
#endif
}
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var nbDirs=u32(SHADOWdirs);var frameId=u32(SHADOWframe);var envRot: f32=SHADOWenvRot;var Resolution: vec2f= vec2f(textureDimensions(depthSampler,0));var currentPixel=vec2i(fragmentInputs.vUV*Resolution);var GlobalIndex =
(frameId*u32(Resolution.y)+u32(currentPixel.y))*u32(Resolution.x) +
u32(currentPixel.x);var N : vec3f=textureLoad(worldNormalSampler,currentPixel,0).xyz;if (length(N)<0.01) {fragmentOutputs.color=vec4f(1.0,1.0,0.0,1.0);return fragmentOutputs;}
var normalizedRotation: f32=envRot/(2.0*PI);var depth : f32=textureLoad(depthSampler,currentPixel,0).x;
#ifndef IS_NDC_HALF_ZRANGE
depth=depth*2.0-1.0;
#endif
var temp : vec2f=(vec2f(currentPixel)+vec2f(0.5))*2.0/Resolution -
vec2f(1.0);var VP : vec4f=uniforms.invProjMtx*vec4f(temp.x,-temp.y,depth,1.0);VP/=VP.w;N=normalize(N);var noise : vec3f=textureLoad(blueNoiseSampler,currentPixel & vec2i(0xFF),0).xyz;noise.z=fract(noise.z+goldenSequence(frameId*nbDirs));
#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
var heat: f32=0.0f;
#endif
var shadowAccum: f32=0.001;var specShadowAccum: f32=0.001;var sampleWeight : f32=0.001;
#ifdef COLOR_SHADOWS
var totalLight: vec3f=vec3f(0.001);var shadowedLight: vec3f=vec3f(0.0);
#endif
for (var i: u32=0; i<nbDirs; i++) {var dirId: u32=nbDirs*GlobalIndex+i;var L: vec4f;var T: vec2f;{var r: vec2f=plasticSequence(frameId*nbDirs+i);r=fract(r+ vec2f(2.0)*abs(noise.xy- vec2f(0.5)));T.x=textureSampleLevel(icdfSampler,icdfSamplerSampler,vec2f(r.x,0.0),0.0).x;T.y=textureSampleLevel(icdfSampler,icdfSamplerSampler,vec2f(T.x,r.y),0.0).y;L= vec4f(uv_to_normal(vec2f(T.x-normalizedRotation,T.y)),0);
#ifndef RIGHT_HANDED
L.z*=-1.0;
#endif
}
#ifdef COLOR_SHADOWS
var lightDir: vec3f=uv_to_normal(vec2f(1.0-fract(T.x+0.25),T.y));var ibl: vec3f=textureSampleLevel(iblSampler,iblSamplerSampler,lightDir,0.0).xyz;var pdf: f32=textureSampleLevel(icdfSampler,icdfSamplerSampler,T,0.0).z;
#endif
var cosNL: f32=dot(N,L.xyz);var opacity: f32=0.0;if (cosNL>0.0) {var VP2: vec4f=VP;VP2.y*=-1.0;var unormWP : vec4f=uniforms.invViewMtx*VP2;var WP: vec3f=(uniforms.wsNormalizationMtx*unormWP).xyz;var vxNoise: vec2f=vec2f(uint2float(hash(dirId*2)),uint2float(hash(dirId*2+1)));
#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
VoxelMarchDiagnosticInfo voxel_march_diagnostic_info;opacity=max(opacity,
uniforms.shadowOpacity.x*voxelShadow(WP,L.xyz,N,vxNoise,
voxel_march_diagnostic_info));heat+=voxel_march_diagnostic_info.heat;
#else
opacity =
max(opacity,uniforms.shadowOpacity.x*voxelShadow(WP,L.xyz,N,vxNoise));
#endif
var VL : vec3f=(uniforms.viewMtx*L).xyz;
#ifdef RIGHT_HANDED
var nearPlaneZ: f32=-2.0*uniforms.projMtx[3][2]/(uniforms.projMtx[2][2]-1.0); 
var farPlaneZ: f32=-uniforms.projMtx[3][2]/(uniforms.projMtx[2][2]+1.0);
#else
var nearPlaneZ: f32=-2.0*uniforms.projMtx[3][2]/(uniforms.projMtx[2][2]+1.0); 
var farPlaneZ: f32=-uniforms.projMtx[3][2]/(uniforms.projMtx[2][2]-1.0);
#endif
var ssShadow: f32=uniforms.shadowOpacity.y *
screenSpaceShadow(VP2.xyz,VL,Resolution,nearPlaneZ,farPlaneZ,
abs(2.0*noise.z-1.0));opacity=max(opacity,ssShadow);
#ifdef COLOR_SHADOWS
var light: vec3f=select(vec3f(0.0),vec3f(cosNL)/vec3f(pdf)*ibl,pdf>1e-6);shadowedLight+=light*opacity;totalLight+=light;
#else
var rcos: f32=1.0-cosNL;shadowAccum+=(1.0-opacity*(1.0-pow(rcos,8.0)));sampleWeight+=1.0;var VR : vec3f=abs((uniforms.viewMtx*vec4f(reflect(-L.xyz,N),0.0)).xyz);specShadowAccum+=max(1.0-(opacity*pow(VR.z,8.0)),0.0);
#endif
}
noise.z=fract(noise.z+GOLD);}
#ifdef COLOR_SHADOWS
var shadow: vec3f=(totalLight-shadowedLight)/totalLight;var maxShadow: f32=max(max(shadow.x,max(shadow.y,shadow.z)),1.0);fragmentOutputs.color=vec4f(shadow/maxShadow,1.0);
#else
#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
fragmentOutputs.color =
vec4f(shadowAccum/sampleWeight,specShadowAccum/sampleWeight,heat/sampleWeight,1.0);
#else
fragmentOutputs.color=vec4f(shadowAccum/sampleWeight,specShadowAccum/sampleWeight,0.0,1.0);
#endif
#endif
}`;S.ShadersStoreWGSL[WC]||(S.ShadersStoreWGSL[WC]=nj);const HC="iblShadowDebugPixelShader",aj=`#ifdef GL_ES
precision mediump float;
#endif
varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D debugSampler;uniform vec4 sizeParams;
#define offsetX sizeParams.x
#define offsetY sizeParams.y
#define widthScale sizeParams.z
#define heightScale sizeParams.w
void main(void) {vec2 uv =
vec2((offsetX+vUV.x)*widthScale,(offsetY+vUV.y)*heightScale);vec4 background=texture2D(textureSampler,vUV);vec4 debugColour=texture2D(debugSampler,vUV);if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {gl_FragColor.rgba=background;} else {gl_FragColor.rgb=mix(debugColour.rgb,background.rgb,0.0);gl_FragColor.a=1.0;}}`;S.ShadersStore[HC]||(S.ShadersStore[HC]=aj);const $C="iblShadowDebugPixelShader",oj=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var debugSamplerSampler: sampler;var debugSampler: texture_2d<f32>;uniform sizeParams: vec4f;
#define offsetX uniforms.sizeParams.x
#define offsetY uniforms.sizeParams.y
#define widthScale uniforms.sizeParams.z
#define heightScale uniforms.sizeParams.w
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var uv: vec2f =
vec2f((offsetX+fragmentInputs.vUV.x)*widthScale,(offsetY+fragmentInputs.vUV.y)*heightScale);var background: vec4f=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.vUV);var debugColour: vec4f=textureSample(debugSampler,debugSamplerSampler,fragmentInputs.vUV);if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {fragmentOutputs.color=background;} else {fragmentOutputs.color=vec4f(mix(debugColour.rgb,background.rgb,0.0),1.0);}}`;S.ShadersStoreWGSL[$C]||(S.ShadersStoreWGSL[$C]=oj);const XC="iblShadowSpatialBlurPixelShader",lj=`#define PI 3.1415927
varying vUV: vec2f;var depthSampler: texture_2d<f32>;var worldNormalSampler: texture_2d<f32>;var voxelTracingSampler : texture_2d<f32>;uniform blurParameters: vec4f;
#define stridef uniforms.blurParameters.x
#define worldScale uniforms.blurParameters.y
const weights=array<f32,5>(0.0625,0.25,0.375,0.25,0.0625);const nbWeights: i32=5;fn max2(v: vec2f,w: vec2f)->vec2f {return vec2f(max(v.x,w.x),max(v.y,w.y));}
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var gbufferRes=vec2f(textureDimensions(depthSampler,0));var gbufferPixelCoord= vec2i(fragmentInputs.vUV*gbufferRes);var shadowRes=vec2f(textureDimensions(voxelTracingSampler,0));var shadowPixelCoord= vec2i(fragmentInputs.vUV*shadowRes);var N: vec3f=textureLoad(worldNormalSampler,gbufferPixelCoord,0).xyz;if (length(N)<0.01) {fragmentOutputs.color=vec4f(1.0,1.0,0.0,1.0);return fragmentOutputs;}
var depth: f32=-textureLoad(depthSampler,gbufferPixelCoord,0).x;var X: vec4f= vec4f(0.0);for(var y: i32=0; y<nbWeights; y++) {for(var x: i32=0; x<nbWeights; x++) {var gBufferCoords: vec2i=gbufferPixelCoord+i32(stridef)*vec2i(x-(nbWeights>>1),y-(nbWeights>>1));var shadowCoords: vec2i=shadowPixelCoord+i32(stridef)*vec2i(x-(nbWeights>>1),y-(nbWeights>>1));var T : vec3f=textureLoad(voxelTracingSampler,shadowCoords,0).xyz;var ddepth: f32=-textureLoad(depthSampler,gBufferCoords,0).x-depth;var dN: vec3f=textureLoad(worldNormalSampler,gBufferCoords,0).xyz-N;var w: f32=weights[x]*weights[y] *
exp2(max(-1000.0/(worldScale*worldScale),-0.5) *
(ddepth*ddepth) -
1e1*dot(dN,dN));X+= vec4f(w*T.x,w*T.y,w*T.z,w);}}
fragmentOutputs.color= vec4f(X.x/X.w,X.y/X.w,X.z/X.w,1.0);}`;S.ShadersStoreWGSL[XC]||(S.ShadersStoreWGSL[XC]=lj);const YC="iblShadowSpatialBlurPixelShader",cj=`precision highp sampler2D;
#define PI 3.1415927
varying vec2 vUV;uniform sampler2D depthSampler;uniform sampler2D worldNormalSampler;uniform sampler2D voxelTracingSampler;uniform vec4 blurParameters;
#define stridef blurParameters.x
#define worldScale blurParameters.y
const float weights[5]=float[5](0.0625,0.25,0.375,0.25,0.0625);const int nbWeights=5;vec2 max2(vec2 v,vec2 w) {return vec2(max(v.x,w.x),max(v.y,w.y));}
void main(void)
{vec2 gbufferRes=vec2(textureSize(depthSampler,0));ivec2 gbufferPixelCoord=ivec2(vUV*gbufferRes);vec2 shadowRes=vec2(textureSize(voxelTracingSampler,0));ivec2 shadowPixelCoord=ivec2(vUV*shadowRes);vec3 N=texelFetch(worldNormalSampler,gbufferPixelCoord,0).xyz;if (length(N)<0.01) {glFragColor=vec4(1.0,1.0,0.0,1.0);return;}
float depth=-texelFetch(depthSampler,gbufferPixelCoord,0).x;vec4 X=vec4(0.0);for(int y=0; y<nbWeights; ++y) {for(int x=0; x<nbWeights; ++x) {ivec2 gBufferCoords=gbufferPixelCoord+int(stridef)*ivec2(x-(nbWeights>>1),y-(nbWeights>>1));ivec2 shadowCoords=shadowPixelCoord+int(stridef)*ivec2(x-(nbWeights>>1),y-(nbWeights>>1));vec4 T=texelFetch(voxelTracingSampler,shadowCoords,0);float ddepth=-texelFetch(depthSampler,gBufferCoords,0).x-depth;vec3 dN=texelFetch(worldNormalSampler,gBufferCoords,0).xyz-N;float w=weights[x]*weights[y] *
exp2(max(-1000.0/(worldScale*worldScale),-0.5) *
(ddepth*ddepth) -
1e1*dot(dN,dN));X+=vec4(w*T.x,w*T.y,w*T.z,w);}}
gl_FragColor=vec4(X.x/X.w,X.y/X.w,X.z/X.w,1.0);}`;S.ShadersStore[YC]||(S.ShadersStore[YC]=cj);const jC="iblShadowAccumulationPixelShader",uj=`varying vUV: vec2f;uniform accumulationParameters: vec4f;
#define remanence uniforms.accumulationParameters.x
#define resetb uniforms.accumulationParameters.y
#define sceneSize uniforms.accumulationParameters.z
var motionSampler: texture_2d<f32>;var positionSampler: texture_2d<f32>;var spatialBlurSampler : texture_2d<f32>;var oldAccumulationSamplerSampler: sampler;var oldAccumulationSampler: texture_2d<f32>;var prevPositionSamplerSampler: sampler;var prevPositionSampler: texture_2d<f32>;fn max2(v: vec2f,w: vec2f)->vec2f { 
return vec2f(max(v.x,w.x),max(v.y,w.y)); }
fn lessThan(x: vec2f,y: vec2f)->vec2<bool> {return x<y;}
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var reset: bool= bool(resetb);var gbufferRes : vec2f=vec2f(textureDimensions(positionSampler,0));var gbufferPixelCoord: vec2i= vec2i(input.vUV*gbufferRes);var shadowRes : vec2f=vec2f(textureDimensions(spatialBlurSampler,0));var shadowPixelCoord: vec2i= vec2i(input.vUV*shadowRes);var LP: vec4f=textureLoad(positionSampler,gbufferPixelCoord,0);if (0.0==LP.w) {fragmentOutputs.color=vec4f(1.0,0.0,0.0,1.0);return fragmentOutputs;}
var velocityColor: vec2f=textureLoad(motionSampler,gbufferPixelCoord,0).xy;var prevCoord: vec2f=input.vUV+velocityColor;var PrevLP: vec3f=textureSampleLevel(prevPositionSampler,prevPositionSamplerSampler,prevCoord,0.0).xyz;var PrevShadows: vec4f=textureSampleLevel(oldAccumulationSampler,oldAccumulationSamplerSampler,prevCoord,0.0);var newShadows : vec3f=textureLoad(spatialBlurSampler,shadowPixelCoord,0).xyz;PrevShadows.a=select(1.0,max(PrevShadows.a/(1.0+PrevShadows.a),1.0-remanence),!reset && all(lessThan(abs(prevCoord- vec2f(0.5)), vec2f(0.5))) &&
distance(LP.xyz,PrevLP)<5e-2*sceneSize);PrevShadows=max( vec4f(0.0),PrevShadows);fragmentOutputs.color= vec4f(mix(PrevShadows.x,newShadows.x,PrevShadows.a),
mix(PrevShadows.y,newShadows.y,PrevShadows.a),
mix(PrevShadows.z,newShadows.z,PrevShadows.a),PrevShadows.a);}`;S.ShadersStoreWGSL[jC]||(S.ShadersStoreWGSL[jC]=uj);const qC="iblShadowAccumulationPixelShader",hj=`#ifdef GL_ES
precision mediump float;
#endif
varying vec2 vUV;uniform vec4 accumulationParameters;
#define remanence accumulationParameters.x
#define resetb accumulationParameters.y
#define sceneSize accumulationParameters.z
uniform sampler2D motionSampler;uniform sampler2D positionSampler;uniform sampler2D spatialBlurSampler;uniform sampler2D oldAccumulationSampler;uniform sampler2D prevPositionSampler;vec2 max2(vec2 v,vec2 w) { return vec2(max(v.x,w.x),max(v.y,w.y)); }
void main(void) {bool reset=bool(resetb);vec2 gbufferRes=vec2(textureSize(motionSampler,0));ivec2 gbufferPixelCoord=ivec2(vUV*gbufferRes);vec2 shadowRes=vec2(textureSize(spatialBlurSampler,0));ivec2 shadowPixelCoord=ivec2(vUV*shadowRes);vec4 LP=texelFetch(positionSampler,gbufferPixelCoord,0);if (0.0==LP.w) {gl_FragColor=vec4(1.0,0.0,0.0,1.0);return;}
vec2 velocityColor=texelFetch(motionSampler,gbufferPixelCoord,0).xy;vec2 prevCoord=vUV+velocityColor;vec3 PrevLP=texture(prevPositionSampler,prevCoord).xyz;vec4 PrevShadows=texture(oldAccumulationSampler,prevCoord);vec3 newShadows=texelFetch(spatialBlurSampler,shadowPixelCoord,0).xyz;PrevShadows.a =
!reset && all(lessThan(abs(prevCoord-vec2(0.5)),vec2(0.5))) &&
distance(LP.xyz,PrevLP)<5e-2*sceneSize
? max(PrevShadows.a/(1.0+PrevShadows.a),1.0-remanence)
: 1.0;PrevShadows=max(vec4(0.0),PrevShadows);gl_FragColor =
vec4(mix(PrevShadows.x,newShadows.x,PrevShadows.a),
mix(PrevShadows.y,newShadows.y,PrevShadows.a),
mix(PrevShadows.z,newShadows.z,PrevShadows.a),PrevShadows.a);}`;S.ShadersStore[qC]||(S.ShadersStore[qC]=hj);const ZC="iblShadowsCombinePixelShader",dj=`precision highp float;varying vec2 vUV;uniform sampler2D shadowSampler;uniform sampler2D textureSampler;uniform float shadowOpacity;void main(void)
{vec3 shadow=texture(shadowSampler,vUV).rgb;vec3 sceneColor=texture(textureSampler,vUV).rgb;float shadowValue=mix(1.0,shadow.x,shadowOpacity);gl_FragColor=vec4(sceneColor*shadowValue,1.0);}`;S.ShadersStore[ZC]||(S.ShadersStore[ZC]=dj);const QC="iblShadowsCombinePixelShader",fj=`varying vUV: vec2f;var shadowSamplerSampler : sampler;var shadowSampler : texture_2d<f32>;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform shadowOpacity: f32;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var shadow
: vec3f =
textureSample(shadowSampler,shadowSamplerSampler,input.vUV).rgb;var color
: vec3f =
textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;var shadowValue: f32=mix(1.0,shadow.x,uniforms.shadowOpacity);fragmentOutputs.color=vec4f(color*shadowValue,1.0);}`;S.ShadersStoreWGSL[QC]||(S.ShadersStoreWGSL[QC]=fj);const KC="iblCombineVoxelGridsPixelShader",pj=`varying vUV: vec2f;var voxelXaxisSamplerSampler: sampler;var voxelXaxisSampler: texture_3d<f32>;var voxelYaxisSamplerSampler: sampler;var voxelYaxisSampler: texture_3d<f32>;var voxelZaxisSamplerSampler: sampler;var voxelZaxisSampler: texture_3d<f32>;uniform layer: f32;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var coordZ: vec3f= vec3f(fragmentInputs.vUV.x,fragmentInputs.vUV.y,uniforms.layer);var voxelZ: f32=textureSample(voxelZaxisSampler,voxelZaxisSamplerSampler,coordZ).r;var coordX: vec3f= vec3f(1.0-uniforms.layer,fragmentInputs.vUV.y,fragmentInputs.vUV.x);var voxelX: f32=textureSample(voxelXaxisSampler,voxelXaxisSamplerSampler,coordX).r;var coordY: vec3f= vec3f(uniforms.layer,fragmentInputs.vUV.x,fragmentInputs.vUV.y);var voxelY: f32=textureSample(voxelYaxisSampler,voxelYaxisSamplerSampler,coordY).r;var voxel=select(0.0,1.0,(voxelX>0.0 || voxelY>0.0 || voxelZ>0.0));fragmentOutputs.color= vec4f( vec3f(voxel),1.0);}`;S.ShadersStoreWGSL[KC]||(S.ShadersStoreWGSL[KC]=pj);const JC="iblCombineVoxelGridsPixelShader",mj="precision highp float;precision highp sampler3D;varying vec2 vUV;uniform sampler3D voxelXaxisSampler;uniform sampler3D voxelYaxisSampler;uniform sampler3D voxelZaxisSampler;uniform float layer;void main(void) {vec3 coordZ=vec3(vUV.x,vUV.y,layer);float voxelZ=texture(voxelZaxisSampler,coordZ).r;vec3 coordX=vec3(1.0-layer,vUV.y,vUV.x);float voxelX=texture(voxelXaxisSampler,coordX).r;vec3 coordY=vec3(layer,vUV.x,vUV.y);float voxelY=texture(voxelYaxisSampler,coordY).r;float voxel=(voxelX>0.0 || voxelY>0.0 || voxelZ>0.0) ? 1.0 : 0.0;glFragColor=vec4(vec3(voxel),1.0);}";S.ShadersStore[JC]||(S.ShadersStore[JC]=mj);const ey="iblGenerateVoxelMipPixelShader",_j=`precision highp float;precision highp sampler3D;varying vec2 vUV;uniform sampler3D srcMip;uniform int layerNum;void main(void) {ivec3 Coords=ivec3(2)*ivec3(gl_FragCoord.x,gl_FragCoord.y,layerNum);uint tex =
uint(texelFetch(srcMip,Coords+ivec3(0,0,0),0).x>0.0f ? 1u : 0u)
<< 0u |
uint(texelFetch(srcMip,Coords+ivec3(1,0,0),0).x>0.0f ? 1u : 0u)
<< 1u |
uint(texelFetch(srcMip,Coords+ivec3(0,1,0),0).x>0.0f ? 1u : 0u)
<< 2u |
uint(texelFetch(srcMip,Coords+ivec3(1,1,0),0).x>0.0f ? 1u : 0u)
<< 3u |
uint(texelFetch(srcMip,Coords+ivec3(0,0,1),0).x>0.0f ? 1u : 0u)
<< 4u |
uint(texelFetch(srcMip,Coords+ivec3(1,0,1),0).x>0.0f ? 1u : 0u)
<< 5u |
uint(texelFetch(srcMip,Coords+ivec3(0,1,1),0).x>0.0f ? 1u : 0u)
<< 6u |
uint(texelFetch(srcMip,Coords+ivec3(1,1,1),0).x>0.0f ? 1u : 0u)
<< 7u;glFragColor.rgb=vec3(float(tex)/255.0f,0.0f,0.0f);glFragColor.a=1.0;}`;S.ShadersStore[ey]||(S.ShadersStore[ey]=_j);const ty="iblGenerateVoxelMipPixelShader",gj=`varying vUV: vec2f;var srcMip: texture_3d<f32>;uniform layerNum: i32;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var Coords=vec3i(2)*vec3i(vec2i(fragmentInputs.position.xy),uniforms.layerNum);var tex =
(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(0,0,0),0).x>0.0f))
<< 0u) |
(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(1,0,0),0).x>0.0f))
<< 1u) |
(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(0,1,0),0).x>0.0f))
<< 2u) |
(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(1,1,0),0).x>0.0f))
<< 3u) |
(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(0,0,1),0).x>0.0f))
<< 4u) |
(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(1,0,1),0).x>0.0f))
<< 5u) |
(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(0,1,1),0).x>0.0f))
<< 6u) |
(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(1,1,1),0).x>0.0f))
<< 7u);fragmentOutputs.color=vec4f( f32(tex)/255.0f,0.0f,0.0f,1.0);}`;S.ShadersStoreWGSL[ty]||(S.ShadersStoreWGSL[ty]=gj);const iy="iblShadowGBufferDebugPixelShader",Sj=`#ifdef GL_ES
precision mediump float;
#endif
varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D depthSampler;uniform sampler2D normalSampler;uniform sampler2D positionSampler;uniform sampler2D velocitySampler;uniform vec4 sizeParams;uniform float maxDepth;
#define offsetX sizeParams.x
#define offsetY sizeParams.y
#define widthScale sizeParams.z
#define heightScale sizeParams.w
void main(void) {vec2 uv =
vec2((offsetX+vUV.x)*widthScale,(offsetY+vUV.y)*heightScale);vec4 backgroundColour=texture2D(textureSampler,vUV).rgba;vec4 depth=texture2D(depthSampler,vUV);vec4 worldNormal=texture2D(normalSampler,vUV);vec4 worldPosition=texture2D(positionSampler,vUV);vec4 velocityLinear=texture2D(velocitySampler,vUV);if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {gl_FragColor.rgba=backgroundColour;} else {gl_FragColor.a=1.0;if (uv.x<=0.25) {gl_FragColor.rgb=depth.rgb;gl_FragColor.a=1.0;} else if (uv.x<=0.5) {velocityLinear.rg=velocityLinear.rg*0.5+0.5;gl_FragColor.rgb=velocityLinear.rgb;} else if (uv.x<=0.75) {gl_FragColor.rgb=worldPosition.rgb;} else {gl_FragColor.rgb=worldNormal.rgb;}}}`;S.ShadersStore[iy]||(S.ShadersStore[iy]=Sj);const ry="iblShadowGBufferDebugPixelShader",vj=`varying vUV : vec2f;var textureSamplerSampler : sampler;var textureSampler : texture_2d<f32>;var depthSamplerSampler : sampler;var depthSampler : texture_2d<f32>;var normalSamplerSampler : sampler;var normalSampler : texture_2d<f32>;var positionSamplerSampler : sampler;var positionSampler : texture_2d<f32>;var velocitySamplerSampler : sampler;var velocitySampler : texture_2d<f32>;uniform sizeParams : vec4f;
#define offsetX uniforms.sizeParams.x
#define offsetY uniforms.sizeParams.y
#define widthScale uniforms.sizeParams.z
#define heightScale uniforms.sizeParams.w
@fragment fn main(input : FragmentInputs)->FragmentOutputs {var uv : vec2f=
vec2f((offsetX+input.vUV.x)*widthScale,(offsetY+input.vUV.y)*heightScale);var backgroundColour: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgba;var depth : vec4f=textureSample(depthSampler,depthSamplerSampler,input.vUV);var worldNormal: vec4f=textureSample(normalSampler,normalSamplerSampler,input.vUV);var worldPosition : vec4f=textureSample(positionSampler,positionSamplerSampler,input.vUV);var velocityLinear : vec4f=textureSample(velocitySampler,velocitySamplerSampler,input.vUV);if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {fragmentOutputs.color=backgroundColour;} else {if (uv.x<=0.25) {fragmentOutputs.color=vec4f(depth.rgb,1.0);} else if (uv.x<=0.5) {velocityLinear =
vec4f(velocityLinear.r*0.5+0.5,velocityLinear.g*0.5+0.5,
velocityLinear.b,velocityLinear.a);fragmentOutputs.color=vec4f(velocityLinear.rgb,1.0);} else if (uv.x<=0.75) {fragmentOutputs.color=vec4f(worldPosition.rgb,1.0);} else {fragmentOutputs.color=vec4f(worldNormal.rgb,1.0);}}}`;S.ShadersStoreWGSL[ry]||(S.ShadersStoreWGSL[ry]=vj);const sm="iblCdfxPixelShader",BO=`#define PI 3.1415927
varying vUV: vec2f;var cdfy: texture_2d<f32>;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var cdfyRes=textureDimensions(cdfy,0);var currentPixel=vec2u(fragmentInputs.position.xy);var cdfx: f32=0.0;for (var x: u32=1; x<=currentPixel.x; x++) {cdfx+=textureLoad(cdfy, vec2u(x-1,cdfyRes.y-1),0).x;}
fragmentOutputs.color= vec4f( vec3f(cdfx),1.0);}`;S.ShadersStoreWGSL[sm]||(S.ShadersStoreWGSL[sm]=BO);const xj={name:sm,shader:BO},Ej=Object.freeze(Object.defineProperty({__proto__:null,iblCdfxPixelShaderWGSL:xj},Symbol.toStringTag,{value:"Module"})),nm="iblCdfxPixelShader",VO=`precision highp sampler2D;
#define PI 3.1415927
varying vec2 vUV;uniform sampler2D cdfy;void main(void) {ivec2 cdfyRes=textureSize(cdfy,0);ivec2 currentPixel=ivec2(gl_FragCoord.xy);float cdfx=0.0;for (int x=1; x<=currentPixel.x; x++) {cdfx+=texelFetch(cdfy,ivec2(x-1,cdfyRes.y-1),0).x;}
gl_FragColor=vec4(vec3(cdfx),1.0);}`;S.ShadersStore[nm]||(S.ShadersStore[nm]=VO);const Tj={name:nm,shader:VO},bj=Object.freeze(Object.defineProperty({__proto__:null,iblCdfxPixelShader:Tj},Symbol.toStringTag,{value:"Module"})),am="iblCdfyPixelShader",UO=`varying vUV : vec2f;
#include <helperFunctions>
#ifdef IBL_USE_CUBE_MAP
var iblSourceSampler: sampler;var iblSource: texture_cube<f32>;
#else
var iblSourceSampler: sampler;var iblSource: texture_2d<f32>;
#endif
uniform iblHeight: i32;
#ifdef IBL_USE_CUBE_MAP
fn fetchCube(uv: vec2f)->f32 {var direction: vec3f=equirectangularToCubemapDirection(uv);return sin(PI*uv.y) *
dot(textureSampleLevel(iblSource,iblSourceSampler,direction,0.0)
.rgb,
LuminanceEncodeApprox);}
#else
fn fetchPanoramic(Coords: vec2i,envmapHeight: f32)->f32 {return sin(PI*(f32(Coords.y)+0.5)/envmapHeight) *
dot(textureLoad(iblSource,Coords,0).rgb,LuminanceEncodeApprox);}
#endif
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var coords: vec2i= vec2i(fragmentInputs.position.xy);var cdfy: f32=0.0;for (var y: i32=1; y<=coords.y; y++) {
#ifdef IBL_USE_CUBE_MAP
var uv: vec2f= vec2f(input.vUV.x,( f32(y-1)+0.5)/ f32(uniforms.iblHeight));cdfy+=fetchCube(uv);
#else
cdfy+=fetchPanoramic( vec2i(coords.x,y-1), f32(uniforms.iblHeight));
#endif
}
fragmentOutputs.color= vec4f(cdfy,0.0,0.0,1.0);}`;S.ShadersStoreWGSL[am]||(S.ShadersStoreWGSL[am]=UO);const Cj={name:am,shader:UO},yj=Object.freeze(Object.defineProperty({__proto__:null,iblCdfyPixelShaderWGSL:Cj},Symbol.toStringTag,{value:"Module"})),om="iblCdfyPixelShader",kO=`precision highp sampler2D;precision highp samplerCube;
#include<helperFunctions>
#define PI 3.1415927
varying vec2 vUV;
#ifdef IBL_USE_CUBE_MAP
uniform samplerCube iblSource;
#else
uniform sampler2D iblSource;
#endif
uniform int iblHeight;
#ifdef IBL_USE_CUBE_MAP
float fetchCube(vec2 uv) {vec3 direction=equirectangularToCubemapDirection(uv);return sin(PI*uv.y)*dot(textureCubeLodEXT(iblSource,direction,0.0).rgb,LuminanceEncodeApprox);}
#else
float fetchPanoramic(ivec2 Coords,float envmapHeight) {return sin(PI*(float(Coords.y)+0.5)/envmapHeight) *
dot(texelFetch(iblSource,Coords,0).rgb,LuminanceEncodeApprox);}
#endif
void main(void) {ivec2 coords=ivec2(gl_FragCoord.x,gl_FragCoord.y);float cdfy=0.0;for (int y=1; y<=coords.y; y++) {
#ifdef IBL_USE_CUBE_MAP
vec2 uv=vec2(vUV.x,(float(y-1)+0.5)/float(iblHeight));cdfy+=fetchCube(uv);
#else
cdfy+=fetchPanoramic(ivec2(coords.x,y-1),float(iblHeight));
#endif
}
gl_FragColor=vec4(cdfy,0.0,0.0,1.0);}`;S.ShadersStore[om]||(S.ShadersStore[om]=kO);const Ij={name:om,shader:kO},Rj=Object.freeze(Object.defineProperty({__proto__:null,iblCdfyPixelShader:Ij},Symbol.toStringTag,{value:"Module"})),lm="iblIcdfPixelShader",GO=`#include<helperFunctions>
varying vUV: vec2f;
#ifdef IBL_USE_CUBE_MAP
var iblSourceSampler: sampler;var iblSource: texture_cube<f32>;
#else
var iblSourceSampler: sampler;var iblSource: texture_2d<f32>;
#endif
var scaledLuminanceSamplerSampler : sampler;var scaledLuminanceSampler : texture_2d<f32>;var cdfx: texture_2d<f32>;var cdfy: texture_2d<f32>;fn fetchLuminance(coords: vec2f)->f32 {
#ifdef IBL_USE_CUBE_MAP
var direction: vec3f=equirectangularToCubemapDirection(coords);var color: vec3f=textureSampleLevel(iblSource,iblSourceSampler,direction,0.0).rgb;
#else
var color: vec3f=textureSampleLevel(iblSource,iblSourceSampler,coords,0.0).rgb;
#endif
return dot(color,LuminanceEncodeApprox);}
fn fetchCDFx(x: u32)->f32 {return textureLoad(cdfx, vec2u(x,0),0).x;}
fn bisectx(size: u32,targetValue: f32)->f32
{var a: u32=0;var b=size-1;while (b-a>1) {var c: u32=(a+b)>>1;if (fetchCDFx(c)<targetValue) {a=c;}
else {b=c;}}
return mix( f32(a), f32(b),(targetValue-fetchCDFx(a))/(fetchCDFx(b)-fetchCDFx(a)))/ f32(size-1);}
fn fetchCDFy(y: u32,invocationId: u32)->f32 {return textureLoad(cdfy, vec2u(invocationId,y),0).x;}
fn bisecty(size: u32,targetValue: f32,invocationId: u32)->f32
{var a: u32=0;var b=size-1;while (b-a>1) {var c=(a+b)>>1;if (fetchCDFy(c,invocationId)<targetValue) {a=c;}
else {b=c;}}
return mix( f32(a), f32(b),(targetValue-fetchCDFy(a,invocationId))/(fetchCDFy(b,invocationId)-fetchCDFy(a,invocationId)))/ f32(size-1);}
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var cdfxSize: vec2u=textureDimensions(cdfx,0);var cdfWidth: u32=cdfxSize.x;var icdfWidth: u32=cdfWidth-1;var currentPixel: vec2u= vec2u(fragmentInputs.position.xy);var outputColor: vec3f=vec3f(1.0);if (currentPixel.x==0)
{outputColor.x= 0.0;}
else if (currentPixel.x==icdfWidth-1) {outputColor.x= 1.0;} else {var targetValue: f32=fetchCDFx(cdfWidth-1)*input.vUV.x;outputColor.x= bisectx(cdfWidth,targetValue);}
var cdfySize: vec2u=textureDimensions(cdfy,0);var cdfHeight: u32=cdfySize.y;if (currentPixel.y==0) {outputColor.y= 0.0;}
else if (currentPixel.y==cdfHeight-2) {outputColor.y= 1.0;} else {var targetValue: f32=fetchCDFy(cdfHeight-1,currentPixel.x)*input.vUV.y;outputColor.y= max(bisecty(cdfHeight,targetValue,currentPixel.x),0.0);}
var size : vec2f=vec2f(textureDimensions(scaledLuminanceSampler,0));var highestMip: f32=floor(log2(size.x));var normalization : f32=textureSampleLevel(scaledLuminanceSampler,
scaledLuminanceSamplerSampler,
input.vUV,highestMip)
.r;var pixelLuminance: f32=fetchLuminance(input.vUV);outputColor.z=pixelLuminance/(2.0*PI*normalization);fragmentOutputs.color=vec4( outputColor,1.0);}`;S.ShadersStoreWGSL[lm]||(S.ShadersStoreWGSL[lm]=GO);const Aj={name:lm,shader:GO},Pj=Object.freeze(Object.defineProperty({__proto__:null,iblIcdfPixelShaderWGSL:Aj},Symbol.toStringTag,{value:"Module"})),cm="iblIcdfPixelShader",zO=`precision highp sampler2D;
#include<helperFunctions>
varying vec2 vUV;
#ifdef IBL_USE_CUBE_MAP
uniform samplerCube iblSource;
#else
uniform sampler2D iblSource;
#endif
uniform sampler2D scaledLuminanceSampler;uniform int iblWidth;uniform int iblHeight;uniform sampler2D cdfx;uniform sampler2D cdfy;float fetchLuminance(vec2 coords) {
#ifdef IBL_USE_CUBE_MAP
vec3 direction=equirectangularToCubemapDirection(coords);vec3 color=textureCubeLodEXT(iblSource,direction,0.0).rgb;
#else
vec3 color=textureLod(iblSource,coords,0.0).rgb;
#endif
return dot(color,LuminanceEncodeApprox);}
float fetchCDFx(int x) { return texelFetch(cdfx,ivec2(x,0),0).x; }
float bisectx(int size,float targetValue) {int a=0,b=size-1;while (b-a>1) {int c=a+b>>1;if (fetchCDFx(c)<targetValue)
a=c;else
b=c;}
return mix(float(a),float(b),
(targetValue-fetchCDFx(a))/(fetchCDFx(b)-fetchCDFx(a))) /
float(size-1);}
float fetchCDFy(int y,int invocationId) {return texelFetch(cdfy,ivec2(invocationId,y),0).x;}
float bisecty(int size,float targetValue,int invocationId) {int a=0,b=size-1;while (b-a>1) {int c=a+b>>1;if (fetchCDFy(c,invocationId)<targetValue)
a=c;else
b=c;}
return mix(float(a),float(b),
(targetValue-fetchCDFy(a,invocationId)) /
(fetchCDFy(b,invocationId)-fetchCDFy(a,invocationId))) /
float(size-1);}
void main(void) {ivec2 cdfxSize=textureSize(cdfx,0);int cdfWidth=cdfxSize.x;int icdfWidth=cdfWidth-1;ivec2 currentPixel=ivec2(gl_FragCoord.xy);vec3 outputColor=vec3(1.0);if (currentPixel.x==0) {outputColor.x=0.0;} else if (currentPixel.x==icdfWidth-1) {outputColor.x=1.0;} else {float targetValue=fetchCDFx(cdfWidth-1)*vUV.x;outputColor.x=bisectx(cdfWidth,targetValue);}
ivec2 cdfySize=textureSize(cdfy,0);int cdfHeight=cdfySize.y;if (currentPixel.y==0) {outputColor.y=0.0;} else if (currentPixel.y==cdfHeight-2) {outputColor.y=1.0;} else {float targetValue=fetchCDFy(cdfHeight-1,currentPixel.x)*vUV.y;outputColor.y=max(bisecty(cdfHeight,targetValue,currentPixel.x),0.0);}
vec2 size=vec2(textureSize(scaledLuminanceSampler,0));float highestMip=floor(log2(size.x));float normalization=texture(scaledLuminanceSampler,vUV,highestMip).r;float pixelLuminance=fetchLuminance(vUV);outputColor.z=pixelLuminance/(2.0*PI*normalization);gl_FragColor=vec4(outputColor,1.0);}
`;S.ShadersStore[cm]||(S.ShadersStore[cm]=zO);const Oj={name:cm,shader:zO},Nj=Object.freeze(Object.defineProperty({__proto__:null,iblIcdfPixelShader:Oj},Symbol.toStringTag,{value:"Module"})),um="iblCdfDebugPixelShader",WO=`#define PI 3.1415927
varying vUV: vec2f;var cdfySampler: sampler;var cdfy: texture_2d<f32>;var cdfxSampler: sampler;var cdfx: texture_2d<f32>;var icdfSampler: sampler;var icdf: texture_2d<f32>;
#ifdef IBL_USE_CUBE_MAP
var iblSourceSampler: sampler;var iblSource: texture_cube<f32>;
#else
var iblSourceSampler: sampler;var iblSource: texture_2d<f32>;
#endif
var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;
#define cdfyVSize (0.8/3.0)
#define cdfxVSize 0.1
#define cdfyHSize 0.5
uniform sizeParams: vec4f;
#ifdef IBL_USE_CUBE_MAP
fn equirectangularToCubemapDirection(uv: vec2f)->vec3f {var longitude: f32=uv.x*2.0*PI-PI;var latitude: f32=PI*0.5-uv.y*PI;var direction: vec3f;direction.x=cos(latitude)*sin(longitude);direction.y=sin(latitude);direction.z=cos(latitude)*cos(longitude);return direction;}
#endif
@fragment
fn main(input: FragmentInputs)->FragmentOutputs { 
var colour: vec3f= vec3f(0.0);var uv: vec2f =
vec2f((uniforms.sizeParams.x+input.vUV.x)*uniforms.sizeParams.z,(uniforms.sizeParams.y+input.vUV.y)*uniforms.sizeParams.w);var backgroundColour: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;var cdfxWidth: u32=textureDimensions(cdfx,0).x;var cdfyHeight: u32=textureDimensions(cdfy,0).y;const iblStart: f32=1.0-cdfyVSize;const pdfStart: f32=1.0-2.0*cdfyVSize;const cdfyStart: f32=1.0-3.0*cdfyVSize;const cdfxStart: f32=1.0-3.0*cdfyVSize-cdfxVSize;const icdfxStart: f32=1.0-3.0*cdfyVSize-2.0*cdfxVSize;
#ifdef IBL_USE_CUBE_MAP
var direction: vec3f=equirectangularToCubemapDirection(
(uv- vec2f(0.0,iblStart))* vec2f(1.0,1.0/cdfyVSize));var iblColour: vec3f=textureSampleLevel(iblSource,iblSourceSampler,direction,0.0).rgb;
#else
var iblColour: vec3f=textureSample(iblSource,iblSourceSampler,(uv- vec2f(0.0,iblStart)) *
vec2f(1.0,1.0/cdfyVSize))
.rgb;
#endif
var pdfColour: vec3f =
textureSample(icdf,icdfSampler,(uv- vec2f(0.0,pdfStart))* vec2f(1.0,1.0/cdfyVSize)).zzz;var cdfyColour: f32 =
textureSample(cdfy,cdfySampler,(uv- vec2f(0.0,cdfyStart))* vec2f(2.0,1.0/cdfyVSize)).r;var icdfyColour: f32 =
textureSample(icdf,icdfSampler,(uv- vec2f(0.5,cdfyStart))* vec2f(2.0,1.0/cdfyVSize)).g;var cdfxColour: f32 =
textureSample(cdfx,cdfxSampler,(uv- vec2f(0.0,cdfxStart))* vec2f(1.0,1.0/cdfxVSize)).r;var icdfxColour: f32=textureSample(icdf,icdfSampler,(uv- vec2f(0.0,icdfxStart)) *
vec2f(1.0,1.0/cdfxVSize)).r;if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {colour=backgroundColour;} else if (uv.y>iblStart) {colour+=iblColour;} else if (uv.y>pdfStart) {colour+=pdfColour;} else if (uv.y>cdfyStart && uv.x<0.5) {colour.r+=cdfyColour/f32(cdfyHeight);} else if (uv.y>cdfyStart && uv.x>0.5) {colour.r+=icdfyColour;} else if (uv.y>cdfxStart) {colour.r+=cdfxColour/f32(cdfxWidth);} else if (uv.y>icdfxStart) {colour.r+=icdfxColour;}
fragmentOutputs.color =vec4(mix(colour,backgroundColour,0.5),1.0);}`;S.ShadersStoreWGSL[um]||(S.ShadersStoreWGSL[um]=WO);const Dj={name:um,shader:WO},Mj=Object.freeze(Object.defineProperty({__proto__:null,iblCdfDebugPixelShaderWGSL:Dj},Symbol.toStringTag,{value:"Module"})),hm="iblCdfDebugPixelShader",HO=`precision highp samplerCube;
#define PI 3.1415927
varying vec2 vUV;uniform sampler2D cdfy;uniform sampler2D cdfx;uniform sampler2D icdf;uniform sampler2D pdf;
#ifdef IBL_USE_CUBE_MAP
uniform samplerCube iblSource;
#else
uniform sampler2D iblSource;
#endif
uniform sampler2D textureSampler;
#define cdfyVSize (0.8/3.0)
#define cdfxVSize 0.1
#define cdfyHSize 0.5
uniform vec4 sizeParams;
#define offsetX sizeParams.x
#define offsetY sizeParams.y
#define widthScale sizeParams.z
#define heightScale sizeParams.w
#ifdef IBL_USE_CUBE_MAP
vec3 equirectangularToCubemapDirection(vec2 uv) {float longitude=uv.x*2.0*PI-PI;float latitude=PI*0.5-uv.y*PI;vec3 direction;direction.x=cos(latitude)*sin(longitude);direction.y=sin(latitude);direction.z=cos(latitude)*cos(longitude);return direction;}
#endif
void main(void) {vec3 colour=vec3(0.0);vec2 uv =
vec2((offsetX+vUV.x)*widthScale,(offsetY+vUV.y)*heightScale);vec3 backgroundColour=texture2D(textureSampler,vUV).rgb;int cdfxWidth=textureSize(cdfx,0).x;int cdfyHeight=textureSize(cdfy,0).y;const float iblStart=1.0-cdfyVSize;const float pdfStart=1.0-2.0*cdfyVSize;const float cdfyStart=1.0-3.0*cdfyVSize;const float cdfxStart=1.0-3.0*cdfyVSize-cdfxVSize;const float icdfxStart=1.0-3.0*cdfyVSize-2.0*cdfxVSize;
#ifdef IBL_USE_CUBE_MAP
vec3 direction=equirectangularToCubemapDirection(
(uv-vec2(0.0,iblStart))*vec2(1.0,1.0/cdfyVSize));vec3 iblColour=textureCubeLodEXT(iblSource,direction,0.0).rgb;
#else
vec3 iblColour=texture2D(iblSource,(uv-vec2(0.0,iblStart)) *
vec2(1.0,1.0/cdfyVSize))
.rgb;
#endif
vec3 pdfColour=texture(icdf,(uv-vec2(0.0,pdfStart)) *
vec2(1.0,1.0/cdfyVSize)).zzz;float cdfyColour =
texture2D(cdfy,(uv-vec2(0.0,cdfyStart))*vec2(2.0,1.0/cdfyVSize))
.r;float icdfyColour =
texture2D(icdf,(uv-vec2(0.5,cdfyStart))*vec2(2.0,1.0/cdfyVSize))
.g;float cdfxColour =
texture2D(cdfx,(uv-vec2(0.0,cdfxStart))*vec2(1.0,1.0/cdfxVSize))
.r;float icdfxColour=texture2D(icdf,(uv-vec2(0.0,icdfxStart)) *
vec2(1.0,1.0/cdfxVSize))
.r;if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {colour=backgroundColour;} else if (uv.y>iblStart) {colour+=iblColour;} else if (uv.y>pdfStart) {colour+=pdfColour;} else if (uv.y>cdfyStart && uv.x<0.5) {colour.r+=cdfyColour/float(cdfyHeight);} else if (uv.y>cdfyStart && uv.x>0.5) {colour.r+=icdfyColour;} else if (uv.y>cdfxStart) {colour.r+=cdfxColour/float(cdfxWidth);} else if (uv.y>icdfxStart) {colour.r+=icdfxColour;}
gl_FragColor=vec4(colour,1.0);glFragColor.rgb=mix(gl_FragColor.rgb,backgroundColour,0.5);}
`;S.ShadersStore[hm]||(S.ShadersStore[hm]=HO);const Fj={name:hm,shader:HO},Lj=Object.freeze(Object.defineProperty({__proto__:null,iblCdfDebugPixelShader:Fj},Symbol.toStringTag,{value:"Module"})),dm="iblScaledLuminancePixelShader",$O=`#include<helperFunctions>
#ifdef IBL_USE_CUBE_MAP
var iblSourceSampler: sampler;var iblSource: texture_cube<f32>;
#else
var iblSourceSampler: sampler;var iblSource: texture_2d<f32>;
#endif
uniform iblHeight: i32;uniform iblWidth: i32;fn fetchLuminance(coords: vec2f)->f32 {
#ifdef IBL_USE_CUBE_MAP
var direction: vec3f=equirectangularToCubemapDirection(coords);var color: vec3f=textureSampleLevel(iblSource,iblSourceSampler,direction,0.0).rgb;
#else
var color: vec3f=textureSampleLevel(iblSource,iblSourceSampler,coords,0.0).rgb;
#endif
return dot(color,LuminanceEncodeApprox);}
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var deform: f32=sin(input.vUV.y*PI);var luminance: f32=fetchLuminance(input.vUV);fragmentOutputs.color=vec4f(vec3f(deform*luminance),1.0);}`;S.ShadersStoreWGSL[dm]||(S.ShadersStoreWGSL[dm]=$O);const wj={name:dm,shader:$O},Bj=Object.freeze(Object.defineProperty({__proto__:null,iblScaledLuminancePixelShaderWGSL:wj},Symbol.toStringTag,{value:"Module"})),fm="iblScaledLuminancePixelShader",XO=`precision highp sampler2D;precision highp samplerCube;
#include<helperFunctions>
varying vec2 vUV;
#ifdef IBL_USE_CUBE_MAP
uniform samplerCube iblSource;
#else
uniform sampler2D iblSource;
#endif
uniform int iblWidth;uniform int iblHeight;float fetchLuminance(vec2 coords) {
#ifdef IBL_USE_CUBE_MAP
vec3 direction=equirectangularToCubemapDirection(coords);vec3 color=textureCubeLodEXT(iblSource,direction,0.0).rgb;
#else
vec3 color=textureLod(iblSource,coords,0.0).rgb;
#endif
return dot(color,LuminanceEncodeApprox);}
void main(void) {float deform=sin(vUV.y*PI);float luminance=fetchLuminance(vUV);gl_FragColor=vec4(vec3(deform*luminance),1.0);}`;S.ShadersStore[fm]||(S.ShadersStore[fm]=XO);const Vj={name:fm,shader:XO},Uj=Object.freeze(Object.defineProperty({__proto__:null,iblScaledLuminancePixelShader:Vj},Symbol.toStringTag,{value:"Module"})),pm="iblDominantDirectionPixelShader",YO=`#include<helperFunctions>
#include<importanceSampling>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
var icdfSamplerSampler: sampler;var icdfSampler: texture_2d<f32>;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var lightDir: vec3f=vec3f(0.0,0.0,0.0);for(var i: u32=0u; i<NUM_SAMPLES; i++)
{var Xi: vec2f=hammersley(i,NUM_SAMPLES);var T: vec2f;T.x=textureSampleLevel(icdfSampler,icdfSamplerSampler,vec2(Xi.x,0.0),0.0).x;T.y=textureSampleLevel(icdfSampler,icdfSamplerSampler,vec2(T.x,Xi.y),0.0).y;var Ls: vec3f=uv_to_normal(vec2f(1.0-fract(T.x+0.25),T.y));lightDir+=Ls;}
lightDir/=vec3f(f32(NUM_SAMPLES));fragmentOutputs.color=vec4f(lightDir,1.0);}`;S.ShadersStoreWGSL[pm]||(S.ShadersStoreWGSL[pm]=YO);const kj={name:pm,shader:YO},Gj=Object.freeze(Object.defineProperty({__proto__:null,iblDominantDirectionPixelShaderWGSL:kj},Symbol.toStringTag,{value:"Module"})),mm="iblDominantDirectionPixelShader",jO=`precision highp sampler2D;precision highp samplerCube;
#include<helperFunctions>
#include<importanceSampling>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
varying vec2 vUV;uniform sampler2D icdfSampler;void main(void) {vec3 lightDir=vec3(0.0,0.0,0.0);for(uint i=0u; i<NUM_SAMPLES; ++i)
{vec2 Xi=hammersley(i,NUM_SAMPLES);vec2 T;T.x=texture2D(icdfSampler,vec2(Xi.x,0.0)).x;T.y=texture2D(icdfSampler,vec2(T.x,Xi.y)).y;vec3 Ls=uv_to_normal(vec2(1.0-fract(T.x+0.25),T.y));lightDir+=Ls;}
lightDir/=float(NUM_SAMPLES);gl_FragColor=vec4(lightDir,1.0);}`;S.ShadersStore[mm]||(S.ShadersStore[mm]=jO);const zj={name:mm,shader:jO},Wj=Object.freeze(Object.defineProperty({__proto__:null,iblDominantDirectionPixelShader:zj},Symbol.toStringTag,{value:"Module"})),sy="iblVoxelGrid2dArrayDebugPixelShader",Hj="precision highp sampler2DArray;varying vec2 vUV;uniform sampler2DArray voxelTexture;uniform sampler2D textureSampler;uniform int slice;void main(void) {ivec3 size=textureSize(voxelTexture,0);float dimension=sqrt(float(size.z));vec2 samplePos=fract(vUV.xy*vec2(dimension));int sampleIndex=int(floor(vUV.x*float(dimension))+floor(vUV.y*float(dimension))*dimension);glFragColor.rgb=texture(voxelTexture,vec3(samplePos.xy,sampleIndex)).rrr;glFragColor.a=1.0;glFragColor.rgb+=texture(textureSampler,vUV.xy).rgb;}";S.ShadersStore[sy]||(S.ShadersStore[sy]=Hj);const ny="iblVoxelGrid2dArrayDebugPixelShader",$j=`varying vUV: vec2f;var voxelTextureSampler: sampler;var voxelTexture: texture_3d<f32>;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform slice: i32;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var size: vec3u=textureDimensions(voxelTexture,0);var dimension: f32=sqrt( f32(size.z));var samplePos: vec2f=fract(input.vUV.xy* vec2f(dimension));var sampleIndex: u32= u32(floor(input.vUV.x* f32(dimension))+floor(input.vUV.y* f32(dimension))*dimension);var color=textureSample(voxelTexture,voxelTextureSampler, vec3f(samplePos.xy,sampleIndex)).rrr;color+=textureSample(textureSampler,textureSamplerSampler,input.vUV.xy).rgb;fragmentOutputs.color=vec4f(color,1.0);}`;S.ShadersStoreWGSL[ny]||(S.ShadersStoreWGSL[ny]=$j);const ay="iblVoxelGridPixelShader",Xj=`precision highp float;layout(location=0) out highp float glFragData[MAX_DRAW_BUFFERS];varying vec3 vNormalizedPosition;uniform float nearPlane;uniform float farPlane;uniform float stepSize;void main(void) {vec3 normPos=vNormalizedPosition.xyz;if (normPos.z<nearPlane || normPos.z>farPlane) {discard;}
glFragData[0]=normPos.z<nearPlane+stepSize ? 1.0 : 0.0;glFragData[1]=normPos.z>=nearPlane+stepSize && normPos.z<nearPlane+2.0*stepSize ? 1.0 : 0.0;glFragData[2]=normPos.z>=nearPlane+2.0*stepSize && normPos.z<nearPlane+3.0*stepSize ? 1.0 : 0.0;glFragData[3]=normPos.z>=nearPlane+3.0*stepSize && normPos.z<nearPlane+4.0*stepSize ? 1.0 : 0.0;
#if MAX_DRAW_BUFFERS>4
glFragData[4]=normPos.z>=nearPlane+4.0*stepSize && normPos.z<nearPlane+5.0*stepSize ? 1.0 : 0.0;glFragData[5]=normPos.z>=nearPlane+5.0*stepSize && normPos.z<nearPlane+6.0*stepSize ? 1.0 : 0.0;glFragData[6]=normPos.z>=nearPlane+6.0*stepSize && normPos.z<nearPlane+7.0*stepSize ? 1.0 : 0.0;glFragData[7]=normPos.z>=nearPlane+7.0*stepSize && normPos.z<nearPlane+8.0*stepSize ? 1.0 : 0.0;
#endif
}`;S.ShadersStore[ay]||(S.ShadersStore[ay]=Xj);const oy="iblVoxelGridVertexShader",Yj=`attribute vec3 position;varying vec3 vNormalizedPosition;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
uniform mat4 invWorldScale;uniform mat4 viewMatrix;void main(void) {vec3 positionUpdated=position;
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);gl_Position=viewMatrix*invWorldScale*worldPos;vNormalizedPosition.xyz=gl_Position.xyz*0.5+0.5;
#ifdef IS_NDC_HALF_ZRANGE
gl_Position.z=gl_Position.z*0.5+0.5;
#endif
}`;S.ShadersStore[oy]||(S.ShadersStore[oy]=Yj);const ly="iblVoxelGridPixelShader",jj=`varying vNormalizedPosition: vec3f;uniform nearPlane: f32;uniform farPlane: f32;uniform stepSize: f32;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var normPos: vec3f=input.vNormalizedPosition.xyz;if (normPos.z<uniforms.nearPlane || normPos.z>uniforms.farPlane) {discard;}
fragmentOutputs.fragData0=select(vec4f(0.0),vec4f(1.0),normPos.z<uniforms.nearPlane+uniforms.stepSize);fragmentOutputs.fragData1=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+uniforms.stepSize && normPos.z<uniforms.nearPlane+2.0*uniforms.stepSize);fragmentOutputs.fragData2=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+2.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+3.0*uniforms.stepSize);fragmentOutputs.fragData3=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+3.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+4.0*uniforms.stepSize);
#if MAX_DRAW_BUFFERS>4
fragmentOutputs.fragData4=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+4.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+5.0*uniforms.stepSize);fragmentOutputs.fragData5=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+5.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+6.0*uniforms.stepSize);fragmentOutputs.fragData6=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+6.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+7.0*uniforms.stepSize);fragmentOutputs.fragData7=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+7.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+8.0*uniforms.stepSize);
#endif
}`;S.ShadersStoreWGSL[ly]||(S.ShadersStoreWGSL[ly]=jj);const cy="iblVoxelGridVertexShader",qj=`attribute position: vec3f;varying vNormalizedPosition: vec3f;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
uniform invWorldScale: mat4x4f;uniform viewMatrix: mat4x4f;@vertex
fn main(input : VertexInputs)->FragmentInputs {var positionUpdated=vertexInputs.position;
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
let worldPos=finalWorld*vec4f(positionUpdated,1.0);vertexOutputs.position=uniforms.viewMatrix*uniforms.invWorldScale*worldPos;vertexOutputs.vNormalizedPosition=vertexOutputs.position.xyz*0.5+0.5;
#ifdef IS_NDC_HALF_ZRANGE
vertexOutputs.position=vec4f(vertexOutputs.position.x,vertexOutputs.position.y,vertexOutputs.position.z*0.5+0.5,vertexOutputs.position.w);
#endif
}
`;S.ShadersStoreWGSL[cy]||(S.ShadersStoreWGSL[cy]=qj);const uy="iblVoxelGrid3dDebugPixelShader",Zj=`precision highp sampler3D;varying vec2 vUV;uniform sampler3D voxelTexture;uniform sampler2D voxelSlabTexture;uniform sampler2D textureSampler;uniform vec4 sizeParams;
#define offsetX sizeParams.x
#define offsetY sizeParams.y
#define widthScale sizeParams.z
#define heightScale sizeParams.w
uniform float mipNumber;void main(void) {vec2 uv =
vec2((offsetX+vUV.x)*widthScale,(offsetY+vUV.y)*heightScale);vec4 background=texture2D(textureSampler,vUV);vec4 voxelSlab=texture2D(voxelSlabTexture,vUV);ivec3 size=textureSize(voxelTexture,int(mipNumber));float dimension=ceil(sqrt(float(size.z)));vec2 samplePos=fract(uv.xy*vec2(dimension));int sampleIndex=int(floor(uv.x*float(dimension)) +
floor(uv.y*float(dimension))*dimension);float mip_separator=0.0;if (samplePos.x<0.01 || samplePos.y<0.01) {mip_separator=1.0;}
bool outBounds=sampleIndex>size.z-1 ? true : false;sampleIndex=clamp(sampleIndex,0,size.z-1);ivec2 samplePosInt=ivec2(samplePos.xy*vec2(size.xy));vec3 voxel=texelFetch(voxelTexture,
ivec3(samplePosInt.x,samplePosInt.y,sampleIndex),
int(mipNumber))
.rgb;if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {gl_FragColor.rgba=background;} else {if (outBounds) {voxel=vec3(0.15,0.0,0.0);} else {if (voxel.r>0.001) {voxel.g=1.0;}
voxel.r+=mip_separator;}
glFragColor.rgb=mix(background.rgb,voxelSlab.rgb,voxelSlab.a)+voxel;glFragColor.a=1.0;}}`;S.ShadersStore[uy]||(S.ShadersStore[uy]=Zj);const hy="iblVoxelGrid3dDebugPixelShader",Qj=`varying vUV: vec2f;var voxelTextureSampler: sampler;var voxelTexture: texture_3d<f32>;var voxelSlabTextureSampler: sampler;var voxelSlabTexture: texture_2d<f32>;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform sizeParams: vec4f;
#define offsetX uniforms.sizeParams.x
#define offsetY uniforms.sizeParams.y
#define widthScale uniforms.sizeParams.z
#define heightScale uniforms.sizeParams.w
uniform mipNumber: f32;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var uv: vec2f =
vec2f((offsetX+input.vUV.x)*widthScale,(offsetY+input.vUV.y)*heightScale);var background: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);var voxelSlab: vec4f=textureSample(voxelSlabTexture,voxelSlabTextureSampler,input.vUV);var size: vec3u=textureDimensions(voxelTexture, i32(uniforms.mipNumber));var dimension: f32=ceil(sqrt( f32(size.z)));var samplePos: vec2f=fract(uv.xy* vec2f(dimension));var sampleIndex: u32= u32(floor(uv.x* f32(dimension)) +
floor(uv.y* f32(dimension))*dimension);var mip_separator: f32=0.0;if (samplePos.x<0.01 || samplePos.y<0.01) {mip_separator=1.0;}
var outBounds: bool=select(false,true,sampleIndex>size.z-1);sampleIndex=clamp(sampleIndex,0,size.z-1);var samplePosInt: vec2i= vec2i(samplePos.xy* vec2f(size.xy));var voxel: vec3f=textureLoad(voxelTexture,
vec3i(i32(samplePosInt.x),i32(samplePosInt.y),i32(sampleIndex)),
i32(uniforms.mipNumber)).rgb;if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {fragmentOutputs.color=background;} else {if (outBounds) {voxel= vec3f(0.15,0.0,0.0);} else {if (voxel.r>0.001) {voxel.g=1.0;}
voxel.r+=mip_separator;}
fragmentOutputs.color=vec4f(mix(background.rgb,voxelSlab.rgb,voxelSlab.a)+voxel,1.0);}}`;S.ShadersStoreWGSL[hy]||(S.ShadersStoreWGSL[hy]=Qj);const dy="iblVoxelSlabDebugVertexShader",Kj="attribute vec3 position;varying vec3 vNormalizedPosition;uniform mat4 world;uniform mat4 invWorldScale;uniform mat4 cameraViewMatrix;uniform mat4 projection;uniform mat4 viewMatrix;void main(void) {vec4 worldPosition=(world*vec4(position,1.));gl_Position=projection*cameraViewMatrix*worldPosition;vNormalizedPosition=(viewMatrix*invWorldScale*worldPosition).rgb;vNormalizedPosition.xyz=vNormalizedPosition.xyz*vec3(0.5)+vec3(0.5);}";S.ShadersStore[dy]||(S.ShadersStore[dy]=Kj);const fy="iblVoxelSlabDebugPixelShader",Jj=`precision highp float;varying vec3 vNormalizedPosition;uniform float nearPlane;uniform float farPlane;uniform float stepSize;void main(void) {vec3 normPos=vNormalizedPosition.xyz;float chunkSize=stepSize*float(MAX_DRAW_BUFFERS);float numChunks=1.0/chunkSize;float positionInChunk=fract(normPos.z/chunkSize);float slab=floor(positionInChunk*float(MAX_DRAW_BUFFERS)) /
float(MAX_DRAW_BUFFERS);if (normPos.x<0.0 || normPos.y<0.0 || normPos.z<0.0 ||
normPos.x>1.0 || normPos.y>1.0 || normPos.z>1.0) {gl_FragColor=vec4(0.0,0.0,0.0,0.0);} else {gl_FragColor=vec4(slab,0.0,0.0,0.75);}}`;S.ShadersStore[fy]||(S.ShadersStore[fy]=Jj);const py="iblVoxelSlabDebugVertexShader",e6=`attribute position: vec3f;varying vNormalizedPosition: vec3f;uniform world: mat4x4f;uniform invWorldScale: mat4x4f;uniform cameraViewMatrix: mat4x4f;uniform projection: mat4x4f;uniform viewMatrix: mat4x4f;@vertex
fn main(input : VertexInputs)->FragmentInputs {var worldPosition: vec4f=(uniforms.world* vec4f(input.position,1.));vertexOutputs.position=uniforms.projection*uniforms.cameraViewMatrix*worldPosition;vertexOutputs.vNormalizedPosition=(uniforms.viewMatrix*uniforms.invWorldScale*worldPosition).rgb;vertexOutputs.vNormalizedPosition=vertexOutputs.vNormalizedPosition* vec3f(0.5)+ vec3f(0.5);}`;S.ShadersStoreWGSL[py]||(S.ShadersStoreWGSL[py]=e6);const my="iblVoxelSlabDebugPixelShader",t6=`varying vNormalizedPosition: vec3f;uniform nearPlane: f32;uniform farPlane: f32;uniform stepSize: f32;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var normPos: vec3f=input.vNormalizedPosition.xyz;var chunkSize: f32=uniforms.stepSize* f32(MAX_DRAW_BUFFERS);var numChunks: f32=1.0/chunkSize;var positionInChunk: f32=fract(normPos.z/chunkSize);var slab: f32=floor(positionInChunk* f32(MAX_DRAW_BUFFERS)) /
f32(MAX_DRAW_BUFFERS);if (normPos.x<0.0 || normPos.y<0.0 || normPos.z<0.0 ||
normPos.x>1.0 || normPos.y>1.0 || normPos.z>1.0) {fragmentOutputs.color= vec4f(0.0,0.0,0.0,0.0);} else {fragmentOutputs.color= vec4f(slab,0.0,0.0,0.75);}}`;S.ShadersStoreWGSL[my]||(S.ShadersStoreWGSL[my]=t6);const _m="oitBackBlendPixelShader",qO=`precision highp float;uniform sampler2D uBackColor;void main() {glFragColor=texelFetch(uBackColor,ivec2(gl_FragCoord.xy),0);if (glFragColor.a==0.0) { 
discard;}}`;S.ShadersStore[_m]||(S.ShadersStore[_m]=qO);const i6={name:_m,shader:qO},_y=Object.freeze(Object.defineProperty({__proto__:null,oitBackBlendPixelShader:i6},Symbol.toStringTag,{value:"Module"})),gm="oitFinalPixelShader",ZO=`precision highp float;uniform sampler2D uFrontColor;uniform sampler2D uBackColor;void main() {ivec2 fragCoord=ivec2(gl_FragCoord.xy);vec4 frontColor=texelFetch(uFrontColor,fragCoord,0);vec4 backColor=texelFetch(uBackColor,fragCoord,0);float alphaMultiplier=1.0-frontColor.a;glFragColor=vec4(
frontColor.rgb+alphaMultiplier*backColor.rgb,
frontColor.a+backColor.a
);}`;S.ShadersStore[gm]||(S.ShadersStore[gm]=ZO);const r6={name:gm,shader:ZO},s6=Object.freeze(Object.defineProperty({__proto__:null,oitFinalPixelShader:r6},Symbol.toStringTag,{value:"Module"})),Sm="oitBackBlendPixelShader",QO=`var uBackColor: texture_2d<f32>;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureLoad(uBackColor,vec2i(fragmentInputs.position.xy),0);if (fragmentOutputs.color.a==0.0) {discard;}}
`;S.ShadersStoreWGSL[Sm]||(S.ShadersStoreWGSL[Sm]=QO);const n6={name:Sm,shader:QO},gy=Object.freeze(Object.defineProperty({__proto__:null,oitBackBlendPixelShaderWGSL:n6},Symbol.toStringTag,{value:"Module"})),vm="oitFinalPixelShader",KO=`var uFrontColor: texture_2d<f32>;var uBackColor: texture_2d<f32>;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var fragCoord: vec2i=vec2i(fragmentInputs.position.xy);var frontColor: vec4f=textureLoad(uFrontColor,fragCoord,0);var backColor: vec4f=textureLoad(uBackColor,fragCoord,0);var alphaMultiplier: f32=1.0-frontColor.a;fragmentOutputs.color=vec4f(
frontColor.rgb+alphaMultiplier*backColor.rgb,
frontColor.a+backColor.a
);}
`;S.ShadersStoreWGSL[vm]||(S.ShadersStoreWGSL[vm]=KO);const a6={name:vm,shader:KO},o6=Object.freeze(Object.defineProperty({__proto__:null,oitFinalPixelShaderWGSL:a6},Symbol.toStringTag,{value:"Module"})),Sy="spriteMapPixelShader",l6=`#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)
#else
#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)
#endif
precision highp float;varying vec3 vPosition;varying vec2 vUV;varying vec2 tUV;uniform float time;uniform float spriteCount;uniform sampler2D spriteSheet;uniform vec2 spriteMapSize;uniform vec2 outputSize;uniform vec2 stageSize;uniform sampler2D frameMap;uniform sampler2D tileMaps[LAYERS];uniform sampler2D animationMap;uniform vec3 colorMul;
#include<fogFragmentDeclaration>
#include<logDepthDeclaration>
float mt;const float fdStep=1.0*0.25;const float aFrameSteps=MAX_ANIMATION_FRAMES==0.0 ? 0.0 : 1.0/MAX_ANIMATION_FRAMES;mat4 getFrameData(float frameID) {float fX=frameID/spriteCount;return mat4(
TEXTUREFUNC(frameMap,vec2(fX,0.0),0.0),
TEXTUREFUNC(frameMap,vec2(fX,fdStep*1.0),0.0),
TEXTUREFUNC(frameMap,vec2(fX,fdStep*2.0),0.0),
vec4(0.0)
);}
void main() {vec4 color=vec4(0.0);vec2 tileUV=fract(tUV);vec2 tileID=floor(tUV);vec2 sheetUnits=1.0/spriteMapSize;float spriteUnits=1.0/spriteCount;vec2 stageUnits=1.0/stageSize;for(int i=0; i<LAYERS; i++) {float frameID;
#define LAYER_ID_SWITCH
vec4 animationData=TEXTUREFUNC(animationMap,vec2((frameID+0.5)/spriteCount,0.0),0.0);if(animationData.y>0.0) {mt=mod(time*animationData.z,1.0);for(float f=0.0; f<MAX_ANIMATION_FRAMES; f++) {if(animationData.y>mt) {frameID=animationData.x;break;}
animationData=TEXTUREFUNC(animationMap,vec2((frameID+0.5)/spriteCount,aFrameSteps*f),0.0);}}
mat4 frameData=getFrameData(frameID+0.5);vec2 frameSize=(frameData[0].zw)/spriteMapSize;vec2 offset=frameData[0].xy*sheetUnits;vec2 ratio=frameData[2].xy/frameData[0].zw;
#ifdef FR_CW
if (frameData[2].z==1.0) {tileUV.xy=tileUV.yx;} else {tileUV.xy=fract(tUV).xy;}
#ifdef FLIPU
tileUV.y=1.0-tileUV.y;
#endif
#else
if (frameData[2].z==1.0) {
#ifdef FLIPU
tileUV.y=1.0-tileUV.y;
#endif
tileUV.xy=tileUV.yx;} else {tileUV.xy=fract(tUV).xy;
#ifdef FLIPU
tileUV.y=1.0-tileUV.y;
#endif
}
#endif
vec4 nc=TEXTUREFUNC(spriteSheet,tileUV*frameSize+offset,0.0);if (i==0) {color=nc;} else {float alpha=min(color.a+nc.a,1.0);vec3 mixed=mix(color.xyz,nc.xyz,nc.a);color=vec4(mixed,alpha);}}
color.xyz*=colorMul;
#include<logDepthFragment>
#include<fogFragment>
gl_FragColor=color;}`;S.ShadersStore[Sy]||(S.ShadersStore[Sy]=l6);const vy="spriteMapVertexShader",c6=`precision highp float;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;varying vec3 vPosition;varying vec2 vUV;varying vec2 tUV;uniform float time;uniform mat4 world;uniform mat4 view;uniform mat4 projection;uniform vec2 stageSize;uniform float stageScale;
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
void main() {vec4 p=vec4( position,1. );vPosition=p.xyz;vUV=uv;tUV=uv*stageSize; 
vec3 viewPos=(view*world*p).xyz; 
gl_Position=projection*vec4(viewPos,1.0); 
#ifdef FOG
vFogDistance=viewPos;
#endif
#include<logDepthVertex>
}`;S.ShadersStore[vy]||(S.ShadersStore[vy]=c6);var xy;(function(s){s[s.CCW=0]="CCW",s[s.CW=1]="CW"})(xy||(xy={}));const Ey="imageProcessingCompatibility",u6=`#ifdef IMAGEPROCESSINGPOSTPROCESS
gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(2.2));
#endif
`;S.IncludesShadersStore[Ey]||(S.IncludesShadersStore[Ey]=u6);const xm="spritesPixelShader",JO=`#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
uniform bool alphaTest;varying vec4 vColor;varying vec2 vUV;uniform sampler2D diffuseSampler;
#include<fogFragmentDeclaration>
#include<logDepthDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
#ifdef PIXEL_PERFECT
vec2 uvPixelPerfect(vec2 uv) {vec2 res=vec2(textureSize(diffuseSampler,0));uv=uv*res;vec2 seam=floor(uv+0.5);uv=seam+clamp((uv-seam)/fwidth(uv),-0.5,0.5);return uv/res;}
#endif
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#ifdef PIXEL_PERFECT
vec2 uv=uvPixelPerfect(vUV);
#else
vec2 uv=vUV;
#endif
vec4 color=texture2D(diffuseSampler,uv);float fAlphaTest=float(alphaTest);if (fAlphaTest != 0.)
{if (color.a<0.95)
discard;}
color*=vColor;
#include<logDepthFragment>
#include<fogFragment>
gl_FragColor=color;
#include<imageProcessingCompatibility>
#define CUSTOM_FRAGMENT_MAIN_END
}`;S.ShadersStore[xm]||(S.ShadersStore[xm]=JO);const h6={name:xm,shader:JO},d6=Object.freeze(Object.defineProperty({__proto__:null,spritesPixelShader:h6},Symbol.toStringTag,{value:"Module"})),Em="spritesVertexShader",eN=`attribute vec4 position;attribute vec2 options;attribute vec2 offsets;attribute vec2 inverts;attribute vec4 cellInfo;attribute vec4 color;uniform mat4 view;uniform mat4 projection;varying vec2 vUV;varying vec4 vColor;
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 viewPos=(view*vec4(position.xyz,1.0)).xyz; 
vec2 cornerPos;float angle=position.w;vec2 size=vec2(options.x,options.y);vec2 offset=offsets.xy;cornerPos=vec2(offset.x-0.5,offset.y -0.5)*size;vec3 rotatedCorner;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;viewPos+=rotatedCorner;gl_Position=projection*vec4(viewPos,1.0); 
vColor=color;vec2 uvOffset=vec2(abs(offset.x-inverts.x),abs(1.0-offset.y-inverts.y));vec2 uvPlace=cellInfo.xy;vec2 uvSize=cellInfo.zw;vUV.x=uvPlace.x+uvSize.x*uvOffset.x;vUV.y=uvPlace.y+uvSize.y*uvOffset.y;
#ifdef FOG
vFogDistance=viewPos;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;S.ShadersStore[Em]||(S.ShadersStore[Em]=eN);const f6={name:Em,shader:eN},p6=Object.freeze(Object.defineProperty({__proto__:null,spritesVertexShader:f6},Symbol.toStringTag,{value:"Module"})),Ty="imageProcessingCompatibility",m6=`#ifdef IMAGEPROCESSINGPOSTPROCESS
fragmentOutputs.color=vec4f(pow(fragmentOutputs.color.rgb, vec3f(2.2)),fragmentOutputs.color.a);
#endif
`;S.IncludesShadersStoreWGSL[Ty]||(S.IncludesShadersStoreWGSL[Ty]=m6);const Tm="spritesPixelShader",tN=`uniform alphaTest: i32;varying vColor: vec4f;varying vUV: vec2f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;
#include<fogFragmentDeclaration>
#include<logDepthDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
#ifdef PIXEL_PERFECT
fn uvPixelPerfect(uv: vec2f)->vec2f {var res: vec2f= vec2f(textureDimensions(diffuseSampler,0));var uvTemp=uv*res;var seam: vec2f=floor(uvTemp+0.5);uvTemp=seam+clamp((uvTemp-seam)/fwidth(uvTemp),vec2f(-0.5),vec2f(0.5));return uvTemp/res;}
#endif
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#ifdef PIXEL_PERFECT
var uv: vec2f=uvPixelPerfect(input.vUV);
#else
var uv: vec2f=input.vUV;
#endif
var color: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,uv);var fAlphaTest: f32= f32(uniforms.alphaTest);if (fAlphaTest != 0.)
{if (color.a<0.95) {discard;}}
color*=input.vColor;
#include<logDepthFragment>
#include<fogFragment>
fragmentOutputs.color=color;
#include<imageProcessingCompatibility>
#define CUSTOM_FRAGMENT_MAIN_END
}`;S.ShadersStoreWGSL[Tm]||(S.ShadersStoreWGSL[Tm]=tN);const _6={name:Tm,shader:tN},g6=Object.freeze(Object.defineProperty({__proto__:null,spritesPixelShaderWGSL:_6},Symbol.toStringTag,{value:"Module"})),bm="spritesVertexShader",iN=`attribute position: vec4f;attribute options: vec2f;attribute offsets: vec2f;attribute inverts: vec2f;attribute cellInfo: vec4f;attribute color: vec4f;uniform view: mat4x4f;uniform projection: mat4x4f;varying vUV: vec2f;varying vColor: vec4f;
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
var viewPos: vec3f=(uniforms.view* vec4f(input.position.xyz,1.0)).xyz; 
var cornerPos: vec2f;var angle: f32=input.position.w;var size: vec2f= vec2f(input.options.x,input.options.y);var offset: vec2f=input.offsets.xy;cornerPos= vec2f(offset.x-0.5,offset.y -0.5)*size;var rotatedCorner: vec3f;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;viewPos+=rotatedCorner;vertexOutputs.position=uniforms.projection*vec4f(viewPos,1.0); 
vertexOutputs.vColor=input.color;var uvOffset: vec2f= vec2f(abs(offset.x-input.inverts.x),abs(1.0-offset.y-input.inverts.y));var uvPlace: vec2f=input.cellInfo.xy;var uvSize: vec2f=input.cellInfo.zw;vertexOutputs.vUV.x=uvPlace.x+uvSize.x*uvOffset.x;vertexOutputs.vUV.y=uvPlace.y+uvSize.y*uvOffset.y;
#ifdef FOG
vertexOutputs.vFogDistance=viewPos;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;S.ShadersStoreWGSL[bm]||(S.ShadersStoreWGSL[bm]=iN);const S6={name:bm,shader:iN},v6=Object.freeze(Object.defineProperty({__proto__:null,spritesVertexShaderWGSL:S6},Symbol.toStringTag,{value:"Module"}));var by;(function(s){s[s.ENTERING_XR=0]="ENTERING_XR",s[s.EXITING_XR=1]="EXITING_XR",s[s.IN_XR=2]="IN_XR",s[s.NOT_IN_XR=3]="NOT_IN_XR"})(by||(by={}));var Cy;(function(s){s[s.NOT_TRACKING=0]="NOT_TRACKING",s[s.TRACKING_LOST=1]="TRACKING_LOST",s[s.TRACKING=2]="TRACKING"})(Cy||(Cy={}));class kn extends pi{constructor(e,t={}){super(e),this.options=t,this._direction=new x(0,0,-1),this._mat=new z,this._onSelectEnabled=!1,this._origin=new x(0,0,0),this.lastNativeXRHitResults=[],this.onHitTestResultObservable=new k,this._onHitTestResults=i=>{const r=i.map(n=>{const a=z.FromArray(n.hitMatrix);return this._xrSessionManager.scene.useRightHandedSystem||a.toggleModelMatrixHandInPlace(),this.options.worldParentNode&&a.multiplyToRef(this.options.worldParentNode.getWorldMatrix(),a),{xrHitResult:n,transformationMatrix:a}});this.lastNativeXRHitResults=i,this.onHitTestResultObservable.notifyObservers(r)},this._onSelect=i=>{this._onSelectEnabled&&kn.XRHitTestWithSelectEvent(i,this._xrSessionManager.referenceSpace)},this.xrNativeFeatureName="hit-test",j.Warn("A newer version of this plugin is available")}static async XRHitTestWithRay(e,t,i,r){const n=await e.requestHitTest(t,i),a=r||(o=>!!o.hitMatrix);return n.filter(a)}static async XRHitTestWithSelectEvent(e,t){const i=e.frame.getPose(e.inputSource.targetRaySpace,t);if(!i)return[];const r=new XRRay(i.transform);return await this.XRHitTestWithRay(e.frame.session,r,t)}attach(){return super.attach()?(this.options.testOnPointerDownOnly&&this._xrSessionManager.session.addEventListener("select",this._onSelect,!1),!0):!1}detach(){return super.detach()?(this._onSelectEnabled=!1,this._xrSessionManager.session.removeEventListener("select",this._onSelect),!0):!1}dispose(){super.dispose(),this.onHitTestResultObservable.clear()}_onXRFrame(e){if(!this.attached||this.options.testOnPointerDownOnly)return;const t=e.getViewerPose(this._xrSessionManager.referenceSpace);if(!t)return;z.FromArrayToRef(t.transform.matrix,0,this._mat),x.TransformCoordinatesFromFloatsToRef(0,0,0,this._mat,this._origin),x.TransformCoordinatesFromFloatsToRef(0,0,-1,this._mat,this._direction),this._direction.subtractInPlace(this._origin),this._direction.normalize();const i=new XRRay({x:this._origin.x,y:this._origin.y,z:this._origin.z,w:0},{x:this._direction.x,y:this._direction.y,z:this._direction.z,w:0});kn.XRHitTestWithRay(this._xrSessionManager.session,i,this._xrSessionManager.referenceSpace).then(this._onHitTestResults)}}kn.Name=Ne.HIT_TEST;kn.Version=1;At.AddWebXRFeature(kn.Name,(s,e)=>()=>new kn(s,e),kn.Version,!1);let x6=0;class fl extends pi{set referenceSpaceForFrameAnchors(e){this._referenceSpaceForFrameAnchors=e}constructor(e,t={}){super(e),this._options=t,this._lastFrameDetected=new Set,this._trackedAnchors=[],this._futureAnchors=[],this.onAnchorAddedObservable=new k,this.onAnchorRemovedObservable=new k,this.onAnchorUpdatedObservable=new k,this._tmpVector=new x,this._tmpQuaternion=new Z,this.xrNativeFeatureName="anchors",this._options.clearAnchorsOnSessionInit&&this._xrSessionManager.onXRSessionInit.add(()=>{this._trackedAnchors.length=0,this._futureAnchors.length=0,this._lastFrameDetected.clear()})}_populateTmpTransformation(e,t){return this._tmpVector.copyFrom(e),this._tmpQuaternion.copyFrom(t),this._xrSessionManager.scene.useRightHandedSystem||(this._tmpVector.z*=-1,this._tmpQuaternion.z*=-1,this._tmpQuaternion.w*=-1),{position:this._tmpVector,rotationQuaternion:this._tmpQuaternion}}async addAnchorPointUsingHitTestResultAsync(e,t=new x,i=new Z){this._populateTmpTransformation(t,i);const r=new XRRigidTransform({x:this._tmpVector.x,y:this._tmpVector.y,z:this._tmpVector.z},{x:this._tmpQuaternion.x,y:this._tmpQuaternion.y,z:this._tmpQuaternion.z,w:this._tmpQuaternion.w});if(e.xrHitResult.createAnchor)try{const n=await e.xrHitResult.createAnchor(r);return await new Promise((a,o)=>{this._futureAnchors.push({nativeAnchor:n,resolved:!1,submitted:!0,xrTransformation:r,resolve:a,reject:o})})}catch(n){throw new Error(n)}else throw this.detach(),new Error("Anchors not enabled in this environment/browser")}async addAnchorAtPositionAndRotationAsync(e,t=new Z,i=!1){this._populateTmpTransformation(e,t);const r=new XRRigidTransform({x:this._tmpVector.x,y:this._tmpVector.y,z:this._tmpVector.z},{x:this._tmpQuaternion.x,y:this._tmpQuaternion.y,z:this._tmpQuaternion.z,w:this._tmpQuaternion.w}),n=i&&this.attached&&this._xrSessionManager.currentFrame?await this._createAnchorAtTransformationAsync(r,this._xrSessionManager.currentFrame):void 0;return await new Promise((a,o)=>{this._futureAnchors.push({nativeAnchor:n,resolved:!1,submitted:!1,xrTransformation:r,resolve:a,reject:o})})}get anchors(){return this._trackedAnchors}detach(){if(!super.detach())return!1;if(!this._options.doNotRemoveAnchorsOnSessionEnded)for(;this._trackedAnchors.length;){const e=this._trackedAnchors.pop();e&&!e._removed&&(this.onAnchorRemovedObservable.notifyObservers(e),e._removed=!0)}return!0}dispose(){this._futureAnchors.length=0,super.dispose(),this.onAnchorAddedObservable.clear(),this.onAnchorRemovedObservable.clear(),this.onAnchorUpdatedObservable.clear()}_onXRFrame(e){if(!this.attached||!e)return;const t=e.trackedAnchors;if(t){const i=this._trackedAnchors.filter(n=>n._removed).map(n=>this._trackedAnchors.indexOf(n));let r=0;for(const n of i){const a=this._trackedAnchors.splice(n-r,1)[0];a.xrAnchor.delete(),this.onAnchorRemovedObservable.notifyObservers(a),r++}t.forEach(n=>{if(this._lastFrameDetected.has(n)){const a=this._findIndexInAnchorArray(n),o=this._trackedAnchors[a];try{this._updateAnchorWithXRFrame(n,o,e),o.attachedNode&&(o.attachedNode.rotationQuaternion=o.attachedNode.rotationQuaternion||new Z,o.transformationMatrix.decompose(o.attachedNode.scaling,o.attachedNode.rotationQuaternion,o.attachedNode.position)),this.onAnchorUpdatedObservable.notifyObservers(o)}catch{j.Warn("Anchor could not be updated")}}else{const a={id:x6++,xrAnchor:n,remove:()=>{a._removed=!0}},o=this._updateAnchorWithXRFrame(n,a,e);this._trackedAnchors.push(o),this.onAnchorAddedObservable.notifyObservers(o);const c=this._futureAnchors.filter(u=>u.nativeAnchor===n)[0];c&&(c.resolve(o),c.resolved=!0)}}),this._lastFrameDetected=t}for(const i of this._futureAnchors)!i.resolved&&!i.submitted&&(this._createAnchorAtTransformationAsync(i.xrTransformation,e).then(r=>{i.nativeAnchor=r},r=>{i.resolved=!0,i.reject(r)}),i.submitted=!0)}_findIndexInAnchorArray(e){for(let t=0;t<this._trackedAnchors.length;++t)if(this._trackedAnchors[t].xrAnchor===e)return t;return-1}_updateAnchorWithXRFrame(e,t,i){const r=i.getPose(e.anchorSpace,this._xrSessionManager.referenceSpace);if(r){const n=t.transformationMatrix||new z;z.FromArrayToRef(r.transform.matrix,0,n),this._xrSessionManager.scene.useRightHandedSystem||n.toggleModelMatrixHandInPlace(),t.transformationMatrix=n,this._options.worldParentNode&&n.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),n)}return t}async _createAnchorAtTransformationAsync(e,t){if(t.createAnchor)try{return await t.createAnchor(e,this._referenceSpaceForFrameAnchors??this._xrSessionManager.referenceSpace)}catch(i){throw new Error(i)}else throw this.detach(),new Error("Anchors are not enabled in your browser")}}fl.Name=Ne.ANCHOR_SYSTEM;fl.Version=1;At.AddWebXRFeature(fl.Name,(s,e)=>()=>new fl(s,e),fl.Version);let E6=0;class pl extends pi{constructor(e,t={}){super(e),this._options=t,this._detectedPlanes=[],this._enabled=!1,this._lastFrameDetected=new Set,this.onPlaneAddedObservable=new k,this.onPlaneRemovedObservable=new k,this.onPlaneUpdatedObservable=new k,this.xrNativeFeatureName="plane-detection",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce(()=>{this._init()})}detach(){if(!super.detach())return!1;if(!this._options.doNotRemovePlanesOnSessionEnded)for(;this._detectedPlanes.length;){const e=this._detectedPlanes.pop();e&&this.onPlaneRemovedObservable.notifyObservers(e)}return!0}dispose(){super.dispose(),this.onPlaneAddedObservable.clear(),this.onPlaneRemovedObservable.clear(),this.onPlaneUpdatedObservable.clear()}isCompatible(){return typeof XRPlane<"u"}async initiateRoomCapture(){if(this._xrSessionManager.session.initiateRoomCapture)return await this._xrSessionManager.session.initiateRoomCapture();throw"initiateRoomCapture is not supported on this session"}_onXRFrame(e){var i;if(!this.attached||!this._enabled||!e)return;const t=e.detectedPlanes||((i=e.worldInformation)==null?void 0:i.detectedPlanes);if(t){for(let r=0;r<this._detectedPlanes.length;r++){const n=this._detectedPlanes[r];t.has(n.xrPlane)||(this._detectedPlanes.splice(r--,1),this.onPlaneRemovedObservable.notifyObservers(n))}t.forEach(r=>{if(this._lastFrameDetected.has(r)){if(r.lastChangedTime===this._xrSessionManager.currentTimestamp){const n=this._findIndexInPlaneArray(r),a=this._detectedPlanes[n];this._updatePlaneWithXRPlane(r,a,e),this.onPlaneUpdatedObservable.notifyObservers(a)}}else{const n={id:E6++,xrPlane:r,polygonDefinition:[]},a=this._updatePlaneWithXRPlane(r,n,e);this._detectedPlanes.push(a),this.onPlaneAddedObservable.notifyObservers(a)}}),this._lastFrameDetected=t}}_init(){const e=()=>{this._enabled=!0,this._detectedPlanes.length&&(this._detectedPlanes.length=0)};if(this._xrSessionManager.isNative&&this._options.preferredDetectorOptions&&this._xrSessionManager.session.trySetPreferredPlaneDetectorOptions&&this._xrSessionManager.session.trySetPreferredPlaneDetectorOptions(this._options.preferredDetectorOptions),!this._xrSessionManager.session.updateWorldTrackingState){e();return}this._xrSessionManager.session.updateWorldTrackingState({planeDetectionState:{enabled:!0}}),e()}_updatePlaneWithXRPlane(e,t,i){t.polygonDefinition=e.polygon.map(n=>{const a=this._xrSessionManager.scene.useRightHandedSystem?1:-1;return new x(n.x,n.y,n.z*a)});const r=i.getPose(e.planeSpace,this._xrSessionManager.referenceSpace);if(r){const n=t.transformationMatrix||new z;z.FromArrayToRef(r.transform.matrix,0,n),this._xrSessionManager.scene.useRightHandedSystem||n.toggleModelMatrixHandInPlace(),t.transformationMatrix=n,this._options.worldParentNode&&n.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),n)}return t}_findIndexInPlaneArray(e){for(let t=0;t<this._detectedPlanes.length;++t)if(this._detectedPlanes[t].xrPlane===e)return t;return-1}}pl.Name=Ne.PLANE_DETECTION;pl.Version=1;At.AddWebXRFeature(pl.Name,(s,e)=>()=>new pl(s,e),pl.Version);class ml extends pi{constructor(e,t={}){super(e),this.options=t,this.onBackgroundStateChangedObservable=new k}attach(){return this._setBackgroundState(!1),super.attach()}detach(){return this._setBackgroundState(!0),super.detach()}dispose(){super.dispose(),this.onBackgroundStateChangedObservable.clear()}_onXRFrame(e){}_setBackgroundState(e){const t=this._xrSessionManager.scene;if(!this.options.ignoreEnvironmentHelper)if(this.options.environmentHelperRemovalFlags){if(this.options.environmentHelperRemovalFlags.skyBox){const i=t.getMeshByName("BackgroundSkybox");i&&i.setEnabled(e)}if(this.options.environmentHelperRemovalFlags.ground){const i=t.getMeshByName("BackgroundPlane");i&&i.setEnabled(e)}}else{const i=t.getMeshByName("BackgroundHelper");i&&i.setEnabled(e)}if(this.options.backgroundMeshes)for(const i of this.options.backgroundMeshes)i.setEnabled(e);this.onBackgroundStateChangedObservable.notifyObservers(e)}}ml.Name=Ne.BACKGROUND_REMOVER;ml.Version=1;At.AddWebXRFeature(ml.Name,(s,e)=>()=>new ml(s,e),ml.Version,!0);class _l extends pi{_createPhysicsImpostor(e){const t=this._options.physicsProperties.impostorType||ue.SphereImpostor,i=this._options.physicsProperties.impostorSize||.1,r=Sn("impostor-mesh-"+e.uniqueId,{diameterX:typeof i=="number"?i:i.width,diameterY:typeof i=="number"?i:i.height,diameterZ:typeof i=="number"?i:i.depth});r.isVisible=this._debugMode,r.isPickable=!1,r.rotationQuaternion=new Z;const n=e.grip||e.pointer;r.position.copyFrom(n.position),r.rotationQuaternion.copyFrom(n.rotationQuaternion);const a=new ue(r,t,{mass:0,...this._options.physicsProperties});this._controllers[e.uniqueId]={xrController:e,impostor:a,impostorMesh:r}}constructor(e,t){super(e),this._options=t,this._attachController=i=>{this._controllers[i.uniqueId]||(this._xrSessionManager.scene.isPhysicsEnabled()||N.Warn("physics engine not enabled, skipped. Please add this controller manually."),this._options.physicsProperties.useControllerMesh&&i.inputSource.gamepad?i.onMotionControllerInitObservable.addOnce(r=>{r._doNotLoadControllerMesh?this._createPhysicsImpostor(i):r.onModelLoadedObservable.addOnce(()=>{const n=new ue(r.rootMesh,ue.MeshImpostor,{mass:0,...this._options.physicsProperties}),a=i.grip||i.pointer;this._controllers[i.uniqueId]={xrController:i,impostor:n,oldPos:a.position.clone(),oldRotation:a.rotationQuaternion.clone()}})}):this._createPhysicsImpostor(i))},this._controllers={},this._debugMode=!1,this._delta=0,this._lastTimestamp=0,this._tmpQuaternion=new Z,this._tmpVector=new x,this._options.physicsProperties||(this._options.physicsProperties={})}_enablePhysicsDebug(){this._debugMode=!0;const e=Object.keys(this._controllers);for(const t of e){const i=this._controllers[t];i.impostorMesh&&(i.impostorMesh.isVisible=!0)}}addController(e){this._attachController(e)}attach(){if(!super.attach())return!1;if(!this._options.xrInput)return!0;for(const e of this._options.xrInput.controllers)this._attachController(e);if(this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),this._options.enableHeadsetImpostor){const e=this._options.headsetImpostorParams||{impostorType:ue.SphereImpostor,restitution:.8,impostorSize:.3},t=e.impostorSize||.3;this._headsetMesh=Sn("headset-mesh",{diameterX:typeof t=="number"?t:t.width,diameterY:typeof t=="number"?t:t.height,diameterZ:typeof t=="number"?t:t.depth}),this._headsetMesh.rotationQuaternion=new Z,this._headsetMesh.isVisible=!1,this._headsetImpostor=new ue(this._headsetMesh,e.impostorType,{mass:0,...e})}return!0}detach(){if(!super.detach())return!1;const e=Object.keys(this._controllers);for(const t of e)this._detachController(t);return this._headsetMesh&&this._headsetMesh.dispose(),!0}getHeadsetImpostor(){return this._headsetImpostor}getImpostorForController(e){const t=typeof e=="string"?e:e.uniqueId;return this._controllers[t]?this._controllers[t].impostor:null}setPhysicsProperties(e){this._options.physicsProperties={...this._options.physicsProperties,...e}}_onXRFrame(e){var i,r,n,a;if(this._delta=this._xrSessionManager.currentTimestamp-this._lastTimestamp,this._lastTimestamp=this._xrSessionManager.currentTimestamp,this._headsetMesh&&this._headsetImpostor){if(this._headsetMesh.position.copyFrom(this._options.xrInput.xrCamera.globalPosition),this._headsetMesh.rotationQuaternion.copyFrom(this._options.xrInput.xrCamera.absoluteRotation),(i=this._options.xrInput.xrCamera._lastXRViewerPose)!=null&&i.linearVelocity){const o=this._options.xrInput.xrCamera._lastXRViewerPose.linearVelocity;this._tmpVector.set(o.x,o.y,o.z),this._headsetImpostor.setLinearVelocity(this._tmpVector)}if((r=this._options.xrInput.xrCamera._lastXRViewerPose)!=null&&r.angularVelocity){const o=this._options.xrInput.xrCamera._lastXRViewerPose.angularVelocity;this._tmpVector.set(o.x,o.y,o.z),this._headsetImpostor.setAngularVelocity(this._tmpVector)}}const t=Object.keys(this._controllers);for(const o of t){const l=this._controllers[o],c=l.xrController.grip||l.xrController.pointer,u=l.oldPos||l.impostorMesh.position;if((n=l.xrController._lastXRPose)!=null&&n.linearVelocity){const d=l.xrController._lastXRPose.linearVelocity;this._tmpVector.set(d.x,d.y,d.z),l.impostor.setLinearVelocity(this._tmpVector)}else c.position.subtractToRef(u,this._tmpVector),this._tmpVector.scaleInPlace(1e3/this._delta),l.impostor.setLinearVelocity(this._tmpVector);u.copyFrom(c.position),this._debugMode&&N.Log([this._tmpVector,"linear"]);const h=l.oldRotation||l.impostorMesh.rotationQuaternion;if((a=l.xrController._lastXRPose)!=null&&a.angularVelocity){const d=l.xrController._lastXRPose.angularVelocity;this._tmpVector.set(d.x,d.y,d.z),l.impostor.setAngularVelocity(this._tmpVector)}else if(!h.equalsWithEpsilon(c.rotationQuaternion)){h.conjugateInPlace().multiplyToRef(c.rotationQuaternion,this._tmpQuaternion);const d=Math.sqrt(this._tmpQuaternion.x*this._tmpQuaternion.x+this._tmpQuaternion.y*this._tmpQuaternion.y+this._tmpQuaternion.z*this._tmpQuaternion.z);if(this._tmpVector.set(this._tmpQuaternion.x,this._tmpQuaternion.y,this._tmpQuaternion.z),d<.001)this._tmpVector.scaleInPlace(2);else{const f=2*Math.atan2(d,this._tmpQuaternion.w);this._tmpVector.scaleInPlace(f/(d*(this._delta/1e3)))}l.impostor.setAngularVelocity(this._tmpVector)}h.copyFrom(c.rotationQuaternion),this._debugMode&&N.Log([this._tmpVector,this._tmpQuaternion,"angular"])}}_detachController(e){const t=this._controllers[e];t&&(t.impostorMesh&&t.impostorMesh.dispose(),delete this._controllers[e])}}_l.Name=Ne.PHYSICS_CONTROLLERS;_l.Version=1;At.AddWebXRFeature(_l.Name,(s,e)=>()=>new _l(s,e),_l.Version,!0);class gl extends pi{constructor(e,t={}){super(e),this.options=t,this._tmpMat=new z,this._tmpPos=new x,this._tmpQuat=new Z,this._initHitTestSource=i=>{if(!i)return;const r=new XRRay(this.options.offsetRay||{}),n={space:this.options.useReferenceSpace?i:this._xrSessionManager.viewerReferenceSpace,offsetRay:r};if(this.options.entityTypes&&(n.entityTypes=this.options.entityTypes),!n.space){j.Warn("waiting for viewer reference space to initialize");return}this._xrSessionManager.session.requestHitTestSource(n).then(a=>{this._xrHitTestSource&&this._xrHitTestSource.cancel(),this._xrHitTestSource=a})},this.autoCloneTransformation=!1,this.onHitTestResultObservable=new k,this.paused=!1,this.xrNativeFeatureName="hit-test",j.Warn("Hit test is an experimental and unstable feature.")}attach(){if(!super.attach()||!this._xrSessionManager.session.requestHitTestSource)return!1;if(this.options.disablePermanentHitTest||(this._xrSessionManager.referenceSpace&&this._initHitTestSource(this._xrSessionManager.referenceSpace),this._xrSessionManager.onXRReferenceSpaceChanged.add(this._initHitTestSource)),this.options.enableTransientHitTest){const e=new XRRay(this.options.transientOffsetRay||{});this._xrSessionManager.session.requestHitTestSourceForTransientInput({profile:this.options.transientHitTestProfile||"generic-touchscreen",offsetRay:e,entityTypes:this.options.entityTypes}).then(t=>{this._transientXrHitTestSource=t})}return!0}detach(){return super.detach()?(this._xrHitTestSource&&(this._xrHitTestSource.cancel(),this._xrHitTestSource=null),this._xrSessionManager.onXRReferenceSpaceChanged.removeCallback(this._initHitTestSource),this._transientXrHitTestSource&&(this._transientXrHitTestSource.cancel(),this._transientXrHitTestSource=null),!0):!1}dispose(){super.dispose(),this.onHitTestResultObservable.clear()}_onXRFrame(e){if(!(!this.attached||this.paused)){if(this._xrHitTestSource){const t=e.getHitTestResults(this._xrHitTestSource);this._processWebXRHitTestResult(t)}if(this._transientXrHitTestSource){const t=e.getHitTestResultsForTransientInput(this._transientXrHitTestSource);for(const i of t)this._processWebXRHitTestResult(i.results,i.inputSource)}}}_processWebXRHitTestResult(e,t){const i=[];for(const r of e){const n=r.getPose(this._xrSessionManager.referenceSpace);if(!n)continue;const a=n.transform.position,o=n.transform.orientation;this._tmpPos.set(a.x,a.y,a.z).scaleInPlace(this._xrSessionManager.worldScalingFactor),this._tmpQuat.set(o.x,o.y,o.z,o.w),z.FromFloat32ArrayToRefScaled(n.transform.matrix,0,1,this._tmpMat),this._xrSessionManager.scene.useRightHandedSystem||(this._tmpPos.z*=-1,this._tmpQuat.z*=-1,this._tmpQuat.w*=-1,this._tmpMat.toggleModelMatrixHandInPlace());const l={position:this.autoCloneTransformation?this._tmpPos.clone():this._tmpPos,rotationQuaternion:this.autoCloneTransformation?this._tmpQuat.clone():this._tmpQuat,transformationMatrix:this.autoCloneTransformation?this._tmpMat.clone():this._tmpMat,inputSource:t,isTransient:!!t,xrHitResult:r};i.push(l)}this.onHitTestResultObservable.notifyObservers(i)}}gl.Name=Ne.HIT_TEST;gl.Version=2;At.AddWebXRFeature(gl.Name,(s,e)=>()=>new gl(s,e),gl.Version,!1);class Sl extends pi{get featurePointCloud(){return this._featurePointCloud}constructor(e){super(e),this._enabled=!1,this._featurePointCloud=[],this.onFeaturePointsAddedObservable=new k,this.onFeaturePointsUpdatedObservable=new k,this.xrNativeFeatureName="bjsfeature-points",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce(()=>{this._init()})}detach(){return super.detach()?(this.featurePointCloud.length=0,!0):!1}dispose(){super.dispose(),this._featurePointCloud.length=0,this.onFeaturePointsUpdatedObservable.clear(),this.onFeaturePointsAddedObservable.clear()}_onXRFrame(e){if(!this.attached||!this._enabled||!e)return;const t=e.featurePointCloud;if(!(!t||t.length===0)){if(t.length%5!==0)throw new Error("Received malformed feature point cloud of length: "+t.length);const i=t.length/5,r=[],n=[];for(let a=0;a<i;a++){const o=a*5,l=t[o+4];this._featurePointCloud[l]?r.push(l):(this._featurePointCloud[l]={position:new x,confidenceValue:0},n.push(l)),this._featurePointCloud[l].position.x=t[o],this._featurePointCloud[l].position.y=t[o+1],this._featurePointCloud[l].position.z=t[o+2],this._featurePointCloud[l].confidenceValue=t[o+3]}n.length>0&&this.onFeaturePointsAddedObservable.notifyObservers(n),r.length>0&&this.onFeaturePointsUpdatedObservable.notifyObservers(r)}}_init(){!this._xrSessionManager.session.trySetFeaturePointCloudEnabled||!this._xrSessionManager.session.trySetFeaturePointCloudEnabled(!0)||(this._enabled=!0)}}Sl.Name=Ne.FEATURE_POINTS;Sl.Version=1;At.AddWebXRFeature(Sl.Name,s=>()=>new Sl(s),Sl.Version);let T6=0;class vl extends pi{constructor(e,t={}){super(e),this._options=t,this._detectedMeshes=new Map,this.onMeshAddedObservable=new k,this.onMeshRemovedObservable=new k,this.onMeshUpdatedObservable=new k,this.xrNativeFeatureName="mesh-detection",this._options.generateMeshes&&(this._options.convertCoordinateSystems=!0),this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce(()=>{this._init()})}detach(){return super.detach()?(this._xrSessionManager.isNative&&this._xrSessionManager.session.trySetMeshDetectorEnabled&&this._xrSessionManager.session.trySetMeshDetectorEnabled(!1),this._options.doNotRemoveMeshesOnSessionEnded||(this._detectedMeshes.forEach(e=>{this.onMeshRemovedObservable.notifyObservers(e)}),this._detectedMeshes.clear()),!0):!1}dispose(){super.dispose(),this.onMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onMeshUpdatedObservable.clear()}_onXRFrame(e){var t;try{if(!this.attached||!e)return;const i=e.detectedMeshes||((t=e.worldInformation)==null?void 0:t.detectedMeshes);if(i){const r=new Set;this._detectedMeshes.forEach((n,a)=>{i.has(a)||r.add(a)}),r.forEach(n=>{const a=this._detectedMeshes.get(n);a&&(this.onMeshRemovedObservable.notifyObservers(a),this._detectedMeshes.delete(n))}),i.forEach(n=>{if(this._detectedMeshes.has(n)){if(n.lastChangedTime===this._xrSessionManager.currentTimestamp){const a=this._detectedMeshes.get(n);a&&(this._updateVertexDataWithXRMesh(n,a,e),this.onMeshUpdatedObservable.notifyObservers(a))}}else{const a={id:T6++,xrMesh:n},o=this._updateVertexDataWithXRMesh(n,a,e);this._detectedMeshes.set(n,o),this.onMeshAddedObservable.notifyObservers(o)}})}}catch(i){N.Log(i.stack)}}_init(){this._xrSessionManager.isNative&&(this._xrSessionManager.session.trySetMeshDetectorEnabled&&this._xrSessionManager.session.trySetMeshDetectorEnabled(!0),this._options.preferredDetectorOptions&&this._xrSessionManager.session.trySetPreferredMeshDetectorOptions&&this._xrSessionManager.session.trySetPreferredMeshDetectorOptions(this._options.preferredDetectorOptions))}_updateVertexDataWithXRMesh(e,t,i){var n;t.xrMesh=e,t.worldParentNode=this._options.worldParentNode;const r=e.vertices||e.positions;if(this._options.convertCoordinateSystems){if(this._xrSessionManager.scene.useRightHandedSystem)t.positions=r,t.normals=e.normals;else{t.positions=new Float32Array(r.length);for(let o=0;o<r.length;o+=3)t.positions[o]=r[o],t.positions[o+1]=r[o+1],t.positions[o+2]=-1*r[o+2];if(e.normals){t.normals=new Float32Array(e.normals.length);for(let o=0;o<e.normals.length;o+=3)t.normals[o]=e.normals[o],t.normals[o+1]=e.normals[o+1],t.normals[o+2]=-1*e.normals[o+2]}}t.indices=e.indices;const a=i.getPose(e.meshSpace,this._xrSessionManager.referenceSpace);if(a){const o=t.transformationMatrix||new z;z.FromArrayToRef(a.transform.matrix,0,o),this._xrSessionManager.scene.useRightHandedSystem||o.toggleModelMatrixHandInPlace(),t.transformationMatrix=o,this._options.worldParentNode&&o.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),o)}if(this._options.generateMeshes){if(t.mesh){const o=t.mesh;o.updateVerticesData(M.PositionKind,t.positions),t.normals?o.updateVerticesData(M.NormalKind,t.normals):o.createNormals(!0),o.updateIndices(t.indices)}else{const o=new Oe("xr mesh "+t.id,this._xrSessionManager.scene);o.rotationQuaternion=new Z,o.setVerticesData(M.PositionKind,t.positions),t.normals?o.setVerticesData(M.NormalKind,t.normals):o.createNormals(!0),o.setIndices(t.indices,void 0,!0),t.mesh=o}(n=t.transformationMatrix)==null||n.decompose(t.mesh.scaling,t.mesh.rotationQuaternion,t.mesh.position)}}return t}}vl.Name=Ne.MESH_DETECTION;vl.Version=1;At.AddWebXRFeature(vl.Name,(s,e)=>()=>new vl(s,e),vl.Version,!1);var Is;(function(s){s[s.NotReceived=0]="NotReceived",s[s.Waiting=1]="Waiting",s[s.Received=2]="Received"})(Is||(Is={}));class xl extends pi{constructor(e,t){super(e),this.options=t,this.onUntrackableImageFoundObservable=new k,this.onTrackableImageFoundObservable=new k,this.onTrackedImageUpdatedObservable=new k,this._trackableScoreStatus=Is.NotReceived,this._trackedImages=[],this.xrNativeFeatureName="image-tracking"}attach(){return super.attach()}detach(){return super.detach()}getTrackedImageById(e){return this._trackedImages[e]||null}dispose(){super.dispose();for(const e of this._trackedImages)e.originalBitmap.close();this._trackedImages.length=0,this.onTrackableImageFoundObservable.clear(),this.onUntrackableImageFoundObservable.clear(),this.onTrackedImageUpdatedObservable.clear()}async getXRSessionInitExtension(){if(!this.options.images||!this.options.images.length)return{};const e=this.options.images.map(async t=>typeof t.src=="string"?await this._xrSessionManager.scene.getEngine()._createImageBitmapFromSource(t.src):t.src);try{const t=await Promise.all(e);return this._originalTrackingRequest=t.map((i,r)=>({image:i,widthInMeters:this.options.images[r].estimatedRealWorldWidth})),{trackedImages:this._originalTrackingRequest}}catch{return j.Error("Error loading images for tracking, WebXRImageTracking disabled for this session."),{}}}_onXRFrame(e){if(!e.getImageTrackingResults||this._trackableScoreStatus===Is.Waiting)return;if(this._trackableScoreStatus===Is.NotReceived){this._checkScoresAsync();return}const t=e.getImageTrackingResults();for(const i of t){let r=!1;const n=i.index,a=this._trackedImages[n];if(!a)continue;a.xrTrackingResult=i,a.realWorldWidth!==i.measuredWidthInMeters&&(a.realWorldWidth=i.measuredWidthInMeters,r=!0);const o=e.getPose(i.imageSpace,this._xrSessionManager.referenceSpace);if(o){const u=a.transformationMatrix;z.FromArrayToRef(o.transform.matrix,0,u),this._xrSessionManager.scene.useRightHandedSystem||u.toggleModelMatrixHandInPlace(),r=!0}const c=i.trackingState==="emulated";a.emulated!==c&&(a.emulated=c,r=!0),r&&this.onTrackedImageUpdatedObservable.notifyObservers(a)}}async _checkScoresAsync(){if(!this._xrSessionManager.session.getTrackedImageScores||this._trackableScoreStatus!==Is.NotReceived)return;this._trackableScoreStatus=Is.Waiting;const e=await this._xrSessionManager.session.getTrackedImageScores();if(!e||e.length===0){this._trackableScoreStatus=Is.NotReceived;return}for(let t=0;t<e.length;++t)if(e[t]=="untrackable")this.onUntrackableImageFoundObservable.notifyObservers(t);else{const i=this._originalTrackingRequest[t].image,r={id:t,originalBitmap:i,transformationMatrix:new z,ratio:i.width/i.height};this._trackedImages[t]=r,this.onTrackableImageFoundObservable.notifyObservers(r)}this._trackableScoreStatus=e.length>0?Is.Received:Is.NotReceived}}xl.Name=Ne.IMAGE_TRACKING;xl.Version=1;At.AddWebXRFeature(xl.Name,(s,e)=>()=>new xl(s,e),xl.Version,!1);class El extends pi{constructor(e,t){super(e),this.options=t,this._domOverlayType=null,this._beforeXRSelectListener=null,this._element=null,this.xrNativeFeatureName="dom-overlay",j.Warn("dom-overlay is an experimental and unstable feature.")}attach(){return!super.attach()||!this._xrSessionManager.session.domOverlayState||this._xrSessionManager.session.domOverlayState.type===null?!1:(this._domOverlayType=this._xrSessionManager.session.domOverlayState.type,this._element!==null&&this.options.supressXRSelectEvents===!0&&(this._beforeXRSelectListener=e=>{e.preventDefault()},this._element.addEventListener("beforexrselect",this._beforeXRSelectListener)),!0)}get domOverlayType(){return this._domOverlayType}dispose(){super.dispose(),this._element!==null&&this._beforeXRSelectListener&&this._element.removeEventListener("beforexrselect",this._beforeXRSelectListener)}_onXRFrame(e){}async getXRSessionInitExtension(){if(this.options.element===void 0)return j.Warn('"element" option must be provided to attach xr-dom-overlay feature.'),{};if(typeof this.options.element=="string"){const e=document.querySelector(this.options.element);if(e===null)return j.Warn(`element not found '${this.options.element}' (not requesting xr-dom-overlay)`),{};this._element=e}else this._element=this.options.element;return{domOverlay:{root:this._element}}}}El.Name=Ne.DOM_OVERLAY;El.Version=1;At.AddWebXRFeature(El.Name,(s,e)=>()=>new El(s,e),El.Version,!1);class Gn extends pi{get movementDirection(){return this._movementDirection}get movementEnabled(){return this._featureContext.movementEnabled}set movementEnabled(e){this._featureContext.movementEnabled=e}get movementOrientationFollowsViewerPose(){return this._featureContext.movementOrientationFollowsViewerPose}set movementOrientationFollowsViewerPose(e){this._featureContext.movementOrientationFollowsViewerPose=e}get movementSpeed(){return this._featureContext.movementSpeed}set movementSpeed(e){this._featureContext.movementSpeed=e}get movementThreshold(){return this._featureContext.movementThreshold}set movementThreshold(e){this._featureContext.movementThreshold=e}get rotationEnabled(){return this._featureContext.rotationEnabled}set rotationEnabled(e){this._featureContext.rotationEnabled=e}get rotationSpeed(){return this._featureContext.rotationSpeed}set rotationSpeed(e){this._featureContext.rotationSpeed=e}get rotationThreshold(){return this._featureContext.rotationThreshold}set rotationThreshold(e){this._featureContext.rotationThreshold=e}constructor(e,t){if(super(e),this._controllers={},this._currentRegistrationConfigurations=[],this._movementDirection=new Z,this._tmpRotationMatrix=z.Identity(),this._tmpTranslationDirection=new x,this._tmpMovementTranslation=new x,this._tempCacheQuaternion=new Z,this._attachController=i=>{if(this._controllers[i.uniqueId])return;this._controllers[i.uniqueId]={xrController:i,registeredComponents:[]};const r=this._controllers[i.uniqueId];if(r.xrController.inputSource.targetRayMode==="tracked-pointer"&&r.xrController.inputSource.gamepad){const n=()=>{if(i.motionController)for(const a of this._currentRegistrationConfigurations){let o=null;if(a.allowedComponentTypes)for(const c of a.allowedComponentTypes){const u=i.motionController.getComponentOfType(c);if(u!==null){o=u;break}}if(a.mainComponentOnly){const c=i.motionController.getMainComponent();if(c===null)continue;o=c}if(typeof a.componentSelectionPredicate=="function"&&(o=a.componentSelectionPredicate(i)),o&&a.forceHandedness&&i.inputSource.handedness!==a.forceHandedness||o===null)continue;const l={registrationConfiguration:a,component:o};r.registeredComponents.push(l),"axisChangedHandler"in a&&(l.onAxisChangedObserver=o.onAxisValueChangedObservable.add(c=>{a.axisChangedHandler(c,this._movementState,this._featureContext,this._xrInput)})),"buttonChangedHandler"in a&&(l.onButtonChangedObserver=o.onButtonStateChangedObservable.add(c=>{c.changes.pressed&&a.buttonChangedHandler(c.changes.pressed,this._movementState,this._featureContext,this._xrInput)}))}};i.motionController?n():i.onMotionControllerInitObservable.addOnce(()=>{n()})}},!t||t.xrInput===void 0){j.Error('WebXRControllerMovement feature requires "xrInput" option.');return}Array.isArray(t.customRegistrationConfigurations)?this._currentRegistrationConfigurations=t.customRegistrationConfigurations:this._currentRegistrationConfigurations=Gn.REGISTRATIONS.default,this._featureContext={movementEnabled:t.movementEnabled??!0,movementOrientationFollowsViewerPose:t.movementOrientationFollowsViewerPose??!0,movementOrientationFollowsController:t.movementOrientationFollowsController??!1,orientationPreferredHandedness:t.orientationPreferredHandedness,movementSpeed:t.movementSpeed??1,movementThreshold:t.movementThreshold??.25,rotationEnabled:t.rotationEnabled??!0,rotationSpeed:t.rotationSpeed??1,rotationThreshold:t.rotationThreshold??.25},this._movementState={moveX:0,moveY:0,rotateX:0,rotateY:0},this._xrInput=t.xrInput}attach(){if(!super.attach())return!1;for(const e of this._xrInput.controllers)this._attachController(e);return this._addNewAttachObserver(this._xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),!0}detach(){if(!super.detach())return!1;const e=Object.keys(this._controllers);for(const t of e)this._detachController(t);return this._controllers={},!0}_onXRFrame(e){if(this.attached){if(this._movementState.rotateX!==0&&this._featureContext.rotationEnabled){const i=this._xrSessionManager.scene.getEngine().getDeltaTime()*.001*this._featureContext.rotationSpeed*this._movementState.rotateX*(this._xrSessionManager.scene.useRightHandedSystem?-1:1);if(this._featureContext.movementOrientationFollowsViewerPose)this._xrInput.xrCamera.cameraRotation.y+=i,Z.RotationYawPitchRollToRef(i,0,0,this._tempCacheQuaternion),this._xrInput.xrCamera.rotationQuaternion.multiplyToRef(this._tempCacheQuaternion,this._movementDirection);else if(this._featureContext.movementOrientationFollowsController){this._xrInput.xrCamera.cameraRotation.y+=i;const r=this._featureContext.orientationPreferredHandedness||"right",n=Object.keys(this._controllers).find(o=>{var l,c;return((c=(l=this._controllers[o])==null?void 0:l.xrController)==null?void 0:c.inputSource.handedness)===r})||Object.keys(this._controllers)[0],a=this._controllers[n];Z.RotationYawPitchRollToRef(i,0,0,this._tempCacheQuaternion),((a==null?void 0:a.xrController.pointer.rotationQuaternion)||Z.Identity()).multiplyToRef(this._tempCacheQuaternion,this._movementDirection)}else Z.RotationYawPitchRollToRef(i*3,0,0,this._tempCacheQuaternion),this._movementDirection.multiplyInPlace(this._tempCacheQuaternion)}else if(this._featureContext.movementOrientationFollowsViewerPose)this._movementDirection.copyFrom(this._xrInput.xrCamera.rotationQuaternion);else if(this._featureContext.movementOrientationFollowsController){const t=this._featureContext.orientationPreferredHandedness||"right",i=Object.keys(this._controllers).find(n=>{var a;return((a=this._controllers[n])==null?void 0:a.xrController.inputSource.handedness)===t})||Object.keys(this._controllers)[0],r=this._controllers[i];this._movementDirection.copyFrom((r==null?void 0:r.xrController.pointer.rotationQuaternion)||Z.Identity())}(this._movementState.moveX||this._movementState.moveY)&&this._featureContext.movementEnabled&&(z.FromQuaternionToRef(this._movementDirection,this._tmpRotationMatrix),this._tmpTranslationDirection.set(this._movementState.moveX,0,this._movementState.moveY*(this._xrSessionManager.scene.useRightHandedSystem?1:-1)),x.TransformCoordinatesToRef(this._tmpTranslationDirection,this._tmpRotationMatrix,this._tmpMovementTranslation),this._tmpMovementTranslation.scaleInPlace(this._xrInput.xrCamera._computeLocalCameraSpeed()*this._featureContext.movementSpeed),this._xrInput.xrCamera.cameraDirection.addInPlace(this._tmpMovementTranslation))}}_detachController(e){const t=this._controllers[e];if(t){for(const i of t.registeredComponents)i.onAxisChangedObserver&&i.component.onAxisValueChangedObservable.remove(i.onAxisChangedObserver),i.onButtonChangedObserver&&i.component.onButtonStateChangedObservable.remove(i.onButtonChangedObserver);delete this._controllers[e]}}}Gn.Name=Ne.MOVEMENT;Gn.REGISTRATIONS={default:[{allowedComponentTypes:[vr.THUMBSTICK_TYPE,vr.TOUCHPAD_TYPE],forceHandedness:"left",axisChangedHandler:(s,e,t)=>{e.rotateX=Math.abs(s.x)>t.rotationThreshold?s.x:0,e.rotateY=Math.abs(s.y)>t.rotationThreshold?s.y:0}},{allowedComponentTypes:[vr.THUMBSTICK_TYPE,vr.TOUCHPAD_TYPE],forceHandedness:"right",axisChangedHandler:(s,e,t)=>{e.moveX=Math.abs(s.x)>t.movementThreshold?s.x:0,e.moveY=Math.abs(s.y)>t.movementThreshold?s.y:0}}]};Gn.Version=1;At.AddWebXRFeature(Gn.Name,(s,e)=>()=>new Gn(s,e),Gn.Version,!0);class Tl extends pi{constructor(e,t){super(e),this.options=t,this._canvasContext=null,this._reflectionCubeMap=null,this._xrLightEstimate=null,this._xrLightProbe=null,this._xrWebGLBinding=null,this._lightDirection=x.Up().negateInPlace(),this._lightColor=q.White(),this._intensity=1,this._sphericalHarmonics=new nM,this._cubeMapPollTime=Date.now(),this._lightEstimationPollTime=Date.now(),this._reflectionCubeMapTextureSize=16,this.directionalLight=null,this.onReflectionCubeMapUpdatedObservable=new k,this._updateReflectionCubeMap=()=>{var r;if(!this._xrLightProbe)return;if(this.options.cubeMapPollInterval){const n=Date.now();if(n-this._cubeMapPollTime<this.options.cubeMapPollInterval)return;this._cubeMapPollTime=n}const i=this._getXRGLBinding().getReflectionCubeMap(this._xrLightProbe);if(i&&this._reflectionCubeMap){if(this._reflectionCubeMap._texture)(r=this._reflectionCubeMap._texture._hardwareTexture)==null||r.set(i),this._reflectionCubeMap._texture.getEngine().resetTextureCache();else{const n=new $t(this._xrSessionManager.scene.getEngine(),0);n.isCube=!0,n.invertY=!1,n._useSRGBBuffer=this.options.reflectionFormat==="srgba8",n.format=5,n.generateMipMaps=!0,n.type=this.options.reflectionFormat!=="srgba8"?2:0,n.samplingMode=3,n.width=this._reflectionCubeMapTextureSize,n.height=this._reflectionCubeMapTextureSize,n._cachedWrapU=1,n._cachedWrapV=1,n._hardwareTexture=new Su(i,this._getCanvasContext()),this._reflectionCubeMap._texture=n}this._reflectionCubeMap._texture.isReady=!0,this.options.disablePreFiltering?(this._xrSessionManager.scene.markAllMaterialsAsDirty(1),this.onReflectionCubeMapUpdatedObservable.notifyObservers(this._reflectionCubeMap)):(this._xrLightProbe.removeEventListener("reflectionchange",this._updateReflectionCubeMap),this._hdrFilter.prefilter(this._reflectionCubeMap).then(()=>{this._xrSessionManager.scene.markAllMaterialsAsDirty(1),this.onReflectionCubeMapUpdatedObservable.notifyObservers(this._reflectionCubeMap),this._xrLightProbe.addEventListener("reflectionchange",this._updateReflectionCubeMap)}))}},this.xrNativeFeatureName="light-estimation",this.options.createDirectionalLightSource&&(this.directionalLight=new aM("light estimation directional",this._lightDirection,this._xrSessionManager.scene),this.directionalLight.position=new x(0,8,0),this.directionalLight.intensity=0,this.directionalLight.falloffType=ro.FALLOFF_GLTF),this._hdrFilter=new pA(this._xrSessionManager.scene.getEngine()),j.Warn("light-estimation is an experimental and unstable feature.")}get reflectionCubeMapTexture(){return this._reflectionCubeMap}get xrLightingEstimate(){return this._xrLightEstimate?{lightColor:this._lightColor,lightDirection:this._lightDirection,lightIntensity:this._intensity,sphericalHarmonics:this._sphericalHarmonics}:this._xrLightEstimate}_getCanvasContext(){return this._canvasContext===null&&(this._canvasContext=this._xrSessionManager.scene.getEngine()._gl),this._canvasContext}_getXRGLBinding(){if(this._xrWebGLBinding===null){const e=this._getCanvasContext();this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,e)}return this._xrWebGLBinding}attach(){if(!super.attach())return!1;const e=this.options.reflectionFormat??(this._xrSessionManager.session.preferredReflectionFormat||"srgba8");return this.options.reflectionFormat=e,this._xrSessionManager.session.requestLightProbe({reflectionFormat:e}).then(t=>{this._xrLightProbe=t,this.options.disableCubeMapReflection||(this._reflectionCubeMap||(this._reflectionCubeMap=new ps(this._xrSessionManager.scene),this._reflectionCubeMap._isCube=!0,this._reflectionCubeMap.coordinatesMode=3,this.options.setSceneEnvironmentTexture&&(this._xrSessionManager.scene.environmentTexture=this._reflectionCubeMap)),this._xrLightProbe.addEventListener("reflectionchange",this._updateReflectionCubeMap))}),!0}detach(){const e=super.detach();return this._xrLightProbe!==null&&!this.options.disableCubeMapReflection&&(this._xrLightProbe.removeEventListener("reflectionchange",this._updateReflectionCubeMap),this._xrLightProbe=null),this._canvasContext=null,this._xrLightEstimate=null,this._xrWebGLBinding=null,e}dispose(){super.dispose(),this.onReflectionCubeMapUpdatedObservable.clear(),this.directionalLight&&(this.directionalLight.dispose(),this.directionalLight=null),this._reflectionCubeMap!==null&&(this._reflectionCubeMap._texture&&this._reflectionCubeMap._texture.dispose(),this._reflectionCubeMap.dispose(),this._reflectionCubeMap=null)}_onXRFrame(e){var t;if(this._xrLightProbe!==null){if(this.options.lightEstimationPollInterval){const i=Date.now();if(i-this._lightEstimationPollTime<this.options.lightEstimationPollInterval)return;this._lightEstimationPollTime=i}if(this._xrLightEstimate=e.getLightEstimate(this._xrLightProbe),this._xrLightEstimate){this._intensity=Math.max(1,this._xrLightEstimate.primaryLightIntensity.x,this._xrLightEstimate.primaryLightIntensity.y,this._xrLightEstimate.primaryLightIntensity.z);const i=this._xrSessionManager.scene.useRightHandedSystem?1:-1;this.options.disableVectorReuse&&(this._lightDirection=new x,this._lightColor=new q,this.directionalLight&&(this.directionalLight.direction=this._lightDirection,this.directionalLight.diffuse=this._lightColor)),this._lightDirection.copyFromFloats(this._xrLightEstimate.primaryLightDirection.x,this._xrLightEstimate.primaryLightDirection.y,this._xrLightEstimate.primaryLightDirection.z*i),this._lightColor.copyFromFloats(this._xrLightEstimate.primaryLightIntensity.x/this._intensity,this._xrLightEstimate.primaryLightIntensity.y/this._intensity,this._xrLightEstimate.primaryLightIntensity.z/this._intensity),this._sphericalHarmonics.updateFromFloatsArray(this._xrLightEstimate.sphericalHarmonicsCoefficients),this._reflectionCubeMap&&!this.options.disableSphericalPolynomial&&(this._reflectionCubeMap.sphericalPolynomial=this._reflectionCubeMap.sphericalPolynomial||new aI,(t=this._reflectionCubeMap.sphericalPolynomial)==null||t.updateFromHarmonics(this._sphericalHarmonics)),this._lightDirection.negateInPlace(),this.directionalLight&&(this.directionalLight.direction.copyFrom(this._lightDirection),this.directionalLight.intensity=Math.min(this._intensity,1),this.directionalLight.diffuse.copyFrom(this._lightColor))}}}}Tl.Name=Ne.LIGHT_ESTIMATION;Tl.Version=1;At.AddWebXRFeature(Tl.Name,(s,e)=>()=>new Tl(s,e),Tl.Version,!1);class bl extends pi{constructor(e){super(e),this.onEyeTrackingStartedObservable=new k,this.onEyeTrackingEndedObservable=new k,this.onEyeTrackingFrameUpdateObservable=new k,this._eyeTrackingStartListener=t=>{this._latestEyeSpace=t.gazeSpace,this._gazeRay=new xe(x.Zero(),x.Forward()),this.onEyeTrackingStartedObservable.notifyObservers(this._gazeRay)},this._eyeTrackingEndListener=()=>{this._latestEyeSpace=null,this._gazeRay=null,this.onEyeTrackingEndedObservable.notifyObservers()},this.xrNativeFeatureName="eye-tracking",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce(()=>{this._init()})}dispose(){super.dispose(),this._xrSessionManager.session.removeEventListener("eyetrackingstart",this._eyeTrackingStartListener),this._xrSessionManager.session.removeEventListener("eyetrackingend",this._eyeTrackingEndListener),this.onEyeTrackingStartedObservable.clear(),this.onEyeTrackingEndedObservable.clear(),this.onEyeTrackingFrameUpdateObservable.clear()}get isEyeGazeValid(){return!!this._gazeRay}getEyeGaze(){return this._gazeRay}_onXRFrame(e){if(!(!this.attached||!e)&&this._latestEyeSpace&&this._gazeRay){const t=e.getPose(this._latestEyeSpace,this._xrSessionManager.referenceSpace);if(t){this._gazeRay.origin.set(t.transform.position.x,t.transform.position.y,t.transform.position.z).scaleInPlace(this._xrSessionManager.worldScalingFactor);const i=t.transform.orientation;G.Quaternion[0].set(i.x,i.y,i.z,i.w),this._xrSessionManager.scene.useRightHandedSystem?x.RightHandedForwardReadOnly.rotateByQuaternionToRef(G.Quaternion[0],this._gazeRay.direction):(this._gazeRay.origin.z*=-1,G.Quaternion[0].z*=-1,G.Quaternion[0].w*=-1,x.LeftHandedForwardReadOnly.rotateByQuaternionToRef(G.Quaternion[0],this._gazeRay.direction)),this.onEyeTrackingFrameUpdateObservable.notifyObservers(this._gazeRay)}}}_init(){this._xrSessionManager.isNative&&(this._xrSessionManager.session.addEventListener("eyetrackingstart",this._eyeTrackingStartListener),this._xrSessionManager.session.addEventListener("eyetrackingend",this._eyeTrackingEndListener))}}bl.Name=Ne.EYE_TRACKING;bl.Version=1;At.AddWebXRFeature(bl.Name,s=>()=>new bl(s),bl.Version,!1);class b6{constructor(e,t){this._samples=[],this._idx=0;for(let i=0;i<e;++i)this._samples.push(t?t():X.Zero())}get length(){return this._samples.length}push(e,t){this._idx=(this._idx+this._samples.length-1)%this._samples.length,this.at(0).copyFromFloats(e,t)}at(e){if(e>=this._samples.length)throw new Error("Index out of bounds");return this._samples[(this._idx+e)%this._samples.length]}}class C6{constructor(){this._samples=new b6(20),this._entropy=0,this.onFirstStepDetected=new k}update(e,t,i,r){this._samples.push(e,t);const n=this._samples.at(0);if(this._entropy*=this._entropyDecayFactor,this._entropy+=X.Distance(n,this._samples.at(1)),this._entropy>this._entropyThreshold)return;let a;for(a=this._samePointCheckStartIdx;a<this._samples.length&&!(X.DistanceSquared(n,this._samples.at(a))<this._samePointSquaredDistanceThreshold);++a);if(a===this._samples.length)return;let o=-1,l=0;for(let A,I=1;I<a;++I)A=X.DistanceSquared(n,this._samples.at(I)),A>o&&(l=I,o=A);if(o<this._apexSquaredDistanceThreshold)return;const c=this._samples.at(l),u=c.subtract(n);u.normalize();const h=G.Vector2[0];let d,f,m=0;for(let A=1;A<a;++A)f=this._samples.at(A),f.subtractToRef(n,h),d=X.Dot(u,h),m+=h.lengthSquared()-d*d;if(m>a*this._squaredProjectionDistanceThreshold)return;const g=G.Vector3[0];g.set(i,r,0);const v=G.Vector3[1];v.set(u.x,u.y,0);const E=x.Cross(g,v).z>0,T=n.clone(),C=n.clone();c.subtractToRef(n,u),E?(u.scaleAndAddToRef(this._axisToApexShrinkFactor,T),u.scaleAndAddToRef(this._axisToApexExtendFactor,C)):(u.scaleAndAddToRef(this._axisToApexExtendFactor,T),u.scaleAndAddToRef(this._axisToApexShrinkFactor,C)),this.onFirstStepDetected.notifyObservers({leftApex:T,rightApex:C,currentPosition:n,currentStepDirection:E?"right":"left"})}reset(){for(let e=0;e<this._samples.length;++e)this._samples.at(e).copyFromFloats(0,0)}get _samePointCheckStartIdx(){return Math.floor(this._samples.length/3)}get _samePointSquaredDistanceThreshold(){return .03*.03}get _apexSquaredDistanceThreshold(){return .09*.09}get _squaredProjectionDistanceThreshold(){return .03*.03}get _axisToApexShrinkFactor(){return .8}get _axisToApexExtendFactor(){return-1.6}get _entropyDecayFactor(){return .93}get _entropyThreshold(){return .4}}class y6{constructor(e,t,i,r){this._leftApex=new X,this._rightApex=new X,this._currentPosition=new X,this._axis=new X,this._axisLength=-1,this._forward=new X,this._steppingLeft=!1,this._t=-1,this._maxT=-1,this._maxTPosition=new X,this._vitality=0,this.onMovement=new k,this.onFootfall=new k,this._reset(e,t,i,r==="left")}_reset(e,t,i,r){this._leftApex.copyFrom(e),this._rightApex.copyFrom(t),this._steppingLeft=r,this._steppingLeft?(this._leftApex.subtractToRef(this._rightApex,this._axis),this._forward.copyFromFloats(-this._axis.y,this._axis.x)):(this._rightApex.subtractToRef(this._leftApex,this._axis),this._forward.copyFromFloats(this._axis.y,-this._axis.x)),this._axisLength=this._axis.length(),this._forward.scaleInPlace(1/this._axisLength),this._updateTAndVitality(i.x,i.y),this._maxT=this._t,this._maxTPosition.copyFrom(i),this._vitality=1}_updateTAndVitality(e,t){this._currentPosition.copyFromFloats(e,t),this._steppingLeft?this._currentPosition.subtractInPlace(this._rightApex):this._currentPosition.subtractInPlace(this._leftApex);const i=this._t,r=X.Dot(this._currentPosition,this._axis);this._t=r/(this._axisLength*this._axisLength);const n=this._currentPosition.lengthSquared()-r/this._axisLength*(r/this._axisLength);this._vitality*=.92-100*Math.max(n-.0016,0)+Math.max(this._t-i,0)}update(e,t){if(this._vitality<this._vitalityThreshold)return!1;const i=this._t;return this._updateTAndVitality(e,t),this._t>this._maxT&&(this._maxT=this._t,this._maxTPosition.copyFromFloats(e,t)),!(this._vitality<this._vitalityThreshold||(this._t>i&&(this.onMovement.notifyObservers({deltaT:this._t-i}),i<.5&&this._t>=.5&&this.onFootfall.notifyObservers({foot:this._steppingLeft?"left":"right"})),this._t<.95*this._maxT&&(this._currentPosition.copyFromFloats(e,t),this._steppingLeft?this._leftApex.copyFrom(this._maxTPosition):this._rightApex.copyFrom(this._maxTPosition),this._reset(this._leftApex,this._rightApex,this._currentPosition,!this._steppingLeft)),this._axisLength<.03))}get _vitalityThreshold(){return .1}get forward(){return this._forward}}class Cl{static get _MillisecondsPerUpdate(){return 1e3/15}constructor(e){this._detector=new C6,this._walker=null,this._movement=new X,this._millisecondsSinceLastUpdate=Cl._MillisecondsPerUpdate,this.movementThisFrame=x.Zero(),this._engine=e,this._detector.onFirstStepDetected.add(t=>{this._walker||(this._walker=new y6(t.leftApex,t.rightApex,t.currentPosition,t.currentStepDirection),this._walker.onFootfall.add(()=>{N.Log("Footfall!")}),this._walker.onMovement.add(i=>{this._walker.forward.scaleAndAddToRef(.024*i.deltaT,this._movement)}))})}update(e,t){t.y=0,t.normalize(),this._millisecondsSinceLastUpdate+=this._engine.getDeltaTime(),this._millisecondsSinceLastUpdate>=Cl._MillisecondsPerUpdate&&(this._millisecondsSinceLastUpdate-=Cl._MillisecondsPerUpdate,this._detector.update(e.x,e.z,t.x,t.z),this._walker&&(this._walker.update(e.x,e.z)||(this._walker=null)),this._movement.scaleInPlace(.85)),this.movementThisFrame.set(this._movement.x,0,this._movement.y)}}class od extends pi{static get Name(){return Ne.WALKING_LOCOMOTION}static get Version(){return 1}get locomotionTarget(){return this._locomotionTarget}set locomotionTarget(e){this._locomotionTarget=e,this._isLocomotionTargetWebXRCamera=this._locomotionTarget.getClassName()==="WebXRCamera"}constructor(e,t){super(e),this._up=new x,this._forward=new x,this._position=new x,this._movement=new x,this._sessionManager=e,this.locomotionTarget=t.locomotionTarget,this._isLocomotionTargetWebXRCamera&&N.Warn("Using walking locomotion directly on a WebXRCamera may have unintended interactions with other XR techniques. Using an XR space parent is highly recommended")}isCompatible(){return this._sessionManager.sessionMode===void 0||this._sessionManager.sessionMode==="immersive-vr"}attach(){return!this.isCompatible||!super.attach()?!1:(this._walker=new Cl(this._sessionManager.scene.getEngine()),!0)}detach(){return super.detach()?(this._walker=null,!0):!1}_onXRFrame(e){const t=e.getViewerPose(this._sessionManager.baseReferenceSpace);if(!t)return;const i=this.locomotionTarget.getScene().useRightHandedSystem?1:-1,r=t.transform.matrix;this._up.copyFromFloats(r[4],r[5],i*r[6]),this._forward.copyFromFloats(r[8],r[9],i*r[10]),this._position.copyFromFloats(r[12],r[13],i*r[14]),this._forward.scaleAndAddToRef(.05,this._position),this._up.scaleAndAddToRef(-.05,this._position),this._walker.update(this._position,this._forward),this._movement.copyFrom(this._walker.movementThisFrame),this._isLocomotionTargetWebXRCamera||x.TransformNormalToRef(this._movement,this.locomotionTarget.getWorldMatrix(),this._movement),this.locomotionTarget.position.addInPlace(this._movement)}}At.AddWebXRFeature(od.Name,(s,e)=>()=>new od(s,e),od.Version,!1);class rN extends a_{constructor(e,t,i,r,n,a,o=null){super(e,t,i,r,a),this.getWidth=e,this.getHeight=t,this.layer=i,this.layerType=r,this.isMultiview=n,this.createRTTProvider=a,this._originalInternalTexture=o}}class sN extends o_{constructor(e,t,i){super(e.scene,i),this._xrSessionManager=e,this._xrWebGLBinding=t,this.layerWrapper=i,this._lastSubImages=new Map,this.onRenderTargetTextureCreatedObservable=new k,this._compositionLayer=i.layer}_getRenderTargetForSubImage(e,t="none"){const i=this._lastSubImages.get(t),r=t=="right"?1:0,n=e.colorTextureWidth??e.textureWidth,a=e.colorTextureHeight??e.textureHeight;if(!this._renderTargetTextures[r]||(i==null?void 0:i.textureWidth)!==n||(i==null?void 0:i.textureHeight)!==a){let o;const l=e.depthStencilTextureWidth??n,c=e.depthStencilTextureHeight??a;(n===l||a===c)&&(o=e.depthStencilTexture),this._renderTargetTextures[r]=this._createRenderTargetTexture(n,a,null,e.colorTexture,o,this.layerWrapper.isMultiview),this._framebufferDimensions={framebufferWidth:n,framebufferHeight:a},this.onRenderTargetTextureCreatedObservable.notifyObservers({texture:this._renderTargetTextures[r],eye:t})}return this._lastSubImages.set(t,e),this._renderTargetTextures[r]}_getSubImageForEye(e){const t=this._xrSessionManager.currentFrame;return t?this._xrWebGLBinding.getSubImage(this._compositionLayer,t,e):null}getRenderTargetTextureForEye(e){const t=this._getSubImageForEye(e);return t?this._getRenderTargetForSubImage(t,e):null}getRenderTargetTextureForView(e){return this.getRenderTargetTextureForEye(e==null?void 0:e.eye)}_setViewportForSubImage(e,t){const i=t.colorTextureWidth??t.textureWidth,r=t.colorTextureHeight??t.textureHeight,n=t.viewport;e.x=n.x/i,e.y=n.y/r,e.width=n.width/i,e.height=n.height/r}trySetViewportForView(e,t){const i=this._lastSubImages.get(t.eye)||this._getSubImageForEye(t.eye);return i?(this._setViewportForSubImage(e,i),!0):!1}}class I6 extends rN{constructor(e,t,i){super(()=>e.textureWidth,()=>e.textureHeight,e,"XRProjectionLayer",t,r=>new R6(r,i,this)),this.layer=e}}class R6 extends sN{constructor(e,t,i){super(e,t,i),this.layerWrapper=i,this._projectionLayer=i.layer}_getSubImageForView(e){return this._xrWebGLBinding.getViewSubImage(this._projectionLayer,e)}getRenderTargetTextureForView(e){return this._getRenderTargetForSubImage(this._getSubImageForView(e),e.eye)}getRenderTargetTextureForEye(e){const t=this._lastSubImages.get(e);return t?this._getRenderTargetForSubImage(t,e):null}trySetViewportForView(e,t){const i=this._lastSubImages.get(t.eye)||this._getSubImageForView(t);return i?(this._setViewportForSubImage(e,i),!0):!1}}const yy={textureType:"texture",colorFormat:6408,depthFormat:35056,scaleFactor:1,clearOnAccess:!1},A6={};class yl extends pi{constructor(e,t={}){super(e),this._options=t,this._existingLayers=[],this._isMultiviewEnabled=!1,this._projectionLayerInitialized=!1,this._compositionLayerTextureMapping=new WeakMap,this._layerToRTTProviderMapping=new WeakMap,this.xrNativeFeatureName="layers"}attach(){if(!super.attach())return!1;const e=this._xrSessionManager.scene.getEngine();this._glContext=e._gl,this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,this._glContext),this._existingLayers.length=0;const t={...yy,...this._options.projectionLayerInit};return this._isMultiviewEnabled=this._options.preferMultiviewOnInit&&e.getCaps().multiview,this.createProjectionLayer(t),this._projectionLayerInitialized=!0,!0}detach(){if(!super.detach())return!1;for(const e of this._existingLayers)e.dispose();return this._existingLayers.length=0,this._projectionLayerInitialized=!1,!0}createXRWebGLLayer(e=A6){const t=new XRWebGLLayer(this._xrSessionManager.session,this._glContext,e);return new l_(t)}_validateLayerInit(e,t=this._isMultiviewEnabled){if(!this._xrSessionManager.inXRSession)throw new Error("Cannot create a layer outside of a WebXR session. Make sure the session has started before creating layers.");if(t&&e.textureType!=="texture-array")throw new Error("Projection layers can only be made multiview if they use texture arrays. Set the textureType parameter to 'texture-array'.");if(!t&&e.textureType==="texture-array")throw new Error("We currently only support multiview rendering when the textureType parameter is set to 'texture-array'.")}_extendXRLayerInit(e,t=this._isMultiviewEnabled){return t&&(e.textureType="texture-array"),e}createProjectionLayer(e=yy,t=this._isMultiviewEnabled){this._extendXRLayerInit(e,t),this._validateLayerInit(e,t);const i=this._xrWebGLBinding.createProjectionLayer(e),r=new I6(i,t,this._xrWebGLBinding);return this.addXRSessionLayer(r),r}_createQuadLayer(e={params:{}},t){this._extendXRLayerInit(e.params,!1);const i=this._existingLayers[0].layer.textureWidth,r=this._existingLayers[0].layer.textureHeight,n={space:this._xrSessionManager.referenceSpace,viewPixelWidth:i,viewPixelHeight:r,clearOnAccess:!0,...e.params};this._validateLayerInit(n,!1);const a=this._xrWebGLBinding.createQuadLayer(n);a.width=this._isMultiviewEnabled?1:2,a.height=1;const o=new rN(()=>a.width,()=>a.height,a,"XRQuadLayer",!1,c=>new sN(c,this._xrWebGLBinding,o));t&&this._compositionLayerTextureMapping.set(a,t);const l=o.createRenderTargetTextureProvider(this._xrSessionManager);return this._layerToRTTProviderMapping.set(a,l),this.addXRSessionLayer(o),o}addFullscreenAdvancedDynamicTexture(e,t={distanceFromHeadset:1.5}){const i=this._createQuadLayer({params:{space:this._xrSessionManager.viewerReferenceSpace,textureType:"texture",layout:"mono"}},e),r=i.layer,a={x:0,y:0,z:-Math.max(.1,t.distanceFromHeadset)},o={x:0,y:0,z:0,w:1};r.transform=new XRRigidTransform(a,o);const l=this._layerToRTTProviderMapping.get(r);if(!l)throw new Error("Could not find the RTT provider for the layer");const c=this._xrSessionManager.scene.layers.find(u=>u.texture===e);if(!c)throw new Error("Could not find the babylon layer for the texture");return l.onRenderTargetTextureCreatedObservable.add(u=>{u.eye&&u.eye==="right"||(u.texture.clearColor=new Te(0,0,0,0),c.renderTargetTextures.push(u.texture),c.renderOnlyInRenderTargetTextures=!0,this._xrSessionManager.scene.onBeforeRenderObservable.add(()=>{u.texture.render()}),c.renderTargetTextures.push(u.texture),c.renderOnlyInRenderTargetTextures=!0,this._xrSessionManager.onXRSessionEnded.addOnce(()=>{c.renderTargetTextures.splice(c.renderTargetTextures.indexOf(u.texture),1),c.renderOnlyInRenderTargetTextures=!1}))}),i}_addLensFlareSystem(e){const t=this._createQuadLayer({params:{space:this._xrSessionManager.viewerReferenceSpace,textureType:"texture",layout:"mono"}}),i=t.layer;i.width=2,i.height=1;const n={x:0,y:0,z:-10},a={x:0,y:0,z:0,w:1};i.transform=new XRRigidTransform(n,a);const o=this._layerToRTTProviderMapping.get(i);if(!o)throw new Error("Could not find the RTT provider for the layer");return o.onRenderTargetTextureCreatedObservable.add(l=>{l.texture.clearColor=new Te(0,0,0,0),l.texture.customRenderFunction=()=>{e.render()}}),this._xrSessionManager.onXRSessionInit.add(()=>{this._xrSessionManager.scene.lensFlareSystems.splice(this._xrSessionManager.scene.lensFlareSystems.indexOf(e),1)}),this._xrSessionManager.onXRSessionEnded.add(()=>{this._xrSessionManager.scene.lensFlareSystems.push(e)}),t}addXRSessionLayer(e){this._existingLayers.push(e),this.setXRSessionLayers(this._existingLayers)}setXRSessionLayers(e=this._existingLayers){const t={...this._xrSessionManager.session.renderState};t.baseLayer=void 0,t.layers=e.map(i=>i.layer),this._xrSessionManager.updateRenderState(t),this._projectionLayerInitialized||this._xrSessionManager._setBaseLayerWrapper(e.length>0?e.at(0):null)}isCompatible(){return!this._xrSessionManager.isNative&&typeof XRWebGLBinding<"u"&&!!XRWebGLBinding.prototype.createProjectionLayer}dispose(){super.dispose()}_onXRFrame(e){const t=this._existingLayers;for(let i=0;i<t.length;++i){const r=t[i];if(r.layerType!=="XRProjectionLayer"){const n=this._layerToRTTProviderMapping.get(r.layer);if(!n)continue;if(n.layerWrapper.isMultiview){const a=e.getViewerPose(this._xrSessionManager.referenceSpace);if(a){const o=a.views;for(let l=0;l<o.length;++l){const c=o[l];n.getRenderTargetTextureForView(c)}}}else n.getRenderTargetTextureForView()}}}}yl.Name=Ne.LAYERS;yl.Version=1;At.AddWebXRFeature(yl.Name,(s,e)=>()=>new yl(s,e),yl.Version,!1);class P6 extends Oi{constructor(){super(...arguments),this.DEPTH_SENSING=!1,this.DEPTH_SENSING_TEXTURE_ARRAY=!1,this.DEPTH_SENSING_TEXTURE_AL=!1,this.DEPTH_SENSING_DISCARD=!0}}let oo=!1,nn=null,Cm=!1;const pu={width:512,height:512},Bn={x:0,y:0,width:1,height:1};let ym=1,nN=0,aN=!0;const Im=z.Identity(),ga=[];class oN extends Er{_markAllDefinesAsDirty(){this._enable(this._isEnabled),this.markAllDefinesAsDirty()}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this._markAllDefinesAsDirty())}isCompatible(e){switch(e){case 0:return!0;default:return!0}}constructor(e){super(e,"DepthSensing",222,new P6),this._isEnabled=!1,this._varColorName=e instanceof Ve?"finalColor":"color",this.doNotSerialize=!0,ga.push(this)}prepareDefines(e){e.DEPTH_SENSING=!!nn&&oo,e.DEPTH_SENSING_TEXTURE_ARRAY=(nn==null?void 0:nn.is2DArray)??!1,e.DEPTH_SENSING_TEXTURE_AL=Cm,e.DEPTH_SENSING_DISCARD=aN}getUniforms(){return{ubo:[{name:"ds_invScreenSize",size:2,type:"vec2"},{name:"ds_rawValueToMeters",size:1,type:"float"},{name:"ds_viewIndex",size:1,type:"float"},{name:"ds_shaderViewport",size:4,type:"vec4"},{name:"ds_uvTransform",size:16,type:"mat4"}],fragment:`#ifdef DEPTH_SENSING
                uniform vec2 ds_invScreenSize;
                uniform float ds_rawValueToMeters;
                uniform float ds_viewIndex;
                uniform vec4 ds_shaderViewport;
                uniform mat4 ds_uvTransform;
                #endif
                `}}getSamplers(e){e.push("ds_depthSampler")}bindForSubMesh(e){oo&&nn&&(e.updateFloat2("ds_invScreenSize",1/pu.width,1/pu.height),e.updateFloat("ds_rawValueToMeters",ym),e.updateFloat("ds_viewIndex",nN),e.updateFloat4("ds_shaderViewport",Bn.x,Bn.y,Bn.width,Bn.height),e.setTexture("ds_depthSampler",nn),e.updateMatrix("ds_uvTransform",Im))}getClassName(){return"DepthSensingMaterialPlugin"}getCustomCode(e){return e==="vertex"?{CUSTOM_VERTEX_MAIN_BEGIN:`
                #ifdef DEPTH_SENSING
                #ifdef MULTIVIEW
                    ds_viewIndexMultiview = float(gl_ViewID_OVR);
                #endif
                #endif
                `,CUSTOM_VERTEX_DEFINITIONS:`
                #ifdef DEPTH_SENSING
                #ifdef MULTIVIEW
                    varying float ds_viewIndexMultiview;
                #endif
                #endif
                `}:{CUSTOM_FRAGMENT_DEFINITIONS:`
                    #ifdef DEPTH_SENSING
                        #ifdef DEPTH_SENSING_TEXTURE_ARRAY
                            uniform highp sampler2DArray ds_depthSampler;
                        #else
                            uniform sampler2D ds_depthSampler;
                        #endif
                        #ifdef MULTIVIEW
                            varying float ds_viewIndexMultiview;
                        #endif
                    #endif
                  `,CUSTOM_FRAGMENT_MAIN_BEGIN:`
#ifdef DEPTH_SENSING
    #ifdef MULTIVIEW
        float ds_viewIndexSet = ds_viewIndexMultiview;
        vec2 ds_compensation = vec2(0.0, 0.0);
    #else
        float ds_viewIndexSet = ds_viewIndex;
        vec2 ds_compensation = vec2(ds_viewIndexSet, 0.0);
    #endif
    vec2 ds_baseUv = gl_FragCoord.xy * ds_invScreenSize;
    #ifdef DEPTH_SENSING_TEXTURE_ARRAY
        vec2 ds_uv = ds_baseUv - ds_compensation;
        vec3 ds_depthUv = vec3((ds_uvTransform * vec4(ds_uv, 0.0, 1.0)).xy, ds_viewIndexSet);
    #else
        vec2 ds_depthUv = (ds_uvTransform * vec4(ds_baseUv.x, 1.0 - ds_baseUv.y, 0.0, 1.0)).xy;
    #endif
    #ifdef DEPTH_SENSING_TEXTURE_AL
        // from alpha-luminance - taken from the explainer
        vec2 ds_alphaLuminance = texture(ds_depthSampler, ds_depthUv).ra;
        float ds_cameraDepth = dot(ds_alphaLuminance, vec2(255.0, 256.0 * 255.0));
    #else
        float ds_cameraDepth = texture(ds_depthSampler, ds_depthUv).r;
    #endif

    ds_cameraDepth = ds_cameraDepth * ds_rawValueToMeters;

    float ds_assetDepth = gl_FragCoord.z;
    #ifdef DEPTH_SENSING_DISCARD
    if(ds_cameraDepth < ds_assetDepth) {
        discard;
    }
    #endif
#endif  
                  `,CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR:`
#ifdef DEPTH_SENSING
    #ifndef DEPTH_SENSING_DISCARD
        const float ds_depthTolerancePerM = 0.005;
        float ds_occlusion = clamp(1.0 - 0.5 * (ds_cameraDepth - ds_assetDepth) / (ds_depthTolerancePerM * ds_assetDepth) +
            0.5, 0.0, 1.0);
        ${this._varColorName} *= (1.0 - ds_occlusion);
    #endif
#endif                  
                  `}}dispose(e){const t=ga.indexOf(this);t!==-1&&ga.splice(t,1),super.dispose(e)}}y("BABYLON.DepthSensingMaterialPlugin",oN);class Il extends pi{get width(){return this._width}get height(){return this._height}get rawValueToMeters(){return this._rawValueToMeters}get normDepthBufferFromNormView(){return this._normDepthBufferFromNormView}get depthUsage(){switch(this._xrSessionManager.session.depthUsage){case"cpu-optimized":return"cpu";case"gpu-optimized":return"gpu"}}get depthDataFormat(){switch(this._xrSessionManager.session.depthDataFormat){case"luminance-alpha":return"ushort";case"float32":return"float";case"unsigned-short":return"ushort"}}get latestInternalTexture(){return this._cachedWebGLTexture?this._getInternalTextureFromDepthInfo():null}get latestDepthBuffer(){return this._cachedDepthBuffer?this.depthDataFormat==="float"?new Float32Array(this._cachedDepthBuffer):new Uint16Array(this._cachedDepthBuffer):null}get latestDepthImageTexture(){return this._cachedDepthImageTexture}constructor(e,t){super(e),this.options=t,this._width=null,this._height=null,this._rawValueToMeters=null,this._textureType=null,this._normDepthBufferFromNormView=null,this._cachedDepthBuffer=null,this._cachedWebGLTexture=null,this._cachedDepthImageTexture=null,this._onCameraObserver=null,this.onGetDepthInMetersAvailable=new k,this.xrNativeFeatureName="depth-sensing",j.Warn("depth-sensing is an experimental and unstable feature."),aN=!t.useToleranceFactorForDepthSensing,TI("WebXRDepthSensingMaterialPlugin",i=>new oN(i))}attach(e){if(!super.attach(e)||this._xrSessionManager.session.depthDataFormat==null||this._xrSessionManager.session.depthUsage==null)return!1;if(this._glBinding=new XRWebGLBinding(this._xrSessionManager.session,this._xrSessionManager.scene.getEngine()._gl),oo=!this.options.disableDepthSensingOnMaterials,oo){for(const i of ga)i.isEnabled=!0;this._onCameraObserver=this._xrSessionManager.scene.onBeforeCameraRenderObservable.add(i=>{if(oo&&i.outputRenderTarget){const r=i.rigCameras.length>0?i.rigCameras[0].viewport:i.viewport;pu.width=i.outputRenderTarget.getRenderWidth()/(i.rigParent&&i.rigParent.rigCameras.length||1),pu.height=i.outputRenderTarget.getRenderHeight(),Bn.x=r.x,Bn.y=r.y,Bn.width=r.width,Bn.height=r.height,i.rigParent&&(nN=i.isLeftCamera?0:1)}})}return!0}detach(){oo=!1,nn=null,this._cachedWebGLTexture=null,this._cachedDepthBuffer=null;for(const e of ga)e.isEnabled=!1;return this._onCameraObserver&&this._xrSessionManager.scene.onBeforeCameraRenderObservable.remove(this._onCameraObserver),super.detach()}dispose(){var e;bI("WebXRDepthSensingMaterialPlugin"),(e=this._cachedDepthImageTexture)==null||e.dispose(),this.onGetDepthInMetersAvailable.clear(),this._onCameraObserver&&this._xrSessionManager.scene.onBeforeCameraRenderObservable.remove(this._onCameraObserver);for(const t of ga)t.dispose();ga.length=0}_onXRFrame(e){const t=this._xrSessionManager.referenceSpace,i=e.getViewerPose(t);if(i!=null)for(const r of i.views)switch(this.depthUsage){case"cpu":this._updateDepthInformationAndTextureCPUDepthUsage(e,r,this.depthDataFormat);break;case"gpu":if(!this._glBinding)break;this._updateDepthInformationAndTextureWebGLDepthUsage(this._glBinding,r,this.depthDataFormat);break;default:j.Error("Unknown depth usage"),this.detach();break}}_updateDepthInformationAndTextureCPUDepthUsage(e,t,i){const r=e.getDepthInformation(t);if(r===null)return;const{data:n,width:a,height:o,rawValueToMeters:l,getDepthInMeters:c,normDepthBufferFromNormView:u}=r;this._width=a,this._height=o,this._rawValueToMeters=l,this._cachedDepthBuffer=n,ym=l,Cm=i==="luminance-alpha",Im.fromArray(u.matrix),this.onGetDepthInMetersAvailable.notifyObservers(c.bind(r)),this._cachedDepthImageTexture||(this._cachedDepthImageTexture=gi.CreateRTexture(null,a,o,this._xrSessionManager.scene,!1,!1,$.NEAREST_SAMPLINGMODE,1),nn=this._cachedDepthImageTexture);let h=null;switch(i){case"ushort":case"luminance-alpha":h=Float32Array.from(new Uint16Array(n));break;case"float":h=new Float32Array(n);break}h&&(this.options.prepareTextureForVisualization&&(h=h.map(d=>d*l)),this._cachedDepthImageTexture.update(h))}_updateDepthInformationAndTextureWebGLDepthUsage(e,t,i){const r=e.getDepthInformation(t);if(r===null)return;const{texture:n,width:a,height:o,textureType:l,rawValueToMeters:c,normDepthBufferFromNormView:u}=r;if(ym=c,Cm=i==="luminance-alpha",Im.fromArray(u.matrix),this._cachedWebGLTexture)return;this._width=a,this._height=o,this._cachedWebGLTexture=n,this._textureType=l;const h=this._xrSessionManager.scene,d=this._getInternalTextureFromDepthInfo();this._cachedDepthImageTexture||(this._cachedDepthImageTexture=gi.CreateRTexture(null,a,o,h,!1,!0,$.NEAREST_SAMPLINGMODE,i==="float"?1:0)),this._cachedDepthImageTexture._texture=d,nn=this._cachedDepthImageTexture,this._xrSessionManager.scene.markAllMaterialsAsDirty(1)}async getXRSessionInitExtension(){const e=this.options.usagePreference!=null&&this.options.usagePreference.length!==0,t=this.options.dataFormatPreference!=null&&this.options.dataFormatPreference.length!==0;return await new Promise(i=>{if(e&&t){const r=this.options.usagePreference.map(a=>{switch(a){case"cpu":return"cpu-optimized";case"gpu":return"gpu-optimized"}}),n=this.options.dataFormatPreference.map(a=>{switch(a){case"luminance-alpha":return"luminance-alpha";case"float":return"float32";case"ushort":return"unsigned-short"}});i({depthSensing:{usagePreference:r,dataFormatPreference:n}})}else i({})})}_getInternalTextureFromDepthInfo(){const e=this._xrSessionManager.scene.getEngine(),t=this.depthDataFormat,i=this._textureType;if(!this._width||!this._height||!this._cachedWebGLTexture)throw new Error("Depth information is not available");const r=e.wrapWebGLTexture(this._cachedWebGLTexture,!1,1,this._width||256,this._height||256);return r.isCube=!1,r.invertY=!1,r._useSRGBBuffer=!1,r.format=t==="luminance-alpha"?2:5,r.generateMipMaps=!1,r.type=t==="float"?1:t==="ushort"?5:0,r._cachedWrapU=1,r._cachedWrapV=1,r._hardwareTexture=new Su(this._cachedWebGLTexture,e._gl),r.is2DArray=i==="texture-array",r}}Il.Name=Ne.DEPTH_SENSING;Il.Version=1;At.AddWebXRFeature(Il.Name,(s,e)=>()=>new Il(s,e),Il.Version,!1);const Iy="velocityPixelShader",O6=`precision highp float;
#define CUSTOM_FRAGMENT_BEGIN
varying vec4 clipPos;varying vec4 previousClipPos;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
highp vec4 motionVector=( clipPos/clipPos.w-previousClipPos/previousClipPos.w );gl_FragColor=motionVector;
#define CUSTOM_FRAGMENT_MAIN_END
}`;S.ShadersStore[Iy]||(S.ShadersStore[Iy]=O6);const Ry="velocityVertexShader",N6=`#define CUSTOM_VERTEX_BEGIN
#define VELOCITY
attribute vec3 position;
#include<instancesDeclaration>
uniform mat4 viewProjection;uniform mat4 previousViewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;uniform mat4 previousViewProjectionR;
#endif
varying vec4 clipPos;varying vec4 previousClipPos;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#include<instancesVertex>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);vec4 previousWorldPos=finalPreviousWorld*vec4(positionUpdated,1.0);
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {clipPos=viewProjection*worldPos;previousClipPos=previousViewProjection*previousWorldPos;gl_Position=clipPos;} else {clipPos=viewProjectionR*worldPos;previousClipPos=previousViewProjectionR*previousWorldPos;gl_Position=clipPos;}
#elif
clipPos=viewProjection*worldPos;previousClipPos=previousViewProjection*previousWorldPos;gl_Position=clipPos;
#endif
#define CUSTOM_VERTEX_MAIN_END
}`;S.ShadersStore[Ry]||(S.ShadersStore[Ry]=N6);class D6 extends Zi{constructor(e,t,i,r=512){super("spacewarp rtt",r,i,!1,!0,2,!1,void 0,!1,!1,!0,void 0,!0),this._originalPairing=[],this._previousWorldMatrices=[],this._previousTransforms=[z.Identity(),z.Identity()],this._renderTarget=this.getScene().getEngine().createMultiviewRenderTargetTexture(this.getRenderWidth(),this.getRenderHeight(),e,t),this._renderTarget._disposeOnlyFramebuffers=!0,this._texture=this._renderTarget.texture,this._texture.isMultiview=!0,this._texture.format=5,i&&(this._velocityMaterial=new Ta("velocity shader material",i,{vertex:"velocity",fragment:"velocity"},{uniforms:["world","previousWorld","viewProjection","viewProjectionR","previousViewProjection","previousViewProjectionR"]}),this._velocityMaterial._materialHelperNeedsPreviousMatrices=!0,this._velocityMaterial.onBindObservable.add(n=>{this._previousWorldMatrices[n.uniqueId]=this._previousWorldMatrices[n.uniqueId]||n.getWorldMatrix(),this._velocityMaterial.getEffect().setMatrix("previousWorld",this._previousWorldMatrices[n.uniqueId]),this._previousWorldMatrices[n.uniqueId]=n.getWorldMatrix(),this._velocityMaterial.getEffect().setMatrix("previousViewProjection",this._previousTransforms[0]),this._velocityMaterial.getEffect().setMatrix("previousViewProjectionR",this._previousTransforms[1]),this._previousTransforms[0].copyFrom(i.getTransformMatrix()),this._previousTransforms[1].copyFrom(i._transformMatrixR)}),this._velocityMaterial.freeze())}render(e=!1,t=!1){this._originalPairing.length=0;const i=this.getScene();i&&this._velocityMaterial&&i.getActiveMeshes().forEach(r=>{this._originalPairing.push([r,r.material]),r.material=this._velocityMaterial}),super.render(e,t);for(const r of this._originalPairing)r[0].material=r[1]}_bindFrameBuffer(){this._renderTarget&&this.getScene().getEngine().bindSpaceWarpFramebuffer(this._renderTarget)}getViewCount(){return 2}dispose(){super.dispose(),this._velocityMaterial.dispose(),this._previousTransforms.length=0,this._previousWorldMatrices.length=0,this._originalPairing.length=0}}class M6{constructor(e,t,i){this._scene=e,this._xrSessionManager=t,this._xrWebGLBinding=i,this._lastSubImages=new Map,this._renderTargetTextures=new Map,this._engine=e.getEngine()}_getSubImageForView(e){const t=this._xrSessionManager._getBaseLayerWrapper();if(!t)throw new Error("For Space Warp, the base layer should be a WebXR Projection Layer.");if(t.layerType!=="XRProjectionLayer")throw new Error('For Space Warp, the base layer type should "XRProjectionLayer".');const i=t.layer;return this._xrWebGLBinding.getViewSubImage(i,e)}_setViewportForSubImage(e,t){e.x=0,e.y=0,e.width=t.motionVectorTextureWidth,e.height=t.motionVectorTextureHeight}_createRenderTargetTexture(e,t,i,r,n){if(!this._engine)throw new Error("Engine is disposed");const a={width:e,height:t},o=new D6(r,n,this._scene,a),l=o.renderTarget;return i&&(l._framebuffer=i),l._colorTextureArray=r,l._depthStencilTextureArray=n,o.disableRescaling(),o.renderListPredicate=()=>!0,o}_getRenderTargetForSubImage(e,t){const i=this._lastSubImages.get(t);let r=this._renderTargetTextures.get(t.eye);const n=e.motionVectorTextureWidth,a=e.motionVectorTextureHeight;return(!r||(i==null?void 0:i.textureWidth)!==n||(i==null?void 0:i.textureHeight)!=a)&&(r=this._createRenderTargetTexture(n,a,null,e.motionVectorTexture,e.depthStencilTexture),this._renderTargetTextures.set(t.eye,r),this._framebufferDimensions={framebufferWidth:n,framebufferHeight:a}),this._lastSubImages.set(t,e),r}trySetViewportForView(e,t){const i=this._lastSubImages.get(t)||this._getSubImageForView(t);return i?(this._setViewportForSubImage(e,i),!0):!1}accessMotionVector(e){const t=this._getSubImageForView(e);t&&(t.motionVectorTexture,t.depthStencilTexture)}getRenderTargetTextureForEye(e){return null}getRenderTargetTextureForView(e){const t=this._getSubImageForView(e);return t?this._getRenderTargetForSubImage(t,e):null}dispose(){this._renderTargetTextures.forEach(e=>e.dispose()),this._renderTargetTextures.clear()}}class Rl extends pi{constructor(e){super(e),this._onAfterRenderObserver=null,this.dependsOn=[Ne.LAYERS],this.xrNativeFeatureName="space-warp",this._xrSessionManager.scene.needsPreviousWorldMatrices=!0}attach(){if(!super.attach())return!1;const e=this._xrSessionManager.scene.getEngine();return this._glContext=e._gl,this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,this._glContext),this.spaceWarpRTTProvider=new M6(this._xrSessionManager.scene,this._xrSessionManager,this._xrWebGLBinding),this._onAfterRenderObserver=this._xrSessionManager.scene.onAfterRenderObservable.add(()=>this._onAfterRender()),!0}detach(){return this._xrSessionManager.scene.onAfterRenderObservable.remove(this._onAfterRenderObserver),super.detach()}_onAfterRender(){this.attached&&this._renderTargetTexture&&this._renderTargetTexture.render(!1,!1)}isCompatible(){return this._xrSessionManager.scene.getEngine().getCaps().colorBufferHalfFloat||!1}dispose(){super.dispose()}_onXRFrame(e){const t=e.getViewerPose(this._xrSessionManager.referenceSpace);if(!t)return;const i=t.views[0];this._renderTargetTexture=this._renderTargetTexture||this.spaceWarpRTTProvider.getRenderTargetTextureForView(i),this.spaceWarpRTTProvider.accessMotionVector(i)}}Rl.Name=Ne.SPACE_WARP;Rl.Version=1;At.AddWebXRFeature(Rl.Name,s=>()=>new Rl(s),Rl.Version,!1);class Al extends pi{constructor(e,t={}){super(e),this.options=t,this._cachedInternalTextures=[],this.texturesData=[],this.viewIndex=[],this.cameraIntrinsics=[],this.onTexturesUpdatedObservable=new k,this.xrNativeFeatureName="camera-access"}attach(e){return super.attach(e)?(this._glContext=this._xrSessionManager.scene.getEngine()._gl,this._glBinding=new XRWebGLBinding(this._xrSessionManager.session,this._glContext),!0):!1}detach(){if(!super.detach())return!1;if(this._glBinding=void 0,!this.options.doNotDisposeOnDetach){for(const e of this._cachedInternalTextures)e.dispose();for(const e of this.texturesData)e.dispose();this._cachedInternalTextures.length=0,this.texturesData.length=0,this.cameraIntrinsics.length=0}return!0}dispose(){super.dispose(),this.onTexturesUpdatedObservable.clear()}_updateCameraIntrinsics(e,t){const i={width:e.camera.width,height:e.camera.height,x:0,y:0},r=e.projectionMatrix,n=(1-r[8])*i.width/2+i.x,a=(1-r[9])*i.height/2+i.y,o=i.width/2*r[0],l=i.height/2*r[5],c=i.width/2*r[4];this.cameraIntrinsics[t]={u0:n,v0:a,ax:o,ay:l,gamma:c,width:i.width,height:i.height,viewportX:i.x,viewportY:i.y}}_updateInternalTextures(e,t=0){var r,n;if(!e.camera)return!1;this.viewIndex[t]=e.eye;const i=(r=this._glBinding)==null?void 0:r.getCameraImage(e.camera);if(this._cachedInternalTextures[t])(n=this._cachedInternalTextures[t]._hardwareTexture)==null||n.set(i);else{const a=new $t(this._xrSessionManager.scene.getEngine(),0,!0);a.invertY=!1,a.format=5,a.generateMipMaps=!0,a.type=0,a.samplingMode=3,a.width=e.camera.width,a.height=e.camera.height,a._cachedWrapU=1,a._cachedWrapV=1,a._hardwareTexture=new Su(i,this._glContext),this._cachedInternalTextures[t]=a;const o=new ps(this._xrSessionManager.scene);o.name=`WebXR Raw Camera Access (${t})`,o._texture=this._cachedInternalTextures[t],this.texturesData[t]=o,this._updateCameraIntrinsics(e,t)}return this._cachedInternalTextures[t].isReady=!0,!0}_onXRFrame(e){const t=this._xrSessionManager.referenceSpace,i=e.getViewerPose(t);if(!i||!i.views)return;let r=!0;for(let n=0;n<i.views.length;n++){const a=i.views[n];r=r&&this._updateInternalTextures(a,n)}r&&this.onTexturesUpdatedObservable.notifyObservers(this.texturesData)}}Al.Name=Ne.RAW_CAMERA_ACCESS;Al.Version=1;At.AddWebXRFeature(Al.Name,(s,e)=>()=>new Al(s,e),Al.Version,!1);class F6 extends Ua{constructor(e,t,i){super(e,L6[i],t,i,!0),this.profileId="generic-hand-select-grasp"}_getFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){}_setRootMesh(e){}_updateModel(){}}ti.RegisterController("generic-hand-select-grasp",(s,e)=>new F6(e,s.gamepad,s.handedness));const L6={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-none",assetPath:"none.glb"}};class zn extends Ua{constructor(e,t,i){super(e,w6["left-right"],t,i),this._mapping={defaultButton:{valueNodeName:"VALUE",unpressedNodeName:"UNPRESSED",pressedNodeName:"PRESSED"},defaultAxis:{valueNodeName:"VALUE",minNodeName:"MIN",maxNodeName:"MAX"},buttons:{"xr-standard-trigger":{rootNodeName:"SELECT",componentProperty:"button",states:["default","touched","pressed"]},"xr-standard-squeeze":{rootNodeName:"GRASP",componentProperty:"state",states:["pressed"]},"xr-standard-touchpad":{rootNodeName:"TOUCHPAD_PRESS",labelAnchorNodeName:"squeeze-label",touchPointNodeName:"TOUCH"},"xr-standard-thumbstick":{rootNodeName:"THUMBSTICK_PRESS",componentProperty:"state",states:["pressed"]}},axes:{"xr-standard-touchpad":{"x-axis":{rootNodeName:"TOUCHPAD_TOUCH_X"},"y-axis":{rootNodeName:"TOUCHPAD_TOUCH_Y"}},"xr-standard-thumbstick":{"x-axis":{rootNodeName:"THUMBSTICK_X"},"y-axis":{rootNodeName:"THUMBSTICK_Y"}}}},this.profileId="microsoft-mixed-reality"}_getFilenameAndPath(){let e="";this.handedness==="left"?e=zn.MODEL_LEFT_FILENAME:e=zn.MODEL_RIGHT_FILENAME;const t="default",i=zn.MODEL_BASE_URL+t+"/";return{filename:e,path:i}}_getModelLoadingConstraints(){const e=Nl.IsPluginForExtensionAvailable(".glb");return e||N.Warn("glTF / glb loaded was not registered, using generic controller instead"),e}_processLoadedModel(e){if(!this.rootMesh)return;const t=this.getComponentIds();for(let i=0;i<t.length;i++){const r=t[i];if(!this.disableAnimation&&r&&this.rootMesh){const n=this._mapping.buttons[r],a=n.rootNodeName;if(!a){N.Log("Skipping unknown button at index: "+i+" with mapped name: "+r);continue}const o=this._getChildByName(this.rootMesh,a);if(!o){N.Warn("Missing button mesh with name: "+a);continue}if(n.valueMesh=this._getImmediateChildByName(o,this._mapping.defaultButton.valueNodeName),n.pressedMesh=this._getImmediateChildByName(o,this._mapping.defaultButton.pressedNodeName),n.unpressedMesh=this._getImmediateChildByName(o,this._mapping.defaultButton.unpressedNodeName),n.valueMesh&&n.pressedMesh&&n.unpressedMesh){const l=this.getComponent(r);l&&l.onButtonStateChangedObservable.add(c=>{this._lerpTransform(n,c.value)},void 0,!0)}else N.Warn("Missing button submesh under mesh with name: "+a)}}for(const i of t){const r=this.getComponent(i);if(!r.isAxes())continue;const n=["x-axis","y-axis"];for(const a of n){if(!this.rootMesh)continue;const o=this._mapping.axes[i][a],l=this._getChildByName(this.rootMesh,o.rootNodeName);if(!l){N.Warn("Missing axis mesh with name: "+o.rootNodeName);continue}o.valueMesh=this._getImmediateChildByName(l,this._mapping.defaultAxis.valueNodeName),o.minMesh=this._getImmediateChildByName(l,this._mapping.defaultAxis.minNodeName),o.maxMesh=this._getImmediateChildByName(l,this._mapping.defaultAxis.maxNodeName),o.valueMesh&&o.minMesh&&o.maxMesh?r&&r.onAxisValueChangedObservable.add(c=>{const u=a==="x-axis"?c.x:c.y;this._lerpTransform(o,u,!0)},void 0,!0):N.Warn("Missing axis submesh under mesh with name: "+o.rootNodeName)}}}_setRootMesh(e){this.rootMesh=new Oe(this.profileId+" "+this.handedness,this.scene),this.rootMesh.isPickable=!1;let t;for(let i=0;i<e.length;i++){const r=e[i];r.isPickable=!1,r.parent||(t=r)}t&&t.setParent(this.rootMesh),this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=Z.FromEulerAngles(0,Math.PI,0))}_updateModel(){}}zn.MODEL_BASE_URL="https://controllers.babylonjs.com/microsoft/";zn.MODEL_LEFT_FILENAME="left.glb";zn.MODEL_RIGHT_FILENAME="right.glb";ti.RegisterController("windows-mixed-reality",(s,e)=>new zn(e,s.gamepad,s.handedness));const w6={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{xr_standard_trigger_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_trigger_pressed_value",minNodeName:"xr_standard_trigger_pressed_min",maxNodeName:"xr_standard_trigger_pressed_max"}}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{xr_standard_squeeze_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_squeeze_pressed_value",minNodeName:"xr_standard_squeeze_pressed_min",maxNodeName:"xr_standard_squeeze_pressed_max"}}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{xr_standard_touchpad_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_pressed_value",minNodeName:"xr_standard_touchpad_pressed_min",maxNodeName:"xr_standard_touchpad_pressed_max"},xr_standard_touchpad_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_pressed_value",minNodeName:"xr_standard_touchpad_xaxis_pressed_min",maxNodeName:"xr_standard_touchpad_xaxis_pressed_max"},xr_standard_touchpad_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_pressed_value",minNodeName:"xr_standard_touchpad_yaxis_pressed_min",maxNodeName:"xr_standard_touchpad_yaxis_pressed_max"},xr_standard_touchpad_xaxis_touched:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_touched_value",minNodeName:"xr_standard_touchpad_xaxis_touched_min",maxNodeName:"xr_standard_touchpad_xaxis_touched_max"},xr_standard_touchpad_yaxis_touched:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_touched_value",minNodeName:"xr_standard_touchpad_yaxis_touched_min",maxNodeName:"xr_standard_touchpad_yaxis_touched_max"},xr_standard_touchpad_axes_touched:{componentProperty:"state",states:["touched","pressed"],valueNodeProperty:"visibility",valueNodeName:"xr_standard_touchpad_axes_touched_value"}},touchPointNodeName:"xr_standard_touchpad_axes_touched_value"},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{xr_standard_thumbstick_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_pressed_value",minNodeName:"xr_standard_thumbstick_pressed_min",maxNodeName:"xr_standard_thumbstick_pressed_max"},xr_standard_thumbstick_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_xaxis_pressed_value",minNodeName:"xr_standard_thumbstick_xaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_xaxis_pressed_max"},xr_standard_thumbstick_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_yaxis_pressed_value",minNodeName:"xr_standard_thumbstick_yaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_yaxis_pressed_max"}}}},gamepadMapping:"xr-standard",rootNodeName:"microsoft-mixed-reality-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{xr_standard_trigger_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_trigger_pressed_value",minNodeName:"xr_standard_trigger_pressed_min",maxNodeName:"xr_standard_trigger_pressed_max"}}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{xr_standard_squeeze_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_squeeze_pressed_value",minNodeName:"xr_standard_squeeze_pressed_min",maxNodeName:"xr_standard_squeeze_pressed_max"}}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{xr_standard_touchpad_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_pressed_value",minNodeName:"xr_standard_touchpad_pressed_min",maxNodeName:"xr_standard_touchpad_pressed_max"},xr_standard_touchpad_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_pressed_value",minNodeName:"xr_standard_touchpad_xaxis_pressed_min",maxNodeName:"xr_standard_touchpad_xaxis_pressed_max"},xr_standard_touchpad_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_pressed_value",minNodeName:"xr_standard_touchpad_yaxis_pressed_min",maxNodeName:"xr_standard_touchpad_yaxis_pressed_max"},xr_standard_touchpad_xaxis_touched:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_touched_value",minNodeName:"xr_standard_touchpad_xaxis_touched_min",maxNodeName:"xr_standard_touchpad_xaxis_touched_max"},xr_standard_touchpad_yaxis_touched:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_touched_value",minNodeName:"xr_standard_touchpad_yaxis_touched_min",maxNodeName:"xr_standard_touchpad_yaxis_touched_max"},xr_standard_touchpad_axes_touched:{componentProperty:"state",states:["touched","pressed"],valueNodeProperty:"visibility",valueNodeName:"xr_standard_touchpad_axes_touched_value"}},touchPointNodeName:"xr_standard_touchpad_axes_touched_value"},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{xr_standard_thumbstick_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_pressed_value",minNodeName:"xr_standard_thumbstick_pressed_min",maxNodeName:"xr_standard_thumbstick_pressed_max"},xr_standard_thumbstick_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_xaxis_pressed_value",minNodeName:"xr_standard_thumbstick_xaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_xaxis_pressed_max"},xr_standard_thumbstick_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_yaxis_pressed_value",minNodeName:"xr_standard_thumbstick_yaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_yaxis_pressed_max"}}}},gamepadMapping:"xr-standard",rootNodeName:"microsoft-mixed-reality-right",assetPath:"right.glb"}};class fs extends Ua{constructor(e,t,i,r=!1,n=!1){super(e,B6[i],t,i),this._forceLegacyControllers=n,this.profileId="oculus-touch"}_getFilenameAndPath(){let e="";this.handedness==="left"?e=fs.MODEL_LEFT_FILENAME:e=fs.MODEL_RIGHT_FILENAME;const t=this._isQuest()?fs.QUEST_MODEL_BASE_URL:fs.MODEL_BASE_URL;return{filename:e,path:t}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){const t=this._isQuest(),i=this.handedness==="right"?-1:1,r=this.getComponentIds();for(const n of r){const a=n&&this.getComponent(n);a&&a.onButtonStateChangedObservable.add(o=>{if(!(!this.rootMesh||this.disableAnimation))switch(n){case"xr-standard-trigger":t||(this._modelRootNode.getChildren()[3].rotation.x=-o.value*.2,this._modelRootNode.getChildren()[3].position.y=-o.value*.005,this._modelRootNode.getChildren()[3].position.z=-o.value*.005);return;case"xr-standard-squeeze":t||(this._modelRootNode.getChildren()[4].position.x=i*o.value*.0035);return;case"xr-standard-thumbstick":return;case"a-button":case"x-button":t||(o.pressed?this._modelRootNode.getChildren()[1].position.y=-.001:this._modelRootNode.getChildren()[1].position.y=0);return;case"b-button":case"y-button":t||(o.pressed?this._modelRootNode.getChildren()[2].position.y=-.001:this._modelRootNode.getChildren()[2].position.y=0);return}},void 0,!0)}}_setRootMesh(e){this.rootMesh=new Oe(this.profileId+" "+this.handedness,this.scene),this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=Z.FromEulerAngles(0,Math.PI,0));for(const t of e)t.isPickable=!1;this._isQuest()?this._modelRootNode=e[0]:(this._modelRootNode=e[1],this.rootMesh.position.y=.034,this.rootMesh.position.z=.052),this._modelRootNode.parent=this.rootMesh}_updateModel(){}_isQuest(){return!!navigator.userAgent.match(/Quest/gi)&&!this._forceLegacyControllers}}fs.MODEL_BASE_URL="https://controllers.babylonjs.com/oculus/";fs.MODEL_LEFT_FILENAME="left.babylon";fs.MODEL_RIGHT_FILENAME="right.babylon";fs.QUEST_MODEL_BASE_URL="https://controllers.babylonjs.com/oculusQuest/";ti.RegisterController("oculus-touch",(s,e)=>new fs(e,s.gamepad,s.handedness));ti.RegisterController("oculus-touch-legacy",(s,e)=>new fs(e,s.gamepad,s.handedness,!0));const B6={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{}},"x-button":{type:"button",gamepadIndices:{button:4},rootNodeName:"x_button",visualResponses:{}},"y-button":{type:"button",gamepadIndices:{button:5},rootNodeName:"y_button",visualResponses:{}},thumbrest:{type:"button",gamepadIndices:{button:6},rootNodeName:"thumbrest",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-touch-v2-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{}},"a-button":{type:"button",gamepadIndices:{button:4},rootNodeName:"a_button",visualResponses:{}},"b-button":{type:"button",gamepadIndices:{button:5},rootNodeName:"b_button",visualResponses:{}},thumbrest:{type:"button",gamepadIndices:{button:6},rootNodeName:"thumbrest",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-touch-v2-right",assetPath:"right.glb"}};class V6 extends Ua{constructor(e,t,i){super(e,U6[i],t,i,!0),this.profileId="oculus-hand"}_getFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){}_setRootMesh(e){}_updateModel(){}}ti.RegisterController("oculus-hand",(s,e)=>new V6(e,s.gamepad,s.handedness));const U6={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}},"swipe-left":{type:"button",gamepadIndices:{button:5},rootNodeName:"swipe-left",visualResponses:{}},"swipe-right":{type:"button",gamepadIndices:{button:6},rootNodeName:"swipe-right",visualResponses:{}},"swipe-forward":{type:"button",gamepadIndices:{button:7},rootNodeName:"swipe-forward",visualResponses:{}},"swipe-backward":{type:"button",gamepadIndices:{button:8},rootNodeName:"swipe-backward",visualResponses:{}},"tap-thumb":{type:"button",gamepadIndices:{button:9},rootNodeName:"tap-thumb",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-hand-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},"swipe-left":{type:"button",gamepadIndices:{button:5},rootNodeName:"swipe-left",visualResponses:{}},"swipe-right":{type:"button",gamepadIndices:{button:6},rootNodeName:"swipe-right",visualResponses:{}},"swipe-forward":{type:"button",gamepadIndices:{button:7},rootNodeName:"swipe-forward",visualResponses:{}},"swipe-backward":{type:"button",gamepadIndices:{button:8},rootNodeName:"swipe-backward",visualResponses:{}},"tap-thumb":{type:"button",gamepadIndices:{button:9},rootNodeName:"tap-thumb",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-hand-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}},"swipe-left":{type:"button",gamepadIndices:{button:5},rootNodeName:"swipe-left",visualResponses:{}},"swipe-right":{type:"button",gamepadIndices:{button:6},rootNodeName:"swipe-right",visualResponses:{}},"swipe-forward":{type:"button",gamepadIndices:{button:7},rootNodeName:"swipe-forward",visualResponses:{}},"swipe-backward":{type:"button",gamepadIndices:{button:8},rootNodeName:"swipe-backward",visualResponses:{}},"tap-thumb":{type:"button",gamepadIndices:{button:9},rootNodeName:"tap-thumb",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-hand-none",assetPath:"none.glb"}};class Do extends Ua{constructor(e,t,i){super(e,k6[i],t,i),this.profileId="htc-vive"}_getFilenameAndPath(){const e=Do.MODEL_FILENAME,t=Do.MODEL_BASE_URL;return{filename:e,path:t}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){const t=this.getComponentIds();for(const i of t){const r=i&&this.getComponent(i);r&&r.onButtonStateChangedObservable.add(n=>{if(!(!this.rootMesh||this.disableAnimation))switch(i){case"xr-standard-trigger":this._modelRootNode.getChildren()[6].rotation.x=-n.value*.15;return;case"xr-standard-touchpad":return;case"xr-standard-squeeze":return}},void 0,!0)}}_setRootMesh(e){this.rootMesh=new Oe(this.profileId+" "+this.handedness,this.scene);for(const t of e)t.isPickable=!1;this._modelRootNode=e[1],this._modelRootNode.parent=this.rootMesh,this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=Z.FromEulerAngles(0,Math.PI,0))}_updateModel(){}}Do.MODEL_BASE_URL="https://controllers.babylonjs.com/vive/";Do.MODEL_FILENAME="wand.babylon";ti.RegisterController("htc-vive",(s,e)=>new Do(e,s.gamepad,s.handedness));const k6={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc_vive_none",assetPath:"none.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc_vive_none",assetPath:"none.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc-vive-none",assetPath:"none.glb"}};class G6{get session(){return this._nativeImpl.session}constructor(e){this._nativeImpl=e,this._xrTransform=new XRRigidTransform,this._xrPose={transform:this._xrTransform,emulatedPosition:!1},this._xrPoseVectorData=new Float32Array(4+4),this.fillPoses=this._nativeImpl.fillPoses.bind(this._nativeImpl),this.getViewerPose=this._nativeImpl.getViewerPose.bind(this._nativeImpl),this.getHitTestResults=this._nativeImpl.getHitTestResults.bind(this._nativeImpl),this.getHitTestResultsForTransientInput=()=>{throw new Error("XRFrame.getHitTestResultsForTransientInput not supported on native.")},this.createAnchor=this._nativeImpl.createAnchor.bind(this._nativeImpl),this.getJointPose=this._nativeImpl.getJointPose.bind(this._nativeImpl),this.fillJointRadii=this._nativeImpl.fillJointRadii.bind(this._nativeImpl),this.getLightEstimate=()=>{throw new Error("XRFrame.getLightEstimate not supported on native.")},this.getImageTrackingResults=()=>this._nativeImpl._imageTrackingResults??[]}getPose(e,t){if(!this._nativeImpl.getPoseData(e,t,this._xrPoseVectorData.buffer,this._xrTransform.matrix.buffer))return;const i=this._xrTransform.position;i.x=this._xrPoseVectorData[0],i.y=this._xrPoseVectorData[1],i.z=this._xrPoseVectorData[2],i.w=this._xrPoseVectorData[3];const r=this._xrTransform.orientation;return r.x=this._xrPoseVectorData[4],r.y=this._xrPoseVectorData[5],r.z=this._xrPoseVectorData[6],r.w=this._xrPoseVectorData[7],this._xrPose}get trackedAnchors(){return this._nativeImpl.trackedAnchors}get worldInformation(){return this._nativeImpl.worldInformation}get detectedPlanes(){return this._nativeImpl.detectedPlanes}get featurePointCloud(){return this._nativeImpl.featurePointCloud}getDepthInformation(e){throw new Error("This function is not available in Babylon Native")}}sw("NativeXRFrame",G6);const Ay="sceneFragmentDeclaration",z6=`uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
uniform mat4 view;uniform mat4 projection;uniform vec4 vEyePosition;
`;S.IncludesShadersStore[Ay]||(S.IncludesShadersStore[Ay]=z6);class W6{constructor(e){Hr(this,"scene");Hr(this,"root");Hr(this,"body");Hr(this,"mat");this.scene=e,this.root=new Es("previewRoot",this.scene),this.body=yI.CreateCapsule("previewBody",{height:1.8,radius:.35},this.scene),this.body.position=new x(0,.9,0),this.body.parent=this.root,this.mat=new Lr("previewMat",this.scene),this.mat.diffuseColor=new q(.4,.6,.9),this.body.material=this.mat}setClass(e){e.includes("sentinel")?this.mat.diffuseColor=new q(.8,.3,.3):e.includes("huntress")&&(this.mat.diffuseColor=new q(.3,.5,.9))}setAscendancy(e){e.includes("warden")?this.mat.emissiveColor=new q(.2,.2,.2):e.includes("champion")?this.mat.emissiveColor=new q(.15,.05,.05):e.includes("pathfinder")?this.mat.emissiveColor=new q(.05,.15,.05):e.includes("marksman")&&(this.mat.emissiveColor=new q(.05,.05,.15))}setAppearance(e){if(e.pose){const t=e.pose==="a"?.2:-.2;this.root.rotation.y=t}e.tint&&(this.mat.specularColor=e.tint==="a"?new q(.3,.3,.3):new q(.1,.1,.1))}dispose(){this.body.dispose(),this.root.dispose()}}class H6{constructor(e,t){Hr(this,"scene");Hr(this,"camera");Hr(this,"avatar");Hr(this,"disposables",[]);Hr(this,"previousCamera",null);Sg("CharacterCreationScene created");const i=window.__gameScene;this.scene=i??new le(e),this.scene.clearColor=new Te(.03,.03,.05,1),this.previousCamera=this.scene.activeCamera,this.camera=new wo("creatorCam",Math.PI/4,.8,6,new x(0,1,0),this.scene),this.camera.lowerRadiusLimit=4,this.camera.upperRadiusLimit=8,this.scene.activeCamera=this.camera;const r=new Lm("hemi",new x(0,1,0),this.scene);r.intensity=.5;const n=new ar("spot",new x(2,4,-2),new x(-.3,-1,.2),Math.PI/3,2,this.scene);n.intensity=1.2,this.disposables.push(r),this.disposables.push(n);const a=yI.CreateGround("creatorGround",{width:8,height:8},this.scene);this.disposables.push(a),this.avatar=new W6(this.scene),this.scene._isCreator=!0}setClass(e){this.avatar.setClass(e)}setAscendancy(e){this.avatar.setAscendancy(e)}setAppearance(e){this.avatar.setAppearance(e)}dispose(){Sg("CharacterCreationScene disposed"),this.avatar.dispose();for(const e of this.disposables)try{e.dispose()}catch{}this.disposables=[],this.previousCamera&&(this.scene.activeCamera=this.previousCamera),window.__gameScene||this.scene.dispose()}}function ee(s,e,t){function i(o,l){var c;Object.defineProperty(o,"_zod",{value:o._zod??{},enumerable:!1}),(c=o._zod).traits??(c.traits=new Set),o._zod.traits.add(s),e(o,l);for(const u in a.prototype)u in o||Object.defineProperty(o,u,{value:a.prototype[u].bind(o)});o._zod.constr=a,o._zod.def=l}const r=(t==null?void 0:t.Parent)??Object;class n extends r{}Object.defineProperty(n,"name",{value:s});function a(o){var l;const c=t!=null&&t.Parent?new n:this;i(c,o),(l=c._zod).deferred??(l.deferred=[]);for(const u of c._zod.deferred)u();return c}return Object.defineProperty(a,"init",{value:i}),Object.defineProperty(a,Symbol.hasInstance,{value:o=>{var l,c;return t!=null&&t.Parent&&o instanceof t.Parent?!0:(c=(l=o==null?void 0:o._zod)==null?void 0:l.traits)==null?void 0:c.has(s)}}),Object.defineProperty(a,"name",{value:s}),a}class _o extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}class lN extends Error{constructor(e){super(`Encountered unidirectional transform during encode: ${e}`),this.name="ZodEncodeError"}}const Rm={};function Pa(s){return s&&Object.assign(Rm,s),Rm}function $6(s){const e=Object.values(s).filter(i=>typeof i=="number");return Object.entries(s).filter(([i,r])=>e.indexOf(+i)===-1).map(([i,r])=>r)}function Am(s,e){return typeof e=="bigint"?e.toString():e}function sg(s){return{get value(){{const e=s();return Object.defineProperty(this,"value",{value:e}),e}}}}function ng(s){return s==null}function ag(s){const e=s.startsWith("^")?1:0,t=s.endsWith("$")?s.length-1:s.length;return s.slice(e,t)}function X6(s,e){const t=(s.toString().split(".")[1]||"").length,i=e.toString();let r=(i.split(".")[1]||"").length;if(r===0&&/\d?e-\d?/.test(i)){const l=i.match(/\d?e-(\d?)/);l!=null&&l[1]&&(r=Number.parseInt(l[1]))}const n=t>r?t:r,a=Number.parseInt(s.toFixed(n).replace(".","")),o=Number.parseInt(e.toFixed(n).replace(".",""));return a%o/10**n}const Py=Symbol("evaluating");function kt(s,e,t){let i;Object.defineProperty(s,e,{get(){if(i!==Py)return i===void 0&&(i=Py,i=t()),i},set(r){Object.defineProperty(s,e,{value:r})},configurable:!0})}function $a(s,e,t){Object.defineProperty(s,e,{value:t,writable:!0,enumerable:!0,configurable:!0})}function Xa(...s){const e={};for(const t of s){const i=Object.getOwnPropertyDescriptors(t);Object.assign(e,i)}return Object.defineProperties({},e)}function Oy(s){return JSON.stringify(s)}const cN="captureStackTrace"in Error?Error.captureStackTrace:(...s)=>{};function mu(s){return typeof s=="object"&&s!==null&&!Array.isArray(s)}const Y6=sg(()=>{var s;if(typeof navigator<"u"&&((s=navigator==null?void 0:navigator.userAgent)!=null&&s.includes("Cloudflare")))return!1;try{const e=Function;return new e(""),!0}catch{return!1}});function $l(s){if(mu(s)===!1)return!1;const e=s.constructor;if(e===void 0)return!0;const t=e.prototype;return!(mu(t)===!1||Object.prototype.hasOwnProperty.call(t,"isPrototypeOf")===!1)}function uN(s){return $l(s)?{...s}:Array.isArray(s)?[...s]:s}const j6=new Set(["string","number","symbol"]);function Mo(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function ea(s,e,t){const i=new s._zod.constr(e??s._zod.def);return(!e||t!=null&&t.parent)&&(i._zod.parent=s),i}function Pe(s){const e=s;if(!e)return{};if(typeof e=="string")return{error:()=>e};if((e==null?void 0:e.message)!==void 0){if((e==null?void 0:e.error)!==void 0)throw new Error("Cannot specify both `message` and `error` params");e.error=e.message}return delete e.message,typeof e.error=="string"?{...e,error:()=>e.error}:e}function q6(s){return Object.keys(s).filter(e=>s[e]._zod.optin==="optional"&&s[e]._zod.optout==="optional")}const Z6={safeint:[Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],int32:[-2147483648,2147483647],uint32:[0,4294967295],float32:[-34028234663852886e22,34028234663852886e22],float64:[-Number.MAX_VALUE,Number.MAX_VALUE]};function Q6(s,e){const t=s._zod.def,i=Xa(s._zod.def,{get shape(){const r={};for(const n in e){if(!(n in t.shape))throw new Error(`Unrecognized key: "${n}"`);e[n]&&(r[n]=t.shape[n])}return $a(this,"shape",r),r},checks:[]});return ea(s,i)}function K6(s,e){const t=s._zod.def,i=Xa(s._zod.def,{get shape(){const r={...s._zod.def.shape};for(const n in e){if(!(n in t.shape))throw new Error(`Unrecognized key: "${n}"`);e[n]&&delete r[n]}return $a(this,"shape",r),r},checks:[]});return ea(s,i)}function J6(s,e){if(!$l(e))throw new Error("Invalid input to extend: expected a plain object");const t=s._zod.def.checks;if(t&&t.length>0)throw new Error("Object schemas containing refinements cannot be extended. Use `.safeExtend()` instead.");const r=Xa(s._zod.def,{get shape(){const n={...s._zod.def.shape,...e};return $a(this,"shape",n),n},checks:[]});return ea(s,r)}function e8(s,e){if(!$l(e))throw new Error("Invalid input to safeExtend: expected a plain object");const t={...s._zod.def,get shape(){const i={...s._zod.def.shape,...e};return $a(this,"shape",i),i},checks:s._zod.def.checks};return ea(s,t)}function t8(s,e){const t=Xa(s._zod.def,{get shape(){const i={...s._zod.def.shape,...e._zod.def.shape};return $a(this,"shape",i),i},get catchall(){return e._zod.def.catchall},checks:[]});return ea(s,t)}function i8(s,e,t){const i=Xa(e._zod.def,{get shape(){const r=e._zod.def.shape,n={...r};if(t)for(const a in t){if(!(a in r))throw new Error(`Unrecognized key: "${a}"`);t[a]&&(n[a]=s?new s({type:"optional",innerType:r[a]}):r[a])}else for(const a in r)n[a]=s?new s({type:"optional",innerType:r[a]}):r[a];return $a(this,"shape",n),n},checks:[]});return ea(e,i)}function r8(s,e,t){const i=Xa(e._zod.def,{get shape(){const r=e._zod.def.shape,n={...r};if(t)for(const a in t){if(!(a in n))throw new Error(`Unrecognized key: "${a}"`);t[a]&&(n[a]=new s({type:"nonoptional",innerType:r[a]}))}else for(const a in r)n[a]=new s({type:"nonoptional",innerType:r[a]});return $a(this,"shape",n),n},checks:[]});return ea(e,i)}function lo(s,e=0){var t;if(s.aborted===!0)return!0;for(let i=e;i<s.issues.length;i++)if(((t=s.issues[i])==null?void 0:t.continue)!==!0)return!0;return!1}function hN(s,e){return e.map(t=>{var i;return(i=t).path??(i.path=[]),t.path.unshift(s),t})}function Dc(s){return typeof s=="string"?s:s==null?void 0:s.message}function Oa(s,e,t){var r,n,a,o,l,c;const i={...s,path:s.path??[]};if(!s.message){const u=Dc((a=(n=(r=s.inst)==null?void 0:r._zod.def)==null?void 0:n.error)==null?void 0:a.call(n,s))??Dc((o=e==null?void 0:e.error)==null?void 0:o.call(e,s))??Dc((l=t.customError)==null?void 0:l.call(t,s))??Dc((c=t.localeError)==null?void 0:c.call(t,s))??"Invalid input";i.message=u}return delete i.inst,delete i.continue,e!=null&&e.reportInput||delete i.input,i}function og(s){return Array.isArray(s)?"array":typeof s=="string"?"string":"unknown"}function Xl(...s){const[e,t,i]=s;return typeof e=="string"?{message:e,code:"custom",input:t,inst:i}:{...e}}const dN=(s,e)=>{s.name="$ZodError",Object.defineProperty(s,"_zod",{value:s._zod,enumerable:!1}),Object.defineProperty(s,"issues",{value:e,enumerable:!1}),s.message=JSON.stringify(e,Am,2),Object.defineProperty(s,"toString",{value:()=>s.message,enumerable:!1})},fN=ee("$ZodError",dN),pN=ee("$ZodError",dN,{Parent:Error});function s8(s,e=t=>t.message){const t={},i=[];for(const r of s.issues)r.path.length>0?(t[r.path[0]]=t[r.path[0]]||[],t[r.path[0]].push(e(r))):i.push(e(r));return{formErrors:i,fieldErrors:t}}function n8(s,e=t=>t.message){const t={_errors:[]},i=r=>{for(const n of r.issues)if(n.code==="invalid_union"&&n.errors.length)n.errors.map(a=>i({issues:a}));else if(n.code==="invalid_key")i({issues:n.issues});else if(n.code==="invalid_element")i({issues:n.issues});else if(n.path.length===0)t._errors.push(e(n));else{let a=t,o=0;for(;o<n.path.length;){const l=n.path[o];o===n.path.length-1?(a[l]=a[l]||{_errors:[]},a[l]._errors.push(e(n))):a[l]=a[l]||{_errors:[]},a=a[l],o++}}};return i(s),t}const lg=s=>(e,t,i,r)=>{const n=i?Object.assign(i,{async:!1}):{async:!1},a=e._zod.run({value:t,issues:[]},n);if(a instanceof Promise)throw new _o;if(a.issues.length){const o=new((r==null?void 0:r.Err)??s)(a.issues.map(l=>Oa(l,n,Pa())));throw cN(o,r==null?void 0:r.callee),o}return a.value},cg=s=>async(e,t,i,r)=>{const n=i?Object.assign(i,{async:!0}):{async:!0};let a=e._zod.run({value:t,issues:[]},n);if(a instanceof Promise&&(a=await a),a.issues.length){const o=new((r==null?void 0:r.Err)??s)(a.issues.map(l=>Oa(l,n,Pa())));throw cN(o,r==null?void 0:r.callee),o}return a.value},Bh=s=>(e,t,i)=>{const r=i?{...i,async:!1}:{async:!1},n=e._zod.run({value:t,issues:[]},r);if(n instanceof Promise)throw new _o;return n.issues.length?{success:!1,error:new(s??fN)(n.issues.map(a=>Oa(a,r,Pa())))}:{success:!0,data:n.value}},a8=Bh(pN),Vh=s=>async(e,t,i)=>{const r=i?Object.assign(i,{async:!0}):{async:!0};let n=e._zod.run({value:t,issues:[]},r);return n instanceof Promise&&(n=await n),n.issues.length?{success:!1,error:new s(n.issues.map(a=>Oa(a,r,Pa())))}:{success:!0,data:n.value}},o8=Vh(pN),l8=s=>(e,t,i)=>{const r=i?Object.assign(i,{direction:"backward"}):{direction:"backward"};return lg(s)(e,t,r)},c8=s=>(e,t,i)=>lg(s)(e,t,i),u8=s=>async(e,t,i)=>{const r=i?Object.assign(i,{direction:"backward"}):{direction:"backward"};return cg(s)(e,t,r)},h8=s=>async(e,t,i)=>cg(s)(e,t,i),d8=s=>(e,t,i)=>{const r=i?Object.assign(i,{direction:"backward"}):{direction:"backward"};return Bh(s)(e,t,r)},f8=s=>(e,t,i)=>Bh(s)(e,t,i),p8=s=>async(e,t,i)=>{const r=i?Object.assign(i,{direction:"backward"}):{direction:"backward"};return Vh(s)(e,t,r)},m8=s=>async(e,t,i)=>Vh(s)(e,t,i),_8=/^[cC][^\s-]{8,}$/,g8=/^[0-9a-z]+$/,S8=/^[0-9A-HJKMNP-TV-Za-hjkmnp-tv-z]{26}$/,v8=/^[0-9a-vA-V]{20}$/,x8=/^[A-Za-z0-9]{27}$/,E8=/^[a-zA-Z0-9_-]{21}$/,T8=/^P(?:(\d+W)|(?!.*W)(?=\d|T\d)(\d+Y)?(\d+M)?(\d+D)?(T(?=\d)(\d+H)?(\d+M)?(\d+([.,]\d+)?S)?)?)$/,b8=/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})$/,Ny=s=>s?new RegExp(`^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-${s}[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12})$`):/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-8][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/,C8=/^(?!\.)(?!.*\.\.)([A-Za-z0-9_'+\-\.]*)[A-Za-z0-9_+-]@([A-Za-z0-9][A-Za-z0-9\-]*\.)+[A-Za-z]{2,}$/,y8="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";function I8(){return new RegExp(y8,"u")}const R8=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,A8=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:))$/,P8=/^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/([0-9]|[1-2][0-9]|3[0-2])$/,O8=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,N8=/^$|^(?:[0-9a-zA-Z+/]{4})*(?:(?:[0-9a-zA-Z+/]{2}==)|(?:[0-9a-zA-Z+/]{3}=))?$/,mN=/^[A-Za-z0-9_-]*$/,D8=/^(?=.{1,253}\.?$)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[-0-9a-zA-Z]{0,61}[0-9a-zA-Z])?)*\.?$/,M8=/^\+(?:[0-9]){6,14}[0-9]$/,_N="(?:(?:\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-(?:(?:0[13578]|1[02])-(?:0[1-9]|[12]\\d|3[01])|(?:0[469]|11)-(?:0[1-9]|[12]\\d|30)|(?:02)-(?:0[1-9]|1\\d|2[0-8])))",F8=new RegExp(`^${_N}$`);function gN(s){const e="(?:[01]\\d|2[0-3]):[0-5]\\d";return typeof s.precision=="number"?s.precision===-1?`${e}`:s.precision===0?`${e}:[0-5]\\d`:`${e}:[0-5]\\d\\.\\d{${s.precision}}`:`${e}(?::[0-5]\\d(?:\\.\\d+)?)?`}function L8(s){return new RegExp(`^${gN(s)}$`)}function w8(s){const e=gN({precision:s.precision}),t=["Z"];s.local&&t.push(""),s.offset&&t.push("([+-](?:[01]\\d|2[0-3]):[0-5]\\d)");const i=`${e}(?:${t.join("|")})`;return new RegExp(`^${_N}T(?:${i})$`)}const B8=s=>{const e=s?`[\\s\\S]{${(s==null?void 0:s.minimum)??0},${(s==null?void 0:s.maximum)??""}}`:"[\\s\\S]*";return new RegExp(`^${e}$`)},V8=/^-?\d+$/,U8=/^-?\d+(?:\.\d+)?/,k8=/^[^A-Z]*$/,G8=/^[^a-z]*$/,Ir=ee("$ZodCheck",(s,e)=>{var t;s._zod??(s._zod={}),s._zod.def=e,(t=s._zod).onattach??(t.onattach=[])}),SN={number:"number",bigint:"bigint",object:"date"},vN=ee("$ZodCheckLessThan",(s,e)=>{Ir.init(s,e);const t=SN[typeof e.value];s._zod.onattach.push(i=>{const r=i._zod.bag,n=(e.inclusive?r.maximum:r.exclusiveMaximum)??Number.POSITIVE_INFINITY;e.value<n&&(e.inclusive?r.maximum=e.value:r.exclusiveMaximum=e.value)}),s._zod.check=i=>{(e.inclusive?i.value<=e.value:i.value<e.value)||i.issues.push({origin:t,code:"too_big",maximum:e.value,input:i.value,inclusive:e.inclusive,inst:s,continue:!e.abort})}}),xN=ee("$ZodCheckGreaterThan",(s,e)=>{Ir.init(s,e);const t=SN[typeof e.value];s._zod.onattach.push(i=>{const r=i._zod.bag,n=(e.inclusive?r.minimum:r.exclusiveMinimum)??Number.NEGATIVE_INFINITY;e.value>n&&(e.inclusive?r.minimum=e.value:r.exclusiveMinimum=e.value)}),s._zod.check=i=>{(e.inclusive?i.value>=e.value:i.value>e.value)||i.issues.push({origin:t,code:"too_small",minimum:e.value,input:i.value,inclusive:e.inclusive,inst:s,continue:!e.abort})}}),z8=ee("$ZodCheckMultipleOf",(s,e)=>{Ir.init(s,e),s._zod.onattach.push(t=>{var i;(i=t._zod.bag).multipleOf??(i.multipleOf=e.value)}),s._zod.check=t=>{if(typeof t.value!=typeof e.value)throw new Error("Cannot mix number and bigint in multiple_of check.");(typeof t.value=="bigint"?t.value%e.value===BigInt(0):X6(t.value,e.value)===0)||t.issues.push({origin:typeof t.value,code:"not_multiple_of",divisor:e.value,input:t.value,inst:s,continue:!e.abort})}}),W8=ee("$ZodCheckNumberFormat",(s,e)=>{var a;Ir.init(s,e),e.format=e.format||"float64";const t=(a=e.format)==null?void 0:a.includes("int"),i=t?"int":"number",[r,n]=Z6[e.format];s._zod.onattach.push(o=>{const l=o._zod.bag;l.format=e.format,l.minimum=r,l.maximum=n,t&&(l.pattern=V8)}),s._zod.check=o=>{const l=o.value;if(t){if(!Number.isInteger(l)){o.issues.push({expected:i,format:e.format,code:"invalid_type",continue:!1,input:l,inst:s});return}if(!Number.isSafeInteger(l)){l>0?o.issues.push({input:l,code:"too_big",maximum:Number.MAX_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:s,origin:i,continue:!e.abort}):o.issues.push({input:l,code:"too_small",minimum:Number.MIN_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:s,origin:i,continue:!e.abort});return}}l<r&&o.issues.push({origin:"number",input:l,code:"too_small",minimum:r,inclusive:!0,inst:s,continue:!e.abort}),l>n&&o.issues.push({origin:"number",input:l,code:"too_big",maximum:n,inst:s})}}),H8=ee("$ZodCheckMaxLength",(s,e)=>{var t;Ir.init(s,e),(t=s._zod.def).when??(t.when=i=>{const r=i.value;return!ng(r)&&r.length!==void 0}),s._zod.onattach.push(i=>{const r=i._zod.bag.maximum??Number.POSITIVE_INFINITY;e.maximum<r&&(i._zod.bag.maximum=e.maximum)}),s._zod.check=i=>{const r=i.value;if(r.length<=e.maximum)return;const a=og(r);i.issues.push({origin:a,code:"too_big",maximum:e.maximum,inclusive:!0,input:r,inst:s,continue:!e.abort})}}),$8=ee("$ZodCheckMinLength",(s,e)=>{var t;Ir.init(s,e),(t=s._zod.def).when??(t.when=i=>{const r=i.value;return!ng(r)&&r.length!==void 0}),s._zod.onattach.push(i=>{const r=i._zod.bag.minimum??Number.NEGATIVE_INFINITY;e.minimum>r&&(i._zod.bag.minimum=e.minimum)}),s._zod.check=i=>{const r=i.value;if(r.length>=e.minimum)return;const a=og(r);i.issues.push({origin:a,code:"too_small",minimum:e.minimum,inclusive:!0,input:r,inst:s,continue:!e.abort})}}),X8=ee("$ZodCheckLengthEquals",(s,e)=>{var t;Ir.init(s,e),(t=s._zod.def).when??(t.when=i=>{const r=i.value;return!ng(r)&&r.length!==void 0}),s._zod.onattach.push(i=>{const r=i._zod.bag;r.minimum=e.length,r.maximum=e.length,r.length=e.length}),s._zod.check=i=>{const r=i.value,n=r.length;if(n===e.length)return;const a=og(r),o=n>e.length;i.issues.push({origin:a,...o?{code:"too_big",maximum:e.length}:{code:"too_small",minimum:e.length},inclusive:!0,exact:!0,input:i.value,inst:s,continue:!e.abort})}}),Uh=ee("$ZodCheckStringFormat",(s,e)=>{var t,i;Ir.init(s,e),s._zod.onattach.push(r=>{const n=r._zod.bag;n.format=e.format,e.pattern&&(n.patterns??(n.patterns=new Set),n.patterns.add(e.pattern))}),e.pattern?(t=s._zod).check??(t.check=r=>{e.pattern.lastIndex=0,!e.pattern.test(r.value)&&r.issues.push({origin:"string",code:"invalid_format",format:e.format,input:r.value,...e.pattern?{pattern:e.pattern.toString()}:{},inst:s,continue:!e.abort})}):(i=s._zod).check??(i.check=()=>{})}),Y8=ee("$ZodCheckRegex",(s,e)=>{Uh.init(s,e),s._zod.check=t=>{e.pattern.lastIndex=0,!e.pattern.test(t.value)&&t.issues.push({origin:"string",code:"invalid_format",format:"regex",input:t.value,pattern:e.pattern.toString(),inst:s,continue:!e.abort})}}),j8=ee("$ZodCheckLowerCase",(s,e)=>{e.pattern??(e.pattern=k8),Uh.init(s,e)}),q8=ee("$ZodCheckUpperCase",(s,e)=>{e.pattern??(e.pattern=G8),Uh.init(s,e)}),Z8=ee("$ZodCheckIncludes",(s,e)=>{Ir.init(s,e);const t=Mo(e.includes),i=new RegExp(typeof e.position=="number"?`^.{${e.position}}${t}`:t);e.pattern=i,s._zod.onattach.push(r=>{const n=r._zod.bag;n.patterns??(n.patterns=new Set),n.patterns.add(i)}),s._zod.check=r=>{r.value.includes(e.includes,e.position)||r.issues.push({origin:"string",code:"invalid_format",format:"includes",includes:e.includes,input:r.value,inst:s,continue:!e.abort})}}),Q8=ee("$ZodCheckStartsWith",(s,e)=>{Ir.init(s,e);const t=new RegExp(`^${Mo(e.prefix)}.*`);e.pattern??(e.pattern=t),s._zod.onattach.push(i=>{const r=i._zod.bag;r.patterns??(r.patterns=new Set),r.patterns.add(t)}),s._zod.check=i=>{i.value.startsWith(e.prefix)||i.issues.push({origin:"string",code:"invalid_format",format:"starts_with",prefix:e.prefix,input:i.value,inst:s,continue:!e.abort})}}),K8=ee("$ZodCheckEndsWith",(s,e)=>{Ir.init(s,e);const t=new RegExp(`.*${Mo(e.suffix)}$`);e.pattern??(e.pattern=t),s._zod.onattach.push(i=>{const r=i._zod.bag;r.patterns??(r.patterns=new Set),r.patterns.add(t)}),s._zod.check=i=>{i.value.endsWith(e.suffix)||i.issues.push({origin:"string",code:"invalid_format",format:"ends_with",suffix:e.suffix,input:i.value,inst:s,continue:!e.abort})}}),J8=ee("$ZodCheckOverwrite",(s,e)=>{Ir.init(s,e),s._zod.check=t=>{t.value=e.tx(t.value)}});class eq{constructor(e=[]){this.content=[],this.indent=0,this&&(this.args=e)}indented(e){this.indent+=1,e(this),this.indent-=1}write(e){if(typeof e=="function"){e(this,{execution:"sync"}),e(this,{execution:"async"});return}const i=e.split(`
`).filter(a=>a),r=Math.min(...i.map(a=>a.length-a.trimStart().length)),n=i.map(a=>a.slice(r)).map(a=>" ".repeat(this.indent*2)+a);for(const a of n)this.content.push(a)}compile(){const e=Function,t=this==null?void 0:this.args,r=[...((this==null?void 0:this.content)??[""]).map(n=>`  ${n}`)];return new e(...t,r.join(`
`))}}const tq={major:4,minor:1,patch:12},vi=ee("$ZodType",(s,e)=>{var r;var t;s??(s={}),s._zod.def=e,s._zod.bag=s._zod.bag||{},s._zod.version=tq;const i=[...s._zod.def.checks??[]];s._zod.traits.has("$ZodCheck")&&i.unshift(s);for(const n of i)for(const a of n._zod.onattach)a(s);if(i.length===0)(t=s._zod).deferred??(t.deferred=[]),(r=s._zod.deferred)==null||r.push(()=>{s._zod.run=s._zod.parse});else{const n=(o,l,c)=>{let u=lo(o),h;for(const d of l){if(d._zod.def.when){if(!d._zod.def.when(o))continue}else if(u)continue;const f=o.issues.length,m=d._zod.check(o);if(m instanceof Promise&&(c==null?void 0:c.async)===!1)throw new _o;if(h||m instanceof Promise)h=(h??Promise.resolve()).then(async()=>{await m,o.issues.length!==f&&(u||(u=lo(o,f)))});else{if(o.issues.length===f)continue;u||(u=lo(o,f))}}return h?h.then(()=>o):o},a=(o,l,c)=>{if(lo(o))return o.aborted=!0,o;const u=n(l,i,c);if(u instanceof Promise){if(c.async===!1)throw new _o;return u.then(h=>s._zod.parse(h,c))}return s._zod.parse(u,c)};s._zod.run=(o,l)=>{if(l.skipChecks)return s._zod.parse(o,l);if(l.direction==="backward"){const u=s._zod.parse({value:o.value,issues:[]},{...l,skipChecks:!0});return u instanceof Promise?u.then(h=>a(h,o,l)):a(u,o,l)}const c=s._zod.parse(o,l);if(c instanceof Promise){if(l.async===!1)throw new _o;return c.then(u=>n(u,i,l))}return n(c,i,l)}}s["~standard"]={validate:n=>{var a;try{const o=a8(s,n);return o.success?{value:o.data}:{issues:(a=o.error)==null?void 0:a.issues}}catch{return o8(s,n).then(l=>{var c;return l.success?{value:l.data}:{issues:(c=l.error)==null?void 0:c.issues}})}},vendor:"zod",version:1}}),ug=ee("$ZodString",(s,e)=>{var t;vi.init(s,e),s._zod.pattern=[...((t=s==null?void 0:s._zod.bag)==null?void 0:t.patterns)??[]].pop()??B8(s._zod.bag),s._zod.parse=(i,r)=>{if(e.coerce)try{i.value=String(i.value)}catch{}return typeof i.value=="string"||i.issues.push({expected:"string",code:"invalid_type",input:i.value,inst:s}),i}}),Qt=ee("$ZodStringFormat",(s,e)=>{Uh.init(s,e),ug.init(s,e)}),iq=ee("$ZodGUID",(s,e)=>{e.pattern??(e.pattern=b8),Qt.init(s,e)}),rq=ee("$ZodUUID",(s,e)=>{if(e.version){const i={v1:1,v2:2,v3:3,v4:4,v5:5,v6:6,v7:7,v8:8}[e.version];if(i===void 0)throw new Error(`Invalid UUID version: "${e.version}"`);e.pattern??(e.pattern=Ny(i))}else e.pattern??(e.pattern=Ny());Qt.init(s,e)}),sq=ee("$ZodEmail",(s,e)=>{e.pattern??(e.pattern=C8),Qt.init(s,e)}),nq=ee("$ZodURL",(s,e)=>{Qt.init(s,e),s._zod.check=t=>{try{const i=t.value.trim(),r=new URL(i);e.hostname&&(e.hostname.lastIndex=0,e.hostname.test(r.hostname)||t.issues.push({code:"invalid_format",format:"url",note:"Invalid hostname",pattern:D8.source,input:t.value,inst:s,continue:!e.abort})),e.protocol&&(e.protocol.lastIndex=0,e.protocol.test(r.protocol.endsWith(":")?r.protocol.slice(0,-1):r.protocol)||t.issues.push({code:"invalid_format",format:"url",note:"Invalid protocol",pattern:e.protocol.source,input:t.value,inst:s,continue:!e.abort})),e.normalize?t.value=r.href:t.value=i;return}catch{t.issues.push({code:"invalid_format",format:"url",input:t.value,inst:s,continue:!e.abort})}}}),aq=ee("$ZodEmoji",(s,e)=>{e.pattern??(e.pattern=I8()),Qt.init(s,e)}),oq=ee("$ZodNanoID",(s,e)=>{e.pattern??(e.pattern=E8),Qt.init(s,e)}),lq=ee("$ZodCUID",(s,e)=>{e.pattern??(e.pattern=_8),Qt.init(s,e)}),cq=ee("$ZodCUID2",(s,e)=>{e.pattern??(e.pattern=g8),Qt.init(s,e)}),uq=ee("$ZodULID",(s,e)=>{e.pattern??(e.pattern=S8),Qt.init(s,e)}),hq=ee("$ZodXID",(s,e)=>{e.pattern??(e.pattern=v8),Qt.init(s,e)}),dq=ee("$ZodKSUID",(s,e)=>{e.pattern??(e.pattern=x8),Qt.init(s,e)}),fq=ee("$ZodISODateTime",(s,e)=>{e.pattern??(e.pattern=w8(e)),Qt.init(s,e)}),pq=ee("$ZodISODate",(s,e)=>{e.pattern??(e.pattern=F8),Qt.init(s,e)}),mq=ee("$ZodISOTime",(s,e)=>{e.pattern??(e.pattern=L8(e)),Qt.init(s,e)}),_q=ee("$ZodISODuration",(s,e)=>{e.pattern??(e.pattern=T8),Qt.init(s,e)}),gq=ee("$ZodIPv4",(s,e)=>{e.pattern??(e.pattern=R8),Qt.init(s,e),s._zod.onattach.push(t=>{const i=t._zod.bag;i.format="ipv4"})}),Sq=ee("$ZodIPv6",(s,e)=>{e.pattern??(e.pattern=A8),Qt.init(s,e),s._zod.onattach.push(t=>{const i=t._zod.bag;i.format="ipv6"}),s._zod.check=t=>{try{new URL(`http://[${t.value}]`)}catch{t.issues.push({code:"invalid_format",format:"ipv6",input:t.value,inst:s,continue:!e.abort})}}}),vq=ee("$ZodCIDRv4",(s,e)=>{e.pattern??(e.pattern=P8),Qt.init(s,e)}),xq=ee("$ZodCIDRv6",(s,e)=>{e.pattern??(e.pattern=O8),Qt.init(s,e),s._zod.check=t=>{const i=t.value.split("/");try{if(i.length!==2)throw new Error;const[r,n]=i;if(!n)throw new Error;const a=Number(n);if(`${a}`!==n)throw new Error;if(a<0||a>128)throw new Error;new URL(`http://[${r}]`)}catch{t.issues.push({code:"invalid_format",format:"cidrv6",input:t.value,inst:s,continue:!e.abort})}}});function EN(s){if(s==="")return!0;if(s.length%4!==0)return!1;try{return atob(s),!0}catch{return!1}}const Eq=ee("$ZodBase64",(s,e)=>{e.pattern??(e.pattern=N8),Qt.init(s,e),s._zod.onattach.push(t=>{t._zod.bag.contentEncoding="base64"}),s._zod.check=t=>{EN(t.value)||t.issues.push({code:"invalid_format",format:"base64",input:t.value,inst:s,continue:!e.abort})}});function Tq(s){if(!mN.test(s))return!1;const e=s.replace(/[-_]/g,i=>i==="-"?"+":"/"),t=e.padEnd(Math.ceil(e.length/4)*4,"=");return EN(t)}const bq=ee("$ZodBase64URL",(s,e)=>{e.pattern??(e.pattern=mN),Qt.init(s,e),s._zod.onattach.push(t=>{t._zod.bag.contentEncoding="base64url"}),s._zod.check=t=>{Tq(t.value)||t.issues.push({code:"invalid_format",format:"base64url",input:t.value,inst:s,continue:!e.abort})}}),Cq=ee("$ZodE164",(s,e)=>{e.pattern??(e.pattern=M8),Qt.init(s,e)});function yq(s,e=null){try{const t=s.split(".");if(t.length!==3)return!1;const[i]=t;if(!i)return!1;const r=JSON.parse(atob(i));return!("typ"in r&&(r==null?void 0:r.typ)!=="JWT"||!r.alg||e&&(!("alg"in r)||r.alg!==e))}catch{return!1}}const Iq=ee("$ZodJWT",(s,e)=>{Qt.init(s,e),s._zod.check=t=>{yq(t.value,e.alg)||t.issues.push({code:"invalid_format",format:"jwt",input:t.value,inst:s,continue:!e.abort})}}),TN=ee("$ZodNumber",(s,e)=>{vi.init(s,e),s._zod.pattern=s._zod.bag.pattern??U8,s._zod.parse=(t,i)=>{if(e.coerce)try{t.value=Number(t.value)}catch{}const r=t.value;if(typeof r=="number"&&!Number.isNaN(r)&&Number.isFinite(r))return t;const n=typeof r=="number"?Number.isNaN(r)?"NaN":Number.isFinite(r)?void 0:"Infinity":void 0;return t.issues.push({expected:"number",code:"invalid_type",input:r,inst:s,...n?{received:n}:{}}),t}}),Rq=ee("$ZodNumber",(s,e)=>{W8.init(s,e),TN.init(s,e)}),Aq=ee("$ZodUnknown",(s,e)=>{vi.init(s,e),s._zod.parse=t=>t}),Pq=ee("$ZodNever",(s,e)=>{vi.init(s,e),s._zod.parse=(t,i)=>(t.issues.push({expected:"never",code:"invalid_type",input:t.value,inst:s}),t)});function Dy(s,e,t){s.issues.length&&e.issues.push(...hN(t,s.issues)),e.value[t]=s.value}const Oq=ee("$ZodArray",(s,e)=>{vi.init(s,e),s._zod.parse=(t,i)=>{const r=t.value;if(!Array.isArray(r))return t.issues.push({expected:"array",code:"invalid_type",input:r,inst:s}),t;t.value=Array(r.length);const n=[];for(let a=0;a<r.length;a++){const o=r[a],l=e.element._zod.run({value:o,issues:[]},i);l instanceof Promise?n.push(l.then(c=>Dy(c,t,a))):Dy(l,t,a)}return n.length?Promise.all(n).then(()=>t):t}});function _u(s,e,t,i){s.issues.length&&e.issues.push(...hN(t,s.issues)),s.value===void 0?t in i&&(e.value[t]=void 0):e.value[t]=s.value}function bN(s){var i,r,n,a;const e=Object.keys(s.shape);for(const o of e)if(!((a=(n=(r=(i=s.shape)==null?void 0:i[o])==null?void 0:r._zod)==null?void 0:n.traits)!=null&&a.has("$ZodType")))throw new Error(`Invalid element at key "${o}": expected a Zod schema`);const t=q6(s.shape);return{...s,keys:e,keySet:new Set(e),numKeys:e.length,optionalKeys:new Set(t)}}function CN(s,e,t,i,r,n){const a=[],o=r.keySet,l=r.catchall._zod,c=l.def.type;for(const u of Object.keys(e)){if(o.has(u))continue;if(c==="never"){a.push(u);continue}const h=l.run({value:e[u],issues:[]},i);h instanceof Promise?s.push(h.then(d=>_u(d,t,u,e))):_u(h,t,u,e)}return a.length&&t.issues.push({code:"unrecognized_keys",keys:a,input:e,inst:n}),s.length?Promise.all(s).then(()=>t):t}const Nq=ee("$ZodObject",(s,e)=>{vi.init(s,e);const t=Object.getOwnPropertyDescriptor(e,"shape");if(!(t!=null&&t.get)){const o=e.shape;Object.defineProperty(e,"shape",{get:()=>{const l={...o};return Object.defineProperty(e,"shape",{value:l}),l}})}const i=sg(()=>bN(e));kt(s._zod,"propValues",()=>{const o=e.shape,l={};for(const c in o){const u=o[c]._zod;if(u.values){l[c]??(l[c]=new Set);for(const h of u.values)l[c].add(h)}}return l});const r=mu,n=e.catchall;let a;s._zod.parse=(o,l)=>{a??(a=i.value);const c=o.value;if(!r(c))return o.issues.push({expected:"object",code:"invalid_type",input:c,inst:s}),o;o.value={};const u=[],h=a.shape;for(const d of a.keys){const m=h[d]._zod.run({value:c[d],issues:[]},l);m instanceof Promise?u.push(m.then(g=>_u(g,o,d,c))):_u(m,o,d,c)}return n?CN(u,c,o,l,i.value,s):u.length?Promise.all(u).then(()=>o):o}}),Dq=ee("$ZodObjectJIT",(s,e)=>{Nq.init(s,e);const t=s._zod.parse,i=sg(()=>bN(e)),r=d=>{const f=new eq(["shape","payload","ctx"]),m=i.value,g=C=>{const A=Oy(C);return`shape[${A}]._zod.run({ value: input[${A}], issues: [] }, ctx)`};f.write("const input = payload.value;");const v=Object.create(null);let E=0;for(const C of m.keys)v[C]=`key_${E++}`;f.write("const newResult = {};");for(const C of m.keys){const A=v[C],I=Oy(C);f.write(`const ${A} = ${g(C)};`),f.write(`
        if (${A}.issues.length) {
          payload.issues = payload.issues.concat(${A}.issues.map(iss => ({
            ...iss,
            path: iss.path ? [${I}, ...iss.path] : [${I}]
          })));
        }
        
        
        if (${A}.value === undefined) {
          if (${I} in input) {
            newResult[${I}] = undefined;
          }
        } else {
          newResult[${I}] = ${A}.value;
        }
        
      `)}f.write("payload.value = newResult;"),f.write("return payload;");const T=f.compile();return(C,A)=>T(d,C,A)};let n;const a=mu,o=!Rm.jitless,c=o&&Y6.value,u=e.catchall;let h;s._zod.parse=(d,f)=>{h??(h=i.value);const m=d.value;return a(m)?o&&c&&(f==null?void 0:f.async)===!1&&f.jitless!==!0?(n||(n=r(e.shape)),d=n(d,f),u?CN([],m,d,f,h,s):d):t(d,f):(d.issues.push({expected:"object",code:"invalid_type",input:m,inst:s}),d)}});function My(s,e,t,i){for(const n of s)if(n.issues.length===0)return e.value=n.value,e;const r=s.filter(n=>!lo(n));return r.length===1?(e.value=r[0].value,r[0]):(e.issues.push({code:"invalid_union",input:e.value,inst:t,errors:s.map(n=>n.issues.map(a=>Oa(a,i,Pa())))}),e)}const Mq=ee("$ZodUnion",(s,e)=>{vi.init(s,e),kt(s._zod,"optin",()=>e.options.some(r=>r._zod.optin==="optional")?"optional":void 0),kt(s._zod,"optout",()=>e.options.some(r=>r._zod.optout==="optional")?"optional":void 0),kt(s._zod,"values",()=>{if(e.options.every(r=>r._zod.values))return new Set(e.options.flatMap(r=>Array.from(r._zod.values)))}),kt(s._zod,"pattern",()=>{if(e.options.every(r=>r._zod.pattern)){const r=e.options.map(n=>n._zod.pattern);return new RegExp(`^(${r.map(n=>ag(n.source)).join("|")})$`)}});const t=e.options.length===1,i=e.options[0]._zod.run;s._zod.parse=(r,n)=>{if(t)return i(r,n);let a=!1;const o=[];for(const l of e.options){const c=l._zod.run({value:r.value,issues:[]},n);if(c instanceof Promise)o.push(c),a=!0;else{if(c.issues.length===0)return c;o.push(c)}}return a?Promise.all(o).then(l=>My(l,r,s,n)):My(o,r,s,n)}}),Fq=ee("$ZodIntersection",(s,e)=>{vi.init(s,e),s._zod.parse=(t,i)=>{const r=t.value,n=e.left._zod.run({value:r,issues:[]},i),a=e.right._zod.run({value:r,issues:[]},i);return n instanceof Promise||a instanceof Promise?Promise.all([n,a]).then(([l,c])=>Fy(t,l,c)):Fy(t,n,a)}});function Pm(s,e){if(s===e)return{valid:!0,data:s};if(s instanceof Date&&e instanceof Date&&+s==+e)return{valid:!0,data:s};if($l(s)&&$l(e)){const t=Object.keys(e),i=Object.keys(s).filter(n=>t.indexOf(n)!==-1),r={...s,...e};for(const n of i){const a=Pm(s[n],e[n]);if(!a.valid)return{valid:!1,mergeErrorPath:[n,...a.mergeErrorPath]};r[n]=a.data}return{valid:!0,data:r}}if(Array.isArray(s)&&Array.isArray(e)){if(s.length!==e.length)return{valid:!1,mergeErrorPath:[]};const t=[];for(let i=0;i<s.length;i++){const r=s[i],n=e[i],a=Pm(r,n);if(!a.valid)return{valid:!1,mergeErrorPath:[i,...a.mergeErrorPath]};t.push(a.data)}return{valid:!0,data:t}}return{valid:!1,mergeErrorPath:[]}}function Fy(s,e,t){if(e.issues.length&&s.issues.push(...e.issues),t.issues.length&&s.issues.push(...t.issues),lo(s))return s;const i=Pm(e.value,t.value);if(!i.valid)throw new Error(`Unmergable intersection. Error path: ${JSON.stringify(i.mergeErrorPath)}`);return s.value=i.data,s}const Lq=ee("$ZodEnum",(s,e)=>{vi.init(s,e);const t=$6(e.entries),i=new Set(t);s._zod.values=i,s._zod.pattern=new RegExp(`^(${t.filter(r=>j6.has(typeof r)).map(r=>typeof r=="string"?Mo(r):r.toString()).join("|")})$`),s._zod.parse=(r,n)=>{const a=r.value;return i.has(a)||r.issues.push({code:"invalid_value",values:t,input:a,inst:s}),r}}),wq=ee("$ZodLiteral",(s,e)=>{if(vi.init(s,e),e.values.length===0)throw new Error("Cannot create literal schema with no valid values");s._zod.values=new Set(e.values),s._zod.pattern=new RegExp(`^(${e.values.map(t=>typeof t=="string"?Mo(t):t?Mo(t.toString()):String(t)).join("|")})$`),s._zod.parse=(t,i)=>{const r=t.value;return s._zod.values.has(r)||t.issues.push({code:"invalid_value",values:e.values,input:r,inst:s}),t}}),Bq=ee("$ZodTransform",(s,e)=>{vi.init(s,e),s._zod.parse=(t,i)=>{if(i.direction==="backward")throw new lN(s.constructor.name);const r=e.transform(t.value,t);if(i.async)return(r instanceof Promise?r:Promise.resolve(r)).then(a=>(t.value=a,t));if(r instanceof Promise)throw new _o;return t.value=r,t}});function Ly(s,e){return s.issues.length&&e===void 0?{issues:[],value:void 0}:s}const Vq=ee("$ZodOptional",(s,e)=>{vi.init(s,e),s._zod.optin="optional",s._zod.optout="optional",kt(s._zod,"values",()=>e.innerType._zod.values?new Set([...e.innerType._zod.values,void 0]):void 0),kt(s._zod,"pattern",()=>{const t=e.innerType._zod.pattern;return t?new RegExp(`^(${ag(t.source)})?$`):void 0}),s._zod.parse=(t,i)=>{if(e.innerType._zod.optin==="optional"){const r=e.innerType._zod.run(t,i);return r instanceof Promise?r.then(n=>Ly(n,t.value)):Ly(r,t.value)}return t.value===void 0?t:e.innerType._zod.run(t,i)}}),Uq=ee("$ZodNullable",(s,e)=>{vi.init(s,e),kt(s._zod,"optin",()=>e.innerType._zod.optin),kt(s._zod,"optout",()=>e.innerType._zod.optout),kt(s._zod,"pattern",()=>{const t=e.innerType._zod.pattern;return t?new RegExp(`^(${ag(t.source)}|null)$`):void 0}),kt(s._zod,"values",()=>e.innerType._zod.values?new Set([...e.innerType._zod.values,null]):void 0),s._zod.parse=(t,i)=>t.value===null?t:e.innerType._zod.run(t,i)}),kq=ee("$ZodDefault",(s,e)=>{vi.init(s,e),s._zod.optin="optional",kt(s._zod,"values",()=>e.innerType._zod.values),s._zod.parse=(t,i)=>{if(i.direction==="backward")return e.innerType._zod.run(t,i);if(t.value===void 0)return t.value=e.defaultValue,t;const r=e.innerType._zod.run(t,i);return r instanceof Promise?r.then(n=>wy(n,e)):wy(r,e)}});function wy(s,e){return s.value===void 0&&(s.value=e.defaultValue),s}const Gq=ee("$ZodPrefault",(s,e)=>{vi.init(s,e),s._zod.optin="optional",kt(s._zod,"values",()=>e.innerType._zod.values),s._zod.parse=(t,i)=>(i.direction==="backward"||t.value===void 0&&(t.value=e.defaultValue),e.innerType._zod.run(t,i))}),zq=ee("$ZodNonOptional",(s,e)=>{vi.init(s,e),kt(s._zod,"values",()=>{const t=e.innerType._zod.values;return t?new Set([...t].filter(i=>i!==void 0)):void 0}),s._zod.parse=(t,i)=>{const r=e.innerType._zod.run(t,i);return r instanceof Promise?r.then(n=>By(n,s)):By(r,s)}});function By(s,e){return!s.issues.length&&s.value===void 0&&s.issues.push({code:"invalid_type",expected:"nonoptional",input:s.value,inst:e}),s}const Wq=ee("$ZodCatch",(s,e)=>{vi.init(s,e),kt(s._zod,"optin",()=>e.innerType._zod.optin),kt(s._zod,"optout",()=>e.innerType._zod.optout),kt(s._zod,"values",()=>e.innerType._zod.values),s._zod.parse=(t,i)=>{if(i.direction==="backward")return e.innerType._zod.run(t,i);const r=e.innerType._zod.run(t,i);return r instanceof Promise?r.then(n=>(t.value=n.value,n.issues.length&&(t.value=e.catchValue({...t,error:{issues:n.issues.map(a=>Oa(a,i,Pa()))},input:t.value}),t.issues=[]),t)):(t.value=r.value,r.issues.length&&(t.value=e.catchValue({...t,error:{issues:r.issues.map(n=>Oa(n,i,Pa()))},input:t.value}),t.issues=[]),t)}}),Hq=ee("$ZodPipe",(s,e)=>{vi.init(s,e),kt(s._zod,"values",()=>e.in._zod.values),kt(s._zod,"optin",()=>e.in._zod.optin),kt(s._zod,"optout",()=>e.out._zod.optout),kt(s._zod,"propValues",()=>e.in._zod.propValues),s._zod.parse=(t,i)=>{if(i.direction==="backward"){const n=e.out._zod.run(t,i);return n instanceof Promise?n.then(a=>Mc(a,e.in,i)):Mc(n,e.in,i)}const r=e.in._zod.run(t,i);return r instanceof Promise?r.then(n=>Mc(n,e.out,i)):Mc(r,e.out,i)}});function Mc(s,e,t){return s.issues.length?(s.aborted=!0,s):e._zod.run({value:s.value,issues:s.issues},t)}const $q=ee("$ZodReadonly",(s,e)=>{vi.init(s,e),kt(s._zod,"propValues",()=>e.innerType._zod.propValues),kt(s._zod,"values",()=>e.innerType._zod.values),kt(s._zod,"optin",()=>e.innerType._zod.optin),kt(s._zod,"optout",()=>e.innerType._zod.optout),s._zod.parse=(t,i)=>{if(i.direction==="backward")return e.innerType._zod.run(t,i);const r=e.innerType._zod.run(t,i);return r instanceof Promise?r.then(Vy):Vy(r)}});function Vy(s){return s.value=Object.freeze(s.value),s}const Xq=ee("$ZodCustom",(s,e)=>{Ir.init(s,e),vi.init(s,e),s._zod.parse=(t,i)=>t,s._zod.check=t=>{const i=t.value,r=e.fn(i);if(r instanceof Promise)return r.then(n=>Uy(n,t,i,s));Uy(r,t,i,s)}});function Uy(s,e,t,i){if(!s){const r={code:"custom",input:t,inst:i,path:[...i._zod.def.path??[]],continue:!i._zod.def.abort};i._zod.def.params&&(r.params=i._zod.def.params),e.issues.push(Xl(r))}}class Yq{constructor(){this._map=new WeakMap,this._idmap=new Map}add(e,...t){const i=t[0];if(this._map.set(e,i),i&&typeof i=="object"&&"id"in i){if(this._idmap.has(i.id))throw new Error(`ID ${i.id} already exists in the registry`);this._idmap.set(i.id,e)}return this}clear(){return this._map=new WeakMap,this._idmap=new Map,this}remove(e){const t=this._map.get(e);return t&&typeof t=="object"&&"id"in t&&this._idmap.delete(t.id),this._map.delete(e),this}get(e){const t=e._zod.parent;if(t){const i={...this.get(t)??{}};delete i.id;const r={...i,...this._map.get(e)};return Object.keys(r).length?r:void 0}return this._map.get(e)}has(e){return this._map.has(e)}}function jq(){return new Yq}const Fc=jq();function qq(s,e){return new s({type:"string",...Pe(e)})}function Zq(s,e){return new s({type:"string",format:"email",check:"string_format",abort:!1,...Pe(e)})}function ky(s,e){return new s({type:"string",format:"guid",check:"string_format",abort:!1,...Pe(e)})}function Qq(s,e){return new s({type:"string",format:"uuid",check:"string_format",abort:!1,...Pe(e)})}function Kq(s,e){return new s({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v4",...Pe(e)})}function Jq(s,e){return new s({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v6",...Pe(e)})}function eZ(s,e){return new s({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v7",...Pe(e)})}function tZ(s,e){return new s({type:"string",format:"url",check:"string_format",abort:!1,...Pe(e)})}function iZ(s,e){return new s({type:"string",format:"emoji",check:"string_format",abort:!1,...Pe(e)})}function rZ(s,e){return new s({type:"string",format:"nanoid",check:"string_format",abort:!1,...Pe(e)})}function sZ(s,e){return new s({type:"string",format:"cuid",check:"string_format",abort:!1,...Pe(e)})}function nZ(s,e){return new s({type:"string",format:"cuid2",check:"string_format",abort:!1,...Pe(e)})}function aZ(s,e){return new s({type:"string",format:"ulid",check:"string_format",abort:!1,...Pe(e)})}function oZ(s,e){return new s({type:"string",format:"xid",check:"string_format",abort:!1,...Pe(e)})}function lZ(s,e){return new s({type:"string",format:"ksuid",check:"string_format",abort:!1,...Pe(e)})}function cZ(s,e){return new s({type:"string",format:"ipv4",check:"string_format",abort:!1,...Pe(e)})}function uZ(s,e){return new s({type:"string",format:"ipv6",check:"string_format",abort:!1,...Pe(e)})}function hZ(s,e){return new s({type:"string",format:"cidrv4",check:"string_format",abort:!1,...Pe(e)})}function dZ(s,e){return new s({type:"string",format:"cidrv6",check:"string_format",abort:!1,...Pe(e)})}function fZ(s,e){return new s({type:"string",format:"base64",check:"string_format",abort:!1,...Pe(e)})}function pZ(s,e){return new s({type:"string",format:"base64url",check:"string_format",abort:!1,...Pe(e)})}function mZ(s,e){return new s({type:"string",format:"e164",check:"string_format",abort:!1,...Pe(e)})}function _Z(s,e){return new s({type:"string",format:"jwt",check:"string_format",abort:!1,...Pe(e)})}function gZ(s,e){return new s({type:"string",format:"datetime",check:"string_format",offset:!1,local:!1,precision:null,...Pe(e)})}function SZ(s,e){return new s({type:"string",format:"date",check:"string_format",...Pe(e)})}function vZ(s,e){return new s({type:"string",format:"time",check:"string_format",precision:null,...Pe(e)})}function xZ(s,e){return new s({type:"string",format:"duration",check:"string_format",...Pe(e)})}function EZ(s,e){return new s({type:"number",checks:[],...Pe(e)})}function TZ(s,e){return new s({type:"number",check:"number_format",abort:!1,format:"safeint",...Pe(e)})}function bZ(s){return new s({type:"unknown"})}function CZ(s,e){return new s({type:"never",...Pe(e)})}function Gy(s,e){return new vN({check:"less_than",...Pe(e),value:s,inclusive:!1})}function ld(s,e){return new vN({check:"less_than",...Pe(e),value:s,inclusive:!0})}function zy(s,e){return new xN({check:"greater_than",...Pe(e),value:s,inclusive:!1})}function cd(s,e){return new xN({check:"greater_than",...Pe(e),value:s,inclusive:!0})}function Wy(s,e){return new z8({check:"multiple_of",...Pe(e),value:s})}function yN(s,e){return new H8({check:"max_length",...Pe(e),maximum:s})}function gu(s,e){return new $8({check:"min_length",...Pe(e),minimum:s})}function IN(s,e){return new X8({check:"length_equals",...Pe(e),length:s})}function yZ(s,e){return new Y8({check:"string_format",format:"regex",...Pe(e),pattern:s})}function IZ(s){return new j8({check:"string_format",format:"lowercase",...Pe(s)})}function RZ(s){return new q8({check:"string_format",format:"uppercase",...Pe(s)})}function AZ(s,e){return new Z8({check:"string_format",format:"includes",...Pe(e),includes:s})}function PZ(s,e){return new Q8({check:"string_format",format:"starts_with",...Pe(e),prefix:s})}function OZ(s,e){return new K8({check:"string_format",format:"ends_with",...Pe(e),suffix:s})}function Sc(s){return new J8({check:"overwrite",tx:s})}function NZ(s){return Sc(e=>e.normalize(s))}function DZ(){return Sc(s=>s.trim())}function MZ(){return Sc(s=>s.toLowerCase())}function FZ(){return Sc(s=>s.toUpperCase())}function LZ(s,e,t){return new s({type:"array",element:e,...Pe(t)})}function wZ(s,e,t){return new s({type:"custom",check:"custom",fn:e,...Pe(t)})}function BZ(s){const e=VZ(t=>(t.addIssue=i=>{if(typeof i=="string")t.issues.push(Xl(i,t.value,e._zod.def));else{const r=i;r.fatal&&(r.continue=!1),r.code??(r.code="custom"),r.input??(r.input=t.value),r.inst??(r.inst=e),r.continue??(r.continue=!e._zod.def.abort),t.issues.push(Xl(r))}},s(t.value,t)));return e}function VZ(s,e){const t=new Ir({check:"custom",...Pe(e)});return t._zod.check=s,t}const UZ=ee("ZodISODateTime",(s,e)=>{fq.init(s,e),si.init(s,e)});function kZ(s){return gZ(UZ,s)}const GZ=ee("ZodISODate",(s,e)=>{pq.init(s,e),si.init(s,e)});function zZ(s){return SZ(GZ,s)}const WZ=ee("ZodISOTime",(s,e)=>{mq.init(s,e),si.init(s,e)});function HZ(s){return vZ(WZ,s)}const $Z=ee("ZodISODuration",(s,e)=>{_q.init(s,e),si.init(s,e)});function XZ(s){return xZ($Z,s)}const YZ=(s,e)=>{fN.init(s,e),s.name="ZodError",Object.defineProperties(s,{format:{value:t=>n8(s,t)},flatten:{value:t=>s8(s,t)},addIssue:{value:t=>{s.issues.push(t),s.message=JSON.stringify(s.issues,Am,2)}},addIssues:{value:t=>{s.issues.push(...t),s.message=JSON.stringify(s.issues,Am,2)}},isEmpty:{get(){return s.issues.length===0}}})},is=ee("ZodError",YZ,{Parent:Error}),jZ=lg(is),qZ=cg(is),ZZ=Bh(is),QZ=Vh(is),KZ=l8(is),JZ=c8(is),eQ=u8(is),tQ=h8(is),iQ=d8(is),rQ=f8(is),sQ=p8(is),nQ=m8(is),Ii=ee("ZodType",(s,e)=>(vi.init(s,e),s.def=e,s.type=e.type,Object.defineProperty(s,"_def",{value:e}),s.check=(...t)=>s.clone(Xa(e,{checks:[...e.checks??[],...t.map(i=>typeof i=="function"?{_zod:{check:i,def:{check:"custom"},onattach:[]}}:i)]})),s.clone=(t,i)=>ea(s,t,i),s.brand=()=>s,s.register=(t,i)=>(t.add(s,i),s),s.parse=(t,i)=>jZ(s,t,i,{callee:s.parse}),s.safeParse=(t,i)=>ZZ(s,t,i),s.parseAsync=async(t,i)=>qZ(s,t,i,{callee:s.parseAsync}),s.safeParseAsync=async(t,i)=>QZ(s,t,i),s.spa=s.safeParseAsync,s.encode=(t,i)=>KZ(s,t,i),s.decode=(t,i)=>JZ(s,t,i),s.encodeAsync=async(t,i)=>eQ(s,t,i),s.decodeAsync=async(t,i)=>tQ(s,t,i),s.safeEncode=(t,i)=>iQ(s,t,i),s.safeDecode=(t,i)=>rQ(s,t,i),s.safeEncodeAsync=async(t,i)=>sQ(s,t,i),s.safeDecodeAsync=async(t,i)=>nQ(s,t,i),s.refine=(t,i)=>s.check(qQ(t,i)),s.superRefine=t=>s.check(ZQ(t)),s.overwrite=t=>s.check(Sc(t)),s.optional=()=>Yy(s),s.nullable=()=>jy(s),s.nullish=()=>Yy(jy(s)),s.nonoptional=t=>zQ(s,t),s.array=()=>PN(s),s.or=t=>ON([s,t]),s.and=t=>DQ(s,t),s.transform=t=>qy(s,wQ(t)),s.default=t=>UQ(s,t),s.prefault=t=>GQ(s,t),s.catch=t=>HQ(s,t),s.pipe=t=>qy(s,t),s.readonly=()=>YQ(s),s.describe=t=>{const i=s.clone();return Fc.add(i,{description:t}),i},Object.defineProperty(s,"description",{get(){var t;return(t=Fc.get(s))==null?void 0:t.description},configurable:!0}),s.meta=(...t)=>{if(t.length===0)return Fc.get(s);const i=s.clone();return Fc.add(i,t[0]),i},s.isOptional=()=>s.safeParse(void 0).success,s.isNullable=()=>s.safeParse(null).success,s)),RN=ee("_ZodString",(s,e)=>{ug.init(s,e),Ii.init(s,e);const t=s._zod.bag;s.format=t.format??null,s.minLength=t.minimum??null,s.maxLength=t.maximum??null,s.regex=(...i)=>s.check(yZ(...i)),s.includes=(...i)=>s.check(AZ(...i)),s.startsWith=(...i)=>s.check(PZ(...i)),s.endsWith=(...i)=>s.check(OZ(...i)),s.min=(...i)=>s.check(gu(...i)),s.max=(...i)=>s.check(yN(...i)),s.length=(...i)=>s.check(IN(...i)),s.nonempty=(...i)=>s.check(gu(1,...i)),s.lowercase=i=>s.check(IZ(i)),s.uppercase=i=>s.check(RZ(i)),s.trim=()=>s.check(DZ()),s.normalize=(...i)=>s.check(NZ(...i)),s.toLowerCase=()=>s.check(MZ()),s.toUpperCase=()=>s.check(FZ())}),aQ=ee("ZodString",(s,e)=>{ug.init(s,e),RN.init(s,e),s.email=t=>s.check(Zq(oQ,t)),s.url=t=>s.check(tZ(lQ,t)),s.jwt=t=>s.check(_Z(bQ,t)),s.emoji=t=>s.check(iZ(cQ,t)),s.guid=t=>s.check(ky(Hy,t)),s.uuid=t=>s.check(Qq(Lc,t)),s.uuidv4=t=>s.check(Kq(Lc,t)),s.uuidv6=t=>s.check(Jq(Lc,t)),s.uuidv7=t=>s.check(eZ(Lc,t)),s.nanoid=t=>s.check(rZ(uQ,t)),s.guid=t=>s.check(ky(Hy,t)),s.cuid=t=>s.check(sZ(hQ,t)),s.cuid2=t=>s.check(nZ(dQ,t)),s.ulid=t=>s.check(aZ(fQ,t)),s.base64=t=>s.check(fZ(xQ,t)),s.base64url=t=>s.check(pZ(EQ,t)),s.xid=t=>s.check(oZ(pQ,t)),s.ksuid=t=>s.check(lZ(mQ,t)),s.ipv4=t=>s.check(cZ(_Q,t)),s.ipv6=t=>s.check(uZ(gQ,t)),s.cidrv4=t=>s.check(hZ(SQ,t)),s.cidrv6=t=>s.check(dZ(vQ,t)),s.e164=t=>s.check(mZ(TQ,t)),s.datetime=t=>s.check(kZ(t)),s.date=t=>s.check(zZ(t)),s.time=t=>s.check(HZ(t)),s.duration=t=>s.check(XZ(t))});function Sa(s){return qq(aQ,s)}const si=ee("ZodStringFormat",(s,e)=>{Qt.init(s,e),RN.init(s,e)}),oQ=ee("ZodEmail",(s,e)=>{sq.init(s,e),si.init(s,e)}),Hy=ee("ZodGUID",(s,e)=>{iq.init(s,e),si.init(s,e)}),Lc=ee("ZodUUID",(s,e)=>{rq.init(s,e),si.init(s,e)}),lQ=ee("ZodURL",(s,e)=>{nq.init(s,e),si.init(s,e)}),cQ=ee("ZodEmoji",(s,e)=>{aq.init(s,e),si.init(s,e)}),uQ=ee("ZodNanoID",(s,e)=>{oq.init(s,e),si.init(s,e)}),hQ=ee("ZodCUID",(s,e)=>{lq.init(s,e),si.init(s,e)}),dQ=ee("ZodCUID2",(s,e)=>{cq.init(s,e),si.init(s,e)}),fQ=ee("ZodULID",(s,e)=>{uq.init(s,e),si.init(s,e)}),pQ=ee("ZodXID",(s,e)=>{hq.init(s,e),si.init(s,e)}),mQ=ee("ZodKSUID",(s,e)=>{dq.init(s,e),si.init(s,e)}),_Q=ee("ZodIPv4",(s,e)=>{gq.init(s,e),si.init(s,e)}),gQ=ee("ZodIPv6",(s,e)=>{Sq.init(s,e),si.init(s,e)}),SQ=ee("ZodCIDRv4",(s,e)=>{vq.init(s,e),si.init(s,e)}),vQ=ee("ZodCIDRv6",(s,e)=>{xq.init(s,e),si.init(s,e)}),xQ=ee("ZodBase64",(s,e)=>{Eq.init(s,e),si.init(s,e)}),EQ=ee("ZodBase64URL",(s,e)=>{bq.init(s,e),si.init(s,e)}),TQ=ee("ZodE164",(s,e)=>{Cq.init(s,e),si.init(s,e)}),bQ=ee("ZodJWT",(s,e)=>{Iq.init(s,e),si.init(s,e)}),AN=ee("ZodNumber",(s,e)=>{TN.init(s,e),Ii.init(s,e),s.gt=(i,r)=>s.check(zy(i,r)),s.gte=(i,r)=>s.check(cd(i,r)),s.min=(i,r)=>s.check(cd(i,r)),s.lt=(i,r)=>s.check(Gy(i,r)),s.lte=(i,r)=>s.check(ld(i,r)),s.max=(i,r)=>s.check(ld(i,r)),s.int=i=>s.check($y(i)),s.safe=i=>s.check($y(i)),s.positive=i=>s.check(zy(0,i)),s.nonnegative=i=>s.check(cd(0,i)),s.negative=i=>s.check(Gy(0,i)),s.nonpositive=i=>s.check(ld(0,i)),s.multipleOf=(i,r)=>s.check(Wy(i,r)),s.step=(i,r)=>s.check(Wy(i,r)),s.finite=()=>s;const t=s._zod.bag;s.minValue=Math.max(t.minimum??Number.NEGATIVE_INFINITY,t.exclusiveMinimum??Number.NEGATIVE_INFINITY)??null,s.maxValue=Math.min(t.maximum??Number.POSITIVE_INFINITY,t.exclusiveMaximum??Number.POSITIVE_INFINITY)??null,s.isInt=(t.format??"").includes("int")||Number.isSafeInteger(t.multipleOf??.5),s.isFinite=!0,s.format=t.format??null});function vt(s){return EZ(AN,s)}const CQ=ee("ZodNumberFormat",(s,e)=>{Rq.init(s,e),AN.init(s,e)});function $y(s){return TZ(CQ,s)}const yQ=ee("ZodUnknown",(s,e)=>{Aq.init(s,e),Ii.init(s,e)});function Xy(){return bZ(yQ)}const IQ=ee("ZodNever",(s,e)=>{Pq.init(s,e),Ii.init(s,e)});function RQ(s){return CZ(IQ,s)}const AQ=ee("ZodArray",(s,e)=>{Oq.init(s,e),Ii.init(s,e),s.element=e.element,s.min=(t,i)=>s.check(gu(t,i)),s.nonempty=t=>s.check(gu(1,t)),s.max=(t,i)=>s.check(yN(t,i)),s.length=(t,i)=>s.check(IN(t,i)),s.unwrap=()=>s.element});function PN(s,e){return LZ(AQ,s,e)}const PQ=ee("ZodObject",(s,e)=>{Dq.init(s,e),Ii.init(s,e),kt(s,"shape",()=>e.shape),s.keyof=()=>MQ(Object.keys(s._zod.def.shape)),s.catchall=t=>s.clone({...s._zod.def,catchall:t}),s.passthrough=()=>s.clone({...s._zod.def,catchall:Xy()}),s.loose=()=>s.clone({...s._zod.def,catchall:Xy()}),s.strict=()=>s.clone({...s._zod.def,catchall:RQ()}),s.strip=()=>s.clone({...s._zod.def,catchall:void 0}),s.extend=t=>J6(s,t),s.safeExtend=t=>e8(s,t),s.merge=t=>t8(s,t),s.pick=t=>Q6(s,t),s.omit=t=>K6(s,t),s.partial=(...t)=>i8(NN,s,t[0]),s.required=(...t)=>r8(DN,s,t[0])});function Yl(s,e){const t={type:"object",shape:s??{},...Pe(e)};return new PQ(t)}const OQ=ee("ZodUnion",(s,e)=>{Mq.init(s,e),Ii.init(s,e),s.options=e.options});function ON(s,e){return new OQ({type:"union",options:s,...Pe(e)})}const NQ=ee("ZodIntersection",(s,e)=>{Fq.init(s,e),Ii.init(s,e)});function DQ(s,e){return new NQ({type:"intersection",left:s,right:e})}const Om=ee("ZodEnum",(s,e)=>{Lq.init(s,e),Ii.init(s,e),s.enum=e.entries,s.options=Object.values(e.entries);const t=new Set(Object.keys(e.entries));s.extract=(i,r)=>{const n={};for(const a of i)if(t.has(a))n[a]=e.entries[a];else throw new Error(`Key ${a} not found in enum`);return new Om({...e,checks:[],...Pe(r),entries:n})},s.exclude=(i,r)=>{const n={...e.entries};for(const a of i)if(t.has(a))delete n[a];else throw new Error(`Key ${a} not found in enum`);return new Om({...e,checks:[],...Pe(r),entries:n})}});function MQ(s,e){const t=Array.isArray(s)?Object.fromEntries(s.map(i=>[i,i])):s;return new Om({type:"enum",entries:t,...Pe(e)})}const FQ=ee("ZodLiteral",(s,e)=>{wq.init(s,e),Ii.init(s,e),s.values=new Set(e.values),Object.defineProperty(s,"value",{get(){if(e.values.length>1)throw new Error("This schema contains multiple valid literal values. Use `.values` instead.");return e.values[0]}})});function Rr(s,e){return new FQ({type:"literal",values:Array.isArray(s)?s:[s],...Pe(e)})}const LQ=ee("ZodTransform",(s,e)=>{Bq.init(s,e),Ii.init(s,e),s._zod.parse=(t,i)=>{if(i.direction==="backward")throw new lN(s.constructor.name);t.addIssue=n=>{if(typeof n=="string")t.issues.push(Xl(n,t.value,e));else{const a=n;a.fatal&&(a.continue=!1),a.code??(a.code="custom"),a.input??(a.input=t.value),a.inst??(a.inst=s),t.issues.push(Xl(a))}};const r=e.transform(t.value,t);return r instanceof Promise?r.then(n=>(t.value=n,t)):(t.value=r,t)}});function wQ(s){return new LQ({type:"transform",transform:s})}const NN=ee("ZodOptional",(s,e)=>{Vq.init(s,e),Ii.init(s,e),s.unwrap=()=>s._zod.def.innerType});function Yy(s){return new NN({type:"optional",innerType:s})}const BQ=ee("ZodNullable",(s,e)=>{Uq.init(s,e),Ii.init(s,e),s.unwrap=()=>s._zod.def.innerType});function jy(s){return new BQ({type:"nullable",innerType:s})}const VQ=ee("ZodDefault",(s,e)=>{kq.init(s,e),Ii.init(s,e),s.unwrap=()=>s._zod.def.innerType,s.removeDefault=s.unwrap});function UQ(s,e){return new VQ({type:"default",innerType:s,get defaultValue(){return typeof e=="function"?e():uN(e)}})}const kQ=ee("ZodPrefault",(s,e)=>{Gq.init(s,e),Ii.init(s,e),s.unwrap=()=>s._zod.def.innerType});function GQ(s,e){return new kQ({type:"prefault",innerType:s,get defaultValue(){return typeof e=="function"?e():uN(e)}})}const DN=ee("ZodNonOptional",(s,e)=>{zq.init(s,e),Ii.init(s,e),s.unwrap=()=>s._zod.def.innerType});function zQ(s,e){return new DN({type:"nonoptional",innerType:s,...Pe(e)})}const WQ=ee("ZodCatch",(s,e)=>{Wq.init(s,e),Ii.init(s,e),s.unwrap=()=>s._zod.def.innerType,s.removeCatch=s.unwrap});function HQ(s,e){return new WQ({type:"catch",innerType:s,catchValue:typeof e=="function"?e:()=>e})}const $Q=ee("ZodPipe",(s,e)=>{Hq.init(s,e),Ii.init(s,e),s.in=e.in,s.out=e.out});function qy(s,e){return new $Q({type:"pipe",in:s,out:e})}const XQ=ee("ZodReadonly",(s,e)=>{$q.init(s,e),Ii.init(s,e),s.unwrap=()=>s._zod.def.innerType});function YQ(s){return new XQ({type:"readonly",innerType:s})}const jQ=ee("ZodCustom",(s,e)=>{Xq.init(s,e),Ii.init(s,e)});function qQ(s,e={}){return wZ(jQ,s,e)}function ZQ(s){return BZ(s)}const QQ=Yl({str:vt().int(),dex:vt().int(),int:vt().int()});Yl({id:Sa().min(1),displayName:Sa().min(1),affinity:QQ,startingStats:Yl({strength:vt().int(),dexterity:vt().int(),intelligence:vt().int(),hp:vt().int(),maxHp:vt().int(),mp:vt().int(),maxMp:vt().int(),energyShield:vt().int(),maxEnergyShield:vt().int(),armor:vt().int(),evasion:vt().int(),fireResistance:vt().int(),coldResistance:vt().int(),lightningResistance:vt().int(),chaosResistance:vt().int(),accuracy:vt().int()}),allowedAscendancies:PN(Sa().min(1)),saveClass:ON([Rr("warrior"),Rr("archer"),Rr("marauder"),Rr("ranger"),Rr("witch"),Rr("duelist"),Rr("templar"),Rr("shadow"),Rr("scion"),Rr("sorceress"),Rr("mercenary"),Rr("monk"),Rr("huntress")])});Yl({id:Sa().min(1),classId:Sa().min(1),displayName:Sa().min(1),shortDescription:Sa().min(1),creationBonuses:Yl({str:vt().int().optional(),dex:vt().int().optional(),int:vt().int().optional(),hp_flat:vt().int().optional(),mp_flat:vt().int().optional(),es_flat:vt().int().optional(),melee_pct:vt().int().optional(),bow_pct:vt().int().optional(),armor:vt().int().optional(),evasion:vt().int().optional(),fire_res:vt().int().optional(),cold_res:vt().int().optional(),lightning_res:vt().int().optional(),chaos_res:vt().int().optional()})});function KQ(s,e){const t={...s};return e&&(typeof e.str=="number"&&(t.strength+=e.str),typeof e.dex=="number"&&(t.dexterity+=e.dex),typeof e.int=="number"&&(t.intelligence+=e.int),typeof e.hp_flat=="number"&&(t.maxHp+=e.hp_flat,t.hp=Math.min(t.hp+e.hp_flat,t.maxHp)),typeof e.mp_flat=="number"&&(t.maxMp+=e.mp_flat,t.mp=Math.min(t.mp+e.mp_flat,t.maxMp)),typeof e.es_flat=="number"&&(t.maxEnergyShield+=e.es_flat,t.energyShield=Math.min(t.energyShield+e.es_flat,t.maxEnergyShield)),typeof e.armor=="number"&&(t.armor+=e.armor),typeof e.evasion=="number"&&(t.evasion+=e.evasion),typeof e.fire_res=="number"&&(t.fireResistance+=e.fire_res),typeof e.cold_res=="number"&&(t.coldResistance+=e.cold_res),typeof e.lightning_res=="number"&&(t.lightningResistance+=e.lightning_res),typeof e.chaos_res=="number"&&(t.chaosResistance+=e.chaos_res)),t}class JQ{constructor(e,t){Hr(this,"state");Hr(this,"listeners",new Set);this.state={classes:e,ascendancies:t,selectedClassId:null,selectedAscendancyId:null,name:""}}subscribe(e){return this.listeners.add(e),e(this.state),()=>this.listeners.delete(e)}emit(){for(const e of this.listeners)e(this.state)}setName(e){this.state.name=e,this.emit()}setClass(e){this.state.selectedClassId=e;const t=this.getSelectedAscendancy();t&&t.classId!==e&&(this.state.selectedAscendancyId=null),this.emit()}setAscendancy(e){this.state.selectedAscendancyId=e,this.emit()}getSelectedClass(){return this.state.classes.find(e=>e.id===this.state.selectedClassId||"")}getSelectedAscendancy(){return this.state.ascendancies.find(e=>e.id===this.state.selectedAscendancyId||"")}getFilteredAscendancies(){const e=this.getSelectedClass();return e?this.state.ascendancies.filter(t=>t.classId===e.id):[]}getDerivedStats(){const e=this.getSelectedClass(),t=this.getSelectedAscendancy();return e?KQ(e.startingStats,t==null?void 0:t.creationBonuses):null}isValid(){return!this.state.name||this.state.name.trim().length<1?{valid:!1,reason:"Enter a name"}:this.state.selectedClassId?this.state.selectedAscendancyId?{valid:!0}:{valid:!1,reason:"Choose an ascendancy"}:{valid:!1,reason:"Choose a class"}}}let wc=null;async function e9(){if(wc)return wc;try{return wc=await(await fetch("/src/features/characterCreation/data/keywords.json")).json(),wc}catch(s){return console.error("Failed to load keywords:",s),[]}}async function t9(s){return(await e9()).find(t=>t.id===s)||null}async function i9(s){const e=await t9(s);return(e==null?void 0:e.description)||`No description available for ${s}`}let Jt=null,hr;async function vK(){var A,I,F,V;const s=EM,e=xM;hr=new JQ(s,e);const t=document.getElementById("class-grid"),i=document.getElementById("asc-grid"),r=document.getElementById("creator-name"),n=document.getElementById("creator-back"),a=document.getElementById("creator-next"),o=document.getElementById("creator-confirm"),l=document.getElementById("validation"),c=document.getElementById("creator-confirm-modal"),u=document.getElementById("confirm-yes"),h=document.getElementById("confirm-no"),d=window.__gameEngine,f=document.getElementById("renderCanvas");d&&f&&(Jt=new H6(d,f)),r9(),new URLSearchParams(window.location.search).has("debug")&&document.addEventListener("click",D=>{console.log("CC Click:",D.target,"composedPath length:",D.composedPath().length)},!0);function m(){t.innerHTML="";for(const D of s){const w=document.createElement("button");w.className="tile",w.setAttribute("role","button"),w.setAttribute("aria-label",D.displayName),w.setAttribute("tabindex","0"),w.innerHTML=`<div class="name">${D.displayName}</div>`,w.addEventListener("click",()=>{hr.setClass(D.id),Jt==null||Jt.setClass(D.id)}),t.appendChild(w)}}function g(){i.innerHTML="";const D=hr.getFilteredAscendancies();for(const w of D){const B=document.createElement("button");B.className="tile",B.setAttribute("tabindex","0"),B.innerHTML=`<div class="name">${w.displayName}</div><div class="desc">${w.shortDescription}</div>`,B.addEventListener("click",()=>{hr.setAscendancy(w.id),Jt==null||Jt.setAscendancy(w.id)}),i.appendChild(B)}}function v(){const D=hr.getDerivedStats(),w=B=>document.getElementById(B);w("stat-str").textContent=D?String(D.strength):"-",w("stat-dex").textContent=D?String(D.dexterity):"-",w("stat-int").textContent=D?String(D.intelligence):"-",w("stat-hp").textContent=D?String(D.maxHp):"-",w("stat-mp").textContent=D?String(D.maxMp):"-",w("stat-es").textContent=D?String(D.maxEnergyShield):"-",w("stat-accuracy").textContent=D?String(D.accuracy):"-",w("stat-armor").textContent=D?String(D.armor):"-",w("stat-evasion").textContent=D?String(D.evasion):"-",w("stat-fire-res").textContent=D?`${D.fireResistance}%`:"-",w("stat-cold-res").textContent=D?`${D.coldResistance}%`:"-",w("stat-lightning-res").textContent=D?`${D.lightningResistance}%`:"-",w("stat-chaos-res").textContent=D?`${D.chaosResistance}%`:"-"}async function E(){const D=document.querySelectorAll(".stat-tooltip");for(const w of D){const B=w.getAttribute("data-keyword");if(B)try{const Q=await i9(B);w.setAttribute("data-tooltip",Q)}catch(Q){console.warn(`Failed to load tooltip for ${B}:`,Q),w.setAttribute("data-tooltip",`No description available for ${B}`)}}}function T(){const D=hr.isValid();l.textContent=D.valid?"":D.reason||"",o.disabled=!D.valid}hr.subscribe(()=>{const D=hr.getSelectedClass(),w=hr.getSelectedAscendancy();document.querySelectorAll("#class-grid .tile").forEach((Q,J)=>{const re=s[J];Q.classList.toggle("selected",!!D&&re.id===D.id)}),g();const B=hr.getFilteredAscendancies();document.querySelectorAll("#asc-grid .tile").forEach((Q,J)=>{const re=B[J];Q.classList.toggle("selected",!!w&&re.id===w.id)}),v(),T()}),r.addEventListener("input",()=>{hr.setName(r.value)}),n.addEventListener("click",()=>{vg.transitionTo(xg.MAIN_MENU)}),a.addEventListener("click",()=>{const D=i.querySelector(".tile");D==null||D.focus()}),o.addEventListener("click",()=>{hr.isValid().valid&&(c.classList.remove("hidden"),h.focus())});function C(){const D=window.__charCreateSlot??0,w=hr.getSelectedClass(),B=r.value.trim()||"Adventurer",Q=oM(D,B,w.saveClass),J=hr.getDerivedStats();J&&(Q.character.stats=J),lM(D,Q),vg.transitionTo(xg.HIDEOUT,{saveData:Q,slot:D})}u.addEventListener("click",()=>{c.classList.add("hidden"),C()}),h.addEventListener("click",()=>c.classList.add("hidden")),(A=document.getElementById("pose-a"))==null||A.addEventListener("click",()=>Jt==null?void 0:Jt.setAppearance({pose:"a"})),(I=document.getElementById("pose-b"))==null||I.addEventListener("click",()=>Jt==null?void 0:Jt.setAppearance({pose:"b"})),(F=document.getElementById("tint-a"))==null||F.addEventListener("click",()=>Jt==null?void 0:Jt.setAppearance({tint:"a"})),(V=document.getElementById("tint-b"))==null||V.addEventListener("click",()=>Jt==null?void 0:Jt.setAppearance({tint:"b"})),m(),g(),v(),T(),E(),setTimeout(()=>{const D=t.querySelector(".tile");D?(D.focus(),D.setAttribute("data-focus-initial","true")):r&&r.focus()},100)}function xK(){s9(),Jt==null||Jt.dispose(),Jt=null}function r9(){var n,a;const s=window.__gameEngine,e=document.getElementById("renderCanvas"),t=window.__gameScene,i=window.__gameCamera;e&&e.classList.add("canvas--disabled");const r=document.querySelector(".hud");r&&r.classList.add("hud--disabled");try{t&&t.detachControl(),i&&i.detachControl(!0),s&&s.getInputElement()&&((a=(n=s.getInputElement()).blur)==null||a.call(n))}catch(o){console.warn("Failed to detach controls:",o)}console.log("🎮 Gameplay input suspended for character creation")}function s9(){const s=document.getElementById("renderCanvas"),e=window.__gameScene,t=window.__gameCamera;s&&s.classList.remove("canvas--disabled");const i=document.querySelector(".hud");i&&i.classList.remove("hud--disabled");try{e&&e.attachControl(),t&&t.attachControl(!0)}catch(r){console.warn("Failed to reattach controls:",r)}console.log("🎮 Gameplay input resumed")}export{xK as cleanup,vK as init};

import{b as L,am as y,e as P}from"./main-cbd8a0ec.js";function U(){const e={cTFETC1:0,cTFETC2:1,cTFBC1:2,cTFBC3:3,cTFBC4:4,cTFBC5:5,cTFBC7:6,cTFPVRTC1_4_RGB:8,cTFPVRTC1_4_RGBA:9,cTFASTC_4x4:10,cTFATC_RGB:11,cTFATC_RGBA_INTERPOLATED_ALPHA:12,cTFRGBA32:13,cTFRGB565:14,cTFBGR565:15,cTFRGBA4444:16,cTFFXT1_RGB:17,cTFPVRTC2_4_RGB:18,cTFPVRTC2_4_RGBA:19,cTFETC2_EAC_R11:20,cTFETC2_EAC_RG11:21};let i=null;onmessage=t=>{if(t.data.action==="init"){if(t.data.url)try{importScripts(t.data.url)}catch(a){postMessage({action:"error",error:a})}i||(i=BASIS({wasmBinary:t.data.wasmBinary})),i!==null&&i.then(a=>{BASIS=a,a.initializeBasis(),postMessage({action:"init"})})}else if(t.data.action==="transcode"){const a=t.data.config,s=t.data.imageData,T=new BASIS.BasisFile(s),n=l(T);let d=t.data.ignoreSupportedFormats?null:o(t.data.config,n),f=!1;d===null&&(f=!0,d=n.hasAlpha?e.cTFBC3:e.cTFBC1);let m=!0;T.startTranscoding()||(m=!1);const C=[];for(let u=0;u<n.images.length&&m;u++){const h=n.images[u];if(a.loadSingleImage===void 0||a.loadSingleImage===u){let _=h.levels.length;a.loadMipmapLevels===!1&&(_=1);for(let p=0;p<_;p++){const G=h.levels[p],b=c(T,u,p,d,f);if(!b){m=!1;break}G.transcodedPixels=b,C.push(G.transcodedPixels.buffer)}}}T.close(),T.delete(),f&&(d=-1),m?postMessage({action:"transcode",success:m,id:t.data.id,fileInfo:n,format:d},C):postMessage({action:"transcode",success:m,id:t.data.id})}};function o(t,a){let s=null;return t.supportedCompressionFormats&&(t.supportedCompressionFormats.astc?s=e.cTFASTC_4x4:t.supportedCompressionFormats.bc7?s=e.cTFBC7:t.supportedCompressionFormats.s3tc?s=a.hasAlpha?e.cTFBC3:e.cTFBC1:t.supportedCompressionFormats.pvrtc?s=a.hasAlpha?e.cTFPVRTC1_4_RGBA:e.cTFPVRTC1_4_RGB:t.supportedCompressionFormats.etc2?s=e.cTFETC2:t.supportedCompressionFormats.etc1?s=e.cTFETC1:s=e.cTFRGB565),s}function l(t){const a=t.getHasAlpha(),s=t.getNumImages(),T=[];for(let d=0;d<s;d++){const f={levels:[]},m=t.getNumLevels(d);for(let C=0;C<m;C++){const u={width:t.getImageWidth(d,C),height:t.getImageHeight(d,C)};f.levels.push(u)}T.push(f)}return{hasAlpha:a,images:T}}function c(t,a,s,T,n){const d=t.getImageTranscodedSizeInBytes(a,s,T);let f=new Uint8Array(d);if(!t.transcodeImage(f,a,s,T,1,0))return null;if(n){const m=t.getImageWidth(a,s)+3&-4,C=t.getImageHeight(a,s)+3&-4;f=r(f,0,m,C)}return f}function r(t,a,s,T){const n=new Uint16Array(4),d=new Uint16Array(s*T),f=s/4,m=T/4;for(let C=0;C<m;C++)for(let u=0;u<f;u++){const h=a+8*(C*f+u);n[0]=t[h]|t[h+1]<<8,n[1]=t[h+2]|t[h+3]<<8,n[2]=(2*(n[0]&31)+1*(n[1]&31))/3|(2*(n[0]&2016)+1*(n[1]&2016))/3&2016|(2*(n[0]&63488)+1*(n[1]&63488))/3&63488,n[3]=(2*(n[1]&31)+1*(n[0]&31))/3|(2*(n[1]&2016)+1*(n[0]&2016))/3&2016|(2*(n[1]&63488)+1*(n[0]&63488))/3&63488;for(let _=0;_<4;_++){const p=t[h+4+_];let G=(C*4+_)*s+u*4;d[G++]=n[p&3],d[G++]=n[p>>2&3],d[G++]=n[p>>4&3],d[G++]=n[p>>6&3]}}return d}}async function D(e,i,o){return await new Promise((l,c)=>{const r=t=>{t.data.action==="init"?(e.removeEventListener("message",r),l(e)):t.data.action==="error"&&c(t.data.error||"error initializing worker")};e.addEventListener("message",r),e.postMessage({action:"init",url:o?L.GetBabylonScriptURL(o):void 0,wasmBinary:i},[i])})}var g;(function(e){e[e.cTFETC1=0]="cTFETC1",e[e.cTFETC2=1]="cTFETC2",e[e.cTFBC1=2]="cTFBC1",e[e.cTFBC3=3]="cTFBC3",e[e.cTFBC4=4]="cTFBC4",e[e.cTFBC5=5]="cTFBC5",e[e.cTFBC7=6]="cTFBC7",e[e.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",e[e.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",e[e.cTFASTC_4x4=10]="cTFASTC_4x4",e[e.cTFATC_RGB=11]="cTFATC_RGB",e[e.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",e[e.cTFRGBA32=13]="cTFRGBA32",e[e.cTFRGB565=14]="cTFRGB565",e[e.cTFBGR565=15]="cTFBGR565",e[e.cTFRGBA4444=16]="cTFRGBA4444",e[e.cTFFXT1_RGB=17]="cTFFXT1_RGB",e[e.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",e[e.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",e[e.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",e[e.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"})(g||(g={}));const F={JSModuleURL:`${L._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${L._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`},v=(e,i)=>{let o;switch(e){case g.cTFETC1:o=36196;break;case g.cTFBC1:o=33776;break;case g.cTFBC4:o=33779;break;case g.cTFASTC_4x4:o=37808;break;case g.cTFETC2:o=37496;break;case g.cTFBC7:o=36492;break}if(o===void 0)throw"The chosen Basis transcoder format is not currently supported";return o};let R=null,E=null,V=0;const W=!1,k=async()=>(R||(R=new Promise((e,i)=>{E?e(E):L.LoadFileAsync(L.GetBabylonScriptURL(F.WasmModuleURL)).then(o=>{if(typeof URL!="function")return i("Basis transcoder requires an environment with a URL constructor");const l=URL.createObjectURL(new Blob([`(${U})()`],{type:"application/javascript"}));E=new Worker(l),D(E,o,F.JSModuleURL).then(e,i)}).catch(i)})),await R),x=async(e,i)=>{const o=e instanceof ArrayBuffer?new Uint8Array(e):e;return await new Promise((l,c)=>{k().then(()=>{const r=V++,t=s=>{s.data.action==="transcode"&&s.data.id===r&&(E.removeEventListener("message",t),s.data.success?l(s.data):c("Transcode is not supported on this device"))};E.addEventListener("message",t);const a=new Uint8Array(o.byteLength);a.set(new Uint8Array(o.buffer,o.byteOffset,o.byteLength)),E.postMessage({action:"transcode",id:r,imageData:a,config:i,ignoreSupportedFormats:W},[a.buffer])},r=>{c(r)})})},w=(e,i)=>{var l,c;let o=(l=i._gl)==null?void 0:l.TEXTURE_2D;e.isCube&&(o=(c=i._gl)==null?void 0:c.TEXTURE_CUBE_MAP),i._bindTextureDirectly(o,e,!0)},H=(e,i)=>{const o=e.getEngine();for(let l=0;l<i.fileInfo.images.length;l++){const c=i.fileInfo.images[l].levels[0];if(e._invertVScale=e.invertY,i.format===-1||i.format===g.cTFRGB565)if(e.type=10,e.format=4,o._features.basisNeedsPOT&&(Math.log2(c.width)%1!==0||Math.log2(c.height)%1!==0)){const r=new y(o,2);e._invertVScale=e.invertY,r.type=10,r.format=4,r.width=c.width+3&-4,r.height=c.height+3&-4,w(r,o),o._uploadDataToTextureDirectly(r,new Uint16Array(c.transcodedPixels.buffer),l,0,4,!0),o._rescaleTexture(r,e,o.scenes[0],o._getInternalFormat(4),()=>{o._releaseTexture(r),w(e,o)})}else e._invertVScale=!e.invertY,e.width=c.width+3&-4,e.height=c.height+3&-4,e.samplingMode=2,w(e,o),o._uploadDataToTextureDirectly(e,new Uint16Array(c.transcodedPixels.buffer),l,0,4,!0);else{e.width=c.width,e.height=c.height,e.generateMipMaps=i.fileInfo.images[l].levels.length>1;const r=B.GetInternalFormatFromBasisFormat(i.format,o);e.format=r,w(e,o);const t=i.fileInfo.images[l].levels;for(let a=0;a<t.length;a++){const s=t[a];o._uploadCompressedDataToTextureDirectly(e,r,s.width,s.height,s.transcodedPixels,l,a)}o._features.basisNeedsPOT&&(Math.log2(e.width)%1!==0||Math.log2(e.height)%1!==0)&&(L.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),e._cachedWrapU=P.CLAMP_ADDRESSMODE,e._cachedWrapV=P.CLAMP_ADDRESSMODE)}}},B={JSModuleURL:F.JSModuleURL,WasmModuleURL:F.WasmModuleURL,GetInternalFormatFromBasisFormat:v,TranscodeAsync:x,LoadTextureFromTranscodeResult:H};Object.defineProperty(B,"JSModuleURL",{get:function(){return F.JSModuleURL},set:function(e){F.JSModuleURL=e}});Object.defineProperty(B,"WasmModuleURL",{get:function(){return F.WasmModuleURL},set:function(e){F.WasmModuleURL=e}});export{H as L,x as T};
